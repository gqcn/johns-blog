"use strict";(self.webpackChunkgf_site=self.webpackChunkgf_site||[]).push([["3892"],{69346:function(e,r,n){n.r(r),n.d(r,{metadata:()=>t,contentTitle:()=>i,default:()=>d,assets:()=>l,toc:()=>m,frontMatter:()=>a});var t=JSON.parse('{"id":"\u53EF\u89C2\u6D4B\u6027/\u76D1\u63A7\u6280\u672F/Cadvisor working set bytes\u4E0Elinux oom killer","title":"Cadvisor working set bytes\u4E0Elinux oom killer","description":"\u63A2\u8BA8 Cadvisor \u4E2D working set bytes \u7684\u6982\u5FF5\u4EE5\u53CA\u5176\u4E0E Linux OOM killer \u7684\u5173\u7CFB\uFF0C\u5E2E\u52A9\u7528\u6237\u7406\u89E3\u5BB9\u5668\u5185\u5B58\u76D1\u63A7\u548C\u7BA1\u7406\u673A\u5236","source":"@site/docs/4-\u53EF\u89C2\u6D4B\u6027/1-\u76D1\u63A7\u6280\u672F/5-Cadvisor working set bytes\u4E0Elinux oom killer.md","sourceDirName":"4-\u53EF\u89C2\u6D4B\u6027/1-\u76D1\u63A7\u6280\u672F","slug":"/cadvisor-working-set-bytes-oom-killer","permalink":"/cadvisor-working-set-bytes-oom-killer","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"slug":"/cadvisor-working-set-bytes-oom-killer","title":"Cadvisor working set bytes\u4E0Elinux oom killer","hide_title":true,"keywords":["Cadvisor","Working Set","OOM Killer","Linux","\u5185\u5B58\u7BA1\u7406","\u5BB9\u5668\u76D1\u63A7","\u8D44\u6E90\u9650\u5236"],"description":"\u63A2\u8BA8 Cadvisor \u4E2D working set bytes \u7684\u6982\u5FF5\u4EE5\u53CA\u5176\u4E0E Linux OOM killer \u7684\u5173\u7CFB\uFF0C\u5E2E\u52A9\u7528\u6237\u7406\u89E3\u5BB9\u5668\u5185\u5B58\u76D1\u63A7\u548C\u7BA1\u7406\u673A\u5236"},"sidebar":"mainSidebar","previous":{"title":"Linux\u4E2D\u8FDB\u7A0B\u5185\u5B58\u53CAcgroup\u5185\u5B58\u7EDF\u8BA1\u5DEE\u5F02","permalink":"/linux-memory-cgroup-statistics"},"next":{"title":"\u4ECEkubelet\u83B7\u53D6cadvisor\u6307\u6807\u5076\u73B0\u4E22\u5931container*\u76F8\u5173\u6307\u6807","permalink":"/kubelet-cadvisor-metrics-missing"}}'),o=n("85893"),s=n("50065");let a={slug:"/cadvisor-working-set-bytes-oom-killer",title:"Cadvisor working set bytes\u4E0Elinux oom killer",hide_title:!0,keywords:["Cadvisor","Working Set","OOM Killer","Linux","\u5185\u5B58\u7BA1\u7406","\u5BB9\u5668\u76D1\u63A7","\u8D44\u6E90\u9650\u5236"],description:"\u63A2\u8BA8 Cadvisor \u4E2D working set bytes \u7684\u6982\u5FF5\u4EE5\u53CA\u5176\u4E0E Linux OOM killer \u7684\u5173\u7CFB\uFF0C\u5E2E\u52A9\u7528\u6237\u7406\u89E3\u5BB9\u5668\u5185\u5B58\u76D1\u63A7\u548C\u7BA1\u7406\u673A\u5236"},i=void 0,l={},m=[{value:"\u80CC\u666F",id:"\u80CC\u666F",level:2},{value:"container_memory_working_set_bytes\u7684\u5177\u4F53\u5B9E\u73B0",id:"container_memory_working_set_bytes\u7684\u5177\u4F53\u5B9E\u73B0",level:2},{value:"OOM Killer\u673A\u5236",id:"oom-killer\u673A\u5236",level:2},{value:"\u53C2\u8003\u8D44\u6599",id:"\u53C2\u8003\u8D44\u6599",level:2}];function c(e){let r={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.h2,{id:"\u80CC\u666F",children:"\u80CC\u666F"}),"\n",(0,o.jsxs)(r.p,{children:["\u5185\u5B58\u4F7F\u7528\u7387\u544A\u8B66\u7684",(0,o.jsx)(r.code,{children:"promeql"}),"\u5982\u4E0B\uFF1A"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-text",children:'100*(sum (container_memory_working_set_bytes{namespace=~"argo|khaos|obs|kube-system"}) by (khaos_product,khaos_cluster,namespace,app_name,pod,container)/sum (container_spec_memory_limit_bytes{namespace=~"argo|khaos|obs|kube-system"}) by (khaos_product,khaos_cluster,namespace,app_name,pod,container) <= 1)\n'})}),"\n",(0,o.jsxs)(r.p,{children:["\u5176\u4E2D",(0,o.jsx)(r.code,{children:"container_memory_working_set_bytes"}),"\u5305\u542B\u4E86",(0,o.jsx)(r.code,{children:"pagecache"}),"\u5185\u5B58\uFF0C\u5982\u679C\u5BB9\u5668\u4F7F\u7528\u4E86\u8F83\u591A\u7684",(0,o.jsx)(r.code,{children:"pagecache"}),"\uFF0C\u8BA1\u7B97\u51FA\u6765\u7684\u5185\u5B58\u4F7F\u7528\u7387\u4F1A\u6BD4\u8F83\u504F\u9AD8\u3002\u90A3\u4E48\u6211\u4EEC\u9700\u8981\u5173\u5FC3\u7684\u6307\u6807\u5E94\u8BE5\u662F\u54EA\u4E9B\u5462\uFF1F\u8FD9\u9700\u8981\u89E3\u7B54",(0,o.jsx)(r.code,{children:"linux"}),"\u5185\u6838",(0,o.jsx)(r.code,{children:"oom killer"}),"\u4F9D\u8D56\u54EA\u4E9B\u5177\u4F53\u7684",(0,o.jsx)(r.code,{children:"cgroup"}),"\u6307\u6807\u9879\u6765\u6267\u884C",(0,o.jsx)(r.code,{children:"oom kill"}),"\u3002"]}),"\n",(0,o.jsx)(r.h2,{id:"container_memory_working_set_bytes\u7684\u5177\u4F53\u5B9E\u73B0",children:"container_memory_working_set_bytes\u7684\u5177\u4F53\u5B9E\u73B0"}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.code,{children:"cadvisor"}),"\u4E2D\u7684\u6E90\u7801\u8BA1\u7B97\u5982\u4E0B\uFF1A"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'func setMemoryStats(s *cgroups.Stats, ret *info.ContainerStats) {\n    ret.Memory.Usage = s.MemoryStats.Usage.Usage\n    ret.Memory.MaxUsage = s.MemoryStats.Usage.MaxUsage\n    ret.Memory.Failcnt = s.MemoryStats.Usage.Failcnt\n    ret.Memory.KernelUsage = s.MemoryStats.KernelUsage.Usage\n\n    if cgroups.IsCgroup2UnifiedMode() {\n        ret.Memory.Cache = s.MemoryStats.Stats["file"]\n        ret.Memory.RSS = s.MemoryStats.Stats["anon"]\n        ret.Memory.Swap = s.MemoryStats.SwapUsage.Usage - s.MemoryStats.Usage.Usage\n        ret.Memory.MappedFile = s.MemoryStats.Stats["file_mapped"]\n    } else if s.MemoryStats.UseHierarchy {\n        ret.Memory.Cache = s.MemoryStats.Stats["total_cache"]\n        ret.Memory.RSS = s.MemoryStats.Stats["total_rss"]\n        ret.Memory.Swap = s.MemoryStats.Stats["total_swap"]\n        ret.Memory.MappedFile = s.MemoryStats.Stats["total_mapped_file"]\n    } else {\n        ret.Memory.Cache = s.MemoryStats.Stats["cache"]\n        ret.Memory.RSS = s.MemoryStats.Stats["rss"]\n        ret.Memory.Swap = s.MemoryStats.Stats["swap"]\n        ret.Memory.MappedFile = s.MemoryStats.Stats["mapped_file"]\n    }\n    if v, ok := s.MemoryStats.Stats["pgfault"]; ok {\n        ret.Memory.ContainerData.Pgfault = v\n        ret.Memory.HierarchicalData.Pgfault = v\n    }\n    if v, ok := s.MemoryStats.Stats["pgmajfault"]; ok {\n        ret.Memory.ContainerData.Pgmajfault = v\n        ret.Memory.HierarchicalData.Pgmajfault = v\n    }\n\n    inactiveFileKeyName := "total_inactive_file"\n    if cgroups.IsCgroup2UnifiedMode() {\n        inactiveFileKeyName = "inactive_file"\n    }\n\n    workingSet := ret.Memory.Usage\n    if v, ok := s.MemoryStats.Stats[inactiveFileKeyName]; ok {\n        if workingSet < v {\n            workingSet = 0\n        } else {\n            workingSet -= v\n        }\n    }\n    ret.Memory.WorkingSet = workingSet\n}\n'})}),"\n",(0,o.jsxs)(r.p,{children:["\xa0\u5176\u4E2D\u7684",(0,o.jsx)(r.code,{children:"s.MemoryStats.Usage.Usage"}),"\u6765\u6E90\u4E8E",(0,o.jsx)(r.code,{children:"github.com/opencontainers/runc"}),"\u5E93\uFF1A"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'func getMemoryData(path, name string) (cgroups.MemoryData, error) {\n    memoryData := cgroups.MemoryData{}\n\n    moduleName := "memory"\n    if name != "" {\n        moduleName = "memory." + name\n    }\n    var (\n        usage    = moduleName + ".usage_in_bytes"\n        maxUsage = moduleName + ".max_usage_in_bytes"\n        failcnt  = moduleName + ".failcnt"\n        limit    = moduleName + ".limit_in_bytes"\n    )\n\n    value, err := fscommon.GetCgroupParamUint(path, usage)\n    if err != nil {\n        if name != "" && os.IsNotExist(err) {\n            // Ignore ENOENT as swap and kmem controllers\n            // are optional in the kernel.\n            return cgroups.MemoryData{}, nil\n        }\n        return cgroups.MemoryData{}, err\n    }\n    memoryData.Usage = value\n    value, err = fscommon.GetCgroupParamUint(path, maxUsage)\n    if err != nil {\n        return cgroups.MemoryData{}, err\n    }\n    memoryData.MaxUsage = value\n    value, err = fscommon.GetCgroupParamUint(path, failcnt)\n    if err != nil {\n        return cgroups.MemoryData{}, err\n    }\n    memoryData.Failcnt = value\n    value, err = fscommon.GetCgroupParamUint(path, limit)\n    if err != nil {\n        if name == "kmem" && os.IsNotExist(err) {\n            // Ignore ENOENT as kmem.limit_in_bytes has\n            // been removed in newer kernels.\n            return memoryData, nil\n        }\n\n        return cgroups.MemoryData{}, err\n    }\n    memoryData.Limit = value\n\n    return memoryData, nil\n}\n'})}),"\n",(0,o.jsxs)(r.p,{children:["\u53EF\u4EE5\u770B\u5230",(0,o.jsx)(r.code,{children:"container_memory_working_set_bytes=memory.usage_in_bytes - memory.stat[total_inactive_file]"}),"\uFF0C\u5176\u4E2D\u7684",(0,o.jsx)(r.code,{children:"memory.usage_in_bytes"}),"\u5C31\u5305\u542B\u4E86",(0,o.jsx)(r.code,{children:"pagecache"}),"\u5185\u5BB9\u3002"]}),"\n",(0,o.jsx)(r.h2,{id:"oom-killer\u673A\u5236",children:"OOM Killer\u673A\u5236"}),"\n",(0,o.jsxs)(r.p,{children:["\u5728",(0,o.jsx)(r.code,{children:"linux oom-killer"}),"\u7684\u6E90\u7801\u4E2D\uFF0C\u4E3B\u8981\u4F7F\u7528\u7684\u662F",(0,o.jsx)(r.code,{children:"rss+swap+pagetable"}),"\u6765\u8BA1\u7B97",(0,o.jsx)(r.code,{children:"oom"}),"\u5206\u503C ",(0,o.jsx)(r.a,{href:"https://elixir.bootlin.com/linux/v5.4.58/source/mm/oom_kill.c#L227",children:"https://elixir.bootlin.com/linux/v5.4.58/source/mm/oom_kill.c#L227"})," \u56E0\u6B64\u5728",(0,o.jsx)(r.code,{children:"pagecache"}),"\u6BD4\u8F83\u5927\u7684\u573A\u666F\u4E0B\u53EF\u4EE5\u4F7F\u7528\u5E95\u5C42\u5DF2\u7ECF\u63D0\u4F9B\u7684\u4E24\u4E2A\u6307\u6807",(0,o.jsx)(r.code,{children:"container_memory_rss+container_memory_swap"}),"\u6765\u66FF\u4EE3",(0,o.jsx)(r.code,{children:"container_memory_working_set_bytes"}),"\u8BA1\u7B97\u5185\u5B58\u4F7F\u7528\u7387\u3002"]}),"\n",(0,o.jsx)(r.h2,{id:"\u53C2\u8003\u8D44\u6599",children:"\u53C2\u8003\u8D44\u6599"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsx)(r.p,{children:(0,o.jsx)(r.a,{href:"https://www.baeldung.com/linux/memory-overcommitment-oom-killer",children:"https://www.baeldung.com/linux/memory-overcommitment-oom-killer"})}),"\n"]}),"\n"]})]})}function d(e={}){let{wrapper:r}={...(0,s.a)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},50065:function(e,r,n){n.d(r,{Z:function(){return i},a:function(){return a}});var t=n(67294);let o={},s=t.createContext(o);function a(e){let r=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function i(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(s.Provider,{value:r},e.children)}}}]);