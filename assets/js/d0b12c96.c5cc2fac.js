"use strict";(self.webpackChunkgf_site=self.webpackChunkgf_site||[]).push([["9090"],{49271:function(e,n,s){s.r(n),s.d(n,{metadata:()=>i,contentTitle:()=>c,default:()=>h,assets:()=>r,toc:()=>o,frontMatter:()=>l});var i=JSON.parse('{"id":"docs/\u65E5\u5E38\u7B14\u8BB0/MySQL 5.7 insert into on duplicate \u6B7B\u9501","title":"MySQL 5.7 insert into on duplicate \u6B7B\u9501","description":"\u5206\u6790 MySQL 5.7 \u4E2D\u4F7F\u7528 insert into on duplicate \u8BED\u53E5\u65F6\u53EF\u80FD\u51FA\u73B0\u7684\u6B7B\u9501\u95EE\u9898\u53CA\u5176\u89E3\u51B3\u65B9\u6848","source":"@site/docs/docs/9000-\u65E5\u5E38\u7B14\u8BB0/MySQL 5.7 insert into on duplicate \u6B7B\u9501.md","sourceDirName":"docs/9000-\u65E5\u5E38\u7B14\u8BB0","slug":"/notes/mysql-insert-duplicate-deadlock","permalink":"/notes/mysql-insert-duplicate-deadlock","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"slug":"/notes/mysql-insert-duplicate-deadlock","title":"MySQL 5.7 insert into on duplicate \u6B7B\u9501","hide_title":true,"keywords":["MySQL","\u6B7B\u9501","insert into","on duplicate","\u6570\u636E\u5E93","\u5E76\u53D1","\u6027\u80FD\u4F18\u5316"],"description":"\u5206\u6790 MySQL 5.7 \u4E2D\u4F7F\u7528 insert into on duplicate \u8BED\u53E5\u65F6\u53EF\u80FD\u51FA\u73B0\u7684\u6B7B\u9501\u95EE\u9898\u53CA\u5176\u89E3\u51B3\u65B9\u6848"},"sidebar":"mainSidebar","previous":{"title":"Make \u547D\u4EE4\u6559\u7A0B","permalink":"/notes/make-command-tutorial"},"next":{"title":"VSCode\u8BBE\u7F6EMarkdown\u622A\u56FE\u6587\u4EF6\u5B58\u653E\u8DEF\u5F84","permalink":"/notes/vscode-image-path-setting"}}'),t=s("85893"),d=s("50065");let l={slug:"/notes/mysql-insert-duplicate-deadlock",title:"MySQL 5.7 insert into on duplicate \u6B7B\u9501",hide_title:!0,keywords:["MySQL","\u6B7B\u9501","insert into","on duplicate","\u6570\u636E\u5E93","\u5E76\u53D1","\u6027\u80FD\u4F18\u5316"],description:"\u5206\u6790 MySQL 5.7 \u4E2D\u4F7F\u7528 insert into on duplicate \u8BED\u53E5\u65F6\u53EF\u80FD\u51FA\u73B0\u7684\u6B7B\u9501\u95EE\u9898\u53CA\u5176\u89E3\u51B3\u65B9\u6848"},c=void 0,r={},o=[{value:"\u4E00\u3001\u95EE\u9898\u590D\u73B0",id:"\u4E00\u95EE\u9898\u590D\u73B0",level:2},{value:"\u4E8C\u3001\u9501\u673A\u5236\u5206\u6790",id:"\u4E8C\u9501\u673A\u5236\u5206\u6790",level:2},{value:"\u4E09\u3001\u4E3A\u4EC0\u4E48\u4F1A\u6709gap\u9501",id:"\u4E09\u4E3A\u4EC0\u4E48\u4F1A\u6709gap\u9501",level:2},{value:"\u4E09\u3001\u5173\u4E8Egap\u9501\u4ECB\u7ECD",id:"\u4E09\u5173\u4E8Egap\u9501\u4ECB\u7ECD",level:2},{value:"\u56DB\u3001\u89E3\u51B3\u65B9\u6848",id:"\u56DB\u89E3\u51B3\u65B9\u6848",level:2},{value:"1\u3001\u5347\u7EA7\u7248\u672C",id:"1\u5347\u7EA7\u7248\u672C",level:3},{value:"2\u3001\u5C31\u662F\u8981\u75285.7\u7248\u672C",id:"2\u5C31\u662F\u8981\u752857\u7248\u672C",level:3}];function a(e){let n={a:"a",blockquote:"blockquote",br:"br",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"\u4E00\u95EE\u9898\u590D\u73B0",children:"\u4E00\u3001\u95EE\u9898\u590D\u73B0"}),"\n",(0,t.jsx)(n.p,{children:"\u8868\u7ED3\u6784\uFF1A"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `test` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `alias` int(11) NOT NULL,\n  `age` int(11) NOT NULL DEFAULT '0',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `u_idx_alias` (`alias`) USING BTREE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u4E8B\u52A1\u9694\u79BB\u7EA7\u522B\u4E3A",(0,t.jsx)(n.code,{children:"MySQL"}),"\u9ED8\u8BA4\u7684",(0,t.jsx)(n.code,{children:"RR"}),"\uFF08\u53EF\u91CD\u590D\u8BFB\uFF09"]}),"\n",(0,t.jsxs)(n.p,{children:["\u6570\u636E\u5E93\u7248\u672C\uFF1A",(0,t.jsx)(n.code,{children:"5.7.20"})]}),"\n",(0,t.jsx)(n.p,{children:"\u63D2\u5165\u6570\u636E\uFF1A"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"insert into test(alias,age) values(1,1),(3,3),(5,5),(7,7);\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u6B7B\u9501\u524D\u63D0\u6761\u4EF6\uFF1A\u591A\u4E2A\u5E76\u53D1\u540C\u65F6\u6267\u884C",(0,t.jsx)(n.code,{children:"insert into on duplicate update xxx"})," \u5224\u65AD\u552F\u4E00\u952E\u662F\u5426\u5B58\u5728\uFF0C\u5B58\u5728\u66F4\u65B0\u6570\u636E"]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{}),(0,t.jsx)(n.th,{}),(0,t.jsx)(n.th,{}),(0,t.jsx)(n.th,{})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"\u65F6\u95F4\u6233"}),(0,t.jsx)(n.td,{children:"\u4E8B\u52A11"}),(0,t.jsx)(n.td,{children:"\u4E8B\u52A12"}),(0,t.jsx)(n.td,{children:"\u4E8B\u52A13"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"T1"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"begin;insert into \xa0`test`(`alias`,`age`) values(9,9) on duplicate key update age=9;"})}),(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"T2"}),(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"begin;insert into \xa0`test`(`alias`,`age`) values(10,10) on duplicate key update age=11;"})}),(0,t.jsx)(n.td,{})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"T3"}),(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"begin;insert into \xa0`test`(`alias`,`age`) values(11,11) on duplicate key update age=11;"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"T4"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"commit;"})}),(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction"})})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"\u4E8C\u9501\u673A\u5236\u5206\u6790",children:"\u4E8C\u3001\u9501\u673A\u5236\u5206\u6790"}),"\n",(0,t.jsxs)(n.p,{children:["\u8FD9\u91CC\u6211\u4EEC\u6765\u5177\u4F53\u5206\u6790\u4E00\u4E0B\u5230\u5E95\u52A0\u4E86\u4EC0\u4E48\u9501\uFF0C\u6211\u4EEC\u77E5\u9053insert\u63D2\u5165\u64CD\u4F5C\u7684\u65F6\u5019\u4F1A\u52A0 X\u9501\u548C\u63D2\u5165\u610F\u5411\u9501\uFF0C\u8FD9\u91CC\u6211\u4EEC\u770B\u770B ",(0,t.jsx)(n.code,{children:"insert into on duplicate key"}),"\u52A0\u4EC0\u4E48\u9501,"]}),"\n",(0,t.jsx)(n.p,{children:"\u9996\u5148\u6253\u5F00\uFF1A"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"set GLOBAL innodb_status_output_locks=ON;\nset GLOBAL innodb_status_output=ON;\n"})}),"\n",(0,t.jsx)(n.p,{children:"MySQL\u7684\u9501\u7EDF\u8BA1\uFF0C\u8FD9\u4E2A\u7EBF\u4E0A\u4E0D\u63A8\u8350\u6253\u5F00\u6253\u5F00\u7684\u8BDD\u65E5\u5FD7\u4F1A\u8BB0\u5F55\u5F97\u6BD4\u8F83\u591A\u3002"}),"\n",(0,t.jsxs)(n.p,{children:["\u9996\u5148\u6267\u884C\u7B2C\u4E00\u4E2ASQL\uFF0C\u8F93\u5165",(0,t.jsx)(n.code,{children:"show engine innodb status"}),"\u547D\u4EE4\u67E5\u770B\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u5728\u6267\u884C\u6267\u884C\u7B2C\u4E8C\u4E2ASQL\uFF0C\u53D1\u73B0\u5176\u63D2\u5165\u610F\u5411\u9501\u6B63\u5728\u88AB",(0,t.jsx)(n.code,{children:"gap\u9501"}),"\u963B\u585E\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u540C\u6837\u7684\u5982\u679C\u6211\u4EEC\u6267\u884C\u7B2C\u4E09\u4E2ASQL\uFF0C\u63D2\u5165\u610F\u5411\u9501\u4E5F\u4F1A\u88AB\u7B2C\u4E00\u4E2A\u4E8B\u52A1",(0,t.jsx)(n.code,{children:"gap\u9501"}),"\u963B\u585E\uFF0C\u5982\u679C\u7B2C\u4E00\u4E2A\u4E8B\u52A1\u7684",(0,t.jsx)(n.code,{children:"gap\u9501"}),"\u63D0\u4EA4\uFF0C\u4ED6\u4EEC\u9996\u5148\u53C8\u4F1A\u5148\u83B7\u53D6",(0,t.jsx)(n.code,{children:"gap\u9501("}),"\u8FD9\u91CC\u4ECE\u9501\u7684\u4FE1\u606F\u5224\u65AD\uFF0C\u88AB\u963B\u585E\u7684\u65F6\u5019\u662F\u6CA1\u6709",(0,t.jsx)(n.code,{children:"gap\u9501"}),")\uFF0C\u5176\u6B21\u518D\u83B7\u53D6\u63D2\u5165\u610F\u5411\u9501\uFF0C\u5C31\u5BFC\u81F4\u4E86T2\u3001T3\u4E24\u4E2A\u5F62\u6210\u5FAA\u73AF\u94FE\u8DEF\uFF0C\u6700\u7EC8\u5BFC\u81F4\u6B7B\u9501\u3002"]}),"\n",(0,t.jsx)(n.h2,{id:"\u4E09\u4E3A\u4EC0\u4E48\u4F1A\u6709gap\u9501",children:"\u4E09\u3001\u4E3A\u4EC0\u4E48\u4F1A\u6709gap\u9501"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"gap\u9501"}),"\u662F",(0,t.jsx)(n.code,{children:"RR"}),"\u9694\u79BB\u7EA7\u522B\u4E0B\u7528\u6765\u89E3\u51B3\u5E7B\u8BFB\u7684\u4E00\u4E2A\u624B\u6BB5\uFF0C\u4E00\u822C\u51FA\u73B0\u5728",(0,t.jsx)(n.code,{children:"delete"}),"\u4E2D\uFF0C\u4E3A\u4EC0\u4E48\u4F1A\u51FA\u73B0\u5728\u8FD9\u91CC\u5462\uFF1F\u8FD9\u5176\u5B9E\u662F\u4E00\u4E2A",(0,t.jsx)(n.code,{children:"BUG"}),"\uFF0C\u5728 ",(0,t.jsx)(n.a,{href:"https://bugs.mysql.com/bug.php?id=50413",children:"https://bugs.mysql.com/bug.php?id=50413"})," \u8FD9\u4E2A",(0,t.jsx)(n.code,{children:"BUG"}),"\u4E2D\u53EF\u4EE5\u770B\u89C1\uFF1A"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:['Concurrent "INSERT \u2026ON DUPLICATE KEY UPDATE" statements run on a table',(0,t.jsx)(n.br,{}),"\n","with multiple unique indexes would sometimes cause events to be written to",(0,t.jsx)(n.br,{}),"\n","the binary log incorrectly"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["\u5F53\u6211\u4EEC\u5E76\u53D1\u7684\u7528",(0,t.jsx)(n.code,{children:"INSERT \u2026ON DUPLICATE KEY UPDATE"}),"\u7684\u65F6\u5019\uFF0C\u5982\u679C\u6211\u4EEC\u6709\u591A\u4E2A\u552F\u4E00\u7D22\u5F15\uFF0C\u90A3\u4E48\u6709\u53EF\u80FD\u4F1A\u5BFC\u81F4binlog\u9519\u8BEF\uFF0C\u4E5F\u5C31\u662F\u4F1A\u5BFC\u81F4\u4E3B\u4ECE\u590D\u5236\u4E0D\u4E00\u81F4\uFF0C\u5177\u4F53\u7684\u4E00\u4E9B\u6D4B\u8BD5\u53EF\u4EE5\u53BB\u94FE\u63A5\u4E2D\u67E5\u770B\u3002"]}),"\n",(0,t.jsx)(n.h2,{id:"\u4E09\u5173\u4E8Egap\u9501\u4ECB\u7ECD",children:"\u4E09\u3001\u5173\u4E8Egap\u9501\u4ECB\u7ECD"}),"\n",(0,t.jsx)(n.p,{children:"\u95F4\u9699\u9501\u5B9E\u8D28\u4E0A\u662F\u5BF9\u7D22\u5F15\u524D\u540E\u7684\u95F4\u9699\u4E0A\u9501\uFF0C\u4E0D\u5BF9\u7D22\u5F15\u672C\u8EAB\u4E0A\u9501\u3002\u6839\u636E\u68C0\u7D22\u6761\u4EF6\u5411\u5DE6\u5BFB\u627E\u6700\u9760\u8FD1\u68C0\u7D22\u6761\u4EF6\u7684\u8BB0\u5F55\u503CA\uFF0C\u4F5C\u4E3A\u5DE6\u533A\u95F4\uFF0C\u5411\u53F3\u5BFB\u627E\u6700\u9760\u8FD1\u68C0\u7D22\u6761\u4EF6\u7684\u8BB0\u5F55\u503CB\u4F5C\u4E3A\u53F3\u533A\u95F4\uFF0C\u5373\u9501\u5B9A\u7684\u95F4\u9699\u4E3A\uFF08A\uFF0CB\uFF09\u3002\u95F4\u9699\u9501\u7684\u76EE\u7684\u662F\u4E3A\u4E86\u9632\u6B62\u5E7B\u8BFB\uFF0C\u5176\u4E3B\u8981\u901A\u8FC7\u4E24\u4E2A\u65B9\u9762\u5B9E\u73B0\u8FD9\u4E2A\u76EE\u7684\uFF1A"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"\u9632\u6B62\u95F4\u9699\u5185\u6709\u65B0\u6570\u636E\u88AB\u63D2\u5165\u3002"}),"\n",(0,t.jsx)(n.li,{children:"\u9632\u6B62\u5DF2\u5B58\u5728\u7684\u6570\u636E\uFF0C\u66F4\u65B0\u6210\u95F4\u9699\u5185\u7684\u6570"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u793A\u4F8B\u6570\u636E\uFF1A"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-text",children:"+----+------+\n| id | n    |\n+----+------+\n| 1  | 1    |\n| 3  | 102  |\n| 5  | 105  |\n| 7  | 107  |\n| 9  | 109  |\n+----+------+\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u5982\u679C\u4E8B\u52A1A\u5F00\u542F\u4E00\u4E2A\u4E8B\u52A1\uFF0C\u6267\u884C",(0,t.jsx)(n.code,{children:"select * from test where n = 105 for update"}),"\u4F1A\u5BF9 ",(0,t.jsx)(n.code,{children:"n"})," \u5728 ",(0,t.jsx)(n.code,{children:"(102,105), (105, 107)"}),"\u7684\u6570\u636E\u4E0A\u9501\u3002"]}),"\n",(0,t.jsx)(n.h2,{id:"\u56DB\u89E3\u51B3\u65B9\u6848",children:"\u56DB\u3001\u89E3\u51B3\u65B9\u6848"}),"\n",(0,t.jsx)(n.h3,{id:"1\u5347\u7EA7\u7248\u672C",children:"1\u3001\u5347\u7EA7\u7248\u672C"}),"\n",(0,t.jsxs)(n.p,{children:["\u7531\u4E8E\u662F\u4E00\u4E2ABUG\uFF0C\u56E0\u6B64\u5347\u7EA7",(0,t.jsx)(n.code,{children:"MySQL"}),"\u7248\u672C\u5230",(0,t.jsx)(n.code,{children:"5.7.35"}),"\u53CA\u4EE5\u4E0A\u7248\u672C\u5373\u53EF\u89E3\u51B3\uFF0C\u6BD4\u5982MySQL 8\u4EE5\u4E0A\u7248\u672C\u4E5F\u6CA1\u7C7B\u4F3C\u95EE\u9898\u3002"]}),"\n",(0,t.jsx)(n.h3,{id:"2\u5C31\u662F\u8981\u752857\u7248\u672C",children:"2\u3001\u5C31\u662F\u8981\u75285.7\u7248\u672C"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u4F7F\u7528",(0,t.jsx)(n.code,{children:"RC"}),"\u7EA7\u522B\uFF0C",(0,t.jsx)(n.code,{children:"RC"}),"\u9694\u79BB\u7EA7\u522B\u4E0B\u4E0D\u4F1A\u6709",(0,t.jsx)(n.code,{children:"gap\u9501"})]}),"\n",(0,t.jsx)(n.li,{children:"\u5728\u6570\u636E\u5E93\u8868\u4E2D\u53EA\u5EFA\u7ACB\u4E3B\u952E\uFF0C\u4E0D\u5EFA\u7ACB\u5176\u4ED6\u552F\u4E00\u7D22\u5F15\u3002"}),"\n",(0,t.jsxs)(n.li,{children:["\u4E0D\u4F7F\u7528 ",(0,t.jsx)(n.code,{children:"insert on duplicate key update"}),"\uFF0C\u4F7F\u7528\u666E\u901A\u7684",(0,t.jsx)(n.code,{children:"insert"}),"\u3002\u6839\u636E\u4E1A\u52A1\u573A\u666F\u5224\u65AD",(0,t.jsx)(n.code,{children:"ON DUPLICATE KEY UPDATE"})," \u662F\u5426\u6709\u5FC5\u8981","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["\u5148",(0,t.jsx)(n.code,{children:"insert"})," \u518D\u6355\u83B7\u5F02\u5E38\uFF0C\u7136\u540E\u8FDB\u884C\u66F4\u65B0"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["\u4F7F\u7528",(0,t.jsx)(n.code,{children:"insert ignore"}),"\uFF0C\u7136\u540E\u5224\u65AD ",(0,t.jsx)(n.code,{children:"affected rows"})," \u662F\u5426\u662F1\uFF0C\u7136\u540E\u518D\u51B3\u5B9A\u662F\u5426\u66F4\u65B0\u3002"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,d.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},50065:function(e,n,s){s.d(n,{Z:function(){return c},a:function(){return l}});var i=s(67294);let t={},d=i.createContext(t);function l(e){let n=i.useContext(d);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),i.createElement(d.Provider,{value:n},e.children)}}}]);