"use strict";(self.webpackChunkgf_site=self.webpackChunkgf_site||[]).push([["388"],{70559:function(n,e,r){r.r(e),r.d(e,{metadata:()=>d,contentTitle:()=>t,default:()=>h,assets:()=>c,toc:()=>o,frontMatter:()=>l});var d=JSON.parse('{"id":"docs/AI\u6280\u672F/AI\u57FA\u7840\u67B6\u6784/HPC/Kubeflow Trainer/Kubeflow Trainer PyTorch\u5E76\u884C\u8BA1\u7B97","title":"Kubeflow Trainer PyTorch\u5E76\u884C\u8BA1\u7B97","description":"\u6DF1\u5165\u4ECB\u7ECDKubeflow Trainer\u5982\u4F55\u652F\u6301PyTorch\u6846\u67B6\u5B9E\u73B0HPC\u5E76\u884C\u8BA1\u7B97\u80FD\u529B\uFF0C\u5305\u62ECHPC\u5E76\u884C\u8BA1\u7B97\u57FA\u7840\u7279\u6027\u3001PyTorch\u5206\u5E03\u5F0F\u8BAD\u7EC3\u539F\u7406\u3001Kubeflow Trainer\u7684CRD\u8BBE\u8BA1\u4E0E\u7EC4\u4EF6\u67B6\u6784\u3001torchrun\u81EA\u52A8\u914D\u7F6E\u673A\u5236\uFF0C\u4EE5\u53CA\u7B97\u6CD5\u5DE5\u7A0B\u5E08\u5982\u4F55\u5728\u4EE3\u7801\u4E2D\u4F7F\u7528\u5E76\u884C\u8BA1\u7B97\u80FD\u529B","source":"@site/docs/docs/1000-AI\u6280\u672F/200-AI\u57FA\u7840\u67B6\u6784/550-HPC/100-Kubeflow Trainer/2000-Kubeflow Trainer PyTorch\u5E76\u884C\u8BA1\u7B97.md","sourceDirName":"docs/1000-AI\u6280\u672F/200-AI\u57FA\u7840\u67B6\u6784/550-HPC/100-Kubeflow Trainer","slug":"/ai/kubeflow-trainer-pytorch-parallel-computing","permalink":"/ai/kubeflow-trainer-pytorch-parallel-computing","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2000,"frontMatter":{"slug":"/ai/kubeflow-trainer-pytorch-parallel-computing","title":"Kubeflow Trainer PyTorch\u5E76\u884C\u8BA1\u7B97","hide_title":true,"keywords":["Kubeflow Trainer","PyTorch","\u5E76\u884C\u8BA1\u7B97","\u5206\u5E03\u5F0F\u8BAD\u7EC3","DDP","FSDP","torchrun","HPC","\u6570\u636E\u5E76\u884C","\u6A21\u578B\u5E76\u884C","NCCL","Gloo","torch.distributed","DistributedDataParallel","FullyShardedDataParallel","GPU\u8BAD\u7EC3","\u591A\u673A\u591A\u5361","TrainJob","TrainingRuntime","Kubernetes","\u5206\u5E03\u5F0F\u73AF\u5883\u53D8\u91CF","WORLD_SIZE","RANK","LOCAL_RANK"],"description":"\u6DF1\u5165\u4ECB\u7ECDKubeflow Trainer\u5982\u4F55\u652F\u6301PyTorch\u6846\u67B6\u5B9E\u73B0HPC\u5E76\u884C\u8BA1\u7B97\u80FD\u529B\uFF0C\u5305\u62ECHPC\u5E76\u884C\u8BA1\u7B97\u57FA\u7840\u7279\u6027\u3001PyTorch\u5206\u5E03\u5F0F\u8BAD\u7EC3\u539F\u7406\u3001Kubeflow Trainer\u7684CRD\u8BBE\u8BA1\u4E0E\u7EC4\u4EF6\u67B6\u6784\u3001torchrun\u81EA\u52A8\u914D\u7F6E\u673A\u5236\uFF0C\u4EE5\u53CA\u7B97\u6CD5\u5DE5\u7A0B\u5E08\u5982\u4F55\u5728\u4EE3\u7801\u4E2D\u4F7F\u7528\u5E76\u884C\u8BA1\u7B97\u80FD\u529B"},"sidebar":"mainSidebar","previous":{"title":"Kubeflow Trainer In HPC","permalink":"/ai/kubeflow-trainer-in-hpc"},"next":{"title":"Kubeflow Trainer CRD\u914D\u7F6E\u683C\u5F0F\u8BE6\u89E3","permalink":"/ai/kubeflow-trainer-crd-reference"}}'),i=r("85893"),s=r("50065");let l={slug:"/ai/kubeflow-trainer-pytorch-parallel-computing",title:"Kubeflow Trainer PyTorch\u5E76\u884C\u8BA1\u7B97",hide_title:!0,keywords:["Kubeflow Trainer","PyTorch","\u5E76\u884C\u8BA1\u7B97","\u5206\u5E03\u5F0F\u8BAD\u7EC3","DDP","FSDP","torchrun","HPC","\u6570\u636E\u5E76\u884C","\u6A21\u578B\u5E76\u884C","NCCL","Gloo","torch.distributed","DistributedDataParallel","FullyShardedDataParallel","GPU\u8BAD\u7EC3","\u591A\u673A\u591A\u5361","TrainJob","TrainingRuntime","Kubernetes","\u5206\u5E03\u5F0F\u73AF\u5883\u53D8\u91CF","WORLD_SIZE","RANK","LOCAL_RANK"],description:"\u6DF1\u5165\u4ECB\u7ECDKubeflow Trainer\u5982\u4F55\u652F\u6301PyTorch\u6846\u67B6\u5B9E\u73B0HPC\u5E76\u884C\u8BA1\u7B97\u80FD\u529B\uFF0C\u5305\u62ECHPC\u5E76\u884C\u8BA1\u7B97\u57FA\u7840\u7279\u6027\u3001PyTorch\u5206\u5E03\u5F0F\u8BAD\u7EC3\u539F\u7406\u3001Kubeflow Trainer\u7684CRD\u8BBE\u8BA1\u4E0E\u7EC4\u4EF6\u67B6\u6784\u3001torchrun\u81EA\u52A8\u914D\u7F6E\u673A\u5236\uFF0C\u4EE5\u53CA\u7B97\u6CD5\u5DE5\u7A0B\u5E08\u5982\u4F55\u5728\u4EE3\u7801\u4E2D\u4F7F\u7528\u5E76\u884C\u8BA1\u7B97\u80FD\u529B"},t=void 0,c={},o=[{value:"1. HPC\u5E76\u884C\u8BA1\u7B97\u57FA\u7840\u7279\u6027",id:"1-hpc\u5E76\u884C\u8BA1\u7B97\u57FA\u7840\u7279\u6027",level:2},{value:"1.1 \u4EC0\u4E48\u662FHPC\u5E76\u884C\u8BA1\u7B97",id:"11-\u4EC0\u4E48\u662Fhpc\u5E76\u884C\u8BA1\u7B97",level:3},{value:"1.2 \u5E76\u884C\u8BA1\u7B97\u7684\u6838\u5FC3\u7279\u6027",id:"12-\u5E76\u884C\u8BA1\u7B97\u7684\u6838\u5FC3\u7279\u6027",level:3},{value:"1.3 AI\u8BAD\u7EC3\u4E2D\u7684\u5E76\u884C\u7B56\u7565",id:"13-ai\u8BAD\u7EC3\u4E2D\u7684\u5E76\u884C\u7B56\u7565",level:3},{value:"1.3.1 \u6570\u636E\u5E76\u884C\uFF08Data Parallelism\uFF09",id:"131-\u6570\u636E\u5E76\u884Cdata-parallelism",level:4},{value:"1.3.2 \u6A21\u578B\u5E76\u884C\uFF08Model Parallelism\uFF09",id:"132-\u6A21\u578B\u5E76\u884Cmodel-parallelism",level:4},{value:"1.4 \u5206\u5E03\u5F0F\u901A\u4FE1\u540E\u7AEF",id:"14-\u5206\u5E03\u5F0F\u901A\u4FE1\u540E\u7AEF",level:3},{value:"2. PyTorch\u5206\u5E03\u5F0F\u8BAD\u7EC3\u539F\u7406",id:"2-pytorch\u5206\u5E03\u5F0F\u8BAD\u7EC3\u539F\u7406",level:2},{value:"2.1 torch.distributed\u6838\u5FC3\u6982\u5FF5",id:"21-torchdistributed\u6838\u5FC3\u6982\u5FF5",level:3},{value:"2.2 \u5206\u5E03\u5F0F\u6570\u636E\u5E76\u884C\uFF08DDP\uFF09",id:"22-\u5206\u5E03\u5F0F\u6570\u636E\u5E76\u884Cddp",level:3},{value:"2.3 \u5168\u5206\u7247\u6570\u636E\u5E76\u884C\uFF08FSDP\uFF09",id:"23-\u5168\u5206\u7247\u6570\u636E\u5E76\u884Cfsdp",level:3},{value:"2.4 torchrun\u542F\u52A8\u5668",id:"24-torchrun\u542F\u52A8\u5668",level:3},{value:"3. Kubeflow Trainer PyTorch\u5E76\u884C\u8BA1\u7B97\u652F\u6301",id:"3-kubeflow-trainer-pytorch\u5E76\u884C\u8BA1\u7B97\u652F\u6301",level:2},{value:"3.1 \u6574\u4F53\u67B6\u6784",id:"31-\u6574\u4F53\u67B6\u6784",level:3},{value:"3.2 \u6838\u5FC3CRD\u8BBE\u8BA1",id:"32-\u6838\u5FC3crd\u8BBE\u8BA1",level:3},{value:"3.2.1 TrainJob",id:"321-trainjob",level:4},{value:"3.2.2 ClusterTrainingRuntime",id:"322-clustertrainingruntime",level:4},{value:"3.3 Torch Plugin\u5B9E\u73B0\u539F\u7406",id:"33-torch-plugin\u5B9E\u73B0\u539F\u7406",level:3},{value:"3.3.1 \u73AF\u5883\u53D8\u91CF\u6CE8\u5165",id:"331-\u73AF\u5883\u53D8\u91CF\u6CE8\u5165",level:4},{value:"3.3.2 numProcPerNode\u8BA1\u7B97\u903B\u8F91",id:"332-numprocpernode\u8BA1\u7B97\u903B\u8F91",level:4},{value:"3.4 \u6267\u884C\u6D41\u7A0B\u8BE6\u89E3",id:"34-\u6267\u884C\u6D41\u7A0B\u8BE6\u89E3",level:3},{value:"3.5 Headless Service\u4E0E\u8282\u70B9\u53D1\u73B0",id:"35-headless-service\u4E0E\u8282\u70B9\u53D1\u73B0",level:3},{value:"4. \u7B97\u6CD5\u5DE5\u7A0B\u5E08\u4F7F\u7528\u6307\u5357",id:"4-\u7B97\u6CD5\u5DE5\u7A0B\u5E08\u4F7F\u7528\u6307\u5357",level:2},{value:"4.1 \u662F\u5426\u9700\u8981\u611F\u77E5\u5E95\u5C42\u67B6\u6784\uFF1F",id:"41-\u662F\u5426\u9700\u8981\u611F\u77E5\u5E95\u5C42\u67B6\u6784",level:3},{value:"4.2 \u8BAD\u7EC3\u4EE3\u7801\u7F16\u5199\u89C4\u8303",id:"42-\u8BAD\u7EC3\u4EE3\u7801\u7F16\u5199\u89C4\u8303",level:3},{value:"4.3 \u4F7F\u7528Kubeflow Python SDK\u63D0\u4EA4\u4EFB\u52A1",id:"43-\u4F7F\u7528kubeflow-python-sdk\u63D0\u4EA4\u4EFB\u52A1",level:3},{value:"4.4 \u5173\u952E\u6CE8\u610F\u4E8B\u9879",id:"44-\u5173\u952E\u6CE8\u610F\u4E8B\u9879",level:3},{value:"4.4.1 \u6570\u636E\u52A0\u8F7D",id:"441-\u6570\u636E\u52A0\u8F7D",level:4},{value:"4.4.2 \u6A21\u578B\u4FDD\u5B58",id:"442-\u6A21\u578B\u4FDD\u5B58",level:4},{value:"4.4.3 \u65E5\u5FD7\u8F93\u51FA",id:"443-\u65E5\u5FD7\u8F93\u51FA",level:4},{value:"4.4.4 \u968F\u673A\u79CD\u5B50",id:"444-\u968F\u673A\u79CD\u5B50",level:4},{value:"4.5 FSDP\u4F7F\u7528\u793A\u4F8B",id:"45-fsdp\u4F7F\u7528\u793A\u4F8B",level:3},{value:"5. \u5B8C\u6574\u793A\u4F8B",id:"5-\u5B8C\u6574\u793A\u4F8B",level:2},{value:"5.1 TrainingRuntime\u914D\u7F6E",id:"51-trainingruntime\u914D\u7F6E",level:3},{value:"5.2 TrainJob\u63D0\u4EA4",id:"52-trainjob\u63D0\u4EA4",level:3},{value:"5.3 \u8BAD\u7EC3\u811A\u672C",id:"53-\u8BAD\u7EC3\u811A\u672C",level:3},{value:"6. \u53C2\u8003\u8D44\u6599",id:"6-\u53C2\u8003\u8D44\u6599",level:2}];function a(n){let e={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.a)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.h2,{id:"1-hpc\u5E76\u884C\u8BA1\u7B97\u57FA\u7840\u7279\u6027",children:"1. HPC\u5E76\u884C\u8BA1\u7B97\u57FA\u7840\u7279\u6027"}),"\n",(0,i.jsx)(e.h3,{id:"11-\u4EC0\u4E48\u662Fhpc\u5E76\u884C\u8BA1\u7B97",children:"1.1 \u4EC0\u4E48\u662FHPC\u5E76\u884C\u8BA1\u7B97"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"HPC"}),"\uFF08",(0,i.jsx)(e.code,{children:"High Performance Computing"}),"\uFF0C\u9AD8\u6027\u80FD\u8BA1\u7B97\uFF09\u662F\u6307\u5229\u7528\u591A\u4E2A\u8BA1\u7B97\u8D44\u6E90\uFF08\u5982",(0,i.jsx)(e.code,{children:"CPU"}),"\u3001",(0,i.jsx)(e.code,{children:"GPU"}),"\uFF09\u534F\u540C\u5DE5\u4F5C\uFF0C\u4EE5\u89E3\u51B3\u590D\u6742\u8BA1\u7B97\u95EE\u9898\u7684\u6280\u672F\u3002\u5728",(0,i.jsx)(e.code,{children:"AI"}),"\u6A21\u578B\u8BAD\u7EC3\u573A\u666F\u4E2D\uFF0C",(0,i.jsx)(e.code,{children:"HPC"}),"\u5E76\u884C\u8BA1\u7B97\u662F\u5B9E\u73B0\u5927\u89C4\u6A21\u6A21\u578B\u8BAD\u7EC3\u7684\u6838\u5FC3\u6280\u672F\u57FA\u7840\u3002"]}),"\n",(0,i.jsx)(e.h3,{id:"12-\u5E76\u884C\u8BA1\u7B97\u7684\u6838\u5FC3\u7279\u6027",children:"1.2 \u5E76\u884C\u8BA1\u7B97\u7684\u6838\u5FC3\u7279\u6027"}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u7279\u6027"}),(0,i.jsx)(e.th,{children:"\u63CF\u8FF0"}),(0,i.jsx)(e.th,{children:"\u5728AI\u8BAD\u7EC3\u4E2D\u7684\u5E94\u7528"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"\u4EFB\u52A1\u5206\u89E3"})}),(0,i.jsx)(e.td,{children:"\u5C06\u5927\u4EFB\u52A1\u62C6\u5206\u4E3A\u591A\u4E2A\u53EF\u5E76\u884C\u6267\u884C\u7684\u5B50\u4EFB\u52A1"}),(0,i.jsxs)(e.td,{children:["\u5C06\u8BAD\u7EC3\u6570\u636E\u5206\u7247\u5230\u591A\u4E2A",(0,i.jsx)(e.code,{children:"GPU"})]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"\u5E76\u884C\u6267\u884C"})}),(0,i.jsx)(e.td,{children:"\u591A\u4E2A\u8BA1\u7B97\u5355\u5143\u540C\u65F6\u5904\u7406\u4E0D\u540C\u5B50\u4EFB\u52A1"}),(0,i.jsxs)(e.td,{children:["\u591A",(0,i.jsx)(e.code,{children:"GPU"}),"\u540C\u65F6\u8BA1\u7B97\u68AF\u5EA6"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"\u901A\u4FE1\u540C\u6B65"})}),(0,i.jsx)(e.td,{children:"\u8BA1\u7B97\u5355\u5143\u95F4\u4EA4\u6362\u6570\u636E\u548C\u540C\u6B65\u72B6\u6001"}),(0,i.jsx)(e.td,{children:"\u68AF\u5EA6\u805A\u5408\u3001\u53C2\u6570\u540C\u6B65"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"\u7ED3\u679C\u5408\u5E76"})}),(0,i.jsx)(e.td,{children:"\u5C06\u5404\u8BA1\u7B97\u5355\u5143\u7684\u7ED3\u679C\u6C47\u603B"}),(0,i.jsx)(e.td,{children:"\u6A21\u578B\u53C2\u6570\u66F4\u65B0"})]})]})]}),"\n",(0,i.jsx)(e.h3,{id:"13-ai\u8BAD\u7EC3\u4E2D\u7684\u5E76\u884C\u7B56\u7565",children:"1.3 AI\u8BAD\u7EC3\u4E2D\u7684\u5E76\u884C\u7B56\u7565"}),"\n",(0,i.jsx)(e.mermaid,{value:'graph TB\n    subgraph "\u5E76\u884C\u7B56\u7565\u5206\u7C7B"\n        DP["\u6570\u636E\u5E76\u884C<br/>Data Parallelism"]\n        MP["\u6A21\u578B\u5E76\u884C<br/>Model Parallelism"]\n        PP["\u6D41\u6C34\u7EBF\u5E76\u884C<br/>Pipeline Parallelism"]\n        TP["\u5F20\u91CF\u5E76\u884C<br/>Tensor Parallelism"]\n    end\n    \n    subgraph "\u6570\u636E\u5E76\u884C\u539F\u7406"\n        D1["GPU 0: \u6570\u636E\u5206\u72471 + \u5B8C\u6574\u6A21\u578B"]\n        D2["GPU 1: \u6570\u636E\u5206\u72472 + \u5B8C\u6574\u6A21\u578B"]\n        D3["GPU 2: \u6570\u636E\u5206\u72473 + \u5B8C\u6574\u6A21\u578B"]\n        D4["GPU 3: \u6570\u636E\u5206\u72474 + \u5B8C\u6574\u6A21\u578B"]\n        SYNC["\u68AF\u5EA6\u540C\u6B65 AllReduce"]\n    end\n    \n    DP --\x3e D1\n    DP --\x3e D2\n    DP --\x3e D3\n    DP --\x3e D4\n    D1 --\x3e SYNC\n    D2 --\x3e SYNC\n    D3 --\x3e SYNC\n    D4 --\x3e SYNC'}),"\n",(0,i.jsx)(e.p,{children:"\u4E0A\u56FE\u6D89\u53CA\u5230\u7684\u4E00\u4E9B\u672F\u8BED\u89E3\u91CA\u5982\u4E0B\uFF1A"}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u672F\u8BED"}),(0,i.jsx)(e.th,{children:"\u542B\u4E49"}),(0,i.jsx)(e.th,{children:"\u5728\u6570\u636E\u5E76\u884C\u4E2D\u7684\u4F5C\u7528/\u5BF9\u5E94\u5173\u7CFB"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"\u6570\u636E\u5206\u7247\uFF08Data Sharding\uFF09"})}),(0,i.jsxs)(e.td,{children:["\u5C06\u6570\u636E\u96C6/\u4E00\u4E2A",(0,i.jsx)(e.code,{children:"batch"}),"\u6309\u6837\u672C\u7EF4\u5EA6\u5207\u5206\u7ED9\u4E0D\u540C\u8FDB\u7A0B"]}),(0,i.jsxs)(e.td,{children:["\u56FE\u4E2D",(0,i.jsx)(e.code,{children:"GPU 0/1/2/3"}),"\u5404\u81EA\u5904\u7406\u4E0D\u540C\u201C\u6570\u636E\u5206\u7247\u201D\uFF1B\u901A\u5E38\u7528",(0,i.jsx)(e.code,{children:"DistributedSampler"}),"\u4FDD\u8BC1\u4E0D\u91CD\u590D\u53D6\u6837"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"\u68AF\u5EA6\uFF08Gradient\uFF09"})}),(0,i.jsx)(e.td,{children:"\u53CD\u5411\u4F20\u64AD\u4EA7\u751F\u7684\u53C2\u6570\u5BFC\u6570 $\\nabla W$"}),(0,i.jsx)(e.td,{children:"\u6BCF\u4E2A\u8FDB\u7A0B\u5148\u7B97\u51FA\u4E00\u4EFD\u201C\u672C\u5730\u68AF\u5EA6\u201D\uFF0C\u7136\u540E\u518D\u505A\u540C\u6B65"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"\u68AF\u5EA6\u540C\u6B65\uFF08Gradient Synchronization\uFF09"})}),(0,i.jsx)(e.td,{children:"\u8BA9\u6240\u6709\u8FDB\u7A0B\u5F97\u5230\u4E00\u81F4\u7684\u68AF\u5EA6\uFF08\u6216\u7B49\u4EF7\u7684\u66F4\u65B0\u91CF\uFF09"}),(0,i.jsx)(e.td,{children:"\u6570\u636E\u5E76\u884C\u7684\u5173\u952E\uFF1A\u540C\u6B65\u540E\u6BCF\u4E2A\u8FDB\u7A0B\u7528\u201C\u540C\u4E00\u4EFD\u68AF\u5EA6\u201D\u66F4\u65B0\u53C2\u6570\uFF0C\u6A21\u578B\u4FDD\u6301\u4E00\u81F4"})]})]})]}),"\n",(0,i.jsx)(e.h4,{id:"131-\u6570\u636E\u5E76\u884Cdata-parallelism",children:"1.3.1 \u6570\u636E\u5E76\u884C\uFF08Data Parallelism\uFF09"}),"\n",(0,i.jsx)(e.p,{children:"\u6570\u636E\u5E76\u884C\u662F\u6700\u5E38\u7528\u7684\u5E76\u884C\u7B56\u7565\uFF0C\u5176\u6838\u5FC3\u601D\u60F3\u662F\uFF1A"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u6BCF\u4E2A",(0,i.jsx)(e.code,{children:"GPU"}),"\u6301\u6709\u5B8C\u6574\u7684\u6A21\u578B\u526F\u672C"]}),"\n",(0,i.jsxs)(e.li,{children:["\u8BAD\u7EC3\u6570\u636E\u88AB\u5206\u7247\u5230\u4E0D\u540C",(0,i.jsx)(e.code,{children:"GPU"})]}),"\n",(0,i.jsxs)(e.li,{children:["\u5404",(0,i.jsx)(e.code,{children:"GPU"}),"\u72EC\u7ACB\u8BA1\u7B97\u68AF\u5EA6"]}),"\n",(0,i.jsxs)(e.li,{children:["\u901A\u8FC7",(0,i.jsx)(e.code,{children:"AllReduce"}),"\u64CD\u4F5C\u540C\u6B65\u68AF\u5EA6"]}),"\n",(0,i.jsxs)(e.li,{children:["\u6240\u6709",(0,i.jsx)(e.code,{children:"GPU"}),"\u4F7F\u7528\u76F8\u540C\u7684\u68AF\u5EA6\u66F4\u65B0\u6A21\u578B"]}),"\n"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u9002\u7528\u573A\u666F"}),"\uFF1A\u6A21\u578B\u80FD\u591F\u653E\u5165\u5355\u4E2A",(0,i.jsx)(e.code,{children:"GPU"}),"\u663E\u5B58\u7684\u60C5\u51B5\u3002"]}),"\n",(0,i.jsx)(e.h4,{id:"132-\u6A21\u578B\u5E76\u884Cmodel-parallelism",children:"1.3.2 \u6A21\u578B\u5E76\u884C\uFF08Model Parallelism\uFF09"}),"\n",(0,i.jsxs)(e.p,{children:["\u5F53\u6A21\u578B\u8FC7\u5927\u65E0\u6CD5\u653E\u5165\u5355\u4E2A",(0,i.jsx)(e.code,{children:"GPU"}),"\u65F6\uFF0C\u9700\u8981\u5C06\u6A21\u578B\u62C6\u5206\u5230\u591A\u4E2A",(0,i.jsx)(e.code,{children:"GPU"}),"\uFF1A"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u6A21\u578B\u7684\u4E0D\u540C\u5C42\u5206\u5E03\u5728\u4E0D\u540C",(0,i.jsx)(e.code,{children:"GPU"}),"\u4E0A"]}),"\n",(0,i.jsxs)(e.li,{children:["\u6570\u636E\u5728",(0,i.jsx)(e.code,{children:"GPU"}),"\u95F4\u6D41\u52A8\uFF0C\u4F9D\u6B21\u7ECF\u8FC7\u5404\u5C42"]}),"\n",(0,i.jsxs)(e.li,{children:["\u9700\u8981\u5904\u7406",(0,i.jsx)(e.code,{children:"GPU"}),"\u95F4\u7684\u6FC0\u6D3B\u503C\u4F20\u9012"]}),"\n"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u9002\u7528\u573A\u666F"}),"\uFF1A\u8D85\u5927\u6A21\u578B\u8BAD\u7EC3\uFF08\u5982",(0,i.jsx)(e.code,{children:"GPT-3"}),"\u3001",(0,i.jsx)(e.code,{children:"LLaMA-70B"}),"\u7B49\uFF09\u3002"]}),"\n",(0,i.jsx)(e.h3,{id:"14-\u5206\u5E03\u5F0F\u901A\u4FE1\u540E\u7AEF",children:"1.4 \u5206\u5E03\u5F0F\u901A\u4FE1\u540E\u7AEF"}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u540E\u7AEF"}),(0,i.jsx)(e.th,{children:"\u9002\u7528\u573A\u666F"}),(0,i.jsx)(e.th,{children:"\u652F\u6301\u64CD\u4F5C"}),(0,i.jsx)(e.th,{children:"\u6027\u80FD\u7279\u70B9"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"NCCL"})}),(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"GPU"}),"\u96C6\u7FA4"]}),(0,i.jsx)(e.td,{children:"\u5168\u90E8\u96C6\u5408\u901A\u4FE1"}),(0,i.jsxs)(e.td,{children:["\u6700\u4F18",(0,i.jsx)(e.code,{children:"GPU"}),"\u901A\u4FE1\u6027\u80FD"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"Gloo"})}),(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"CPU"}),"/",(0,i.jsx)(e.code,{children:"GPU"})]}),(0,i.jsx)(e.td,{children:"\u5168\u90E8\u96C6\u5408\u901A\u4FE1"}),(0,i.jsx)(e.td,{children:"\u8DE8\u5E73\u53F0\u517C\u5BB9"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"MPI"})}),(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"HPC"}),"\u96C6\u7FA4"]}),(0,i.jsx)(e.td,{children:"\u70B9\u5BF9\u70B9+\u96C6\u5408\u901A\u4FE1"}),(0,i.jsxs)(e.td,{children:["\u4F20\u7EDF",(0,i.jsx)(e.code,{children:"HPC"}),"\u6807\u51C6"]})]})]})]}),"\n",(0,i.jsx)(e.h2,{id:"2-pytorch\u5206\u5E03\u5F0F\u8BAD\u7EC3\u539F\u7406",children:"2. PyTorch\u5206\u5E03\u5F0F\u8BAD\u7EC3\u539F\u7406"}),"\n",(0,i.jsx)(e.h3,{id:"21-torchdistributed\u6838\u5FC3\u6982\u5FF5",children:"2.1 torch.distributed\u6838\u5FC3\u6982\u5FF5"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"PyTorch"}),"\u901A\u8FC7",(0,i.jsx)(e.code,{children:"torch.distributed"}),"\u5305\u63D0\u4F9B\u5206\u5E03\u5F0F\u8BAD\u7EC3\u80FD\u529B\uFF0C\u6838\u5FC3\u6982\u5FF5\u5305\u62EC\uFF1A"]}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u6982\u5FF5"}),(0,i.jsx)(e.th,{children:"\u8BF4\u660E"}),(0,i.jsx)(e.th,{children:"\u793A\u4F8B"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"World Size"})}),(0,i.jsx)(e.td,{children:"\u53C2\u4E0E\u8BAD\u7EC3\u7684\u603B\u8FDB\u7A0B\u6570"}),(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"4\u8282\u70B9\xd78GPU = 32"})})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"Rank"})}),(0,i.jsx)(e.td,{children:"\u5F53\u524D\u8FDB\u7A0B\u7684\u5168\u5C40\u552F\u4E00\u6807\u8BC6"}),(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"0, 1, 2, ..., 31"})})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"Local Rank"})}),(0,i.jsx)(e.td,{children:"\u5F53\u524D\u8FDB\u7A0B\u5728\u672C\u8282\u70B9\u7684\u6807\u8BC6"}),(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"0, 1, ..., 7"})})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"Process Group"})}),(0,i.jsx)(e.td,{children:"\u8FDB\u7A0B\u7EC4\uFF0C\u7528\u4E8E\u96C6\u5408\u901A\u4FE1"}),(0,i.jsx)(e.td,{children:"\u9ED8\u8BA4\u7EC4\u5305\u542B\u6240\u6709\u8FDB\u7A0B"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"Backend"})}),(0,i.jsx)(e.td,{children:"\u901A\u4FE1\u540E\u7AEF"}),(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"nccl, gloo, mpi"})})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"AllReduce"})}),(0,i.jsxs)(e.td,{children:["\u96C6\u5408\u901A\u4FE1\u7B97\u5B50\uFF1A\u5BF9\u6240\u6709\u8FDB\u7A0B\u7684\u5F20\u91CF\u505A\u89C4\u7EA6\uFF08",(0,i.jsx)(e.code,{children:"sum/avg"}),"\uFF09\u5E76\u5E7F\u64AD\u56DE\u6240\u6709\u8FDB\u7A0B"]}),(0,i.jsx)(e.td,{})]})]})]}),"\n",(0,i.jsx)(e.h3,{id:"22-\u5206\u5E03\u5F0F\u6570\u636E\u5E76\u884Cddp",children:"2.2 \u5206\u5E03\u5F0F\u6570\u636E\u5E76\u884C\uFF08DDP\uFF09"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"DistributedDataParallel"}),"\uFF08",(0,i.jsx)(e.code,{children:"DDP"}),"\uFF09\u662F",(0,i.jsx)(e.code,{children:"PyTorch"}),"\u63A8\u8350\u7684\u6570\u636E\u5E76\u884C\u65B9\u6848\uFF1A"]}),"\n",(0,i.jsx)(e.mermaid,{value:'sequenceDiagram\n    participant GPU0 as GPU 0 (Rank 0)\n    participant GPU1 as GPU 1 (Rank 1)\n    participant GPU2 as GPU 2 (Rank 2)\n    participant GPU3 as GPU 3 (Rank 3)\n    \n    Note over GPU0,GPU3: 1. \u521D\u59CB\u5316\u5206\u5E03\u5F0F\u73AF\u5883\n    GPU0->>GPU0: init_process_group(backend="nccl")\n    GPU1->>GPU1: init_process_group(backend="nccl")\n    GPU2->>GPU2: init_process_group(backend="nccl")\n    GPU3->>GPU3: init_process_group(backend="nccl")\n    \n    Note over GPU0,GPU3: 2. \u52A0\u8F7D\u6570\u636E\u5206\u7247\n    GPU0->>GPU0: DataLoader + DistributedSampler\n    GPU1->>GPU1: DataLoader + DistributedSampler\n    GPU2->>GPU2: DataLoader + DistributedSampler\n    GPU3->>GPU3: DataLoader + DistributedSampler\n    \n    Note over GPU0,GPU3: 3. \u524D\u5411\u4F20\u64AD\uFF08\u72EC\u7ACB\u8BA1\u7B97\uFF09\n    GPU0->>GPU0: output = model(data_0)\n    GPU1->>GPU1: output = model(data_1)\n    GPU2->>GPU2: output = model(data_2)\n    GPU3->>GPU3: output = model(data_3)\n    \n    Note over GPU0,GPU3: 4. \u53CD\u5411\u4F20\u64AD + \u68AF\u5EA6\u540C\u6B65\n    GPU0->>GPU1: AllReduce(gradients)\n    GPU1->>GPU2: AllReduce(gradients)\n    GPU2->>GPU3: AllReduce(gradients)\n    GPU3->>GPU0: AllReduce(gradients)\n    \n    Note over GPU0,GPU3: 5. \u53C2\u6570\u66F4\u65B0\uFF08\u4F7F\u7528\u540C\u6B65\u540E\u7684\u68AF\u5EA6\uFF09\n    GPU0->>GPU0: optimizer.step()\n    GPU1->>GPU1: optimizer.step()\n    GPU2->>GPU2: optimizer.step()\n    GPU3->>GPU3: optimizer.step()'}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"DDP\u8BAD\u7EC3\u6D41\u7A0B\u8BF4\u660E"}),"\uFF1A"]}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u524D\u5411\u4F20\u64AD\u9636\u6BB5"}),"\uFF1A\u5404",(0,i.jsx)(e.code,{children:"GPU"}),"\u72EC\u7ACB\u6267\u884C\uFF0C\u4E92\u4E0D\u901A\u4FE1\u3002\u6BCF\u4E2A\u8FDB\u7A0B\u7528\u81EA\u5DF1\u7684\u6570\u636E\u5206\u7247\uFF08\u5982",(0,i.jsx)(e.code,{children:"data_0"}),"\u3001",(0,i.jsx)(e.code,{children:"data_1"}),"\u7B49\uFF09\u901A\u8FC7\u6A21\u578B\u5F97\u5230\u8F93\u51FA\u3002"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u53CD\u5411\u4F20\u64AD\u9636\u6BB5"}),"\uFF1A\u5728\u8BA1\u7B97\u68AF\u5EA6\u65F6\uFF0C",(0,i.jsx)(e.code,{children:"DDP"}),"\u4F1A\u81EA\u52A8\u5C06\u68AF\u5EA6\u6309",(0,i.jsx)(e.code,{children:"bucket"}),"\u5206\u7EC4\u8FDB\u884C",(0,i.jsx)(e.code,{children:"AllReduce"}),"\u540C\u6B65\uFF0C\u786E\u4FDD\u6240\u6709\u8FDB\u7A0B\u5F97\u5230\u76F8\u540C\u7684\u68AF\u5EA6\u3002\u8FD9\u4E2A\u8FC7\u7A0B\u4E0E\u68AF\u5EA6\u8BA1\u7B97\u91CD\u53E0\u6267\u884C\uFF0C\u51CF\u5C11\u7B49\u5F85\u65F6\u95F4\u3002"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u53C2\u6570\u66F4\u65B0\u9636\u6BB5"}),"\uFF1A\u56E0\u4E3A\u6240\u6709\u8FDB\u7A0B\u7684\u68AF\u5EA6\u5DF2\u540C\u6B65\uFF0C\u5404\u8FDB\u7A0B\u72EC\u7ACB\u6267\u884C",(0,i.jsx)(e.code,{children:"optimizer.step()"}),"\u540E\uFF0C\u6A21\u578B\u53C2\u6570\u4ECD\u4FDD\u6301\u4E00\u81F4\u3002"]}),"\n"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"DDP\u6838\u5FC3\u4F18\u52BF"}),"\uFF1A"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u68AF\u5EA6\u540C\u6B65\u4E0E\u53CD\u5411\u4F20\u64AD\u91CD\u53E0\uFF0C\u51CF\u5C11\u901A\u4FE1\u5F00\u9500"}),"\n",(0,i.jsxs)(e.li,{children:["\u6BCF\u4E2A\u8FDB\u7A0B\u72EC\u7ACB\u8FD0\u884C\uFF0C\u65E0",(0,i.jsx)(e.code,{children:"GIL"}),"\u9650\u5236"]}),"\n",(0,i.jsx)(e.li,{children:"\u652F\u6301\u591A\u673A\u591A\u5361\u6269\u5C55"}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"23-\u5168\u5206\u7247\u6570\u636E\u5E76\u884Cfsdp",children:"2.3 \u5168\u5206\u7247\u6570\u636E\u5E76\u884C\uFF08FSDP\uFF09"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"FullyShardedDataParallel"}),"\uFF08",(0,i.jsx)(e.code,{children:"FSDP"}),"\uFF09\u662F",(0,i.jsx)(e.code,{children:"PyTorch"}),"\u9488\u5BF9\u5927\u6A21\u578B\u7684\u4F18\u5316\u65B9\u6848\uFF1A"]}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u7279\u6027"}),(0,i.jsx)(e.th,{children:"DDP"}),(0,i.jsx)(e.th,{children:"FSDP"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u6A21\u578B\u5B58\u50A8"}),(0,i.jsxs)(e.td,{children:["\u6BCF\u4E2A",(0,i.jsx)(e.code,{children:"GPU"}),"\u5B58\u50A8\u5B8C\u6574\u6A21\u578B"]}),(0,i.jsx)(e.td,{children:"\u6A21\u578B\u53C2\u6570\u5206\u7247\u5B58\u50A8"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u663E\u5B58\u5360\u7528"}),(0,i.jsxs)(e.td,{children:["\u9AD8\uFF08",(0,i.jsx)(e.code,{children:"N"}),"\u4EFD\u5B8C\u6574\u6A21\u578B\uFF09"]}),(0,i.jsxs)(e.td,{children:["\u4F4E\uFF08",(0,i.jsx)(e.code,{children:"1/N"}),"\u6A21\u578B\u53C2\u6570\uFF09"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u901A\u4FE1\u6A21\u5F0F"}),(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"AllReduce"}),"\u68AF\u5EA6"]}),(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"AllGather"}),"\u53C2\u6570 + ",(0,i.jsx)(e.code,{children:"ReduceScatter"}),"\u68AF\u5EA6"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u9002\u7528\u573A\u666F"}),(0,i.jsx)(e.td,{children:"\u4E2D\u5C0F\u6A21\u578B"}),(0,i.jsxs)(e.td,{children:["\u5927\u6A21\u578B\uFF08",(0,i.jsx)(e.code,{children:">10B"}),"\u53C2\u6570\uFF09"]})]})]})]}),"\n",(0,i.jsx)(e.h3,{id:"24-torchrun\u542F\u52A8\u5668",children:"2.4 torchrun\u542F\u52A8\u5668"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"torchrun"}),"\u662F",(0,i.jsx)(e.code,{children:"PyTorch"}),"\u5B98\u65B9\u63A8\u8350\u7684\u5206\u5E03\u5F0F\u8BAD\u7EC3\u542F\u52A8\u5DE5\u5177\uFF0C\u5B83\u4F1A\u81EA\u52A8\u8BBE\u7F6E\u4EE5\u4E0B\u73AF\u5883\u53D8\u91CF\uFF1A"]}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u73AF\u5883\u53D8\u91CF"}),(0,i.jsx)(e.th,{children:"\u8BF4\u660E"}),(0,i.jsx)(e.th,{children:"\u6765\u6E90"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"WORLD_SIZE"})}),(0,i.jsx)(e.td,{children:"\u603B\u8FDB\u7A0B\u6570"}),(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"--nnodes \xd7 --nproc-per-node"})})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"RANK"})}),(0,i.jsx)(e.td,{children:"\u5168\u5C40\u8FDB\u7A0B\u7F16\u53F7"}),(0,i.jsx)(e.td,{children:"\u81EA\u52A8\u8BA1\u7B97"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"LOCAL_RANK"})}),(0,i.jsx)(e.td,{children:"\u672C\u5730\u8FDB\u7A0B\u7F16\u53F7"}),(0,i.jsx)(e.td,{children:"\u81EA\u52A8\u8BA1\u7B97"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"MASTER_ADDR"})}),(0,i.jsx)(e.td,{children:"\u4E3B\u8282\u70B9\u5730\u5740"}),(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"--master-addr"})})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"MASTER_PORT"})}),(0,i.jsx)(e.td,{children:"\u4E3B\u8282\u70B9\u7AEF\u53E3"}),(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"--master-port"})})]})]})]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"torchrun\u547D\u4EE4\u793A\u4F8B"}),"\uFF1A"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"# \u5355\u673A4\u5361\ntorchrun --nproc-per-node=4 train.py\n\n# \u591A\u673A\u591A\u5361\uFF084\u8282\u70B9\uFF0C\u6BCF\u8282\u70B98\u5361\uFF09\ntorchrun \\\n    --nnodes=4 \\\n    --nproc-per-node=8 \\\n    --node-rank=0 \\\n    --master-addr=192.168.1.1 \\\n    --master-port=29500 \\\n    train.py\n"})}),"\n",(0,i.jsx)(e.h2,{id:"3-kubeflow-trainer-pytorch\u5E76\u884C\u8BA1\u7B97\u652F\u6301",children:"3. Kubeflow Trainer PyTorch\u5E76\u884C\u8BA1\u7B97\u652F\u6301"}),"\n",(0,i.jsx)(e.h3,{id:"31-\u6574\u4F53\u67B6\u6784",children:"3.1 \u6574\u4F53\u67B6\u6784"}),"\n",(0,i.jsx)(e.mermaid,{value:'graph TB\n    subgraph "\u7528\u6237\u63D0\u4EA4"\n        CLIENT["\u5BA2\u6237\u7AEF<br/>(SDK/kubectl/API\u8C03\u7528)"]\n        TJ["TrainJob CR"]\n    end\n    \n    subgraph "Kubernetes API Server"\n        API["kube-apiserver"]\n    end\n    \n    subgraph "Kubeflow Training Runtimes"\n        CTR["ClusterTrainingRuntime"]\n        TR["TrainingRuntime"]\n    end\n    \n    subgraph "Trainer Controller Manager"\n        TC["TrainJob Controller"]\n        RF["Runtime Framework"]\n        TP["Torch Plugin<br/>(EnforceMLPolicy)"]\n    end\n    \n    subgraph "JobSet Controller"\n        JSC["JobSet Controller"]\n    end\n    \n    subgraph "Kubernetes Workloads"\n        JS["JobSet CR"]\n        JOB["Kubernetes Job"]\n        POD["Training Pods"]\n    end\n    \n    subgraph "Training Pod"\n        ENV["\u73AF\u5883\u53D8\u91CF\u6CE8\u5165<br/>PET_NNODES<br/>PET_NPROC_PER_NODE<br/>PET_NODE_RANK<br/>PET_MASTER_ADDR<br/>PET_MASTER_PORT"]\n        TORCHRUN["torchrun\u542F\u52A8\u5668"]\n        TRAIN["\u8BAD\u7EC3\u811A\u672C"]\n    end\n    \n    CLIENT --\x3e TJ\n    TJ --\x3e API\n    API --\x3e TC\n    CTR --\x3e RF\n    TR --\x3e RF\n    TC --\x3e RF\n    RF --\x3e TP\n    TP --\x3e JS\n    JS --\x3e JSC\n    JSC --\x3e JOB\n    JOB --\x3e POD\n    POD --\x3e ENV\n    ENV --\x3e TORCHRUN\n    TORCHRUN --\x3e TRAIN'}),"\n",(0,i.jsx)(e.h3,{id:"32-\u6838\u5FC3crd\u8BBE\u8BA1",children:"3.2 \u6838\u5FC3CRD\u8BBE\u8BA1"}),"\n",(0,i.jsx)(e.h4,{id:"321-trainjob",children:"3.2.1 TrainJob"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"TrainJob"}),"\u662F\u9762\u5411\u6570\u636E\u79D1\u5B66\u5BB6\u7684\u7B80\u5316",(0,i.jsx)(e.code,{children:"API"}),"\uFF0C\u7528\u4E8E\u63D0\u4EA4\u8BAD\u7EC3\u4EFB\u52A1\uFF1A"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-yaml",children:'apiVersion: trainer.kubeflow.org/v1alpha1\nkind: TrainJob\nmetadata:\n  name: pytorch-ddp-training\n  namespace: ml-team\nspec:\n  # \u5F15\u7528\u9884\u5B9A\u4E49\u7684\u8BAD\u7EC3\u8FD0\u884C\u65F6\n  runtimeRef:\n    apiGroup: trainer.kubeflow.org\n    kind: ClusterTrainingRuntime\n    name: torch-distributed\n  \n  # \u8BAD\u7EC3\u5668\u914D\u7F6E\uFF08\u53EF\u8986\u76D6Runtime\u9ED8\u8BA4\u503C\uFF09\n  trainer:\n    image: my-registry/pytorch-training:v1.0\n    command:\n      - torchrun\n      - train.py\n    args:\n      - --epochs=100\n      - --batch-size=64\n    numNodes: 4                    # \u8BAD\u7EC3\u8282\u70B9\u6570\n    numProcPerNode: 8              # \u6BCF\u8282\u70B9\u8FDB\u7A0B\u6570\uFF08\u901A\u5E38\u7B49\u4E8EGPU\u6570\uFF09\n    resourcesPerNode:\n      requests:\n        nvidia.com/gpu: 8\n        memory: "64Gi"\n        cpu: "16"\n    env:\n      - name: NCCL_DEBUG\n        value: "INFO"\n'})}),"\n",(0,i.jsx)(e.h4,{id:"322-clustertrainingruntime",children:"3.2.2 ClusterTrainingRuntime"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"ClusterTrainingRuntime"}),"\u662F\u5E73\u53F0\u5DE5\u7A0B\u5E08\u9884\u5B9A\u4E49\u7684\u8BAD\u7EC3\u4EFB\u52A1\u6A21\u677F\uFF1A"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-yaml",children:"apiVersion: trainer.kubeflow.org/v1alpha1\nkind: ClusterTrainingRuntime\nmetadata:\n  name: torch-distributed\n  labels:\n    trainer.kubeflow.org/framework: torch\nspec:\n  # ML\u7B56\u7565\u914D\u7F6E\n  mlPolicy:\n    numNodes: 1                    # \u9ED8\u8BA4\u8282\u70B9\u6570\n    torch:\n      numProcPerNode: auto         # auto/cpu/gpu/\u5177\u4F53\u6570\u503C\n      # \u5F39\u6027\u8BAD\u7EC3\u914D\u7F6E\uFF08\u53EF\u9009\uFF09\n      # elasticPolicy:\n      #   minNodes: 2\n      #   maxNodes: 8\n      #   maxRestarts: 3\n  \n  # Gang\u8C03\u5EA6\u7B56\u7565\uFF08\u53EF\u9009\uFF09\n  podGroupPolicy:\n    volcano: {}                    # \u4F7F\u7528Volcano\u8C03\u5EA6\u5668\n  \n  # JobSet\u6A21\u677F\n  template:\n    spec:\n      replicatedJobs:\n        - name: node\n          template:\n            metadata:\n              labels:\n                trainer.kubeflow.org/trainjob-ancestor-step: trainer\n            spec:\n              template:\n                spec:\n                  containers:\n                    - name: node\n                      image: pytorch/pytorch:2.7.1-cuda12.8-cudnn9-runtime\n                      ports:\n                        - containerPort: 29500  # \u5206\u5E03\u5F0F\u901A\u4FE1\u7AEF\u53E3\n"})}),"\n",(0,i.jsx)(e.h3,{id:"33-torch-plugin\u5B9E\u73B0\u539F\u7406",children:"3.3 Torch Plugin\u5B9E\u73B0\u539F\u7406"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"Kubeflow Trainer"}),"\u901A\u8FC7",(0,i.jsx)(e.code,{children:"Torch Plugin"}),"\u5B9E\u73B0\u5BF9",(0,i.jsx)(e.code,{children:"PyTorch"}),"\u5206\u5E03\u5F0F\u8BAD\u7EC3\u7684\u652F\u6301\u3002\u8BE5\u63D2\u4EF6\u7684\u6838\u5FC3\u529F\u80FD\u662F\u81EA\u52A8\u6CE8\u5165\u5206\u5E03\u5F0F\u73AF\u5883\u53D8\u91CF\u3002"]}),"\n",(0,i.jsx)(e.h4,{id:"331-\u73AF\u5883\u53D8\u91CF\u6CE8\u5165",children:"3.3.1 \u73AF\u5883\u53D8\u91CF\u6CE8\u5165"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"Torch Plugin"}),"\u4F1A\u81EA\u52A8\u4E3A\u6BCF\u4E2A\u8BAD\u7EC3",(0,i.jsx)(e.code,{children:"Pod"}),"\u6CE8\u5165\u4EE5\u4E0B\u73AF\u5883\u53D8\u91CF\uFF1A"]}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u73AF\u5883\u53D8\u91CF"}),(0,i.jsx)(e.th,{children:"\u8BF4\u660E"}),(0,i.jsx)(e.th,{children:"\u8BA1\u7B97\u65B9\u5F0F"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"PET_NNODES"})}),(0,i.jsx)(e.td,{children:"\u8BAD\u7EC3\u8282\u70B9\u603B\u6570"}),(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"spec.trainer.numNodes"})})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"PET_NPROC_PER_NODE"})}),(0,i.jsx)(e.td,{children:"\u6BCF\u8282\u70B9\u8FDB\u7A0B\u6570"}),(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"spec.mlPolicy.torch.numProcPerNode"})})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"PET_NODE_RANK"})}),(0,i.jsx)(e.td,{children:"\u5F53\u524D\u8282\u70B9\u7F16\u53F7"}),(0,i.jsxs)(e.td,{children:["\u4ECE",(0,i.jsx)(e.code,{children:"Job Completion Index"}),"\u83B7\u53D6"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"PET_MASTER_ADDR"})}),(0,i.jsx)(e.td,{children:"\u4E3B\u8282\u70B9\u5730\u5740"}),(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"{trainjob-name}-node-0-0.{trainjob-name}"})})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"PET_MASTER_PORT"})}),(0,i.jsx)(e.td,{children:"\u4E3B\u8282\u70B9\u7AEF\u53E3"}),(0,i.jsxs)(e.td,{children:["\u9ED8\u8BA4",(0,i.jsx)(e.code,{children:"29500"})]})]})]})]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u6CE8\u610F"}),"\uFF1A\u8FD9\u4E9B\u73AF\u5883\u53D8\u91CF\u4F7F\u7528",(0,i.jsx)(e.code,{children:"PET_"}),"\u524D\u7F00\uFF08",(0,i.jsx)(e.code,{children:"PyTorch Elastic Training"}),"\uFF09\uFF0C",(0,i.jsx)(e.code,{children:"torchrun"}),"\u4F1A\u81EA\u52A8\u8BC6\u522B\u5E76\u4F7F\u7528\u8FD9\u4E9B\u53D8\u91CF\u3002"]}),"\n",(0,i.jsx)(e.h4,{id:"332-numprocpernode\u8BA1\u7B97\u903B\u8F91",children:"3.3.2 numProcPerNode\u8BA1\u7B97\u903B\u8F91"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"numProcPerNode"}),"\u652F\u6301\u591A\u79CD\u914D\u7F6E\u65B9\u5F0F\uFF1A"]}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u914D\u7F6E\u503C"}),(0,i.jsx)(e.th,{children:"\u884C\u4E3A"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"auto"})}),(0,i.jsxs)(e.td,{children:["\u5982\u679C\u914D\u7F6E\u4E86",(0,i.jsx)(e.code,{children:"GPU"}),"\u8D44\u6E90\uFF0C\u4F7F\u7528",(0,i.jsx)(e.code,{children:"GPU"}),"\u6570\u91CF\uFF1B\u5426\u5219\u4F7F\u7528",(0,i.jsx)(e.code,{children:"CPU"}),"\u6570\u91CF"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"cpu"})}),(0,i.jsxs)(e.td,{children:["\u4F7F\u7528",(0,i.jsx)(e.code,{children:"CPU"}),"\u6838\u5FC3\u6570"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"gpu"})}),(0,i.jsxs)(e.td,{children:["\u4F7F\u7528",(0,i.jsx)(e.code,{children:"GPU"}),"\u6570\u91CF"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u6574\u6570\u503C"}),(0,i.jsx)(e.td,{children:"\u4F7F\u7528\u6307\u5B9A\u7684\u6570\u503C"})]})]})]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'// \u6E90\u7801\u903B\u8F91\u7B80\u5316\nif numProcPerNode == "auto" {\n    if gpuCount > 0 {\n        numProcPerNode = gpuCount\n    } else {\n        numProcPerNode = cpuCount\n    }\n}\n'})}),"\n",(0,i.jsx)(e.h3,{id:"34-\u6267\u884C\u6D41\u7A0B\u8BE6\u89E3",children:"3.4 \u6267\u884C\u6D41\u7A0B\u8BE6\u89E3"}),"\n",(0,i.jsx)(e.mermaid,{value:"sequenceDiagram\n    participant User as \u7528\u6237\n    participant API as Kubernetes API\n    participant TC as TrainJob Controller\n    participant TP as Torch Plugin\n    participant JS as JobSet Controller\n    participant POD as Training Pods\n    \n    User->>API: 1. \u521B\u5EFATrainJob\n    API->>TC: 2. \u89E6\u53D1Reconcile\n    \n    TC->>TC: 3. \u83B7\u53D6RuntimeRef\u5F15\u7528\u7684Runtime\n    TC->>TP: 4. \u8C03\u7528EnforceMLPolicy\n    \n    rect rgb(200, 220, 240)\n        Note over TP: Torch Plugin\u5904\u7406\n        TP->>TP: 5. \u8BA1\u7B97numProcPerNode\n        TP->>TP: 6. \u751F\u6210PET_*\u73AF\u5883\u53D8\u91CF\n        TP->>TP: 7. \u8BBE\u7F6E\u5BB9\u5668\u7AEF\u53E3(29500)\n        TP->>TP: 8. \u66F4\u65B0Pod\u6A21\u677F\n    end\n    \n    TC->>API: 9. \u521B\u5EFAJobSet\n    API->>JS: 10. \u89E6\u53D1JobSet Reconcile\n    JS->>API: 11. \u521B\u5EFAJob\u8D44\u6E90\n    \n    loop \u6BCF\u4E2A\u8BAD\u7EC3\u8282\u70B9\n        API->>POD: 12. \u521B\u5EFAPod\n        POD->>POD: 13. \u6CE8\u5165\u73AF\u5883\u53D8\u91CF\n        POD->>POD: 14. \u542F\u52A8torchrun\n        POD->>POD: 15. \u6267\u884C\u8BAD\u7EC3\u811A\u672C\n    end\n    \n    Note over POD: \u6240\u6709Pod\u901A\u8FC7NCCL\u8FDB\u884C\u68AF\u5EA6\u540C\u6B65"}),"\n",(0,i.jsx)(e.h3,{id:"35-headless-service\u4E0E\u8282\u70B9\u53D1\u73B0",children:"3.5 Headless Service\u4E0E\u8282\u70B9\u53D1\u73B0"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"Kubeflow Trainer"}),"\u4F1A\u81EA\u52A8\u521B\u5EFA",(0,i.jsx)(e.code,{children:"Headless Service"}),"\u7528\u4E8E\u8282\u70B9\u95F4\u901A\u4FE1\uFF1A"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Service\nmetadata:\n  name: pytorch-ddp-training  # \u4E0ETrainJob\u540C\u540D\nspec:\n  clusterIP: None             # Headless Service\n  selector:\n    trainer.kubeflow.org/trainjob-name: pytorch-ddp-training\n  ports:\n    - port: 29500\n      targetPort: 29500\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u8282\u70B9DNS\u89E3\u6790"}),"\uFF1A"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\u4E3B\u8282\u70B9\uFF1A",(0,i.jsx)(e.code,{children:"pytorch-ddp-training-node-0-0.pytorch-ddp-training"})]}),"\n",(0,i.jsxs)(e.li,{children:["\u5DE5\u4F5C\u8282\u70B91\uFF1A",(0,i.jsx)(e.code,{children:"pytorch-ddp-training-node-0-1.pytorch-ddp-training"})]}),"\n",(0,i.jsxs)(e.li,{children:["\u5DE5\u4F5C\u8282\u70B92\uFF1A",(0,i.jsx)(e.code,{children:"pytorch-ddp-training-node-0-2.pytorch-ddp-training"})]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"4-\u7B97\u6CD5\u5DE5\u7A0B\u5E08\u4F7F\u7528\u6307\u5357",children:"4. \u7B97\u6CD5\u5DE5\u7A0B\u5E08\u4F7F\u7528\u6307\u5357"}),"\n",(0,i.jsx)(e.h3,{id:"41-\u662F\u5426\u9700\u8981\u611F\u77E5\u5E95\u5C42\u67B6\u6784",children:"4.1 \u662F\u5426\u9700\u8981\u611F\u77E5\u5E95\u5C42\u67B6\u6784\uFF1F"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u7B80\u77ED\u56DE\u7B54"}),"\uFF1A",(0,i.jsx)(e.strong,{children:"\u4E0D\u9700\u8981"}),"\u3002",(0,i.jsx)(e.code,{children:"Kubeflow Trainer"}),"\u7684\u8BBE\u8BA1\u76EE\u6807\u4E4B\u4E00\u5C31\u662F\u5BF9\u7B97\u6CD5\u5DE5\u7A0B\u5E08\u5C4F\u853D",(0,i.jsx)(e.code,{children:"Kubernetes"}),"\u548C\u5206\u5E03\u5F0F\u8BAD\u7EC3\u7684\u590D\u6742\u6027\u3002"]}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u5173\u6CE8\u70B9"}),(0,i.jsx)(e.th,{children:"\u7B97\u6CD5\u5DE5\u7A0B\u5E08\u9700\u8981\u5173\u5FC3"}),(0,i.jsx)(e.th,{children:"Kubeflow Trainer\u81EA\u52A8\u5904\u7406"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u5206\u5E03\u5F0F\u73AF\u5883\u521D\u59CB\u5316"}),(0,i.jsx)(e.td,{children:"\u274C"}),(0,i.jsx)(e.td,{children:"\u2705 \u81EA\u52A8\u6CE8\u5165\u73AF\u5883\u53D8\u91CF"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u8282\u70B9\u53D1\u73B0\u4E0E\u901A\u4FE1"}),(0,i.jsx)(e.td,{children:"\u274C"}),(0,i.jsxs)(e.td,{children:["\u2705 \u81EA\u52A8\u521B\u5EFA",(0,i.jsx)(e.code,{children:"Headless Service"})]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"torchrun"}),"\u53C2\u6570\u914D\u7F6E"]}),(0,i.jsx)(e.td,{children:"\u274C"}),(0,i.jsxs)(e.td,{children:["\u2705 \u81EA\u52A8\u8BA1\u7B97",(0,i.jsx)(e.code,{children:"nnodes"}),"\u3001",(0,i.jsx)(e.code,{children:"nproc"}),"\u7B49"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"GPU"}),"\u8D44\u6E90\u5206\u914D"]}),(0,i.jsx)(e.td,{children:"\u274C"}),(0,i.jsxs)(e.td,{children:["\u2705 \u901A\u8FC7",(0,i.jsx)(e.code,{children:"Runtime"}),"\u914D\u7F6E"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"Pod"}),"\u8C03\u5EA6\u4E0E\u7F16\u6392"]}),(0,i.jsx)(e.td,{children:"\u274C"}),(0,i.jsxs)(e.td,{children:["\u2705 \u901A\u8FC7",(0,i.jsx)(e.code,{children:"JobSet"}),"\u7BA1\u7406"]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u8BAD\u7EC3\u4EE3\u7801\u7F16\u5199"}),(0,i.jsx)(e.td,{children:"\u2705"}),(0,i.jsx)(e.td,{children:"-"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u6A21\u578B\u67B6\u6784\u8BBE\u8BA1"}),(0,i.jsx)(e.td,{children:"\u2705"}),(0,i.jsx)(e.td,{children:"-"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u8D85\u53C2\u6570\u8C03\u4F18"}),(0,i.jsx)(e.td,{children:"\u2705"}),(0,i.jsx)(e.td,{children:"-"})]})]})]}),"\n",(0,i.jsx)(e.h3,{id:"42-\u8BAD\u7EC3\u4EE3\u7801\u7F16\u5199\u89C4\u8303",children:"4.2 \u8BAD\u7EC3\u4EE3\u7801\u7F16\u5199\u89C4\u8303"}),"\n",(0,i.jsxs)(e.p,{children:["\u7B97\u6CD5\u5DE5\u7A0B\u5E08\u53EA\u9700\u6309\u7167\u6807\u51C6\u7684",(0,i.jsx)(e.code,{children:"PyTorch"}),"\u5206\u5E03\u5F0F\u8BAD\u7EC3\u65B9\u5F0F\u7F16\u5199\u4EE3\u7801\uFF1A"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'def train():\n    import os\n    import torch\n    import torch.distributed as dist\n    from torch.nn.parallel import DistributedDataParallel as DDP\n    from torch.utils.data import DataLoader, DistributedSampler\n    \n    # [1] \u521D\u59CB\u5316\u5206\u5E03\u5F0F\u73AF\u5883\n    # Kubeflow Trainer\u5DF2\u81EA\u52A8\u8BBE\u7F6E\u6240\u6709\u5FC5\u8981\u7684\u73AF\u5883\u53D8\u91CF\n    device = "cuda" if torch.cuda.is_available() else "cpu"\n    backend = "nccl" if device == "cuda" else "gloo"\n    dist.init_process_group(backend=backend)\n    \n    # [2] \u83B7\u53D6\u5206\u5E03\u5F0F\u4FE1\u606F\uFF08\u53EF\u9009\uFF0C\u7528\u4E8E\u65E5\u5FD7\u6216\u8C03\u8BD5\uFF09\n    world_size = dist.get_world_size()\n    rank = dist.get_rank()\n    local_rank = int(os.environ.get("LOCAL_RANK", 0))\n    \n    print(f"Initialized: World Size={world_size}, Rank={rank}, Local Rank={local_rank}")\n    \n    # [3] \u8BBE\u7F6E\u5F53\u524D\u8FDB\u7A0B\u4F7F\u7528\u7684GPU\n    if device == "cuda":\n        torch.cuda.set_device(local_rank)\n        device = torch.device(f"cuda:{local_rank}")\n    \n    # [4] \u521B\u5EFA\u6A21\u578B\u5E76\u5305\u88C5\u4E3ADDP\n    model = MyModel().to(device)\n    model = DDP(model, device_ids=[local_rank] if device.type == "cuda" else None)\n    \n    # [5] \u521B\u5EFA\u6570\u636E\u52A0\u8F7D\u5668\uFF08\u4F7F\u7528DistributedSampler\uFF09\n    dataset = MyDataset()\n    sampler = DistributedSampler(dataset, num_replicas=world_size, rank=rank)\n    dataloader = DataLoader(dataset, batch_size=64, sampler=sampler)\n    \n    # [6] \u8BAD\u7EC3\u5FAA\u73AF\n    optimizer = torch.optim.Adam(model.parameters(), lr=0.001)\n    for epoch in range(100):\n        sampler.set_epoch(epoch)  # \u91CD\u8981\uFF1A\u786E\u4FDD\u6BCF\u4E2Aepoch\u6570\u636E\u6253\u4E71\u65B9\u5F0F\u4E0D\u540C\n        for batch in dataloader:\n            inputs, labels = batch\n            inputs, labels = inputs.to(device), labels.to(device)\n            \n            optimizer.zero_grad()\n            outputs = model(inputs)\n            loss = criterion(outputs, labels)\n            loss.backward()\n            optimizer.step()\n        \n        # \u53EA\u5728\u4E3B\u8282\u70B9\u4FDD\u5B58\u6A21\u578B\n        if rank == 0:\n            torch.save(model.module.state_dict(), f"model_epoch_{epoch}.pt")\n    \n    # [7] \u6E05\u7406\n    dist.destroy_process_group()\n\nif __name__ == "__main__":\n    train()\n'})}),"\n",(0,i.jsx)(e.h3,{id:"43-\u4F7F\u7528kubeflow-python-sdk\u63D0\u4EA4\u4EFB\u52A1",children:"4.3 \u4F7F\u7528Kubeflow Python SDK\u63D0\u4EA4\u4EFB\u52A1"}),"\n",(0,i.jsxs)(e.p,{children:["\u7B97\u6CD5\u5DE5\u7A0B\u5E08\u53EF\u4EE5\u4F7F\u7528",(0,i.jsx)(e.code,{children:"Kubeflow Python SDK"}),"\u76F4\u63A5\u4ECE",(0,i.jsx)(e.code,{children:"Python"}),"\u4EE3\u7801\u63D0\u4EA4\u8BAD\u7EC3\u4EFB\u52A1\uFF1A"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'from kubeflow.trainer import TrainerClient, CustomTrainer\n\n# \u5B9A\u4E49\u8BAD\u7EC3\u51FD\u6570\ndef train_pytorch():\n    import torch\n    import torch.distributed as dist\n    from torch.nn.parallel import DistributedDataParallel as DDP\n    \n    # \u521D\u59CB\u5316\u5206\u5E03\u5F0F\u73AF\u5883\uFF08Kubeflow Trainer\u81EA\u52A8\u914D\u7F6E\uFF09\n    device, backend = ("cuda", "nccl") if torch.cuda.is_available() else ("cpu", "gloo")\n    dist.init_process_group(backend=backend)\n    \n    local_rank = int(os.environ.get("LOCAL_RANK", 0))\n    \n    # \u521B\u5EFA\u6A21\u578B\n    model = torch.nn.Linear(10, 10).to(device)\n    model = DDP(model)\n    \n    # \u8BAD\u7EC3\u903B\u8F91...\n    print(f"Training on rank {dist.get_rank()}/{dist.get_world_size()}")\n    \n    dist.destroy_process_group()\n\n# \u521B\u5EFA\u8BAD\u7EC3\u4EFB\u52A1\nclient = TrainerClient()\n\njob_id = client.train(\n    trainer=CustomTrainer(\n        func=train_pytorch,\n        num_nodes=4,                    # 4\u4E2A\u8BAD\u7EC3\u8282\u70B9\n        resources_per_node={\n            "cpu": 8,\n            "memory": "32Gi",\n            "gpu": 2,                   # \u6BCF\u8282\u70B92\u4E2AGPU\n        },\n        packages_to_install=["transformers>=4.53.0"],  # \u989D\u5916\u4F9D\u8D56\n    )\n)\n\n# \u7B49\u5F85\u4EFB\u52A1\u5B8C\u6210\nclient.wait_for_job_status(job_id)\n\n# \u67E5\u770B\u65E5\u5FD7\nfor log in client.get_job_logs(job_id, follow=True):\n    print(log)\n'})}),"\n",(0,i.jsx)(e.h3,{id:"44-\u5173\u952E\u6CE8\u610F\u4E8B\u9879",children:"4.4 \u5173\u952E\u6CE8\u610F\u4E8B\u9879"}),"\n",(0,i.jsx)(e.h4,{id:"441-\u6570\u636E\u52A0\u8F7D",children:"4.4.1 \u6570\u636E\u52A0\u8F7D"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:"# \u2705 \u6B63\u786E\uFF1A\u4F7F\u7528DistributedSampler\nsampler = DistributedSampler(dataset)\ndataloader = DataLoader(dataset, sampler=sampler)\n\n# \u274C \u9519\u8BEF\uFF1A\u4E0D\u4F7F\u7528Sampler\u4F1A\u5BFC\u81F4\u6240\u6709\u8282\u70B9\u5904\u7406\u76F8\u540C\u6570\u636E\ndataloader = DataLoader(dataset, shuffle=True)\n"})}),"\n",(0,i.jsx)(e.h4,{id:"442-\u6A21\u578B\u4FDD\u5B58",children:"4.4.2 \u6A21\u578B\u4FDD\u5B58"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'# \u2705 \u6B63\u786E\uFF1A\u53EA\u5728\u4E3B\u8282\u70B9\u4FDD\u5B58\nif dist.get_rank() == 0:\n    torch.save(model.module.state_dict(), "model.pt")\n\n# \u274C \u9519\u8BEF\uFF1A\u6240\u6709\u8282\u70B9\u90FD\u4FDD\u5B58\u4F1A\u9020\u6210\u51B2\u7A81\ntorch.save(model.state_dict(), "model.pt")\n'})}),"\n",(0,i.jsx)(e.h4,{id:"443-\u65E5\u5FD7\u8F93\u51FA",children:"4.4.3 \u65E5\u5FD7\u8F93\u51FA"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'# \u2705 \u63A8\u8350\uFF1A\u53EA\u5728\u4E3B\u8282\u70B9\u8F93\u51FA\u8BE6\u7EC6\u65E5\u5FD7\nif dist.get_rank() == 0:\n    print(f"Epoch {epoch}, Loss: {loss.item()}")\n\n# \u6216\u4F7F\u7528\u6761\u4EF6\u65E5\u5FD7\ndef log(msg):\n    if dist.get_rank() == 0:\n        print(msg)\n'})}),"\n",(0,i.jsx)(e.h4,{id:"444-\u968F\u673A\u79CD\u5B50",children:"4.4.4 \u968F\u673A\u79CD\u5B50"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:"# \u2705 \u6B63\u786E\uFF1A\u8BBE\u7F6E\u786E\u5B9A\u6027\u79CD\u5B50\uFF0C\u4F46\u6BCF\u4E2A\u8282\u70B9\u4F7F\u7528\u4E0D\u540C\u7684\u6570\u636E\u589E\u5F3A\ntorch.manual_seed(42 + dist.get_rank())\n"})}),"\n",(0,i.jsx)(e.h3,{id:"45-fsdp\u4F7F\u7528\u793A\u4F8B",children:"4.5 FSDP\u4F7F\u7528\u793A\u4F8B"}),"\n",(0,i.jsxs)(e.p,{children:["\u5BF9\u4E8E\u5927\u6A21\u578B\u8BAD\u7EC3\uFF0C\u53EF\u4EE5\u4F7F\u7528",(0,i.jsx)(e.code,{children:"FSDP"}),"\uFF1A"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'from torch.distributed.fsdp import FullyShardedDataParallel as FSDP\nfrom torch.distributed.fsdp.wrap import transformer_auto_wrap_policy\n\ndef train_large_model():\n    import torch\n    import torch.distributed as dist\n    from transformers import AutoModelForCausalLM\n    \n    dist.init_process_group(backend="nccl")\n    local_rank = int(os.environ["LOCAL_RANK"])\n    torch.cuda.set_device(local_rank)\n    \n    # \u52A0\u8F7D\u5927\u6A21\u578B\n    model = AutoModelForCausalLM.from_pretrained("meta-llama/Llama-2-7b")\n    \n    # \u4F7F\u7528FSDP\u5305\u88C5\n    model = FSDP(\n        model,\n        auto_wrap_policy=transformer_auto_wrap_policy,\n        device_id=local_rank,\n    )\n    \n    # \u8BAD\u7EC3\u903B\u8F91...\n    \n    dist.destroy_process_group()\n'})}),"\n",(0,i.jsx)(e.h2,{id:"5-\u5B8C\u6574\u793A\u4F8B",children:"5. \u5B8C\u6574\u793A\u4F8B"}),"\n",(0,i.jsx)(e.h3,{id:"51-trainingruntime\u914D\u7F6E",children:"5.1 TrainingRuntime\u914D\u7F6E"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-yaml",children:'apiVersion: trainer.kubeflow.org/v1alpha1\nkind: ClusterTrainingRuntime\nmetadata:\n  name: pytorch-ddp-gpu\nspec:\n  mlPolicy:\n    numNodes: 2\n    torch:\n      numProcPerNode: auto\n  podGroupPolicy:\n    volcano: {}\n  template:\n    spec:\n      replicatedJobs:\n        - name: node\n          template:\n            metadata:\n              labels:\n                trainer.kubeflow.org/trainjob-ancestor-step: trainer\n            spec:\n              template:\n                spec:\n                  schedulerName: volcano\n                  containers:\n                    - name: node\n                      image: pytorch/pytorch:2.7.1-cuda12.8-cudnn9-runtime\n                      resources:\n                        limits:\n                          nvidia.com/gpu: 4\n                          memory: "64Gi"\n                          cpu: "16"\n                      env:\n                        - name: NCCL_DEBUG\n                          value: "INFO"\n'})}),"\n",(0,i.jsx)(e.h3,{id:"52-trainjob\u63D0\u4EA4",children:"5.2 TrainJob\u63D0\u4EA4"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-yaml",children:"apiVersion: trainer.kubeflow.org/v1alpha1\nkind: TrainJob\nmetadata:\n  name: mnist-ddp-training\n  namespace: ml-team\nspec:\n  runtimeRef:\n    name: pytorch-ddp-gpu\n  trainer:\n    image: my-registry/mnist-training:v1.0\n    command:\n      - torchrun\n      - train.py\n    args:\n      - --epochs=50\n      - --batch-size=128\n    numNodes: 4\n    resourcesPerNode:\n      requests:\n        nvidia.com/gpu: 8\n"})}),"\n",(0,i.jsx)(e.h3,{id:"53-\u8BAD\u7EC3\u811A\u672C",children:"5.3 \u8BAD\u7EC3\u811A\u672C"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'#!/usr/bin/env python3\n"""\nMNIST\u5206\u5E03\u5F0F\u8BAD\u7EC3\u793A\u4F8B\n\u6B64\u811A\u672C\u53EF\u76F4\u63A5\u5728Kubeflow Trainer\u4E2D\u8FD0\u884C\uFF0C\u65E0\u9700\u4FEE\u6539\n"""\n\nimport os\nimport argparse\nimport torch\nimport torch.nn as nn\nimport torch.nn.functional as F\nimport torch.distributed as dist\nfrom torch.nn.parallel import DistributedDataParallel as DDP\nfrom torch.utils.data import DataLoader\nfrom torch.utils.data.distributed import DistributedSampler\nfrom torchvision import datasets, transforms\n\n\nclass MNISTNet(nn.Module):\n    def __init__(self):\n        super().__init__()\n        self.conv1 = nn.Conv2d(1, 32, 3, 1)\n        self.conv2 = nn.Conv2d(32, 64, 3, 1)\n        self.fc1 = nn.Linear(9216, 128)\n        self.fc2 = nn.Linear(128, 10)\n\n    def forward(self, x):\n        x = F.relu(self.conv1(x))\n        x = F.relu(self.conv2(x))\n        x = F.max_pool2d(x, 2)\n        x = torch.flatten(x, 1)\n        x = F.relu(self.fc1(x))\n        x = self.fc2(x)\n        return F.log_softmax(x, dim=1)\n\n\ndef train(args):\n    # \u521D\u59CB\u5316\u5206\u5E03\u5F0F\u73AF\u5883\n    device = "cuda" if torch.cuda.is_available() else "cpu"\n    backend = "nccl" if device == "cuda" else "gloo"\n    dist.init_process_group(backend=backend)\n    \n    rank = dist.get_rank()\n    world_size = dist.get_world_size()\n    local_rank = int(os.environ.get("LOCAL_RANK", 0))\n    \n    if device == "cuda":\n        torch.cuda.set_device(local_rank)\n        device = torch.device(f"cuda:{local_rank}")\n    \n    if rank == 0:\n        print(f"Starting distributed training with {world_size} processes")\n    \n    # \u51C6\u5907\u6570\u636E\n    transform = transforms.Compose([\n        transforms.ToTensor(),\n        transforms.Normalize((0.1307,), (0.3081,))\n    ])\n    \n    # \u53EA\u5728rank 0\u4E0B\u8F7D\u6570\u636E\n    if rank == 0:\n        datasets.MNIST(\'./data\', train=True, download=True)\n    dist.barrier()\n    \n    dataset = datasets.MNIST(\'./data\', train=True, transform=transform)\n    sampler = DistributedSampler(dataset, num_replicas=world_size, rank=rank)\n    dataloader = DataLoader(dataset, batch_size=args.batch_size, sampler=sampler)\n    \n    # \u521B\u5EFA\u6A21\u578B\n    model = MNISTNet().to(device)\n    model = DDP(model, device_ids=[local_rank] if device.type == "cuda" else None)\n    \n    optimizer = torch.optim.Adam(model.parameters(), lr=0.001)\n    \n    # \u8BAD\u7EC3\u5FAA\u73AF\n    for epoch in range(args.epochs):\n        sampler.set_epoch(epoch)\n        model.train()\n        \n        for batch_idx, (data, target) in enumerate(dataloader):\n            data, target = data.to(device), target.to(device)\n            \n            optimizer.zero_grad()\n            output = model(data)\n            loss = F.nll_loss(output, target)\n            loss.backward()\n            optimizer.step()\n            \n            if batch_idx % 100 == 0 and rank == 0:\n                print(f"Epoch {epoch} [{batch_idx * len(data)}/{len(dataset)}] Loss: {loss.item():.6f}")\n        \n        # \u4FDD\u5B58\u68C0\u67E5\u70B9\n        if rank == 0:\n            torch.save({\n                \'epoch\': epoch,\n                \'model_state_dict\': model.module.state_dict(),\n                \'optimizer_state_dict\': optimizer.state_dict(),\n            }, f\'checkpoint_epoch_{epoch}.pt\')\n    \n    if rank == 0:\n        print("Training completed!")\n    \n    dist.destroy_process_group()\n\n\nif __name__ == "__main__":\n    parser = argparse.ArgumentParser()\n    parser.add_argument("--epochs", type=int, default=10)\n    parser.add_argument("--batch-size", type=int, default=64)\n    args = parser.parse_args()\n    \n    train(args)\n'})}),"\n",(0,i.jsx)(e.h2,{id:"6-\u53C2\u8003\u8D44\u6599",children:"6. \u53C2\u8003\u8D44\u6599"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://www.kubeflow.org/docs/components/trainer/",children:"Kubeflow Trainer\u5B98\u65B9\u6587\u6863"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://pytorch.org/tutorials/beginner/dist_overview.html",children:"PyTorch Distributed Overview"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://pytorch.org/tutorials/intermediate/ddp_tutorial.html",children:"PyTorch DDP Tutorial"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://pytorch.org/tutorials/intermediate/FSDP_tutorial.html",children:"PyTorch FSDP Tutorial"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://pytorch.org/docs/stable/elastic/run.html",children:"torchrun Documentation"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://github.com/kubeflow/trainer",children:"Kubeflow Trainer GitHub"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://pytorch.org/blog/pytorch-on-kubernetes-kubeflow-trainer-joins-the-pytorch-ecosystem/",children:"PyTorch on Kubernetes Blog"})}),"\n"]})]})}function h(n={}){let{wrapper:e}={...(0,s.a)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(a,{...n})}):a(n)}},50065:function(n,e,r){r.d(e,{Z:function(){return t},a:function(){return l}});var d=r(67294);let i={},s=d.createContext(i);function l(n){let e=d.useContext(s);return d.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:l(n.components),d.createElement(s.Provider,{value:e},n.children)}}}]);