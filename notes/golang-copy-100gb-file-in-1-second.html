<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/日常笔记/震惊！Golang拷贝100+GB的文件不到1秒，啥情况？" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>震惊！Golang拷贝100+GB的文件不到1秒，啥情况？ | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/notes/golang-copy-100gb-file-in-1-second><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="震惊！Golang拷贝100+GB的文件不到1秒，啥情况？ | John's Blog"><meta data-rh=true name=description content=深入分析为什么Go程序能在1秒内拷贝100GB+文件的神奇现象，揭秘XFS文件系统reflink特性和Copy-on-Write机制的工作原理><meta data-rh=true property=og:description content=深入分析为什么Go程序能在1秒内拷贝100GB+文件的神奇现象，揭秘XFS文件系统reflink特性和Copy-on-Write机制的工作原理><meta data-rh=true name=keywords content=Go,Golang,文件拷贝,XFS,reflink,CoW,写时复制,copy_file_range,文件系统,Linux内核,性能分析,系统调用,strace><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/notes/golang-copy-100gb-file-in-1-second><link data-rh=true rel=alternate href=https://johng.cn/notes/golang-copy-100gb-file-in-1-second hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/notes/golang-copy-100gb-file-in-1-second hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><script src=https://cdn.wwads.cn/js/makemoney.js async></script><link rel=stylesheet href=/assets/css/styles.93f82223.css><script src=/assets/js/runtime~main.bb39dd5c.js defer></script><script src=/assets/js/main.2cb84663.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/ai>AI技术</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/cloud-native>云原生</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/observability>可观测性</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/cloud-native>云原生</a><button aria-label="Expand sidebar category '云原生'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/notes>日常笔记</a><button aria-label="Collapse sidebar category '日常笔记'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/notes/goland-debug-issue>Goland Debug无法进入断点位置</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/notes/linux-port-forwarding-methods>Linux端口转发的几种常用方法</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/notes/mac-terminal-copy-paste-issue>Mac 在终端下复制粘贴出现：00~ xxx 01~ 问题的解决方案</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/notes/jetbrains-ide-search-settings>MacOS下取消JetBrains IDE双击Shift时出现的全局搜索</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/notes/mac-git-completion-setup>Mac安装git completion</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/notes/make-command-tutorial>Make 命令教程</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/notes/mysql-insert-duplicate-deadlock>MySQL 5.7 insert into on duplicate 死锁</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/notes/vscode-image-path-setting>VSCode设置Markdown截图文件存放路径</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/notes/github-pr-collaboration>Github PR代码多人协作</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/notes/container-gomaxprocs-issue>容器化下的GOMAXPROCS问题</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/notes/linux-vim-encoding-fix>解决linux下vim乱码的情况</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/notes/golang-nested-pointer-bug>遇到一个Golang指针嵌套体复制的BUG</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/notes/golang-copy-100gb-file-in-1-second>震惊！Golang拷贝100+GB的文件不到1秒，啥情况？</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/notes><span itemprop=name>日常笔记</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>震惊！Golang拷贝100+GB的文件不到1秒，啥情况？</span><meta itemprop=position content=2></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=1-背景介绍>1. 背景介绍<a href=#1-背景介绍 class=hash-link aria-label="Direct link to 1. 背景介绍" title="Direct link to 1. 背景介绍">​</a></h2>
<p>最近咱们系统增加了一个<code>AI</code>模型加速的组件，用于缓存大模型文件内容到本地的<code>hostPath</code>，并在训练、推理服务启动前通过<code>initContainer</code>的方式将大模型的文件（层级目录，很多文件）拷贝到业务容器中（没有使用目录软连接）。</p>
<p>但在测试时发现不管模型多大，从<code>2.9GB</code>到<code>139GB</code>的大模型文件，这个<code>initContainer</code>的拷贝操作都能瞬间完成（不到<code>1</code>秒）。然而使用<code>python</code>脚本或者<code>cp</code>命令执行目录文件拷贝，时间开销都是几秒到几分钟不等。</p>
<p>该情况无论是在容器中，还是在宿主机上都能够复现，前提是在同一块磁盘上进行拷贝，跨磁盘无法复现。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=2-排查过程>2. 排查过程<a href=#2-排查过程 class=hash-link aria-label="Direct link to 2. 排查过程" title="Direct link to 2. 排查过程">​</a></h2>
<p>为了方便排查，我们在宿主机上进行复现。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=21-确认环境信息>2.1 确认环境信息<a href=#21-确认环境信息 class=hash-link aria-label="Direct link to 2.1 确认环境信息" title="Direct link to 2.1 确认环境信息">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=211-内核版本>2.1.1 内核版本<a href=#211-内核版本 class=hash-link aria-label="Direct link to 2.1.1 内核版本" title="Direct link to 2.1.1 内核版本">​</a></h4>
<p>这里使用的<code>Linux</code>内核版本是<code>5.15</code>版本。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ </span><span class="token function" style=color:#e6db74>uname</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-a</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Linux dev-app-2-150-master-1 </span><span class="token number" style=color:#ae81ff>5.15</span><span class="token plain">.0-1078-nvidia </span><span class="token comment" style=color:#8292a2;font-style:italic>#79-Ubuntu SMP Fri Apr 25 14:51:39 UTC 2025 x86_64 x86_64 x86_64 GNU/Linux</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=212-系统版本>2.1.2 系统版本<a href=#212-系统版本 class=hash-link aria-label="Direct link to 2.1.2 系统版本" title="Direct link to 2.1.2 系统版本">​</a></h4>
<p>使用的是<code>Ubuntu 22.04.3 LTS</code>。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ </span><span class="token function" style=color:#e6db74>cat</span><span class="token plain"> /etc/os-release</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token assign-left variable" style=color:#f8f8f2>PRETTY_NAME</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"Ubuntu 22.04.3 LTS"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token assign-left variable" style=color:#f8f8f2>NAME</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"Ubuntu"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token assign-left variable" style=color:#f8f8f2>VERSION_ID</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"22.04"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token assign-left variable" style=color:#f8f8f2>VERSION</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"22.04.3 LTS (Jammy Jellyfish)"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token assign-left variable" style=color:#f8f8f2>VERSION_CODENAME</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">jammy</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token assign-left variable" style=color:#f8f8f2>ID</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">ubuntu</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token assign-left variable" style=color:#f8f8f2>ID_LIKE</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">debian</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token assign-left variable" style=color:#f8f8f2>HOME_URL</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"https://www.ubuntu.com/"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token assign-left variable" style=color:#f8f8f2>SUPPORT_URL</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"https://help.ubuntu.com/"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token assign-left variable" style=color:#f8f8f2>BUG_REPORT_URL</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"https://bugs.launchpad.net/ubuntu/"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token assign-left variable" style=color:#f8f8f2>PRIVACY_POLICY_URL</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token assign-left variable" style=color:#f8f8f2>UBUNTU_CODENAME</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">jammy</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=213-磁盘信息>2.1.3 磁盘信息<a href=#213-磁盘信息 class=hash-link aria-label="Direct link to 2.1.3 磁盘信息" title="Direct link to 2.1.3 磁盘信息">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=2131-通过fdisk查看磁盘信息>2.1.3.1 通过fdisk查看磁盘信息<a href=#2131-通过fdisk查看磁盘信息 class=hash-link aria-label="Direct link to 2.1.3.1 通过fdisk查看磁盘信息" title="Direct link to 2.1.3.1 通过fdisk查看磁盘信息">​</a></h5>
<p>其中<code>Disk model: MR9560-16i</code>的<code>MR9560-16i</code>表示磁盘使用的是<code>RAID6</code>类型。我们后续是在系统盘的<code>/tmp</code>目录下测试，因此主要关心系统盘即可。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ </span><span class="token function" style=color:#e6db74>fdisk</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-l</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Disk /dev/sda: </span><span class="token number" style=color:#ae81ff>558.41</span><span class="token plain"> GiB, </span><span class="token number" style=color:#ae81ff>599584145408</span><span class="token plain"> bytes, </span><span class="token number" style=color:#ae81ff>1171062784</span><span class="token plain"> sectors</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Disk model: MR9560-16i</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Units: sectors of </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> * </span><span class="token number" style=color:#ae81ff>512</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>512</span><span class="token plain"> bytes</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Sector size </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">logical/physical</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">: </span><span class="token number" style=color:#ae81ff>512</span><span class="token plain"> bytes / </span><span class="token number" style=color:#ae81ff>512</span><span class="token plain"> bytes</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">I/O size </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">minimum/optimal</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">: </span><span class="token number" style=color:#ae81ff>262144</span><span class="token plain"> bytes / </span><span class="token number" style=color:#ae81ff>262144</span><span class="token plain"> bytes</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Disklabel type: gpt</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Disk identifier: 98429DEA-8628-4C03-99CD-9843A103346C</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Device       Start        End    Sectors   Size Type</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">/dev/sda1     </span><span class="token number" style=color:#ae81ff>2048</span><span class="token plain">     </span><span class="token number" style=color:#ae81ff>526335</span><span class="token plain">     </span><span class="token number" style=color:#ae81ff>524288</span><span class="token plain">   256M EFI System</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">/dev/sda2   </span><span class="token number" style=color:#ae81ff>526336</span><span class="token plain">    </span><span class="token number" style=color:#ae81ff>2623487</span><span class="token plain">    </span><span class="token number" style=color:#ae81ff>2097152</span><span class="token plain">     1G Linux filesystem</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">/dev/sda3  </span><span class="token number" style=color:#ae81ff>2623488</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1171062750</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1168439263</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>557</span><span class="token plain">.2G Linux filesystem</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Disk /dev/sdb: </span><span class="token number" style=color:#ae81ff>4.91</span><span class="token plain"> TiB, </span><span class="token number" style=color:#ae81ff>5396257308672</span><span class="token plain"> bytes, </span><span class="token number" style=color:#ae81ff>10539565056</span><span class="token plain"> sectors</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Disk model: MR9560-16i</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Units: sectors of </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> * </span><span class="token number" style=color:#ae81ff>512</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>512</span><span class="token plain"> bytes</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Sector size </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">logical/physical</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">: </span><span class="token number" style=color:#ae81ff>512</span><span class="token plain"> bytes / </span><span class="token number" style=color:#ae81ff>512</span><span class="token plain"> bytes</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">I/O size </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">minimum/optimal</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">: </span><span class="token number" style=color:#ae81ff>262144</span><span class="token plain"> bytes / </span><span class="token number" style=color:#ae81ff>1048576</span><span class="token plain"> bytes</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Disklabel type: gpt</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Disk identifier: E1B34555-9B4B-4EF7-B18B-6A7F2B5D5E40</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Device     Start         End     Sectors  Size Type</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">/dev/sdb1   </span><span class="token number" style=color:#ae81ff>2048</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>10539563007</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>10539560960</span><span class="token plain">  </span><span class="token number" style=color:#ae81ff>4</span><span class="token plain">.9T Linux filesystem</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=2132-通过df查看文件系统类型>2.1.3.2 通过df查看文件系统类型<a href=#2132-通过df查看文件系统类型 class=hash-link aria-label="Direct link to 2.1.3.2 通过df查看文件系统类型" title="Direct link to 2.1.3.2 通过df查看文件系统类型">​</a></h5>
<p>其中系统盘使用了<code>xfs</code>的系统类型。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ </span><span class="token function" style=color:#e6db74>df</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-hT</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Filesystem                      Type   Size  Used Avail Use% Mounted on</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">tmpfs                           tmpfs   26G  </span><span class="token number" style=color:#ae81ff>9</span><span class="token plain">.3M   26G   </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">% /run</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">/dev/mapper/ubuntu-root         xfs    550G  106G  444G  </span><span class="token number" style=color:#ae81ff>20</span><span class="token plain">% /</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">tmpfs                           tmpfs  126G  192K  126G   </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">% /dev/shm</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">tmpfs                           tmpfs  </span><span class="token number" style=color:#ae81ff>5</span><span class="token plain">.0M     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">  </span><span class="token number" style=color:#ae81ff>5</span><span class="token plain">.0M   </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">% /run/lock</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">/dev/mapper/vg_home-lv_home     xfs    </span><span class="token number" style=color:#ae81ff>5</span><span class="token plain">.0T  </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">.5T  </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">.5T  </span><span class="token number" style=color:#ae81ff>51</span><span class="token plain">% /home</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">/dev/sda2                       xfs   1006M  621M  386M  </span><span class="token number" style=color:#ae81ff>62</span><span class="token plain">% /boot</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">/dev/sda1                       vfat   256M  </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">.1M  250M   </span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">% /boot/efi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">shm                             tmpfs   64M     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">   64M   </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">% /run/containerd/io.containerd.grpc.v1.cri/sandboxes/c268a702b2a081b2ce66466d4dc48ab0fb718026e637f0e41456ee86a2e1bf38/shm</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=214-golang源代码>2.1.4 Golang源代码<a href=#214-golang源代码 class=hash-link aria-label="Direct link to 2.1.4 Golang源代码" title="Direct link to 2.1.4 Golang源代码">​</a></h4>
<p>为了简化示例，这里使用到了一个第三方包 <code>github.com/otiai10/copy</code> ，这个包实现比较简单，这里换成自己手写的文件/目录拷贝也是能复现的。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>package</span><span class="token plain"> main</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token string" style=color:#a6e22e>"log/slog"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token string" style=color:#a6e22e>"os"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token string" style=color:#a6e22e>"github.com/otiai10/copy"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>main</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>len</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">os</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Args</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>3</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    slog</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Error</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"usage: copy &lt;src> &lt;dst>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  srcPath </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> os</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Args</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  dstPath </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> os</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Args</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> srcPath </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>||</span><span class="token plain"> dstPath </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    slog</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Error</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"COPY_SRC or COPY_DST is not set"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>copy</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Copy</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">srcPath</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> dstPath</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    slog</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Error</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"failed to copy models"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"error"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  slog</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Info</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"copy models"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"source"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> srcPath</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"target"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> dstPath</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>将该源代码编译为<code>Linux</code>下可以运行的二进制，文件名为<code>copy</code>。使用方式为：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">./copy 源文件 目标文件</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=215-文件信息>2.1.5 文件信息<a href=#215-文件信息 class=hash-link aria-label="Direct link to 2.1.5 文件信息" title="Direct link to 2.1.5 文件信息">​</a></h4>
<p>测试的文件大小约<code>19GB</code>。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ ll</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">total </span><span class="token number" style=color:#ae81ff>39680432</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">-rwxr-xr-x </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> qiang.guo qiang.guo     </span><span class="token number" style=color:#ae81ff>3166731</span><span class="token plain"> Jul  </span><span class="token number" style=color:#ae81ff>7</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>15</span><span class="token plain">:44 copy</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>-rwxrwxrwx</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> qiang.guo qiang.guo </span><span class="token number" style=color:#ae81ff>20314793478</span><span class="token plain"> Jul  </span><span class="token number" style=color:#ae81ff>7</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>15</span><span class="token plain">:54 tritonserver-24.02.09.10-llm-mo-py3.10.tar</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>-rwxrwxrwx</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> qiang.guo qiang.guo </span><span class="token number" style=color:#ae81ff>20314793478</span><span class="token plain"> Jul  </span><span class="token number" style=color:#ae81ff>7</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>16</span><span class="token plain">:17 tritonserver-24.02.09.10-llm-mo-py3.10.tar2</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>其中：</p>
<ul>
<li><code>copy</code>文件是上面源代码编译后的二进制文件。</li>
<li><code>tritonserver-24.02.09.10-llm-mo-py3.10.tar</code>是大模型源文件打包后的文件，只使用一个大文件而不是目录是为了方便测试。</li>
<li><code>tritonserver-24.02.09.10-llm-mo-py3.10.tar2</code>是大模型源文件通过<code>copy</code>程序拷贝后的文件，文件拷贝时间开销不到<code>1</code>秒（毫秒级别）。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=22-源代码排查>2.2 源代码排查<a href=#22-源代码排查 class=hash-link aria-label="Direct link to 2.2 源代码排查" title="Direct link to 2.2 源代码排查">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=221-自身文件排查>2.2.1 自身文件排查<a href=#221-自身文件排查 class=hash-link aria-label="Direct link to 2.2.1 自身文件排查" title="Direct link to 2.2.1 自身文件排查">​</a></h4>
<p>首先检查了自己的源代码，并没有特殊的地方，底层都是调用的<code>Golang</code>标准库<code>io.Copy/io.CopyBuffer</code>来实现的文件拷贝。有没有可能在<code>io.Copy/io.CopyBuffer</code>的实现中其实没有真正实现大文件拷贝，而是做了软连接或硬链接？</p>
<p>实际上一开始我们就可以排除这样的想法，因为如果是软连接，在系统上就可以看出来；如果是硬链接的话<code>inode</code>也能看得出来；并且<code>Golang</code>标准库原则上不会自动做这种骚操作。
稳妥起见，还是看一下两个文件的<code>inode</code>信息：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ ll </span><span class="token parameter variable" style=color:#f8f8f2>-i</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">total </span><span class="token number" style=color:#ae81ff>39680432</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token number" style=color:#ae81ff>520141384</span><span class="token plain"> -rwxr-xr-x </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> qiang.guo qiang.guo     </span><span class="token number" style=color:#ae81ff>3166731</span><span class="token plain"> Jul  </span><span class="token number" style=color:#ae81ff>7</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>15</span><span class="token plain">:44 copy</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token number" style=color:#ae81ff>520141385</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-rwxrwxrwx</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> qiang.guo qiang.guo </span><span class="token number" style=color:#ae81ff>20314793478</span><span class="token plain"> Jul  </span><span class="token number" style=color:#ae81ff>7</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>15</span><span class="token plain">:54 tritonserver-24.02.09.10-llm-mo-py3.10.tar</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token number" style=color:#ae81ff>520141386</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-rwxrwxrwx</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> qiang.guo qiang.guo </span><span class="token number" style=color:#ae81ff>20314793478</span><span class="token plain"> Jul  </span><span class="token number" style=color:#ae81ff>7</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>16</span><span class="token plain">:17 tritonserver-24.02.09.10-llm-mo-py3.10.tar2</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>看起来两个文件的<code>inode</code>并没有一样，因此放弃拷贝后的文件是连接文件这一种可能。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=222-iocopy深入排查>2.2.2 io.Copy深入排查<a href=#222-iocopy深入排查 class=hash-link aria-label="Direct link to 2.2.2 io.Copy深入排查" title="Direct link to 2.2.2 io.Copy深入排查">​</a></h4>
<p>既然最终都会走到<code>io.Copy*</code>方法，那么我们应该去查看标准库的具体实现逻辑和流程。</p>
<p>这个拷贝操作最终都会走到一个系统调用，以<code>Linux</code>系统为例，具体在<code>/usr/local/go/src/os/zero_copy_linux.go</code>源码文件的这里：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">f </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">File</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>copyFileRange</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">r io</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Reader</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">written </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> handled </span><span class="token builtin" style=color:#e6db74>bool</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    written</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> handled</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>pollCopyFileRange</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">f</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">pfd</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">src</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">pfd</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> remain</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> written</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> handled</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>wrapSyscallError</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"copy_file_range"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>其中的<code>pollCopyFileRange</code>是一个系统调用，不同的系统实现会不一样。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token string" style=color:#a6e22e>"internal/poll"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token string" style=color:#a6e22e>"io"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token string" style=color:#a6e22e>"syscall"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>var</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    pollCopyFileRange </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> poll</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">CopyFileRange</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    pollSplice        </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> poll</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Splice</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>大概的调用关系是这样的：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">应用程序 (Go)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ↓ io.Copy()</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">标准库 (glibc)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ↓ read()/write() 或 copy_file_range()</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">内核 VFS层</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ↓</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">具体文件系统实现</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>初步看在程序这块本身没有什么问题，都是做的拷贝操作，并且最后调用的是系统函数实现的文件拷贝。如果需要进一步排查的话，需要去查看系统函数源码实现，可能会稍微麻烦一些，因此我们先去排查下其他方面，比如磁盘的一些信息。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=23-磁盘信息排查>2.3 磁盘信息排查<a href=#23-磁盘信息排查 class=hash-link aria-label="Direct link to 2.3 磁盘信息排查" title="Direct link to 2.3 磁盘信息排查">​</a></h3>
<p>我们看看是否可能是外部环境引起的，特别是进一步看看磁盘的信息。之前在查看磁盘信息的时候，知道磁盘使用的是<code>RAID6</code>和<code>XFS</code>文件系统，有没可能跟这两个有关系？</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=231-raid6>2.3.1 RAID6<a href=#231-raid6 class=hash-link aria-label="Direct link to 2.3.1 RAID6" title="Direct link to 2.3.1 RAID6">​</a></h4>
<p><code>RAID6</code>是一种使用双重奇偶校验的磁盘阵列技术，能够同时容忍<code>2</code>块磁盘故障而不丢失数据。它至少需要<code>4</code>块磁盘，其中<code>2</code>块用于存储校验信息。<code>RAID6</code>的主要优势是极高的可靠性和良好的读性能，特别适合关键业务数据存储。缺点是写性能较差（需要计算双重校验）和较长的重建时间。</p>
<p>看起来跟我们需要排查的问题没有太大关系。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=232-xfs>2.3.2 XFS<a href=#232-xfs class=hash-link aria-label="Direct link to 2.3.2 XFS" title="Direct link to 2.3.2 XFS">​</a></h4>
<p><code>XFS</code>是一个高性能的<code>64</code>位日志式文件系统，专为处理大文件和高并发<code>I/O</code>而设计。它支持高达<code>8EB</code>的文件系统容量，采用<code>extent-based</code>的空间管理方式，能够有效减少文件碎片。<code>XFS</code>的突出特点包括卓越的大文件性能、在线扩容、<code>reflink</code>支持以及优秀的并发处理能力。目前是<code>RHEL/CentOS 7+</code>的默认文件系统。</p>
<p>这里有个<code>reflink</code>的特性让人眼前一亮，看看是干什么的。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=233-关于reflink特性>2.3.3 关于reflink特性<a href=#233-关于reflink特性 class=hash-link aria-label="Direct link to 2.3.3 关于reflink特性" title="Direct link to 2.3.3 关于reflink特性">​</a></h4>
<p><code>reflink</code>是<code>XFS</code>文件系统的写时复制（<code>Copy-on-Write</code>, <code>CoW</code>）功能，允许多个文件共享相同的物理数据块，直到其中一个文件被修改时才进行实际的数据复制。</p>
<p>这个<code>CoW</code>功能具体又是什么呢？</p>
<p><code>CoW</code>是一种资源管理技术，当多个调用者请求相同资源时，它们会共享同一个副本，直到有调用者试图修改内容时，才会真正创建一个新的副本。</p>
<p><code>CoW</code>的工作原理如下：</p>
<ol>
<li>
<p>初始化状态-创建<code>CoW</code>副本</p>
<p>磁盘布局：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">┌───────────────┐</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">│   数据块 A     │ ← 原文件和副本都指向这里</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">│   数据块 B     │</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">│   数据块 C     │</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">└───────────────┘</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ↑       ↑</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">原文件元数据  副本文件元数据</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
<li>
<p>读取操作 - 共享数据</p>
<p>读取操作不会创建新的数据块，而是共享原始数据块。</p>
</li>
<li>
<p>写入操作 - 触发复制</p>
<p>写入后的磁盘布局：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">┌───────┬───────┐</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">│   数据块 A     │ ← 原文件仍指向这里</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">│   数据块 B     │</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">│   数据块 C     │</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">│   数据块 A'    │ ← 副本的新数据块</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">│   数据块 B'    │</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">│   数据块 C'    │</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">└───────────────┘</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ↑          ↑</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">原文件元数据 副本文件元数据</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
</ol>
<p>从结果现状来看的话，我们排查的问题比较吻合<code>CoW</code>特性的特征，我们进一步确认一下。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=234-排查iocopy是否使用了cow功能>2.3.4 排查io.Copy*是否使用了CoW功能<a href=#234-排查iocopy是否使用了cow功能 class=hash-link aria-label="Direct link to 2.3.4 排查io.Copy*是否使用了CoW功能" title="Direct link to 2.3.4 排查io.Copy*是否使用了CoW功能">​</a></h4>
<p>查看两个大文件的<strong>磁盘数据块范围</strong>是否一致：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ xfs_bmap </span><span class="token parameter variable" style=color:#f8f8f2>-v</span><span class="token plain"> tritonserver-24.02.09.10-llm-mo-py3.10.tar</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">tritonserver-24.02.09.10-llm-mo-py3.10.tar:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"> EXT: FILE-OFFSET           BLOCK-RANGE          AG AG-OFFSET              TOTAL FLAGS</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>23</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">:              </span><span class="token number" style=color:#ae81ff>306733544</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>306733567</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>26</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>25064</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>25087</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">            </span><span class="token number" style=color:#ae81ff>24</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>101010</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>24</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>3004535</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">:        </span><span class="token number" style=color:#ae81ff>327221808</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>330226319</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>27</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>8716848</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>11721359</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">  </span><span class="token number" style=color:#ae81ff>3004512</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>101111</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>3004536</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>6100519</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">:   </span><span class="token number" style=color:#ae81ff>338943752</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>342039735</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>28</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>8642312</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>11738295</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">  </span><span class="token number" style=color:#ae81ff>3095984</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>101111</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>6100520</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>16776703</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">:  </span><span class="token number" style=color:#ae81ff>342412320</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>353088503</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>29</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>314400</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>10990583</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">  </span><span class="token number" style=color:#ae81ff>10676184</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>101111</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>4</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>16776704</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>25165311</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">: </span><span class="token number" style=color:#ae81ff>365984352</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>374372959</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>31</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>293472</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>8682079</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">    </span><span class="token number" style=color:#ae81ff>8388608</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>101111</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>5</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>25165312</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>36837367</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">: </span><span class="token number" style=color:#ae81ff>601694208</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>613366263</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>51</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>73728</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>11745783</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">   </span><span class="token number" style=color:#ae81ff>11672056</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100101</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>36837368</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>39677327</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">: </span><span class="token number" style=color:#ae81ff>613601792</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>616441751</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>52</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>184832</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>3024791</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">    </span><span class="token number" style=color:#ae81ff>2839960</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100101</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>7</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>39677328</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>39677335</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">: </span><span class="token number" style=color:#ae81ff>365864304</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>365864311</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>31</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>173424</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>173431</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">           </span><span class="token number" style=color:#ae81ff>8</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>101111</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">$ xfs_bmap </span><span class="token parameter variable" style=color:#f8f8f2>-v</span><span class="token plain"> tritonserver-24.02.09.10-llm-mo-py3.10.tar2</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">tritonserver-24.02.09.10-llm-mo-py3.10.tar2:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"> EXT: FILE-OFFSET           BLOCK-RANGE          AG AG-OFFSET              TOTAL FLAGS</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>23</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">:              </span><span class="token number" style=color:#ae81ff>306733544</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>306733567</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>26</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>25064</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>25087</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">            </span><span class="token number" style=color:#ae81ff>24</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>101010</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>24</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>3004535</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">:        </span><span class="token number" style=color:#ae81ff>327221808</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>330226319</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>27</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>8716848</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>11721359</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">  </span><span class="token number" style=color:#ae81ff>3004512</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>101111</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>3004536</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>6100519</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">:   </span><span class="token number" style=color:#ae81ff>338943752</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>342039735</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>28</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>8642312</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>11738295</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">  </span><span class="token number" style=color:#ae81ff>3095984</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>101111</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>6100520</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>16776703</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">:  </span><span class="token number" style=color:#ae81ff>342412320</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>353088503</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>29</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>314400</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>10990583</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">  </span><span class="token number" style=color:#ae81ff>10676184</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>101111</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>4</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>16776704</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>25165311</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">: </span><span class="token number" style=color:#ae81ff>365984352</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>374372959</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>31</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>293472</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>8682079</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">    </span><span class="token number" style=color:#ae81ff>8388608</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>101111</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>5</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>25165312</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>36837367</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">: </span><span class="token number" style=color:#ae81ff>601694208</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>613366263</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>51</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>73728</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>11745783</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">   </span><span class="token number" style=color:#ae81ff>11672056</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100101</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>36837368</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>39677327</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">: </span><span class="token number" style=color:#ae81ff>613601792</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>616441751</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>52</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>184832</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>3024791</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">    </span><span class="token number" style=color:#ae81ff>2839960</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100101</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   </span><span class="token number" style=color:#ae81ff>7</span><span class="token plain">: </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>39677328</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>39677335</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">: </span><span class="token number" style=color:#ae81ff>365864304</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>365864311</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>31</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>173424</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>173431</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">           </span><span class="token number" style=color:#ae81ff>8</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>101111</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>从<code>BLOCK-RANGE</code>看起来，这两个文件确实引用了同一个数据块！</p>
<p>我们再确认一下<code>XFS</code>开启的特性查看是否开启了<code>reflink</code>特性，如下，其中的<code>reflink=1</code>表示该特性是开启的。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ xfs_info /</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">meta-data</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">/dev/mapper/ubuntu-root </span><span class="token assign-left variable" style=color:#f8f8f2>isize</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>512</span><span class="token plain">    </span><span class="token assign-left variable" style=color:#f8f8f2>agcount</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>98</span><span class="token plain">, </span><span class="token assign-left variable" style=color:#f8f8f2>agsize</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>1474560</span><span class="token plain"> blks</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">         </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">                       </span><span class="token assign-left variable" style=color:#f8f8f2>sectsz</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>512</span><span class="token plain">   </span><span class="token assign-left variable" style=color:#f8f8f2>attr</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">, </span><span class="token assign-left variable" style=color:#f8f8f2>projid32bit</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">         </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">                       </span><span class="token assign-left variable" style=color:#f8f8f2>crc</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">        </span><span class="token assign-left variable" style=color:#f8f8f2>finobt</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">, </span><span class="token assign-left variable" style=color:#f8f8f2>sparse</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">, </span><span class="token assign-left variable" style=color:#f8f8f2>rmapbt</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">         </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">                       </span><span class="token assign-left variable" style=color:#f8f8f2>reflink</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">    </span><span class="token assign-left variable" style=color:#f8f8f2>bigtime</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token assign-left variable" style=color:#f8f8f2>inobtcount</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">data     </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">                       </span><span class="token assign-left variable" style=color:#f8f8f2>bsize</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>4096</span><span class="token plain">   </span><span class="token assign-left variable" style=color:#f8f8f2>blocks</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>143958016</span><span class="token plain">, </span><span class="token assign-left variable" style=color:#f8f8f2>imaxpct</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>25</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">         </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">                       </span><span class="token assign-left variable" style=color:#f8f8f2>sunit</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>64</span><span class="token plain">     </span><span class="token assign-left variable" style=color:#f8f8f2>swidth</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>64</span><span class="token plain"> blks</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">naming   </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">version </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">              </span><span class="token assign-left variable" style=color:#f8f8f2>bsize</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>4096</span><span class="token plain">   ascii-ci</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">, </span><span class="token assign-left variable" style=color:#f8f8f2>ftype</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">log      </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">internal log           </span><span class="token assign-left variable" style=color:#f8f8f2>bsize</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>4096</span><span class="token plain">   </span><span class="token assign-left variable" style=color:#f8f8f2>blocks</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>11520</span><span class="token plain">, </span><span class="token assign-left variable" style=color:#f8f8f2>version</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">         </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">                       </span><span class="token assign-left variable" style=color:#f8f8f2>sectsz</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>512</span><span class="token plain">   </span><span class="token assign-left variable" style=color:#f8f8f2>sunit</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>64</span><span class="token plain"> blks, lazy-count</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">realtime </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">none                   </span><span class="token assign-left variable" style=color:#f8f8f2>extsz</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>4096</span><span class="token plain">   </span><span class="token assign-left variable" style=color:#f8f8f2>blocks</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">, </span><span class="token assign-left variable" style=color:#f8f8f2>rtextents</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>0</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=24-猜测与验证>2.4 猜测与验证<a href=#24-猜测与验证 class=hash-link aria-label="Direct link to 2.4 猜测与验证" title="Direct link to 2.4 猜测与验证">​</a></h3>
<p>目前有了比较确定的结论：这里的文件拷贝使用到了<code>CoW</code>特性。</p>
<p>但是为什么<code>Golang</code>程序的<code>io.Copy*</code>会引发<code>CoW</code>的特性呢？</p>
<p>猜测：与<code>Golang</code>程序没有任何关系，应该是底层<code>XFS</code>文件系统自动提供的<code>CoW</code>实现。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=241-更进一步的证据>2.4.1 更进一步的证据<a href=#241-更进一步的证据 class=hash-link aria-label="Direct link to 2.4.1 更进一步的证据" title="Direct link to 2.4.1 更进一步的证据">​</a></h4>
<p>为了验证我们的猜想，我们需要更进一步梳理程序的接口调用关系。通过源码分析，大概的调用关系应该是这样的：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">应用程序 (Go)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ↓ io.Copy()</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">标准库 (glibc)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ↓ read()/write() 或 copy_file_range()</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">内核 VFS层</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ↓</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">XFS文件系统</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ↓ 检测到相同文件系统内拷贝(猜测)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">自动extent共享/COW优化(猜测)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>其中内核的<code>VFS</code>层只是一层接口，最终的文件拷贝操作是由具体的文件系统提供的实现，比如在我们当前场景中是由<code>XFS</code>文件系统提供的实现。</p>
<p>再手动执行一次大文件拷贝，同时我们使用<code>strace</code>命令跟踪程序的系统调用，确定准确的系统函数调用关系和调用函数：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ </span><span class="token function" style=color:#e6db74>strace</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-e</span><span class="token plain"> </span><span class="token assign-left variable" style=color:#f8f8f2>trace</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">all ./copy tritonserver-24.02.09.10-llm-mo-py3.10.tar tritonserver-24.02.09.10-llm-mo-py3.10.tar3</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">execve</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"./copy"</span><span class="token plain">, </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"./copy"</span><span class="token plain">, </span><span class="token string" style=color:#a6e22e>"tritonserver-24.02.09.10-llm-mo-"</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token plain">., </span><span class="token string" style=color:#a6e22e>"tritonserver-24.02.09.10-llm-mo-"</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token plain">.</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">, 0x7ffecd624290 /* </span><span class="token number" style=color:#ae81ff>37</span><span class="token plain"> vars */</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token plain">.</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>987440646</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">copy_file_range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">, NULL, </span><span class="token number" style=color:#ae81ff>1073741824</span><span class="token plain">, </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">close</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>6</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">                                </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">close</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>3</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">                                </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token plain">.</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>确定最终是通过<code>copy_file_range</code>系统函数来实现的文件拷贝，每次拷贝<code>1GB</code>左右的容量，而且速度非常快。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=242-copy_file_range系统函数>2.4.2 copy_file_range系统函数<a href=#242-copy_file_range系统函数 class=hash-link aria-label="Direct link to 2.4.2 copy_file_range系统函数" title="Direct link to 2.4.2 copy_file_range系统函数">​</a></h4>
<p>我们查查<code>Linux</code>手册看看<code>copy_file_range</code>这个系统函数的介绍：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ </span><span class="token function" style=color:#e6db74>man</span><span class="token plain"> copy_file_range </span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>该函数是在<code>Linux</code>内核<code>4.5</code>版本引入的，但在<code>5.3</code>版本做了重构和改进：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">VERSIONS</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    The copy_file_range() system call first appeared in Linux 4.5, but glibc 2.27 provides a user-space emulation when it is not available.</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    A major rework of the kernel implementation occurred in 5.3.  Areas of the API that weren't clearly defined were clarified and  the  API  bounds  are  much  more  strictly</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    checked than on earlier kernels.  Applications should target the behaviour and requirements of 5.3 kernels.</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    First support for cross-filesystem copies was introduced in Linux 5.3.  Older kernels will return -EXDEV when cross-filesystem copies are attempted.</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>在该系统函数的最后有一段介绍比较关键：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">NOTES</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ...</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    copy_file_range() gives filesystems an opportunity to implement "copy acceleration" techniques, such as the use of reflinks (i.e., two or more inodes that  share  pointers</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    to the same copy-on-write disk blocks) or server-side-copy (in the case of NFS).</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>也就是说，如果底层的文件系统支持"拷贝加速"的技术，比如这里<code>XFS</code>提供的<code>reflink</code>，那么该系统函数将会"给文件系统机会"来实现"拷贝加速"。猜测字面意思，就是主要看<code>XFS</code>是怎么实现的，如果<code>XFS</code>支持通过<code>reflink</code>实现<code>CoW</code>特性，那么就会通过<code>reflink</code>来实现"拷贝加速"。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=243-还需要进行下去吗>2.4.3 还需要进行下去吗？<a href=#243-还需要进行下去吗 class=hash-link aria-label="Direct link to 2.4.3 还需要进行下去吗？" title="Direct link to 2.4.3 还需要进行下去吗？">​</a></h4>
<p>从目前的排查来看，基本上可以确定是因为<code>XFS</code>文件系统的<code>reflink</code>特性引发的<code>CoW</code>功能实现，使得大文件拷贝如此之快。如果需要更准确的证据，那么需要进一步去查看系统函数<code>copy_file_range</code>的源码实现，以及<code>XFS</code>对应的<code>copy_file_range</code>相关调用的接口实现。这样的排查成本会更大和周期也会更长，没有太大意义了。</p>
<p>随后我做了其他的一些尝试：</p>
<ul>
<li>我找了一个其他文件系统（<code>etx4</code>）来同样做了测试，发现没有出现<code>CoW</code>。</li>
<li>找了一个<code>XFS</code>文件系统的磁盘，但是<code>Linux</code>内核是<code>4.18</code>，同样的拷贝操作，发现没有出现<code>CoW</code>。并且系统调用没有出现<code>copy_file_range</code>系统函数调用，而是调用的<code>read/write</code>系统函数。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=3-排查结论>3. 排查结论<a href=#3-排查结论 class=hash-link aria-label="Direct link to 3. 排查结论" title="Direct link to 3. 排查结论">​</a></h2>
<ul>
<li>大文件拷贝速度过快是由于底层的<code>XFS</code>文件系统开启了<code>reflink</code>特性引发的<code>CoW</code>功能实现，与<code>Golang</code>程序没有关系。</li>
<li><code>XFS</code>文件系统的<code>CoW</code>实现需要依赖<code>Linux</code>内核版本<code>>=4.5</code>后提供的<code>copy_file_range</code>系统函数。</li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/notes/golang-nested-pointer-bug><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>遇到一个Golang指针嵌套体复制的BUG</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/programming><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>开发语言</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#1-背景介绍 class="table-of-contents__link toc-highlight">1. 背景介绍</a><li><a href=#2-排查过程 class="table-of-contents__link toc-highlight">2. 排查过程</a><ul><li><a href=#21-确认环境信息 class="table-of-contents__link toc-highlight">2.1 确认环境信息</a><li><a href=#22-源代码排查 class="table-of-contents__link toc-highlight">2.2 源代码排查</a><li><a href=#23-磁盘信息排查 class="table-of-contents__link toc-highlight">2.3 磁盘信息排查</a><li><a href=#24-猜测与验证 class="table-of-contents__link toc-highlight">2.4 猜测与验证</a></ul><li><a href=#3-排查结论 class="table-of-contents__link toc-highlight">3. 排查结论</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>