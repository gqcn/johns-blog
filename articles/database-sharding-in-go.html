<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-hidden/GoFrame/分库分表" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>电商系统案例，Go语言数据库分库分表实战 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/articles/database-sharding-in-go><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="电商系统案例，Go语言数据库分库分表实战 | John's Blog"><meta data-rh=true name=description content=本文从电商系统业务实战场景出发，以GoFrame框架和MySQL数据库为例，详细介绍针对业务数据库分库分表的设计思路和具体实现方法，帮助开发者轻松应对大数据量挑战。><meta data-rh=true property=og:description content=本文从电商系统业务实战场景出发，以GoFrame框架和MySQL数据库为例，详细介绍针对业务数据库分库分表的设计思路和具体实现方法，帮助开发者轻松应对大数据量挑战。><meta data-rh=true name=keywords content=GoFrame,分库分表,数据库分片,水平扩展,MySQL分库分表><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/articles/database-sharding-in-go><link data-rh=true rel=alternate href=https://johng.cn/articles/database-sharding-in-go hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/articles/database-sharding-in-go hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><link rel=stylesheet href=/assets/css/styles.a5309560.css><script src=/assets/js/runtime~main.1cd77dc6.js defer></script><script src=/assets/js/main.a11acb47.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/cloud-native>云原生</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/observability>可观测性</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/hidden/goframe>GoFrame</a><button aria-label="Collapse sidebar category 'GoFrame'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/goframe/examples>基于即时可用、最佳实践的Examples示例代码</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/goframe/use-error-code-gracefully-in-golang>Go开发中如何优雅地使用错误码</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/articles/rbac-permission-authentication-in-go>为Go应用增加完整的权限认证能力</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/goframe/techempower-web-benchmarks-r23>TechEmpower Web Benchmarks最新性能评测</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/articles/database-sharding-in-go>电商系统案例，Go语言数据库分库分表实战</a></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/hidden>隐藏目录</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/hidden/resource-collection>资源收藏</a><button aria-label="Expand sidebar category '资源收藏'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/hidden/other>其他文档</a><button aria-label="Expand sidebar category '其他文档'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/hidden/temp>临时文档</a><button aria-label="Expand sidebar category '临时文档'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/hidden/goframe><span itemprop=name>GoFrame</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>电商系统案例，Go语言数据库分库分表实战</span><meta itemprop=position content=2></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=前言>前言<a href=#前言 class=hash-link aria-label="Direct link to 前言" title="Direct link to 前言">​</a></h2>
<p>随着业务规模的不断扩大，单一数据库的性能瓶颈日益凸显。当数据量达到一定规模，单表数据量过大或单库负载过高时，数据库的读写性能会显著下降，甚至可能导致系统不可用。分库分表技术作为解决这一问题的有效手段，已成为大型系统架构中不可或缺的一部分。</p>
<p>本文从电商系统业务实战场景出发，以<code>GoFrame</code>框架和<code>MySQL</code>数据库为例，详细介绍针对业务数据库分库分表的设计思路和具体实现方法，帮助开发者轻松应对大数据量挑战。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=分库分表的业务场景>分库分表的业务场景<a href=#分库分表的业务场景 class=hash-link aria-label="Direct link to 分库分表的业务场景" title="Direct link to 分库分表的业务场景">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=什么是分库分表>什么是分库分表？<a href=#什么是分库分表 class=hash-link aria-label="Direct link to 什么是分库分表？" title="Direct link to 什么是分库分表？">​</a></h3>
<p>分库分表是指按照某种规则，将数据库中的一张表分散到不同的数据库或多张表中，以解决单库单表数据量过大带来的性能问题。</p>
<ul>
<li><strong>分库</strong>：将数据分散到不同的数据库实例中，主要解决数据库连接资源有限、单机磁盘空间有限、单机计算能力有限等问题。</li>
<li><strong>分表</strong>：将数据分散到同一个数据库的多张表中，主要解决单表数据量过大导致的查询效率低下问题。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=适用场景>适用场景<a href=#适用场景 class=hash-link aria-label="Direct link to 适用场景" title="Direct link to 适用场景">​</a></h3>
<p>分库分表技术适用于以下业务场景：</p>
<ol>
<li><strong>用户系统</strong>：大型互联网应用的用户数据，可按用户ID进行分片，将用户数据分散到多个库表中。</li>
<li><strong>订单系统</strong>：电商平台的订单数据，可按订单ID或时间维度分片，应对高并发订单处理。</li>
<li><strong>日志系统</strong>：系统日志、操作日志等数据量巨大且增长迅速的场景，通常按时间维度分片。</li>
<li><strong>社交媒体</strong>：社交平台的用户关系、内容数据，可按用户ID或内容ID分片。</li>
<li><strong>物联网应用</strong>：海量设备产生的数据，可按设备ID或时间分片。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=分库分表的必要性>分库分表的必要性<a href=#分库分表的必要性 class=hash-link aria-label="Direct link to 分库分表的必要性" title="Direct link to 分库分表的必要性">​</a></h3>
<ol>
<li><strong>性能提升</strong>：通过减少单表数据量，降低索引深度，提高查询效率；分散数据库压力，提高并发处理能力。</li>
<li><strong>突破限制</strong>：突破单机数据库在存储容量、连接数、计算能力等方面的限制。</li>
<li><strong>高可用性</strong>：分库可以实现数据库级别的故障隔离，提高系统整体可用性。</li>
<li><strong>扩展性</strong>：随着业务增长，可以通过增加数据库节点或表的方式实现水平扩展。</li>
<li><strong>便于维护</strong>：可以按照分片单独进行备份、恢复和归档操作，简化数据库维护工作。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=电商订单系统案例>电商订单系统案例<a href=#电商订单系统案例 class=hash-link aria-label="Direct link to 电商订单系统案例" title="Direct link to 电商订单系统案例">​</a></h2>
<p>下面我们以一个电商订单系统为例，详细介绍如何使用<code>GoFrame</code>框架实现分库分表。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=业务需求分析>业务需求分析<a href=#业务需求分析 class=hash-link aria-label="Direct link to 业务需求分析" title="Direct link to 业务需求分析">​</a></h3>
<p>假设我们的电商平台每天产生大量订单数据，随着业务增长，单表已无法承载，需要进行分库分表设计。</p>
<p><strong>订单表结构</strong>：</p>
<ul>
<li>订单ID：唯一标识</li>
<li>用户ID：下单用户</li>
<li>订单金额：订单总金额</li>
<li>订单状态：订单当前状态</li>
<li>创建时间：订单创建时间</li>
<li>更新时间：订单更新时间</li>
</ul>
<p><strong>业务特点</strong>：</p>
<ul>
<li>订单数据量大且增长迅速</li>
<li>查询多基于订单ID和用户ID</li>
<li>历史订单查询频率较低，但需要长期保存</li>
<li>系统需要支持快速扩容</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=分库分表方案设计>分库分表方案设计<a href=#分库分表方案设计 class=hash-link aria-label="Direct link to 分库分表方案设计" title="Direct link to 分库分表方案设计">​</a></h3>
<p>基于业务特点，我们采用以下分库分表策略：</p>
<ol>
<li><strong>分库策略</strong>：<strong>按用户ID取模分库</strong>，将不同用户的订单分散到不同的数据库实例中</li>
<li><strong>分表策略</strong>：<strong>按订单创建时间按月分表</strong>，便于历史数据归档和查询优化</li>
</ol>
<p><strong>分库分表结构</strong>：</p>
<ul>
<li>分库：<code>db_0, db_1</code>（按用户ID取模）</li>
<li>分表：<code>order_202501, order_202502, ...</code>（按月份命名）</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=技术实现>技术实现<a href=#技术实现 class=hash-link aria-label="Direct link to 技术实现" title="Direct link to 技术实现">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=1-数据库准备>1. 数据库准备<a href=#1-数据库准备 class=hash-link aria-label="Direct link to 1. 数据库准备" title="Direct link to 1. 数据库准备">​</a></h4>
<p>首先，需要提前创建分库和相应的表结构：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>-- 创建分库</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DATABASE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>IF</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>EXISTS</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">db_0</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DATABASE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>IF</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>EXISTS</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">db_1</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>-- 在每个分库中创建按月分表（以2025年1月和2月为例）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>USE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">db_0</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">order_202501</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">order_id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>varchar</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>32</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'订单ID'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">user_id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>11</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'用户ID'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">amount</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>decimal</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>10</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'订单金额'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">status</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>tinyint</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>4</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'订单状态'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">create_time</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>datetime</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'创建时间'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">update_time</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>datetime</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'更新时间'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token keyword" style=color:#66d9ef>PRIMARY</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>KEY</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">order_id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token keyword" style=color:#66d9ef>KEY</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">idx_user_id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">user_id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token keyword" style=color:#66d9ef>KEY</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">idx_create_time</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">create_time</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>ENGINE</span><span class="token operator" style=color:#66d9ef>=</span><span class="token keyword" style=color:#66d9ef>InnoDB</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DEFAULT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>CHARSET</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">utf8mb4 </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>'2025年1月订单表'</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">order_202502</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">order_id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>varchar</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>32</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'订单ID'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">user_id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>11</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'用户ID'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">amount</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>decimal</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>10</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'订单金额'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">status</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>tinyint</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>4</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'订单状态'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">create_time</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>datetime</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'创建时间'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">update_time</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>datetime</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'更新时间'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token keyword" style=color:#66d9ef>PRIMARY</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>KEY</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">order_id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token keyword" style=color:#66d9ef>KEY</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">idx_user_id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">user_id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token keyword" style=color:#66d9ef>KEY</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">idx_create_time</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">create_time</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>ENGINE</span><span class="token operator" style=color:#66d9ef>=</span><span class="token keyword" style=color:#66d9ef>InnoDB</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DEFAULT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>CHARSET</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">utf8mb4 </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>'2025年2月订单表'</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>-- 同样在db_1中创建相同结构的表</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>USE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">db_1</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">order_202501</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic>-- 与db_0中的表结构相同</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">order_202502</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic>-- 与db_0中的表结构相同</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=2-数据库配置>2. 数据库配置<a href=#2-数据库配置 class=hash-link aria-label="Direct link to 2. 数据库配置" title="Direct link to 2. 数据库配置">​</a></h4>
<p>在<code>config.yaml</code>中配置多数据库连接：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">database</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">default</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">link</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"mysql:root:password@tcp(127.0.0.1:3306)/default"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">debug</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">db_0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">link</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"mysql:root:password@tcp(127.0.0.1:3306)/db_0"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">debug</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">db_1</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">link</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"mysql:root:password@tcp(127.0.0.1:3306)/db_1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">debug</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=3-自定义分库分表规则>3. 自定义分库分表规则<a href=#3-自定义分库分表规则 class=hash-link aria-label="Direct link to 3. 自定义分库分表规则" title="Direct link to 3. 自定义分库分表规则">​</a></h4>
<p>我们需要实现自定义的分库分表规则，支持 <strong>按用户ID分库</strong> 和 <strong>按时间分表</strong>：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// ShardingValue 分片值</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> ShardingValue </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    UserId     </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain">       </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    CreateTime time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Time</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// OrderShardingRule 订单分片规则</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> OrderShardingRule </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    SchemaCount </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// 分库数量</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// 实现ShardingRule接口中的SchemaName方法</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">r </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">OrderShardingRule</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>SchemaName</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> config gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ShardingSchemaConfig</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> value any</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token builtin" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">SchemaCount </span><span class="token operator" style=color:#66d9ef>&lt;=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> gerror</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"schema count should be greater than 0"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 获取用户ID</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    sv</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> ok </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> value</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ShardingValue</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>!</span><span class="token plain">ok </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> gerror</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"invalid sharding value"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    userId </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> sv</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">UserId</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> userId </span><span class="token operator" style=color:#66d9ef>&lt;=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> gerror</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"invalid user_id for sharding"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 按用户ID取模确定分库</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    schemaIndex </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> userId </span><span class="token operator" style=color:#66d9ef>%</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">SchemaCount</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> fmt</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Sprintf</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"%s%d"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> config</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Prefix</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> schemaIndex</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// 实现ShardingRule接口中的TableName方法</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">r </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">OrderShardingRule</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>TableName</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> config gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ShardingTableConfig</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> value any</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token builtin" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 获取订单创建时间</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    sv</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> ok </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> value</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ShardingValue</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>!</span><span class="token plain">ok </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> gerror</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"invalid sharding value"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    createTime </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> sv</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">CreateTime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> createTime</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>IsZero</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> gerror</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"invalid create_time for sharding"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 按月份确定分表</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    tableName </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> fmt</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Sprintf</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token string" style=color:#a6e22e>"%s%d%02d"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> config</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Prefix</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> createTime</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Year</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> createTime</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Month</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> tableName</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=4-订单模型定义>4. 订单模型定义<a href=#4-订单模型定义 class=hash-link aria-label="Direct link to 4. 订单模型定义" title="Direct link to 4. 订单模型定义">​</a></h4>
<p>订单模型关联订单数据表结构，用于操作数据表。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Order 订单模型</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> Order </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    OrderId    </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain">      </span><span class="token string" style=color:#a6e22e>`json:"order_id"    dc:"订单ID"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    UserId     </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain">       </span><span class="token string" style=color:#a6e22e>`json:"user_id"     dc:"用户ID"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Amount     </span><span class="token builtin" style=color:#e6db74>float64</span><span class="token plain">     </span><span class="token string" style=color:#a6e22e>`json:"amount"      dc:"订单金额"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Status     </span><span class="token builtin" style=color:#e6db74>int</span><span class="token plain">         </span><span class="token string" style=color:#a6e22e>`json:"status"      dc:"订单状态"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    CreateTime time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Time   </span><span class="token string" style=color:#a6e22e>`json:"create_time" dc:"创建时间"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    UpdateTime time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Time   </span><span class="token string" style=color:#a6e22e>`json:"update_time" dc:"更新时间"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=5-订单服务实现>5. 订单服务实现<a href=#5-订单服务实现 class=hash-link aria-label="Direct link to 5. 订单服务实现" title="Direct link to 5. 订单服务实现">​</a></h4>
<p>订单服务的核心逻辑，为了简化示例，这里只列举了几个关键方法的代码实现。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>NewOrderService</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">OrderService </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    orderModel </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>DB</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"order"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    shardingConfig </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ShardingConfig</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// 分库配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        Schema</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ShardingSchemaConfig</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            Enable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>true</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic>// 启用分库</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            Prefix</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"db_"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// 分库前缀</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            Rule</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">   </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">sharding</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">OrderShardingRule</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain">SchemaCount</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// 分库规则</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// 分表配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        Table</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ShardingTableConfig</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            Enable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>true</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain">     </span><span class="token comment" style=color:#8292a2;font-style:italic>// 启用分表</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            Prefix</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"order_"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// 分表前缀</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            Rule</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">   </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">sharding</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">OrderShardingRule</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain">SchemaCount</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// 分表规则</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">OrderService</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        orderModel</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> orderModel</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Sharding</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">shardingConfig</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// CreateOrder 创建订单</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">OrderService</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>CreateOrder</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> userId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> amount </span><span class="token builtin" style=color:#e6db74>float64</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token builtin" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 生成订单ID，分库分表后不能使用自增id</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    orderId </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> grand</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>S</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 创建订单对象</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    now </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> gtime</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Now</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    order </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Order</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        OrderId</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">    orderId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        UserId</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">     userId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        Amount</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">     amount</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        Status</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">     StatusPending</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// 常量表示待支付</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        CreateTime</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> now</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        UpdateTime</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> now</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 创建分库分表模型</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    model </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">orderModel</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>ShardingValue</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ShardingValue</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        UserId</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">     order</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">UserId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        CreateTime</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> order</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">CreateTime</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 插入订单数据</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>_</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Data</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">order</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Insert</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> orderId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// GetOrderById 根据订单ID查询订单</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">OrderService</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>GetOrderById</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> orderId </span><span class="token builtin" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> userId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> createTime time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Time</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Order</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 创建分库分表模型</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    model </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">orderModel</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>ShardingValue</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ShardingValue</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        UserId</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">     userId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        CreateTime</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> createTime</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 查询订单</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>var</span><span class="token plain"> order model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Order</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Where</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"order_id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> orderId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Scan</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">order</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">order</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// 其他订单相关方法...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=6-订单接口实现>6. 订单接口实现<a href=#6-订单接口实现 class=hash-link aria-label="Direct link to 6. 订单接口实现" title="Direct link to 6. 订单接口实现">​</a></h4>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// CreateReq 创建订单请求参数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> CreateReq </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    UserId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain">   </span><span class="token string" style=color:#a6e22e>`v:"required|min:1#用户ID不能为空|用户ID必须大于0"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Amount </span><span class="token builtin" style=color:#e6db74>float64</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>`v:"required|min:0.01#订单金额不能为空|订单金额必须大于0"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// CreateRes 创建订单返回结果</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> CreateRes </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    OrderId </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>`json:"orderId"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// CreateOrder 创建订单</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">c </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">OrderController</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>CreateOrder</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">CreateReq</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">res </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">CreateRes</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    orderId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> c</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">orderService</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>CreateOrder</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">UserId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Amount</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">CreateRes</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain">OrderId</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> orderId</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// GetReq 获取订单详情请求参数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> GetReq </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    OrderId    </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>`v:"required#订单ID不能为空"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    UserId     </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain">  </span><span class="token string" style=color:#a6e22e>`v:"required|min:1#用户ID不能为空|用户ID必须大于0"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    CreateTime </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>`v:"required#创建时间不能为空"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// GetRes 获取订单详情返回结果</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> GetRes </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Order </span><span class="token comment" style=color:#8292a2;font-style:italic>// 嵌入订单实体</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// GetOrder 获取订单详情</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">c </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">OrderController</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>GetOrder</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">GetReq</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">res </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">GetRes</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    order</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> c</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">orderService</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>GetOrderById</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">OrderId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">UserId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">CreateTime</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">GetRes</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain">Order</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> order</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// 其他API接口实现...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=数据扩容>数据扩容<a href=#数据扩容 class=hash-link aria-label="Direct link to 数据扩容" title="Direct link to 数据扩容">​</a></h3>
<p>如果分库分表后，随着业务规模的增长，当前的数据库设计已经无法满足需求，还需要进行数据扩容，怎么做？</p>
<p>为了数据扩容操作对业务的影响降到最低，可以参考以下操作步骤，个人建议、仅作参考：</p>
<ol>
<li><strong>确认数据备份</strong>：保证现有数据至少有一份存档。比如冷备数据。</li>
<li><strong>扩容数据库表</strong>：以当前业务场景为例，由于数据表本来就是按照日期滚动分表的，我们需要进一步扩容数据库。预估业务增长速度，进而评估扩容后的数据库表数量。</li>
<li><strong>使用数据双写</strong>：在扩容期间，新写入的数据同时写入新旧分片。<!-- -->
<ul>
<li>具体方式可以通过订阅旧分片的<code>binlog</code>，实现异步将数据按照新的分片规则重新散列。</li>
<li>订阅程序需要分布式处理，提高<code>binlog</code>处理效率，降低同步延迟可能带来的业务影响。</li>
<li>这种方案非常适合读多写少的业务场景。</li>
</ul>
</li>
<li><strong>旧分片数据迁移</strong>：将历史数据从旧分片迁移到新分片（不删除旧分片数据）。如果一开始使用了一致性哈希的设计，那么这里受影响的分片将只有一部分。</li>
<li><strong>更新分片规则</strong>：更新分片规则，程序将使用到新的分片进行数据读写。分片规则中的核心参数如分片数通常可以通过配置来管理，这样无需重新编译发布程序服务。</li>
<li><strong>关闭数据同步</strong>：关闭<code>binlog</code>同步，让程序按照新的分片规则自动维护数据读写。</li>
<li><strong>清理旧分片数据</strong>：在确认新分片规则下数据完整后，可以安全地清理旧分片规则所映射的分片数据。</li>
</ol>
<p>下图展示了数据扩容的完整流程：</p>
<!-- -->
<p>图中展示了分库分表扩容的四个主要阶段：准备阶段、数据同步阶段、切换阶段和收尾阶段。其中：</p>
<ul>
<li>浅灰色背景的方块表示主要阶段</li>
<li>浅蓝色背景的节点表示关键操作（数据双写、数据迁移和更新分片规则）</li>
<li>白色背景的节点表示具体的执行步骤</li>
</ul>
<p>数据同步和切换是最关键的环节，需要特别注意。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=分库分表实现中的关键点>分库分表实现中的关键点<a href=#分库分表实现中的关键点 class=hash-link aria-label="Direct link to 分库分表实现中的关键点" title="Direct link to 分库分表实现中的关键点">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=1-主键设计>1. 主键设计<a href=#1-主键设计 class=hash-link aria-label="Direct link to 1. 主键设计" title="Direct link to 1. 主键设计">​</a></h3>
<p>在分库分表环境中，主键设计是一个核心问题：</p>
<ul>
<li><strong>避免使用自增ID</strong>：不同分片的自增ID会产生冲突，导致主键重复</li>
<li><strong>全局唯一ID</strong>：应使用全局唯一ID生成策略，如：<!-- -->
<ul>
<li><strong>UUID</strong>：全局唯一但无序，索引效率较低</li>
<li><strong>雪花算法(Snowflake)</strong>：Twitter开源的分布式ID生成器，能保证全局唯一且有序</li>
<li><strong>号段模式</strong>：预先分配一段ID区间，用完再申请新区间</li>
<li><strong>Redis自增</strong>：利用Redis的原子操作生成全局递增ID</li>
</ul>
</li>
</ul>
<p>在我们的示例中，订单ID采用了字符串类型，当然也可以使用雪花算法等方案生成全局唯一ID。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=2-分片键选择>2. 分片键选择<a href=#2-分片键选择 class=hash-link aria-label="Direct link to 2. 分片键选择" title="Direct link to 2. 分片键选择">​</a></h3>
<p>分片键的选择直接影响分库分表的效果和性能：</p>
<ul>
<li><strong>选择高频查询条件</strong>：分片键应该是查询中经常使用的字段，以减少跨分片查询。</li>
<li><strong>数据分布均匀</strong>：分片键的值应该分布均匀，避免数据倾斜。</li>
<li><strong>不易变更</strong>：分片键一旦确定，变更成本很高，应选择不易变更的字段。</li>
</ul>
<p>在我们的案例中，<strong>用户ID作为分库键，创建时间作为分表键</strong>，这样既能保证查询效率，又能实现数据均匀分布。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=3-跨分片查询处理>3. 跨分片查询处理<a href=#3-跨分片查询处理 class=hash-link aria-label="Direct link to 3. 跨分片查询处理" title="Direct link to 3. 跨分片查询处理">​</a></h3>
<p>跨分片查询是分库分表实现中的难点，主要有以下处理方法：</p>
<ul>
<li><strong>避免跨分片查询</strong>：通过合理设计分片策略，尽量避免跨分片查询。</li>
<li><strong>分片聚合</strong>：对多个分片的查询结果在应用层进行聚合处理。</li>
</ul>
<p>在我们的案例中，通过要求数据库操作时必须提供用户ID和创建时间，避免了跨分片查询的问题。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=4-索引设计>4. 索引设计<a href=#4-索引设计 class=hash-link aria-label="Direct link to 4. 索引设计" title="Direct link to 4. 索引设计">​</a></h3>
<p>分库分表环境下的索引设计需要特别注意：</p>
<ul>
<li><strong>分片键索引</strong>：分片键必须建立索引，以提高路由效率。</li>
<li><strong>冗余索引控制</strong>：过多的索引会影响写入性能，应控制索引数量。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=5-sql兼容性>5. SQL兼容性<a href=#5-sql兼容性 class=hash-link aria-label="Direct link to 5. SQL兼容性" title="Direct link to 5. SQL兼容性">​</a></h3>
<p>分库分表环境下，某些SQL操作会受到限制：</p>
<ul>
<li><strong>JOIN操作受限</strong>：跨分片JOIN操作性能较差，应尽量避免。</li>
<li><strong>排序和分页</strong>：跨分片排序和分页需要在应用层处理。</li>
<li><strong>聚合函数</strong>：避免在业务中涉及COUNT、SUM等跨多分片的聚合函数设计和使用。</li>
<li><strong>事务范围</strong>：单个事务应尽量限制在同一个分片内。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=6-动态扩容>6. 动态扩容<a href=#6-动态扩容 class=hash-link aria-label="Direct link to 6. 动态扩容" title="Direct link to 6. 动态扩容">​</a></h3>
<p>随着业务规模增长，分库分表系统需要支持动态扩容能力，以应对不断增长的数据量：</p>
<ul>
<li>
<p><strong>一致性哈希算法</strong>：使用一致性哈希算法进行分片，当增加新节点时，只需要迁移部分数据，而不是全量重新分片。</p>
</li>
<li>
<p><strong>平滑迁移策略</strong>：实现在线数据迁移，不影响系统正常运行。常见策略包括：</p>
<ul>
<li><strong>双写模式</strong>：在迁移期间，新写入的数据同时写入新旧分片。</li>
<li><strong>归档迁移</strong>：先迁移历史数据，再处理增量数据。</li>
<li><strong>分批迁移</strong>：将数据分批次迁移，降低单次迁移对系统的影响。</li>
</ul>
</li>
<li>
<p><strong>动态路由规则</strong>：支持在不重启系统的情况下动态更新路由规则，实现平滑切换。</p>
</li>
<li>
<p><strong>容量规划</strong>：提前规划分片容量，预留足够的扩展空间，避免频繁扩容。</p>
</li>
</ul>
<blockquote>
<p>在<code>GoFrame</code>中，可以通过配置文件和分片规则的动态加载来支持动态扩容。例如，当需要增加新的分库时，可以在配置中添加新的数据源，并更新分片规则中的分库数量。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=最佳实践>最佳实践<a href=#最佳实践 class=hash-link aria-label="Direct link to 最佳实践" title="Direct link to 最佳实践">​</a></h2>
<p>基于上述分析和实践经验，总结以下分库分表的最佳实践：</p>
<ol>
<li><strong>提前规划</strong>：在系统设计初期就考虑分库分表方案，避免后期改造成本过高。</li>
<li><strong>合理选择分片键</strong>：分片键应具备查询高频、分布均匀、不易变更的特点。</li>
<li><strong>全局唯一ID</strong>：使用雪花算法等方案生成全局唯一ID，替代自增主键。</li>
<li><strong>避免跨分片操作</strong>：业务设计应尽量避免跨分片查询、排序和事务。</li>
<li><strong>冗余适当数据</strong>：适当冗余关联数据，减少跨分片JOIN操作。</li>
<li><strong>应用层聚合</strong>：复杂查询在应用层进行结果聚合和处理。</li>
<li><strong>异步处理</strong>：非实时性要求的操作采用异步处理机制。</li>
<li><strong>容量规划</strong>：提前规划扩容策略，预留足够的扩展空间。</li>
<li><strong>监控与告警</strong>：建立完善的监控系统，及时发现分片异常、资源紧张等问题。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=总结>总结<a href=#总结 class=hash-link aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h2>
<p>本文通过电商订单系统的案例，详细介绍了使用<code>GoFrame</code>实现<code>MySQL</code>数据库分库分表的完整解决方案。分库分表作为应对大数据量挑战的有效手段，能够显著提升系统性能和可扩展性。</p>
<p>在实际应用中，应根据业务特点和数据特性，选择合适的分片策略，并妥善处理跨分片查询、分布式事务等问题。<code>GoFrame</code>框架提供的分库分表功能，简化了实现过程，使开发者能够更加专注于业务逻辑的实现。</p>
<p>随着业务的发展，可能需要进一步优化分库分表方案，如引入分布式ID生成器、增加缓存层、实现动态扩容等，以满足不断增长的业务需求。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=参考资料>参考资料<a href=#参考资料 class=hash-link aria-label="Direct link to 参考资料" title="Direct link to 参考资料">​</a></h2>
<ol>
<li><code>GoFrame</code>官方文档：<a href=https://goframe.org/docs/core/gdb-sharding target=_blank rel="noopener noreferrer">ORM分库分表</a></li>
<li>数据库分库分表原理与实践</li>
<li>大型互联网应用数据库架构设计与优化</li>
</ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/goframe/techempower-web-benchmarks-r23><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>TechEmpower Web Benchmarks最新性能评测</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/hidden><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>隐藏目录</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#前言 class="table-of-contents__link toc-highlight">前言</a><li><a href=#分库分表的业务场景 class="table-of-contents__link toc-highlight">分库分表的业务场景</a><ul><li><a href=#什么是分库分表 class="table-of-contents__link toc-highlight">什么是分库分表？</a><li><a href=#适用场景 class="table-of-contents__link toc-highlight">适用场景</a><li><a href=#分库分表的必要性 class="table-of-contents__link toc-highlight">分库分表的必要性</a></ul><li><a href=#电商订单系统案例 class="table-of-contents__link toc-highlight">电商订单系统案例</a><ul><li><a href=#业务需求分析 class="table-of-contents__link toc-highlight">业务需求分析</a><li><a href=#分库分表方案设计 class="table-of-contents__link toc-highlight">分库分表方案设计</a><li><a href=#技术实现 class="table-of-contents__link toc-highlight">技术实现</a><li><a href=#数据扩容 class="table-of-contents__link toc-highlight">数据扩容</a></ul><li><a href=#分库分表实现中的关键点 class="table-of-contents__link toc-highlight">分库分表实现中的关键点</a><ul><li><a href=#1-主键设计 class="table-of-contents__link toc-highlight">1. 主键设计</a><li><a href=#2-分片键选择 class="table-of-contents__link toc-highlight">2. 分片键选择</a><li><a href=#3-跨分片查询处理 class="table-of-contents__link toc-highlight">3. 跨分片查询处理</a><li><a href=#4-索引设计 class="table-of-contents__link toc-highlight">4. 索引设计</a><li><a href=#5-sql兼容性 class="table-of-contents__link toc-highlight">5. SQL兼容性</a><li><a href=#6-动态扩容 class="table-of-contents__link toc-highlight">6. 动态扩容</a></ul><li><a href=#最佳实践 class="table-of-contents__link toc-highlight">最佳实践</a><li><a href=#总结 class="table-of-contents__link toc-highlight">总结</a><li><a href=#参考资料 class="table-of-contents__link toc-highlight">参考资料</a></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>