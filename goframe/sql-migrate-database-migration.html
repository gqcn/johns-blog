<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-hidden/GoFrame/SQL Migrate数据库迁移与版本管理：管理数据库结构变更的有效方法" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>SQL Migrate数据库迁移与版本管理：管理数据库结构变更的有效方法 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/goframe/sql-migrate-database-migration><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="SQL Migrate数据库迁移与版本管理：管理数据库结构变更的有效方法 | John's Blog"><meta data-rh=true name=description content=本文全面剖析了数据库迁移与版本管理的关键技术，从手动SQL脚本到golang-migrate等专业工具，并提供了实用的最佳实践和生产环境安全审核方案，帮助团队实现可控、可追踪的数据库变更管理。><meta data-rh=true property=og:description content=本文全面剖析了数据库迁移与版本管理的关键技术，从手动SQL脚本到golang-migrate等专业工具，并提供了实用的最佳实践和生产环境安全审核方案，帮助团队实现可控、可追踪的数据库变更管理。><meta data-rh=true name=keywords content=数据库迁移,版本管理,golang-migrate,SQL审核,GoFrame,持续集成,多环境部署,数据库版本控制,团队协作,安全变更><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/goframe/sql-migrate-database-migration><link data-rh=true rel=alternate href=https://johng.cn/goframe/sql-migrate-database-migration hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/goframe/sql-migrate-database-migration hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><script src=https://cdn.wwads.cn/js/makemoney.js async></script><link rel=stylesheet href=/assets/css/styles.96de5670.css><script src=/assets/js/runtime~main.c6ab75bf.js defer></script><script src=/assets/js/main.045ed315.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/cloud-native>云原生</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/ai>AI技术</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/observability>可观测性</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/hidden>隐藏目录</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/hidden/goframe>GoFrame</a><button aria-label="Collapse sidebar category 'GoFrame'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/goframe/notes>Go语言实战案例文章建议</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/goframe/notes-v3>GoFrame v3开发笔记</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/goframe/relation-query-best-practice>关联表查询的最佳实践：以电商系统为例</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/goframe/multi-tenant>GoFrame实现多租户隔离的最佳实践</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/goframe/data-validation>Go接口校验全攻略：如何优雅地处理和验证用户输入</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/hidden/ai-prompt-notes>AI提示工程随笔</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/hidden/goframe-v3>关于GoFrame V3版本的一些思考</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/goframe/sql-migrate-database-migration>SQL Migrate数据库迁移与版本管理：管理数据库结构变更的有效方法</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/hidden/ideas>一些想法</a><button aria-label="Expand sidebar category '一些想法'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/hidden/resource-collection>资源收藏</a><button aria-label="Expand sidebar category '资源收藏'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/hidden/other>其他文档</a><button aria-label="Expand sidebar category '其他文档'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/hidden/temp>临时文档</a><button aria-label="Expand sidebar category '临时文档'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/data-structures-and-algorithms>数据结构和算法</a><button aria-label="Expand sidebar category '数据结构和算法'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/hidden/goframe><span itemprop=name>GoFrame</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>SQL Migrate数据库迁移与版本管理：管理数据库结构变更的有效方法</span><meta itemprop=position content=2></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=1-数据库迁移与版本管理的业务场景与必要性>1. 数据库迁移与版本管理的业务场景与必要性<a href=#1-数据库迁移与版本管理的业务场景与必要性 class=hash-link aria-label="Direct link to 1. 数据库迁移与版本管理的业务场景与必要性" title="Direct link to 1. 数据库迁移与版本管理的业务场景与必要性">​</a></h2>
<p>在现代软件开发过程中，数据库结构变更是一个常见且不可避免的环节。随着业务的发展和需求的变化，我们经常需要对数据库进行各种修改，如添加新表、修改字段、创建索引等。如果没有一个有效的管理机制，这些变更可能会导致以下问题：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=11-常见业务场景>1.1 常见业务场景<a href=#11-常见业务场景 class=hash-link aria-label="Direct link to 1.1 常见业务场景" title="Direct link to 1.1 常见业务场景">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=111-多环境部署一致性>1.1.1 多环境部署一致性<a href=#111-多环境部署一致性 class=hash-link aria-label="Direct link to 1.1.1 多环境部署一致性" title="Direct link to 1.1.1 多环境部署一致性">​</a></h4>
<p>在开发、测试、预发布和生产等多个环境中，确保数据库结构的一致性是一个巨大挑战。没有版本管理，很容易出现环境不一致的情况，导致应用在某些环境中无法正常运行。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">开发环境 → 测试环境 → 预发布环境 → 生产环境</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=112-团队协作冲突>1.1.2 团队协作冲突<a href=#112-团队协作冲突 class=hash-link aria-label="Direct link to 1.1.2 团队协作冲突" title="Direct link to 1.1.2 团队协作冲突">​</a></h4>
<p>在多人协作的项目中，不同开发者可能同时对数据库进行修改。如果没有统一的变更管理，很容易出现冲突或覆盖他人的修改。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=113-版本回滚需求>1.1.3 版本回滚需求<a href=#113-版本回滚需求 class=hash-link aria-label="Direct link to 1.1.3 版本回滚需求" title="Direct link to 1.1.3 版本回滚需求">​</a></h4>
<p>当新版本出现严重问题需要回滚时，如果没有对应的数据库回滚机制，可能导致数据库结构与应用代码不匹配，引发更多问题。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=114-微服务架构下的数据库演进>1.1.4 微服务架构下的数据库演进<a href=#114-微服务架构下的数据库演进 class=hash-link aria-label="Direct link to 1.1.4 微服务架构下的数据库演进" title="Direct link to 1.1.4 微服务架构下的数据库演进">​</a></h4>
<p>在微服务架构中，不同服务可能有独立的数据库或共享某些数据库。管理这些服务的数据库变更和依赖关系变得更加复杂。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=12-数据库迁移管理的必要性>1.2 数据库迁移管理的必要性<a href=#12-数据库迁移管理的必要性 class=hash-link aria-label="Direct link to 1.2 数据库迁移管理的必要性" title="Direct link to 1.2 数据库迁移管理的必要性">​</a></h3>
<ul>
<li><strong>可追踪性</strong>：记录所有数据库变更的历史，知道何时、由谁、为什么进行了特定的变更</li>
<li><strong>可重复性</strong>：确保相同的变更可以在不同环境中以相同的方式执行</li>
<li><strong>可靠性</strong>：减少人为错误，特别是在复杂的生产环境中</li>
<li><strong>协作效率</strong>：提高团队协作效率，减少冲突和沟通成本</li>
<li><strong>持续集成/持续部署支持</strong>：支持自动化的CI/CD流程，实现数据库变更的自动化部署</li>
</ul>
<p>了解了数据库迁移与版本管理的重要性和业务场景后，接下来我们将探讨几种常见的实现方式，从最基础的手动执行到专业的迁移工具，每种方式都有其适用场景和优缺点。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=2-数据库迁移与版本管理的�常见方式>2. 数据库迁移与版本管理的常见方式<a href=#2-数据库迁移与版本管理的常见方式 class=hash-link aria-label="Direct link to 2. 数据库迁移与版本管理的常见方式" title="Direct link to 2. 数据库迁移与版本管理的常见方式">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=21-手动执行sql脚本>2.1 手动执行SQL脚本<a href=#21-手动执行sql脚本 class=hash-link aria-label="Direct link to 2.1 手动执行SQL脚本" title="Direct link to 2.1 手动执行SQL脚本">​</a></h3>
<p>最原始的方式是手动编写SQL脚本并在各环境中执行。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>-- 手动执行的SQL脚本示例</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>ALTER</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> users </span><span class="token keyword" style=color:#66d9ef>ADD</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COLUMN</span><span class="token plain"> last_login_time </span><span class="token keyword" style=color:#66d9ef>DATETIME</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'最后登录时间'</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>INDEX</span><span class="token plain"> idx_user_login </span><span class="token keyword" style=color:#66d9ef>ON</span><span class="token plain"> users</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">last_login_time</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=211-优点>2.1.1 优点<a href=#211-优点 class=hash-link aria-label="Direct link to 2.1.1 优点" title="Direct link to 2.1.1 优点">​</a></h4>
<ul>
<li><strong>简单直接</strong>：不需要额外的工具或框架，直接使用数据库客户端即可执行</li>
<li><strong>灵活性高</strong>：可以执行任何复杂的SQL语句，不受工具限制</li>
<li><strong>无学习成本</strong>：团队成员不需要学习新工具</li>
<li><strong>适合小型项目</strong>：对于规模小、变更少的项目，这种方式足够简单有效</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=212-缺点>2.1.2 缺点<a href=#212-缺点 class=hash-link aria-label="Direct link to 2.1.2 缺点" title="Direct link to 2.1.2 缺点">​</a></h4>
<ul>
<li><strong>缺乏版本控制</strong>：无法跟踪哪些脚本已执行，哪些未执行</li>
<li><strong>执行顺序难以管理</strong>：依赖手动维护执行顺序，容易出错</li>
<li><strong>容易出现人为错误</strong>：手动执行容易遗漏或重复执行某些脚本</li>
<li><strong>难以追踪变更历史</strong>：无法知道何时、由谁执行了哪些变更</li>
<li><strong>回滚困难</strong>：没有自动化的回滚机制，需要手动编写和执行回滚脚本</li>
<li><strong>多环境一致性差</strong>：不同环境可能执行不同的脚本或顺序不同，导致环境不一致</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=22-基于版本号的sql脚本管理>2.2 基于版本号的SQL脚本管理<a href=#22-基于版本号的sql脚本管理 class=hash-link aria-label="Direct link to 2.2 基于版本号的SQL脚本管理" title="Direct link to 2.2 基于版本号的SQL脚本管理">​</a></h3>
<p>这种方式将SQL脚本按版本号命名并按顺序执行，通常配合一个版本记录表来跟踪已执行的脚本。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token operator" style=color:#66d9ef>/</span><span class="token plain">migrations</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  ├── V1</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">0__create_users_table</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  ├── V1</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">1__add_email_column</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  ├── V1</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">0__create_orders_table</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  └── V1</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">1__add_order_status</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>版本记录表示例：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">schema_version</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">version</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>VARCHAR</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>50</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">description</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>VARCHAR</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>200</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">installed_on</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TIMESTAMP</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DEFAULT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>CURRENT_TIMESTAMP</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">success</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>BOOLEAN</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>PRIMARY</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>KEY</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">version</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=221-优点>2.2.1 优点<a href=#221-优点 class=hash-link aria-label="Direct link to 2.2.1 优点" title="Direct link to 2.2.1 优点">​</a></h4>
<ul>
<li><strong>版本控制</strong>：通过版本号和版本记录表，可以清晰地知道当前数据库处于哪个版本</li>
<li><strong>执行顺序明确</strong>：脚本按版本号顺序执行，避免顺序错误</li>
<li><strong>避免重复执行</strong>：版本记录表可以防止同一脚本被多次执行</li>
<li><strong>可追踪性</strong>：可以记录每个变更的执行时间和状态</li>
<li><strong>仍然保持简单</strong>：相比完全手动方式有所改进，但实现仍然相对简单</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=222-缺点>2.2.2 缺点<a href=#222-缺点 class=hash-link aria-label="Direct link to 2.2.2 缺点" title="Direct link to 2.2.2 缺点">​</a></h4>
<ul>
<li><strong>仍需手动管理</strong>：需要手动维护版本号和执行脚本</li>
<li><strong>回滚支持有限</strong>：通常需要额外编写回滚脚本，且回滚过程可能不够自动化</li>
<li><strong>缺乏自动化工具支持</strong>：需要自行开发脚本来执行和管理迁移</li>
<li><strong>对复杂变更支持有限</strong>：对于需要数据迁移的复杂变更，可能需要额外的处理逻辑</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=23-orm框架内置的迁移功能>2.3 ORM框架内置的迁移功能<a href=#23-orm框架内置的迁移功能 class=hash-link aria-label="Direct link to 2.3 ORM框架内置的迁移功能" title="Direct link to 2.3 ORM框架内置的迁移功能">​</a></h3>
<p>许多现代<code>ORM</code>框架提供了内置的迁移功能，如<code>Django</code>的<code>Migrations</code>、<code>Laravel</code>的<code>Migrations</code>等。这些工具通常支持：</p>
<ul>
<li>自动生成迁移脚本</li>
<li>检测模型变化</li>
<li>应用/回滚迁移</li>
<li>迁移状态查询</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=231-优点>2.3.1 优点<a href=#231-优点 class=hash-link aria-label="Direct link to 2.3.1 优点" title="Direct link to 2.3.1 优点">​</a></h4>
<ul>
<li><strong>与框架无缝集成</strong>：作为框架的一部分，使用体验一致，学习成本低</li>
<li><strong>自动生成迁移脚本</strong>：基于模型变化自动生成迁移脚本，减少手动编写SQL的工作量</li>
<li><strong>双向迁移</strong>：支持升级和回滚操作</li>
<li><strong>依赖管理</strong>：能够处理迁移脚本之间的依赖关系</li>
<li><strong>数据迁移支持</strong>：除了结构变更，还支持数据迁移操作</li>
<li><strong>开发体验好</strong>：与开发流程紧密结合，提高开发效率</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=232-缺点>2.3.2 缺点<a href=#232-缺点 class=hash-link aria-label="Direct link to 2.3.2 缺点" title="Direct link to 2.3.2 缺点">​</a></h4>
<ul>
<li><strong>框架绑定</strong>：与特定框架绑定，不易跨框架使用</li>
<li><strong>自动生成的SQL可能不够优化</strong>：自动生成的SQL可能不如手写的SQL高效</li>
<li><strong>学习特定语法</strong>：需要学习框架特定的迁移语法和命令</li>
<li><strong>复杂场景支持有限</strong>：某些复杂的数据库操作可能无法通过框架的迁移功能完成</li>
<li><strong>黑盒操作</strong>：开发者可能不清楚底层实际执行的SQL语句</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=233-注意事项>2.3.3 注意事项<a href=#233-注意事项 class=hash-link aria-label="Direct link to 2.3.3 注意事项" title="Direct link to 2.3.3 注意事项">​</a></h4>
<p>ORM框架内置的迁移功能自动生成的迁移脚本可能没有考虑数据安全，在字段修改、表重构等敏感<code>DDL</code>操作时可能导致数据丢失，在生产环境使用时存在多种可能导致数据丢失的情况，主要包括：</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=2331-字段类型修改导致的数据截断>2.3.3.1 字段类型修改导致的数据截断<a href=#2331-字段类型修改导致的数据截断 class=hash-link aria-label="Direct link to 2.3.3.1 字段类型修改导致的数据截断" title="Direct link to 2.3.3.1 字段类型修改导致的数据截断">​</a></h5>
<p>当将字段类型从较大的类型修改为较小的类型时，可能会导致数据截断。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>-- 例如，将VARCHAR(255)修改为VARCHAR(50)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>-- 自动生成的迁移可能会直接执行：</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>ALTER</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">users</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>MODIFY</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COLUMN</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">description</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>VARCHAR</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>50</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>-- 这将导致超过50个字符的数据被截断</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=2332-表重构导致的数据丢失>2.3.3.2 表重构导致的数据丢失<a href=#2332-表重构导致的数据丢失 class=hash-link aria-label="Direct link to 2.3.3.2 表重构导致的数据丢失" title="Direct link to 2.3.3.2 表重构导致的数据丢失">​</a></h5>
<p>当模型变化较大时，某些ORM框架迁移功能可能会选择删除旧表并创建新表，而不是执行<code>ALTER TABLE</code>操作。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>-- 自动生成的迁移可能会执行：</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>DROP</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">users</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">users</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>-- 这将导致原表中的所有数据丢失</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=2333-字段删除导致的数据丢失>2.3.3.3 字段删除导致的数据丢失<a href=#2333-字段删除导致的数据丢失 class=hash-link aria-label="Direct link to 2.3.3.3 字段删除导致的数据丢失" title="Direct link to 2.3.3.3 字段删除导致的数据丢失">​</a></h5>
<p>当从模型中删除字段时，自动生成的迁移脚本通常会直接删除该字段，而不会考虑先备份数据。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>-- 当从模型中删除email字段时，自动生成的迁移可能是：</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>ALTER</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">users</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DROP</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COLUMN</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">email</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>-- 这将导致所有用户的邮箱信息永久丢失</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=2334-唯一约束添加导致的数据冲突>2.3.3.4 唯一约束添加导致的数据冲突<a href=#2334-唯一约束添加导致的数据冲突 class=hash-link aria-label="Direct link to 2.3.3.4 唯一约束添加导致的数据冲突" title="Direct link to 2.3.3.4 唯一约束添加导致的数据冲突">​</a></h5>
<p>当在现有数据上添加唯一约束时，如果数据中存在重复值，迁移将失败或导致数据丢失。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>-- 在现有表上添加唯一索引：</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>ALTER</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">users</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>ADD</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>UNIQUE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>INDEX</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">idx_email</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">email</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>-- 如果表中存在重复的邮箱，这个操作将失败</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=2335-外键关系处理不当>2.3.3.5 外键关系处理不当<a href=#2335-外键关系处理不当 class=hash-link aria-label="Direct link to 2.3.3.5 外键关系处理不当" title="Direct link to 2.3.3.5 外键关系处理不当">​</a></h5>
<p>当删除或修改外键关联的表或字段时，如果没有正确处理外键关系，可能导致数据一致性问题。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>-- 删除被引用的主表：</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>DROP</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">categories</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>-- 如果有产品表引用了分类表，可能导致外键约束错误或数据不一致</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=2336-回滚操作的不可逆性>2.3.3.6 回滚操作的不可逆性<a href=#2336-回滚操作的不可逆性 class=hash-link aria-label="Direct link to 2.3.3.6 回滚操作的不可逆性" title="Direct link to 2.3.3.6 回滚操作的不可逆性">​</a></h5>
<p>某些数据变更是不可逆的，即使有回滚脚本，也无法恢复原始数据。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>-- 如果执行了数据截断操作：</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>ALTER</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">users</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>MODIFY</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COLUMN</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">description</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>VARCHAR</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>50</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>-- 回滚脚本可能是：</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>ALTER</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">users</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>MODIFY</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COLUMN</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">description</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>VARCHAR</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>255</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>-- 但被截断的数据已经丢失，无法通过回滚恢复</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=234-适用场景>2.3.4 适用场景<a href=#234-适用场景 class=hash-link aria-label="Direct link to 2.3.4 适用场景" title="Direct link to 2.3.4 适用场景">​</a></h4>
<p>这种方式主要适合以下场景：</p>
<ul>
<li><strong>非严谨的个人项目</strong>：数据不敏感，可以接受偏差的项目</li>
<li><strong>小型团队项目</strong>：团队成员都使用相同框架，并且数据量较小</li>
<li><strong>原型开发阶段</strong>：在项目早期需要快速迭代的阶段</li>
<li><strong>内部工具或测试环境</strong>：数据可以容忍丢失或重建的环境</li>
</ul>
<blockquote>
<p>注意：对于企业级生产环境、关键业务系统或数据敏感的项目，应谨慎使用ORM框架的自动迁移功能。在这些场景下，建议使用专业数据库迁移工具或手写的迁移脚本，并进行人工审核。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=24-专业数据库迁移工具>2.4 专业数据库迁移工具<a href=#24-专业数据库迁移工具 class=hash-link aria-label="Direct link to 2.4 专业数据库�迁移工具" title="Direct link to 2.4 专业数据库迁移工具">​</a></h3>
<p>专门的数据库迁移工具提供了更强大的功能：</p>
<ul>
<li><strong>Flyway</strong>：<code>Java</code>生态系统中流行的数据库迁移工具</li>
<li><strong>Liquibase</strong>：支持多种数据库的开源数据库变更管理工具</li>
<li><strong>Alembic</strong>：<code>Python SQLAlchemy</code>的数据库迁移工具</li>
<li><strong>golang-migrate</strong>：<code>Go</code>语言的数据库迁移工具</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=241-优点>2.4.1 优点<a href=#241-优点 class=hash-link aria-label="Direct link to 2.4.1 优点" title="Direct link to 2.4.1 优点">​</a></h4>
<ul>
<li><strong>独立于应用框架</strong>：可以与任何语言或框架的应用一起使用</li>
<li><strong>多数据库支持</strong>：通常支持多种数据库系统</li>
<li><strong>强大的版本控制</strong>：提供完善的版本管理和迁移历史记录</li>
<li><strong>命令行和API支持</strong>：既可以通过命令行使用，也可以通过API集成到应用中</li>
<li><strong>CI/CD友好</strong>：易于集成到持续集成和持续部署流程中</li>
<li><strong>社区支持</strong>：成熟的工具通常有活跃的社区和丰富的文档</li>
<li><strong>企业级特性</strong>：部分工具提供了高级功能，如基线版本、条件迁移、多环境配置等</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=242-缺点>2.4.2 缺点<a href=#242-缺点 class=hash-link aria-label="Direct link to 2.4.2 缺点" title="Direct link to 2.4.2 缺点">​</a></h4>
<ul>
<li><strong>额外的依赖</strong>：引入了新的工具依赖</li>
<li><strong>学习成本</strong>：需要学习特定工具的使用方法和最佳实践</li>
<li><strong>与应用集成需要额外工作</strong>：需要编写代码将工具与应用集成</li>
<li><strong>可能的性能开销</strong>：某些工具在执行迁移时可能带来额外的性能开销</li>
<li><strong>配置复杂性</strong>：高级功能可能需要复杂的配置</li>
</ul>
<p>在了解了各种数据库迁移方式的优缺点后，我们可以根据项目的实际需求选择最合适的方案。对于大多数现代应用开发，特别是需要团队协作和多环境部署的项目，我们推荐以下数据库迁移与版本管理方式。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=3-推荐的数据库迁移与版本管理方式>3. 推荐的数据库迁移与版本管理方式<a href=#3-推荐的数据库迁移与版本管理方式 class=hash-link aria-label="Direct link to 3. 推荐的数据库迁移与版本管理方式" title="Direct link to 3. 推荐的数据库迁移与版本管理方式">​</a></h2>
<p>基于实际项目经验，以下是推荐的数据库迁移与版本管理方式。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=31-sql迁移版本管理工具>3.1 SQL迁移版本管理工具<a href=#31-sql迁移版本管理工具 class=hash-link aria-label="Direct link to 3.1 SQL迁移版本管理工具" title="Direct link to 3.1 SQL迁移版本管理工具">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=311-常用sql版本管理工具>3.1.1 常用SQL版本管理工具<a href=#311-常用sql版本管理工具 class=hash-link aria-label="Direct link to 3.1.1 常用SQL版本管理工具" title="Direct link to 3.1.1 常用SQL版本管理工具">​</a></h4>
<p>数据库迁移工具推荐尽可能与开发语言和框架无关，这样可以在不同的项目中使用相同的迁移方案。以下是几款常见的与开发语言无关的SQL迁移版本管理工具。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=3111-flyway>3.1.1.1 Flyway<a href=#3111-flyway class=hash-link aria-label="Direct link to 3.1.1.1 Flyway" title="Direct link to 3.1.1.1 Flyway">​</a></h5>
<p><a href=https://flywaydb.org/ target=_blank rel="noopener noreferrer">Flyway</a> 是一款开源的数据库迁移工具，它的特点包括：</p>
<ul>
<li><strong>多平台支持</strong>：提供命令行工具、<code>Java API</code>、<code>Maven</code>插件、<code>Gradle</code>插件等多种使用方式</li>
<li><strong>多数据库支持</strong>：<code>Oracle</code>、<code>SQL Server</code>、<code>DB2</code>、<code>MySQL</code>、<code>PostgreSQL</code>等多种数据库</li>
<li><strong>版本化管理</strong>：使用版本号管理每个迁移脚本</li>
<li><strong>安全性</strong>：防止已应用的迁移脚本被修改</li>
<li><strong>商业与社区版</strong>：提供免费的社区版和功能更完善的商业版</li>
</ul>
<p>命名规范示例：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">V1__Create_person_table</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">V2__Add_people</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">V3__Add_nickname_column</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=3112-liquibase>3.1.1.2 Liquibase<a href=#3112-liquibase class=hash-link aria-label="Direct link to 3.1.1.2 Liquibase" title="Direct link to 3.1.1.2 Liquibase">​</a></h5>
<p><a href=https://www.liquibase.org/ target=_blank rel="noopener noreferrer">Liquibase</a> 是一款开源的数据库模式变更管理工具，具有以下特点：</p>
<ul>
<li><strong>多格式支持</strong>：可以使用XML、YAML、JSON或SQL编写变更脚本</li>
<li><strong>多数据库支持</strong>：支持20多种不同的数据库</li>
<li><strong>变更集</strong>：使用“变更集”（Changeset）管理变更</li>
<li><strong>上下文感知</strong>：可以根据不同的环境执行不同的变更</li>
<li><strong>回滚支持</strong>：支持自动生成回滚脚本</li>
</ul>
<p>Liquibase的变更集示例（XML格式）：</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token tag punctuation" style=color:#f8f8f2>&lt;</span><span class="token tag" style=color:#f92672>changeSet</span><span class="token tag" style=color:#f92672> </span><span class="token tag attr-name" style="color:#a6e22e !important">id</span><span class="token tag attr-value punctuation attr-equals" style=color:#f8f8f2>=</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag attr-value" style=color:#f92672>1</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag" style=color:#f92672> </span><span class="token tag attr-name" style="color:#a6e22e !important">author</span><span class="token tag attr-value punctuation attr-equals" style=color:#f8f8f2>=</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag attr-value" style=color:#f92672>bob</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag punctuation" style=color:#f8f8f2>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token tag punctuation" style=color:#f8f8f2>&lt;</span><span class="token tag" style=color:#f92672>createTable</span><span class="token tag" style=color:#f92672> </span><span class="token tag attr-name" style="color:#a6e22e !important">tableName</span><span class="token tag attr-value punctuation attr-equals" style=color:#f8f8f2>=</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag attr-value" style=color:#f92672>department</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag punctuation" style=color:#f8f8f2>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token tag punctuation" style=color:#f8f8f2>&lt;</span><span class="token tag" style=color:#f92672>column</span><span class="token tag" style=color:#f92672> </span><span class="token tag attr-name" style="color:#a6e22e !important">name</span><span class="token tag attr-value punctuation attr-equals" style=color:#f8f8f2>=</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag attr-value" style=color:#f92672>id</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag" style=color:#f92672> </span><span class="token tag attr-name" style="color:#a6e22e !important">type</span><span class="token tag attr-value punctuation attr-equals" style=color:#f8f8f2>=</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag attr-value" style=color:#f92672>int</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag punctuation" style=color:#f8f8f2>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token tag punctuation" style=color:#f8f8f2>&lt;</span><span class="token tag" style=color:#f92672>constraints</span><span class="token tag" style=color:#f92672> </span><span class="token tag attr-name" style="color:#a6e22e !important">primaryKey</span><span class="token tag attr-value punctuation attr-equals" style=color:#f8f8f2>=</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag attr-value" style=color:#f92672>true</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag" style=color:#f92672> </span><span class="token tag attr-name" style="color:#a6e22e !important">nullable</span><span class="token tag attr-value punctuation attr-equals" style=color:#f8f8f2>=</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag attr-value" style=color:#f92672>false</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag punctuation" style=color:#f8f8f2>/></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token tag punctuation" style=color:#f8f8f2>&lt;/</span><span class="token tag" style=color:#f92672>column</span><span class="token tag punctuation" style=color:#f8f8f2>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token tag punctuation" style=color:#f8f8f2>&lt;</span><span class="token tag" style=color:#f92672>column</span><span class="token tag" style=color:#f92672> </span><span class="token tag attr-name" style="color:#a6e22e !important">name</span><span class="token tag attr-value punctuation attr-equals" style=color:#f8f8f2>=</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag attr-value" style=color:#f92672>name</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag" style=color:#f92672> </span><span class="token tag attr-name" style="color:#a6e22e !important">type</span><span class="token tag attr-value punctuation attr-equals" style=color:#f8f8f2>=</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag attr-value" style=color:#f92672>varchar(50)</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag punctuation" style=color:#f8f8f2>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token tag punctuation" style=color:#f8f8f2>&lt;</span><span class="token tag" style=color:#f92672>constraints</span><span class="token tag" style=color:#f92672> </span><span class="token tag attr-name" style="color:#a6e22e !important">nullable</span><span class="token tag attr-value punctuation attr-equals" style=color:#f8f8f2>=</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag attr-value" style=color:#f92672>false</span><span class="token tag attr-value punctuation" style=color:#f8f8f2>"</span><span class="token tag punctuation" style=color:#f8f8f2>/></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token tag punctuation" style=color:#f8f8f2>&lt;/</span><span class="token tag" style=color:#f92672>column</span><span class="token tag punctuation" style=color:#f8f8f2>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token tag punctuation" style=color:#f8f8f2>&lt;/</span><span class="token tag" style=color:#f92672>createTable</span><span class="token tag punctuation" style=color:#f8f8f2>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token tag punctuation" style=color:#f8f8f2>&lt;/</span><span class="token tag" style=color:#f92672>changeSet</span><span class="token tag punctuation" style=color:#f8f8f2>></span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=3113-alembic>3.1.1.3 Alembic<a href=#3113-alembic class=hash-link aria-label="Direct link to 3.1.1.3 Alembic" title="Direct link to 3.1.1.3 Alembic">​</a></h5>
<p><a href=https://alembic.sqlalchemy.org/ target=_blank rel="noopener noreferrer">Alembic</a> 是一款轻量级的数据库迁移工具，虽然它是为Python的SQLAlchemy ORM设计的，但它的迁移脚本是纯粹的SQL文件，可以在任何项目中使用：</p>
<ul>
<li><strong>版本化迁移</strong>：支持向前和向后的数据库迁移</li>
<li><strong>自动生成迁移脚本</strong>：可以基于模型变化自动生成迁移脚本</li>
<li><strong>分支支持</strong>：支持分支和合并迁移</li>
<li><strong>多数据库支持</strong>：支持SQLAlchemy支持的所有数据库</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=3114-golang-migrate>3.1.1.4 golang-migrate<a href=#3114-golang-migrate class=hash-link aria-label="Direct link to 3.1.1.4 golang-migrate" title="Direct link to 3.1.1.4 golang-migrate">​</a></h5>
<p><a href=https://github.com/golang-migrate/migrate target=_blank rel="noopener noreferrer">golang-migrate</a> 是一个强大的数据库迁移工具，它的最大特点是与任何开发语言或框架无关，可以在任何项目中使用，无论是使用<code>Go</code>、<code>Java</code>、<code>Python</code>、<code>PHP</code>还是其他语言开发的项目。</p>
<p>它支持多种数据库系统，包括：</p>
<ul>
<li><code>MySQL</code></li>
<li><code>PostgreSQL</code></li>
<li><code>SQLite</code></li>
<li><code>MongoDB</code></li>
<li><code>Microsoft SQL Server</code></li>
<li><code>CockroachDB</code></li>
<li><code>Clickhouse</code></li>
<li>等多种数据库</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=312-golang-migrate方案>3.1.2 golang-migrate方案<a href=#312-golang-migrate方案 class=hash-link aria-label="Direct link to 3.1.2 golang-migrate方案" title="Direct link to 3.1.2 golang-migrate方案">​</a></h4>
<p>在上面介绍的几种工具中，<code>golang-migrate</code>因其语言无关性、简洁性和强大的功能而脱颜而出。它不仅支持多种数据库系统，还提供了命令行和程序化API的双重使用方式，非常适合现代开发团队的需求。</p>
<p>以下我们将详细介绍使用<code>golang-migrate</code>工具的完整迁移版本管理方案，从安装、配置到实际使用的各个环节。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=313-安装golang-migrate>3.1.3 安装golang-migrate<a href=#313-安装golang-migrate class=hash-link aria-label="Direct link to 3.1.3 安装golang-migrate" title="Direct link to 3.1.3 安装golang-migrate">​</a></h4>
<p><code>golang-migrate</code>提供了多种安装方式，可以选择最适合您环境的方式：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># MacOS使用Homebrew安装</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">brew </span><span class="token function" style=color:#e6db74>install</span><span class="token plain"> golang-migrate</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># Linux使用curl安装</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>curl</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-L</span><span class="token plain"> https://github.com/golang-migrate/migrate/releases/download/v4.16.2/migrate.linux-amd64.tar.gz </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>tar</span><span class="token plain"> xvz</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>sudo</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>mv</span><span class="token plain"> migrate /usr/local/bin/</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># Windows可以从官方GitHub仓库下载可执行文件</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 或使用scoop安装</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">scoop </span><span class="token function" style=color:#e6db74>install</span><span class="token plain"> migrate</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 如果您使用Go语言，也可以通过go install安装</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">go </span><span class="token function" style=color:#e6db74>install</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-tags</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'mysql'</span><span class="token plain"> github.com/golang-migrate/migrate/v4/cmd/migrate@latest</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=314-目录设计与命名规范>3.1.4 目录设计与命名规范<a href=#314-目录设计与命名规范 class=hash-link aria-label="Direct link to 3.1.4 目录设计与命名规范" title="Direct link to 3.1.4 目录设计与命名规范">​</a></h4>
<blockquote>
<p>即便不依赖<code>golang-migrate</code>工具管理SQL迁移脚本，以下的目录设计以及命名规范也同样适合于手动管理SQL迁移脚本的场景。</p>
</blockquote>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=3141-目录结构设计>3.1.4.1 目录结构设计<a href=#3141-目录结构设计 class=hash-link aria-label="Direct link to 3.1.4.1 目录结构设计" title="Direct link to 3.1.4.1 目录结构设计">​</a></h5>
<p>在使用<code>golang-migrate</code>进行数据库迁移时，推荐采用以下目录结构：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token operator" style=color:#66d9ef>/</span><span class="token plain">项目根目录</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  └── manifest</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      └── sql                # SQL版本管理目录</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          ├── mysql          # MySQL迁移脚本</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          │   ├── </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token plain">版本前缀</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token boolean" style=color:#ae81ff>_</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token plain">描述</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">up</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          │   ├── </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token plain">版本前缀</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token boolean" style=color:#ae81ff>_</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token plain">描述</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">down</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          │   ├── </span><span class="token operator" style=color:#66d9ef>...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          │   └── </span><span class="token operator" style=color:#66d9ef>...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          └── postgres       # PostgreSQL迁移脚本</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">如果需要</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这种目录结构有以下优点：</p>
<ul>
<li><strong>集中管理</strong>：将所有SQL版本管理文件集中在<code>manifest/sql</code>目录下，方便管理和查找</li>
<li><strong>多数据库支持</strong>：按数据库类型分类组织，支持同一项目使用多种数据库</li>
<li><strong>清晰的版本历史</strong>：通过文件名可以直观地看到数据库结构的演进历史</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=3142-迁移脚本的up和down含义>3.1.4.2 迁移脚本的up和down含义<a href=#3142-迁移脚本的up和down含义 class=hash-link aria-label="Direct link to 3.1.4.2 迁移脚本的up和down含义" title="Direct link to 3.1.4.2 迁移脚本的up和down含义">​</a></h5>
<p>每个迁移版本都包含两个文件：</p>
<ul>
<li>
<p><strong>up文件</strong>（如<code>v0.1.0_create_users_table.up.sql</code>）：包含升级操作，即应用新版本时需要执行的变更，例如创建表、添加字段、创建索引等。</p>
</li>
<li>
<p><strong>down文件</strong>（如<code>v0.1.0_create_users_table.down.sql</code>）：包含回滚操作，即当需要回滚到上一版本时执行的操作，例如删除表、删除字段、删除索引等。<code>down</code>文件应该是<code>up</code>文件的逆操作，确保可以完全回滚变更。</p>
</li>
</ul>
<p>例如，对于创建用户表的迁移：</p>
<p><code>v0.1.0_create_users_table.up.sql</code>（升级脚本）：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">users</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>BIGINT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>UNSIGNED</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>AUTO_INCREMENT</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">username</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>VARCHAR</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>50</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'用户名'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">email</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>VARCHAR</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>100</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'邮箱'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">created_at</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DATETIME</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DEFAULT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>CURRENT_TIMESTAMP</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>PRIMARY</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>KEY</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>UNIQUE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>INDEX</span><span class="token plain"> idx_username </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">username</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>UNIQUE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>INDEX</span><span class="token plain"> idx_email </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">email</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>ENGINE</span><span class="token operator" style=color:#66d9ef>=</span><span class="token keyword" style=color:#66d9ef>InnoDB</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DEFAULT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>CHARSET</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">utf8mb4 </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>'用户表'</span><span class="token punctuation" style=color:#f8f8f2>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>v0.1.0_create_users_table.down.sql</code>（回滚脚本）：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>DROP</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>IF</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>EXISTS</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">users</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>在<code>golang-migrate</code>中，可以只创建<code>up</code>文件而不创建<code>down</code>文件，但这会带来以下影响：</p>
<ol>
<li>
<p><strong>无法回滚该版本</strong>：当执行<code>migrate down</code>命令时，如果没有对应的<code>down</code>文件，工具将无法执行回滚操作，会返回错误。</p>
</li>
<li>
<p><strong>版本控制受限</strong>：如果需要回滚到更早的版本，则必须跳过没有<code>down</code>文件的版本，可能需要使用<code>force</code>命令强制设置版本号。</p>
</li>
<li>
<p><strong>紧急情况处理困难</strong>：在生产环境中，如果需要紧急回滚某个有问题的变更，没有<code>down</code>文件将大大增加处理难度。</p>
</li>
<li>
<p><strong>文档不完整</strong>：<code>down</code>文件也是一种文档，记录了如何撤销变更，没有它会使数据库变更的文档不完整。</p>
</li>
</ol>
<p>因此，即使在某些情况下您认为不需要回滚，也强烈建议始终创建对应的<code>down</code>文件，以保证版本控制的完整性和灵活性。在某些情况下，您可能需要在<code>down</code>文件中添加特殊的处理逻辑，例如备份数据后再删除表。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=3143-迁移脚本命名规范>3.1.4.3 迁移脚本命名规范<a href=#3143-迁移脚本命名规范 class=hash-link aria-label="Direct link to 3.1.4.3 迁移脚本命名规范" title="Direct link to 3.1.4.3 迁移脚本命名规范">​</a></h5>
<p><code>golang-migrate</code>支持多种脚本文件命名规范，主要有两种常用的命名方式：</p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=31431-数字序列命名方式>3.1.4.3.1 数字序列命名方式<a href=#31431-数��字序列命名方式 class=hash-link aria-label="Direct link to 3.1.4.3.1 数字序列命名方式" title="Direct link to 3.1.4.3.1 数字序列命名方式">​</a></h6>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">000001_create_users_table</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">up</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">000001_create_users_table</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">down</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">000002_add_user_fields</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">up</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">000002_add_user_fields</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">down</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这种方式使用数字序列作为前缀，例如<code>000001</code>、<code>000002</code>等。它的优点是：</p>
<ul>
<li>简单直观，按数字顺序执行</li>
<li>容易自动生成，使用<code>migrate create -seq</code>命令可以自动生成递增的序列号</li>
<li>适合频繁发布的项目，序列号不会很快耗尽</li>
</ul>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=31432-语义化版本号命名方式>3.1.4.3.2 语义化版本号命名方式<a href=#31432-语义化版本号命名方式 class=hash-link aria-label="Direct link to 3.1.4.3.2 语义化版本号命名方式" title="Direct link to 3.1.4.3.2 语义化版本号命名方式">​</a></h6>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">v0</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">0_create_users_table</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">up</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">v0</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">0_create_users_table</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">down</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">v0</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">0_add_user_fields</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">up</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">v0</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">0_add_user_fields</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">down</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">sql</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这种方式使用语义化版本号作为前缀，例如<code>v0.1.0</code>、<code>v0.2.0</code>等。它的优点是：</p>
<ul>
<li>更易于理解文件的用途以及与应用版本的关系</li>
<li>可以直观地反映出重大版本变更，例如<code>v1.0.0</code>到<code>v2.0.0</code>的变化</li>
<li>适合与应用版本绑定的项目，例如每个应用版本发布都会有对应的数据库变更</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=315-创建迁移脚本>3.1.5 创建迁移脚本<a href=#315-创建迁移脚本 class=hash-link aria-label="Direct link to 3.1.5 创建迁移脚本" title="Direct link to 3.1.5 创建迁移脚本">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=3151-自动创建迁移文件>3.1.5.1 自动创建迁移文件<a href=#3151-自动创建迁移文件 class=hash-link aria-label="Direct link to 3.1.5.1 自动创建迁移文件" title="Direct link to 3.1.5.1 自动创建迁移文件">​</a></h5>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 创建新的迁移脚本</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">migrate create </span><span class="token parameter variable" style=color:#f8f8f2>-ext</span><span class="token plain"> sql </span><span class="token parameter variable" style=color:#f8f8f2>-dir</span><span class="token plain"> migrations/mysql </span><span class="token parameter variable" style=color:#f8f8f2>-seq</span><span class="token plain"> add_login_history_table</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这将创建两个文件：</p>
<ul>
<li><code>migrations/mysql/000003_add_login_history_table.up.sql</code> (升级脚本)</li>
<li><code>migrations/mysql/000003_add_login_history_table.down.sql</code> (回滚脚本)</li>
</ul>
<p>随后手动补充对应文件的SQL升级与回滚脚本内容。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=3152-手动创建迁移文件>3.1.5.2 手动创建迁移文件<a href=#3152-手动创建迁移文件 class=hash-link aria-label="Direct link to 3.1.5.2 手动创建迁移文件" title="Direct link to 3.1.5.2 手动创建迁移文件">​</a></h5>
<p>虽然<code>golang-migrate</code>提供了便捷的命令行工具来创建迁移文件，但也完全可以手动创建迁移文件。手动创建的步骤如下：</p>
<ol>
<li>确定版本号和命名规范（如<code>v0.1.0</code>或<code>000001</code>）</li>
<li>创建对应的<code>up</code>和<code>down</code>文件，命名符合规范</li>
<li>编写升级和回滚的SQL脚本</li>
</ol>
<blockquote>
<p>注意：无论选择哪种命名方式，重要的是在项目中保持一致性。<code>golang-migrate</code>工具会根据文件名前缀的字典序来确定执行顺序，因此命名规范必须能保证正确的执行顺序。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=316-编写迁移脚本>3.1.6 编写迁移脚本<a href=#316-编写迁移脚本 class=hash-link aria-label="Direct link to 3.1.6 编写迁移脚本" title="Direct link to 3.1.6 编写迁移脚本">​</a></h4>
<p>升级脚本 (<code>000003_add_login_history_table.up.sql</code>):</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> login_history </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    id </span><span class="token keyword" style=color:#66d9ef>BIGINT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>UNSIGNED</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>AUTO_INCREMENT</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    user_id </span><span class="token keyword" style=color:#66d9ef>BIGINT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>UNSIGNED</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'用户ID'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    login_time </span><span class="token keyword" style=color:#66d9ef>DATETIME</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'登录时间'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ip </span><span class="token keyword" style=color:#66d9ef>VARCHAR</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>50</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'登录IP'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    device </span><span class="token keyword" style=color:#66d9ef>VARCHAR</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>200</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'登录设备'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    created_at </span><span class="token keyword" style=color:#66d9ef>DATETIME</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DEFAULT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>CURRENT_TIMESTAMP</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>PRIMARY</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>KEY</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">id</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>INDEX</span><span class="token plain"> idx_user_id </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">user_id</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>INDEX</span><span class="token plain"> idx_login_time </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">login_time</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>ENGINE</span><span class="token operator" style=color:#66d9ef>=</span><span class="token keyword" style=color:#66d9ef>InnoDB</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DEFAULT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>CHARSET</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">utf8mb4 </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>'用户登录历史'</span><span class="token punctuation" style=color:#f8f8f2>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>回滚脚本 (<code>000003_add_login_history_table.down.sql</code>):</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>DROP</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>IF</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>EXISTS</span><span class="token plain"> login_history</span><span class="token punctuation" style=color:#f8f8f2>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=317-命令行使用方式>3.1.7 命令行使用方式<a href=#317-命令行使用方式 class=hash-link aria-label="Direct link to 3.1.7 命令行使用方式" title="Direct link to 3.1.7 命令行使用方式">​</a></h4>
<p><code>golang-migrate</code>提供了简洁易用的命令行工具，可以在任何项目中使用，不依赖于特定的编程语言或框架：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 创建新的迁移脚本</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">migrate create </span><span class="token parameter variable" style=color:#f8f8f2>-ext</span><span class="token plain"> sql </span><span class="token parameter variable" style=color:#f8f8f2>-dir</span><span class="token plain"> migrations/mysql </span><span class="token parameter variable" style=color:#f8f8f2>-seq</span><span class="token plain"> create_users_table</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 执行升级迁移</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">migrate </span><span class="token parameter variable" style=color:#f8f8f2>-path</span><span class="token plain"> migrations/mysql </span><span class="token parameter variable" style=color:#f8f8f2>-database</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"mysql://user:password@tcp(localhost:3306)/dbname?multiStatements=true"</span><span class="token plain"> up</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 回滚最近一次迁移</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">migrate </span><span class="token parameter variable" style=color:#f8f8f2>-path</span><span class="token plain"> migrations/mysql </span><span class="token parameter variable" style=color:#f8f8f2>-database</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"mysql://user:password@tcp(localhost:3306)/dbname?multiStatements=true"</span><span class="token plain"> down </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 回滚到特定版本</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">migrate </span><span class="token parameter variable" style=color:#f8f8f2>-path</span><span class="token plain"> migrations/mysql </span><span class="token parameter variable" style=color:#f8f8f2>-database</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"mysql://user:password@tcp(localhost:3306)/dbname?multiStatements=true"</span><span class="token plain"> goto </span><span class="token number" style=color:#ae81ff>20230101120000</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 强制设置版本（在迁移出错后使用）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">migrate </span><span class="token parameter variable" style=color:#f8f8f2>-path</span><span class="token plain"> migrations/mysql </span><span class="token parameter variable" style=color:#f8f8f2>-database</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"mysql://user:password@tcp(localhost:3306)/dbname?multiStatements=true"</span><span class="token plain"> force </span><span class="token number" style=color:#ae81ff>20230101120000</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 查看当前版本</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">migrate </span><span class="token parameter variable" style=color:#f8f8f2>-path</span><span class="token plain"> migrations/mysql </span><span class="token parameter variable" style=color:#f8f8f2>-database</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"mysql://user:password@tcp(localhost:3306)/dbname?multiStatements=true"</span><span class="token plain"> version</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<blockquote>
<p>更多的使用方式请参考<code>golang-migrate</code>项目官网。</p>
</blockquote>
<p>这种命令行方式的使用可以集成到任何项目的构建或部署脚本中，例如<code>Makefile</code>、<code>shell</code>脚本、<code>CI/CD</code>流程等。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=318-go项�目中的程序化使用>3.1.8 Go项目中的程序化使用<a href=#318-go项目中的程序化使用 class=hash-link aria-label="Direct link to 3.1.8 Go项目中的程序化使用" title="Direct link to 3.1.8 Go项目中的程序化使用">​</a></h4>
<p>对于<code>Go</code>语言项目，<code>golang-migrate</code>还提供了可以直接在代码中导入并使用的库，这使得可以在应用启动时自动执行迁移：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>package</span><span class="token plain"> main</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token string" style=color:#a6e22e>"fmt"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token string" style=color:#a6e22e>"log"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token string" style=color:#a6e22e>"github.com/golang-migrate/migrate/v4"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token comment" style=color:#8292a2;font-style:italic>// 导入需要的数据库驱动</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token boolean" style=color:#ae81ff>_</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"github.com/golang-migrate/migrate/v4/database/mysql"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token comment" style=color:#8292a2;font-style:italic>// 导入迁移文件源</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token boolean" style=color:#ae81ff>_</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"github.com/golang-migrate/migrate/v4/source/file"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>main</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token comment" style=color:#8292a2;font-style:italic>// 创建migrate实例</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	m</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> migrate</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token string" style=color:#a6e22e>"file://./migrations/mysql"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token string" style=color:#a6e22e>"mysql://user:password@tcp(localhost:3306)/dbname?multiStatements=true"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		log</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Fatalf</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"创建migrate实例失败: %v"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token comment" style=color:#8292a2;font-style:italic>// 执行所有升级迁移</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> m</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Up</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&&</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> migrate</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ErrNoChange </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		log</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Fatalf</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"执行迁移失败: %v"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token comment" style=color:#8292a2;font-style:italic>// 获取当前版本</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	version</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> dirty</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> m</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Version</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&&</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> migrate</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ErrNilVersion </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		log</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Fatalf</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"获取版本失败: %v"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	fmt</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Printf</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"当前数据库版本: %d, 是否处于脏状态: %t\n"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> version</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> dirty</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token comment" style=color:#8292a2;font-style:italic>// 应用的其他初始化代码...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这种方式的优点是可以将迁移与应用的生命周期绑定，确保应用启动时数据库结构总是最新的。但这种方式仅适用于<code>Go</code>项目，对于其他语言的项目，仍然需要使用命令行方式。</p>
<blockquote>
<p>注意：无论使用哪种方式，<code>golang-migrate</code>都保持了与语言和框架无关的特性。即使在<code>Go</code>项目中通过<code>import</code>方式使用，其迁移文件和版本管理机制仍然是通用的，可以被其他语言的项目或命令行工具使用。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=32-sql语句执行审核工具>3.2 SQL语句执行审核工具<a href=#32-sql语句执行审核工具 class=hash-link aria-label="Direct link to 3.2 SQL语句执行审核工具" title="Direct link to 3.2 SQL语句执行审核工具">​</a></h3>
<p>在生产环境的数据库变更管理中，代码开发者通常没有权限直接在生产环境执行SQL语句。这时需要依赖SQL提交、审核和执行工具，以规范化发布流程。这些工具可以与SQL迁移工具结合使用，形成完整的数据库变更管理流程。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=321-sql审核工具的必要性>3.2.1 SQL审核工具的必要性<a href=#321-sql审核工具的必要性 class=hash-link aria-label="Direct link to 3.2.1 SQL审核工具的必要性" title="Direct link to 3.2.1 SQL审核工具的必要性">​</a></h4>
<ol>
<li><strong>安全性</strong>：防止有风险的SQL语句被直接执行到生产环境</li>
<li><strong>规范性</strong>：强制执行团队的SQL编写规范，确保代码质量</li>
<li><strong>可审计性</strong>：记录所有SQL变更的审核人、执行人和执行时间</li>
<li><strong>权限分离</strong>：实现开发人员、审核人员和执行人员的职责分离</li>
<li><strong>性能优化</strong>：在执行前发现并优化低效SQL语句</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=322-常用的sql审核工具>3.2.2 常用的SQL审核工具<a href=#322-常用的sql审核工具 class=hash-link aria-label="Direct link to 3.2.2 常用的SQL审核工具" title="Direct link to 3.2.2 常用的SQL审核工具">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=3221-archery>3.2.2.1 Archery<a href=#3221-archery class=hash-link aria-label="Direct link to 3.2.2.1 Archery" title="Direct link to 3.2.2.1 Archery">​</a></h5>
<p><img decoding=async loading=lazy alt="alt text" src=/assets/images/image-2-cb07e11c253726314e975ba3fd1fb7c2.png width=2764 height=1378 class=img_ev3q></p>
<p><a href=https://github.com/hhyo/Archery target=_blank rel="noopener noreferrer">Archery</a> 是一款开源的SQL审核、SQL管理工具，由国内开发者维护，具有以下特点：</p>
<ul>
<li>支持多种数据库：MySQL、Oracle、SQLServer、PostgreSQL、MongoDB、Redis等</li>
<li>完善的SQL审核功能：支持使用Inception、SOAR、SQLAdvisor等多种审核引擎</li>
<li>工单流程：实现完整的提交-审核-执行流程</li>
<li>权限管理：细粒度的权限控制系统</li>
<li>数据库监控：集成了数据库实例、慢查询等监控功能</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=3222-bytebase>3.2.2.2 Bytebase<a href=#3222-bytebase class=hash-link aria-label="Direct link to 3.2.2.2 Bytebase" title="Direct link to 3.2.2.2 Bytebase">​</a></h5>
<p><img decoding=async loading=lazy alt="alt text" src=/assets/images/image-9b453e6d4c94f39059ad4bbca3c5f4f4.png width=2952 height=1356 class=img_ev3q></p>
<p><a href=https://github.com/bytebase/bytebase target=_blank rel="noopener noreferrer">Bytebase</a> 是一款现代化的数据库DevOps和变更管理工具，特点包括：</p>
<ul>
<li>直观的Web UI：提供类似GitHub的界面体验</li>
<li>GitOps集成：可以与Git仓库集成，实现数据库变更的版本控制</li>
<li>SQL审核：内置了多种SQL审核规则</li>
<li>环境管理：支持开发、测试、生产等多环境管理</li>
<li>可视化的数据库模式管理</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=3223-yearning>3.2.2.3 Yearning<a href=#3223-yearning class=hash-link aria-label="Direct link to 3.2.2.3 Yearning" title="Direct link to 3.2.2.3 Yearning">​</a></h5>
<p><img decoding=async loading=lazy alt="alt text" src=/assets/images/image-1-a702138bcc9c72e42467e3f8f88dc8a4.png width=3560 height=1750 class=img_ev3q></p>
<p><a href=https://github.com/cookieY/Yearning target=_blank rel="noopener noreferrer">Yearning</a> 是一款国产的MySQL审核平台，具有以下特点：</p>
<ul>
<li>轻量级：部署简单，资源消耗小</li>
<li>完善的审核流程：支持多人审核、审核意见等</li>
<li>内置审核规则：包含常见的SQL审核规则</li>
<li>权限管理：细粒度的权限控制</li>
<li>支持定时任务和批量执行</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=323-与sql迁移工具的集成>3.2.3 与SQL迁移工具的集成<a href=#323-与sql迁移工具的集成 class=hash-link aria-label="Direct link to 3.2.3 与SQL迁移工具的集成" title="Direct link to 3.2.3 与SQL迁移工具的集成">​</a></h4>
<p>将SQL审核工具与SQL迁移工具结合使用，可以实现完整的数据库变更管理流程：</p>
<ol>
<li>
<p><strong>开发阶段</strong>：开发人员使用SQL迁移工具（如<code>golang-migrate</code>）编写变更脚本</p>
</li>
<li>
<p><strong>代码审核</strong>：通过代码审核确保迁移脚本的质量</p>
</li>
<li>
<p><strong>提交审核</strong>：将迁移脚本提交到SQL审核平台（如<code>Archery</code>、<code>Bytebase</code>）</p>
</li>
<li>
<p><strong>自动审核</strong>：SQL审核平台自动检查SQL语句是否符合规范</p>
</li>
<li>
<p><strong>人工审核</strong>：DBA或高级开发人员审核变更</p>
</li>
<li>
<p><strong>执行变更</strong>：审核通过后，由授权人员执行变更</p>
</li>
<li>
<p><strong>记录与追踪</strong>：所有变更操作都被记录并可追踪</p>
</li>
</ol>
<p>这种集成方式结合了SQL迁移工具的版本控制能力和SQL审核工具的安全保障能力，特别适合严格的企业级生产环境。</p>
<p>无论选择哪种迁移工具，都需要遵循一系列最佳实践，以确保数据库变更的安全性、可靠性和可维护性。以下是我们总结的数据库迁移与版本管理的最佳实践建议。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=4-最佳实践建议>4. 最佳实践建议<a href=#4-最佳实践建议 class=hash-link aria-label="Direct link to 4. 最佳实践建议" title="Direct link to 4. 最佳实践建议">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=41-迁移脚本命名规范>4.1 迁移脚本命名规范<a href=#41-迁移脚本命名规范 class=hash-link aria-label="Direct link to 4.1 迁移脚本命名规范" title="Direct link to 4.1 迁移脚本命名规范">​</a></h3>
<ul>
<li>使用序列号前缀确保执行顺序</li>
<li>使用描述性名称说明变更内容</li>
<li>区分<code>up</code>(升级)和<code>down</code>(回滚)脚本</li>
<li>在团队中统一命名规范，确保一致性</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=42-迁移内容规范>4.2 迁移内容规范<a href=#42-迁移内容规范 class=hash-link aria-label="Direct link to 4.2 迁移内容规范" title="Direct link to 4.2 迁移内容规范">​</a></h3>
<ul>
<li>每个迁移应该是原子的，专注于一个变更</li>
<li>确保每个迁移都有对应的回滚脚本</li>
<li>避免在迁移中包含大量数据操作，数据迁移应与结构变更分开</li>
<li>对于大表的结构变更，考虑使用在线DDL工具</li>
<li>在迁移脚本中添加注释，说明变更的目的和影响</li>
<li>避免使用数据库特定的功能，以确保可移植性</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=43-环境管理>4.3 环境管理<a href=#43-环境管理 class=hash-link aria-label="Direct link to 4.3 环境管理" title="Direct link to 4.3 环境管理">​</a></h3>
<ul>
<li>开发环境可以频繁重置和重新迁移</li>
<li>测试环境应该模拟生产环境的迁移流程</li>
<li>生产环境迁移前必须备份数据库</li>
<li>考虑使用蓝绿部署或金丝雀发布策略进行生产环境迁移</li>
<li>建立环境特定的迁移配置，如开发、测试、预发布和生产环境</li>
<li>在生产环境执行迁移前，先在预发布环境进行完整测试</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=5-总结>5. 总结<a href=#5-总结 class=hash-link aria-label="Direct link to 5. 总结" title="Direct link to 5. 总结">​</a></h2>
<p>数据库迁移与版本管理是现代软件开发中不可或缺的一部分。通过采用合适的迁移策略和工具，可以显著提高团队协作效率，减少环境差异带来的问题，并支持持续集成和持续部署流程。</p>
<p>本文介绍了多种数据库迁移管理方法，从手动SQL脚本管理到专业的迁移工具，并重点推荐了<code>golang-migrate</code>工具作为一种与语言无关的通用解决方案。同时，我们也介绍了SQL审核工具在生产环境中的重要性，以及如何将它们与迁移工具结合使用。</p>
<p>对于使用<code>Go</code>语言的项目，推荐采用<code>golang-migrate</code>工具进行数据库迁移管理，它提供了强大的版本控制功能，支持升级和回滚操作，并且可以无缝集成到现有项目中。它的命令行工具和程序化API使其能够灵活地适应不同的项目需求和开发流程。</p>
<p>无论选择哪种迁移工具，关键是建立一套规范的流程和最佳实践，确保数据库变更可追踪、可重复、可靠，从而支持业务的快速迭代和发展。随着项目规模的增长和复杂性的提高，一个健全的数据库迁移策略将成为维持系统稳定性和可维护性的关键因素。</div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/hidden/goframe-v3><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>关于GoFrame V3版本的一些思考</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/hidden/ideas><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>一些想法</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#1-数据库迁移与版本管理的业务场景与必要性 class="table-of-contents__link toc-highlight">1. 数据库迁移与版本管理的业务场景与必要性</a><ul><li><a href=#11-常见业务场景 class="table-of-contents__link toc-highlight">1.1 常见业务场景</a><li><a href=#12-数据库迁移管理的必要性 class="table-of-contents__link toc-highlight">1.2 数据库迁移管理的必要性</a></ul><li><a href=#2-数据库迁移与版本管理的常见方式 class="table-of-contents__link toc-highlight">2. 数据库迁移与版本管理的常见方式</a><ul><li><a href=#21-手动执行sql脚本 class="table-of-contents__link toc-highlight">2.1 手动执行SQL脚本</a><li><a href=#22-基于版本号的sql脚本管理 class="table-of-contents__link toc-highlight">2.2 基于版本号的SQL脚本管理</a><li><a href=#23-orm框架内置的迁移功能 class="table-of-contents__link toc-highlight">2.3 ORM框架内置的迁移功能</a><li><a href=#24-专业数据库迁移工具 class="table-of-contents__link toc-highlight">2.4 专业数据库迁移工具</a></ul><li><a href=#3-推荐的数据库迁移与版本管理方式 class="table-of-contents__link toc-highlight">3. 推荐的数据库迁移与版本管理方式</a><ul><li><a href=#31-sql迁移版本管理工具 class="table-of-contents__link toc-highlight">3.1 SQL迁移版本管理工具</a><li><a href=#32-sql语句执行审核工具 class="table-of-contents__link toc-highlight">3.2 SQL语句执行审核工具</a></ul><li><a href=#4-最佳实践建议 class="table-of-contents__link toc-highlight">4. 最佳实践建议</a><ul><li><a href=#41-迁移脚本命名规范 class="table-of-contents__link toc-highlight">4.1 迁移脚本命名规范</a><li><a href=#42-迁移内容规范 class="table-of-contents__link toc-highlight">4.2 迁移内容规范</a><li><a href=#43-环境管理 class="table-of-contents__link toc-highlight">4.3 环境管理</a></ul><li><a href=#5-总结 class="table-of-contents__link toc-highlight">5. 总结</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>