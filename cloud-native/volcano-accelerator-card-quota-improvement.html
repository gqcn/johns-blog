<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/云原生/Volcano/Volcano扩展开发/Volcano调度器支持智算卡Quota改进方案" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Volcano调度器支持智算卡Quota改进方案 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/cloud-native/volcano-accelerator-card-quota-improvement><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=author content="John Guo"><meta data-rh=true property=og:image content=https://johng.cn/img/favicon.png><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Volcano调度器支持智算卡Quota改进方案 | John's Blog"><meta data-rh=true name=description content="详细介绍Volcano调度器支持智算卡配额管理的改进方案，包括卡维度配额设计、单实例多卡部署配额管控、capacity-card自定义插件实现、节点卡型号自动识别、调度器扩展点设计等核心内容。方案支持GPU、NPU等多种智算卡类型，支持MIG/MPS等GPU Share技术，实现了精确的卡型号级别配额控制，解决了Volcano原生配额管理无法区分不同卡型号的痛点。"><meta data-rh=true property=og:description content="详细介绍Volcano调度器支持智算卡配额管理的改进方案，包括卡维度配额设计、单实例多卡部署配额管控、capacity-card自定义插件实现、节点卡型号自动识别、调度器扩展点设计等核心内容。方案支持GPU、NPU等多种智算卡类型，支持MIG/MPS等GPU Share技术，实现了精确的卡型号级别配额控制，解决了Volcano原生配额管理无法区分不同卡型号的痛点。"><meta data-rh=true name=keywords content="Volcano,Kubernetes,智算卡配额,GPU配额管理,NPU配额管理,capacity-card插件,卡维度配额,单实例多卡,MIG子卡,MPS子卡,GPU Share,资源队列,Volcano Queue,调度器插件,云原生调度,异构计算,AI训练调度,推理服务调度,HPA自动伸缩,资源配额管控,volcano.sh/card.quota,volcano.sh/card.name,volcano.sh/card.request,JobEnqueueableFn,AllocatableFn,NodeOrderFn,EventHandler"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/cloud-native/volcano-accelerator-card-quota-improvement><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/volcano-accelerator-card-quota-improvement hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/volcano-accelerator-card-quota-improvement hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="John's Blog RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="John's Blog Atom Feed"><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><link rel=stylesheet href=/assets/css/styles.2f56d3c4.css><script src=/assets/js/runtime~main.082e8481.js defer></script><script src=/assets/js/main.00d67687.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" href=/ai>AI技术</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/cloud-native>云原生</a><a class="navbar__item navbar__link" href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/programming>开发语言</a><a class="navbar__item navbar__link" href=/architecture>技术架构</a><a class="navbar__item navbar__link" href=/observability>可观测性</a><a class="navbar__item navbar__link" href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" href=/life>生活笔记</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href=/aboutme>关于我</a><a class="navbar__item navbar__link" href=/blog>博客</a><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/cloud-native>云原生</a><button aria-label="Collapse sidebar category '云原生'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/container>Container</a><button aria-label="Expand sidebar category 'Container'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kubernetes>Kubernetes</a><button aria-label="Expand sidebar category 'Kubernetes'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/argo-workflow>Argo Workflow</a><button aria-label="Expand sidebar category 'Argo Workflow'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/cloud-native/volcano>Volcano</a><button aria-label="Collapse sidebar category 'Volcano'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/volcano-queue-job>Volcano Queue&Job</a><button aria-label="Expand sidebar category 'Volcano Queue&Job'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/volcano-actions-plugins>Volcano Actions&Plugins</a><button aria-label="Expand sidebar category 'Volcano Actions&Plugins'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/volcano-advanced-features>Volcano高级特性</a><button aria-label="Expand sidebar category 'Volcano高级特性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/cloud-native/volcano-extension-development>Volcano扩展开发</a><button aria-label="Collapse sidebar category 'Volcano扩展开发'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-session-plugins-fns>Volcano Session Plugins方法介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/cloud-native/volcano-accelerator-card-quota-improvement>Volcano调度器支持智算卡Quota改进方案</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-cross-queues-reclaim-design>Volcano跨队列资源抢占驱逐改进设计</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-cross-queues-reclaim-test>Volcano跨队列资源抢占驱逐测试</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/volcano-usage-notes>Volcano使用笔记</a><button aria-label="Expand sidebar category 'Volcano使用笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-introduction>Volcano基本介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-startup-parameters>Volcano启动参数</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-examples>Volcano使用示例</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-annotations>Volcano常用注解</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-scheduler-config>Volcano调度器配置</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kind>Kind</a><button aria-label="Expand sidebar category 'Kind'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/helm>Helm常用指令</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/dragonfly>Dragonfly介绍</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/life>生活笔记</a><button aria-label="Expand sidebar category '生活笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native><span itemprop=name>云原生</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native/volcano><span itemprop=name>Volcano</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native/volcano-extension-development><span itemprop=name>Volcano扩展开发</span></a><meta itemprop=position content=3><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Volcano调度器支持智算卡Quota改进方案</span><meta itemprop=position content=4></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=背景介绍>背景介绍<a href=#背景介绍 class=hash-link aria-label="Direct link to 背景介绍" title="Direct link to 背景介绍">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=�当前业务场景>当前业务场景<a href=#当前业务场景 class=hash-link aria-label="Direct link to 当前业务场景" title="Direct link to 当前业务场景">​</a></h3>
<ul>
<li><strong>底座及多卡类型</strong>：底座使用<code>K8S</code>，每个集群存在多种智算卡类型（例如<code>GPU</code>、<code>NPU</code>、<code>PPU</code>等）、卡型号（如<code>NVIDIA-H200</code>、<code>Ascend-910B</code>、<code>PPU-ZW810E</code>等）。</li>
<li><strong>存在<code>Share</code>资源</strong>：每个节点只有一种智算卡型号，但可能存在<code>Share</code>卡和整卡并存的情况，例如<code>GPU</code>和<code>MIG</code>子卡同存在一个节点（如节点上总共有<code>8</code>张<code>NVIDIA-H200</code>卡，其中有<code>7</code>张整卡，<code>1</code>张<code>Share</code>卡拆分为了<code>4</code>张<code>MIG</code>子卡：<code>1</code>张<code>3g.71gb</code>和<code>3</code>张<code>1g.18gb</code>子卡）。</li>
<li><strong>底层工作负载</strong>：离线训练任务使用<code>Volcano Job</code>的工作负载实现，在线推理服务使用<code>K8S</code>原生的<code>Deployment</code>工作负载实现。</li>
<li><strong>单实例多卡需求</strong>：由于卡资源较少，为尽可能利用好已有的卡资源，在离线的实例（<code>Pod</code>）需要单实例多卡型号部署支持。比如单实例部署时需要支持同时使用<code>NVIDIA GPU 4090</code>、<code>4090D</code>、<code>5090</code>的卡型号部署，哪种卡有资源就部署使用哪种卡。例如同一个离线训练的<code>Volcano Job</code>任务，可能部署使用到不同的卡型号（不考虑卡型号之间的性能差异）。</li>
<li><strong>底层触发的资源变化</strong>：在线服务需要支持<code>HPA</code>（自动伸缩），即在底层自动触发扩缩容，不依赖上层管控触发资源使用。因此智算资源的配额（<code>Quota</code>）管控应当能管控到底层由触发的租户资源变化：当租户的配额不够时，不能触发<code>HPA</code>扩容；当<code>HPA</code>缩容时，应当退还租户的配额量。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=当前技术实现>当前技术实现<a href=#当前技术实现 class=hash-link aria-label="Direct link to 当前技术实现" title="Direct link to 当前技术实现">​</a></h3>
<ul>
<li><strong>节点标签规范</strong>：当前智算资源的识别和管理依赖对节点标签的规范化打标，以下是几项重要的标签：<!-- -->
<ul>
<li><strong>智算卡名称</strong>，标签规则：<code>厂商域前缀/卡类型.product</code></li>
<li><strong>智算卡数量</strong>，标签规则：<code>厂商域前缀/卡类型.count</code></li>
<li><strong>智算卡内存</strong>，标签规则：<code>厂商域前缀/卡类型.memory</code></li>
</ul>
</li>
<li>在智算资源的配额管控中，除了上层业务服务层面来实现“软性”的配额管理逻辑实现以外，下层“硬性”的配额控制主要使用<code>Volcano</code>的<code>Volcano Queue</code>来实现。<!-- -->
<ul>
<li>“软性”配额管控：所有配额的管理由业务服务层来实现，并在发货和扩容时实现粗略的资源校验。目的是：<!-- -->
<ul>
<li><strong>提升产品交互体验</strong>：由于<code>K8S</code>底层资源管理都是异步的，上层<code>API</code>可以粗略地检查资源配额，提前反馈错误，便于用户修正操作。</li>
<li><strong>降低对调度器压力</strong>：租户配额不够时，上层可以拦截大量不满足资源配额条件的发货或扩容任务。</li>
</ul>
</li>
<li>“硬性”配额管控：真实的配额限制是由底层的基础组件来实现，从调度器层面实现资源的精确配额控制。</li>
</ul>
</li>
<li>但<code>Volcano Queue</code>针对智算卡的配额管理存在以下痛点：<!-- -->
<ul>
<li><strong>无法实现卡维度的配额管控</strong>：比如<code>H200</code>和<code>4090</code>的GPU卡，在<code>Volcano Queue</code>的配额管理中（使用<code>capacity</code>调度器插件）都是被当做相同的<code>nvidia.com/gpu</code>资源名称（<code>ResourceName</code>），无法实现精准的卡维度的配额管控。</li>
<li><strong>不支持单实例多卡部署的配额管控</strong>：当任务支持多卡部署时，真实使用哪种卡是由调度器在对实例（<code>Pod</code>）调度流程中选择绑定节点的时候决定的，因此业务服务层很难做管控。同时该需求偏定制化，需要独立开发实现。</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=改进方案>改进方案<a href=#改进方案 class=hash-link aria-label="Direct link to 改进方案" title="Direct link to 改进方案">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=核心目标>核心目标<a href=#核心目标 class=hash-link aria-label="Direct link to 核心目标" title="Direct link to 核心目标">​</a></h3>
<ul>
<li>实现卡维度的配额管控。</li>
<li>实现单实例多卡部署的配额管控。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=功能设计>功能设计<a href=#功能设计 class=hash-link aria-label="Direct link to 功能设计" title="Direct link to 功能设计">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=调度器背景知识>调度器背景知识<a href=#调度器背景知识 class=hash-link aria-label="Direct link to 调度器背景知识" title="Direct link to 调度器背景知识">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=调度器执行流程介绍>调度器执行流程介绍<a href=#调度器执行流程介绍 class=hash-link aria-label="Direct link to 调度器执行流程介绍" title="Direct link to 调度器执行流程介绍">​</a></h5>
<p><strong><code>Volcano</code>的任务创建流程</strong>：</p>
<!-- -->
<p><strong>调度器内部工作流程</strong>：
<img decoding=async loading=lazy alt="alt text" src=/assets/images/image-28fb38a35364dfdc1a4d24fc8f8baa00.png width=1256 height=503 class=img_ev3q></p>
<p>这张图来源<code>volcano</code>官网，展示了<code>volcano</code>调度器执行的工作流程。调度器中存在<code>action</code>和<code>plugin</code>两种类型的可插拔资源，<code>action</code>用于实现一些关键步骤，如任务入队（<code>enqueue</code>）、资源分配（<code>allocate</code>）、抢占（<code>preempt</code>）、回收（<code>reclaim</code>）等；但是<code>action</code>的具体实现是依赖<code>plugin</code>注册的扩展点函数。<code>plugin</code>资源定义了具体的功能特性实现，用于在各个<code>action</code>步骤来实现具体的业务逻辑。</p>
<p><code>Volcano Scheduler</code>的工作的大致流程如下：</p>
<ol>
<li>客户端提交的<code>Job</code>被调度器识别到并缓存起来。</li>
<li>周期性开启会话（<code>Session</code>），一个调度周期开始。</li>
<li>将没有被调度的<code>Job</code>发送到会话的待调度队列中。</li>
<li>遍历所有的待调度<code>Job</code>，按照定义的次序依次执行<code>enqueue</code>、<code>allocate</code>、<code>preempt</code>、<code>reclaim</code>、<code>backfill</code>等动作，为每个<code>Job</code>找到一个最合适的节点。将该<code>Job</code>绑定到这个节点。<code>action</code>中执行的具体算法逻辑取决于注册的<code>plugin</code>中各函数的实现。</li>
<li>关闭本次会话。</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=调度器实现精确的额度管控原理>调度器实现精确的额度管控原理<a href=#调度器实现精确的额度管控原理 class=hash-link aria-label="Direct link to 调度器实现精确的额度管控原理" title="Direct link to 调度器实现精确的额度管控原理">​</a></h5>
<ul>
<li><strong>单实例串行执行</strong>：调度器是单实例运行的，所有的集群资源量、资源配额量、已调度和待调度资源量都是在自身内存中计算好后，再串行执行调度、资源更新，不会存在并发调度问题，以保证资源计算和调度的准确性。在<code>Volcano</code>调度器中，同时只会存在一个<code>Session</code>在执行，<code>Session</code>中的所有操作都是串行的，包括其中的<code>EventHandler</code>的调用。</li>
<li><strong>多副本选主控制</strong>：即便调度器存在多个副本实例（<code>Pod</code>），仍然会通过选主方式（通过<code>etcd</code>租约）确定只有其中一个实例负责调度逻辑。其他副本会持续监听是否主下线（判断<code>etcd</code>租约过期），下线后会重新出现新的主节点接替原有的调度职责。</li>
<li><strong>执行逻辑简单</strong>：调度器只负责资源调度，执行逻辑相对简单，因此单实例能够高效支持大量的任务调度。同样，在我们扩展调度器功能时，也不应当执行太复杂的逻辑，尽可能保持逻辑的精炼、算法的高效。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=卡维度配额设计>卡维度配额设计<a href=#卡维度配额设计 class=hash-link aria-label="Direct link to 卡维度配额设计" title="Direct link to 卡维度配额设计">​</a></h4>
<p>先从使用的角度看看如何来进行卡维度的额度配置。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=队列设计>队列设计<a href=#队列设计 class=hash-link aria-label="Direct link to 队列设计" title="Direct link to 队列设计">​</a></h5>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=队列卡配额配置示例>队列卡配额配置示例<a href=#队列卡配额配置示例 class=hash-link aria-label="Direct link to 队列卡配额配置示例" title="Direct link to 队列卡配额配置示例">​</a></h6>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> scheduling.volcano.sh/v1beta1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Queue</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> cr</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">queue1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">volcano.sh/card.quota</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'{"NVIDIA-H200":3,"NVIDIA-H800":2,"NVIDIA-GeForce-RTX-4090":2,"NVIDIA-H800/mps-80g*1/2":2,"NVIDIA-H200/mig-1g.18gb-mixed":3,"NVIDIA-H200/mig-3g.71gb-mixed":1}'</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">weight</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">capability</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>4</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 4Gi</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>在以上的<code>cr-queue1</code>队列中，除了指定了常规的<code>CPU</code>和<code>Memory</code>的配额外，通过新增的<code>volcano.sh/card.quota</code>的注解指定队列的卡型号额度如下：</p>
<table><thead><tr><th>卡型号<th>额度（张）<th>备注<tbody><tr><td><code>NVIDIA-H200</code><td><code>3</code><td>主卡<tr><td><code>NVIDIA-H800</code><td><code>2</code><td>主卡<tr><td><code>NVIDIA-GeForce-RTX-4090</code><td><code>2</code><td>主卡<tr><td><code>NVIDIA-H800/mps-80g*1/2</code><td><code>2</code><td><code>MPS</code>子卡<tr><td><code>NVIDIA-H200/mig-1g.18gb-mixed</code><td><code>3</code><td><code>MIG</code>子卡<tr><td><code>NVIDIA-H200/mig-3g.71gb-mixed</code><td><code>1</code><td><code>MIG</code>子卡</table>
<p>同时需要注意：</p>
<ul>
<li>只有队列配置了具体的卡名称配额才能使用该卡资源，没有配置则无法使用该卡资源。</li>
<li>不再使用<code>guarantee</code>配置项，底层资源队列不再做资源预留设置，资源的预留依靠上层业务系统划分配额时控制<code>capability</code>即可。</li>
<li><code>CPU&Memory</code>在配置后会按照该配置量进行配额限制，没有配置时默认为<code>0</code>，表示没有任何配额，任务使用该队列时将会无法申请<code>CPU&Memory</code>资源。</li>
</ul>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=为什么不使用capabilitydeserved和guarantee配置卡额度>为什么不使用capability、deserved和guarantee配置卡额度<a href=#为什么不使用capabilitydeserved和guarantee配置卡额度 class=hash-link aria-label="Direct link to 为什么不使用capability、deserved和guarantee配置卡额度" title="Direct link to 为什么不使用capability、deserved和guarantee配置卡额度">​</a></h6>
<p>为什么通过新增注解的形式配置卡型号配额，而不是使用队列已有的<code>capability</code>、<code>deserved</code>和<code>guarantee</code>配置方式？</p>
<ul>
<li><code>Vocalno</code>原本的资源配额是通过<code>capability</code>、<code>deserved</code>和<code>guarantee</code>配置来实现的，并且这些配置项都是使用节点的资源名称作为键名，配额值作为键值。</li>
<li>而我们的卡型号并不是资源名称（拿<code>NVIDIA-H200</code>举例，它的资源名称实际为<code>nvidia.com/gpu</code>），考虑到如果将卡型号名称作为资源名称注入到这几个配置属性中，可能会引起其他<code>Volcano</code>插件（或者后续其他插件）的兼容性问题。因此，我们这里使用了“旁路”的方式，通过注解来配置队列的卡型号配额。</li>
<li>其他常规的资源名称，如<code>CPU</code>和<code>Memory</code>资源配额，仍然只用<code>Volcano</code>默认的配置属性来管理。</li>
</ul>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=为什么只配置卡名称不需要配置nvidiacomgpu的资源配额>为什么只配置卡名称，不需要配置nvidia.com/gpu的资源配额<a href=#为什么只配置卡名称不需要配置nvidiacomgpu的资源配额 class=hash-link aria-label="Direct link to 为什么只配置卡名称，不需要配置nvidia.com/gpu的资源配额" title="Direct link to 为什么只配置卡名称，不需要配置nvidia.com/gpu的资源配额">​</a></h6>
<p>原因如下：</p>
<ul>
<li>原因1：为了简化卡的管理复杂度。如果需要通过注解方式配置卡配额，同时还要配置<code>capability</code>、<code>deserved</code>或<code>guarantee</code>中的对应卡资源名称，配置管理太复杂了。</li>
<li>原因2：避免注解方式配置的配额数量与<code>capability</code>等配置项中的数量不一致。</li>
</ul>
<p>在调度器内部进行额度计算的时候，会通过<code>Pod</code>注解结合<code>resources.limits</code>读取到使用的卡名称对应的数量，和关联队列对应卡名称剩余的额度数量进行比较即可。</p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=使用卡的pod不限制cpumemory资源>使用卡的Pod不限制CPU&Memory资源<a href=#使用卡的pod不限制cpumemory资源 class=hash-link aria-label="Direct link to 使用卡的Pod不限制CPU&Memory资源" title="Direct link to 使用卡的Pod不限制CPU&Memory资源">​</a></h6>
<p><code>Pod</code>在使用卡资源时，可以对<code>CPU</code>&<code>Memory</code>资源的配额不做限制。这是一个偏业务定制化的特性，该特性主要解决业务的痛点背景如下：</p>
<ul>
<li>业务上分为智算卡任务和<code>CPU</code>类型任务，两种任务使用不同的节点执行：智算卡节点和<code>CPU</code>节点。</li>
<li>智算卡任务的资源瓶颈主要在智算卡资源而不是<code>CPU</code>/<code>Memory</code>，且这两种资源十分空余；但<code>CPU</code>任务的瓶颈在<code>CPU</code>/<code>Memory</code>，<code>CPU</code>节点的资源量少，资源使用紧张。</li>
<li>因此业务上需要对<code>CPU</code>的任务限制<code>CPU</code>&<code>Memory</code>，但智算卡任务不需要对<code>CPU</code>&<code>Memory</code>做限制，两种任务类型的配额管理需要区分。</li>
</ul>
<p>为了使用同一个队列而不是多个队列来实现这一业务需求，我们增加注解特性开关来实现，以减少队列数量提高可运维性。由于该特性开关比较偏全局配置，因此放到插件的配置中来维护，插件的配置示例如下：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">actions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"enqueue, allocate, backfill"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">tiers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">plugins</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> priority</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> gang</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">enablePreemptable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>false</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> conformance</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">plugins</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> drf</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">enablePreemptable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>false</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> predicates</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> capacity</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">card</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># Pod在使用卡资源时，可以对CPU&Memory资源的配额不做限制</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">arguments</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">cardUnlimitedCpuMemory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nodeorder</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> binpack</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=任务示例>任务示例<a href=#任务示例 class=hash-link aria-label="Direct link to 任务示例" title="Direct link to 任务示例">​</a></h5>
<p>在部署任务中增加了以下两项注解内容：</p>
<ul>
<li>
<p><code>volcano.sh/card.request</code>：（仅针对<code>Volcano Job</code>离线任务，可选）当前任务总请求的卡型号资源数量。用于资源预检查提前防止任务进入<code>Inqueue</code>状态，避免调度器创建过多<code>Pending</code>的<code>Pod</code>。如果已经创建出<code>Pod</code>，则以<code>Pod</code>实际申请的资源为准，例如自动扩缩容(<code>HPA</code>)场景，那么调度器会忽略该注解配置，而是使用<code>Pod</code>计算出的智算卡数量。</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 任务的注解，总共需要多少张卡，则配置多少数值</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">volcano.sh/card.request</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'{"NVIDIA-H200":2}'</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
<li>
<p><code>volcano.sh/card.name</code>：指定任务中具体实例使用的卡型号名称，调度器会使用该注解的卡型号，结合队列的配额进行额度管控。</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 具体实例使用的卡型号名称</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">volcano.sh/card.name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">H200</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
</ul>
<p>注解名称使用<code>volcano.sh</code>作为前缀的目的：</p>
<ul>
<li><code>Volcano Controller</code>会将所有<code>Job/ReplicaSet</code>等工作负载中<code>volcano.sh</code>开头的注解传播到<code>PodGroup</code>中，方便调度器使用。这应当是<code>Volcano</code>预留的能力，这样我们可以避免去修改<code>Controller</code>逻辑，只需要专注<code>Scheduler</code>实现即可，也能够避免对<code>Volcano</code>调度器已有逻辑源码的侵入。</li>
<li>尽可能避免定制化的内容，使得该特性后续能够贡献到社区。</li>
</ul>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=离线训练任务示例>离线训练任务示例<a href=#离线训练任务示例 class=hash-link aria-label="Direct link to 离线训练任务示例" title="Direct link to 离线训练任务示例">​</a></h6>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> batch.volcano.sh/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Job</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> cr</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">job</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">volcano.sh/card.request</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'{"NVIDIA-H200":2}'</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">minAvailable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">schedulerName</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> volcano</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">queue</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> cr</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">queue1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">policies</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">action</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> CompleteJob</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">event</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> TaskCompleted</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">tasks</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> master</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">volcano.sh/card.name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">H200</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">affinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">nodeAffinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia.com/gpu.product</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">H200</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Never</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=在线推理服务示例>在线推理服务示例<a href=#在线推理服务示例 class=hash-link aria-label="Direct link to 在线推理服务示例" title="Direct link to 在线推理服务示例">​</a></h6>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> apps/v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Deployment</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> cr</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">deployment</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nginx</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nginx</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">volcano.sh/card.name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">H200</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">scheduling.volcano.sh/queue-name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cr-queue1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">affinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">nodeAffinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia.com/gpu.product</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">H200</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">schedulerName</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> volcano</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">..</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=单实例多卡配额设计>单实例多卡配额设计<a href=#单实例多卡配额设计 class=hash-link aria-label="Direct link to 单实例多卡配额设计" title="Direct link to 单实例多卡配额设计">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=注解配置>注解配置<a href=#注解配置 class=hash-link aria-label="Direct link to 注解配置" title="Direct link to 注解配置">​</a></h5>
<p>针对单实例多卡部署的使用，只需要将注解中的<code>volcano.sh/card.request</code>和<code>volcano.sh/card.name</code>键值改为多卡配置即可。</p>
<p>以下是<code>volcano.sh/card.request</code>注解配置示例，表示该任务使用<code>NVIDIA-GeForce-RTX-4090</code>或者<code>NVIDIA-GeForce-RTX-4090-D</code>卡型号，总共需要<code>2</code>张：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 任务的注解，总共需要多少张卡，则配置多少数值</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">volcano.sh/card.request</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'{"NVIDIA-GeForce-RTX-4090|NVIDIA-GeForce-RTX-4090-D":2}'</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>以下是<code>volcano.sh/card.card</code>注解配置示例，表示该<code>Pod</code>使用<code>NVIDIA-GeForce-RTX-4090</code>或者<code>NVIDIA-GeForce-RTX-4090-D</code>卡型号：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 具体实例使用的卡型号名称</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">volcano.sh/card.card</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'NVIDIA-GeForce-RTX-4090|NVIDIA-GeForce-RTX-4090-D'</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=不同资源类型的多卡组合>不同资源类型的多卡组合<a href=#不同资源类型的多卡组合 class=hash-link aria-label="Direct link to 不同资源类型的多卡组合" title="Direct link to 不同资源类型的多卡组合">​</a></h5>
<p>不同资源类型的卡组合是指在单实例多卡组合中，每种不同的卡对应的资源类型不同，比如：</p>
<ul>
<li><strong>整卡和<code>GPU Share</code>卡组合</strong>，如：<code>NVIDIA-GeForce-RTX-4090|NVIDIA-H20/mig-1g.24gb-mixed</code>。</li>
<li><strong>不同<code>GPU Share</code>卡的组合</strong>，如：<code>NVIDIA-H20/mig-1g.24gb-mixed|NVIDIA-H20/mig-1g.37gb-mixed</code>。</li>
<li><strong>不同卡类型的组合</strong>，如：<code>NVIDIA-H200|Ascend-910B</code>。</li>
</ul>
<p>例如<code>NVIDIA-GeForce-RTX-4090|NVIDIA-H20/mig-1g.24gb-mixed</code>，其中<code>NVIDIA-GeForce-RTX-4090</code>卡的资源类型为<code>nvidia.com/gpu</code>，<code>NVIDIA-H20/mig-1g.24gb-mixed</code>卡的资源类型为<code>nvidia.com/mig-1g.24gb</code>。</p>
<p><strong>调度器不支持这种不同资源类型的多卡组合</strong>，原因如下：</p>
<ul>
<li>
<p><strong>由于资源名称不同</strong>，拿<code>NVIDIA-GeForce-RTX-4090|NVIDIA-H20/mig-1g.24gb-mixed</code>二选一举例，在部署任务时需要在<code>resources.requests&limits</code>中增加两种资源名称：</p>
<ul>
<li><code>nvidia.com/gpu: 1</code></li>
<li><code>nvidia.com/mig-1g.24gb: 1</code></li>
</ul>
<p>调度器虽然能够根据单实例多卡的逻辑将<code>Pod</code>调度到合适的节点上，但是由于涉及多种卡资源名称，<code>NVIDIA GPU DevicePlugin</code>会为该<code>Pod</code>分配两种资源，并不能实现二选一的请求（在调度器中删除<code>Pod</code>的<code>resources</code>资源配置也不是一个优雅的方式）。并且，不同的智算卡的<code>DevicePlugin</code>，其表现行为也可能会不同。</p>
</li>
<li>
<p><strong>如果资源名称相同</strong>，拿<code>NVIDIA-GeForce-RTX-4090|NVIDIA-GeForce-RTX-4090-D</code>二选一举例，在部署任务时需要在<code>resources.requests&limits</code>中增加一种资源名称：</p>
<ul>
<li><code>nvidia.com/gpu: 1</code></li>
</ul>
<p>调度器能够根据单实例多卡的逻辑将<code>Pod</code>调度到合适的节点上，并且只有一种卡资源名称，<code>NVIDIA GPU DevicePlugin</code>会为该<code>Pod</code>分配一种资源，能够实现二选一的请求。</p>
</li>
</ul>
<p>如果有这种业务场景，解决方案是在上层业务系统中根据每种卡的配额情况将多卡组合自行转换为单卡再执行部署。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=任务示例-1>任务示例<a href=#任务示例-1 class=hash-link aria-label="Direct link to 任务示例" title="Direct link to 任务示例">​</a></h5>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=离线训练任务示例-1>离线训练任务示例<a href=#离线训练任务示例-1 class=hash-link aria-label="Direct link to 离线训练任务示例" title="Direct link to 离线训练任务示例">​</a></h6>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> batch.volcano.sh/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Job</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> cr</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">job</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">volcano.sh/card.request</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'{"NVIDIA-GeForce-RTX-4090|NVIDIA-GeForce-RTX-4090-D":2}'</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">minAvailable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">schedulerName</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> volcano</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">queue</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> cr</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">queue1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">policies</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">action</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> CompleteJob</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">event</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> TaskCompleted</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">tasks</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> master</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">volcano.sh/card.name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">GeForce</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">RTX</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">4090</span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token plain">NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">GeForce</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">RTX</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">4090</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">D</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">affinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">nodeAffinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia.com/gpu.product</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> H200</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Never</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=在线推理服务示例-1>在线推理服务示例<a href=#在线推理服务示例-1 class=hash-link aria-label="Direct link to 在线推理服务示例" title="Direct link to 在线推理服务示例">​</a></h6>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> apps/v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Deployment</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> cr</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">deployment</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nginx</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nginx</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">volcano.sh/card.name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">GeForce</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">RTX</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">4090</span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token plain">NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">GeForce</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">RTX</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">4090</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">D</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">scheduling.volcano.sh/queue-name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cr-queue1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">affinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">nodeAffinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia.com/gpu.product</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">H200</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">schedulerName</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> volcano</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">..</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=调度器插件扩展设计>调度器插件扩展设计<a href=#调度器插件扩展设计 class=hash-link aria-label="Direct link to 调度器插件扩展设计" title="Direct link to 调度器插件扩展设计">​</a></h4>
<p><code>Volcano</code>提供了很强大的插件扩展机制，考虑到后续和社区的<code>Volcano</code>源码升级融合（或者反哺贡献社区），我们使用了独立的插件来实现卡维度和单实例多卡的额度管控能力。这样可以实现热插拔能力，对<code>Volcano</code>调度器源码没有侵入性和影响，可以通过配置的方式即可启用/卸载该插件。
我们的插件名称使用<code>capacity-card</code>，插件整体的实现可以参考官方的<code>capacity</code>插件。以下为<code>demo</code>验证代码的代码结构示例，可以看到，通过独立插件的设计对于<code>Volcano</code>社区源码几乎没有侵入性，完全可热插拔。</p>
<p><img decoding=async loading=lazy alt="Volcano 调度器插件扩展设计" src=/assets/images/image-1-aa7fd279581d9b77664f4daea831444f.png width=1224 height=1280 class=img_ev3q></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=额度资源对象>额度资源对象<a href=#额度资源对象 class=hash-link aria-label="Direct link to 额度资源对象" title="Direct link to 额度资源对象">​</a></h5>
<p>在插件的<code>Quota</code>管控实现中，需要使用到一些关键的额度资源对象来维护特定类型的资源额度，便于运行时高效计算队列的额度是否足以运行指定任务，如下：</p>
<table><thead><tr><th>资源对象<th>所属对象<th>用途<tbody><tr><td><code>totalResource</code><td><code>Plugin</code><td>集群总共资源量，包含所有卡资源量。卡资源量来源于所有节点的规范化标签和<code>node.Status.Allocatable</code>计算结果。<tr><td><code>totalGuarantee</code><td><code>Plugin</code><td>所有队列预留资源总和，队列的预留资源来源于<code>guarantee</code>配置，以及卡配额的<code>volcano.sh/card.quota</code>注解配置。该资源对象结合<code>totalResource</code>资源对象可以计算出集群的弹性资源量。<tr><td><code>capability</code><td><code>Queue</code><td>队列的资源配额上限，超过该对象中资源申请无法通过调度。队列的资源上限来源于队列的<code>capability</code>配置，以及卡配额的<code>volcano.sh/card.quota</code>注解配置。<tr><td><code>guarantee</code><td><code>Queue</code><td>队列的资源配额预留，集群为该队列保证的资源量。队列的预留资源来源于队列的<code>guarantee</code>配置，以及卡配额的<code>volcano.sh/card.quota</code>注解配置。<tr><td><code>request</code><td><code>Queue</code><td>队列中已请求的资源量：队列中所有<code>Pod</code>申请量总和（包含<code>Pending</code>状态的<code>Pod</code>）。<tr><td><code>inqueue</code><td><code>Queue</code><td>队列中排队中的资源量：<code>PodGroup</code>处于<code>Inqueue</code>状态的资源量。<tr><td><code>allocated</code><td><code>Queue</code><td>队列中已分配的资源量：队列中所有<code>Bound</code>、<code>Binding</code>、<code>Running</code>、<code>Allocated</code>状态的<code>Pod</code>申请量总和。<tr><td><code>elastic</code><td><code>Queue</code><td>队列中的弹性资源量：已分配的资源量（<code>allocated</code>）- 队列中任务最小可运行所需的资源量（比如<code>Job</code>中的<code>minAvailable</code>配置）。该弹性资源量可被<code>Pod</code>调度时使用（可入队，创建出<code>Pending</code>状态的<code>Pod</code>），但在集群资源紧张时，使用的弹性资源的低优先级任务会被其他高优先级任务抢占。</table>
<p>以下为<code>demo</code>验证代码片段截图示例：</p>
<p><img decoding=async loading=lazy alt=调度器插件扩展设计-额度资源对象 src=/assets/images/image-2-5e397b8753081f724bfd57d1690531e7.png width=1280 height=399 class=img_ev3q></p>
<p><img decoding=async loading=lazy alt=调度器插件扩展设计-额度资源对象 src=/assets/images/image-3-9935eae48f8b7fd0726c23a546760cd2.png width=1280 height=400 class=img_ev3q></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=资源对象初始化>资源对象初始化<a href=#资源对象初始化 class=hash-link aria-label="Direct link to 资源对象初始化" title="Direct link to 资源对象初始化">​</a></h5>
<p>由于<code>Volcano</code>是通过<code>Session</code>机制间隔触发实现调度，因此每一次<code>Session</code>的开启和关闭都会涉及到对以下资源的重新计算和释放：</p>
<ul>
<li><strong>集群总资源量</strong>：前面资源对象表格中的<code>Plugin</code>维度的资源计算，资源量来源于集群所有节点资源、队列所有配置。</li>
<li><strong>各个队列资源</strong>：前面对象对象表格中的<code>Queue</code>维度的资源计算，资源量来源于所有<code>Pod</code>的资源量。</li>
</ul>
<p>由于资源初始化计算需要遍历所有的节点、队列和<code>Pod</code>资源，是整合插件实现中资源开销最大的部分，因此该阶段需要尽可能避免过多的内存分配，避免过多的循环计算，提高算法性能。
同时需要注意：</p>
<ul>
<li><strong>部分属性内存获取延迟</strong>：节点列表不能使用<code>Session</code>对象中提供的<code>Nodes</code>数组，而是需要从<code>Informer</code>的<code>Nodes Lister</code>中单独获取。虽然<code>Session</code>流程中的各个方法是串行执行的，<code>Informer</code>也有<code>WaitSynced</code>机制，但<code>Session</code>中的<code>Nodes</code>数组是通过<code>Informer</code>事件异步更新的，在<code>Session</code>第一次执行的时候，有可能<code>Session</code>中的<code>Nodes</code>数据还没有同步，造成<code>Nodes</code>数据不完整，引起资源初始化数据的不正确。</li>
<li><strong>调度器对执行效率敏感</strong>：调度器对效率要求较高，在进行插件开发时，不要对外部服务产生调用依赖。例如，在调度器逻辑中，尽量避免直接去调用<code>APIServer</code>，而是尽可能使用<code>Informer</code>机制从本地内存获取相关数据。考虑到<code>Informer</code>会有数据延迟，在设计功能时需要考虑到数据延迟性对功能的影响。</li>
<li><strong>注意卡资源计算单位</strong>：在<code>Volcano</code>的资源管理中，除了<code>CPU</code>和<code>Memory</code>资源，其他都是<code>Scalar</code>资源，这些资源的默认单位都是<code>MilliValue</code>，即原有的数值乘以<code>1000</code>。例如卡资源量是<code>5</code>张卡，那么在<code>Scalar</code>资源中会显示为<code>5000</code>的数值。该数值会在平时开发、查看日志、<code>Event</code>时有展示，需要注意自行做转换识别。</li>
<li><strong>忽略非智算卡Scalar资源</strong>：<code>Scalar</code>可能包括其它设备资源，如<code>IB</code>设备的资源，该插件只关注 <code>CPU</code>、<code>Memory</code>、智算卡资源，对于其它资源不限制。因此在资源初始化和后续计算中忽略非智算卡<code>Scalar</code>资源，只计算 <code>CPU</code>、<code>Memory</code>、智算卡资源。</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=节点卡型号自动识别>节点卡型号自动识别<a href=#节点卡型号自动识别 class=hash-link aria-label="Direct link to 节点卡型号自动识别" title="Direct link to 节点卡型号自动识别">​</a></h5>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=卡型号命名规范>卡型号命名规范<a href=#卡型号命名规范 class=hash-link aria-label="Direct link to 卡型号命名规范" title="Direct link to 卡型号命名规范">​</a></h6>
<p>由于是使用智算卡的名称而不是资源名称来实现额度管控，为了保证管控服务分配的卡型号资源名称和调度器从节点识别到的卡型号资源名称一致，需要制定命名规范：</p>
<ul>
<li><strong>节点标签的规范</strong>：每个节点只能存在一种智算卡（但可能同时存在整卡和<code>Share</code>的情况），为了方便识别智算卡名称、数量及显存大小，因此制定了具体的节点标签规范，这是我们能够对智算卡进行管理的基础：<!-- -->
<ul>
<li><strong>智算卡名称</strong>，标签规则：<code>厂商域前缀/卡类型.product</code></li>
<li><strong>智算卡数量</strong>，标签规则：<code>厂商域前缀/卡类型.count</code></li>
<li><strong>智算卡内存</strong>，标签规则：<code>厂商域前缀/卡类型.memory</code></li>
</ul>
</li>
<li><strong>GPU Share卡的命名规范</strong>：<!-- -->
<ul>
<li><strong>MPS</strong>：<code>%s/mps-%dg*1/%d</code>，其中：<!-- -->
<ul>
<li>第一个<code>%s</code>为整卡型号名称，例如<code>NIVIDIA-H20</code>。</li>
<li>第一个<code>%d</code>为整卡的显存大小（单位<code>Gi</code>），例如<code>90</code>。</li>
<li>第二个<code>%d</code>为每张整卡拆分的子卡数量，无论该节点拆分多少张整卡，这里都是一个数值，例如<code>2</code>。</li>
<li>最终子卡的名称示例：<code>NIVIDIA-H20/mps-90g*1/2</code></li>
</ul>
</li>
<li><strong>MIG</strong>：<code>%s/mig-%s-mixed</code>，其中：<!-- -->
<ul>
<li>第一个<code>%s</code>为整卡型号名称，例如<code>NIVIDIA-H20</code>。</li>
<li>第二个<code>%s</code>为MIG的规格名称，例如<code>1g.12gb</code>。</li>
<li>统一<code>MIG</code>的拆分策略为<code>mixed</code>，表示每张整卡可以由不同的拆分策略。</li>
<li>最终子卡的名称示例：<code>NIVIDIA-H20/mig-1g.12gb-mixed</code></li>
</ul>
</li>
</ul>
</li>
<li><strong>其他Share卡命名规范</strong>：通过标签形式制定，具体规则等未来有需要再确定，预留该扩展空间。</li>
</ul>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=如何识别整卡信息>如何识别整卡信息<a href=#如何识别整卡信息 class=hash-link aria-label="Direct link to 如何识别整卡信息" title="Direct link to 如何识别整卡信息">​</a></h6>
<ul>
<li>遍历每个节点的节点标签，找到符合智算卡节点标签命名规范的标签内容，标签示例：<!-- -->
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">nvidia.com/gpu.product</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NIVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">H20</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.count</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>8</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>97871</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
<li>识别符合<code>厂商域前缀/卡类型.product</code>和<code>厂商域前缀/卡类型.memory</code>两项命名规范的的标签（例如通过正则匹配），如果存在则可以获得<code>厂商域前缀</code>及<code>卡类型</code>，例如<code>nvidia.com</code>及<code>gpu</code>。</li>
<li>因此可以获得智算卡名称、智算卡显存，进而可以获得智算卡数量。例如<code>NIVIDIA-H20</code>、<code>97871</code>、<code>8</code>。</li>
</ul>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=如何获取gpu-share子卡信息及资源量>如何获取GPU Share子卡信息及资源量<a href=#如何获取gpu-share子卡信息及资源量 class=hash-link aria-label="Direct link to 如何获取GPU Share子卡信息及资源量" title="Direct link to 如何获取GPU Share子卡信息及资源量">​</a></h6>
<ul>
<li>
<p>前面获取到了节点的整卡信息，我们继续遍历节点的<code>Status.Allocatable</code>字段，获取资源信息。</p>
</li>
<li>
<p><strong><code>MPS</code>子卡信息识别</strong>：</p>
<ul>
<li>由于<code>MPS</code>的资源名称是固定的<code>nvidia.com/gpu.shared</code>，通过该名称判断<code>Status.Allocatable</code>中是否存在<code>MPS</code>子卡资源，如果存在，该资源值则是<code>MPS</code>子卡的资源量（例如<code>8</code>）。</li>
<li>获取节点的<code>nvidia.com/gpu.replicas</code>标签内容，该标签内容则是<code>MPS</code>的单卡拆分的副本数（例如<code>2</code>）。</li>
<li>根据<code>GPU Share MPS</code>子卡的命名规范<code>%s/mps-%dg*1/%d</code>可以获取到<code>MPS</code>子卡的名称，例如<code>NIVIDIA-H20/mps-90g*1/2</code>。</li>
</ul>
</li>
<li>
<p><strong><code>MIG</code>子卡信息识别</strong>：</p>
<ul>
<li>MIG的节点包含了带有<code>nvidia.com/mig-</code>前缀的标签和资源名称，并且我们需要统一使用<code>mixed</code>子卡拆分策略。</li>
<li>去掉<code>nvidia.com/mig-</code>前缀的资源名称（例如<code>nvidia.com/mig-1g.12gb</code>）则是<code>MIG</code>的规格名称（例如<code>1g.12gb</code>），那么该资源值则是<code>MIG</code>子卡的资源量（例如<code>2</code>）。</li>
<li>根据<code>GPU Share MIG子卡命名规范%s/mig-%s-mixed</code>则可以获取到<code>MIG</code>的子卡名称，例如<code>NIVIDIA-H20/mig-1g.12gb-mixed</code>。</li>
</ul>
</li>
</ul>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=如何识别整卡资源量>如何识别整卡资源量<a href=#如何识别整卡资源量 class=hash-link aria-label="Direct link to 如何识别整卡资源量" title="Direct link to 如何识别整卡资源量">​</a></h6>
<ul>
<li>遍历节点的<code>Status.Allocatable</code>字段，在过滤完<code>MPS</code>和<code>MIG</code>子卡的资源名称后，如果该资源名称还带有厂商域前缀前缀，那么该资源名称则为整卡资源名称。</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=调度器扩展点设计>调度器扩展点设计<a href=#调度器扩展点设计 class=hash-link aria-label="Direct link to 调度器扩展点设计" title="Direct link to 调度器扩展点设计">​</a></h5>
<p><code>Volcano</code>调度器提供了丰富的扩展点，以提供了很强大的扩展性。由于扩展点比较多，这里不详细介绍，具体请参考：[<code>Volcano Session Plugins</code>方法](./1000-Volcano%20Session%20Plugins方法介绍.md。</p>
<p>本方案使用到的关键扩展点如下：</p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=jobenqueueablefn>JobEnqueueableFn<a href=#jobenqueueablefn class=hash-link aria-label="Direct link to JobEnqueueableFn" title="Direct link to JobEnqueueableFn">​</a></h6>
<p>该扩展点工作在<code>enqueue</code> action中，用于判断作业是否可以进入调度队列。该函数将会把<code>Pending</code>状态的<code>PodGroup</code>转换为<code>Inqueue</code>状态，随后<code>PodGroup</code>对应的<code>Pod</code>将会创建出来，新建出来的<code>Pod</code>处于<code>Pending</code>状态。</p>
<p>在该扩展点中，使用以下算法决定任务（<code>Job</code>）是否能够入队：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">队列资源预使用总量</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">totalToBeUsed</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> 任务最小请求资源量</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">job</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MinReqResource</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>+</span><span class="token plain"> queue</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">allocated </span><span class="token operator" style=color:#66d9ef>+</span><span class="token plain"> queue</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">inqueue </span><span class="token operator" style=color:#66d9ef>-</span><span class="token plain"> queue</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">elastic</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">队列资源总量</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">capability</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>>=</span><span class="token plain"> 队列资源预使用总量</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">totalToBeUsed</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> ? 可入队</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 不可入队。</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=allocatablefn>AllocatableFn<a href=#allocatablefn class=hash-link aria-label="Direct link to AllocatableFn" title="Direct link to AllocatableFn">​</a></h6>
<p>该扩展点工作在<code>allocate action</code>中，用于判断队列是否可以为任务分配资源。该函数将会允许<code>Pending</code>状态的<code>Pod</code>继续进行调度（分配资源），随后<code>Pod</code>将会被绑定到符合条件的节点上，<code>Pod</code>状态从<code>Pending</code>转换到<code>Running</code>状态。</p>
<p>在该扩展点中，使用以下算法决定任务的<code>Pod</code>是否能够分配资源：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">队列资源预分配总量</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">totalToBeAllocated</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> 任务总请求资源量</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">job</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">request</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>+</span><span class="token plain"> queue</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">allocated</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">队列资源总量</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">capability</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>>=</span><span class="token plain"> 队列资源预分配总量</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">totalToBeAllocated</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> ? 可分配</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 不可分配。</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=nodeorderfn>NodeOrderFn<a href=#nodeorderfn class=hash-link aria-label="Direct link to NodeOrderFn" title="Direct link to NodeOrderFn">​</a></h6>
<p>该扩展点工作在<code>allocate action</code>中，用于决定<code>Node</code>调度的优先级。我们可以使用该扩展点来实现单实例多卡部署的配额管控中的多卡优先级控制，例如，<code>Pod</code>请求<code>NVIDIA-GeForce-RTX-4090|NVIDIA-GeForce-RTX-4090-D</code>两种卡型号资源，那么我们可以根据配置的顺序来决定调度优先级，其中<code>NVIDIA-GeForce-RTX-4090</code>的优先级调度高于<code>NVIDIA-GeForce-RTX-4090-D</code>。</p>
<p>该扩展点作为预留功能扩展能力，未来需要支持单实例多卡的优先级控制的时候再增加扩展实现。</p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=eventhandler>EventHandler<a href=#eventhandler class=hash-link aria-label="Direct link to EventHandler" title="Direct link to EventHandler">​</a></h6>
<p>事件处理器，用于在任务分配和释放过程中执行自定义的回调逻辑。这是插件中对资源分配管理的关键方法。需要注意，<code>EventHandler</code>在<code>Session</code>整合流程中不是异步触发的，而是串行执行的。</p>
<ul>
<li>
<p><code>AllocateFunc</code>:</p>
<p>任务被正式分配到节点时（<code>Allocate</code>操作）、进入流水线调度时（<code>Pipeline</code>操作）、被驱逐的任务恢复运行时（<code>Unevict</code>操作），参数为包含任务和节点信息的事件。</p>
<p>在该回调中，需要将已完成分配的<code>Pod</code>总请求资源量累加到队列的已分配总量（<code>allocated</code>）中。如果该实例是单实例多卡部署，那么真实累加的卡型号资源量需要根据实例绑定节点的卡型号类型来确定。</p>
</li>
<li>
<p><code>DeallocateFunc</code>:</p>
<p>任务被抢占驱逐（<code>Evict</code>操作）、调度决策被撤销（<code>UnPipeline</code>操作）、任务分配被取消（<code>UnAllocate</code>操作）时，参数为包含任务和节点信息的事件。</p>
<p>在该回调中，需要将已取消分配的<code>Pod</code>总请求资源量从队列的已分配总量（<code>allocated</code>）中减去。如果该实例是单实例多卡部署，那么真实扣减的卡型号资源量需要根据实例绑定节点的卡型号类型来确定。</p>
</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=具体执行流程>具体执行流程<a href=#具体执行流程 class=hash-link aria-label="Direct link to 具体执行流程" title="Direct link to 具体执行流程">​</a></h5>
<p>以下是该插件的关键执行流程，以及关键操作介绍，整体流程都是串行执行，以避免并发调度问题。</p>
<p><img decoding=async loading=lazy alt=调度器插件扩展设计-额度资源对象 src=/assets/images/image-4-1032f53d461e56dba3c9579087a1d080.png width=1666 height=1660 class=img_ev3q></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=event信息提示>Event信息提示<a href=#event信息提示 class=hash-link aria-label="Direct link to Event信息提示" title="Direct link to Event信息提示">​</a></h5>
<p>在<code>Volcano</code>默认的配额管理插件<code>capacity</code>中，一旦出现队列额度问题，只有查看调度器日志信息才能确定<code>任务/Pod</code>无法调度的原因，运维效率低下。</p>
<p>为了解决这个问题，在新的插件中，我们需要将调度失败的原因通过<code>Event</code>的方式添加到<code>任务/Pod</code>上，这样便于快速定位由于额度问题引发的调度问题。</p>
<ul>
<li>
<p><strong>针对任务无法调度（<code>Volcano Job</code>）</strong>：这个时候通常没有<code>Pod</code>被创建出来，我们可以将<code>Event</code>创建到<code>PodGroup</code>上，描述具体无法调度的原因。由于为<code>PodGroup</code>创建<code>Event</code>是<code>Volcano Session</code>已经封装好的能力（并没有将<code>Event</code>创建到<code>Volcano Job</code>上），因此我们这里保留<code>Volcano</code>原有设计，当遇到<code>Pod</code>无法创建时，查看<code>PodGroup</code>的<code>Event</code>即可。例如：<code>Queue &lt;cr-queue1> has insufficient &lt;NVIDIA-H200> quota: requested &lt;5000>, total would be &lt;5000>, but capability is &lt;3000></code></p>
</li>
<li>
<p><strong>针对<code>Pod</code>处于<code>Pending</code>无法调度到节点上</strong>：我们可以将<code>Event</code>创建到<code>Pod</code>上，描述具体无法调度的原因。该功能需要在插件中自行实现封装。例如：<code>Queue &lt;cr-queue1> has insufficient &lt;NVIDIA-H200> quota: requested &lt;5000>, total would be &lt;5000>, but capability is &lt;3000></code></p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=上层额度管控的关键实现点>上层额度管控的关键实现点<a href=#上层额度管控的关键实现点 class=hash-link aria-label="Direct link to 上层额度管控的关键实现点" title="Direct link to 上层额度管控的关键实现点">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=额度的资源查询>额度的资源查询<a href=#额度的资源查询 class=hash-link aria-label="Direct link to 额度的资源查询" title="Direct link to 额度�的资源查询">​</a></h4>
<ul>
<li><strong>队列状态可用</strong>：在<code>Volcano</code>的资源队列中，有当前队列已分配的资源量（<code>Queue.Status.Allocated</code>），理论上来讲上层直接使用即可，不用再重新汇总<code>Pod</code>数据。</li>
<li><strong>历史数据的考虑</strong>：但考虑到存在历史数据，这部分数据并没有真正绑定到资源队列上（绑定队列需要重启业务<code>Pod</code>，影响面较大），因此上层额度的资源查询仍然由额度管控服务遍历<code>Pod</code>去汇总统计。</li>
<li><strong>状态逻辑一致性</strong>：需要注意判断<code>Pod</code>的状态需要保持和<code>Volcano</code>相同的判断逻辑。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=不再使用层级队列>不再使用层级队列<a href=#不再使用层级队列 class=hash-link aria-label="Direct link to 不再使用层级队列" title="Direct link to 不再使用层级队列">​</a></h4>
<ul>
<li><strong>平级的队列关系</strong>：为降低运维管控的复杂度，我们的调度器插件不再支持层级队列，资源队列都是平级关系（其父级队列默认为<code>root</code>）。并且在使用资源队列时，不再需要对根队列（<code>root</code>）做额度配置。</li>
<li><strong>统一额度管控入口</strong>：在分配资源队列额度时。我们的调度器插件不会对剩余资源量进行额度校验，比如集群资源在分配完后只有<code>2</code>张<code>H200</code>的卡剩余资源量，但是底层调度器任然允许继续分配超过<code>2</code>张<code>H200</code>的卡资源量。这给上层业务管控服务能力提供了更多的扩展空间：<!-- -->
<ul>
<li>上层的资源管控服务作为额度管控的唯一入口和控制点，超出集群资源总量的额度分配会导致队列之间（租户之间）资源的争抢。</li>
<li>这种设计也为未来的资源超卖提供了可能。</li>
</ul>
</li>
<li><strong>调度器稳定性增强</strong>：在集群资源发生变更，如集群机器被挪出、机器出现故障、<code>GPU Share</code>拆卡，导致卡资源不充足时，在<code>Volcano</code>默认的额度管理（<code>capacity</code>插件）中会引发调度器的整体崩溃。在我们自定义的额度插件中不再出现调度器崩溃的问题，但卡资源不够会造成申请使用该卡型号的业务<code>Pod Pending</code>，这也符合预期。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=常见调度问题的快速排查>常见调度问题的快速排查<a href=#常见调度问题的快速排查 class=hash-link aria-label="Direct link to 常见调度问题的快速排查" title="Direct link to 常见调度问题的快速排查">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=额度分配的合理性检查>额度分配的合理性检查<a href=#额度分配的合理性检查 class=hash-link aria-label="Direct link to 额度分配的合理性检查" title="Direct link to 额度分配的合理性检查">​</a></h4>
<p>例如：</p>
<ul>
<li><strong>集群资源被超额分配</strong>：本来只有<code>10</code>卡资源，实际上分出去了<code>11</code>卡。可能是业务系统没有做到合理校验，或者集群资源发生了变更。</li>
<li><strong>集群资源产生了异常</strong>：如节点被挪出、节点故障导致集群总资源低于队列已分配额度。
解决方案：</li>
<li>提供队列<code>grafana</code>可观测面板，实现对集群总资源、在线离线总资源、队列额度资源、已使用量进行可观测，主动发现问题。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=使用资源队列的volcano-job的pod未创建出来>使用资源队列的Volcano Job的Pod未创建出来<a href=#使用资源队列的volcano-job的pod未创建出来 class=hash-link aria-label="Direct link to 使用资源队列的Volcano Job的Pod未创建出来" title="Direct link to �使用资源队列的Volcano Job的Pod未创建出来">​</a></h4>
<p>查询<code>Pod</code>对应的<code>PodGroup</code>的<code>Event</code>信息即可，如果是调度问题，在<code>Event</code>中会有详细的<code>Warning</code>事件。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=使用资源队列的pod创建出来但持续处于pending状态>使用资源队列的Pod创建出来，但持续处于Pending状态<a href=#使用资源队列的pod创建出来但持续处于pending状态 class=hash-link aria-label="Direct link to 使用资源队列的Pod创建出来，但持续处于Pending状态" title="Direct link to 使用资源队列的Pod创建出来，但持续处于Pending状态">​</a></h4>
<p>查询<code>Pod</code>的<code>Event</code>信息即可，如果是调度问题，在<code>Event</code>中会有详细的<code>Warning</code>事件。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=其他注意事项>其他注意事项<a href=#其他注意事项 class=hash-link aria-label="Direct link to 其他注意事项" title="Direct link to 其他注意事项">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=调度器启动参数>调度器启动参数<a href=#调度器启动参数 class=hash-link aria-label="Direct link to 调度器启动参数" title="Direct link to 调度器启动参数">​</a></h4>
<p>调度器默认配置为：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">- </span><span class="token parameter variable" style=color:#f8f8f2>--logtostderr</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --scheduler-conf</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">/volcano.scheduler/volcano-scheduler.conf</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --enable-healthz</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">true</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --enable-metrics</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">true</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --leader-elect</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">false</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --kube-api-qps</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>2000</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --kube-api-burst</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>2000</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --schedule-period</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">1s</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --node-worker-threads</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>20</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- </span><span class="token parameter variable" style=color:#f8f8f2>-v</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- </span><span class="token operator file-descriptor important" style=color:#66d9ef>2</span><span class="token operator" style=color:#66d9ef>></span><span class="token file-descriptor important">&1</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>调整为：</p>
<ul>
<li>多节点部署调度器实例，并开启选主配置<code>leader-elect</code></li>
<li>调整调度器执行建个为<code>3s</code></li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">- </span><span class="token parameter variable" style=color:#f8f8f2>--logtostderr</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --scheduler-conf</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">/volcano.scheduler/volcano-scheduler.conf</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --enable-healthz</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">true</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --enable-metrics</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">true</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --leader-elect</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">true</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --kube-api-qps</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>2000</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --kube-api-burst</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>2000</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --schedule-period</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">3s</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- --node-worker-threads</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>20</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- </span><span class="token parameter variable" style=color:#f8f8f2>-v</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>3</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- </span><span class="token operator file-descriptor important" style=color:#66d9ef>2</span><span class="token operator" style=color:#66d9ef>></span><span class="token file-descriptor important">&1</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/cloud-native/volcano-session-plugins-fns><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Volcano Session Plugins方法介绍</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/cloud-native/volcano-cross-queues-reclaim-design><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Volcano跨队列资源抢占驱逐改进设计</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#背景介绍 class="table-of-contents__link toc-highlight">背景介绍</a><ul><li><a href=#当前业务场景 class="table-of-contents__link toc-highlight">当前业务场景</a><li><a href=#当前技术实现 class="table-of-contents__link toc-highlight">当前技术实现</a></ul><li><a href=#改进方案 class="table-of-contents__link toc-highlight">改进方案</a><ul><li><a href=#核心目标 class="table-of-contents__link toc-highlight">核心目标</a><li><a href=#功能设计 class="table-of-contents__link toc-highlight">功能设计</a><li><a href=#上层额度管控的关键实现点 class="table-of-contents__link toc-highlight">上层额度管控的关键实现点</a><li><a href=#常见调度问题的快速排查 class="table-of-contents__link toc-highlight">常见调度问题的快速排查</a><li><a href=#其他注意事项 class="table-of-contents__link toc-highlight">其他注意事项</a></ul></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>