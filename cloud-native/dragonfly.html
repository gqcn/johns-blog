<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/云原生/Dragonfly介绍" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Dragonfly介绍 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/cloud-native/dragonfly><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Dragonfly介绍 | John's Blog"><meta data-rh=true name=description content=Dragonfly是一款基于P2P的智能镜像和文件分发工具，旨在提高大规模文件传输的效率和速率，最大限度地利用网络带宽。本文介绍了Dragonfly的架构、工作原理及其在应用分发、缓存分发、日志分发和镜像分发等领域的应用。><meta data-rh=true property=og:description content=Dragonfly是一款基于P2P的智能镜像和文件分发工具，旨在提高大规模文件传输的效率和速率，最大限度地利用网络带宽。本文介绍了Dragonfly的架构、工作原理及其在应用分发、缓存分发、日志分发和镜像分发等领域的应用。><meta data-rh=true name=keywords content=Dragonfly,P2P,文件分发,镜像加速,CNCF,Scheduler,分布式下载,容器镜像,Nydus><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/cloud-native/dragonfly><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/dragonfly hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/dragonfly hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><script src=https://cdn.wwads.cn/js/makemoney.js async></script><link rel=stylesheet href=/assets/css/styles.19b7c7dc.css><script src=/assets/js/runtime~main.068dc4dc.js defer></script><script src=/assets/js/main.fb4c190e.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" sidebarid=mainSidebar href=/cloud-native>云原生</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/ai>AI技术</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/observability>可观测性</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/cloud-native>云原生</a><button aria-label="Collapse sidebar category '云原生'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kubernetes>Kubernetes</a><button aria-label="Expand sidebar category 'Kubernetes'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/argo-workflow>Argo Workflow</a><button aria-label="Expand sidebar category 'Argo Workflow'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/volcano>Volcano</a><button aria-label="Expand sidebar category 'Volcano'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/helm>helm介绍及常用指令</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/cloud-native/dragonfly>Dragonfly介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/docker-containerd-commands>Docker和Containerd常用命令对比</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-kind>使用Kubernetes Kind搭建本地测试集群</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernettes-kind-mock-ai-test-cluster>使用Kubernetes Kind模拟AI算力测试集群</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native><span itemprop=name>云原生</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Dragonfly介绍</span><meta itemprop=position content=2></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><blockquote>
<p>上世纪末期，基于<code>C/S</code>模式的思想，人们发展了<code>HTTP</code>、<code>FTP</code>等应用层协议。然而<code>C/S</code>模式的弊端很明显：服务器的负载过大，下载速率过慢。基于上述背景，有人结合<code>P2P</code>网络与负载均衡的思想，提出<code>P2P</code>下载模式。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=背景><strong>背景</strong><a href=#背景 class=hash-link aria-label="Direct link to 背景" title="Direct link to 背景">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=网络下载><strong>网络下载</strong><a href=#网络下载 class=hash-link aria-label="Direct link to 网络下载" title="Direct link to 网络下载">​</a></h3>
<p>提起网络下载领域，你应该首先会想到基于<code>TCP/IP</code>协议簇的<code>C/S</code>模式。这种模式希望每一个客户机都与服务器建立<code>TCP</code>连接，服务器轮询监听<code>TCP</code>连接并依次响应，如下图：</p>
<p><img decoding=async loading=lazy alt=网络下载 src=/assets/images/5d3b12856d43463fb737de3b88ee5b89-4d576d6e0504abd77c04b8633d32d1a5.png width=1080 height=862 class=img_ev3q></p>
<p>上世纪末期，基于<code>C/S</code>模式的思想，人们发展了<code>HTTP</code>、<code>FTP</code>等应用层协议。然而<code>C/S</code>模式的弊端很明显：服务器的负载过大，下载速率过慢。随着互联网规模的增大以及客户对于下载数据大小，下载速率等需求的上升，这些弊端被不断放大。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=p2p-下载原理><strong>P2P 下载原理</strong><a href=#p2p-下载原理 class=hash-link aria-label="Direct link to p2p-下载原理" title="Direct link to p2p-下载原理">​</a></h3>
<p>基于上述背景，有人结合<code>P2P</code>网络与负载均衡的思想，提出<code>P2P</code>下载模式。这种模式不再把所有的下载压力丢给服务器，服务器只负责传递文件元数据，真正的文件下载连接建立在客户机与客户机之间。同时一个文件可以被分片为多个块，同一个文件中不同的块可以在不同的客户机之上下载，使得下载文件在<code>P2P</code>网络中动态流通，大幅提升了下载效率，如下图：</p>
<p><img decoding=async loading=lazy alt="P2P 下载原理" src=/assets/images/fb7c62d1b67049e289acc0fed05e17f5-44b6cb6b978d764494c383c736d57926.png width=1080 height=630 class=img_ev3q></p>
<p>去中心化的<code>P2P</code>下载基于<code>DHT</code>技术，它采用分布式全网方式来进行信息的存储和检索。所有信息均以哈希表条目形式加以存储，这些条目被分散地存储在各个节点上，从而以全网方式构成一张巨大的分布式哈希表。在此基础上做到对单服务器的去中心化，哈希表负责对负载的分摊，将全网负载均摊到多个机器之上。</p>
<p><strong><code>Dragonfly</code>简介及架构概述</strong></p>
<p><strong><code>Dragonfly</code>是一款基于 P2P 的智能镜像和文件分发工具</strong>。它旨在提高大规模文件传输的效率和速率，最大限度地利用网络带宽。在应用分发、缓存分发、日志分发和镜像分发等领域被大规模使用。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=原理><strong>原理</strong><a href=#原理 class=hash-link aria-label="Direct link to 原理" title="Direct link to 原理">​</a></h3>
<p><code>Dragonfly</code>结合<code>C/S</code>架构与<code>P2P</code>架构的优点。它提供面向客户的<code>C/S</code>架构下载模式。同时它也提供面向服务器集群的<code>P2P</code>回源模式，与传统<code>P2P</code>不同的是，对等网络建立在<code>Scheduler</code>内部，目标是最大化<code>P2P</code>内部下载效率，如下图：</p>
<p><img decoding=async loading=lazy alt=Dragonfly原理 src=/assets/images/fae57f4226fd405f806b67d3aa83c30e-71c2817a57f5e584435799ca9c8533bb.png width=1080 height=845 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=架构简介><strong>架构简介</strong><a href=#架构简介 class=hash-link aria-label="Direct link to 架构简介" title="Direct link to 架构简介">​</a></h3>
<p><code>Dragonfly</code>面向镜像分发和文件分发，结合<code>P2P</code>网络和服务器集群的思想，向用户提供稳定的、高效的下载服务。<code>Dragonfly</code>希望在服务器内部构建<code>P2P</code>网络，将服务器的不同主机节点分为 <strong>Manager、Scheduler、Seed Peer 以及 Peer</strong> 四个角色，分别提供不同的功能。</p>
<p>其中<code>Manager</code>提供总体配置功能，拉取其他角色的配置并相互通信。<code>Scheduler</code>提供下载调度功能，其调度结果直接影响下载速率。<code>Seed Peer</code>负责回源下载，从外部网络中拉取所需的镜像或文件。<code>Peer</code>作为<code>C/S</code>架构中的服务器，通过多种协议向客户提供下载功能。架构图如下：</p>
<p><img decoding=async loading=lazy alt=Dragonfly架构简介 src=/assets/images/b9b9fd0d98f3445f9b09e95014dc996e-d8b1591a7f17a906764b17a1ec223caa.png width=997 height=622 class=img_ev3q></p>
<p>其中，<code>Seed Peer</code>支持使用多种协议从外部网络中回源下载，同时也支持当作集群当中一个<code>Peer</code>使用。<code>Peer</code>提供基于多种协议的下载服务，也提供为镜像仓库或其他下载任务的代理服务。</p>
<p><strong>组件详解</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=manager><strong><code>Manager</code></strong><a href=#manager class=hash-link aria-label="Direct link to manager" title="Direct link to manager">​</a></h3>
<p><code>Manager</code>在多<code>P2P</code>集群部署的时候扮演管理者的角色，提供前端控制台方便用户进行可视化操作<code>P2P</code>集群。其主要提供动态配置管理、维护集群稳定性以及维护多套<code>P2P</code>集群的关联关系等功能。对于维护集群整体稳定性<code>Manager</code>和各个服务保持<code>Keepalive</code>保证能够在实例异常情况下将异常实例进行剔除。动态配置管理可以在<code>Manager</code>上面操作各个组件的控制单元，比如控制<code>Peer</code>和<code>Seed Peer</code>的负载数，<code>Scheduler</code>调度<code>Parent</code>的个数等。<code>Manager</code>也可以维护多套<code>P2P</code>集群关联关系，一个<code>Scheduler Cluster</code>、一个<code>Seed Peer Cluster</code>和若干个<code>Peer</code>组成一个完整的<code>P2P</code>集群，当然不同<code>P2P</code>集群可以是网络隔离的。正常情况下采用一个机房一套<code>P2P</code>集群，统一由一个<code>Manager</code>管理多个<code>P2P</code>集群。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=scheduler><strong><code>Scheduler</code></strong><a href=#scheduler class=hash-link aria-label="Direct link to scheduler" title="Direct link to scheduler">​</a></h3>
<p><code>Scheduler</code>主要工作就是为当前下载节点寻找最优父节点并触发<code>Seed Peer</code>进行回源下载。在适当时候让<code>Peer</code>进行回源下载。<code>Scheduler</code>在启动时，先向<code>Manager</code>注册，注册成功后初始化动态配置客户端，并从<code>Manager</code>拉取动态配置，接下来启动<code>Scheduler</code>自身所需的服务。</p>
<p><code>Scheduler</code>的核心就是选取一组最优<code>Parent</code>节点供当前下载<code>Peer</code>进行下载。<code>Scheduler</code>面向<code>Task</code>，一次<code>Task</code>就是一次完整的下载任务，在<code>Scheduler</code>中存储<code>Task</code>信息和相应<code>P2P</code>下载网络的<code>DAG</code>。调度过程是首先过滤异常<code>Parent</code>节点，根据多维度进行过滤，比如判断该<code>Peer</code>是否是<code>BadNode</code>，判断逻辑为假设每个节点的响应时长都遵循正态分布，若一个节点目前的响应时长处于 6σ 范围之外，那么认为该节点是<code>BadNode</code>，剔除该节点。再根据历史下载特征值对剩余待定<code>Parent</code>节点进行打分，返回一组分数最高的<code>Parent</code>提供给当前<code>Peer</code>进行下载。</p>
<p><img decoding=async loading=lazy alt="Dragonfly Scheduler" src=/assets/images/3a82facd49334978a776f90b5728e015-f995efd5c39adc068f9c677da7d35a1d.png width=1080 height=647 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=seed-peer和peer><strong><code>Seed Peer</code>和<code>Peer</code></strong><a href=#seed-peer和peer class=hash-link aria-label="Direct link to seed-peer和peer" title="Direct link to seed-peer和peer">​</a></h3>
<p><code>Seed Peer</code>和<code>Peer</code>有很多相似之处。他们都是基于<code>Dfdaemon</code>，不同的是<code>Seed Peer</code>采用<code>Seed Peer</code>模式，支持主动触发回源下载。<code>Peer</code>采用<code>Peer</code>模式，作为<code>C/S</code>架构中的服务器向用户提供下载功能，支持被<code>Scheduler</code>被动触发回源下载。这表明<code>Peer</code>和<code>Seed Peer</code>的关系不是固定的，一个<code>Peer</code>可以通过回源使自己成为<code>Seed Peer</code>，<code>Seed Peer</code>也可以改动运行状态变为<code>Peer</code>，<code>Scheduler</code>会动态地对相应<code>DAG</code>进行改动。另外<code>Seed Peer</code>和<code>Peer</code>都需要参与调度下载过程当中，<code>Scheduler</code>可能会选取<code>Seed Peer</code>或者<code>Peer</code>作为父节点向其他<code>Peer</code>提供下载功能。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=dfstore-和-dfcache><strong>Dfstore 和 Dfcache</strong><a href=#dfstore-和-dfcache class=hash-link aria-label="Direct link to dfstore-和-dfcache" title="Direct link to dfstore-和-dfcache">​</a></h3>
<p><code>Dfcache</code>是<code>dragonfly</code>的缓存客户端，它与<code>dfdaemon</code>通信并对<code>P2P</code>网络中的文件进行操作，其中<code>P2P</code>网络充当缓存系统。可以在<code>Scheduler</code>中存储相应<code>Task</code>和<code>DAG</code>。</p>
<p><code>Dfstore</code>是<code>dragonfly</code>存储客户端. 其可以依赖不同类型的对象存储服务作为<code>Backend</code>，提供稳定的存储方案，现在支持<code>S3</code>和<code>OSS</code>。<code>Dfstore</code>依赖<code>Backend</code>对象存储服务结合<code>P2P</code>本身的加速特点。可做到快写快读，并且能够节省回源以及跨机房流量，减少源站压力。</p>
<p><strong>优势</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=稳定性><strong>稳定性</strong><a href=#稳定性 class=hash-link aria-label="Direct link to 稳定性" title="Direct link to 稳定性">​</a></h3>
<p><code>Dragonfly</code>会自动隔离异常节点来提高下载稳定性，<code>Dragonfly</code>中各个组件通过<code>Keepalive</code>与<code>Manager</code>进行联系，<code>Manager</code>能够保证返回给<code>Peer</code>的<code>Scheduler</code>地址和返回给<code>Scheduler</code>的<code>Seed Peer</code>地址都是可用的。不可用的<code>Scheduler</code>和<code>Seed Peer</code>不会被<code>Manager</code>推给需要进行下载任务的<code>Peer</code>或<code>Scheduler</code>，从而达到隔离异常节点的目的，这也是实例维度的异常隔离，如下图：</p>
<p><img decoding=async loading=lazy alt=Dragonfly src=/assets/images/493a056a5806443db47f4a37b3b1adab-c399f81489939c9bcfc4338fab185881.png width=941 height=801 class=img_ev3q></p>
<p>另外<code>Dragonfly</code>在调度时以<code>Task</code>为单位，也确保了整个调度过程的稳定性。在收到一个新的<code>Task</code>调度请求之后，<code>Scheduler</code>触发<code>Seed Peer</code>进行回源下载；在收到一个已有<code>Task</code>的调度请求之后，<code>Scheduler</code>调度最优<code>Parent Peer</code>集合返回给<code>Peer</code>。这个逻辑确保了无论<code>Task</code>是否下载过，<code>Dragonfly</code>都可以对其进行处理。此外在<code>Scheduler</code>调度过程中，对响应时长过慢的<code>Peer</code>，认为目前是异常节点，将不会作为<code>Parent Peer</code>被返还。这也是<code>Task</code>维度的异常隔离。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=高效性><strong>高效性</strong><a href=#高效性 class=hash-link aria-label="Direct link to 高效性" title="Direct link to 高效性">​</a></h3>
<p><code>Dragonfly</code>采用<code>P2P</code>进行服务端内部的回源，<code>P2P</code>下载本身即分摊负载，将每个服务端节点的负载降到最低，有以下几个细节保证了<code>Dragonfly</code>下载的高效性：</p>
<ul>
<li>
<p><code>Scheduler</code>通过为每个可能的<code>Parent</code>打分，返回给<code>Peer</code>目前局部最优的<code>Parent</code>集合，<code>Peer</code>基于此集合做下载。</p>
</li>
<li>
<p>下载过程基于<code>Task</code>，每个<code>Task</code>将待下载文件分为多个<code>Piece</code>，<code>Peer</code>拿到了最优的<code>Parent</code>之后，向此集合广播每个<code>Piece</code>的下载请求，集合中的<code>Parent</code>收到该请求后返回给<code>Peer</code>对应<code>Piece</code>的元信息，<code>Peer</code>将第一个收到的<code>Piece</code>元信息所对应的<code>Parent Peer</code>作为该<code>Piece</code>的实际下载源。该做法考虑到<code>Scheduler</code>返回可用<code>Parent</code>到触发下载这段时间内可能的变化，同时对不同的<code>Piece</code>，允许<code>Peer</code>向不同的下载源获取数据。</p>
</li>
<li>
<p><code>Dfdaemon</code>分为<code>Seed Peer</code>模式和<code>Peer</code>模式，允许<code>Seed Peer</code>和<code>Peer</code>进行切换，可以根据实际需求改变作为<code>Seed Peer</code>和<code>Peer</code>的机器数目，动态调整更适应实际情况。</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=简单易用><strong>简单易用</strong><a href=#简单易用 class=hash-link aria-label="Direct link to 简单易用" title="Direct link to 简单易用">​</a></h3>
<p><code>Dragonfly</code>提供<code>Helm Charts</code>、<code>Docker Compose</code>、<code>Docker Image</code>以及二进制的多种部署方式。用户可以<strong>快速一键部署进行一次简单<code>POC</code></strong>，并且也可以<strong>基于<code>Helm Charts</code>进行大规模生产部署</strong>。当然<code>Dragonfly</code>各个服务都有完善的<code>Metrics</code>也提供现成的<code>Granafa</code>模版，方便用户观察<code>P2P</code>的流量走势。</p>
<p><code>Dragonfly</code>作为<code>CNCF</code>在镜像加速领域标准解决方案，结合<code>Dragonfly</code>子项目<code>Nydus</code>进行按需加载可以<strong>最大限度提升镜像下载速度</strong>，未来我们也会继续努力建设镜像加速领域的生态链。感谢所有参与到社区建设的同学，希望有更多对镜像加速领域或<code>P2P</code>感兴趣的同学加入（文末扫描二维码或搜索钉钉群号：44701621进群交流）到我们的社区当中。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=参考链接>参考链接<a href=#参考链接 class=hash-link aria-label="Direct link to 参考链接" title="Direct link to 参考链接">​</a></h2>
<ul>
<li><a href=https://github.com/dragonflyoss/dragonfly target=_blank rel="noopener noreferrer">https://github.com/dragonflyoss/dragonfly</a></li>
<li><a href=https://zhuanlan.zhihu.com/p/630101983 target=_blank rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/630101983</a></li>
<li><a href="https://developer.aliyun.com/article/1008039?utm_content=m_1000357296" target=_blank rel="noopener noreferrer">https://developer.aliyun.com/article/1008039?utm_content=m_1000357296</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/cloud-native/helm><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>helm介绍及常用指令</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/cloud-native/docker-containerd-commands><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Docker和Containerd常用命令对比</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#背景 class="table-of-contents__link toc-highlight"><strong>背景</strong></a><ul><li><a href=#网络下载 class="table-of-contents__link toc-highlight"><strong>网络下载</strong></a><li><a href=#p2p-下载原理 class="table-of-contents__link toc-highlight"><strong>P2P 下载原理</strong></a><li><a href=#原理 class="table-of-contents__link toc-highlight"><strong>原理</strong></a><li><a href=#架构简介 class="table-of-contents__link toc-highlight"><strong>架构简介</strong></a><li><a href=#manager class="table-of-contents__link toc-highlight"><strong><code>Manager</code></strong></a><li><a href=#scheduler class="table-of-contents__link toc-highlight"><strong><code>Scheduler</code></strong></a><li><a href=#seed-peer和peer class="table-of-contents__link toc-highlight"><strong><code>Seed Peer</code>和<code>Peer</code></strong></a><li><a href=#dfstore-和-dfcache class="table-of-contents__link toc-highlight"><strong>Dfstore 和 Dfcache</strong></a><li><a href=#稳定性 class="table-of-contents__link toc-highlight"><strong>稳定性</strong></a><li><a href=#高效性 class="table-of-contents__link toc-highlight"><strong>高效性</strong></a><li><a href=#简单易用 class="table-of-contents__link toc-highlight"><strong>简单易用</strong></a></ul><li><a href=#参考链接 class="table-of-contents__link toc-highlight">参考链接</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>