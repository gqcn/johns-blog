<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/云原生/Volcano/Volcano高级特性/Volcano网络拓扑感知调度案例" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Volcano网络拓扑感知调度案例 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/cloud-native/volcano-network-topology-scheduling-case><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=author content="John Guo"><meta data-rh=true property=og:image content=https://johng.cn/img/favicon.png><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Volcano网络拓扑感知调度案例 | John's Blog"><meta data-rh=true name=description content=通过PD分离部署场景，详细演示如何使用Volcano网络拓扑感知调度功能，在IB网络环境下优化大模型推理服务的节点选择，降低网络延迟，提升带宽利用率。包含HyperNode配置、节点标签、Prefill和Decode服务部署的完整示例。><meta data-rh=true property=og:description content=通过PD分离部署场景，详细演示如何使用Volcano网络拓扑感知调度功能，在IB网络环境下优化大模型推理服务的节点选择，降低网络延迟，提升带宽利用率。包含HyperNode配置、节点标签、Prefill和Decode服务部署的完整示例。><meta data-rh=true name=keywords content=Volcano,网络拓扑感知调度,HyperNode,PD分离,Prefill-Decode,IB网络,InfiniBand,GPU调度,Kubernetes调度,大模型推理,分布式推理,网络优化,Gang调度><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/cloud-native/volcano-network-topology-scheduling-case><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/volcano-network-topology-scheduling-case hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/volcano-network-topology-scheduling-case hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="John's Blog RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="John's Blog Atom Feed"><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><link rel=stylesheet href=/assets/css/styles.2f56d3c4.css><script src=/assets/js/runtime~main.e38e5f97.js defer></script><script src=/assets/js/main.7cde404c.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" href=/ai>AI技术</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/cloud-native>云原生</a><a class="navbar__item navbar__link" href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/programming>开发语言</a><a class="navbar__item navbar__link" href=/architecture>技术架构</a><a class="navbar__item navbar__link" href=/observability>可观测性</a><a class="navbar__item navbar__link" href=/life>生活笔记</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href=/aboutme>关于我</a><a class="navbar__item navbar__link" href=/blog>博客</a><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/cloud-native>云原生</a><button aria-label="Collapse sidebar category '云原生'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/container>Container</a><button aria-label="Expand sidebar category 'Container'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kubernetes>Kubernetes</a><button aria-label="Expand sidebar category 'Kubernetes'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/argo-workflow>Argo Workflow</a><button aria-label="Expand sidebar category 'Argo Workflow'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/cloud-native/volcano>Volcano</a><button aria-label="Collapse sidebar category 'Volcano'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-introduction>Volcano基本介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-installation-testing>Volcano安装测试</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-startup-parameters>Volcano启动参数</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-examples>Volcano使用示例</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-annotations>Volcano常用注解</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-scheduler-config>Volcano调度器配置</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/volcano-queue-job>Volcano Queue&Job</a><button aria-label="Expand sidebar category 'Volcano Queue&Job'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/volcano-actions-plugins>Volcano Actions&Plugins</a><button aria-label="Expand sidebar category 'Volcano Actions&Plugins'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/cloud-native/volcano-advanced-features>Volcano高级特性</a><button aria-label="Collapse sidebar category 'Volcano高级特性'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-network-topology-scheduling>Volcano网络拓扑感知调度</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-network-topology-scheduling-test>Volcano网络拓扑感知调度测试</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/cloud-native/volcano-network-topology-scheduling-case>Volcano网络拓扑感知调度案例</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/volcano-extension-development>Volcano扩展开发</a><button aria-label="Expand sidebar category 'Volcano扩展开发'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/volcano-usage-notes>Volcano使用笔记</a><button aria-label="Expand sidebar category 'Volcano使用笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kind>Kind</a><button aria-label="Expand sidebar category 'Kind'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/helm>Helm常用指令</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/dragonfly>Dragonfly介绍</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/life>生活笔记</a><button aria-label="Expand sidebar category '生活笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native><span itemprop=name>云原生</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native/volcano><span itemprop=name>Volcano</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native/volcano-advanced-features><span itemprop=name>Volcano高级特性</span></a><meta itemprop=position content=3><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Volcano网络拓扑感知调度案例</span><meta itemprop=position content=4></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><p>在大规模<code>GPU</code>集群中部署大模型推理服务时，网络拓扑对性能的影响至关重要。本文通过 <strong><code>PD（Prefill-Decode）</code>分离部署</strong> 的实战场景案例，详细演示如何使用<code>Volcano</code>的网络拓扑感知调度功能，在<code>IB（InfiniBand）</code>网络环境下优化节点选择，实现：</p>
<ul>
<li>🎯 <strong>延迟优化</strong>：将跨交换机通信延迟从<code>5-10μs</code>降低到<code>2-5μs</code>，性能提升<code>2-5</code>倍</li>
<li>🎯 <strong>带宽优化</strong>：保持<code>200Gbps</code>高带宽，避免<code>50%</code>的带宽损失，吞吐量提升<code>30-50%</code></li>
<li>🎯 <strong>资源优化</strong>：<code>Prefill</code>使用<code>NVIDIA-H100</code>高性能<code>GPU</code>，<code>Decode</code>使用<code>NVIDIA-GeForce-RTX-4090</code>性价比<code>GPU</code>，降低整体成本</li>
</ul>
<p>本文将从场景背景、技术方案分析、<code>HyperNode</code>拓扑设计到具体实施，提供完整的实践案例。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=场景背景>场景背景<a href=#场景背景 class=hash-link aria-label="Direct link to 场景背景" title="Direct link to 场景背景">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=基础设施环境>基础设施环境<a href=#基础设施环境 class=hash-link aria-label="Direct link to 基础设施环境" title="Direct link to 基础设施环境">​</a></h3>
<p><strong>硬件拓扑</strong>：</p>
<ul>
<li><strong>集群规模</strong>：<code>GPU</code>服务器若干</li>
<li><strong>IB网络组网</strong>：<!-- -->
<ul>
<li><code>7</code>个交换机，其中<code>3</code>个<code>IB</code>交换机，<code>4</code>个以太网交换机，每个叶子交换机上最多有<code>64</code>台<code>GPU</code>服务器</li>
<li><code>IB</code>网络提供高带宽（<code>200Gbps</code>）、低延迟（<code>&lt;2μs</code>）的<code>RDMA</code>通信</li>
<li>跨<code>IB</code>网络域通信需要经过以太网，延迟显著增加（<code>>10μs</code>）</li>
</ul>
</li>
<li><strong>GPU配置</strong>：<!-- -->
<ul>
<li>每台服务器配置<code>8</code>张<code>GPU</code>卡</li>
<li>每个交换机下有各种卡型号服务器，以<code>NVIDIA-A100/NVIDIA-H100</code>和<code>RTX 4090/RTX 5090</code>为主。</li>
</ul>
</li>
</ul>
<p>大致的网络拓扑如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">                                    eth switch6</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      /                                    \</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  ib switch4                           eth switch5</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              /                \                    /               \</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      ib switch0           ib switch1         eth switch2      eth switch3</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      /    |    \          /    |    \        /    |    \      /    |    \ </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  node0   ...  node63   node64 ... node127  ...   ...   ...  ...   ...   ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>网络性能对比</strong>：</p>
<table><thead><tr><th>通信类型<th>带宽<th>延迟<th>带宽损失<th>适用场景<tbody><tr><td><code>IB</code>交换机内（同交换机节点）<td><code>200Gbps</code><td><code>&lt;2μs</code><td><code>0%</code><td>高性能分布式推理<tr><td><code>IB</code>交换机间（跨<code>IB</code>交换机）<td><code>200Gbps</code><td><code>2-5μs</code><td><code>0%</code><td>分布式推理<tr><td><code>IB</code>到以太网（跨交换机类型）<td><code>100Gbps</code><td><code>5-10μs</code><td><code>~50%</code><td>一般分布式任务<tr><td>以太网交换机间<td><code>10-100Gbps</code><td><code>>10μs</code><td><code>50-95%</code><td>非性能敏感任务</table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=pd分离推理场景介绍>PD分离推理场景介绍<a href=#pd分离推理场景介绍 class=hash-link aria-label="Direct link to PD分离推理场景介绍" title="Direct link to PD分离推理场景介绍">​</a></h3>
<p><strong>什么是PD分离？</strong></p>
<p><code>PD</code>分离（<code>Prefill-Decode</code>分离）是大模型推理优化的一种架构模式：</p>
<ul>
<li>
<p><strong>Prefill阶段</strong>：处理输入<code>prompt</code>，生成初始<code>KV Cache</code></p>
<ul>
<li>计算密集型，需要高算力</li>
<li>输入长度可变，计算量大</li>
<li>适合部署在高性能数据中心<code>GPU</code>上（如<code>NVIDIA-H100</code>、<code>NVIDIA-A100</code>）</li>
</ul>
</li>
<li>
<p><strong>Decode阶段</strong>：逐个生成输出<code>token</code></p>
<ul>
<li>访存密集型，对带宽要求高</li>
<li>计算量相对较小，但需要频繁访问<code>KV Cache</code></li>
<li>可以使用性价比更高的消费级<code>GPU</code>（如<code>NVIDIA-GeForce-RTX-4090</code>、<code>NVIDIA-GeForce-RTX-5090</code>）</li>
</ul>
</li>
</ul>
<p><strong>PD分离的优势</strong>：</p>
<ul>
<li>✅ 资源利用率提升：不同阶段使用最适合的<code>GPU</code>型号</li>
<li>✅ 吞吐量提升：<code>Prefill</code>和<code>Decode</code>可以并行处理不同请求</li>
<li>✅ 成本优化：根据计算特点选择性价比最优的硬件</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=业务需求>业务需求<a href=#业务需求 class=hash-link aria-label="Direct link to 业务需求" title="Direct link to 业务需求">​</a></h3>
<p><strong>分布式PD推理架构</strong>：</p>
<p>在我们的场景中，需要部署分布式<code>PD</code>分离推理服务：</p>
<ol>
<li>
<p><strong>Prefill服务</strong>：</p>
<ul>
<li>需要<code>12</code>个<code>Pod</code>，每个<code>Pod</code>使用<code>1</code>张<code>GPU</code>（<code>NVIDIA-H100</code>）</li>
<li>要求在同一<code>IB</code>网络域内，以实现高效的<code>KV Cache</code>传输</li>
</ul>
</li>
<li>
<p><strong>Decode服务</strong>：</p>
<ul>
<li>需要<code>12</code>个<code>Pod</code>，每个<code>Pod</code>使用<code>1</code>张<code>GPU</code>（<code>NVIDIA-GeForce-RTX-4090</code>）</li>
<li>要求在同一<code>IB</code>网络域内，以实现高效的<code>KV Cache</code>访问</li>
</ul>
</li>
</ol>
<p><strong>核心需求</strong>：</p>
<ul>
<li>✅ <strong>同域部署</strong>：<code>Prefill</code>和<code>Decode</code>集群必须部署在同一<code>IB</code>网络域内，避免跨域通信延迟</li>
<li>✅ <strong>域内优化</strong>：在<code>IB</code>网络域内，优化节点选择，减少跨交换机通信</li>
<li>✅ <strong>资源利用</strong>：充分利用同一域内不同节点的<code>GPU</code>型号优势（<code>NVIDIA-H100</code>用于<code>Prefill</code>，<code>NVIDIA-GeForce-RTX-4090</code>用于<code>Decode</code>）</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=技术方案分析>技术方案分析<a href=#技术方案分析 class=hash-link aria-label="Direct link to 技术方案分析" title="Direct link to 技术方案分析">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=简单亲和性调度的局限性>简单亲和性调度的局限性<a href=#简单亲和性调度的局限性 class=hash-link aria-label="Direct link to 简单亲和性调度的局限性" title="Direct link to 简单亲和性调度的局限性">​</a></h3>
<p><strong>场景分析</strong>：</p>
<p>在大规模混合网络集群中（<code>7</code>个交换机，其中<code>3</code>个<code>IB</code>交换机、<code>4</code>个以太网交换机，最多<code>384</code>台服务器），如果仅使用节点亲和性或<code>Pod</code>亲和性：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 仅使用节点亲和性的配置示例</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">affinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">nodeAffinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia.com/gpu.product</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">H100  </span><span class="token comment" style=color:#8292a2;font-style:italic># 只能保证选择NVIDIA-H100节点</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>存在的问题</strong>：</p>
<ol>
<li>
<p><strong>无法感知网络拓扑</strong>：</p>
<ul>
<li>❌ 调度器不知道节点之间的网络距离和交换机类型</li>
<li>❌ <code>12</code>个<code>Prefill Pod</code>可能分散在<code>IB</code>和以太网交换机下</li>
<li>❌ <code>12</code>个<code>Decode Pod</code>也可能分散在不同类型的交换机下</li>
<li>❌ <code>Prefill</code>和<code>Decode</code>之间的<code>KV Cache</code>传输可能需要跨交换机类型</li>
</ul>
</li>
<li>
<p><strong>网络性能不可控</strong>：</p>
<ul>
<li>❌ <strong>延迟问题</strong>：<!-- -->
<ul>
<li>同一<code>IB</code>交换机内通信延迟<code>&lt;2μs</code></li>
<li>跨<code>IB</code>交换机通信延迟<code>2-5μs</code></li>
<li>跨交换机类型（<code>IB</code>到以太网）延迟<code>5-10μs</code></li>
<li>延迟差异可能导致<code>5</code>倍的性能差距</li>
</ul>
</li>
<li>❌ <strong>带宽损失问题</strong>：<!-- -->
<ul>
<li><code>IB</code>交换机间保持<code>200Gbps</code>带宽</li>
<li>跨交换机类型带宽降至<code>100Gbps</code>（损失<code>~50%</code>）</li>
<li>以太网交换机间带宽仅<code>10-100Gbps</code>（损失<code>50-95%</code>）</li>
<li>带宽损失严重影响<code>KV Cache</code>传输效率</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>资源利用率低</strong>：</p>
<ul>
<li>❌ 无法优先选择网络距离近且交换机类型匹配的节点</li>
<li>❌ 可能导致高性能<code>IB</code>交换机下的节点空闲，而低性能以太网交换机下的节点过载</li>
</ul>
</li>
</ol>
<p><strong>实际影响</strong>：</p>
<p>对于<code>PD</code>分离推理服务：</p>
<ul>
<li><code>Prefill</code>生成的<code>KV Cache</code>需要频繁传输给<code>Decode</code></li>
<li>如果<code>12</code>个<code>Prefill Pod</code>和<code>12</code>个<code>Decode Pod</code>分散在不同类型的交换机下：<!-- -->
<ul>
<li><strong>延迟影响</strong>：跨交换机类型通信延迟从<code>&lt;2μs</code>增加到<code>5-10μs</code>，增加<code>5</code>倍</li>
<li><strong>带宽影响</strong>：跨交换机类型带宽从<code>200Gbps</code>降至<code>100Gbps</code>，损失<code>50%</code></li>
<li><strong>吞吐量影响</strong>：<code>KV Cache</code>传输效率降低，<code>Decode</code>阶段等待时间增加，整体吞吐量可能下降<code>30-50%</code></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=网络拓扑感知调度的优势>网络拓扑感知调度的优势<a href=#网络拓扑感知调度的优势 class=hash-link aria-label="Direct link to 网络拓扑感知调度的优势" title="Direct link to 网络拓扑感知调度的优势">​</a></h3>
<p><strong>核心价值</strong>：</p>
<p>网络拓扑感知调度能够理解集群的网络拓扑结构，在调度时优先选择网络距离近的节点：</p>
<ol>
<li>
<p><strong>拓扑感知</strong>：</p>
<ul>
<li>✅ 调度器知道每个节点所属的交换机层级和交换机类型（<code>IB</code>或以太网）</li>
<li>✅ 能够计算节点之间的网络距离（通过<code>LCA</code>最低公共祖先）</li>
<li>✅ 优先选择同一交换机下的节点，避免跨交换机类型通信</li>
</ul>
</li>
<li>
<p><strong>性能优化</strong>：</p>
<ul>
<li>✅ <strong>延迟优化</strong>：<!-- -->
<ul>
<li><code>12</code>个<code>Prefill Pod</code>尽量集中在<code>IB</code>交换机下（<code>ib switch0</code>、<code>ib switch1</code>）</li>
<li><code>12</code>个<code>Decode Pod</code>也尽量集中在<code>IB</code>交换机下（<code>ib switch0</code>、<code>ib switch1</code>）</li>
<li>两组<code>Pod</code>尽量在同一<code>IB</code>交换机下（<code>ib switch0</code>、<code>ib switch1</code>），延迟保持在<code>2-5μs</code></li>
</ul>
</li>
<li>✅ <strong>带宽优化</strong>：<!-- -->
<ul>
<li>避免跨交换机类型通信，保持<code>200Gbps</code>带宽</li>
<li>避免带宽损失（<code>50-95%</code>），确保<code>KV Cache</code>传输效率</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>灵活性</strong>：</p>
<ul>
<li>✅ 支持<code>Hard</code>模式（严格限制）和<code>Soft</code>模式（尽力而为）</li>
<li>✅ 可以通过<code>highestTierAllowed</code>控制允许的最大网络距离</li>
<li>✅ 在满足拓扑约束的前提下，仍然支持其他调度策略</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=使用方案>使用方案<a href=#使用方案 class=hash-link aria-label="Direct link to 使用方案" title="Direct link to 使用方案">​</a></h3>
<p><strong>组合方案：节点亲和性 + 网络拓扑感知调度</strong></p>
<ul>
<li><strong>节点亲和性</strong>：硬约束，确保选择正确的<code>GPU</code>型号（<code>NVIDIA-H100</code>或<code>NVIDIA-GeForce-RTX-4090</code>）</li>
<li><strong>网络拓扑感知调度</strong>：软约束，在满足<code>GPU</code>型号要求的前提下，优化网络拓扑</li>
</ul>
<p><strong>方案优势</strong>：</p>
<ul>
<li>✅ <strong>精确控制</strong>：通过节点亲和性确保<code>GPU</code>型号正确</li>
<li>✅ <strong>性能优化</strong>：通过网络拓扑感知在域内选择网络距离近的节点</li>
<li>✅ <strong>适应性强</strong>：适合大规模、复杂网络拓扑的集群</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=hypernode拓扑设计>HyperNode拓扑设计<a href=#hypernode拓扑设计 class=hash-link aria-label="Direct link to HyperNode拓扑设计" title="Direct link to HyperNode拓扑设计">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=拓扑结构设计>拓扑结构设计<a href=#拓扑结构设计 class=hash-link aria-label="Direct link to 拓扑结构设计" title="Direct link to 拓扑结构设计">​</a></h3>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"/></svg></span>提示</div><div class=admonitionContent_BuS1><p>我们这里以交换机（<code>switch</code>）为单位来描述网络拓扑层级，真实使用的业务场景中，我们可以构造一个虚拟的层级关系（比如按照一定的标签规则，<code>label1</code>为<code>1</code>级、<code>label2</code>为<code>2</code>级...以此类推），不一定要按照真实的交换机为单位来划分。</div></div>
<p>根据我们的网络拓扑情况，设计如下<code>HyperNode</code>拓扑层级：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">tier3                                            eth switch6</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                                  /                                    \</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">tier2                         ib switch4                           eth switch5</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          /                \                    /              \</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">tier1             ib switch0           ib switch1         eth switch2      eth switch3</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  /    |    \          /    |    \        /    |    \      /    |    \ </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">             node0    ...   node63  node64 ... node127  ...   ...   ...   ...  ...   ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>层级说明</strong>：</p>
<ul>
<li><strong>Tier 1</strong>：叶子交换机层，每个叶子交换机下最多<code>64</code>台服务器<!-- -->
<ul>
<li><code>ib switch0</code>、<code>ib switch1</code>：<code>IB</code>交换机，提供高带宽低延迟通信</li>
<li><code>eth switch2</code>、<code>eth switch3</code>：以太网交换机，用于非性能敏感任务</li>
</ul>
</li>
<li><strong>Tier 2</strong>：汇聚交换机层<!-- -->
<ul>
<li><code>ib switch4</code>：<code>IB</code>汇聚交换机，连接<code>ib switch0</code>和<code>ib switch1</code></li>
<li><code>eth switch5</code>：以太网汇聚交换机，连接<code>eth switch2</code>和<code>eth switch3</code></li>
</ul>
</li>
<li><strong>Tier 3</strong>：核心交换机（<code>eth switch6</code>），整个集群的根节点，连接不同类型的汇聚交换机</li>
</ul>
<p><strong>网络拓扑特点</strong>：</p>
<ul>
<li><strong>同一<code>IB</code>交换机内</strong>：延迟<code>&lt;2μs</code>，带宽<code>200Gbps</code>，性能最优</li>
<li><strong>跨<code>IB</code>交换机</strong>：延迟<code>2-5μs</code>，带宽<code>200Gbps</code>，保持高性能</li>
<li><strong><code>IB</code>到以太网</strong>：延迟<code>5-10μs</code>，带宽降至<code>100Gbps</code>（损失<code>~50%</code>），性能显著下降</li>
<li><strong>以太网交换机间</strong>：延迟<code>>10μs</code>，带宽<code>10-100Gbps</code>（损失<code>50-95%</code>），不适合高性能任务</li>
</ul>
<p><strong>PD分离部署说明</strong>：</p>
<ul>
<li><code>Prefill</code>服务：<code>12</code>个<code>Pod</code>，需要选择<code>NVIDIA-H100</code>节点，<strong>必须部署在<code>IB</code>交换机下</strong>（<code>ib switch0</code>或<code>ib switch1</code>）</li>
<li><code>Decode</code>服务：<code>12</code>个<code>Pod</code>，需要选择<code>NVIDIA-GeForce-RTX-4090</code>节点，<strong>必须部署在<code>IB</code>交换机下</strong>（<code>ib switch0</code>或<code>ib switch1</code>）</li>
<li>两个服务的所有节点应尽量在同一<code>IB</code>汇聚交换机（<code>ib switch4</code>）下，以：<!-- -->
<ul>
<li>保持<code>200Gbps</code>带宽，避免带宽损失</li>
<li>保持<code>2-5μs</code>延迟，避免跨交换机类型通信</li>
<li>确保<code>KV Cache</code>传输效率最优</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=hypernode配置>HyperNode配置<a href=#hypernode配置 class=hash-link aria-label="Direct link to HyperNode配置" title="Direct link to HyperNode配置">​</a></h3>
<p>为了支持网络拓扑感知调度，我们需要创建<code>HyperNode</code>资源来描述集群的网络拓扑（这里使用手动维护<code>HyperNode</code>的方式）。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"/></svg></span>提示</div><div class=admonitionContent_BuS1><p>如果不基于以太网节点之间的网络拓扑实现感知调度，可以不创建以太网的<code>HyperNode</code>以简化维护成本。本示例为保证完整性，为所有交换机创建了<code>HyperNode</code>配置。</div></div>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># Tier 1: IB叶子交换机 ib-switch0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> topology.volcano.sh/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> HyperNode</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ib</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">tier</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">members</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">labelMatch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">topology.kubernetes.io/switch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ib</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">topology.kubernetes.io/switch-type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ib  </span><span class="token comment" style=color:#8292a2;font-style:italic># IB交换机标识</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>---</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># Tier 1: IB叶子交换机 ib-switch1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> topology.volcano.sh/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> HyperNode</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ib</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">tier</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">members</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">labelMatch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">topology.kubernetes.io/switch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ib</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">topology.kubernetes.io/switch-type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ib</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>---</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># Tier 1: 以太网叶子交换机 eth-switch2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> topology.volcano.sh/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> HyperNode</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> eth</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch2</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">tier</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">members</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">labelMatch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">topology.kubernetes.io/switch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> eth</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch2</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">topology.kubernetes.io/switch-type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ethernet  </span><span class="token comment" style=color:#8292a2;font-style:italic># 以太网交换机标识</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>---</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># Tier 1: 以太网叶子交换机 eth-switch3</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> topology.volcano.sh/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> HyperNode</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> eth</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch3</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">tier</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">members</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">labelMatch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">topology.kubernetes.io/switch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> eth</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch3</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">topology.kubernetes.io/switch-type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ethernet</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>---</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># Tier 2: IB汇聚交换机 ib-switch4（连接 ib-switch0 和 ib-switch1）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> topology.volcano.sh/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> HyperNode</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ib</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch4</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">tier</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">members</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> HyperNode</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">exactMatch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ib</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> HyperNode</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">exactMatch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ib</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>---</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># Tier 2: 以太网汇聚交换机 eth-switch5（连接 eth-switch2 和 eth-switch3）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> topology.volcano.sh/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> HyperNode</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> eth</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch5</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">tier</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">members</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> HyperNode</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">exactMatch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> eth</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch2</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> HyperNode</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">exactMatch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> eth</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch3</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>---</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># Tier 3: 核心交换机 eth-switch6（集群根节点）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> topology.volcano.sh/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> HyperNode</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> eth</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch6</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">tier</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>3</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">members</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> HyperNode</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">exactMatch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ib</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch4</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> HyperNode</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">exactMatch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> eth</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">switch5</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>配置说明</strong>：</p>
<ul>
<li><strong>IB交换机</strong>（<code>ib-switch0</code>、<code>ib-switch1</code>）：通过标签选择器关联<code>IB</code>交换机下的节点，用于高性能任务</li>
<li><strong>以太网交换机</strong>（<code>eth-switch2</code>、<code>eth-switch3</code>）：通过标签选择器关联以太网交换机下的节点，用于非性能敏感任务</li>
<li><strong>IB汇聚交换机</strong>（<code>ib-switch4</code>）：连接两个<code>IB</code>叶子交换机，保持<code>200Gbps</code>带宽</li>
<li><strong>以太网汇聚交换机</strong>（<code>eth-switch5</code>）：连接两个以太网叶子交换机</li>
<li><strong>核心交换机</strong>（<code>eth-switch6</code>）：连接不同类型的汇聚交换机，形成完整的拓扑树</li>
</ul>
<p><strong>重要提示</strong>：</p>
<ul>
<li><code>PD</code>分离服务应部署在<code>IB</code>交换机下的节点，通过节点标签<code>topology.kubernetes.io/switch-type: ib</code>进行筛选</li>
<li>避免将高性能任务调度到以太网交换机下的节点，以免带宽损失和延迟增加</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=方案实施>方案实施<a href=#方案实施 class=hash-link aria-label="Direct link to 方案实施" title="Direct link to 方案实施">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=为节点打标签>为节点打标签<a href=#为节点打标签 class=hash-link aria-label="Direct link to 为节点打标签" title="Direct link to 为节点打标签">​</a></h3>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"/></svg></span>提示</div><div class=admonitionContent_BuS1><p>以下脚本仅做示例，主要阐述在使用网络拓扑感知调度之前，节点打标也是很重要一个环节。</div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 为 IB switch0 下的节点打标签（假设 node0-node63）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> </span><span class="token for-or-select variable" style=color:#f8f8f2>i</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>63</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>do</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  kubectl label </span><span class="token function" style=color:#e6db74>node</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>node</span><span class="token variable" style=color:#f8f8f2>$i</span><span class="token plain"> topology.kubernetes.io/switch</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">ib-switch0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  kubectl label </span><span class="token function" style=color:#e6db74>node</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>node</span><span class="token variable" style=color:#f8f8f2>$i</span><span class="token plain"> topology.kubernetes.io/switch-type</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">ib</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>done</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 为 IB switch1 下的节点打标签（假设 node64-node127）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> </span><span class="token for-or-select variable" style=color:#f8f8f2>i</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token number" style=color:#ae81ff>64</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>127</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>do</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  kubectl label </span><span class="token function" style=color:#e6db74>node</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>node</span><span class="token variable" style=color:#f8f8f2>$i</span><span class="token plain"> topology.kubernetes.io/switch</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">ib-switch1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  kubectl label </span><span class="token function" style=color:#e6db74>node</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>node</span><span class="token variable" style=color:#f8f8f2>$i</span><span class="token plain"> topology.kubernetes.io/switch-type</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">ib</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>done</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 为以太网 switch2 下的节点打标签（假设 node128-node191）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> </span><span class="token for-or-select variable" style=color:#f8f8f2>i</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token number" style=color:#ae81ff>128</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>191</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>do</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  kubectl label </span><span class="token function" style=color:#e6db74>node</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>node</span><span class="token variable" style=color:#f8f8f2>$i</span><span class="token plain"> topology.kubernetes.io/switch</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">eth-switch2</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  kubectl label </span><span class="token function" style=color:#e6db74>node</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>node</span><span class="token variable" style=color:#f8f8f2>$i</span><span class="token plain"> topology.kubernetes.io/switch-type</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">ethernet</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>done</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 为以太网 switch3 下的节点打标签（假设 node192-node255）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> </span><span class="token for-or-select variable" style=color:#f8f8f2>i</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token number" style=color:#ae81ff>192</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token number" style=color:#ae81ff>255</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>do</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  kubectl label </span><span class="token function" style=color:#e6db74>node</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>node</span><span class="token variable" style=color:#f8f8f2>$i</span><span class="token plain"> topology.kubernetes.io/switch</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">eth-switch3</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  kubectl label </span><span class="token function" style=color:#e6db74>node</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>node</span><span class="token variable" style=color:#f8f8f2>$i</span><span class="token plain"> topology.kubernetes.io/switch-type</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">ethernet</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>done</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 验证标签</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl get nodes </span><span class="token parameter variable" style=color:#f8f8f2>-L</span><span class="token plain"> topology.kubernetes.io/switch,topology.kubernetes.io/switch-type</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>标签说明</strong>：</p>
<ul>
<li><code>topology.kubernetes.io/switch</code>：标识节点所属的叶子交换机（<code>ib-switch0</code>、<code>ib-switch1</code>、<code>eth-switch2</code>、<code>eth-switch3</code>）</li>
<li><code>topology.kubernetes.io/switch-type</code>：标识交换机类型（<code>ib</code>或<code>ethernet</code>）</li>
</ul>
<p><strong>重要提示</strong>：</p>
<ul>
<li><code>PD</code>分离服务的节点必须在<code>IB</code>交换机下（<code>topology.kubernetes.io/switch-type=ib</code>）</li>
<li>以太网交换机下的节点不适合高性能推理任务，应用于非性能敏感任务</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=prefill服务配置>Prefill服务配置<a href=#prefill服务配置 class=hash-link aria-label="Direct link to Prefill服务配置" title="Direct link to Prefill服务配置">​</a></h3>
<p><strong>需求</strong>：部署<code>Prefill</code>服务，<code>12</code>个<code>Pod</code>，选择<code>NVIDIA-H100</code>节点，尽量集中在少数交换机下。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"/></svg></span>提示</div><div class=admonitionContent_BuS1><p>这里使用<code>Volcano Job</code>来演示<code>Prefill</code>服务的部署，若使用<code>Deployment</code>部署，相关配置一致。</div></div>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> batch.volcano.sh/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Job</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">prefill</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">service</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">minAvailable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>12</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># Gang调度：12个Pod必须同时满足</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">schedulerName</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> volcano</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">queue</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> default</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 网络拓扑感知调度：优化节点选择，尽量集中在少数交换机下</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">networkTopology</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">mode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> hard  </span><span class="token comment" style=color:#8292a2;font-style:italic># 硬约束，必须按照highestTierAllowed选择网络距离近的节点</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">highestTierAllowed</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 允许在Tier 2（汇聚交换机）内调度</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">tasks</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>12</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> prefill</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">worker</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token comment" style=color:#8292a2;font-style:italic># 节点亲和性：必须选择IB交换机下的H100节点（硬约束）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">affinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">nodeAffinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia.com/gpu.product</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">H100  </span><span class="token comment" style=color:#8292a2;font-style:italic># 必须在H100节点</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> topology.kubernetes.io/switch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">type</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> ib  </span><span class="token comment" style=color:#8292a2;font-style:italic># 必须在IB交换机下</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic># Pod反亲和性：尽量将Pod分散到不同节点（软约束）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">podAntiAffinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">weight</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">podAffinityTerm</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token key atrule">labelSelector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> volcano.sh/job</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">name</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">prefill</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">service</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token key atrule">topologyKey</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> kubernetes.io/hostname</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> prefill</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">service</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> vllm/vllm</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">latest</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"python"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"-m"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"vllm.entrypoints.api_server"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">args</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"--model=/models/llama-70b"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"--tensor-parallel-size=1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"--pipeline-parallel-size=1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"--enable-prefix-caching"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NCCL_IB_DISABLE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"0"</span><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 启用IB网络</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NCCL_SOCKET_IFNAME</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"ib0"</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 指定IB网络接口</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NCCL_IB_HCA</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"mlx5"</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic># 指定IB设备</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> OnFailure</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>关键配置说明</strong>：</p>
<ul>
<li><code>minAvailable: 12</code>：Gang调度，确保<code>12</code>个<code>Pod</code>同时满足才开始调度</li>
<li><code>nodeAffinity</code>：硬约束，确保所有<code>Prefill Pod</code>调度到<code>IB</code>交换机下的<code>NVIDIA-H100</code>节点<!-- -->
<ul>
<li><code>nvidia.com/gpu.product: NVIDIA-H100</code>：选择<code>NVIDIA-H100</code>节点</li>
<li><code>topology.kubernetes.io/switch-type: ib</code>：<strong>必须在<code>IB</code>交换机下</strong></li>
</ul>
</li>
<li><code>networkTopology.mode: hard</code>：硬约束，必须按照<code>highestTierAllowed</code>选择网络距离近的节点</li>
<li><code>networkTopology.highestTierAllowed: 2</code>：允许在<code>Tier 2</code>（<code>IB</code>汇聚交换机）内调度</li>
<li><code>podAntiAffinity</code>：软约束，尽量将<code>Pod</code>分散到不同节点</li>
<li><code>NCCL_IB_DISABLE=0</code>：启用<code>IB</code>网络</li>
</ul>
<p><strong>调度效果（网络拓扑感知的优势）</strong>：</p>
<p>如果<strong>不使用</strong>网络拓扑感知调度或未限制交换机类型：</p>
<ul>
<li>❌ <code>12</code>个<code>Pod</code>可能分散在<code>IB</code>和以太网交换机下</li>
<li>❌ <strong>延迟问题</strong>：跨交换机类型通信延迟可能达到<code>5-10μs</code></li>
<li>❌ <strong>带宽损失</strong>：跨交换机类型带宽降至<code>100Gbps</code>，损失<code>50%</code></li>
<li>❌ <code>KV Cache</code>传输效率严重下降，吞吐量可能下降<code>30-50%</code></li>
</ul>
<p>使用网络拓扑感知调度 + <code>IB</code>交换机约束后：</p>
<ul>
<li>✅ <code>12</code>个<code>Prefill Pod</code>全部部署在<code>IB</code>交换机下（<code>ib-switch0</code>和<code>ib-switch1</code>）</li>
<li>✅ 大部分<code>Pod</code>在同一叶子交换机下，通信延迟<code>&lt;2μs</code>，带宽<code>200Gbps</code></li>
<li>✅ 少数跨叶子交换机的通信也在同一<code>IB</code>汇聚交换机（<code>ib-switch4</code>）下，延迟<code>2-5μs</code>，带宽<code>200Gbps</code></li>
<li>✅ <strong>避免跨交换机类型通信，无带宽损失，网络性能最优</strong></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=decode服务配置>Decode服务配置<a href=#decode服务配置 class=hash-link aria-label="Direct link to Decode服务配置" title="Direct link to Decode服务配置">​</a></h3>
<p><strong>需求</strong>：部署<code>Decode</code>服务，<code>12</code>个<code>Pod</code>，选择<code>NVIDIA-GeForce-RTX-4090</code>节点，尽量集中在少数交换机下，并与<code>Prefill</code>服务在同一汇聚交换机下。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"/></svg></span>提示</div><div class=admonitionContent_BuS1><p>这里使用<code>Volcano Job</code>来演示<code>Decode</code>服务的部署，若使用<code>Deployment</code>部署，相关配置一致。</div></div>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> batch.volcano.sh/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Job</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">decode</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">service</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">minAvailable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>12</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># Gang调度：12个Pod必须同时满足</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">schedulerName</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> volcano</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">queue</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> default</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 网络拓扑感知调度：优化节点选择，尽量集中在少数交换机下</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">networkTopology</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">mode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> hard  </span><span class="token comment" style=color:#8292a2;font-style:italic># 硬约束，必须按照highestTierAllowed选择网络距离近的节点</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">highestTierAllowed</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 允许在Tier 2（汇聚交换机）内调度</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">tasks</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>12</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> decode</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">worker</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token comment" style=color:#8292a2;font-style:italic># 节点亲和性：必须选择IB交换机下的RTX 4090节点（硬约束）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">affinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">nodeAffinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia.com/gpu.product</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">GeForce</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">RTX</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token number" style=color:#ae81ff>4090</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 必须在RTX 4090节点</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> topology.kubernetes.io/switch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">type</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> ib  </span><span class="token comment" style=color:#8292a2;font-style:italic># 必须在IB交换机下</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic># Pod反亲和性：尽量将Pod分散到不同节点（软约束）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">podAntiAffinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">weight</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">podAffinityTerm</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token key atrule">labelSelector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> volcano.sh/job</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">name</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">decode</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">service</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token key atrule">topologyKey</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> kubernetes.io/hostname</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> decode</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">service</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> vllm/vllm</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">latest</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"python"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"-m"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"vllm.entrypoints.api_server"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">args</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"--model=/models/llama-70b"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"--tensor-parallel-size=1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"--pipeline-parallel-size=1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"--enable-prefix-caching"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NCCL_IB_DISABLE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"0"</span><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 启用IB网络</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NCCL_SOCKET_IFNAME</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"ib0"</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 指定IB网络接口</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NCCL_IB_HCA</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"mlx5"</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic># 指定IB设备</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> OnFailure</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>关键配置说明</strong>：</p>
<ul>
<li><code>minAvailable: 12</code>：<code>Gang</code>调度，确保<code>12</code>个<code>Pod</code>同时满足才开始调度</li>
<li><code>nodeAffinity</code>：硬约束，确保所有<code>Decode Pod</code>调度到<code>IB</code>交换机下的<code>NVIDIA-GeForce-RTX-4090</code>节点<!-- -->
<ul>
<li><code>nvidia.com/gpu.product: NVIDIA-GeForce-RTX-4090</code>：选择<code>NVIDIA-GeForce-RTX-4090</code>节点</li>
<li><code>topology.kubernetes.io/switch-type: ib</code>：<strong>必须在<code>IB</code>交换机下</strong></li>
</ul>
</li>
<li><code>networkTopology.mode: hard</code>：硬约束，必须按照<code>highestTierAllowed</code>选择网络距离近的节点</li>
<li><code>networkTopology.highestTierAllowed: 2</code>：允许在<code>Tier 2</code>（<code>IB</code>汇聚交换机）内调度</li>
<li><code>podAntiAffinity</code>：软约束，尽量将<code>Pod</code>分散到不同节点</li>
</ul>
<p><strong>调度效果（PD分离的完整优化）</strong>：</p>
<p>使用网络拓扑感知调度 + <code>IB</code>交换机约束后：</p>
<ul>
<li>✅ <code>12</code>个<code>Decode Pod</code>也全部部署在<code>IB</code>交换机下（<code>ib-switch0</code>和<code>ib-switch1</code>）</li>
<li>✅ <code>Prefill</code>和<code>Decode</code>之间的<code>KV Cache</code>传输主要在同一<code>IB</code>交换机（<code>ib-switch0</code>和<code>ib-switch1</code>），或者汇聚交换机（<code>ib-switch4</code>）下，延迟<code>2-5μs</code>，带宽<code>200Gbps</code></li>
<li>✅ <strong>避免跨交换机类型的<code>KV Cache</code>传输，无带宽损失</strong></li>
<li>✅ 整体推理性能最优，吞吐量最高</li>
</ul>
<p><strong>与简单亲和性调度的对比</strong>：</p>
<table><thead><tr><th>对比项<th>简单亲和性调度<th>网络拓扑感知 + IB约束<tbody><tr><td><code>Prefill Pod</code>分布<td>可能分散在<code>IB</code>和以太网交换机<td>集中在<code>IB</code>交换机（<code>ib-switch0/1</code>）<tr><td><code>Decode Pod</code>分布<td>可能分散在<code>IB</code>和以太网交换机<td>集中在<code>IB</code>交换机（<code>ib-switch0/1</code>）<tr><td><code>Prefill</code>内部通信延迟<td><code>2-10μs</code>（可能跨交换机类型）<td><code>&lt;5μs</code>（<code>IB</code>交换机内）<tr><td><code>Prefill</code>内部通信带宽<td><code>100-200Gbps</code>（可能损失<code>50%</code>）<td><code>200Gbps</code>（无损失）<tr><td><code>Decode</code>内部通信延迟<td><code>2-10μs</code>（可能跨交换机类型）<td><code>&lt;5μs</code>（<code>IB</code>交换机内）<tr><td><code>Decode</code>内部通信带宽<td><code>100-200Gbps</code>（可能损失<code>50%</code>）<td><code>200Gbps</code>（无损失）<tr><td><code>Prefill-Decode</code>通信延迟<td><code>5-10μs</code>（可能跨交换机类型）<td><code>2-5μs</code>（同一<code>IB</code>汇聚交换机）<tr><td><code>Prefill-Decode</code>通信带宽<td><code>100Gbps</code>（损失<code>50%</code>）<td><code>200Gbps</code>（无损失）<tr><td>整体吞吐量<td>下降<code>30-50%</code><td>最优，无损失</table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=总结>总结<a href=#总结 class=hash-link aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h2>
<p><strong>网络拓扑感知调度在大规模集群中的核心价值</strong>：</p>
<ol>
<li>
<p><strong>拓扑感知的性能优化</strong>：</p>
<ul>
<li>✅ 在大规模混合网络集群（<code>7</code>个交换机，其中<code>3</code>个<code>IB</code>交换机、<code>4</code>个以太网交换机，最多<code>384</code>台服务器）中，网络拓扑感知调度能够显著优化节点选择</li>
<li>✅ 通过<code>IB</code>交换机类型约束，确保所有高性能任务部署在<code>IB</code>交换机下</li>
<li>✅ <code>12</code>个<code>Prefill Pod</code>和<code>12</code>个<code>Decode Pod</code>集中在<code>IB</code>交换机下，避免跨交换机类型通信</li>
<li>✅ 通过<code>highestTierAllowed: 2</code>限制，确保所有<code>Pod</code>在同一<code>IB</code>汇聚交换机（<code>Tier 2</code>）下</li>
<li>✅ <strong>延迟优化</strong>：从可能的<code>5-10μs</code>降低到<code>2-5μs</code>，性能提升<code>2-5</code>倍</li>
<li>✅ <strong>带宽优化</strong>：保持<code>200Gbps</code>带宽，避免<code>50%</code>的带宽损失，吞吐量提升<code>30-50%</code></li>
</ul>
</li>
<li>
<p><strong>解决简单亲和性调度的局限性</strong>：</p>
<ul>
<li>✅ 简单的节点亲和性只能保证<code>GPU</code>型号正确，无法感知网络拓扑和交换机类型</li>
<li>✅ 网络拓扑感知调度能够理解节点之间的网络距离和交换机类型，优先选择网络距离近且交换机类型匹配的节点</li>
<li>✅ 在满足<code>GPU</code>型号要求的前提下，进一步优化网络性能，避免跨交换机类型的带宽损失</li>
</ul>
</li>
<li>
<p><strong>资源精细化利用</strong>：</p>
<ul>
<li>✅ <code>Prefill</code>服务使用高性能<code>NVIDIA-H100 GPU</code>，满足计算密集型需求</li>
<li>✅ <code>Decode</code>服务使用性价比高的<code>NVIDIA-GeForce-RTX-4090 GPU</code>，满足访存密集型需求</li>
<li>✅ 充分发挥不同<code>GPU</code>型号的优势，降低整体成本</li>
</ul>
</li>
<li>
<p><strong>适应混合网络拓扑</strong>：</p>
<ul>
<li>✅ 支持<code>IB</code>和以太网混合的多层级网络拓扑（叶子交换机、汇聚交换机、核心交换机）</li>
<li>✅ 通过<code>HyperNode</code>灵活定义网络拓扑结构，支持不同交换机类型的标识</li>
<li>✅ 适合大规模、复杂混合网络拓扑的集群环境</li>
<li>✅ 能够根据任务特性选择合适的交换机类型（高性能任务选择<code>IB</code>，非性能敏感任务选择以太网）</li>
</ul>
</li>
<li>
<p><strong>灵活扩展</strong>：</p>
<ul>
<li>✅ 支持多个<code>PD</code>分离服务实例</li>
<li>✅ 可以根据负载动态调整<code>Prefill</code>和<code>Decode</code>服务规模</li>
<li>✅ 易于水平扩展，适应业务增长</li>
</ul>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=参考资料>参考资料<a href=#参考资料 class=hash-link aria-label="Direct link to 参考资料" title="Direct link to 参考资料">​</a></h2>
<ul>
<li><a href=https://volcano.sh/zh/docs/network_topology_aware_scheduling/ target=_blank rel="noopener noreferrer">Volcano官方文档 - 网络拓扑感知调度</a></li>
<li><a href=https://github.com/volcano-sh/volcano/blob/master/docs/design/Network%20Topology%20Aware%20Scheduling.md target=_blank rel="noopener noreferrer">Volcano GitHub - Network Topology Aware Scheduling设计文档</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/cloud-native/volcano-network-topology-scheduling-test><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Volcano网络拓扑感知调度测试</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/cloud-native/volcano-extension-development><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Volcano扩展开发</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#场景背景 class="table-of-contents__link toc-highlight">场景背景</a><ul><li><a href=#基础设施环境 class="table-of-contents__link toc-highlight">基础设施环境</a><li><a href=#pd分离推理场景介绍 class="table-of-contents__link toc-highlight">PD分离推理场景介绍</a><li><a href=#业务需求 class="table-of-contents__link toc-highlight">业务需求</a></ul><li><a href=#技术方案分析 class="table-of-contents__link toc-highlight">技术方案分析</a><ul><li><a href=#简单亲和性调度的局限性 class="table-of-contents__link toc-highlight">简单亲和性调度的局限性</a><li><a href=#网络拓扑感知调度的优势 class="table-of-contents__link toc-highlight">网络拓扑感知调度的优势</a><li><a href=#使用方案 class="table-of-contents__link toc-highlight">使用方案</a></ul><li><a href=#hypernode拓扑设计 class="table-of-contents__link toc-highlight">HyperNode拓扑设计</a><ul><li><a href=#拓扑结构设计 class="table-of-contents__link toc-highlight">拓扑结构设计</a><li><a href=#hypernode配置 class="table-of-contents__link toc-highlight">HyperNode配置</a></ul><li><a href=#方案实施 class="table-of-contents__link toc-highlight">方案实施</a><ul><li><a href=#为节点打标签 class="table-of-contents__link toc-highlight">为节点打标签</a><li><a href=#prefill服务配置 class="table-of-contents__link toc-highlight">Prefill服务配置</a><li><a href=#decode服务配置 class="table-of-contents__link toc-highlight">Decode服务配置</a></ul><li><a href=#总结 class="table-of-contents__link toc-highlight">总结</a><li><a href=#参考资料 class="table-of-contents__link toc-highlight">参考资料</a></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2026 johng.cn</div></div></div></footer></div>