<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/云原生/Argo Workflow/Argo Workflow介绍" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Argo Workflow介绍 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/cloud-native/argo-workflow-introduction><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Argo Workflow介绍 | John's Blog"><meta data-rh=true name=description content="介绍 Argo Workflow 的基本概念、核心特性和使用场景，帮助读者理解这个基于 Kubernetes 的工作流引擎"><meta data-rh=true property=og:description content="介绍 Argo Workflow 的基本概念、核心特性和使用场景，帮助读者理解这个基于 Kubernetes 的工作流引擎"><meta data-rh=true name=keywords content="Argo Workflow,工作流,容器编排,Kubernetes,流程自动化,任务编排"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/cloud-native/argo-workflow-introduction><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/argo-workflow-introduction hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/argo-workflow-introduction hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><script src=https://cdn.wwads.cn/js/makemoney.js async></script><link rel=stylesheet href=/assets/css/styles.96de5670.css><script src=/assets/js/runtime~main.4e3fc753.js defer></script><script src=/assets/js/main.1dfd30ac.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/programming>开发语言</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" sidebarid=mainSidebar href=/cloud-native>云原生</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/ai>AI技术</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/observability>可观测性</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/cloud-native>云原生</a><button aria-label="Collapse sidebar category '云原生'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kubernetes>Kubernetes</a><button aria-label="Expand sidebar category 'Kubernetes'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/cloud-native/argo-workflow>Argo Workflow</a><button aria-label="Collapse sidebar category 'Argo Workflow'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/cloud-native/argo-workflow-introduction>Argo Workflow介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/argo-workflow-source-code>Argo Workflow源码解析</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/argo-workflow-faq>Argo Workflow常见问题</a><button aria-label="Expand sidebar category 'Argo Workflow常见问题'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/argo-workflow-development-setup>Argo Workflow开发环境搭建</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/volcano>Volcano</a><button aria-label="Expand sidebar category 'Volcano'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/dragonfly>Dragonfly介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/docker-containerd-commands>Docker和Containerd常用命令对比</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-kind>使用Kubernetes Kind搭建本地测试集群</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernettes-kind-mock-ai-test-cluster>使用Kubernetes Kind模拟AI算力测试集群</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native><span itemprop=name>云原生</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native/argo-workflow><span itemprop=name>Argo Workflow</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Argo Workflow介绍</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=一什么是流水线>一、什么是流水线<a href=#一什么是流水线 class=hash-link aria-label="Direct link to 一、什么是流水线" title="Direct link to 一、什么是流水线">​</a></h2>
<p>在计算机中，<strong>流水线是把一个重复的过程分解为若干个子过程，使每个子过程与其他子过程并行进行的技术，也叫 Pipeline</strong>。由于这种工作方式与工厂中的生产流水线十分相似， 因此也被称为流水线技术。从本质上讲，流水线技术是一种时间并行技术。以“构建镜像”过程为例：</p>
<p><img decoding=async loading=lazy src=/assets/images/3710404115-5fffb6e1af9bc-70e06260f0ca2cabc141f3124d36621f.png width=645 height=365 class=img_ev3q></p>
<p>在每一次构建镜像中，我们都需要拉下代码仓库中的代码，进行代码编译，构建镜像，最后推往镜像仓库。在每一次代码更改过后，这一过程都是不变的。使用流水线工具可以极大的提升这一过程的效率，只需要进行简单的配置便可以轻松的完成重复性的工作。这样的过程也被称之为 CI。</p>
<p>上图流程中使用的是 Jenkins。Jenkins 作为老牌流水线框架被大家所熟知。在云原生时代，Jenkins 推出了 Jenkins X 作为基于 Kubernetes 的新一代流水线，另外云原生时代还诞生了两大流水线框架—— Argo 和 Tekton。本文就详细介绍了 Argo 的相关内容。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=二argo是什么>二、Argo是什么<a href=#二argo是什么 class=hash-link aria-label="Direct link to 二、Argo是什么" title="Direct link to 二、Argo是什么">​</a></h2>
<p><code>Argo Workflows</code> 是一个开源的容器原生的工作流引擎，可在 Kubernetes 上编排并行作业。Argo Workflows 通过 Kubernetes CRD方式实现。Argo 基于 Kubernetes，可以直接使用 <code>kubectl</code> 安装，安装的组件主要包括了一些 CRD 以及对应的 controller 和一个 server。</p>
<p><img decoding=async loading=lazy src=/assets/images/974227319-5fffb6fd58599-ba755b4db8add886a2b0bf828d69d0e0.png width=1080 height=119 class=img_ev3q></p>
<blockquote>
<p>注意，上述安装只会执行同 namespace 内的 Workflow，cluster install 详见文档。文档地址：<a href=https://argoproj.github.io/argo-workflows/ target=_blank rel="noopener noreferrer">https://argoproj.github.io/argo-workflows/</a></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=三三级定义>三、三级定义<a href=#三三级定义 class=hash-link aria-label="Direct link to 三、三级定义" title="Direct link to 三、三级定义">​</a></h2>
<p>要了解 Argo 定义的 CRD，先从其中的三级定义入手。概念上的从大到小分别为 WorkflowTemplate、Workflow、Template，这些资源的命名有些相似，要注意分辨。<a href=https://argoproj.github.io/argo-workflows/workflow-concepts/ target=_blank rel="noopener noreferrer">https://argoproj.github.io/argo-workflows/workflow-concepts/</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=1template>1、Template<a href=#1template class=hash-link aria-label="Direct link to 1、Template" title="Direct link to 1、Template">​</a></h3>
<p>从最简单的 template 说起，一个 template 有多种类型，分别为 <code>container</code>、<code>script</code>、<code>dag</code>、<code>steps</code>、<code>resource</code> 以及 <code>suspend</code>**。**对于 template，我们可以简单的将其理解为一个 Pod ——container/script/resource 类型的 template 都会去实际控制一个 Pod，而 dag/steps 类型的 template 则是由多个基础类型的 template （container/script/resource）组成的。</p>
<ul>
<li><strong>container</strong>：最常见的模板类型，与 Kubernetes container spec 保持一致。</li>
<li><strong>script</strong>：该类型基于 Container，支持用户在 template 定义一段脚本，另有一个 Source 字段来表示脚本的运行环境。</li>
<li><strong>resource</strong>：该类型支持我们在 template 中对 kubernetes 的资源进行操作，有一个 action 字段可以指定操作类型，如 create, apply, delete 等，并且支持设定相关的成功与失败条件用于判断该 template 的成功与失败。</li>
<li><strong>suspend</strong>：Suspend template 将在一段时间内或在手动恢复执行之前暂停执行。可以从 CLI （使用 argo resume）、API 或 UI 恢复执行。</li>
<li><strong>steps</strong>：Steps Template 允许用户以一系列步骤定义任务。在 Steps 中，[--] 代表顺序执行，[-] 代表并行执行。</li>
<li><strong>dag</strong>：DAG template 允许用户将任务定义为带依赖的有向无环图。在 DAG 中，通过 dependencies设置在特定任务开始之前必须完成的其他任务。没有任何依赖项的任务将立即运行。有关 DAG 的详细逻辑可见源码 <a href=https://github.com/argoproj/argo/blob/master/workflow/controller/dag.go#L204 target=_blank rel="noopener noreferrer">https://github.com/argoproj/a...</a>。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=2workflow>2、Workflow<a href=#2workflow class=hash-link aria-label="Direct link to 2、Workflow" title="Direct link to 2、Workflow">​</a></h3>
<p>在一个 Workflow 中，其 spec 中有一个名为 templates 的字段，在其中至少需要一个 template 作为其组成的任务。</p>
<p>一个最简单的 hello world 例子如下：</p>
<p><img decoding=async loading=lazy src=/assets/images/2478719909-5fffb73379d3c-531378f7560a980fb79a3ecdb26186e2.png width=1080 height=671 class=img_ev3q></p>
<p>在这个例子中，该 Workflow 的 templates 字段中指定了一个类型为 container 的 template，使用了 whalesay 镜像。</p>
<p>下面是一个稍微复杂的 workflow：</p>
<p><img decoding=async loading=lazy src=/assets/images/2043671593-5fffb84536c0d-1d77831ab9ef9de2681fd18521885279.png width=1080 height=1052 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=3workflowtemplate>3、WorkflowTemplate<a href=#3workflowtemplate class=hash-link aria-label="Direct link to 3、WorkflowTemplate" title="Direct link to 3、WorkflowTemplate">​</a></h3>
<p>WorkflowTemplate 相当于 Workflow 的模板库，和 Workflow 一样，也由 template 组成。用户在创建完 WorkflowTemplate 后，可以通过直接提交它们来执行 Workflow。</p>
<p><img decoding=async loading=lazy src=/assets/images/2381840871-5fffb856062a4-4b35ec38ef44f0ebc0f74e7249c746bb.png width=1080 height=906 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=4workflow-overview>4、Workflow Overview<a href=#4workflow-overview class=hash-link aria-label="Direct link to 4、Workflow Overview" title="Direct link to 4、Workflow Overview">​</a></h3>
<p><img decoding=async loading=lazy src=/assets/images/3008190936-5fffb8654df09-7ceafc3f619037682f6ba60c6063b339.png width=1020 height=780 class=img_ev3q></p>
<p>在了解了 Argo 的三级定义后，我们首先来深入一下 Argo 中最为关键的定义，Workflow。<strong>Workflow 是 Argo 中最重要的资源，有两个重要的功能：</strong></p>
<ul>
<li><strong>定义了要执行的工作流。</strong></li>
<li><strong>存储了工作流的状态。</strong></li>
</ul>
<p>由于这些双重职责，Workflow 应该被视为一个 Active 的对象。它不仅是一个静态定义，也是上述定义的一个“实例”。</p>
<p>**Workflow Template 的定义与 Workflow 几乎一致，除了类型不同。**正因为 Workflow 既可以是一个定义也可以是一个实例，所以才需要 WorkflowTemplate 作为 Workflow 的模板，WorkflowTemplate 在定义后可以通过提交（Submit）来创建一个 Workflow。</p>
<p>而 <strong>Workflow</strong> 由一个 entrypoint 及一系列 template 组成，entrypoint 定义了这个 workflow 执行的入口，而 template 会实际去执行一个 Pod，其中，用户定义的内容会在 Pod 中以 Main Container 体现。此外，还有两个 <strong>Sidecar</strong> 来辅助运行。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=四sidecar>四、Sidecar<a href=#四sidecar class=hash-link aria-label="Direct link to 四、Sidecar" title="Direct link to 四、Sidecar">​</a></h2>
<p>在 Argo 中，这些 Sidecar 的镜像都是 <strong><code>argoexec</code></strong>。Argo 通过这个 executor 来完成一些流程控制。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=1init>1、Init<a href=#1init class=hash-link aria-label="Direct link to 1、Init" title="Direct link to 1、Init">​</a></h3>
<p>当用户的 template 中需要使用到 inputs 中的 <code>artifact</code> 或者是 script 类型时（script 类型需要注入脚本），Argo 都会为这个 pod 加上一个 <strong>InitContainer</strong> —— 其镜像为 argoexec，命令是 argoexec init。在这个 <code>Init Container</code> 中，主要工作就是加载 <code>artifact</code>：</p>
<p><img decoding=async loading=lazy src=/assets/images/2657741167-5fffb8c009e45-4db8db8968f03a5d0ba268d4dda1f7a6.png width=940 height=916 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=2wait>2、Wait<a href=#2wait class=hash-link aria-label="Direct link to 2、Wait" title="Direct link to 2、Wait">​</a></h3>
<p>除了 Resource 类型外的 template，Argo 都会注入一个 Wait Container，用于等待 Main Container 的完成并结束所有 Sidecar。这个 Wait Container 的镜像同样为 <code>argoexec</code>，命令是 <code>argoexec wait</code>。（Resource 类型的不需要是因为 Resource 类型的 template 直接使用 <code>argoexec</code> 作为 Main Container 运行）</p>
<p><img decoding=async loading=lazy src=/assets/images/143124495-5fffb8cd0ce29-145b0f57687be3d889aa4efd4979cbae.png width=1080 height=1623 class=img_ev3q></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=五inputs-and-outputs>五、Inputs and Outputs<a href=#五inputs-and-outputs class=hash-link aria-label="Direct link to 五、Inputs and Outputs" title="Direct link to 五、Inputs and Outputs">​</a></h2>
<p>在运行 Workflow 时，一个常见的场景是输出产物的传递。通常，一个 Step 的输出产物可以用作后续步骤的输入产物。<strong>在 Argo 中，产物可以通过 Artifact 或是 Parameter 传递。</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=1artifact>1、Artifact<a href=#1artifact class=hash-link aria-label="Direct link to 1、Artifact" title="Direct link to 1、Artifact">​</a></h3>
<p>**要使用 Argo 的 Artifact，首先必须配置和使用 Artifact 存储仓库。**具体的配置方式可以通过修改存有 Artifact Repository 信息的默认 Config Map 或者在 Workflow 中显示指定，详见 配置文档，在此不做赘述。下表为 Argo 支持的仓库类型。</p>
<p><img decoding=async loading=lazy src=/assets/images/368505397-5fffb8e6dbf65-e62804815598ad2e8630df898c49cf04.png width=1080 height=608 class=img_ev3q></p>
<p>一个简单的使用了 Artifact 的例子如下：</p>
<p><img decoding=async loading=lazy src=/assets/images/3952974062-5fffb8f00b5dc-14bdbc7d72d41de463c6289f6ab243e0.png width=1080 height=1286 class=img_ev3q></p>
<p><strong>默认情况下，Artifact 被打包为 tgz(tar +gzip)包，我们也可以使用 archive 字段指定存档策略。</strong></p>
<p>在上面的例子里，名为 whalesay 的 template 使用 cowsay 命令生成一个名为 /tmp/hello-world.txt 的文件，然后将该文件作为一个名为 hello-art 的 Artifact 输出。名为 print-message 的 template 接受一个名为 message 的输入 Artifact，在 /tmp/message 的路径上解包它，然后使用 cat 命令打印 /tmp/message 的内容。</p>
<p>在前面 Sidecar 介绍中提到过，<strong>Init Container 主要用于拉取 Artifact 产物</strong>。这些 Sidecar 正是产物传递的关键。下面，我们通过介绍另一种产物传递的方式来体验 Argo 中传递产物的关键。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=2script>2、Script<a href=#2script class=hash-link aria-label="Direct link to 2、Script" title="Direct link to 2、Script">​</a></h3>
<p>先来看一个简单的例子：</p>
<p><img decoding=async loading=lazy src=/assets/images/2992108274-5fffb90ac6e9e-23d1f387c673ea2aacf0e804366d2dcf.png width=1080 height=1065 class=img_ev3q></p>
<p>在上面的例子中，有两个类型为 script 的 template，script 允许使用 source 规范脚本主体。这将创建一个包含脚本主体的临时文件，然后将临时文件的名称作为最后一个参数传递给 command（执行脚本主体的解释器），这样便可以方便的执行不同类型的脚本（bash、python、js etc）。</p>
<p>Script template 会将脚本的标准输出分配给一个名为 result 的特殊输出参数从而被其他 template 调用。在这里，通过 <code>{{steps.generate.outputs.result}}</code> 即可获取到名为 generate 的 template 的脚本输出。</p>
<blockquote>
<p><code>{{xxx}}</code> 是 Argo 固定的变量替换格式：</p>
<ul>
<li>关于变量的格式详见文档，文档地址：<a href=https://github.com/argoproj/argo/blob/master/docs/variables.md target=_blank rel="noopener noreferrer">https://github.com/argoproj/a...</a></li>
<li>关于变量替换的逻辑详见源码，源码地址：<a href=https://github.com/argoproj/argo/blob/master/workflow/common/util.go#L305 target=_blank rel="noopener noreferrer">https://github.com/argoproj/a...</a></li>
</ul>
</blockquote>
<p>那么，容器内部应该如何获取这个脚本输出呢？我们回到 Sidecar，在 Wait Container 中，有这样一段逻辑：</p>
<p><img decoding=async loading=lazy src=/assets/images/455755801-5fffb91c238b1-9a5228b39cad5863135588493973922b.png width=1080 height=943 class=img_ev3q></p>
<p><img decoding=async loading=lazy src=/assets/images/4120955339-5fffb922eee06-418fcdf47aa018788d826e3d92b5d3df.png width=1080 height=376 class=img_ev3q></p>
<p>再来看看这个 Wait Container 的 Volume Mount 情况：</p>
<p><img decoding=async loading=lazy src=/assets/images/3976899563-5fffb9477dcc3-77e275983758415b8b8dcd247b25f2e0.png width=1080 height=488 class=img_ev3q></p>
<p>现在就十分明确了，<strong>Wait Container 通过挂载 docker.sock 以及 service account，获取到 Main Container 中的输出结果，并保存到 Workflow 中</strong>。当然，因为 Workflow 中保存了大量的信息，当一个 Workflow 的 Step 过多时，整个 Workflow 的结构会过于庞大。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=3parameter>3、Parameter<a href=#3parameter class=hash-link aria-label="Direct link to 3、Parameter" title="Direct link to 3、Parameter">​</a></h3>
<p>**Parameter 提供了一种通用机制，可以将步骤的结果用作参数。**Parameter 的工作原理与脚本结果类似，除了输出参数的值会被设置为生成文件的内容，而不是 stdout 的内容。如：<br>
<img decoding=async loading=lazy src=/assets/images/946689225-5fffba4a1a03d-e7e71fff35930ce45f2f2ef35625419b.png width=1080 height=338 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=4volume>4、Volume<a href=#4volume class=hash-link aria-label="Direct link to 4、Volume" title="Direct link to 4、Volume">​</a></h3>
<p>这并不是 Argo 处理产物传递的一种标准方式，但是通过共享存储，我们显然也能达到共通产物的结果。当然，如果使用 Volume，我们则无需借助 Inputs 和 Outputs。在 Workflow 的 Spec 中，我们定义一个 Volume 模板：</p>
<p><img decoding=async loading=lazy src=/assets/images/2256174945-5fffba5dc767f-3dd97c228780c3541fd53d699f526341.png width=1080 height=392 class=img_ev3q></p>
<p>并在其他的 template 中 mount 该 volume：</p>
<p><img decoding=async loading=lazy src=/assets/images/3085720282-5fffba6cb8ae6-01c71b8a97310577488b3ab88df448db.png width=1080 height=289 class=img_ev3q></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=六流程控制功能>六、流程控制功能<a href=#六流程控制功能 class=hash-link aria-label="Direct link to 六、流程控制功能" title="Direct link to 六、流程控制功能">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=1循环>1、循环<a href=#1循环 class=hash-link aria-label="Direct link to 1、循环" title="Direct link to 1、循环">​</a></h3>
<p>在编写 Workflow 时，能够循环迭代一组输入通常是非常有用的，如下例所示:</p>
<p><img decoding=async loading=lazy src=/assets/images/1714551681-5fffba7f41974-3804f00f0ce66361d51b75532ee0a3ff.png width=1080 height=383 class=img_ev3q></p>
<p>在源码实现中，将会去判断 withItems，如果存在，则对其中的每个元素进行一次 step 的扩展。</p>
<p><img decoding=async loading=lazy src=/assets/images/2164989231-5fffba8844abe-3612d6827bd220b0cf61241ab5a81c37.png width=1080 height=774 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=2条件判断>2、条件判断<a href=#2条件判断 class=hash-link aria-label="Direct link to 2、条件判断" title="Direct link to 2、条件判断">​</a></h3>
<p>通过 <code>when</code> 关键字指定：</p>
<p><img decoding=async loading=lazy src=/assets/images/1732212544-5fffbaa9f3a4f-54db5a7b977363ceb4729f8314c518ac.png width=1080 height=454 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=3错误重试>3、错误重试<a href=#3错误重试 class=hash-link aria-label="Direct link to 3、错误重试" title="Direct link to 3、错误重试">​</a></h3>
<p><img decoding=async loading=lazy src=/assets/images/1488316399-5fffbab193435-3e042ac83cc57ba933dc121db0a01df8.png width=1080 height=313 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=4递归>4、递归<a href=#4递归 class=hash-link aria-label="Direct link to 4、递归" title="Direct link to 4、递归">​</a></h3>
<p><strong>Template 可以递归地相互调用</strong>，这是一个非常实用的功能。例如在机器学习场景中：可以设定准确率必须满足一个值，否则就持续进行训练。在下面这个抛硬币例子中，我们可以持续抛硬币，直到出现正面才结束整个工作流。</p>
<p><img decoding=async loading=lazy src=/assets/images/3566924783-5fffbabdcee62-9f22d68899b84aef0c7660320defc5e6.png width=1080 height=1002 class=img_ev3q></p>
<p>以下是两次执行的结果，第一次执行直接抛到正面，结束流程；第二次重复三次后才抛到正面，结束流程。</p>
<p><img decoding=async loading=lazy src=/assets/images/124113011-5fffbacb91e93-c6e58bd43052515c69d339d277970433.png width=1080 height=710 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=5退出处理>5、退出处理<a href=#5退出处理 class=hash-link aria-label="Direct link to 5、退出处理" title="Direct link to 5、退出处理">​</a></h3>
<p><strong>退出处理是一个指定在 workflow 结束时执行的 template，无论成功或失败。</strong></p>
<p><img decoding=async loading=lazy src=/assets/images/1707708146-5fffbb107bb50-462844b9e7a7f0ae8c99b86862464e2d.png width=1080 height=192 class=img_ev3q></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=七参考资料>七、参考资料<a href=#七参考资料 class=hash-link aria-label="Direct link to 七、参考资料" title="Direct link to 七、参考资料">​</a></h2>
<ul>
<li>
<p><a href=https://segmentfault.com/a/1190000038979821 target=_blank rel="noopener noreferrer">https://segmentfault.com/a/1190000038979821</a></p>
</li>
<li>
<p><a href=https://github.com/argoproj/argo-workflows target=_blank rel="noopener noreferrer">https://github.com/argoproj/argo-workflows</a></p>
</li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/cloud-native/argo-workflow><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Argo Workflow</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/cloud-native/argo-workflow-source-code><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Argo Workflow源码解析</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#一什么是流水线 class="table-of-contents__link toc-highlight">一、什么是流水线</a><li><a href=#二argo是什么 class="table-of-contents__link toc-highlight">二、Argo是什么</a><li><a href=#三三级定义 class="table-of-contents__link toc-highlight">三、三级定义</a><ul><li><a href=#1template class="table-of-contents__link toc-highlight">1、Template</a><li><a href=#2workflow class="table-of-contents__link toc-highlight">2、Workflow</a><li><a href=#3workflowtemplate class="table-of-contents__link toc-highlight">3、WorkflowTemplate</a><li><a href=#4workflow-overview class="table-of-contents__link toc-highlight">4、Workflow Overview</a></ul><li><a href=#四sidecar class="table-of-contents__link toc-highlight">四、Sidecar</a><ul><li><a href=#1init class="table-of-contents__link toc-highlight">1、Init</a><li><a href=#2wait class="table-of-contents__link toc-highlight">2、Wait</a></ul><li><a href=#五inputs-and-outputs class="table-of-contents__link toc-highlight">五、Inputs and Outputs</a><ul><li><a href=#1artifact class="table-of-contents__link toc-highlight">1、Artifact</a><li><a href=#2script class="table-of-contents__link toc-highlight">2、Script</a><li><a href=#3parameter class="table-of-contents__link toc-highlight">3、Parameter</a><li><a href=#4volume class="table-of-contents__link toc-highlight">4、Volume</a></ul><li><a href=#六流程控制功能 class="table-of-contents__link toc-highlight">六、流程控制功能</a><ul><li><a href=#1循环 class="table-of-contents__link toc-highlight">1、循环</a><li><a href=#2条件判断 class="table-of-contents__link toc-highlight">2、条件判断</a><li><a href=#3错误重试 class="table-of-contents__link toc-highlight">3、错误重试</a><li><a href=#4递归 class="table-of-contents__link toc-highlight">4、递归</a><li><a href=#5退出处理 class="table-of-contents__link toc-highlight">5、退出处理</a></ul><li><a href=#七参考资料 class="table-of-contents__link toc-highlight">七、参考资料</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>