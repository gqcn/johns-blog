<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/云原生/Argo Workflow/Argo Workflow源码解析" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Argo Workflow源码解析 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/cloud-native/argo-workflow-source-code><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=author content="John Guo"><meta data-rh=true property=og:image content=https://johng.cn/img/favicon.png><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Argo Workflow源码解析 | John's Blog"><meta data-rh=true name=description content="深入分析 Argo Workflow 的源代码实现，探讨其核心组件、工作流程和关键功能的技术细节"><meta data-rh=true property=og:description content="深入分析 Argo Workflow 的源代码实现，探讨其核心组件、工作流程和关键功能的技术细节"><meta data-rh=true name=keywords content="Argo Workflow,源码分析,工作流引擎,Kubernetes,Go语言,代码实现"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/cloud-native/argo-workflow-source-code><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/argo-workflow-source-code hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/argo-workflow-source-code hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="John's Blog RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="John's Blog Atom Feed"><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><link rel=stylesheet href=/assets/css/styles.2f56d3c4.css><script src=/assets/js/runtime~main.a2ab4500.js defer></script><script src=/assets/js/main.8f3de613.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" href=/ai>AI技术</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/cloud-native>云原生</a><a class="navbar__item navbar__link" href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/programming>开发语言</a><a class="navbar__item navbar__link" href=/architecture>技术架构</a><a class="navbar__item navbar__link" href=/observability>可观测性</a><a class="navbar__item navbar__link" href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" href=/life>生活笔记</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href=/aboutme>关于我</a><a class="navbar__item navbar__link" href=/blog>博客</a><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/cloud-native>云原生</a><button aria-label="Collapse sidebar category '云原生'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/container>Container</a><button aria-label="Expand sidebar category 'Container'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kubernetes>Kubernetes</a><button aria-label="Expand sidebar category 'Kubernetes'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/cloud-native/argo-workflow>Argo Workflow</a><button aria-label="Collapse sidebar category 'Argo Workflow'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/argo-workflow-introduction>Argo Workflow介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/cloud-native/argo-workflow-source-code>Argo Workflow源码解析</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/argo-workflow-faq>Argo Workflow常见问题</a><button aria-label="Expand sidebar category 'Argo Workflow常见问题'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/argo-workflow-development-setup>Argo Workflow开发环境搭建</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/volcano>Volcano</a><button aria-label="Expand sidebar category 'Volcano'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kind>Kind</a><button aria-label="Expand sidebar category 'Kind'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/helm>Helm常用指令</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/dragonfly>Dragonfly介绍</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/life>生活笔记</a><button aria-label="Expand sidebar category '生活笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native><span itemprop=name>云原生</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native/argo-workflow><span itemprop=name>Argo Workflow</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Argo Workflow源码解析</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><p>本文主要对Argo Workflow的核心Feature以及核心执行流程的源码实现进行解析讲解，Feature的实现细节请翻看Argo Workflow源码进行更深入的了解。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=知识梳理>知识梳理<a href=#知识梳理 class=hash-link aria-label="Direct link to 知识梳理" title="Direct link to 知识梳理">​</a></h2>
<p>由于Argo本身的概念和内容较多，我这里先通过思维导图的方式梳理出其中较为关键的知识点，作为前置预备知识：</p>
<p><a href=https://whimsical.com/kubernetes-argo-framework-UZXKpyqfjqMzRx6mxuEdNt@2Ux7TurymN5ZuzLYocBL target=_blank rel="noopener noreferrer">https://whimsical.com/kubernetes-argo-framework-UZXKpyqfjqMzRx6mxuEdNt@2Ux7TurymN5ZuzLYocBL</a></p>
<p>一些基本的概念和功能介绍这里不再赘述，可以参考之前的一篇Argo介绍文章：<a href=/cloud-native/argo-workflow-introduction>Argo Workflow介绍</a></p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmElEQVR4nE2OS47DMAzFcv9bdoJ0EsuyJMtOumPRz6KLtyEI8C0+LkoLNmlIn8S4eDHPSbOgqmHjYvE8+duFVY09kvYrqlJKwfJkeUHtk9t/4abGEfkWzYOmFZH6EWM+EEvWvbKqY/38LBLLSdWGWGepkdzF2O6KHIna/KZPmhlFhO2oLK0Pqg92cZpPLL8f54PmwVGE6skTl5vkAKc2bH8AAAAASUVORK5CYII=")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=365 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/KubernetesArgoFramework.a68e801.640.png srcset="/assets/ideal-img/KubernetesArgoFramework.a68e801.640.png 640w,/assets/ideal-img/KubernetesArgoFramework.6bd67f3.2487.png 2487w" alt="" width=640 height=365></noscript></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=充满好奇>充满好奇<a href=#充满好奇 class=hash-link aria-label="Direct link to 充满好奇" title="Direct link to 充满好奇">​</a></h2>
<p>为了更好地学习Argo Workflow，这里有几个问题，我们带着问题去探究Argo效果可能会更好一些：</p>
<ol>
<li>Workflow有哪些核心组件，各自的作用是什么？</li>
<li>Workflow的流程数据是如何实现上下文传递的？</li>
<li>Workflow的流程管理逻辑是如何实现的？</li>
<li>Workflow的模板以及状态数据存储在哪里？</li>
</ol>
<p>接下来我们先梳理一下Argo Workflow的核心流程以及一些关键逻辑，然后我们再回过头来解答这些问题。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=工程结构>工程结构<a href=#工程结构 class=hash-link aria-label="Direct link to 工程结构" title="Direct link to 工程结构">​</a></h2>
<p><code>Argo Workflow</code>的整个工程是使用经典的<code>kubebuilder</code>搭建的，因此大部分目录结构和<code>kubebuilder</code>保持一致。关于<code>kubebuilder</code>的介绍可参考：<a href=https://cloudnative.to/kubebuilder/ target=_blank rel="noopener noreferrer">https://cloudnative.to/kubebuilder/</a></p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAVCAYAAAB/sn/zAAAACXBIWXMAAAsTAAALEwEAmpwYAAABOElEQVR4nIVS207CQBTsV0mgbPfSUkuh3e61BSU+eHkz8Td88Alj4ou/OmaLIYq0PExycjKZMzO7Ubl7w93LF26fP9Hc76Ef9jCP7z10mJ8+UO1eETFG0GgJQmaYTq8wm03+I54gihOOSllIZcFEDioWSFj6B3MqEBHKUSsL4zyKcoUsLxB2vzFPGCKWLmDaTU+ICe2Xp0RCA1EsYHyHvCjPEPgRP4pbLFfVBaLI4NotrpcXFGOSoFYGUhkkTAwTE55C2RZFuR4Iwg9EkeXQrjvWMOpRW49yVSHMg0TKBLR20M73XQ6pRiGAti2sP/gcVCQ8ReM28G2Hdd30b3v+NM+gXIdaqv508HnufESogDQt6kaNJu89GuMvF05Y8NhBKg2e5sOKhGeo/Q20seP1UJbC2pBYjn6Kb3DvevEGEAEdAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=1331 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_15-15-13.462dfee.640.png srcset="/assets/ideal-img/image2021-7-3_15-15-13.462dfee.640.png 640w,/assets/ideal-img/image2021-7-3_15-15-13.a441b68.828.png 828w" alt="" width=640 height=1331></noscript></div>
<table><thead><tr><th>目录名称<th>职责及说明<tbody><tr><td><code>api</code><td>Swagger API 定义Json文件存放目录，主要是供Argo Server UI使用。<tr><td><code>cmd</code><td>入口源码文件<tr><td> <code> - argo</code><td><code>argo CLI</code><tr><td> <code> - argoexec</code><td><code>argoexec container image</code>命令<tr><td> <code> - workflow-controller</code><td><code>Kubernetes CRD Controller</code><tr><td><code>community</code><td>开源社区相关介绍，目前就一个README.MD<tr><td><code>config</code><td><code>Argo Workflow Controller</code>配置对象以及相关方法<tr><td><code>docs</code><td><code>Argo Workflow</code>的相关介绍文档，与官网文档一致<tr><td><code>errors</code><td>封装第三方 <code>[github.com/pkg/errors](http://github.com/pkg/errors)</code> 组件，<code>argo Workflow</code>内部使用的错误管理组件<tr><td><code>examples</code><td>丰富的使用示例，主要是yaml文件<tr><td><code>hack</code><td>项目使用到的脚本及工具文件<tr><td><code>manifests</code><td><code>Argo</code>的安装配置文件，都是些<code>yaml</code>文件，使用<code>kustomize</code>工具管理，关于kustomize工具的介绍请参考：<a href=https://kubernetes.io/zh/docs/tasks/manage-kubernetes-objects/kustomization/ target=_blank rel="noopener noreferrer">https://kubernetes.io/zh/docs/tasks/manage-kubernetes-objects/kustomization/</a><tr><td><code>persist</code><td>Argo数据库持久化封装组件，支持MySQL/PostgreSQL两种数据库。持久化主要是针对于<code>Archived Workflow</code>对象的存储，包含Workflow的定义以及状态数据。<tr><td><code>pkg</code><td><code>Argo Workflow</code>的对外API定义、结构定义、客户端定义，主要提供给外部服务、客户端使用。<tr><td> <code> - apiclient</code><td><code>Argo Server</code>对外<code>API</code>相关定义、客户端组件。<tr><td> <code> - workflow</code><td><code>Argo Workflow Controller</code>相关结构体定义。<tr><td> <code> - client</code><td><code>Argo Workflow Controller</code>与<code>Kubernetes</code>交互的<code>Client/Informer/Lister</code>定义。<tr><td><code>server</code><td><code>Argo Server</code>模块。<tr><td><code>test</code><td>单元测试文件。<tr><td><code>ui</code><td><code>Argo Server</code>的前端<code>UI NodeJS</code>源码文件，使用<code>Yarn</code>包管理。<tr><td><code>util</code><td>项目封装的工具包模块<tr><td><code>workflow</code><td><code>Argo Workflow</code>的核心功能逻辑封装</table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=workflow-controller>Workflow Controller<a href=#workflow-controller class=hash-link aria-label="Direct link to Workflow Controller" title="Direct link to Workflow Controller">​</a></h2>
<p><code>Argo</code>中最核心也最复杂的便是<code>Workflow Controller</code>的实现。<code>Argo Workflow Controller</code>的主要职责是<code>CRD</code>的实现，以及<code>Pod</code>的创建创建。由于<code>Argo</code>采用的是<code>Kubernetes CRD</code>设计，因此整体架构以及流程控制采用的是<code>Kubernetes Informer</code>实现，相关背景知识可以参考之前的两篇文章：<a href=/cloud-native/kubernetes-informer-client-go>Kubernetes Informer及client-go资料</a>、<a href=/cloud-native/kubernetes-crd-controller-operator>Kubernetes CRD, Controller, Operator</a>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=基本架构>基本架构<a href=#基本架构 class=hash-link aria-label="Direct link to 基本架构" title="Direct link to 基本架构">​</a></h3>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAHAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAMH/8QAIRAAAQMDBAMAAAAAAAAAAAAAAQACAwUREhQhJDFBUeH/xAAUAQEAAAAAAAAAAAAAAAAAAAAE/8QAGREBAAMBAQAAAAAAAAAAAAAAAQACEZHR/9oADAMBAAIRAxEAPwDfqvrDVmhzyyOwyMbzYbHwrMknwby5uvf1ESGmgjnPIVtiz//Z")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=424 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/architecture.cd4db84.640.jpeg srcset="/assets/ideal-img/architecture.cd4db84.640.jpeg 640w,/assets/ideal-img/architecture.65a3734.1810.jpeg 1810w" alt="" width=640 height=424></noscript></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=重要设计>重要设计<a href=#重要设计 class=hash-link aria-label="Direct link to 重要设计" title="Direct link to 重要设计">​</a></h3>
<p><code>Argo Workflow Controller</code>组件有一些，我个人觉得较为重要的设计给大家分享下。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=1定义与状态分离>1）定义与状态分离<a href=#1定义与状态分离 class=hash-link aria-label="Direct link to 1）定义与状态分离" title="Direct link to 1）定义与状态分离">​</a></h4>
<p>这个其实是<code>Kubernetes</code>的标准设计，即<code>CRD实现</code>对象应当包含<code>Spec</code>及<code>Status</code>属性对象，其中<code>Spec</code>对应<code>CR</code>的定义，而<code>Status</code>对应<code>CR</code>的业务状态信息。<code>Spec</code>由业务客户端创建和修改，一般创建后不会更新，在<code>Informer Controller</code>处理流程中只能读取。而<code>Status</code>是<code>Informer Controller</code>中根据业务场景的需要不断变化的字段。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=2定义与数据分离>2）定义与数据分离<a href=#2定义与数据分离 class=hash-link aria-label="Direct link to 2）定义与数据分离" title="Direct link to 2）定义与数据分离">​</a></h4>
<p><code>Argo Workflow Template</code>应当只包含流程以及变量定义，而变量数据则是由运行时产生的，例如通过Template运行时生成到终端或者<code>Artifact</code>，再通过<code>Outputs</code>的定义被其他的Template引用。一个<code>Node</code>执行成功之后，它的输出数据将会被保存到<code>Template.Status</code>字段（<code>Kubernetes etcd</code>）或者Artifact中，返回执行不会重复生成。一个<code>Node</code>执行失败后，如果重新执行将会重新去拉取依赖的数据。这种定义与数据分离的设计使得<code>Workflow Template</code>可以预先设计，甚至可以通过UI拖拽的方式生成。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=3全局与局部变量>3）全局与局部变量<a href=#3全局与局部变量 class=hash-link aria-label="Direct link to 3）全局与局部变量" title="Direct link to 3）全局与局部变量">​</a></h4>
<p><code>在Argo Workflow Controller</code>内部中的变量分为两种:一种是<code>Workflow</code>全局生效的变量(<code>globalParams</code>)，一种是当前<code>Template</code>生效的本地变量(<code>localParams</code>)。其中全局变量也包括开发者自定义的输入/输出变量、<code>Workflow Annotations&Labels</code>，这些变量也是能被<code>Workflow</code>全局中访问。两种变量由于访问方式不同，因此不会相互冲突。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=4模板化变量设计>4）模板化变量设计<a href=#4模板化变量设计 class=hash-link aria-label="Direct link to 4）模板化变量设计" title="Direct link to 4）模板化变量设计">​</a></h4>
<p><code>Argo Workflow Controller</code>的变量其实主要是使用到模板解析中。在<code>Controller</code>处理流程中，会看到多次的<code>json.Marshal/json.Unmarshal</code>操作：通过<code>json.Marhsal</code>将<code>Template</code>对象转为字符串，再通过模板解析将字符串中的变量替换为真正的内容，随后再将字符串<code>json.Unmarshal</code>到该对象上覆盖原有属性值。这种设计也使得<code>Workflow Template</code>中的变量对应的内容必须是一个具体的值（字符串/数字等基本类型），不能是一个复杂对象，否则无法完成模板解析替换。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=5多模板融合设计>5）多模板融合设计<a href=#5多模板融合设计 class=hash-link aria-label="Direct link to 5）多模板融合设计" title="Direct link to 5）多模板融合设计">​</a></h4>
<p>在<code>Argo Workflow</code>中有三个地方可以设置<code>Template</code>运行模板，按照优先级顺序为：<code>Default Template、Workflow Template和Node Template</code>。</p>
<p><code>**Default Template**</code>: 全局Template定义，所有创建的Workflow都会自动使用到该Template定义。</p>
<p><code>**Workflow Template**</code>: Workflow流程中所有Node都会使用到的Template定义。</p>
<p><code>**Node Template**</code>: 使用Steps/DAG流程调度的各个步骤/任务Node使用到的Template。</p>
<p>优先级高的<code>Template</code>在运行时会覆盖优先级低的<code>Template</code>，最终融合生成的Template再使用到<code>Pod</code>的创建中。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=6简化的调度控制>6）简化的调度控制<a href=#6简化的调度控制 class=hash-link aria-label="Direct link to 6）简化的调度控制" title="Direct link to 6）简化的调度控制">​</a></h4>
<p><code>Argo Workflow</code>目前仅使用两种调度控制方式：<code>Steps</code>和<code>DAG</code>。</p>
<p><code>Steps:</code> 通过步骤的先后顺序、并行/串行控制来调度执行任务。</p>
<p><code>DAG:</code> 通过有向无环图，任务之间的依赖关系来调度执行任务。</p>
<p>并且这两种方式可以混合使用，使得<code>Argo Workflow</code>基本能满足绝大部分的任务调度业务场景。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=核心结构>核心结构<a href=#核心结构 class=hash-link aria-label="Direct link to 核心结构" title="Direct link to 核心结构">​</a></h3>
<p>整个<code>Controller</code>逻辑中涉及到的核心数据结构如下。</p>
<table><thead><tr><th>数据结构<th>结构介绍<tbody><tr><td><code>WorkflowController</code><td><div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAALCAYAAABGbhwYAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA3UlEQVR4nGWPW27FIBBDs50QCDBPStKrSlX3vyRXkKsoVT+OzIfHNks/PvH1/YPjOOHuUHOYGVgEIgpRQSXCUomhalAhpJQQQkBYw9R1XSfjvRDrTFF3EBNKrUj7Po9iSlMHS+Wrwt1QS0bOBTkPzZc5RmzbNhIFZg5vDUT1Thjs+45croNZbd5gLmCzeR0HMf7h3lipwpqCvSHT42MhvKtF8dFPEBX0V4eeL4zdzwkzkWUkNjBXeG8o0xTvjUNnIouh9QMshP46UVixbVfdk1mt6mBhiAv2Sv9Mw/gL/HqsbfFGmDsAAAAASUVORK5CYII=")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=701 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-1_11-14-52.4ea70e6.640.png srcset="/assets/ideal-img/image2021-7-1_11-14-52.4ea70e6.640.png 640w,/assets/ideal-img/image2021-7-1_11-14-52.2ead255.2292.png 2292w" alt="" width=640 height=701></noscript></div><br><br>用于<code>Workflow Controller</code>流程控制的核心数据结构对象，封装了主要的<code>Controller</code>处理逻辑、维护着核心的相关业务逻辑对象、数据队列、<code>KubeClient</code>对象、<code>Informer</code>对象等等。该结构只有一个对象实例，由主流程创建。<tr><td><code>Workflow</code><td><div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAACCAYAAABhYU3QAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAPklEQVR4nEXKuRHAIBAEQfLhHnSwkH9kQ0mOjPa6TQkdUfWQmUQGET93x8xoS2KfzdyiZlGrGCNxty/0/upc7UMfKywLFHgAAAAASUVORK5CYII=")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=157 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-1_11-18-1.2c3e41d.640.png srcset="/assets/ideal-img/image2021-7-1_11-18-1.2c3e41d.640.png 640w,/assets/ideal-img/image2021-7-1_11-18-1.75f6e27.2780.png 2780w" alt="" width=640 height=157></noscript></div><br><br><code>Workflow</code>的内容管理对象，用于<code>Workflow</code>的逻辑处理。<tr><td><code>WorkflowSpec</code><td><div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAHCAYAAAAxrNxjAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAf0lEQVR4nHWOQQ4EIQgEfY+CgODG+f/DesKM2Zhs9tAnqosun7WwrgsxJ9wdNgxqClFBl47eM4JiI4/jOdoGWms7FbW+KcMDM23h0G1LCxEdhfaCHvF9qSbgzmAmEP2A/rxUVYgImP+Ac6Yxd6ZVDphBWWDaRneMzLmRCe3YeQO0lGx5QSUEQAAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=467 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-1_11-19-10.86efb90.640.png srcset="/assets/ideal-img/image2021-7-1_11-19-10.86efb90.640.png 640w,/assets/ideal-img/image2021-7-1_11-19-10.6607dcc.3552.png 3552w" alt="" width=640 height=467></noscript></div><br><br><code>Workflow</code>的内容定义映射对象，与开发者使用的<code>yaml</code>文件结构一一对应。需要注意与<code>WorkflowStatus</code>的区别：<br><br>*   <code>WorkflowSpec</code>是<code>Workflow</code>的定义，来源于<code>Workflow Yaml</code>配置以及对象初始化。初始化完成后再运行时不会执行修改操作，运行时操作中只对<code>Spec</code>对象执行读取操作。<br>*   <code>WorkflowStatus</code>是<code>Workflow</code>运行时的状态信息管理对象，因为状态信息会不断变化，因此内部的属性也会不停地被修改。<tr><td><code>WorkflowStatus</code><td><div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAJCAYAAAALpr0TAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAr0lEQVR4nE2PSw4CMQxDe582beKkzAjE/Y9llFQCFpY3T/60+/niM/V687pvPq6LsR+MHTSAqlZqcKeHE1AuXZxrci7hkMHe+1fNfDP2pjm4dHIlqJMyDywyypt5EAANSrWTqnpS++gco5c3+Ka7E26Eo+BMExGO8atv8KCnAAJGM6Wq1oScktVfMDdGeL3MCWZWoPydquqIXbUpg52kPPNfnWcOeOA8kodqZ209iR9BxYxp1tT/qQAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=567 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-1_11-21-30.a5a7294.640.png srcset="/assets/ideal-img/image2021-7-1_11-21-30.a5a7294.640.png 640w,/assets/ideal-img/image2021-7-1_11-21-30.6443599.2930.png 2930w" alt="" width=640 height=567></noscript></div><br><br><code>Workflow</code>逻辑处理流程中的运行时状态信息管理对象。该结构是与<code>Kubernetes Pod操作相关的资源结构。几点重要的说明：</code><br><br><code>1、StoredTemplates</code><br><br>该属性是一个<code>Map</code>类型，存放了当前<code>Workflow</code>所有的<code>Template</code>对象，以便于全局访问。键名为生成的<code>TemplateID</code>，生成规则为：<br><br><code>Scope/MetaName/TemplateName</code><br><br><div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAECAYAAAC3OK7NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAcElEQVR4nCWMQQ4CMQzE+p9umqRJtt0TCPj/l4wWDiPLkjUt6mSvYq3E50TNcXPUDPXbFR1C80giJte+OKOY5tgYuCo+hN77b82jOKfy2ck7k2clj5y80tkq9ONARGhZi2mDciVUSVPC/ryfD5Ff+AUcVz8mqc9jPAAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=261 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-1_17-42-37.51d0a88.640.png srcset="/assets/ideal-img/image2021-7-1_17-42-37.51d0a88.640.png 640w,/assets/ideal-img/image2021-7-1_17-42-37.41d4d3f.2548.png 2548w" alt="" width=640 height=261></noscript></div><tr><td><code>WorkflowStep</code><td><div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAALCAYAAABGbhwYAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAyUlEQVR4nE2QyZEEMQgExx8hTqmP9d+v2gA6euah0CepLPis48TffeO+LqgKVO35GcyMMUa9j68Dqgo3gyRgWjALYzL9ghtmjlgL5ga1TFOICFjmCxcYEdjnBY+Au8KjB/0ZpEmtNrOCzfR5Xj1FM7V7NuiOtaL+UlurJ8/SD3oSwx17b1gpvdS+HKKMOedXneVTrWa9kObmWto8EdF7nuy4uludJ9UKIsKg0WDss4Bj95al9dQKRDLtPc9R05qLZNJ79EzNjg3+Ayvbq+K/SuGPAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=673 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-1_17-6-38.a93439c.640.png srcset="/assets/ideal-img/image2021-7-1_17-6-38.a93439c.640.png 640w,/assets/ideal-img/image2021-7-1_17-6-38.fe79b14.2022.png 2022w" alt="" width=640 height=673></noscript></div><br><br>是的，你没猜错，这个是用来管理执行流程控制的每一个操作步骤对象。该步骤对象必然会绑定一个<code>Template</code>对象。<br><br><code>Workflow</code>的初始化执行步骤是通过<code>woc.execWf.Spec.Entrypoint</code> 作为入口<code>Template</code>。<tr><td><code>wfOperationCtx</code><td><div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAALCAYAAABGbhwYAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAyElEQVR4nGWQ0bKDIAxE/R4FDAmQ4GDb//+p7UCL18592CeP2bMstZ14PF84W8NxHGiPF9r5hNkBswqrFUUVC0VBLhksghACQvBX1nW9skRO0FLAzIiRQDHChwDvPbZtuzLAUhRZFYEI3jk4536gbYKqCjWD5IwYGUT7uOhuP31AM5iWcbW77vs+fDs8FQbYP6YkYOmeEUQ04H/VtVbItfov90Hf6v5eBkkyFnevWTtdr2pJCalXM/8MmVlY0seLedTdh8zLHXwDVP6sJ2WvMskAAAAASUVORK5CYII=")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=687 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-1_11-27-8.ec56b66.640.png srcset="/assets/ideal-img/image2021-7-1_11-27-8.ec56b66.640.png 640w,/assets/ideal-img/image2021-7-1_11-27-8.799e360.2334.png 2334w" alt="" width=640 height=687></noscript></div><br><br><code>Workflow</code>业务逻辑封装对象。<br><br>几点重要的说明：<br><br>1、<code>wf/orig/execWf</code><br><br>1）<code>wf</code><br><br>该对象是开发者通过<code>yaml</code>创建的<code>Workflow</code>对象的深度拷贝对象。官方注释建议运行时逻辑处理中应当使用<code>execWf</code>而不是<code>wf</code>对象，wf对象未来可能会被废弃掉。<br><br>2）<code>orig</code><br><br>该对象是开发者通过<code>yaml</code>创建的<code>Workflow</code>对象，任何时候开发者都不应当去修改它，该对象主要用于后续可以对<code>Workflow</code>的<code>patch</code>更新判断。<br><br>3）<code>execWf</code><br><br>该对象是运行时逻辑处理中修改的<code>Workflow</code>对象，因为<code>Workflow</code>对象会在逻辑处理中不断被修改更新，特别是<code>execWf</code>是多个模板<code>(Wf/WfDefault/WfTemplate)</code>的合并结构。<br><br>*   关于<code>TemplateDefault</code>的介绍请参考官方文档：<a href=https://argoproj.github.io/argo-workflows/template-defaults/ target=_blank rel="noopener noreferrer">https://argoproj.github.io/argo-workflows/template-defaults/</a><br>*   <code>WfTemplate</code>来源于<code>templateRef</code>配置，具体请参考官方文档：<a href=https://argoproj.github.io/argo-workflows/workflow-templates/#referencing-other-workflowtemplates target=_blank rel="noopener noreferrer">https://argoproj.github.io/argo-workflows/workflow-templates/#referencing-other-workflowtemplates</a><br><br>2、<code>globalParams</code><br><br>全局变量，类型为<code>map[string]string</code>，该<code>Workflow</code>中的所有<code>template</code>共享该变量，该变量的名称也可被用于<code>template</code>中的模板变量。<br><br>3、<code>update</code><br><br>该属性用于标识当前<code>Workflow</code>对象是否已更新，以便判断是否同步到<code>Kubernetes</code>中。<br><br>4、<code>node</code><br><br>在<code>woc</code>处理流程的源码中会出现<code>node</code>的概念，这里的<code>node</code>是<code>Steps/DAG中</code>的执行节点，每一个节点都会运行一个<code>Pod</code>来执行。注意它和<code>Template</code>不是一个概念。<tr><td><code>templateresolution.</code><br><br><code>Context</code><td><div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAFCAYAAAB8ZH1oAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAe0lEQVR4nEWOWwrDMAwEc546D1mv2ik05P6HmhKXph+DYLUMO5kHGUHvDTdFqqKqbCIsy8I8z5RSmNQCNeM4T7I1NBNvfXDlIsK6rkzVgqrG+ziIZyP6C8/EItm2v/VbrMq+78QzUY/xvCwXd1E9h97ckFrvTY9Sxv3xAakVTvJHGpwgAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=312 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-1_16-56-26.ad988a4.640.png srcset="/assets/ideal-img/image2021-7-1_16-56-26.ad988a4.640.png 640w,/assets/ideal-img/image2021-7-1_16-56-26.80e98bc.1386.png 1386w" alt="" width=640 height=312></noscript></div><br><br>如注释所示，用于<code>Workflow</code>中的<code>template</code>检索。</table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=核心流程>核心流程<a href=#核心流程 class=hash-link aria-label="Direct link to 核心流程" title="Direct link to 核心流程">​</a></h3>
<p>主要节点流程图：<a href=https://whimsical.com/kubernetes-argo-controller-4BkPmeF1ZNP548D3JmaHhS@2Ux7TurymME7dMV1vz75 target=_blank rel="noopener noreferrer">https://whimsical.com/kubernetes-argo-controller-4BkPmeF1ZNP548D3JmaHhS@2Ux7TurymME7dMV1vz75</a></p>
<p>由于<code>Argo Workflow Controller</code>的细节很多、流程非常长，这里对流程做了精简，只保留了相对比较重要的执行节点，以便有侧重性进行介绍。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAACXBIWXMAAAsTAAALEwEAmpwYAAABIUlEQVR4nE2Q207CQBRF+//vfoCJD5roP5BosASLQEWEFmW4ttDLTDvTaROSZQrE+LCfTs7K3svJtaU0lu+DZr4vue0ndAKFtTVpYZH6EicvLZWtGYiCzkzSm85wZ2s+thp/oxgKxXitcFpifv2q6obee0jXX+MJhbvIWMQFaWFaYoUylkga3pYFT12P50nILjP8xIqDNMiywmn7GVujtCVSNUNvgBCC0+mEtZdaWUtcJZogKgijgmVqmPe/mAU7RGoRsWZ5KIlyjTNaKV6CjNcwvybDdRc8jAT3vuCuv2e0kji6spjKok1FXTdskyOPnsvkGDE9xnzucjZJiZOVllZRVrQ+G4J9zk3HR5YtoEFXl/7n1X9pVSUSOQ7OA7J/t1+RrXMhBbElswAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=617 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/KubernetesArgoController.68a9087.640.png srcset="/assets/ideal-img/KubernetesArgoController.68a9087.640.png 640w,/assets/ideal-img/KubernetesArgoController.7a24db1.2270.png 2270w" alt="" width=640 height=617></noscript></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=1workflowcontroller><code>1）WorkflowController</code><a href=#1workflowcontroller class=hash-link aria-label="Direct link to 1workflowcontroller" title="Direct link to 1workflowcontroller">​</a></h4>
<ul>
<li>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAECAYAAAC3OK7NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAYUlEQVR4nEWMUQrDMAxDcx7bidzYeGnZ/a+l0VKyD6GHeKgdWey9s2oRAOGdjvFsqrrTZtYD5/VlRFBEKPIXtng/qhk/62Ktk2b2ykJR3dwykq7COpzp4Bx3BifeHmAA/AGbRD3EWB8nngAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=251 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-2_10-6-9.4e7e19e.640.png srcset="/assets/ideal-img/image2021-7-2_10-6-9.4e7e19e.640.png 640w,/assets/ideal-img/image2021-7-2_10-6-9.d9ac0e0.2040.png 2040w" alt="" width=640 height=251></noscript></div>
</li>
</ul>
<p><code>Controller</code>启动是由<code>Cobra</code>命令行组件管理，通过<code>workflow-controller</code>命令执行启动。启动后创建<code>WorkflowController</code>对象，并执行该对象的<code>Run</code>方法将流程的控制交给了该对象维护。这里同时会创建一个<code>HTTP Serever:``6060/healthz</code>，用于<code>Controller容器</code>的健康检查。不过，从执行结果来看，<code>6060</code>端口的健康检查服务并没有被使用，而是使用的后续开启的<code>Metrics Http Server</code>作为健康检查的地址。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAJCAYAAAALpr0TAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApUlEQVR4nHWQ2w7EIAhEwQtaq6jd7v9/6mww7cPeHk4ICTAz0BgDc05YTSnBOQci+qbWCiPGCGb+PUQEuq8ZvXeUUhY557UsIqtSaw2qCu/9umi4i7tfSrVVjDkhKcGH8CbHTHB89WdveC4UpzZoEjSJ2CXiTBHiLt8P86iKkjNKTqilYN8yJAREx+BbwULkbYP3Acx/XmMcxwHDXmRJLaUF+xx8Ae21YBWyCkLhAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=603 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-2_10-23-20.18be239.640.png srcset="/assets/ideal-img/image2021-7-2_10-23-20.18be239.640.png 640w,/assets/ideal-img/image2021-7-2_10-23-20.a35ed23.2760.png 2760w" alt="" width=640 height=603></noscript></div>
<ul>
<li>在初始化<code>WorkflowController</code>时会自动创建内部的一个<code>Informer</code>对象<code>Watch ConfigMap</code>的变化，当<code>argo</code>的相关<code>ConfigMap</code>更新后，会自动更新<code>wfc</code>的相关配置，包括数据库连接<code>Session</code>。</li>
</ul>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAHCAYAAAAxrNxjAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnklEQVR4nEWPWRLDMAhDcx6z2sZb2vtfSx07k+kHH8BDSFdtA2aOvgZKVESrcHeIKNQMZgZhwRV9QoTRRkftE7lWmDuYCSmlU5TSAxIRPGfc68a6J9b3g2gdIgJmPvsHZAYTIWpB2Yo5w0tBzgWq9gffq4jAnB1jBtoaiN7OfIv8wUTnVckO8x1EoW7Hv+obRvV43CG2whOCzvHpKeEHMPBtH4heK7QAAAAASUVORK5CYII=")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=473 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-2_15-42-36.7dcf421.640.png srcset="/assets/ideal-img/image2021-7-2_15-42-36.7dcf421.640.png 640w,/assets/ideal-img/image2021-7-2_15-42-36.3251aa3.1564.png 1564w" alt="" width=640 height=473></noscript></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=2wfcontrollerrun><code>2）wfController.Run</code><a href=#2wfcontrollerrun class=hash-link aria-label="Direct link to 2wfcontrollerrun" title="Direct link to 2wfcontrollerrun">​</a></h4>
<p><code>WorkflowCotroller</code>首先会进行大量的初始化操作，主要如下：</p>
<ul>
<li>创建<code>wfc.wfInformer/wfc.wftmplInformer/wfc.podInformer/wfc.cwftmplInformer</code>并绑定相关的<code>Event Handler</code>，根据各自设定的<code>cache.ListWatch</code>规则对<code>Event</code>进行过滤（只会监听<code>argo</code>创建的相关资源）。例如：</li>
</ul>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkklEQVR4nG3NwWrDMBBFUX+PZjSSLc1IthsKpS3k/z/oBhzIImRxVu/CW1oPvn3l/3T+zsbP18ntcH6jc2+FUY3WnaV3x82IcTBmY46glI0jC1MSKkJKiWXrTtTKLYK5GftaONaCV8NqwcwQ0WeoORNjJ5uRVJCLoqqIyOUZambuJ93jNbxbtj4opqzXTUEkfQwfqBxeDiEeT7AAAAAASUVORK5CYII=")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=367 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-2_15-51-15.192f794.640.png srcset="/assets/ideal-img/image2021-7-2_15-51-15.192f794.640.png 640w,/assets/ideal-img/image2021-7-2_15-51-15.1933951.1456.png 1456w" alt="" width=640 height=367></noscript></div>
<ul>
<li>创建<code>Metrics Http Server:9090</code>，用于<code>Prometheus</code>的指标上报，内部的指标有点多，可以单独创建一个话题来研究，这里就不深究了。</li>
<li>经典的<code>Kubernetes Client Leader</code>选举逻辑，当选出<code>Leader</code>时，在<code>Leader</code>节点通过<code>OnStartedLeading</code>回调进入<code>wfc.startLeading</code>逻辑。</li>
<li><code>wfc.startLeading</code>中开始队列的开启、异步任务的创建，这里使用了<code>wait.Until</code>方法，该方法会每隔一段时间创建一个异步的协程执行。</li>
<li>这里涉及到3个队列的<code>worker</code>创建：<code>wfc.wfQueue/wfc.podQueue/wfc.podCleanupQueue</code>：<!-- -->
<ul>
<li><code>wfc.wfQueue</code> 用于核心的Workflow对象的创建/修改流程控制。</li>
<li><code>wfc.podQueue</code> 用于<code>Pod</code>的更新，其实就是当<code>Pod</code>有更新时如果<code>Pod</code>还存在，那么重新往<code>wfc.wfQueue</code>中添加一条数据重新走一遍<code>Workflow</code>的流程对<code>Pod</code>执行修改。</li>
<li><code>wfc.podCleanupQueue</code> 用于<code>Pod</code>的标记完成。关闭：先关闭<code>main container</code>，再关闭<code>wait container</code>（关闭时先发送<code>syscall.SIGTERM</code>再发送<code>syscall.SIGKILL</code>信号）。删除：直接从<code>Kubernetes</code>中<code>Delete</code>该<code>Pod</code>。</li>
<li>官方的架构图中也能看得到几个队列之间的关联关系。</li>
</ul>
</li>
</ul>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAlElEQVR4nC2NQZIDIQzE5j0M2MYYmEkqySX//5JSsHvQTd06vAXNKxGNiEqrSjXDRDApFBFEhMM86Cq8o/LqwdON2zK3FGo+SSlxpsTx9+g8ruCewTUnXo2cM+fiPDdH9cDd6HNsMcKwWnFvmOoeLLY4rPAenc9cad3cqkiRTSlLbJ1LC98RfIfzMuVjyiyZ9J9d6R8Z/V5th1AzsgAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=409 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-2_16-19-31.1c82e8e.640.png srcset="/assets/ideal-img/image2021-7-2_16-19-31.1c82e8e.640.png 640w,/assets/ideal-img/image2021-7-2_16-19-31.a2d29d8.2030.png 2030w" alt="" width=640 height=409></noscript></div>
<p> </p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=3wrcwfqueue><code>3）wrc.wfQueue</code><a href=#3wrcwfqueue class=hash-link aria-label="Direct link to 3wrcwfqueue" title="Direct link to 3wrcwfqueue">​</a></h4>
<p><code>wfc.wfQueue</code>是最核心的一个消息队列，接下来我们主要学习对于该队列的业务逻辑处理。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=4utilfromunstructured><code>4）util.FromUnstructured</code><a href=#4utilfromunstructured class=hash-link aria-label="Direct link to 4utilfromunstructured" title="Direct link to 4utilfromunstructured">​</a></h4>
<p>由于我们的<code>wfc.wfInformer</code>使用的是<code>dynamicInterface</code>过滤类型，因此所有的事件对象都是<code>unstructured.Unstructured</code>对象（其实是一个<code>map[string]interface{}</code>），无法直接通过断言转换为<code>Workflow</code>对象。因此这里使用了<code>util.FromUnstructured</code>方法将<code>unstructured.Unstructured</code>对象转换为<code>Workflow</code>对象。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=5newworkflowoperationctx><code>5）newWorkflowOperationCtx</code><a href=#5newworkflowoperationctx class=hash-link aria-label="Direct link to 5newworkflowoperationctx" title="Direct link to 5newworkflowoperationctx">​</a></h4>
<p>该方法会创建核心的<code>wfOperationCtx</code>对象，该对象是在<code>Workflow</code>处理中核心的上下文流程和变量管理对象，接下来<code>wfc(WorkflowController)</code>会将业务逻辑的流程控制转交给<code>woc(wfOperationCtx)</code>来管理。我们可以这么来理解，<code>wfc</code>是一个<code>Kubernetes Controller</code>，用于<code>CRD</code>的实现，负责与<code>Kubernetes Event</code>打交道。<code>woc</code>负责内部的业务逻辑、流程、变量管理，因此<code>woc</code>是<code>Workflow</code>处理中的核心业务逻辑封装对象。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=6wocoperate><code>6）woc.operate</code><a href=#6wocoperate class=hash-link aria-label="Direct link to 6wocoperate" title="Direct link to 6wocoperate">​</a></h4>
<p>毫无疑问地，接下来的控制权转交给了<code>woc(wfOperationCtx)</code>，通过<code>woc.operate</code>进入业务逻辑处理流程。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAALCAYAAABGbhwYAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA0klEQVR4nG2QS27DMAxEdZ1K4p+MHaObrHL/E01hNQgauIsHisBQnGGrSDxM8NwczzI8XKGjX2gWCVLBduy47Rs8Em4JEgYvaNUWWTBhCBNoTsw5QXRCHzTzhKsgqxDhMHWICCZNjDHeNIsCMUPNYKoQ5g/BeAs9EBG474VIX37O9Rehey6P5Qpmwhx9MXrHOOurb3mepxKPWyCFYDThzHCa4N5ffKHp+aMqjvuOqoLbuV7+JOZ1hd8ws+O4bzj2b2Tclsd+8Ri1HqIKM1vT/6X+ATMsqm0qEHHZAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=696 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-2_16-37-11.ede9bd6.640.png srcset="/assets/ideal-img/image2021-7-2_16-37-11.ede9bd6.640.png 640w,/assets/ideal-img/image2021-7-2_16-37-11.28c34c0.2026.png 2026w" alt="" width=640 height=696></noscript></div>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAgElEQVR4nG2MSw7CMAwFc558bCex21IE3P9Ug4jUDepi9BbzNGmL4LMPXmG8N1v74zmFcwinVWoppOlBhLMdwb4PejdUBdWGSKO1Sq2V1IdjavjoiAg5Z3IplD9SH5NuyuMItnBUddXaql27ipPahOmOz8HotsRN0RHVJe8O1/EL+7RdKp9u584AAAAASUVORK5CYII=")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=381 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-2_16-38-49.1628a6b.640.png srcset="/assets/ideal-img/image2021-7-2_16-38-49.1628a6b.640.png 640w,/assets/ideal-img/image2021-7-2_16-38-49.0b7b292.2228.png 2228w" alt="" width=640 height=381></noscript></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=7wocsetexecworkflow><code>7）woc.setExecWorkflow</code><a href=#7wocsetexecworkflow class=hash-link aria-label="Direct link to 7wocsetexecworkflow" title="Direct link to 7wocsetexecworkflow">​</a></h4>
<ul>
<li>通过<code>woc.execWf</code>属性对象设置<code>woc</code>的<code>volumes</code>磁盘挂载。</li>
<li>通过<code>woc.setGlobalParameters</code>设置<code>woc</code>的<code>globalParams</code>全局变量。</li>
<li>通过<code>woc.substituteGlobalVariables</code>解析<code>woc.execWf.Spec</code>中的模板变量。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=8woccreatetemplatecontext><code>8）woc.createTemplateContext</code><a href=#8woccreatetemplatecontext class=hash-link aria-label="Direct link to 8woccreatetemplatecontext" title="Direct link to 8woccreatetemplatecontext">​</a></h4>
<p>通过<code>woc.CreateTemplateContext</code>创建<code>templateresolution.Context</code>，该对象用于<code>Workflow</code>中的<code>template</code>检索。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=9wocsubstituteparamsinvolumes><code>9）woc.substituteParamsInVolumes</code><a href=#9wocsubstituteparamsinvolumes class=hash-link aria-label="Direct link to 9wocsubstituteparamsinvolumes" title="Direct link to 9wocsubstituteparamsinvolumes">​</a></h4>
<p>通过<code>woc.substituteParamsInVolumes</code>方法解析替换<code>Volume</code>配置中的变量内容。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=10woccreatepvcs><code>10）woc.createPVCs</code><a href=#10woccreatepvcs class=hash-link aria-label="Direct link to 10woccreatepvcs" title="Direct link to 10woccreatepvcs">​</a></h4>
<p>通过<code>woc.createPVCs</code>方法根据<code>woc.execWf.Spec.VolumeClaimTemplates</code>配置创建<code>PVC</code>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=11wocexecutetemplate><code>11）woc.executeTemplate</code><a href=#11wocexecutetemplate class=hash-link aria-label="Direct link to 11wocexecutetemplate" title="Direct link to 11wocexecutetemplate">​</a></h4>
<ul>
<li>通过<code>woc.executeTemplate</code>方法开始执行<code>Workflow</code>中的<code>Template</code>，入口为<code>woc.execWf.Spec.Entrypoint</code>。</li>
</ul>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAECAYAAAC3OK7NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAdElEQVR4nF3NMQ7CMBBEUd8myka2s16vE+wCKBAt97/MR4YuxZN+M5rg7cC8oeY0LxxeSCmxrCuLCEmEsglhV+UcAz877exYdYYqL688q/Fx412VoFYZ9wft1v/agcZIzQlL8dd7jISYd3IpzME0b1eRi40vP/0/R2LPLl4AAAAASUVORK5CYII=")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=239 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-1_17-28-40.f6c32a0.640.png srcset="/assets/ideal-img/image2021-7-1_17-28-40.f6c32a0.640.png 640w,/assets/ideal-img/image2021-7-1_17-28-40.61d7610.1104.png 1104w" alt="" width=640 height=239></noscript></div>
<ul>
<li>内部会根据给定的<code>Entrypoint</code>先去<code>StoredTemplates</code>检索对应的<code>Template</code>对象，找到之后对该<code>Template</code>对象做深度拷贝并返回该拷贝对象。如果找不到则去<code>Workflow</code>对象中查找，并缓存、返回查找到的<code>Template</code>对象。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=12wocmergedtemplatedefaultsinto><code>12）woc.mergedTemplateDefaultsInto</code><a href=#12wocmergedtemplatedefaultsinto class=hash-link aria-label="Direct link to 12wocmergedtemplatedefaultsinto" title="Direct link to 12wocmergedtemplatedefaultsinto">​</a></h4>
<p>关于什么是<code>TemplateDefaults</code>请参考章节介绍：<a href=https://argoproj.github.io/argo-workflows/template-defaults/ target=_blank rel="noopener noreferrer">https://argoproj.github.io/argo-workflows/template-defaults/</a></p>
<p>通过<code>woc.mergedTemplateDefaultsInto</code>方法将用户配置的<code>TemplateDefaults</code>合并到当前操作的<code>Template</code>对象上。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=13commonprocessargs><code>13）common.ProcessArgs</code><a href=#13commonprocessargs class=hash-link aria-label="Direct link to 13commonprocessargs" title="Direct link to 13commonprocessargs">​</a></h4>
<p><code>common.ProcessArgs</code>方法主要用于<code>Template</code>的模板变量解析。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAMCAYAAABbayygAAAACXBIWXMAAAsTAAALEwEAmpwYAAABB0lEQVR4nFWQW07sQAwFsx2623H7kQyTDGKQEPvfUSGHe4X4sOyPUtnHS2Ry34Pna/B17JwRhNlVMic6J2MMlvBgc6f6zSfPmDxUeNOVcxWsd7R3Fvfg2IKzzD6568ougw8V3qVzHw3rjcU8L9OZkyOdW9lVeZrylM6HNHL0AoOI4LYn+xaoGasqfXSsVstA+j/QzMgI3I0KF/kzawWRlf4DJlsm25ZEGFlQJOaOlrn3/2Ct9qsuYyQVUGSltfYXtDkvk7ldUJ1StvrfH7ACWCbqhkV1Z6xKG8JL77QC674jjMcWPNJ523eODN7nyucUvuSFczSWLZLTlcOUm/7WvgoxxvV8F+Ebpxm9E2ks20EAAAAASUVORK5CYII=")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=745 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-2_19-43-57.9d49c8b.640.png srcset="/assets/ideal-img/image2021-7-2_19-43-57.9d49c8b.640.png 640w,/assets/ideal-img/image2021-7-2_19-43-57.d7bbc9f.2180.png 2180w" alt="" width=640 height=745></noscript></div>
<p>注意：<code>argo</code>内部中的变量分为两种，一种是<code>Workflow</code>全局生效的变量(<code>globalParams</code>)，一种是当前<code>Template</code>生效的本地变量(<code>localParams</code>)。其中全局变量也包括开发者自定义的输入/输出变量、<code>Workflow Annotations&Labels</code>，这些变量也是能被<code>Workflow</code>全局中访问。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAICAYAAADA+m62AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAq0lEQVR4nF2PS3LDMAxDfR5bogR+JMVuc/9bIWOmmcl0gRVAPHAzH7x+n7weJ89xcj1+uM6LgLLWylIKj+Pg1tUYY3KtxWGTwxfNnCKSKqW+g1BjB6gKNmmUKtlURTKw7/sn6DR3jnCaguggYDQzto5svPHZ6DEYEQyfdHd6OAFQboLchMKtw3K4uVFNKe1tfmP/0MoI55yTapb7Pua3tg7NBqBnSJrkU/8PXl0SfOsJXC30AAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=527 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-2_19-35-40.0f86027.640.png srcset="/assets/ideal-img/image2021-7-2_19-35-40.0f86027.640.png 640w,/assets/ideal-img/image2021-7-2_19-35-40.25b8bd5.2724.png 2724w" alt="" width=640 height=527></noscript></div>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAHCAYAAAAxrNxjAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAe0lEQVR4nG3NSRKEIBBEUe/DVANQ2Hr/a2UHIKFhuMjdq18bi6LkAlUFMYHoXowRzrmxTTTjaCfMGkQZzISU0liHIYQb/uxArRUiPKoLduS9fxT3E1ZtFDtcpYUmlAwrDVkzWAiJZukTttomul4+tw6uokFERq2/fa/DPxk1bTPopD4uAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=430 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-2_19-30-46.65743d4.640.png srcset="/assets/ideal-img/image2021-7-2_19-30-46.65743d4.640.png 640w,/assets/ideal-img/image2021-7-2_19-30-46.3203dc6.2864.png 2864w" alt="" width=640 height=430></noscript></div>
<p>在模板变量解析中，还有一个关键的点。<code>Argo</code>的模板变量是支持表达式的，表达式解析是使用 <code>github.com/antonmedv/expr</code> 组件。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAICAYAAADA+m62AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAuUlEQVR4nFWQW2rFMAxEs53GtiRLfoVcCt3/ok5x2lvoh9DHnJGGOcZa9KiMFrgJpgVVQ6WgJZNzIqXE0fqkuRGuVK94VbQIJZcHeM/RxqSq4B4UEc5HyP+gB+xzPVfcDSsFTx9YOh/xx/QGx8Rq5RrB5+xcPRhuzGpcJrhmSikc0QcRlft1M6/JGoNVjduE0J13g3mDE8mJEZUZztduIIIeDTP7e3/0sbBdhSlNhSWZyInIe5/Ib9ZvdgN8z5F0Hs8AAAAASUVORK5CYII=")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=515 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_14-38-26.73415f0.640.png srcset="/assets/ideal-img/image2021-7-3_14-38-26.73415f0.640.png 640w,/assets/ideal-img/image2021-7-3_14-38-26.4af2630.1928.png 1928w" alt="" width=640 height=515></noscript></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=14processedtmplmemoize><code>14）processedTmpl.Memoize</code><a href=#14processedtmplmemoize class=hash-link aria-label="Direct link to 14processedtmplmemoize" title="Direct link to 14processedtmplmemoize">​</a></h4>
<p><code>processdTmpl.Memoize</code>配置用于开发者自定义是否缓存当前<code>Template</code>执行结果，具体介绍请参考章节：<a href=https://argoproj.github.io/argo-workflows/memoization/#using-memoization target=_blank rel="noopener noreferrer">https://argoproj.github.io/argo-workflows/memoization/#using-memoization</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=15processedtmplgettype><code>15）processedTmpl.GetType</code><a href=#15processedtmplgettype class=hash-link aria-label="Direct link to 15processedtmplgettype" title="Direct link to 15processedtmplgettype">​</a></h4>
<p>接下来是<code>Template</code>执行的关键地方，根据不同的<code>Template</code>类型，执行不同的操作逻辑。从流程图中可以看到，最关键的是<code>Container</code>类型，以及<code>Steps&DAG</code>类型。其中<code>Container</code>类型是所有<code>Template</code>执行的终点，也就是说<code>Template</code>执行最终是需要一个容器来实现。而<code>Steps&DAG</code>类型用于控制用户编排的<code>Template</code>流程，通过循环执行的方式，最终也会落到<code>Container</code>类型中去执行。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvUlEQVR4nDWOzUrDQAAG9/2fxmOhWA+BtIKI6JqWYCmhMU1iusn+J9EyorSHuXxz+EYMLmJ9pFaet0KTJilZtsPGb5R29MZz1g5hw4hxAecj8+WH44ukLUrifMH7ERdGBuMRj3nHetuSbr9Ispa1bNg8l6xkxfK15EHWvBc94nR2VJ3hszOclONwbFgu7knyPat8jywbWnW9vhHiRDVY7j4OaBeZ4oy/pom/4YYNE3XTky6e6JRB+8jgwr/7BeZT3woGwBbjAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=400 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-2_20-29-45.61e5f2a.640.png srcset="/assets/ideal-img/image2021-7-2_20-29-45.61e5f2a.640.png 640w,/assets/ideal-img/image2021-7-2_20-29-45.005743c.3900.png 3900w" alt="" width=640 height=400></noscript></div>
<ul>
<li><strong>Suspend</strong></li>
</ul>
<p>Suspend类型的Template通过woc.executeSuspend方法实现，内部只是将当前的Template标记一下更新时间和Suspend的时间并重新丢回队列以便下一次判断。</p>
<ul>
<li><code>**Script**</code></li>
</ul>
<p><code>Script</code>类型的<code>Template</code>通过<code>woc.executeScript</code>方法实现，内部判断当前的<code>Script</code>是否有其他<code>Template</code>在使用，随后调用<code>woc.createWorkflowPod</code>创建<code>Pod</code>到<code>Kubernetes</code>中。</p>
<ul>
<li><code>**Resource**</code></li>
</ul>
<p><code>Resource</code>类型的<code>Template</code>通过<code>woc.executeResource</code>方法实现，<code>Resource</code>内容通过创建一个<code>argoexec</code>容器，并使用 <code>argoexec resource</code> 命令解析参数，容器创建通过调用<code>woc.createWorkflowPod</code>创建<code>Pod</code>到<code>Kubernetes</code>中。</p>
<ul>
<li><code>**Data**</code></li>
</ul>
<p><code>Data</code>类型的<code>Template</code>通过<code>woc.executeData</code>方法实现，<code>data</code>内容通过创建一个<code>argoexec</code>容器，并使用 <code>argoexec data</code> 命令解析参数，容器创建通过调用<code>woc.createWorkflowPod</code>创建<code>Pod</code>到<code>Kubernetes</code>中。</p>
<ul>
<li><code>**ContainerSet**</code></li>
</ul>
<p><code>ContainerSet</code>类型的<code>Template</code>通过<code>woc.executeContainerSet</code>方法实现，多个容器的创建通过调用<code>woc.createWorkflowPod</code>创建<code>Pod</code>到<code>Kubernetes</code>中。关于<code>ContainerSet</code>类型的<code>Template</code>介绍请参考：<a href=https://argoproj.github.io/argo-workflows/container-set-template/ target=_blank rel="noopener noreferrer">https://argoproj.github.io/argo-workflows/container-set-template/</a></p>
<ul>
<li><code>**Steps & DAG**</code></li>
</ul>
<p><code>Steps&DAG</code>类型的<code>Template</code>通过<code>woc.executeSteps</code>、<code>woc.executeDAG</code>方法实现，内部会对多个<code>Template</code>的流程进行控制，循环调用<code>woc.executeTemplate</code>方法执行每个<code>Template</code>。</p>
<ul>
<li><code>**Container**</code></li>
</ul>
<p>这部分是整个<code>Workflow Controller</code>调度的关键，是创建<code>Pod</code>的核心逻辑。<code>Container</code>类型的<code>Template</code>通过<code>woc.executeTemplate</code>方法实现。在该方法中，涉及到几点重要的<code>Pod</code>设置：</p>
<p>a）根据条件创建<code>Init/Wait Containers</code>，内部都是通过 <code>woc.newExecContainer </code> 创建容器，容器创建时并设置通用的环境变量以及<code>Volume</code>挂载。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAHCAYAAAAxrNxjAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAo0lEQVR4nDXPR44DMRAEQX1n1YZtyJHB6P/PSoGz0CFvgQLq1j3pefCYxWcOZiVZRVbycuWtfywVblVNz8VzNZ+VdG6YPCoQM0qE2jCzmd2c58n7PIlqTJWXCU+Ta81kw2ruoowIopIRjqpyV8XNGKroD8ZwuouqXZIZ+HDUdoqa/cMxnLUOjuNgzqYqcHfMDBG5uuBe2KcqishiDMPdrqUf/AJdvW1kGO4LcgAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=470 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_10-58-40.950bf63.640.png srcset="/assets/ideal-img/image2021-7-3_10-58-40.950bf63.640.png 640w,/assets/ideal-img/image2021-7-3_10-58-40.d563e3c.2284.png 2284w" alt="" width=640 height=470></noscript></div>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAANCAYAAACQN/8FAAAACXBIWXMAAAsTAAALEwEAmpwYAAABGElEQVR4nE2RWXLEIAxE5zpjNiEJDPYkqdz/UC9lnO2jiw8ejbr1GK1z7IM5Bq9uHFoYJdEk4+WWbIGHmqPuuDsfY/DZjZcVeo7EEAgxElO6QamVfRzMfTD6jrkjUijlVoyRR1WnSMFbo3rH+6D1QVUlf0MhhBucbrwdJ6/j5P08OS9nrVhO6/tLD1WjiyxHV6OpIUVI25MeNzQGSlygY6VgzXF13DpVjZTiAp5XoB9HF6HPgyqCSKWILNUY2f6Du1ZG7zRVaslYrUiMlO3Jtm1/YUbzFeQccz049vu8qkkp/9VjWplzMvad5o3WLnW6Gjn/9mjMWvk4Bm/NOa1zqtNyoseAho28ZrSGXvvMmRTCr67LtcLvMF++ds0YZNqHRAAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=804 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_10-52-34.0db564a.640.png srcset="/assets/ideal-img/image2021-7-3_10-52-34.0db564a.640.png 640w,/assets/ideal-img/image2021-7-3_10-52-34.1bfd0cd.2040.png 2040w" alt="" width=640 height=804></noscript></div>
<p>b）<code>addVolumeReferences</code> 根据将开发者自定义的<code>Volume</code>，按照名称关联挂载到<code>Pod的Init/Wait/Main  Containers</code>中。</p>
<p>c）<code>addSchedulingConstraints</code> 方法根据<code>WorkflowSpec</code>的配置来设置<code>Pod</code>调度的一些调度策略，包括：<code>NodeSelector/Affinity/Tolerations/SchedulerName/PriorityClassName/Priority/HostAliases/SecurityContext</code>。</p>
<p>d）<code>woc.addInputArtifactsVolumes</code> 对于<code>artifacts</code>功能特性来说是一个很重要的方法，将<code>Artifacts</code>相关的<code>Volume</code>挂载到<code>Pod</code>中，这些<code>Volume</code>包括：<code>/argo/inputs/artifacts</code> 、 <code>/mainctrfs</code>以及开发者在配置中设置的<code>Volume</code>地址。</p>
<p>如果<code>Template</code>类型为<code>Script</code>，那么会增加挂载一个 <code>/argo/staging</code> 的<code>emptyDir</code>类型的<code>Volume</code>，用于<code>Init/Wait/``Main Containers</code>之间共享<code>Resource</code>内容。我们来看一个官方的例子<code>(scripts-bash.yaml)</code>：</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtklEQVR4nHWQbQuDMAyEY1ub9b12OjfYYP//T95IQUVkHx4Cx90lLaWc8VhmfB4L3q2ieYcbM7QxIKKDnDNCCJAZQ4D3foeZYa3FOI4gMYkwDMO5gahrGxRj7G0ScM5DKY1BXUM0TRMEWZW8R7QjrNZXozSu64rXc8V3mVGcg2WGMeZYK8aUEgRpdM71KeHtdgl0owjCLvxDHtJaQ04R9xTBWp9XbpRaUUvBEj0K294s/6aUOhl/WylrvRZQ5owAAAAASUVORK5CYII=")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=663 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-5_19-53-5.554953c.640.png srcset="/assets/ideal-img/image2021-7-5_19-53-5.554953c.640.png 640w,/assets/ideal-img/image2021-7-5_19-53-5.9e70b19.2566.png 2566w" alt="" width=640 height=663></noscript></div>
<p>在使用<code>artifacts</code>配置的时候，它会创建一个名称为 <code>inputs-artifacts</code> 的<code>emptyDir</code>类型volume供<code>Init/Wait/Main  Containers共享artifacts数据。我们来看一个官方的例子(artifacts-passing.yaml)：</code></p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAALCAYAAABGbhwYAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAz0lEQVR4nHWQS3LEIAxEMQYJMJi/ff+TdkrMZMpJKotegJ5aLamcM3rvuHrHXTJG8HDWQin1Uykl1NYwBa4FLR6IwYOZobXGtm1LCwwhgJhgrIUlBjsH5xyIaMnKBO/9AuWxHH6PVG+VUiAKR8ARE4yxMMasJvUE83lizoleK+aZMDyDzP7XMcaIMQbuOXG3ipYzJLdEEud9fzdJPtlQPjatV1HyPvUBxZWIob+7/1vmmgMtJVwp4iB6LSK3e4I+BHjnkJhw8utmMn4d+QF+AcBFdoD9+pNhAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=680 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-5_19-48-52.7df3583.640.png srcset="/assets/ideal-img/image2021-7-5_19-48-52.7df3583.640.png 640w,/assets/ideal-img/image2021-7-5_19-48-52.eaf8819.2564.png 2564w" alt="" width=640 height=680></noscript></div>
<p>e）<code>addInitContainers &  addSidecars &  </code> <code>addOutputArtifactsVolumes</code> 将<code>Main Containers</code>中的<code>Volume</code>同步挂载到<code>Init/Wait Containers</code>中，以便于共享数据。从一个示例可以看到，<code>Main Containers</code>中的<code>Volume</code>在<code>Init/Wait Containers</code>中都有。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAx0lEQVR4nG2Q207GIBAGgbJQoBzbamN8/9ccQxP1r/FiLjbs4RvU2xicY9ByJq0rqxPEGKxSqFfOVriOg4/zZC+FmiJ9S4zVsxiN1hOFKjkTQmD1HieCd+5GJiI3s1nFGJlYazHGPM+pF3pr1FLI20aMARHL8t/ANTqf18V17PQZQ4Qolmj/NE/bvTVGq4xa6aXctBgJTn7jpJTujGZZnhtuW43+rqd1q/U2n7bzYeK1Rua3/GTsjfde6SmSvSM7oXpHWPTjwhdoaGvlicLwbAAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=633 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_11-15-51.1875c5e.640.png srcset="/assets/ideal-img/image2021-7-3_11-15-51.1875c5e.640.png 640w,/assets/ideal-img/image2021-7-3_11-15-51.0e2490a.2730.png 2730w" alt="" width=640 height=633></noscript></div>
<p>f）一些固定的环境变量设置，注意其中的<code>Template</code>环境变量设置，将整个<code>Template</code>对象转换为<code>Json</code>后塞到环境变量中，以便于后续容器读取：</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAECAYAAAC3OK7NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAZklEQVR4nCXKyRHCMBQFQeeD9fRXCZx/XkMhDn3rK6PoTJ7d7GiWJ7uCdwXlRsyJS1wehdkkM6hqohpzw+xP03jdN5dn4e58VvN5HiILjYGGGENI4j4x8sTdRa+FuSP94jxJmid+ARshPvNljk0XAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=282 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_10-23-46.9b73d30.640.png srcset="/assets/ideal-img/image2021-7-3_10-23-46.9b73d30.640.png 640w,/assets/ideal-img/image2021-7-3_10-23-46.906f472.2014.png 2014w" alt="" width=640 height=282></noscript></div>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAFCAYAAAB8ZH1oAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAbElEQVR4nGWOWw7DIAwEuQ/Gxo8Ek9z/XFsVlKhSP+ZrR6Mtqg5Th5qi9w4RWbTWFkSEWiuKmuPKGzkTHvZK3/GXJY4jMc6xqtIFzPwWn2pRC8xxIXMiTof5vkD/xcCIRBwBtf2RG4Pq/vaIH/nPTcPQI7+oAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=305 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_10-24-12.1aa8c1d.640.png srcset="/assets/ideal-img/image2021-7-3_10-24-12.1aa8c1d.640.png 640w,/assets/ideal-img/image2021-7-3_10-24-12.d4fd6fa.2402.png 2402w" alt="" width=640 height=305></noscript></div>
<p>g）<code>substituePodParams</code> 最后一次变量替换，特别是来源于<code>Workflow ConfigMap</code>或者<code>Volume</code>属性的变量。</p>
<p>h）<code>kubeclientset.CoreV1.Pods.Create</code> 将之前创建的<code>Pod</code>提交到<code>Kubernetes</code>执行创建。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAECAYAAAC3OK7NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAXklEQVR4nGXKQQ7CMAwF0ZyH1P72T1q4/8UGUbFAYvFWM2OvzdPFay2uNmeJs5tdjSNwfohRbaTkujYqERlfyWPO25yT0d64G7voFpLIzDv+Gr02tlEGGUGmOI74G9/I4j3SFKmtEgAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=234 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_10-37-11.59b5476.640.png srcset="/assets/ideal-img/image2021-7-3_10-37-11.59b5476.640.png 640w,/assets/ideal-img/image2021-7-3_10-37-11.354dd5e.2578.png 2578w" alt="" width=640 height=234></noscript></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=argoexec-container>ArgoExec Container<a href=#argoexec-container class=hash-link aria-label="Direct link to ArgoExec Container" title="Direct link to ArgoExec Container">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=核心结构-1>核心结构<a href=#核心结构-1 class=hash-link aria-label="Direct link to 核心结构" title="Direct link to 核心结构">​</a></h3>
<p>整个<code>agoexec</code>逻辑中涉及到的核心数据结构如下。</p>
<table><thead><tr><th>数据结构<th>简要介绍<tbody><tr><td><code>WorkflowExecutor</code><td><div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAECAYAAAC3OK7NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAXklEQVR4nGXKQQ7CMAwF0ZyH1P72T1q4/8UGUbFAYvFWM2OvzdPFay2uNmeJs5tdjSNwfohRbaTkujYqERlfyWPO25yT0d64G7voFpLIzDv+Gr02tlEGGUGmOI74G9/I4j3SFKmtEgAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=234 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_10-37-11.59b5476.640.png srcset="/assets/ideal-img/image2021-7-3_10-37-11.59b5476.640.png 640w,/assets/ideal-img/image2021-7-3_10-37-11.354dd5e.2578.png 2578w" alt="" width=640 height=234></noscript></div><br><br>用于<code>Init/Wait Containers</code>的运行管理核心对象。<tr><td><code>ContainerRuntimeExecutor</code><td><div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAFCAYAAAB8ZH1oAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAeElEQVR4nC3OSw4DMQgEUd/HP2iwlZn736siO1n07omiRCbvZ/O8DyuCCCF3ZJMxBr13WqsUVxAypMAO+M/dmaNTa70rimAvsXeiDDKTkCOdy8ack94bRZlkOnHQ2qxcyAx3YQea3fyFJ50pdP6TCD/wlx9z0FrjC1msTreMQT4iAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=336 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_11-1-26.ac530bb.640.png srcset="/assets/ideal-img/image2021-7-3_11-1-26.ac530bb.640.png 640w,/assets/ideal-img/image2021-7-3_11-1-26.cc82fa1.2082.png 2082w" alt="" width=640 height=336></noscript></div><br><br>如注释所示，用于与<code>Docker Container</code>进行交互的<code>API</code>接口。<tr><td><code>Artifact</code><td><div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAJCAYAAAALpr0TAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnElEQVR4nG2QyQ3DQAwD04+9Okg5/XfGQPIGMJA89BsMRb5Yb1VRRSjRl4oMmZnO89RxHHMv1FvupsxQRCgyZba0bP2CyBC3DYAife5cDzB5KTPF4kSCHLuH/QFB1VVCG4mxtj1x/3pH8xK+YEMMkRxzNOjrASZUVYqvcRbY8bvQNkKcKJ/I/rfBLmT+iO79SOx5Ysp0QQ+f6dr6AbncjHoKwpJMAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=598 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_11-32-4.906c076.640.png srcset="/assets/ideal-img/image2021-7-3_11-32-4.906c076.640.png 640w,/assets/ideal-img/image2021-7-3_11-32-4.6b69eae.2066.png 2066w" alt="" width=640 height=598></noscript></div><br><br><code>Artifact</code>资源管理对象。<tr><td><code>ArtifactDriver</code><td><div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAADCAYAAACqPZ51AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAVElEQVR4nB2MyxVCIRTE6AeEmft5av+FxYOL7JKMrKIreX++VJpIcyQsIR0ksfdmRBUZ5umHzKC6uXFVYm3Wmsw5GdlN+FBhwvcY+BJGZ/Na6y/+AER7LzevQiw6AAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=223 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_11-27-19.53e67eb.640.png srcset="/assets/ideal-img/image2021-7-3_11-27-19.53e67eb.640.png 640w,/assets/ideal-img/image2021-7-3_11-27-19.baec650.1510.png 1510w" alt="" width=640 height=223></noscript></div><br><br><div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAADCAYAAACqPZ51AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAZ0lEQVR4nFXDSwrCMBRA0axJKkrJRzFNX5NHa6o40UkQB+5/AVfozAPH2FjJty9RG2l+I9fPdtCGTE+SNro+Ys5jZn28GMuCaGXSdZtLZS4Ldym4wxFjQ2CQhD/5/8Fx8Zbgevbdjh99Szcv4YeTBQAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=212 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_11-31-15.b5337a3.640.png srcset="/assets/ideal-img/image2021-7-3_11-31-15.b5337a3.640.png 640w,/assets/ideal-img/image2021-7-3_11-31-15.2cf43af.2112.png 2112w" alt="" width=640 height=212></noscript></div><br><br>用于<code>Artifacts</code>的驱动管理。<code>Argo</code>默认支持多种<code>Artifacts</code>驱动。<tr><td><code>ArchiveStrategy</code><td><div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAACCAYAAABhYU3QAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAQElEQVR4nB3Jyw2AMAzA0C5EmuZXkGD/sYzSw5MPHp6bzOB5P2oXZsoyJSJOm4gwPHo6vm88i+U9J5mF2jxELn4KUR/XzfRuDgAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=122 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_11-36-44.025961b.640.png srcset="/assets/ideal-img/image2021-7-3_11-36-44.025961b.640.png 640w,/assets/ideal-img/image2021-7-3_11-36-44.8305d69.1706.png 1706w" alt="" width=640 height=122></noscript></div><br><br><code>ArchiveStrategy</code>用以标识该<code>Artifact</code>的压缩策略。</table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=argoexec-init><code>ArgoExec Init</code><a href=#argoexec-init class=hash-link aria-label="Direct link to argoexec-init" title="Direct link to argoexec-init">​</a></h3>
<p>只有在<code>Template</code>类型为<code>Script</code>或者带有<code>Artifacts</code>功能时，<code>Argo Workflow Controller</code>才会为<code>Pod</code>创建<code>Init Container</code>，该<code>Container</code>使用的是<code>argoexec</code>镜像，通过 <code>argoexec init</code> 命令启动运行。<code>Init Container</code>主要的职责是将<code>Script</code>的<code>Resource</code>读取或将依赖的<code>Artifacts</code>内容拉取，保存到本地挂载的共享<code>Volume</code>上，便于后续启动的<code>Main Container</code>使用。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAALCAYAAABGbhwYAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8UlEQVR4nGWQ3UsCQRTF/f//ARGCHiLTpI/XghCrrezRQpFe1nVmTZBm52PvqAkn5raru/hwmbmHH/eeexqZ8+CyHicPc5z2Bfe61ItqHEBCNxLovaT8PwKDYJyHsoT2k0A3OoC6UjxRF2Ankui9pvgxOZQh1mqrSzBAV28L2Jyw3W5g6d97HTSEs4HAZSQxSRRu378xlRqO1lC28MjGLWEqNOKlwUes0LpP+CW/5qn7qwMcxN3vBp+zDM27GUZxxhpPrEYgVw5LleMrNbgepvXV1cDPHyXnOE4ULp4lxnONvJy49+g8X3wzXHAfsq3m+AeaLpo9gI+O5gAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=688 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_11-41-5.a991005.640.png srcset="/assets/ideal-img/image2021-7-3_11-41-5.a991005.640.png 640w,/assets/ideal-img/image2021-7-3_11-41-5.ce535ed.2282.png 2282w" alt="" width=640 height=688></noscript></div>
<p>由于<code>Init Container</code>的执行流程比较简单，这里简单介绍一下。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=1iniexecutor--wfexecutorinit>1）<code>iniExecutor & wfExecutor.Init</code><a href=#1iniexecutor--wfexecutorinit class=hash-link aria-label="Direct link to 1iniexecutor--wfexecutorinit" title="Direct link to 1iniexecutor--wfexecutorinit">​</a></h4>
<p>首先创建<code>WorkflowExecutor</code>对象，该对象用于<code>Init/Wait Containers</code>的核心业务逻辑封装、流程控制执行。</p>
<p>在<code>WorkflowExecutor</code>对象创建时会同时创建<code>ContainerRuntimeExecutor</code>对象，用于<code>Docker Container</code>的交互，包括<code>Docker</code>终端输出读取、结果文件获取等重要操作。在默认情况下，<code>WorkflowExecutor</code>会创建一个<code>DockerExecutor</code>对象。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAECAYAAAC3OK7NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAbElEQVR4nCXKSxaEIAxFQdcj4AvIJ1H3v63bp3VQs9pan3QrPI8TcTP6YoxAh5FSppTy2v5RR8F9cl/OE4s7LtYK5nJ6HxzSF6sKEZPL4zWH0+qJWUUy9n3/oqlwtkptRmuGScgMSeScSSnxA1dkP5xDKkj7AAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=279 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_11-53-2.c36b3f9.640.png srcset="/assets/ideal-img/image2021-7-3_11-53-2.c36b3f9.640.png 640w,/assets/ideal-img/image2021-7-3_11-53-2.a59c576.1570.png 1570w" alt="" width=640 height=279></noscript></div>
<p>此外，大家可能会对于为何能与<code>Pod</code>内部的<code>Container</code>交互，并且如何获取到<code>Docker</code>的输出内容感觉好奇。那我们<code>describe</code>一个<code>Pod</code>来看大家也许就明白了：</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAJCAYAAAALpr0TAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsklEQVR4nG2Qxw7CMBBEvS642xsngEBw4v+/cdBacCDkMJLL2zKjaq1IKaG1hlLKPOecp7z3cM7BWgv1/TTGgIigtT6UkkrpGmNE8B6aCEqpf3VmtN7hQ5jS1sLIqD249YbX/Ybn5YzHNnDNEck5BGMQNMHSB2y1Yl0WDGasC2PtHdw7WimI3uPk3NxdZXlICdqY31FEE5iQ3MU1M0/nQXYUh0dmJL8xxgQlN8lMstsXvAGh8GDLEd2y6QAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=568 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_11-56-38.31ecf94.640.png srcset="/assets/ideal-img/image2021-7-3_11-56-38.31ecf94.640.png 640w,/assets/ideal-img/image2021-7-3_11-56-38.2305ca1.2542.png 2542w" alt="" width=640 height=568></noscript></div>
<p>可以看到，容器中挂载了<code>docker.dock</code>文件到本地，以便本地可以通过<code>docker</code>命令与<code>docker</code>进行交互。当然<code>Init Container</code>不会直接与<code>Docker</code>交互，往往只有<code>Wait Container</code>才会，所以<code>Init Container</code>中并没有挂载该<code>docker.sock</code>文件。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=2wfexecutorstagefiles><code>2）wfExecutor.StageFiles</code><a href=#2wfexecutorstagefiles class=hash-link aria-label="Direct link to 2wfexecutorstagefiles" title="Direct link to 2wfexecutorstagefiles">​</a></h4>
<p><code>wfExecutor.StageFiles</code>方法用于将<code>Script/Resource</code>（如果有）以文件形式存写入到本地挂载的<code>Volume</code>位置，这些<code>Volume</code>是<code>Container</code>之间共享后续操作，后续<code>Main Container</code>会通过共享<code>Volume</code>访问到这些文件。需要注意的是，不同的<code>Template</code>类型，内容来源以及写入的磁盘位置会不同：</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAHCAYAAAAxrNxjAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnElEQVR4nE2PW47DMAwDc571Q1Il2U5y/3NNkboF9mOgH5IiD8/ByOC8bsKdcMVN6b1/aZRSOF4xcO3c983MgalRa6XVSimV+lArh8f4uK5rsdZkzsXIJPyFimGy70do0jjPxZyTkYvwIDzpTZAu9NY5PCcqnXwpKoKaY+aIKKX8fSk7UUTIsD3keWlPzz3ix07sDWm79I//okf4BopdbYFSV5tEAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=449 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_11-59-59.b7980c3.640.png srcset="/assets/ideal-img/image2021-7-3_11-59-59.b7980c3.640.png 640w,/assets/ideal-img/image2021-7-3_11-59-59.196e379.1634.png 1634w" alt="" width=640 height=449></noscript></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=3wfexecutorloadartifacts>3）<code>wfExecutor.LoadArtifacts</code><a href=#3wfexecutorloadartifacts class=hash-link aria-label="Direct link to 3wfexecutorloadartifacts" title="Direct link to 3wfexecutorloadartifacts">​</a></h4>
<p>该方法仅在使用了<code>Artifacts</code>功能的场景下有效。负责将配置的<code>Artifact</code>拉取到本地，并根据压缩策略进行解压，修改权限，以便下一步<code>Main Container</code>访问。为便于扩展，<code>Artifacts</code>使用了<code>ArtifactDrive</code>接口设计，不同类型的<code>Artifact</code>可以分开实现，并根据类型进行引入，通过接口进行使用。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=argoexec-wait><code>ArgoExec Wait</code><a href=#argoexec-wait class=hash-link aria-label="Direct link to argoexec-wait" title="Direct link to argoexec-wait">​</a></h3>
<p>所有的<code>Argo Workflow Template</code>在执行时都会创建一个<code>Wait Container</code>，<strong>这是一个非常关键的<code>Container</code></strong>。该<code>Container</code>负责监控 <code>Main Container</code>的生命周期，在 <code>Main Container</code> 中的主要逻辑运行结束之后，负责将输出部分读取、持久化，这样 <code>Main Container</code> 就不用操心如何将该步产生的结果传到后面的步骤上的问题。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAHCAYAAAAxrNxjAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAdklEQVR4nGP48Pnb/49fvoPxh8/f/y888OT/8iPP/n/6ChGDYQZUhd/+rz729P/GU89RFIEVInPef/72f/mRp//XngApRBiAqfATkolINmFVuOro0//rT+JR+AmqcP7+J/+XHX5K2OpNp1/8337u5f+Pn1E9AwANMAaLAMr0rQAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=451 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_13-54-35.5e68e46.640.png srcset="/assets/ideal-img/image2021-7-3_13-54-35.5e68e46.640.png 640w,/assets/ideal-img/image2021-7-3_13-54-35.ea8f875.2846.png 2846w" alt="" width=640 height=451></noscript></div>
<p>由于<code>Wait Container</code>的执行流程比较简单，这里简单介绍一下。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=1wfxecutorwait>1）<code>wfxecutor.Wait</code><a href=#1wfxecutorwait class=hash-link aria-label="Direct link to 1wfxecutorwait" title="Direct link to 1wfxecutorwait">​</a></h4>
<p>该方法用于等待<code>Main Container</code>完成，我们看看默认的<code>DockerExecutor</code>底层是怎么实现的：</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAi0lEQVR4nE3NQQrDMAxE0VwnliXZlm26iKHQ+5/plySFdPF3j5kt+qDWwpiT2RstGtE7pVbcFNOMiLC1PlBVSjHc/UpNySfIQhJ5YHXlNYOIuKAkufuhZ9H0ur/XjD1nkpz9L8ZgtHpVTOmuHLXQ3TARPGf0hKNPlgnvqizLHLrzscTSxDJluRJp5wtyc10jwEcwNAAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=401 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_13-41-38.bea94c4.640.png srcset="/assets/ideal-img/image2021-7-3_13-41-38.bea94c4.640.png 640w,/assets/ideal-img/image2021-7-3_13-41-38.92681e9.1850.png 1850w" alt="" width=640 height=401></noscript></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=2wfexecutorcapturescriptresult>2）<code>wfExecutor.CaptureScriptResult</code><a href=#2wfexecutorcapturescriptresult class=hash-link aria-label="Direct link to 2wfexecutorcapturescriptresult" title="Direct link to 2wfexecutorcapturescriptresult">​</a></h4>
<p>通过捕获<code>Main Container</code>的终端输出，并保存输出结果。<strong>需要特别注意</strong>的是执行结果的大小，如果超过<code>256KB</code>将会被强行截断。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAICAYAAADA+m62AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvklEQVR4nE2PUWrEMAwFc51Yki1Z8TqhZbv96P2PNMVpC/0YBI95grdlHsxzMq+TPILoftO8YdVQ1ZvNI8lwejTMVig/mFJN70xE2CKTkcGVwRmNlxtvblytMauiIj9i78kRTvYgIqgquAqxvopQ/sToB2MkYxy4O0WNKkKuwr+7ZU8evXPmICN4VOVlhS8rfFjhqYVc4pJmduYxyN7xVmm/I9aYMKWpsM3Me8DTK59NededuZCdS3ceutPKzjeLuny5XF1b5AAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=534 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-6_14-38-0.0704dd9.640.png srcset="/assets/ideal-img/image2021-7-6_14-38-0.0704dd9.640.png 640w,/assets/ideal-img/image2021-7-6_14-38-0.833c0b3.2316.png 2316w" alt="" width=640 height=534></noscript></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=2wfexecutorsavelogs>2）<code>wfExecutor.SaveLogs</code><a href=#2wfexecutorsavelogs class=hash-link aria-label="Direct link to 2wfexecutorsavelogs" title="Direct link to 2wfexecutorsavelogs">​</a></h4>
<p>保存日志，默认情况下会保存到<code>argo</code>自带的<code>minio</code>服务（使用<code>S3</code>通信协议）中，该日志也可以被<code>Argo Server</code>中访问展示。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAHCAYAAAAxrNxjAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApklEQVR4nE2PQW4EIQwE5zuDwTY2MCttlP3/qyqCveRQF6vcrb5yLjKC9bzIDGY63h01+6KKtsoVYxHReWYS4bgbrTVEhPKPI/b+FXMEYwS9B7VWqggqQtvinIsRyRrBDGd0Z/bgt1XeKiy5WVK2+JBqvLKT3XFTQo2oijel3uVwrZ1odhI/m64Ma+fWRbD7Plx7tVsjXbG6qwqfVvhphVctZC3n4Q8ZLG1XEX5KjQAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=467 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_13-47-50.807e309.640.png srcset="/assets/ideal-img/image2021-7-3_13-47-50.807e309.640.png 640w,/assets/ideal-img/image2021-7-3_13-47-50.f9ce378.1714.png 1714w" alt="" width=640 height=467></noscript></div>
<p><code>Argo</code>默认的<code>ArtifactRepository</code>：</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAr0lEQVR4nDXNO27DMBREUW1HfE+UKEo0acf62AEi078mQBoX2f8mbhAGKW53MFN95Mw0LxynmZgSMTi6vsPaptSUlGq7v3h8fnO6fLHbL3hn6Z2lbRXb2gJFheqSn2z5wXreiPHAPuwIfqCuDbURjAgiQpWvd9bzO2/zQoyJFEaS9/RiaFXoVLC/cMs3jvPKtJwIMTEMI945GmNoREpaFm/Pgv7hOAZ6P/5dqpZUlR9tnWJJpr6LvwAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=407 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-5_17-48-35.5fed568.640.png srcset="/assets/ideal-img/image2021-7-5_17-48-35.5fed568.640.png 640w,/assets/ideal-img/image2021-7-5_17-48-35.6315b5b.2818.png 2818w" alt="" width=640 height=407></noscript></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=3wfxecutorsaveparameters>3）<code>wfxecutor.SaveParameters</code><a href=#3wfxecutorsaveparameters class=hash-link aria-label="Direct link to 3wfxecutorsaveparameters" title="Direct link to 3wfxecutorsaveparameters">​</a></h4>
<p>只有在<code>Template</code>中存在<code>Outputs</code>配置时才会执行该逻辑，该方法将容器执行的结果保存到当前 <code>Template.Outputs.Parameters</code> 中。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAJCAYAAAALpr0TAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAu0lEQVR4nF2PSXLDMAwE9R4SCwGCcpw4zv9f1SlJOTg+9AU1NZjeRiQ1k3mwijEGrTV67//YfASZQa0iIjFzxJQugoiiqojIEUxmOLc9qUpWTVZdt4wgIlCzq3EfzmNf3GeyD+Xmxo8pyxTp14wzaKaMGJj7+ab19sfLxkPmI4PHCr7qYHEfzqcr+i4z3NjXOqVEFRWhpOO9I6+NZob7RZqS0rEjeJpfbJWTxwyeK/mu4JmDEMF7O7F28Qtijout3bqfogAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=568 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_13-59-11.cd887c0.640.png srcset="/assets/ideal-img/image2021-7-3_13-59-11.cd887c0.640.png 640w,/assets/ideal-img/image2021-7-3_13-59-11.37fe4c4.2804.png 2804w" alt="" width=640 height=568></noscript></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=3wfxecutorsaveartifacts>3）<code>wfxecutor.SaveArtifacts</code><a href=#3wfxecutorsaveartifacts class=hash-link aria-label="Direct link to 3wfxecutorsaveartifacts" title="Direct link to 3wfxecutorsaveartifacts">​</a></h4>
<p>如果<code>Template</code>存在<code>Artifacts</code>操作时，该方法用于读取<code>Main Container</code>中的<code>Artifacts</code>保存到 <code>/mainctrfs</code> 目录，并且解压（<code>untar/unzip</code>）后保存临时目录<code>/tmp/argo/outputs/artifacts</code>下，随后将临时目录中的<code>Artifacts</code>文件将上传到<code>Artifact Repository</code>中。值得注意的是：</p>
<ul>
<li><code>/mainctrfs</code> 目录是<code>Wait Container</code>与<code>Main Container</code>的共享<code>Volume</code>，因此直接文件<code>Copy</code>即可。这是内部<code>Volume</code>交互，文件都是压缩（<code>tgz</code>）过后的，无须解压。</li>
<li>临时目录 <code>/tmp/argo/outputs/artifacts</code>下的<code>Artifacts</code>文件只是用于后续的<code>ArtifactDriver</code>上传到<code>Artifact Repository</code>中，并且上传的文件内容需要实现解压（<code>untar/unzip</code>），因为压缩的机制只是<code>argo</code>内部文件交互使用，并不对外部<code>ArtifactDriver</code>通用。</li>
<li>默认的<code>ArtifactRepository</code>是<code>minio</code>，因此执行结果也会保存到<code>minio</code>服务中。</li>
</ul>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAALCAYAAABGbhwYAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8UlEQVR4nC2QS5bDIAwEfZ0YJPTDTjKb3P9SNQ+ShTbQ6mr14ZG80/ncxWcGfz6YZtzu3DbIdmIqHOZBVPF8P5mvIiqJ/L6JDh6tIaJLmAwR5gyu+yLCkN7pfQk6ooKqcix0eDBnUpW4OdKF1tqex3kistHrczCnf5ER6DD6QraTfp6beNhyNKUyduiFKxVeQ7jWMdKJJawsrgyucp7ppDlvbZT07WT7GOG4spj7Usfc8HDUjdXGMGe0H/qKpNzILMYYe3uNitC7MHpDV49fx6JmkbX6y1+HSusd698Ix8zilc4VTo5BqOKyBG3n83Zu939Qk6vXvQSOtAAAAABJRU5ErkJggg==")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=703 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_14-17-9.e6437ef.640.png srcset="/assets/ideal-img/image2021-7-3_14-17-9.e6437ef.640.png 640w,/assets/ideal-img/image2021-7-3_14-17-9.54a322f.2328.png 2328w" alt="" width=640 height=703></noscript></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=4wfexecutorannotateoutputs>4）<code>wfExecutor.AnnotateOutputs</code><a href=#4wfexecutorannotateoutputs class=hash-link aria-label="Direct link to 4wfexecutorannotateoutputs" title="Direct link to 4wfexecutorannotateoutputs">​</a></h4>
<p><code>Wait Container</code>最后这一步操作很有意思。但是可能会使得<code>Metadata</code>中的<code>Annotation</code>会变得比较大。使用时需要注意，<code>Annotation</code>本身是有大小限制的，<code>Kubernetes</code>对于该项默认大小限制是<code>256KB</code>。</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAFCAYAAAB8ZH1oAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAh0lEQVR4nE2NSw7CMBDFep5MkpnJpxRSaAvc/0pGyoqFN0+W31Jb59hunGNwbZ3vvXH0ylorzZ1iiqfEUmqbw9Y7q9ukmtE041GwKKgIS2kdN6W4kXMixkgSQUQIf0zxaM57LZxNuXrhyJGRAnsMvFKY1SmWHNk9M1x5uPJU5WOJT1FOy/P6B5q5Ty+Y+4jEAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=300 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_14-20-25.7a5215e.640.png srcset="/assets/ideal-img/image2021-7-3_14-20-25.7a5215e.640.png 640w,/assets/ideal-img/image2021-7-3_14-20-25.2b1e201.1904.png 1904w" alt="" width=640 height=300></noscript></div>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtElEQVR4nD2Ny06DUBQA7/fc17lPFtCohaiE1AiFhljjyv//hjFl4WKS2UxGzdeFZV0Yp4mu6yilUmpDqZWU8j/qdh3Z15H+pSPETCmFnDMpZ2KKBBG01qj584P7184wDMQYkeAx1mKMxVqLPtyg5vWb+88vw9tEiZHmsRIheHdErbcEa1Hb8s5teaU/n2hL4dxUnmvm9CAn2iB451DbemHfLvT9ExISIoIXjxfBOYc25lj/AV/dZB1vMr7VAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=359 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_14-25-18.cb62094.640.png srcset="/assets/ideal-img/image2021-7-3_14-25-18.cb62094.640.png 640w,/assets/ideal-img/image2021-7-3_14-25-18.e184087.2300.png 2300w" alt="" width=640 height=359></noscript></div>
<p>这个<code>Annotations</code>会在<code>Workflow Controller</code>调度时被自动读取出来设置到<code>Template</code>的<code>Outputs</code>属性中，这样一个<code>Template</code>执行的输出便可以被其他关联的<code>Template</code>引用到：</p>
<div style='background-size:cover;background-repeat:no-repeat;position:relative;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtElEQVR4nD2Ny06DUBQA7/fc17lPFtCohaiE1AiFhljjyv//hjFl4WKS2UxGzdeFZV0Yp4mu6yilUmpDqZWU8j/qdh3Z15H+pSPETCmFnDMpZ2KKBBG01qj584P7184wDMQYkeAx1mKMxVqLPtyg5vWb+88vw9tEiZHmsRIheHdErbcEa1Hb8s5teaU/n2hL4dxUnmvm9CAn2iB451DbemHfLvT9ExISIoIXjxfBOYc25lj/AV/dZB1vMr7VAAAAAElFTkSuQmCC")'><svg style=width:100%;height:auto;max-width:100%;margin-bottom:-4px width=640 height=359 /><noscript><img style=width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0 src=/assets/ideal-img/image2021-7-3_14-25-18.cb62094.640.png srcset="/assets/ideal-img/image2021-7-3_14-25-18.cb62094.640.png 640w,/assets/ideal-img/image2021-7-3_14-25-18.e184087.2300.png 2300w" alt="" width=640 height=359></noscript></div>
<p>归根到底，从底层实现来讲，多个<code>Template</code>传递流程数据的方式主要依靠<code>Annotations、Artifacts</code>及共享<code>Volume</code>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=argoexec其他命令>ArgoExec其他命令<a href=#argoexec其他命令 class=hash-link aria-label="Direct link to ArgoExec其他命令" title="Direct link to ArgoExec其他命令">​</a></h3>
<p><code>ArgoExec</code>的其他命令（<code>data/resource/emissary</code>）主要用于流程调度过程中的内容解析，比较简单，这里不再做介绍，感兴趣可以看下源码。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=常见问题>常见问题<a href=#常见问题 class=hash-link aria-label="Direct link to 常见问题" title="Direct link to 常见问题">​</a></h2>
<p><code>Argo Workflow</code>的流程和主要逻辑梳理完了，接下来我们回答最开始的那几个问题。</p>
<p>由于篇幅较长，我们将问答内容迁移到了这里：<a href=/cloud-native/argo-workflow-faq>Argo Workflow常见问题</a></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/cloud-native/argo-workflow-introduction><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Argo Workflow介绍</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/cloud-native/argo-workflow-faq><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Argo Workflow常见问题</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#知识梳理 class="table-of-contents__link toc-highlight">知识梳理</a><li><a href=#充满好奇 class="table-of-contents__link toc-highlight">充满好奇</a><li><a href=#工程结构 class="table-of-contents__link toc-highlight">工程结构</a><li><a href=#workflow-controller class="table-of-contents__link toc-highlight">Workflow Controller</a><ul><li><a href=#基本架构 class="table-of-contents__link toc-highlight">基本架构</a><li><a href=#重要设计 class="table-of-contents__link toc-highlight">重要设计</a><li><a href=#核心结构 class="table-of-contents__link toc-highlight">核心结构</a><li><a href=#核心流程 class="table-of-contents__link toc-highlight">核心流程</a></ul><li><a href=#argoexec-container class="table-of-contents__link toc-highlight">ArgoExec Container</a><ul><li><a href=#核心结构-1 class="table-of-contents__link toc-highlight">核心结构</a><li><a href=#argoexec-init class="table-of-contents__link toc-highlight"><code>ArgoExec Init</code></a><li><a href=#argoexec-wait class="table-of-contents__link toc-highlight"><code>ArgoExec Wait</code></a><li><a href=#argoexec其他命令 class="table-of-contents__link toc-highlight">ArgoExec其他命令</a></ul><li><a href=#常见问题 class="table-of-contents__link toc-highlight">常见问题</a></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>