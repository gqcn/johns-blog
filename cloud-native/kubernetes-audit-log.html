<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/云原生/Kubernetes/Kubernetes审计日志开启与查看" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Kubernetes审计日志开启与查看 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/cloud-native/kubernetes-audit-log><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Kubernetes审计日志开启与查看 | John's Blog"><meta data-rh=true name=description content=详细介绍Kubernetes审计日志的背景、用途、开启方法和查看方式。包括审计策略配置、kube-apiserver参数设置、日志后端选择、审计事件格式解析等内容，帮助追踪资源删除等异常操作，提升集群安全性和可追溯性。><meta data-rh=true property=og:description content=详细介绍Kubernetes审计日志的背景、用途、开启方法和查看方式。包括审计策略配置、kube-apiserver参数设置、日志后端选择、审计事件格式解析等内容，帮助追踪资源删除等异常操作，提升集群安全性和可追溯性。><meta data-rh=true name=keywords content="Kubernetes,审计日志,Audit Log,kube-apiserver,审计策略,Audit Policy,资源删除,操作追踪,安全审计,日志分析,kubectl,API请求,审计事件,审计后端,日志文件,Webhook,集群安全,操作记录,故障排查,合规审计"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/cloud-native/kubernetes-audit-log><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/kubernetes-audit-log hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/kubernetes-audit-log hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="John's Blog RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="John's Blog Atom Feed"><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><link rel=stylesheet href=/assets/css/styles.1f745325.css><script src=/assets/js/runtime~main.ff581bb9.js defer></script><script src=/assets/js/main.66589fc4.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/ai>AI技术</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" sidebarid=mainSidebar href=/cloud-native>云原生</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/observability>可观测性</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href=/blog>博客</a><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/cloud-native>云原生</a><button aria-label="Collapse sidebar category '云原生'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/container>Container</a><button aria-label="Expand sidebar category 'Container'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/cloud-native/kubernetes>Kubernetes</a><button aria-label="Collapse sidebar category 'Kubernetes'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-common-commands>Kuberntes 常用命令</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-krew-plugins>Kuberntes krew常用插件</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-kustomize>Kubernetes kustomize</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-informer-client-go>Kubernetes Informer及client-go资料</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-aggregation-apiserver>Kubernetes Aggregation APIServer</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-crd-controller-operator>Kubernetes CRD, Controller, Operator</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-scheduler-framework>Kubernetes Scheduler Framework</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-network-policy>Kubernetes NetworkPolicy</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-common-issues>Kubernetes 常见问题</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-pod-stuck-issues>Pod stuck in ContainerCreating/Terminating</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-device-plugin>Kubernetes Device Plugin</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-kubelet-pod-eviction-process>Kubelet驱逐Pod详细流程</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-generate-bearer-token>Kubernetes生成Bearer Token方式</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/cloud-native/kubernetes-audit-log>Kubernetes审计日志开启与查看</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/argo-workflow>Argo Workflow</a><button aria-label="Expand sidebar category 'Argo Workflow'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/volcano>Volcano</a><button aria-label="Expand sidebar category 'Volcano'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kind>Kind</a><button aria-label="Expand sidebar category 'Kind'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/helm>Helm常用指令</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/dragonfly>Dragonfly介绍</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native><span itemprop=name>云原生</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native/kubernetes><span itemprop=name>Kubernetes</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Kubernetes审计日志开启与查看</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=1-背景与用途>1. 背景与用途<a href=#1-背景与用途 class=hash-link aria-label="Direct link to 1. 背景与用途" title="Direct link to 1. 背景与用途">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=11-什么是kubernetes审计日志>1.1 什么是Kubernetes审计日志<a href=#11-什么是kubernetes审计日志 class=hash-link aria-label="Direct link to 1.1 什么是Kubernetes审计日志" title="Direct link to 1.1 什么是Kubernetes审计日志">​</a></h3>
<p><code>Kubernetes</code>审计日志（<code>Audit Log</code>）是一种安全机制，用于记录集群中所有对<code>API Server</code>的请求操作。每个请求都会生成一个审计事件，包含请求的详细信息，如操作者、操作时间、操作对象、操作结果等。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=12-为什么需要审计日志>1.2 为什么需要审计日志<a href=#12-为什么需要审计日志 class=hash-link aria-label="Direct link to 1.2 为什么需要审计日志" title="Direct link to 1.2 为什么需要审计日志">​</a></h3>
<p>在生产环境中，我们经常会遇到以下问题：</p>
<ul>
<li><strong>资源被莫名删除</strong>：<code>Deployment</code>、<code>Service</code>等资源突然消失，不知道是谁删除的</li>
<li><strong>配置被意外修改</strong>：关键配置被修改导致服务异常，需要追溯修改记录</li>
<li><strong>安全合规要求</strong>：企业安全审计要求记录所有操作日志</li>
<li><strong>故障排查需要</strong>：需要回溯某个时间点的操作历史</li>
</ul>
<p>审计日志可以帮助我们：</p>
<ul>
<li>追踪所有API操作的完整记录</li>
<li>识别异常或恶意操作</li>
<li>满足安全合规要求</li>
<li>辅助故障排查和问题定位</li>
<li>分析集群使用情况和性能瓶颈</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=13-审计日志的工作原理>1.3 审计日志的工作原理<a href=#13-审计日志的工作原理 class=hash-link aria-label="Direct link to 1.3 审计日志的工作原理" title="Direct link to 1.3 审计日志的工作原理">​</a></h3>
<p>当用户或系统组件通过<code>kubectl</code>、API调用或控制器对<code>Kubernetes API Server</code>发起请求时，<code>API Server</code>会根据配置的审计策略生成审计事件，并将这些事件发送到配置的后端存储。</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=2-如何开启审计日志>2. 如何开启审计日志<a href=#2-如何开启审计日志 class=hash-link aria-label="Direct link to 2. 如何开启审计日志" title="Direct link to 2. 如何开启审计日志">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=21-创建审计策略文件>2.1 创建审计策略文件<a href=#21-创建审计策略文件 class=hash-link aria-label="Direct link to 2.1 创建审计策略文件" title="Direct link to 2.1 创建审计策略文件">​</a></h3>
<p>首先需要创建一个审计策略文件，定义哪些事件需要被记录以及记录的详细程度。</p>
<p>创建文件 <code>/etc/kubernetes/audit-policy.yaml</code>：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> audit.k8s.io/v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Policy</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 不记录请求体</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">omitStages</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"RequestReceived"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">rules</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 记录所有删除操作的详细信息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">level</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> RequestResponse</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">verbs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"delete"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"deletecollection"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">group</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"pods"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"services"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"configmaps"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"secrets"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">group</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"apps"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"deployments"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"statefulsets"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"daemonsets"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">group</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"batch"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"jobs"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cronjobs"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 记录所有创建、更新、打补丁操作的元数据</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">level</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Metadata</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">verbs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"create"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"update"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"patch"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">group</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"pods"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"services"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"configmaps"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"secrets"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">group</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"apps"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"deployments"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"statefulsets"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"daemonsets"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">group</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"batch"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"jobs"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cronjobs"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 记录所有认证失败的请求</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">level</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Metadata</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">omitStages</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"RequestReceived"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">users</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"system:anonymous"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 不记录只读操作（get, list, watch）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">level</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> None</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">verbs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"get"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"list"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"watch"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 不记录系统组件的心跳请求</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">level</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> None</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">users</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"system:kube-proxy"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"system:kube-scheduler"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"system:kube-controller-manager"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">verbs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"get"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"update"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">namespaces</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"kube-system"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">group</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"endpoints"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"services"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 不记录某些系统资源的操作</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">level</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> None</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">group</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"events"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认记录其他所有请求的元数据</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">level</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Metadata</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">omitStages</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"RequestReceived"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=审计级别说明>审计级别说明<a href=#审计级别说明 class=hash-link aria-label="Direct link to 审计级别说明" title="Direct link to 审计级别说明">​</a></h4>
<ul>
<li><strong>None</strong>：不记录该事件</li>
<li><strong>Metadata</strong>：记录请求的元数据（用户、时间戳、资源、操作等），但不记录请求体和响应体</li>
<li><strong>Request</strong>：记录元数据和请求体，但不记录响应体</li>
<li><strong>RequestResponse</strong>：记录元数据、请求体和响应体（最详细，但会产生大量日志）</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=22-配置kube-apiserver>2.2 配置kube-apiserver<a href=#22-配置kube-apiserver class=hash-link aria-label="Direct link to 2.2 配置kube-apiserver" title="Direct link to 2.2 配置kube-apiserver">​</a></h3>
<p>需要修改<code>kube-apiserver</code>的启动参数来启用审计日志。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 审计相关参数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">--audit-policy-file</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">/etc/kubernetes/audit-policy.yaml</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">--audit-log-path</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">/var/log/kubernetes/audit.log</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">--audit-log-maxage</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>30</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">--audit-log-maxbackup</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>10</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">--audit-log-maxsize</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>100</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>参数说明：</p>
<ul>
<li><code>--audit-policy-file</code>：审计策略文件本地路径</li>
<li><code>--audit-log-path</code>：审计日志文件本地路径</li>
<li><code>--audit-log-maxage</code>：日志文件保留天数</li>
<li><code>--audit-log-maxbackup</code>：保留的日志文件数量</li>
<li><code>--audit-log-maxsize</code>：单个日志文件最大大小（<code>MB</code>）</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=23-验证审计日志是否开启>2.3 验证审计日志是否开启<a href=#23-验证审计日志是否开启 class=hash-link aria-label="Direct link to 2.3 验证审计日志是否开启" title="Direct link to 2.3 验证审计日志是否开启">​</a></h3>
<p>检查<code>kube-apiserver</code>是否正常运行：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 查看kube-apiserver Pod状态</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl get pod </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> kube-system </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> kube-apiserver</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 查看kube-apiserver日志</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl logs </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> kube-system kube-apiserver-</span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">node-name</span><span class="token operator" style=color:#66d9ef>></span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>执行一个测试操作：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 创建一个测试Pod</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl run test-pod </span><span class="token parameter variable" style=color:#f8f8f2>--image</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">nginx</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 删除测试Pod</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl delete pod test-pod</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=3-到哪里查看审计日志>3. 到哪里查看审计日志<a href=#3-到哪里查看审计日志 class=hash-link aria-label="Direct link to 3. 到哪里查看审计日志" title="Direct link to 3. 到哪里查看审计日志">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=31-日志文件位置>3.1 日志文件位置<a href=#31-日志文件位置 class=hash-link aria-label="Direct link to 3.1 日志文件位置" title="Direct link to 3.1 日志文件位置">​</a></h3>
<p>如果使用文件后端，审计日志默认存储在配置的路径中（如 <code>/var/log/kubernetes/audit.log</code>）。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 12 16"><path fill-rule=evenodd d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"/></svg></span>tip</div><div class=admonitionContent_BuS1><p>审计日志文件存储在运行<code>kube-apiserver</code>的节点上，需要登录到该节点查看。如果是高可用集群，每个<code>kube-apiserver</code>节点都有各自的审计日志文件。</div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=在kube-apiserver节点上查看>在kube-apiserver节点上查看<a href=#在kube-apiserver节点上查看 class=hash-link aria-label="Direct link to 在kube-apiserver节点上查看" title="Direct link to 在kube-apiserver节点上查看">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 查看最新的审计日志</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>tail</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-f</span><span class="token plain"> /var/log/kubernetes/audit.log</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 查看最近100条日志</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>tail</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100</span><span class="token plain"> /var/log/kubernetes/audit.log</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 搜索特定资源的删除操作</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'"verb":"delete"'</span><span class="token plain"> /var/log/kubernetes/audit.log </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'"resource":"deployments"'</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 搜索特定用户的操作</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'"username":"admin"'</span><span class="token plain"> /var/log/kubernetes/audit.log</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=32-使用jq工具格式化查看>3.2 使用jq工具格式化查看<a href=#32-使用jq工具格式化查看 class=hash-link aria-label="Direct link to 3.2 使用jq工具格式化查看" title="Direct link to 3.2 使用jq工具格式化查看">​</a></h3>
<p>审计日志是<code>JSON</code>格式，可以使用<code>jq</code>工具进行格式化和过滤：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 格式化查看最新的审计事件</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>tail</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> /var/log/kubernetes/audit.log </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> jq </span><span class="token builtin class-name" style=color:#e6db74>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 查看所有删除操作</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>cat</span><span class="token plain"> /var/log/kubernetes/audit.log </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> jq </span><span class="token string" style=color:#a6e22e>'select(.verb=="delete")'</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 查看特定命名空间的操作</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>cat</span><span class="token plain"> /var/log/kubernetes/audit.log </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> jq </span><span class="token string" style=color:#a6e22e>'select(.objectRef.namespace=="default")'</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 查看特定时间范围的操作</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>cat</span><span class="token plain"> /var/log/kubernetes/audit.log </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> jq </span><span class="token string" style=color:#a6e22e>'select(.requestReceivedTimestamp >= "2024-11-10T00:00:00Z")'</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 统计各类操作的数量</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>cat</span><span class="token plain"> /var/log/kubernetes/audit.log </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> jq </span><span class="token parameter variable" style=color:#f8f8f2>-r</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'.verb'</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>sort</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>uniq</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-c</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>sort</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-rn</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=4-审计日志的内容格式>4. 审计日志的内容格式<a href=#4-审计日志的内容格式 class=hash-link aria-label="Direct link to 4. 审计日志的内容格式" title="Direct link to 4. 审计日志的内容格式">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=41-审计事件结构>4.1 审计事件结构<a href=#41-审计事件结构 class=hash-link aria-label="Direct link to 4.1 审计事件结构" title="Direct link to 4.1 审计事件结构">​</a></h3>
<p>每个审计事件都是一个<code>JSON</code>对象，包含以下主要字段：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-json codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"kind"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"Event"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"apiVersion"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"audit.k8s.io/v1"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"level"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"Metadata"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"auditID"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"a1b2c3d4-e5f6-7890-abcd-ef1234567890"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"stage"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"ResponseComplete"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"requestURI"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"/api/v1/namespaces/default/pods/test-pod"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"verb"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"delete"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"user"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"username"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"kubernetes-admin"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"uid"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"aws-iam-authenticator:123456789012:AIDAI..."</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"groups"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token string" style=color:#a6e22e>"system:masters"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token string" style=color:#a6e22e>"system:authenticated"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"sourceIPs"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token string" style=color:#a6e22e>"192.168.1.100"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"userAgent"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"kubectl/v1.28.0 (linux/amd64) kubernetes/1234567"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"objectRef"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"resource"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"pods"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"namespace"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"default"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"name"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"test-pod"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"apiVersion"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"v1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"responseStatus"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"metadata"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"code"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>200</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"requestReceivedTimestamp"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2024-11-10T08:30:15.123456Z"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"stageTimestamp"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2024-11-10T08:30:15.234567Z"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"annotations"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"authorization.k8s.io/decision"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"allow"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"authorization.k8s.io/reason"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"RBAC: allowed by ClusterRoleBinding \"cluster-admin\" of ClusterRole \"cluster-admin\" to Group \"system:masters\""</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=42-关键字段说明>4.2 关键字段说明<a href=#42-关键字段说明 class=hash-link aria-label="Direct link to 4.2 关键字段说明" title="Direct link to 4.2 关键字段说明">​</a></h3>
<table><thead><tr><th>字段<th>说明<th>示例值<tbody><tr><td><code>level</code><td>审计级别<td><code>Metadata</code>, <code>Request</code>, <code>RequestResponse</code><tr><td><code>auditID</code><td>审计事件唯一标识<td><code>a1b2c3d4-e5f6-7890-abcd-ef1234567890</code><tr><td><code>stage</code><td>请求处理阶段<td><code>RequestReceived</code>, <code>ResponseStarted</code>, <code>ResponseComplete</code>, <code>Panic</code><tr><td><code>requestURI</code><td>请求的<code>URI</code><td><code>/api/v1/namespaces/default/pods/test-pod</code><tr><td><code>verb</code><td>操作动词<td><code>get</code>, <code>list</code>, <code>create</code>, <code>update</code>, <code>patch</code>, <code>delete</code><tr><td><code>user.username</code><td>操作用户<td><code>kubernetes-admin</code>, <code>system:serviceaccount:default:my-sa</code><tr><td><code>user.groups</code><td>用户所属组<td><code>["system:masters", "system:authenticated"]</code><tr><td><code>sourceIPs</code><td>请求来源IP<td><code>["192.168.1.100"]</code><tr><td><code>userAgent</code><td>客户端标识<td><code>kubectl/v1.28.0 (linux/amd64)</code><tr><td><code>objectRef.resource</code><td>操作的资源类型<td><code>pods</code>, <code>deployments</code>, <code>services</code><tr><td><code>objectRef.namespace</code><td>资源所在命名空间<td><code>default</code>, <code>kube-system</code><tr><td><code>objectRef.name</code><td>资源名称<td><code>test-pod</code>, <code>nginx-deployment</code><tr><td><code>responseStatus.code</code><td>HTTP响应码<td><code>200</code>, <code>201</code>, <code>404</code>, <code>403</code><tr><td><code>requestReceivedTimestamp</code><td>请求接收时间<td><code>2024-11-10T08:30:15.123456Z</code><tr><td><code>stageTimestamp</code><td>当前阶段时间<td><code>2024-11-10T08:30:15.234567Z</code></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=43-常见操作动词>4.3 常见操作动词<a href=#43-常见操作动词 class=hash-link aria-label="Direct link to 4.3 常见操作动词" title="Direct link to 4.3 常见操作动词">​</a></h3>
<table><thead><tr><th>动词<th>说明<th>示例场景<tbody><tr><td><code>get</code><td>获取单个资源<td><code>kubectl get pod my-pod</code><tr><td><code>list</code><td>列出资源列表<td><code>kubectl get pods</code><tr><td><code>watch</code><td>监听资源变化<td><code>kubectl get pods --watch</code><tr><td><code>create</code><td>创建资源<td><code>kubectl create -f deployment.yaml</code><tr><td><code>update</code><td>更新资源（完整替换）<td><code>kubectl replace -f deployment.yaml</code><tr><td><code>patch</code><td>部分更新资源<td><code>kubectl patch deployment nginx -p '{"spec":{"replicas":3}}'</code><tr><td><code>delete</code><td>删除资源<td><code>kubectl delete pod my-pod</code><tr><td><code>deletecollection</code><td>批量删除资源<td><code>kubectl delete pods --all</code></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=44-请求处理阶段>4.4 请求处理阶段<a href=#44-请求处理阶段 class=hash-link aria-label="Direct link to 4.4 请求处理阶段" title="Direct link to 4.4 请求处理阶段">​</a></h3>
<table><thead><tr><th>阶段<th>说明<tbody><tr><td><code>RequestReceived</code><td><code>API Server</code>接收到请求<tr><td><code>ResponseStarted</code><td>开始发送响应头（仅用于长时间运行的请求，如<code>watch</code>）<tr><td><code>ResponseComplete</code><td>响应体发送完成<tr><td><code>Panic</code><td>请求处理过程中发生<code>panic</code></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=45-实际案例分析>4.5 实际案例分析<a href=#45-实际案例分析 class=hash-link aria-label="Direct link to 4.5 实际案例分析" title="Direct link to 4.5 实际案例分析">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=案例1deployment被删除>案例1：Deployment被删除<a href=#案例1deployment被删除 class=hash-link aria-label="Direct link to 案例1：Deployment被删除" title="Direct link to 案例1：Deployment被删除">​</a></h4>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-json codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"kind"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"Event"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"apiVersion"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"audit.k8s.io/v1"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"level"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"RequestResponse"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"auditID"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"abc123-def456-ghi789"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"stage"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"ResponseComplete"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"requestURI"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"/apis/apps/v1/namespaces/production/deployments/web-app"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"verb"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"delete"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"user"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"username"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"john.doe@example.com"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"groups"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"developers"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"system:authenticated"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"sourceIPs"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"10.0.1.50"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"userAgent"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"kubectl/v1.28.0 (darwin/amd64)"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"objectRef"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"resource"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"deployments"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"namespace"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"production"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"name"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"web-app"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"apiGroup"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"apps"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"apiVersion"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"v1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"responseStatus"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"code"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>200</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"requestReceivedTimestamp"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2024-11-10T08:30:15.123456Z"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"stageTimestamp"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2024-11-10T08:30:15.234567Z"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>分析结果</strong>：</p>
<ul>
<li>用户 <code>john.doe@example.com</code> 在 <code>2024-11-10 08:30:15</code> 从IP <code>10.0.1.50</code> 使用 <code>kubectl</code> 删除了 <code>production</code> 命名空间下的 <code>web-app</code> <code>Deployment</code></li>
<li>操作成功（响应码<code>200</code>）</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=案例2未授权的删除尝试>案例2：未授权的删除尝试<a href=#案例2未授权的删除尝试 class=hash-link aria-label="Direct link to 案例2：未授权的删除尝试" title="Direct link to 案例2：未授权的删除尝试">​</a></h4>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-json codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"kind"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"Event"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"apiVersion"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"audit.k8s.io/v1"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"level"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"Metadata"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"auditID"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"xyz789-abc123-def456"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"stage"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"ResponseComplete"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"requestURI"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"/api/v1/namespaces/kube-system/secrets/important-secret"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"verb"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"delete"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"user"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"username"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"system:serviceaccount:default:test-sa"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"groups"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"system:serviceaccounts"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"system:authenticated"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"sourceIPs"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"10.0.2.100"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"objectRef"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"resource"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"secrets"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"namespace"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"kube-system"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"name"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"important-secret"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"apiVersion"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"v1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"responseStatus"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"code"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>403</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token property" style=color:#f92672>"message"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"secrets \"important-secret\" is forbidden: User \"system:serviceaccount:default:test-sa\" cannot delete resource \"secrets\" in API group \"\" in the namespace \"kube-system\""</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"requestReceivedTimestamp"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2024-11-10T09:15:30.123456Z"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token property" style=color:#f92672>"stageTimestamp"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2024-11-10T09:15:30.145678Z"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>分析结果</strong>：</p>
<ul>
<li><code>ServiceAccount</code> <code>test-sa</code> 尝试删除 <code>kube-system</code> 命名空间下的 <code>Secret</code></li>
<li>操作被拒绝（响应码<code>403</code>），因为该 <code>ServiceAccount</code> 没有删除权限</li>
<li>这可能是一次安全事件，需要进一步调查</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=5-常见问题排查>5. 常见问题排查<a href=#5-常见问题排查 class=hash-link aria-label="Direct link to 5. 常见问题排查" title="Direct link to 5. 常见问题排查">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=51-审计日志未生成>5.1 审计日志未生成<a href=#51-审计日志未生成 class=hash-link aria-label="Direct link to 5.1 审计日志未生成" title="Direct link to 5.1 审计日志未生成">​</a></h3>
<p><strong>检查清单</strong>：</p>
<ol>
<li>确认<code>kube-apiserver</code>配置正确：</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl get pod </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> kube-system kube-apiserver-</span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">node</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-o</span><span class="token plain"> yaml </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> audit</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<ol start=2>
<li>检查审计策略文件是否存在且格式正确：</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token function" style=color:#e6db74>cat</span><span class="token plain"> /etc/kubernetes/audit-policy.yaml</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<ol start=3>
<li>查看 <code>kube-apiserver</code> 日志：</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl logs </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> kube-system kube-apiserver-</span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">node</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-i</span><span class="token plain"> audit</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<ol start=4>
<li>确认日志目录权限：</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token function" style=color:#e6db74>ls</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-ld</span><span class="token plain"> /var/log/kubernetes</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=52-日志文件过大>5.2 日志文件过大<a href=#52-日志文件过大 class=hash-link aria-label="Direct link to 5.2 日志文件过大" title="Direct link to 5.2 日志文件过大">​</a></h3>
<p>如果日志增长过快：</p>
<ol>
<li>调整审计策略，减少记录的事件</li>
<li>降低审计级别（从<code>RequestResponse</code>改为<code>Metadata</code>）</li>
<li>增加日志轮转频率</li>
<li>过滤更多的系统噪音</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=53-api-server性能下降>5.3 API Server性能下降<a href=#53-api-server性能下降 class=hash-link aria-label="Direct link to 5.3 API Server性能下降" title="Direct link to 5.3 API Server性能下降">​</a></h3>
<p>如果开启审计后 <code>API Server</code> 性能下降：</p>
<ol>
<li>检查是否使用了<code>RequestResponse</code>级别记录大量操作</li>
<li>考虑使用<code>webhook</code>后端异步处理</li>
<li>优化审计策略，减少不必要的记录</li>
<li>增加 <code>API Server</code> 资源配额</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=6-参考资料>6. 参考资料<a href=#6-参考资料 class=hash-link aria-label="Direct link to 6. 参考资料" title="Direct link to 6. 参考资料">​</a></h2>
<ul>
<li><a href=https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/audit/ target=_blank rel="noopener noreferrer">https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/audit/</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/cloud-native/kubernetes-generate-bearer-token><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Kubernetes生成Bearer Token方式</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/cloud-native/argo-workflow><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Argo Workflow</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#1-背景与用途 class="table-of-contents__link toc-highlight">1. 背景与用途</a><ul><li><a href=#11-什么是kubernetes审计日志 class="table-of-contents__link toc-highlight">1.1 什么是Kubernetes审计日志</a><li><a href=#12-为什么需要审计日志 class="table-of-contents__link toc-highlight">1.2 为什么需要审计日志</a><li><a href=#13-审计日志的工作原理 class="table-of-contents__link toc-highlight">1.3 审计日志的工作原理</a></ul><li><a href=#2-如何开启审计日志 class="table-of-contents__link toc-highlight">2. 如何开启审计日志</a><ul><li><a href=#21-创建审计策略文件 class="table-of-contents__link toc-highlight">2.1 创建审计策略文件</a><li><a href=#22-配置kube-apiserver class="table-of-contents__link toc-highlight">2.2 配置kube-apiserver</a><li><a href=#23-验证审计日志是否开启 class="table-of-contents__link toc-highlight">2.3 验证审计日志是否开启</a></ul><li><a href=#3-到哪里查看审计日志 class="table-of-contents__link toc-highlight">3. 到哪里查看审计日志</a><ul><li><a href=#31-日志文件位置 class="table-of-contents__link toc-highlight">3.1 日志文件位置</a><li><a href=#32-使用jq工具格式化查看 class="table-of-contents__link toc-highlight">3.2 使用jq工具格式化查看</a></ul><li><a href=#4-审计日志的内容格式 class="table-of-contents__link toc-highlight">4. 审计日志的内容格式</a><ul><li><a href=#41-审计事件结构 class="table-of-contents__link toc-highlight">4.1 审计事件结构</a><li><a href=#42-关键字段说明 class="table-of-contents__link toc-highlight">4.2 关键字段说明</a><li><a href=#43-常见操作动词 class="table-of-contents__link toc-highlight">4.3 常见操作动词</a><li><a href=#44-请求处理阶段 class="table-of-contents__link toc-highlight">4.4 请求处理阶段</a><li><a href=#45-实际案例分析 class="table-of-contents__link toc-highlight">4.5 实际案例分析</a></ul><li><a href=#5-常见问题排查 class="table-of-contents__link toc-highlight">5. 常见问题排查</a><ul><li><a href=#51-审计日志未生成 class="table-of-contents__link toc-highlight">5.1 审计日志未生成</a><li><a href=#52-日志文件过大 class="table-of-contents__link toc-highlight">5.2 日志文件过大</a><li><a href=#53-api-server性能下降 class="table-of-contents__link toc-highlight">5.3 API Server性能下降</a></ul><li><a href=#6-参考资料 class="table-of-contents__link toc-highlight">6. 参考资料</a></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>