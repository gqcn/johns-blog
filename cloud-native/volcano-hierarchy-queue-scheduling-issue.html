<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/云原生/Volcano/Volcano层级队列配置引发的调度器系统性故障问题" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Volcano层级队列配置引发的调度器系统性故障问题 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/cloud-native/volcano-hierarchy-queue-scheduling-issue><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Volcano层级队列配置引发的调度器系统性故障问题 | John's Blog"><meta data-rh=true name=description content="详细分析Volcano调度器中层级队列配置不当导致的系统性故障问题，包括capacity插件的工作原理、问题根因分析、源码逻辑梳理以及完整的解决方案。涵盖PodGroup一直处于Pending状态、调度器panic crash等典型故障场景的排查和修复方法。"><meta data-rh=true property=og:description content="详细分析Volcano调度器中层级队列配置不当导致的系统性故障问题，包括capacity插件的工作原理、问题根因分析、源码逻辑梳理以及完整的解决方案。涵盖PodGroup一直处于Pending状态、调度器panic crash等典型故障场景的排查和修复方法。"><meta data-rh=true name=keywords content="Volcano,Kubernetes,层级队列,capacity插件,调度器故障,PodGroup Pending,NotEnoughResources,队列配额,root队列,hierarchy队列,Gang调度,资源配额检查,调度器panic,overcommit插件,云原生调度"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/cloud-native/volcano-hierarchy-queue-scheduling-issue><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/volcano-hierarchy-queue-scheduling-issue hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/volcano-hierarchy-queue-scheduling-issue hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="John's Blog RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="John's Blog Atom Feed"><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><link rel=stylesheet href=/assets/css/styles.667035e4.css><script src=/assets/js/runtime~main.ac68b0e3.js defer></script><script src=/assets/js/main.7b246a3f.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/ai>AI技术</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" sidebarid=mainSidebar href=/cloud-native>云原生</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/observability>可观测性</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href=/blog>博客</a><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/cloud-native>云原生</a><button aria-label="Collapse sidebar category '云原生'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/container>Container</a><button aria-label="Expand sidebar category 'Container'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kubernetes>Kubernetes</a><button aria-label="Expand sidebar category 'Kubernetes'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/argo-workflow>Argo Workflow</a><button aria-label="Expand sidebar category 'Argo Workflow'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/cloud-native/volcano>Volcano</a><button aria-label="Collapse sidebar category 'Volcano'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-introduction>Volcano基本介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-startup-parameters>Volcano启动参数</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-examples>Volcano使用示例</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-annotations>Volcano常用注解</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-queue>Volcano Queue详解</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-job-task-podgroup-pod>Volcano Job/Task/PodGroup/Pod详解</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-queue-job-pod-preemption>Volcano Queue&Job&Pod资源抢占设计</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-scheduler-actions-plugins>Volcano Actions&Plugins详解</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-session-plugins-fns>Volcano Session Plugins方法介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/cloud-native/volcano-hierarchy-queue-scheduling-issue>Volcano层级队列配置引发的调度器系统性故障问题</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-hierarchy-queue-notes>Volcano层级队列使用的一些笔记</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/volcano-accelerator-card-quota-improvement>Volcano调度器支持智算卡Quota改进方案</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kind>Kind</a><button aria-label="Expand sidebar category 'Kind'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/helm>Helm常用指令</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/dragonfly>Dragonfly介绍</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native><span itemprop=name>云原生</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native/volcano><span itemprop=name>Volcano</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Volcano层级队列配置引发的调度器系统性故障问题</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=1-背景>1. 背景<a href=#1-背景 class=hash-link aria-label="Direct link to 1. 背景" title="Direct link to 1. 背景">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=11-版本信息>1.1 版本信息<a href=#11-版本信息 class=hash-link aria-label="Direct link to 1.1 版本信息" title="Direct link to 1.1 版本信息">​</a></h3>
<table><thead><tr><th>关键组件<th>版本<tbody><tr><td><code>kubernetes</code><td><code>1.27.5</code><tr><td><code>volcano</code><td><code>1.12.1</code></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=12-问题描述>1.2 问题描述<a href=#12-问题描述 class=hash-link aria-label="Direct link to 1.2 问题描述" title="Direct link to 1.2 问题描述">​</a></h3>
<p><code>Volcano Job</code>一直处于<code>Pending</code>状态，<code>Pod</code>没有创建出来。查看对应<code>PodGroup</code>的状态，也是处于<code>Pending</code>状态，且存在报错信息：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">status</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">conditions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">lastTransitionTime</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2025-07-30T07:56:43Z"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">message</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'1/0 tasks in gang unschedulable: pod group is not ready, 1 minAvailable'</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">reason</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NotEnoughResources</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">status</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"True"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">transitionID</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 6d79218e</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">2cd8</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">4728</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">a430</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">4d4e2bf0fb4a</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Unschedulable</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">phase</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Pending</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>看起来是资源不足（<code>NotEnoughResources</code>），但是不确定是哪种资源不足。但是，从查看节点的状态来看，节点资源是足够的，包括 CPU、内存、GPU卡数也是满足任务请求的资源要求。</p>
<p>通过查看<code>Volcano Scheduler Pod</code>的日志信息，发现存在报错信息，相关的报错信息类似于：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">E0815 02:53:22.165811 1 capacity.go:510] Failed to check queue's hierarchical structure, error; queue &lt;rot> capability is less than its child queue &lt;test-queue></span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><img decoding=async loading=lazy alt="alt text" src=/assets/images/image-b21b520f635b4e906931d15d2a930185.png width=3064 height=1564 class=img_ev3q>
或者</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">E0815 05:55:34.455546 1 capacity.go:612] Failed to check queue's hierarchical structure, error: queue &lt;root> capability &lt;cpu 30000.00, memory 24652726272.00, pods 330.00, ephemeral-storage 3243300384768000.00, hugepages-1Gi 0.00, hugepages-2Mi 0.00, hugepages-32Mi 0.00, hugepages-64Ki 0.00> is less than its child queue &lt;test-queue> capability &lt;cpu 20000000.00, memory 21474836480000.00, hugepages-2Mi 0.00, hugepages-32Mi 0.00, hugepages-64Ki 0.00, pods 330.00, ephemeral-storage 3243300384768000.00, hugepages-1Gi 0.00></span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><img decoding=async loading=lazy alt="alt text" src=/assets/images/image-1-21de0a4eda654b1169c3fb38a3b38777.png width=3032 height=1604 class=img_ev3q></p>
<p>该问题在<code>1.8.2</code>的<code>volcano</code>版本中（目前笔者旧版本集群使用的<code>volcano</code>版本），将会导致调度器组件直接<code>panic crash</code>。而在新版本如<code>1.12.1</code>以后，调度器不会<code>panic crash</code>，但是调度器仍然不能系统性工作，并且会在日志中不断打印错误日志。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=2-问题排查>2. 问题排查<a href=#2-问题排查 class=hash-link aria-label="Direct link to 2. 问题排查" title="Direct link to 2. 问题排查">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=21-源码实现逻辑梳理>2.1 源码实现逻辑梳理<a href=#21-源码实现逻辑梳理 class=hash-link aria-label="Direct link to 2.1 源码实现逻辑梳理" title="Direct link to 2.1 源码实现逻辑梳理">​</a></h3>
<p>通过错误日志所指向的源码文件，去理解源码的实现逻辑，关键代码在这里：<a href=https://github.com/volcano-sh/volcano/blob/f7acc998d1b23f045b3e3f53cdccff1695bbff37/pkg/scheduler/plugins/capacity/capacity.go#L659 target=_blank rel="noopener noreferrer">https://github.com/volcano-sh/volcano/blob/f7acc998d1b23f045b3e3f53cdccff1695bbff37/pkg/scheduler/plugins/capacity/capacity.go#L659</a></p>
<p>针对<code>capacity</code>插件的实现逻辑分析，发现在启用<code>capacity</code>插件后，当层级队列中配置的队列<code>capacity</code>、<code>deserved</code>或<code>guarantee</code>任一资源配额大于父队列的资源配额时，会导致<code>volcano</code>调度器系统性无法正常工作。由于是触发系统性的故障，因此即便其他队列的资源配额配置正确，调度器也无法为其他队列分配资源。</p>
<p>以下是针对该插件的一些关键逻辑介绍：</p>
<ol>
<li><code>volcano</code>调度器对每次任务（<code>volcano job</code>）的创建、修改都会调用<code>capability</code>插件进行处理。</li>
<li><code>capacity</code>插件会递归检查所有队列下的子级队列的<code>capability</code>、<code>deserved</code>和<code>guarantee</code>任一资源配额是否大于父队列的资源配额（任一资源）。如果发现有队列的资源配额大于父队列的资源配额，则会返回错误信息，并停止调度。</li>
<li><code>volcano</code>资源队列默认的<code>root</code>队列资源配额是集群的所有资源的总和（<code>nodes allocatable</code>），并且会随着节点变化或节点资源的变化而自动改变：<a href=https://github.com/volcano-sh/volcano/blob/f7acc998d1b23f045b3e3f53cdccff1695bbff37/pkg/scheduler/plugins/capacity/capacity.go#L503 target=_blank rel="noopener noreferrer">https://github.com/volcano-sh/volcano/blob/f7acc998d1b23f045b3e3f53cdccff1695bbff37/pkg/scheduler/plugins/capacity/capacity.go#L503</a></li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=22-为何子级队列配额会大于父级队列配额>2.2 为何子级队列配额会大于父级队列配额？<a href=#22-为何子级队列配额会大于父级队列配额 class=hash-link aria-label="Direct link to 2.2 为何子级队列配额会大于父级队列配额？" title="Direct link to 2.2 为何子级队列配额会大于父级队列配额？">​</a></h3>
<p>大致可分为以下几种情况：</p>
<ol>
<li><strong>队列配额设置不合理</strong>：子级配额资源配额的总量大于父级队列配额资源。在资源队列创建时，<code>volcano</code>没有对子级队列的资源配额做严格的、同步的资源检查，导致异常的子级队列被创建到了集群中（也许未来<code>volcano</code>对这块会有所改进）。</li>
<li><strong>集群节点异常导致队列可用资源变少</strong>：由于<code>volcano</code>的<code>root</code>队列默认是使用的集群的总资源大小（<code>nodes allocatable</code>，每次<code>session open</code>时重新计算），当集群的节点异常、节点被移除时，实际上<code>root</code>队列的可用资源会变少，导致子级队列的可用资源配额可能会大于父级队列的可用资源配额：<a href=https://github.com/volcano-sh/volcano/blob/36e949025f1abff74f2f18b080c6f91bde84db0a/pkg/scheduler/framework/session.go#L206 target=_blank rel="noopener noreferrer">https://github.com/volcano-sh/volcano/blob/36e949025f1abff74f2f18b080c6f91bde84db0a/pkg/scheduler/framework/session.go#L206</a></li>
<li><strong>在GPU Share场景中，对GPU进行拆卡后，整卡资源减少</strong>：在AI智算场景中，以<code>GPU</code>为例，当对<code>GPU</code>卡进行<code>MPS/MIG</code>拆卡后，会产生新的资源类型，但是原有的<code>GPU</code>整卡资源类型数量会减少。例如，原有节点有<code>8</code>张整卡的<code>nvidia.com/gpu</code>资源，对其中<code>4</code>张卡进行<code>MIG</code>拆卡后，原有的<code>nvidia.com/gpu</code>资源数量就会变为<code>4</code>，如果资源队列中有指定配额为<code>8</code>张卡，这个时候也会触发调度问题。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=3-解决方案>3. 解决方案<a href=#3-解决方案 class=hash-link aria-label="Direct link to 3. 解决方案" title="Direct link to 3. 解决方案">​</a></h2>
<p>同样的，这种使用开源组件的问题，通常不是我们第一个遇到，应该也会有其他的使用者遇到类似问题。因此检索了<code>volcano</code>社区的<code>issue</code>和<code>pr</code>，果然发现一个<code>pr</code>解决的问题和我们遇到的问题很类似：<a href=https://github.com/volcano-sh/volcano/pull/4354 target=_blank rel="noopener noreferrer">https://github.com/volcano-sh/volcano/pull/4354</a></p>
<p>这个<code>pr</code>提供的解决方案是这样的：</p>
<ol>
<li>首先再了解下背景，<code>volcano</code>默认会创建一个<code>root</code>的队列，该队列的资源配额（<code>capability</code>）是集群的总资源大小（<code>nodes allocatable</code>），且不可修改（即便修改了，保存后依然会被<code>volcano</code>调度器设置为集群节点的资源总和）。</li>
<li>该<code>pr</code>是允许使用者自定义<code>root</code>队列的配额（<code>capability</code>）大小，当自定义后，<code>volcano</code>调度器将不会自动覆盖该<code>root</code>队列的配额值。</li>
<li>使用者可以将<code>root</code>队列的配额设置成一个很大的值，这样就不会触发<code>capacity</code>插件的资源配额检查异常了。</li>
</ol>
<p>其他一些额外的注意事项：</p>
<ol>
<li>在创建资源队列时，需要做严格的子父级资源配额检查，确保子级队列的资源配额不会大于父级队列的资源配额。在产品功能上，尽可能通过接口或者程序的方式来实现队列创建，而不是直接通过<code>yaml</code>文件来创建。</li>
<li>虽然该<code>pr</code>已经合并入主分支，但目前<code>volcano</code>已发布的最新版本（<code>1.12.2</code>）并未包含该内容，如果需要使用该功能，需要自己编译源码和镜像来使用。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=4-测试内容>4. 测试内容<a href=#4-测试内容 class=hash-link aria-label="Direct link to 4. 测试内容" title="Direct link to 4. 测试内容">​</a></h2>
<p>以下是用于测试该问题的部署内容，主要使用CPU和内存进行测试。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=41-调度器配置>4.1 调度器配置<a href=#41-调度器配置 class=hash-link aria-label="Direct link to 4.1 调度器配置" title="Direct link to 4.1 调度器配置">​</a></h3>
<p>需要在<code>volcano</code>调度器的配置文件中，增加<code>capacity</code>插件，并配置使用<code>hierarchy</code>功能：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> capacity</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">enableHierarchy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>完整配置如下：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockTitle_Ktv7>volcano-scheduler-configmap.yaml</div><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">data</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">volcano-scheduler.conf</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token scalar string" style=color:#a6e22e></span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>    actions: "enqueue, allocate, backfill"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>    tiers:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>    - plugins:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      - name: priority</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      - name: gang</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>        enablePreemptable: false</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      - name: conformance</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>    - plugins:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      - name: overcommit</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      - name: drf</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>        enablePreemptable: false</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      - name: predicates</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      - name: capacity</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>        enableHierarchy: true</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      - name: nodeorder</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      - name: binpack</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ConfigMap</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> volcano</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">scheduler</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">configmap</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> volcano</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">system</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>注意事项</strong>：</p>
<ol>
<li>
<p>在<code>volcano</code>默认的调度器配置，<code>overcommit</code>插件是默认启用的，该插件允许集群的资源能够超额分配，默认超额比例（<code>overcommitRatio</code>）是<code>1.2</code>，例如<code>10</code>核CPU资源的集群，那么<code>overcommit</code>插件会允许调度器调度<code>12</code>核CPU的任务。</p>
</li>
<li>
<p><code>overcommit</code>插件还有一个隐藏功能，当队列的<code>capability</code>资源不够调度时，<code>overcommit</code>插件会阻止任务创建对应的<code>Pod</code>，以减少<code>Pending</code>的<code>Pod</code>数量。否则，即便队列资源不够，也会创建<code>Pod</code>，导致<code>Pending</code>的<code>Pod</code>数量不断增加。</p>
</li>
<li>
<p><code>capacity</code>插件和<code>proportion</code>插件是互斥的，两者只留其一。其中<code>proportion</code>插件是默认启用的，建议将<code>capacity</code>插件的配置位置修改到<code>proportion</code>位置处。</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=42-队列配置>4.2 队列配置<a href=#42-队列配置 class=hash-link aria-label="Direct link to 4.2 队列配置" title="Direct link to 4.2 队列配置">​</a></h3>
<p>修改<code>root</code>队列的配置，配置如下：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockTitle_Ktv7>root.yaml</div><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> scheduling.volcano.sh/v1beta1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Queue</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> root</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">capability</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>10000000</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 10000000Gi</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>该<code>root</code>队列的资源配额是是远超于集群的总资源大小，这样保证了<code>capacity</code>插件不会因为资源配额检查失败而停止调度。</p>
<p><strong>注意事项</strong>：</p>
<ol>
<li>只能修改<code>root</code>队列的<code>capability</code>资源配额，不能设置/修改<code>deserved</code>资源配额，在创建任务后会被调度器自动覆盖为<code>0</code>（不知是否为一个<code>BUG</code>）。也不能设置/修改<code>guarantee</code>资源配额。</li>
<li>在层级队列中，如果子队列带有<code>guarantee</code>配额设置，父队列不带<code>guarantee</code>配额只带有<code>capability</code>配额设置，任务依然能创建成功。</li>
</ol>
<p>创建一个<code>test-queue</code>队列，配置如下：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockTitle_Ktv7>test-queue.yaml</div><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> scheduling.volcano.sh/v1beta1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Queue</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> test</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">queue</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">capability</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>200</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 200Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">guarantee</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">resource</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>200</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 200Gi</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=43-job-配置>4.3 Job 配置<a href=#43-job-配置 class=hash-link aria-label="Direct link to 4.3 Job 配置" title="Direct link to 4.3 Job 配置">​</a></h3>
<p>创建一个<code>test-job</code>，配置如下：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockTitle_Ktv7>test-job.yaml</div><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> batch.volcano.sh/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Job</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> test</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">job</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">minAvailable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">schedulerName</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> volcano</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">queue</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> test</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">queue</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">policies</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">action</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> CompleteJob</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">event</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> TaskCompleted</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">tasks</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> master</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Never</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> alpine</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">latest</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> IfNotPresent</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> master</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"sh"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"-c"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"echo master"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 100m</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 100Mi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> worker</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Never</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> alpine</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">latest</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> IfNotPresent</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> worker</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"sh"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"-c"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"echo worker"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 100m</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 100Mi</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=参考资料>参考资料<a href=#参考资料 class=hash-link aria-label="Direct link to 参考资料" title="Direct link to 参考资料">​</a></h2>
<ul>
<li><a href=https://github.com/volcano-sh/volcano/pull/4354 target=_blank rel="noopener noreferrer">https://github.com/volcano-sh/volcano/pull/4354</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/cloud-native/volcano-session-plugins-fns><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Volcano Session Plugins方法介绍</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/cloud-native/volcano-hierarchy-queue-notes><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Volcano层级队列使用的一些笔记</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#1-背景 class="table-of-contents__link toc-highlight">1. 背景</a><ul><li><a href=#11-版本信息 class="table-of-contents__link toc-highlight">1.1 版本信息</a><li><a href=#12-问题描述 class="table-of-contents__link toc-highlight">1.2 问题描述</a></ul><li><a href=#2-问题排查 class="table-of-contents__link toc-highlight">2. 问题排查</a><ul><li><a href=#21-源码实现逻辑梳理 class="table-of-contents__link toc-highlight">2.1 源码实现逻辑梳理</a><li><a href=#22-为何子级队列配额会大于父级队列配额 class="table-of-contents__link toc-highlight">2.2 为何子级队列配额会大于父级队列配额？</a></ul><li><a href=#3-解决方案 class="table-of-contents__link toc-highlight">3. 解决方案</a><li><a href=#4-测试内容 class="table-of-contents__link toc-highlight">4. 测试内容</a><ul><li><a href=#41-调度器配置 class="table-of-contents__link toc-highlight">4.1 调度器配置</a><li><a href=#42-队列配置 class="table-of-contents__link toc-highlight">4.2 队列配置</a><li><a href=#43-job-配置 class="table-of-contents__link toc-highlight">4.3 Job 配置</a></ul><li><a href=#参考资料 class="table-of-contents__link toc-highlight">参考资料</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>