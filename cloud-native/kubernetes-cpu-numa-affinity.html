<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/云原生/Kubernetes/Kubernetes CPU&NUMA亲和性调度" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Kubernetes CPU&NUMA亲和性调度 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/cloud-native/kubernetes-cpu-numa-affinity><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=author content="John Guo"><meta data-rh=true property=og:image content=https://johng.cn/img/favicon.png><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Kubernetes CPU&NUMA亲和性调度 | John's Blog"><meta data-rh=true name=description content="深入解析Kubernetes中CPU和NUMA亲和性调度的完整实现方案。详细讲解Topology Manager、CPU Manager、Memory Manager和Device Manager四大核心组件的工作原理、配置方法和协同机制。涵盖kubelet完整配置示例、策略选项详解、NVIDIA GPU设备插件的NUMA感知功能、多种拓扑管理策略对比，以及实际测试案例和故障排查指南。适用于AI训练、推理等对CPU-GPU-内存局部性要求高的工作负载，助力性能优化和资源高效利用。"><meta data-rh=true property=og:description content="深入解析Kubernetes中CPU和NUMA亲和性调度的完整实现方案。详细讲解Topology Manager、CPU Manager、Memory Manager和Device Manager四大核心组件的工作原理、配置方法和协同机制。涵盖kubelet完整配置示例、策略选项详解、NVIDIA GPU设备插件的NUMA感知功能、多种拓扑管理策略对比，以及实际测试案例和故障排查指南。适用于AI训练、推理等对CPU-GPU-内存局部性要求高的工作负载，助力性能优化和资源高效利用。"><meta data-rh=true name=keywords content="Kubernetes,CPU亲和性,NUMA亲和性,Topology Manager,CPU Manager,Memory Manager,Device Manager,GPU调度,AI训练,kubelet配置,cpuset-cpus,cpuset-mems,PCIe拓扑,NUMA节点,QoS,nvidia-device-plugin,静态策略,拓扑感知调度"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/cloud-native/kubernetes-cpu-numa-affinity><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/kubernetes-cpu-numa-affinity hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/kubernetes-cpu-numa-affinity hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="John's Blog RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="John's Blog Atom Feed"><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><link rel=stylesheet href=/assets/css/styles.2f56d3c4.css><script src=/assets/js/runtime~main.11cb46fe.js defer></script><script src=/assets/js/main.815918c6.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" href=/ai>AI技术</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/cloud-native>云原生</a><a class="navbar__item navbar__link" href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/programming>开发语言</a><a class="navbar__item navbar__link" href=/architecture>技术架构</a><a class="navbar__item navbar__link" href=/observability>可观测性</a><a class="navbar__item navbar__link" href=/life>生活笔记</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href=/aboutme>关于我</a><a class="navbar__item navbar__link" href=/blog>博客</a><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/cloud-native>云原生</a><button aria-label="Collapse sidebar category '云原生'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/container>Container</a><button aria-label="Expand sidebar category 'Container'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/cloud-native/kubernetes>Kubernetes</a><button aria-label="Collapse sidebar category 'Kubernetes'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kubernetes-usage-notes>Kubernetes使用笔记</a><button aria-label="Expand sidebar category 'Kubernetes使用笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kubernetes-extension-development>Kubernetes扩展开发</a><button aria-label="Expand sidebar category 'Kubernetes扩展开发'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kubernetes-troubleshooting>Kubernetes问题排查</a><button aria-label="Expand sidebar category 'Kubernetes问题排查'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-kubelet-pod-eviction-process>Kubelet驱逐Pod详细流程</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-device-plugin>Kubernetes Device Plugin</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-network-policy>Kubernetes NetworkPolicy</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/cloud-native/kubernetes-cpu-numa-affinity>Kubernetes CPU&NUMA亲和性调度</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/argo-workflow>Argo Workflow</a><button aria-label="Expand sidebar category 'Argo Workflow'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/volcano>Volcano</a><button aria-label="Expand sidebar category 'Volcano'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/kind>Kind</a><button aria-label="Expand sidebar category 'Kind'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/helm>Helm常用指令</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/dragonfly>Dragonfly介绍</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/life>生活笔记</a><button aria-label="Expand sidebar category '生活笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native><span itemprop=name>云原生</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native/kubernetes><span itemprop=name>Kubernetes</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Kubernetes CPU&NUMA亲和性调度</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=背景与价值>背景与价值<a href=#背景与价值 class=hash-link aria-label="Direct link to 背景与价值" title="Direct link to 背景与价值">​</a></h2>
<p>在<code>AI</code>模型开发、训练和推理业务场景下，<code>CPU</code>亲和性与<code>NUMA</code>亲和性调度至关重要。现代服务器通常采用多<code>Socket</code>、多<code>NUMA</code>节点的架构，<code>GPU</code>等加速设备通过<code>PCIe</code>连接到特定的<code>NUMA</code>节点。如果<code>CPU</code>、<code>内存</code>和<code>GPU</code>分配在不同的<code>NUMA</code>节点上，数据访问将产生跨<code>NUMA</code>的内存延迟，显著降低训练和推理性能。通过合理配置<code>CPU</code>亲和性和<code>NUMA</code>亲和性，可以确保计算资源（<code>CPU</code>）、内存和加速设备（<code>GPU</code>）在同一<code>NUMA</code>节点内协同工作，最大化数据局部性，减少跨节点通信开销，从而提升<code>AI</code>工作负载的整体性能。</p>
<p>以典型的<code>8</code>卡<code>GPU</code>服务器为例，其拓扑结构如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">        GPU0    GPU1    GPU2    GPU3    GPU4    GPU5    GPU6    GPU7    CPU Affinity    NUMA Affinity</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU0     X      PIX     NODE    NODE    SYS     SYS     SYS     SYS     0-31,64-95      0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU1    PIX      X      NODE    NODE    SYS     SYS     SYS     SYS     0-31,64-95      0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU2    NODE    NODE     X      PIX     SYS     SYS     SYS     SYS     0-31,64-95      0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU3    NODE    NODE    PIX      X      SYS     SYS     SYS     SYS     0-31,64-95      0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU4    SYS     SYS     SYS     SYS      X      PIX     NODE    NODE    32-63,96-127    1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU5    SYS     SYS     SYS     SYS     PIX      X      NODE    NODE    32-63,96-127    1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU6    SYS     SYS     SYS     SYS     NODE    NODE     X      PIX     32-63,96-127    1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU7    SYS     SYS     SYS     SYS     NODE    NODE    PIX      X      32-63,96-127    1</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>可以看到：</p>
<ul>
<li><code>GPU 0-3</code>连接到<code>NUMA 0</code>，对应<code>CPU 0-31, 64-95</code></li>
<li><code>GPU 4-7</code>连接到<code>NUMA 1</code>，对应<code>CPU 32-63, 96-127</code></li>
</ul>
<p>通过<code>Kubernetes</code>的<code>NUMA</code>亲和性调度，可以确保使用<code>GPU 0-3</code>的<code>Pod</code>被分配到<code>NUMA 0</code>对应的<code>CPU</code>核心上。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=kubernetes-numa-亲和性关键组件>Kubernetes NUMA 亲和性关键组件<a href=#kubernetes-numa-亲和性关键组件 class=hash-link aria-label="Direct link to Kubernetes NUMA 亲和性关键组件" title="Direct link to Kubernetes NUMA 亲和性关键组件">​</a></h2>
<p><code>Kubernetes</code>通过<code>kubelet</code>中的多个<code>Manager</code>组件协同工作来实现<code>NUMA</code>亲和性调度：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">  ┌─────────────────────────────────────────────────────────────┐</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  │                        Topology Manager                     │</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  └─────────────────────────────────────────────────────────────┘</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            ↑                    ↑                    ↑</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            │                    │                    │</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   ┌────────┴────────┐   ┌───────┴────────┐   ┌───────┴────────┐</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   │   CPU Manager   │   │ Memory Manager │   │ Device Manager │</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   └─────────────────┘   └────────────────┘   └────────────────┘</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=组件功能概述>组件功能概述<a href=#组件功能概述 class=hash-link aria-label="Direct link to 组件功能概述" title="Direct link to 组件功能概述">​</a></h3>
<table><thead><tr><th>组件<th>功能<th>说明<tbody><tr><td><code>CPU Manager</code><td><code>CPU</code>亲和性管理<td>为<code>Guaranteed QoS Pod</code>分配独占<code>CPU</code>核心，提供<code>CPU</code>级别的拓扑提示<tr><td><code>Memory Manager</code><td>内存<code>NUMA</code>亲和性<td>为<code>Pod</code>分配特定<code>NUMA</code>节点的内存，确保内存访问本地化<tr><td><code>Device Manager</code><td>设备亲和性<td>管理<code>GPU</code>等设备的分配，提供设备所在<code>NUMA</code>节点的拓扑提示<tr><td><code>Topology Manager</code><td>拓扑协调中心<td>收集各<code>Manager</code>的拓扑提示，根据策略决定资源分配和<code>Pod</code>准入</table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=工作流程>工作流程<a href=#工作流程 class=hash-link aria-label="Direct link to 工作流程" title="Direct link to 工作流程">​</a></h3>
<ol>
<li><code>Pod</code>被调度到节点后，<code>kubelet</code>的<code>Topology Manager</code>开始协调资源分配</li>
<li>各<code>Manager</code>作为<code>Hint Provider</code>，向<code>Topology Manager</code>提供拓扑亲和性提示（<code>Hints</code>）</li>
<li><code>Topology Manager</code>根据配置的策略合并这些<code>Hints</code>，计算最优的<code>NUMA</code>节点分配</li>
<li>根据策略决定<code>Pod</code>的准入或拒绝</li>
<li>准入后，各<code>Manager</code>根据拓扑提示分配对应<code>NUMA</code>节点上的资源</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=关键组件配置详解>关键组件配置详解<a href=#关键组件配置详解 class=hash-link aria-label="Direct link to 关键组件配置详解" title="Direct link to 关键组件配置详解">​</a></h2>
<p>以下是启用<code>CPU</code>亲和性和<code>NUMA</code>亲和性调度的完整<code>kubelet</code>配置，该配置通常位于宿主机上的<code>/var/lib/kubelet/config.yaml</code>。随后我们会详细介绍每个组件的配置项：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> kubelet.config.k8s.io/v1beta1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> KubeletConfiguration</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ============= CPU Manager 配置 =============</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">cpuManagerPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> static                    </span><span class="token comment" style=color:#8292a2;font-style:italic># 启用静态CPU管理策略</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">cpuManagerReconcilePeriod</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 10s              </span><span class="token comment" style=color:#8292a2;font-style:italic># 调和周期</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">cpuManagerPolicyOptions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">full-pcpus-only</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain">                   </span><span class="token comment" style=color:#8292a2;font-style:italic># 仅分配完整物理核心</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">distribute-cpus-across-numa</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain">       </span><span class="token comment" style=color:#8292a2;font-style:italic># 跨NUMA均匀分配（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ============= Topology Manager 配置 =============</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">topologyManagerPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> restricted           </span><span class="token comment" style=color:#8292a2;font-style:italic># 严格要求NUMA对齐</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">topologyManagerScope</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pod                   </span><span class="token comment" style=color:#8292a2;font-style:italic># Pod级别对齐</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">topologyManagerPolicyOptions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">prefer-closest-numa-nodes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain">         </span><span class="token comment" style=color:#8292a2;font-style:italic># 优先选择距离最近的NUMA节点</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ============= Memory Manager 配置 =============</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">memoryManagerPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Static                 </span><span class="token comment" style=color:#8292a2;font-style:italic># 启用静态内存管理策略</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">reservedMemory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">numaNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 2Gi                           </span><span class="token comment" style=color:#8292a2;font-style:italic># NUMA 0 预留内存</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">numaNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 2Gi                           </span><span class="token comment" style=color:#8292a2;font-style:italic># NUMA 1 预留内存</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ============= 资源预留配置 =============</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kubeReserved</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 2Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">systemReserved</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 2Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">reservedSystemCPUs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"0-3"</span><span class="token plain">                   </span><span class="token comment" style=color:#8292a2;font-style:italic># 预留CPU 0-3给系统</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ============= 驱逐配置 =============</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">evictionHard</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">memory.available</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"100Mi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">nodefs.available</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"10%"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">imagefs.available</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"15%"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ============= Feature Gates（可选）=============</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">featureGates</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">CPUManagerPolicyOptions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">CPUManagerPolicyBetaOptions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">TopologyManagerPolicyOptions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=cpu-manager>CPU Manager<a href=#cpu-manager class=hash-link aria-label="Direct link to CPU Manager" title="Direct link to CPU Manager">​</a></h3>
<p><code>CPU Manager</code>负责为<code>Guaranteed QoS</code>的<code>Pod</code>分配独占<code>CPU</code>核心，避免<code>CPU</code>资源竞争带来的性能抖动。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=实现原理>实现原理<a href=#实现原理 class=hash-link aria-label="Direct link to 实现原理" title="Direct link to 实现原理">​</a></h4>
<ol>
<li><strong>共享池管理</strong>：<code>CPU Manager</code>维护一个共享<code>CPU</code>池，初始包含节点所有<code>CPU</code>（除预留<code>CPU</code>外）</li>
<li><strong>独占分配</strong>：对于<code>Guaranteed QoS</code>且<code>CPU</code>请求为整数的容器，从共享池中分配独占<code>CPU</code></li>
<li><strong>亲和性设置</strong>：通过<code>Linux cgroups</code>的<code>cpuset</code>将容器绑定到特定<code>CPU</code>核心</li>
<li><strong>状态持久化</strong>：分配状态存储在<code>/var/lib/kubelet/cpu_manager_state</code>文件中</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=前置配置要求>前置配置要求<a href=#前置配置要求 class=hash-link aria-label="Direct link to 前置配置要求" title="Direct link to 前置配置要求">​</a></h4>
<table><thead><tr><th>前置要求<th>说明<tbody><tr><td>静态策略前提<td>使用<code>static</code>策略时，必须配置<code>CPU</code>预留（<code>kubeReserved</code>、<code>systemReserved</code>或<code>reservedSystemCPUs</code>中至少一个大于<code>0</code>）<tr><td><code>QoS</code>要求<td>只有<code>Guaranteed QoS</code>的<code>Pod</code>才能获得独占<code>CPU</code><tr><td><code>CPU</code>请求要求<td><code>CPU</code>的<code>requests</code>和<code>limits</code>必须相等，且为<strong>整数</strong>值</table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=配置示例>配置示例<a href=#配置示例 class=hash-link aria-label="Direct link to 配置示例" title="Direct link to 配置示例">​</a></h4>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># ============= CPU Manager 配置 =============</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">cpuManagerPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> static                    </span><span class="token comment" style=color:#8292a2;font-style:italic># 启用静态CPU管理策略</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">cpuManagerReconcilePeriod</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 10s              </span><span class="token comment" style=color:#8292a2;font-style:italic># 调和周期</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">cpuManagerPolicyOptions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">full-pcpus-only</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain">                   </span><span class="token comment" style=color:#8292a2;font-style:italic># 仅分配完整物理核心</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">distribute-cpus-across-numa</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain">       </span><span class="token comment" style=color:#8292a2;font-style:italic># 跨NUMA均匀分配（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ============= 资源预留配置 =============</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kubeReserved</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 2Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">systemReserved</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 2Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">reservedSystemCPUs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"0-3"</span><span class="token plain">                   </span><span class="token comment" style=color:#8292a2;font-style:italic># 预留CPU 0-3给系统</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=配置参数>配置参数<a href=#配置参数 class=hash-link aria-label="Direct link to 配置参数" title="Direct link to 配置参数">​</a></h4>
<table><thead><tr><th>参数名称<th>可选值<th>默认值<th style=text-align:center>是否必须<th>说明<tbody><tr><td><code>cpuManagerPolicy</code><td><code>none</code>, <code>static</code><td><code>none</code><td style=text-align:center>否<td><code>CPU</code>管理策略。<code>none</code>不提供亲和性；<code>static</code>为<code>Guaranteed Pod</code>分配独占<code>CPU</code><tr><td><code>cpuManagerReconcilePeriod</code><td><code>Duration</code><td><code>10s</code><td style=text-align:center>否<td><code>CPU Manager</code>调和周期，定期检查并修正<code>CPU</code>分配<tr><td><code>cpuManagerPolicyOptions</code><td><code>Map</code><td><code>nil</code><td style=text-align:center>否<td>策略选项，用于精细调整<code>static</code>策略行为<tr><td><code>reservedSystemCPUs</code><td><code>CPU</code>列表<td><code>""</code><td style=text-align:center><code>static</code>策略时必须<td>为系统进程预留的<code>CPU</code>列表，如<code>0-3,8-11</code></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=cpumanagerpolicyoptions策略选项>cpuManagerPolicyOptions（策略选项）<a href=#cpumanagerpolicyoptions策略选项 class=hash-link aria-label="Direct link to cpuManagerPolicyOptions（策略选项）" title="Direct link to cpuManagerPolicyOptions（策略选项）">​</a></h4>
<table><thead><tr><th>选项名称<th>说明<tbody><tr><td><code>full-pcpus-only</code><td><strong>仅分配完整物理核心</strong>：启用后，<code>CPU Manager</code>只会为容器分配完整的物理核心，而不会分配单个硬件线程（超线程）。这可以有效避免<code>SMT</code>（<code>Simultaneous Multithreading</code>，超线程）带来的"吵闹邻居"问题，即多个进程共享同一物理核心的执行单元导致的性能干扰。对于<code>CPU</code>密集型和延迟敏感的<code>AI</code>训练任务，建议启用此选项以获得更稳定的性能表现。例如，在开启超线程的<code>64</code>核服务器上（<code>128</code>个逻辑核心），启用此选项后容器最多只能获得<code>64</code>个完整物理核心<tr><td><code>distribute-cpus-across-numa</code><td><strong>跨NUMA均匀分配CPU</strong>：当容器请求多个<code>CPU</code>核心时，<code>CPU Manager</code>会尽可能将这些核心均匀分配到多个<code>NUMA</code>节点上，而不是集中在单个<code>NUMA</code>节点。这种策略适合能够感知<code>NUMA</code>拓扑并进行并行计算的应用程序，可以充分利用多<code>NUMA</code>节点的内存带宽。但需要注意，此选项可能会增加跨<code>NUMA</code>内存访问的开销，不适合需要严格<code>NUMA</code>局部性的场景。通常与<code>Topology Manager</code>的<code>best-effort</code>策略配合使用<tr><td><code>align-by-socket</code><td><strong>按Socket对齐</strong>：在多<code>Socket</code>服务器上，优先在<code>Socket</code>边界对齐<code>CPU</code>分配，而非<code>NUMA</code>边界。在某些服务器架构中，一个<code>Socket</code>可能包含多个<code>NUMA</code>节点，此选项会尝试将容器的所有<code>CPU</code>分配在同一个物理<code>Socket</code>上，以减少跨<code>Socket</code>通信延迟。这对于需要频繁<code>CPU</code>间通信的应用（如共享<code>L3 Cache</code>）有性能优势。注意：此选项为<code>Alpha</code>特性，默认不启用<tr><td><code>distribute-cpus-across-cores</code><td><strong>跨物理核心分配虚拟核心</strong>：当容器请求的<code>CPU</code>数量少于节点物理核心数时，此选项会优先将虚拟核心（硬件线程）分配到不同的物理核心上，而不是集中在少数物理核心的多个硬件线程上。这样可以减少同一物理核心内多个线程之间的资源竞争（如执行单元、缓存冲突），提升整体吞吐量。例如，请求<code>4</code>个<code>CPU</code>时，会分配<code>4</code>个不同物理核心的单个线程，而不是<code>2</code>个物理核心的<code>4</code>个线程。注意：此选项为<code>Alpha</code>特性<tr><td><code>strict-cpu-reservation</code><td><strong>严格CPU预留</strong>：启用后，会严格隔离通过<code>reservedSystemCPUs</code>预留的<code>CPU</code>核心，确保任何<code>Pod</code>（包括<code>BestEffort</code>、<code>Burstable</code>和<code>Guaranteed QoS</code>）都无法使用这些预留的<code>CPU</code>。未启用时，预留的<code>CPU</code>仅对<code>Guaranteed QoS</code>的独占分配有效，<code>BestEffort</code>和<code>Burstable Pod</code>仍可能调度到这些核心上。对于需要为系统关键进程（如<code>kubelet</code>、容器运行时、系统守护进程）保证稳定<code>CPU</code>资源的生产环境，强烈建议启用此选项，避免节点过载导致的稳定性问题<tr><td><code>prefer-align-cpus-by-uncorecache</code><td><strong>优先按Uncore Cache对齐</strong>：<code>Uncore Cache</code>通常指<code>Last Level Cache（LLC，最后级缓存）</code>，它在多个<code>CPU</code>核心之间共享。启用此选项后，<code>CPU Manager</code>会尽可能将容器的所有<code>CPU</code>核心分配到共享同一<code>LLC</code>的核心组中。这可以显著提高缓存命中率，减少内存访问延迟，对于数据局部性要求高的应用（如<code>AI</code>推理服务、数据库）有明显性能提升。在现代服务器架构中，通常一个<code>NUMA</code>节点内的核心共享一个<code>LLC</code>，因此此选项与<code>NUMA</code>亲和性策略配合效果更佳</table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=topology-manager>Topology Manager<a href=#topology-manager class=hash-link aria-label="Direct link to Topology Manager" title="Direct link to Topology Manager">​</a></h3>
<p><code>Topology Manager</code>是<code>NUMA</code>亲和性的核心协调器，负责收集各<code>Manager</code>的拓扑提示并做出准入决策。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=实现原理-1>实现原理<a href=#实现原理-1 class=hash-link aria-label="Direct link to 实现原理" title="Direct link to 实现原理">​</a></h4>
<ol>
<li><strong>Hint收集</strong>：从<code>CPU Manager</code>、<code>Memory Manager</code>、<code>Device Manager</code>收集拓扑亲和性<code>Hints</code></li>
<li><strong>Hint合并</strong>：根据配置的策略合并所有<code>Hints</code>，找出满足所有资源需求的最优<code>NUMA</code>节点组合</li>
<li><strong>准入决策</strong>：根据策略决定是否允许<code>Pod</code>在该节点运行</li>
<li><strong>资源协调</strong>：通知各<code>Manager</code>按照合并后的<code>NUMA</code>节点分配资源</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=配置示例-1>配置示例<a href=#配置示例-1 class=hash-link aria-label="Direct link to 配置示例" title="Direct link to 配置示例">​</a></h4>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">topologyManagerPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> restricted           </span><span class="token comment" style=color:#8292a2;font-style:italic># 严格要求NUMA对齐</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">topologyManagerScope</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pod                   </span><span class="token comment" style=color:#8292a2;font-style:italic># Pod级别对齐</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">topologyManagerPolicyOptions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">prefer-closest-numa-nodes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain">         </span><span class="token comment" style=color:#8292a2;font-style:italic># 优先选择距离最近的NUMA节点</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=配置参数-1>配置参数<a href=#配置参数-1 class=hash-link aria-label="Direct link to 配置参数" title="Direct link to 配置参数">​</a></h4>
<table><thead><tr><th>参数名称<th>可选值<th>默认值<th style=text-align:center>是否必须<th>说明<tbody><tr><td><code>topologyManagerPolicy</code><td><code>none</code>, <code>best-effort</code>, <code>restricted</code>, <code>single-numa-node</code><td><code>none</code><td style=text-align:center><strong>是（启用<code>NUMA</code>亲和性时）</strong><td>拓扑管理策略，决定<code>NUMA</code>对齐的严格程度<tr><td><code>topologyManagerScope</code><td><code>container</code>, <code>pod</code><td><code>container</code><td style=text-align:center>否<td>拓扑管理的作用范围<tr><td><code>topologyManagerPolicyOptions</code><td><code>Map</code><td><code>nil</code><td style=text-align:center>否<td>策略选项，用于精细调整策略行为</table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=topologymanagerpolicy-详解>topologyManagerPolicy 详解<a href=#topologymanagerpolicy-详解 class=hash-link aria-label="Direct link to topologyManagerPolicy 详解" title="Direct link to topologyManagerPolicy 详解">​</a></h4>
<table><thead><tr><th>Policy<th>说明<th>适用场景<tbody><tr><td><code>none</code><td>不执行任何拓扑对齐，不影响资源分配<td>默认行为，不需要<code>NUMA</code>亲和性<tr><td><code>best-effort</code><td>优先选择<code>NUMA</code>对齐，但不强制。即使没有最优<code>NUMA</code>对齐，<code>Pod</code>也会被准入<td>希望<code>NUMA</code>对齐但允许降级<tr><td><code>restricted</code><td>仅允许<code>NUMA</code>对齐的<code>Pod</code>准入。如果无法满足最优对齐，<code>Pod</code>被拒绝<td><strong>推荐用于AI训练/推理场景</strong><tr><td><code>single-numa-node</code><td>仅允许所有资源都在<strong>同一个<code>NUMA</code>节点</strong>的<code>Pod</code>准入<td>延迟极度敏感的工作负载</table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=topologymanagerscope-详解>topologyManagerScope 详解<a href=#topologymanagerscope-详解 class=hash-link aria-label="Direct link to topologyManagerScope 详解" title="Direct link to topologyManagerScope 详解">​</a></h4>
<table><thead><tr><th>Scope<th>说明<th>特点<tbody><tr><td><code>container</code><td>在每个容器级别进行资源对齐<td>同一<code>Pod</code>的不同容器可能分配到不同<code>NUMA</code>节点<tr><td><code>pod</code><td>在<code>Pod</code>级别进行资源对齐<td><strong>推荐</strong>：所有容器分配到相同的<code>NUMA</code>节点集合，适合需要进程间通信的应用</table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=topologymanagerpolicyoptions策略选项>topologyManagerPolicyOptions（策略选项）<a href=#topologymanagerpolicyoptions策略选项 class=hash-link aria-label="Direct link to topologyManagerPolicyOptions（策略选项）" title="Direct link to topologyManagerPolicyOptions（策略选项）">​</a></h4>
<table><thead><tr><th>选项名称<th>说明<tbody><tr><td><code>prefer-closest-numa-nodes</code><td>优先选择距离最近的<code>NUMA</code>节点集合，减少跨<code>NUMA</code>通信延迟<tr><td><code>max-allowable-numa-nodes</code><td>允许超过<code>8</code>个<code>NUMA</code>节点的系统启用<code>Topology Manager</code>（默认限制<code>8</code>个）</table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=memory-manager>Memory Manager<a href=#memory-manager class=hash-link aria-label="Direct link to Memory Manager" title="Direct link to Memory Manager">​</a></h3>
<p><code>Memory Manager</code>负责为<code>Pod</code>分配特定<code>NUMA</code>节点的内存，确保内存访问本地化。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=实现原理-2>实现原理<a href=#实现原理-2 class=hash-link aria-label="Direct link to 实现原理" title="Direct link to 实现原理">​</a></h4>
<ol>
<li><strong>内存计数</strong>：跟踪每个<code>NUMA</code>节点的可用内存和已分配内存</li>
<li><strong>NUMA感知分配</strong>：根据<code>Topology Manager</code>的决策，从指定<code>NUMA</code>节点分配内存</li>
<li><strong>Hint提供</strong>：向<code>Topology Manager</code>提供内存的<code>NUMA</code>亲和性提示</li>
<li><strong>状态持久化</strong>：分配状态存储在<code>/var/lib/kubelet/memory_manager_state</code>文件中</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=配置示例-2>配置示例<a href=#配置示例-2 class=hash-link aria-label="Direct link to 配置示例" title="Direct link to 配置示例">​</a></h4>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">memoryManagerPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Static                 </span><span class="token comment" style=color:#8292a2;font-style:italic># 启用静态内存管理策略</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">reservedMemory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">numaNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 2Gi                           </span><span class="token comment" style=color:#8292a2;font-style:italic># NUMA 0 预留内存</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">numaNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 2Gi                           </span><span class="token comment" style=color:#8292a2;font-style:italic># NUMA 1 预留内存</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=配置参数-2>配置参数<a href=#配置参数-2 class=hash-link aria-label="Direct link to 配置参数" title="Direct link to 配置参数">​</a></h4>
<table><thead><tr><th>参数名称<th>可选值<th>默认值<th style=text-align:center>是否必须<th>说明<tbody><tr><td><code>memoryManagerPolicy</code><td><code>None</code>, <code>Static</code><td><code>None</code><td style=text-align:center>否<td>内存管理策略。<code>Static</code>为<code>Guaranteed Pod</code>提供内存<code>NUMA</code>亲和性<tr><td><code>reservedMemory</code><td><code>MemoryReservation</code>列表<td><code>nil</code><td style=text-align:center><code>Static</code>策略时必须<td>每个<code>NUMA</code>节点预留的内存量</table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=reserved-memory-配置>Reserved Memory 配置<a href=#reserved-memory-配置 class=hash-link aria-label="Direct link to Reserved Memory 配置" title="Direct link to Reserved Memory 配置">​</a></h4>
<p>使用<code>Static</code>策略时，必须配置每个<code>NUMA</code>节点预留的内存，且需满足：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">sum(reserved-memory) = kube-reserved + system-reserved + eviction-hard</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>其中：</p>
<ul>
<li><strong>kube-reserved</strong>：为<code>Kubernetes</code>系统组件（如<code>kubelet</code>、容器运行时）预留的资源</li>
<li><strong>system-reserved</strong>：为操作系统守护进程（如<code>sshd</code>、<code>systemd</code>）预留的资源</li>
<li><strong>eviction-hard</strong>：<strong>硬驱逐阈值</strong>，当节点资源使用达到该阈值时，<code>kubelet</code>会立即驱逐<code>Pod</code>以回收资源，避免节点资源耗尽。常见的驱逐信号包括：<!-- -->
<ul>
<li><code>memory.available</code>：可用内存低于阈值</li>
<li><code>nodefs.available</code>：节点文件系统可用空间低于阈值</li>
<li><code>imagefs.available</code>：镜像文件系统可用空间低于阈值</li>
<li><code>pid.available</code>：可用<code>PID</code>数量低于阈值</li>
</ul>
</li>
</ul>
<p><strong>evictionHard配置示例</strong>：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># kubelet配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">evictionHard</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">memory.available</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"100Mi"</span><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 可用内存低于100Mi时立即驱逐Pod</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">nodefs.available</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"10%"</span><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 节点文件系统可用空间低于10%时驱逐</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">imagefs.available</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"15%"</span><span class="token plain">       </span><span class="token comment" style=color:#8292a2;font-style:italic># 镜像文件系统可用空间低于15%时驱逐</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">nodefs.inodesFree</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"5%"</span><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 节点文件系统可用inode低于5%时驱逐</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>当<code>kubelet</code>配置不满足<code>sum(reserved-memory) = kube-reserved + system-reserved + eviction-hard</code>规则时，会报类似如下的错误：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">Failed to initialize memory manager</span><span class="token string" style=color:#a6e22e>" err="</span><span class="token plain">the total amount </span><span class="token string" style=color:#a6e22e>"xxx"</span><span class="token plain"> of </span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"memory"</span><span class="token plain"> is not equal to the value </span><span class="token string" style=color:#a6e22e>"xxx"</span><span class="token plain"> determined by Node Allocatable feature"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=device-manager>Device Manager<a href=#device-manager class=hash-link aria-label="Direct link to Device Manager" title="Direct link to Device Manager">​</a></h3>
<p><code>Device Manager</code>本身由设备插件（<code>Device Plugin</code>）实现，如<code>NVIDIA GPU</code>的<code>nvidia-device-plugin</code>。它向<code>Topology Manager</code>提供<code>GPU</code>设备所在<code>NUMA</code>节点的信息。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=工作机制>工作机制<a href=#工作机制 class=hash-link aria-label="Direct link to 工作机制" title="Direct link to 工作机制">​</a></h4>
<ol>
<li><strong>NUMA拓扑检测</strong>：<code>Device Plugin</code>启动时通过读取<code>/sys/bus/pci/devices/&lt;busid>/numa_node</code>文件自动检测每个<code>GPU</code>的<code>NUMA</code>节点信息</li>
<li><strong>设备注册</strong>：向<code>kubelet</code>注册设备资源（如<code>nvidia.com/gpu</code>），并在设备的<code>TopologyInfo</code>字段中携带<code>NUMA</code>节点信息</li>
<li><strong>Hints提供</strong>：当<code>Pod</code>请求<code>GPU</code>时，通过<code>GetPreferredAllocation</code>接口返回<code>NUMA</code>感知的设备分配建议</li>
<li><strong>拓扑协调</strong>：<code>Topology Manager</code>结合<code>CPU</code>、<code>Memory</code>和<code>GPU</code>的<code>Hints</code>，选择最优的<code>NUMA</code>节点组合</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=numa感知功能说明>NUMA感知功能说明<a href=#numa感知功能说明 class=hash-link aria-label="Direct link to NUMA感知功能说明" title="Direct link to NUMA感知功能说明">​</a></h4>
<p><strong>重要特性</strong>：<code>NVIDIA Device Plugin</code>从<code>v0.2.0</code>版本开始<strong>原生支持<code>NUMA</code>感知功能</strong>，无需额外配置即可自动启用。该功能基于以下机制：</p>
<ol>
<li><strong>自动检测</strong>：通过<code>NVML</code>库和<code>sysfs</code>自动获取<code>GPU</code>的<code>NUMA</code>节点信息</li>
<li><strong>透明传递</strong>：通过<code>Kubernetes Device Plugin API</code>的<code>TopologyInfo</code>结构体将<code>NUMA</code>信息传递给<code>kubelet</code></li>
<li><strong>智能分配</strong>：实现了<code>GetPreferredAllocation</code>接口，根据设备类型采用不同的分配策略：<!-- -->
<ul>
<li><strong>对齐分配</strong>：对于完整<code>GPU</code>，优先选择同一<code>NUMA</code>节点的设备</li>
<li><strong>分布式分配</strong>：对于<code>MIG</code>、<code>Time-slicing</code>等共享模式，均匀分布设备</li>
</ul>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=配置方式>配置方式<a href=#配置方式 class=hash-link aria-label="Direct link to 配置方式" title="Direct link to 配置方式">​</a></h4>
<p><code>NVIDIA Device Plugin</code>支持多种配置方式，可以通过<code>ConfigMap</code>、命令行参数或<code>Helm Chart</code>进行配置。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=configmap配置示例>ConfigMap配置示例<a href=#configmap配置示例 class=hash-link aria-label="Direct link to ConfigMap配置示例" title="Direct link to ConfigMap配置示例">​</a></h5>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ConfigMap</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">plugin</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">config</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">plugin</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">data</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">config.yaml</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token scalar string" style=color:#a6e22e></span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>    version: v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>    flags:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      migStrategy: "none"              # MIG策略: none, single, mixed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      failOnInitError: true             # 初始化失败时是否终止</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      nvidiaDriverRoot: "/"             # NVIDIA驱动根目录</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      plugin:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>        passDeviceSpecs: false          # 是否传递设备规范（与CPU Manager兼容时设为true）</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>        deviceListStrategy: "envvar"    # 设备列表策略: envvar, volume-mounts</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>        deviceIDStrategy: "uuid"        # 设备ID策略: uuid, index</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=关键配置参数>关键配置参数<a href=#关键配置参数 class=hash-link aria-label="Direct link to 关键配置参数" title="Direct link to 关键配置参数">​</a></h4>
<table><thead><tr><th>参数名称<th>可选值<th>默认值<th>说明<tbody><tr><td><code>migStrategy</code><td><code>none</code>, <code>single</code>, <code>mixed</code><td><code>none</code><td><code>MIG</code>模式策略。<code>none</code>表示不使用<code>MIG</code>；<code>single</code>表示每个<code>MIG</code>设备作为独立资源；<code>mixed</code>表示同时暴露完整<code>GPU</code>和<code>MIG</code>设备<tr><td><code>failOnInitError</code><td><code>true</code>, <code>false</code><td><code>true</code><td>初始化失败时是否终止插件。建议生产环境设为<code>true</code><tr><td><code>passDeviceSpecs</code><td><code>true</code>, <code>false</code><td><code>false</code><td>是否传递设备规范给容器。当启用<code>CPU Manager</code>的<code>static</code>策略时，需要设为<code>false</code>以避免权限问题<tr><td><code>deviceListStrategy</code><td><code>envvar</code>, <code>volume-mounts</code><td><code>envvar</code><td>设备列表传递方式。<code>envvar</code>通过环境变量<code>NVIDIA_VISIBLE_DEVICES</code>传递；<code>volume-mounts</code>通过挂载<code>/dev</code>设备节点<tr><td><code>deviceIDStrategy</code><td><code>uuid</code>, <code>index</code><td><code>uuid</code><td>设备标识策略。<code>uuid</code>使用<code>GPU UUID</code>；<code>index</code>使用设备索引</table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=关键组件配置更新>关键组件配置更新<a href=#关键组件配置更新 class=hash-link aria-label="Direct link to 关键组件配置更新" title="Direct link to 关键组件配置更新">​</a></h2>
<p>在执行测试之前，我们对<code>kubelet</code>的配置进行修改以启用<code>NUMA</code>亲和性特性：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> kubelet.config.k8s.io/v1beta1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> KubeletConfiguration</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ============= CPU Manager 配置 =============</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">cpuManagerPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> static                    </span><span class="token comment" style=color:#8292a2;font-style:italic># 启用静态CPU管理策略</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">cpuManagerReconcilePeriod</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 10s              </span><span class="token comment" style=color:#8292a2;font-style:italic># 调和周期</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">cpuManagerPolicyOptions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">full-pcpus-only</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain">                   </span><span class="token comment" style=color:#8292a2;font-style:italic># 仅分配完整物理核心</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ============= Topology Manager 配置 =============</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">topologyManagerPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> best</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">effort          </span><span class="token comment" style=color:#8292a2;font-style:italic># 希望NUMA对齐但允许降级</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">topologyManagerScope</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pod                   </span><span class="token comment" style=color:#8292a2;font-style:italic># Pod级别对齐</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">topologyManagerPolicyOptions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">prefer-closest-numa-nodes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain">         </span><span class="token comment" style=color:#8292a2;font-style:italic># 优先选择距离最近的NUMA节点</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ============= Memory Manager 配置 =============</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">memoryManagerPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Static                 </span><span class="token comment" style=color:#8292a2;font-style:italic># 启用静态内存管理策略</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">reservedMemory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">numaNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 2Gi                           </span><span class="token comment" style=color:#8292a2;font-style:italic># NUMA 0 预留内存</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">numaNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 2Gi                           </span><span class="token comment" style=color:#8292a2;font-style:italic># NUMA 1 预留内存</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ============= 资源预留配置 =============</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 注意需要保证公式：</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># sum(reserved-memory) = kube-reserved + system-reserved + eviction-hard</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kubeReserved</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 1Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">systemReserved</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 1Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">evictionHard</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">memory.available</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2Gi"</span><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 可用内存低于2Gi时立即驱逐Pod</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">nodefs.available</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"10%"</span><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 节点文件系统可用空间低于10%时驱逐</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">imagefs.available</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"15%"</span><span class="token plain">       </span><span class="token comment" style=color:#8292a2;font-style:italic># 镜像文件系统可用空间低于15%时驱逐</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">nodefs.inodesFree</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"5%"</span><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 节点文件系统可用inode低于5%时驱逐</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ============= Feature Gates（可选）=============</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">featureGates</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">CPUManagerPolicyOptions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">CPUManagerPolicyBetaOptions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">TopologyManagerPolicyOptions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 低版本K8S需要此项启用策略选项，如笔者当前的1.27.3版本</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">TopologyManagerPolicyAlphaOptions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ... 其他配置项保持不变 ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>按照以下步骤更新<code>kubelet</code>配置并重启：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 1. Drain节点（建议）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl drain </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">node-name</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"> --ignore-daemonsets --delete-emptydir-data</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 2. 停止kubelet</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">systemctl stop kubelet</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 3. 删除状态文件</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>rm</span><span class="token plain"> /var/lib/kubelet/cpu_manager_state</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>rm</span><span class="token plain"> /var/lib/kubelet/memory_manager_state</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 4. 修改kubelet配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>vim</span><span class="token plain"> /var/lib/kubelet/config.yaml</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 5. 启动kubelet</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">systemctl start kubelet</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 6. Uncordon节点（若前面执行了drain）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl uncordon </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">node-name</span><span class="token operator" style=color:#66d9ef>></span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>需要注意切换策略需要清理状态文件，否则会报类似如下的错误：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">start cpu manager error: could not restore state from checkpoint: configured policy "static" differs from state checkpoint policy "none", please drain this node and delete the CPU manager checkpoint file "/var/lib/kubelet/cpu_manager_state" before restarting Kubelet"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=测试示例>测试示例<a href=#测试示例 class=hash-link aria-label="Direct link to 测试示例" title="Direct link to 测试示例">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=验证numa亲和性>验证NUMA亲和性<a href=#验证numa亲和性 class=hash-link aria-label="Direct link to 验证NUMA亲和性" title="Direct link to 验证NUMA亲和性">​</a></h3>
<p>以下示例使用<code>NVIDIA CUDA</code>镜像，通过<code>nvidia-smi topo -m</code>命令验证<code>GPU</code>的<code>NUMA</code>亲和性配置：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Pod</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> numa</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">affinity</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">test</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Never</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> cuda</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">container</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia/cuda</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">12.2.0</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">base</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">ubuntu20.04</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> /bin/bash</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">c</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token scalar string" style=color:#a6e22e></span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo "========== GPU Topology Information =========="</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      nvidia-smi topo -m</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo ""</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo "========== CPU Affinity Information =========="</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo "Current CPU affinity: $(taskset -p $$)"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      cat /proc/self/status | grep -E "Cpus_allowed|Mems_allowed"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo ""</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo "========== NUMA Information =========="</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      numactl --hardware 2>/dev/null || echo "numactl not available"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo ""</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo "========== Process CPU Binding =========="</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      cat /proc/self/cpuset</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo ""</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo "========== Sleeping for observation =========="</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      sleep 3600</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># Guaranteed QoS: requests == limits</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># CPU必须是整数才能获得独占CPU</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"4"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8Gi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"4"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8Gi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=多gpu-numa亲和性测试>多GPU NUMA亲和性测试<a href=#多gpu-numa亲和性测试 class=hash-link aria-label="Direct link to 多GPU NUMA亲和性测试" title="Direct link to 多GPU NUMA亲和性测试">​</a></h3>
<p>以下示例请求同一<code>NUMA</code>节点的多个<code>GPU</code>：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Pod</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> multi</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">gpu</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">numa</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">test</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> default</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Never</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> cuda</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">multi</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">gpu</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia/cuda</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">12.2.0</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">base</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">ubuntu20.04</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> /bin/bash</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">c</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token scalar string" style=color:#a6e22e></span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo "========== GPU Topology =========="</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      nvidia-smi topo -m</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo ""</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo "========== Allocated GPUs =========="</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo "NVIDIA_VISIBLE_DEVICES: $NVIDIA_VISIBLE_DEVICES"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo ""</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo "========== GPU Details =========="</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      nvidia-smi --query-gpu=index,name,pci.bus_id,memory.total --format=csv</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo ""</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo "========== CPU Binding =========="</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      cat /proc/self/status | grep -E "Cpus_allowed_list|Mems_allowed_list"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      echo ""</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>      sleep 3600</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"16Gi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain">       </span><span class="token comment" style=color:#8292a2;font-style:italic># 请求2个GPU</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"16Gi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=故障排查>故障排查<a href=#故障排查 class=hash-link aria-label="Direct link to 故障排查" title="Direct link to 故障排查">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=topologyaffinityerror>TopologyAffinityError<a href=#topologyaffinityerror class=hash-link aria-label="Direct link to TopologyAffinityError" title="Direct link to TopologyAffinityError">​</a></h3>
<p>当<code>Pod</code>无法满足<code>Topology Manager</code>的策略要求时，会出现此错误：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ kubectl get pods</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">NAME                READY   STATUS                  RESTARTS   AGE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">numa-affinity-test  </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">/1     TopologyAffinityError   </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">          10s</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>排查步骤</strong>：</p>
<ol>
<li>检查节点可用资源是否满足<code>NUMA</code>对齐要求</li>
<li>降低策略严格程度（如从<code>single-numa-node</code>改为<code>restricted</code>）</li>
<li>减少<code>Pod</code>的资源请求</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=切换cpu-manager-policy>切换CPU Manager Policy<a href=#切换cpu-manager-policy class=hash-link aria-label="Direct link to 切换CPU Manager Policy" title="Direct link to 切换CPU Manager Policy">​</a></h3>
<p>切换策略需要清理状态文件：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 1. Drain节点（建议）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl drain </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">node-name</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"> --ignore-daemonsets --delete-emptydir-data</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 2. 停止kubelet</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">systemctl stop kubelet</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 3. 删除状态文件</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>rm</span><span class="token plain"> /var/lib/kubelet/cpu_manager_state</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>rm</span><span class="token plain"> /var/lib/kubelet/memory_manager_state</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 4. 修改kubelet配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>vim</span><span class="token plain"> /var/lib/kubelet/config.yaml</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 5. 启动kubelet</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">systemctl start kubelet</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 6. Uncordon节点</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl uncordon </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">node-name</span><span class="token operator" style=color:#66d9ef>></span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=查看kubelet日志>查看Kubelet日志<a href=#查看kubelet日志 class=hash-link aria-label="Direct link to 查看Kubelet日志" title="Direct link to 查看Kubelet日志">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">journalctl </span><span class="token parameter variable" style=color:#f8f8f2>-u</span><span class="token plain"> kubelet </span><span class="token parameter variable" style=color:#f8f8f2>-f</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-E</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cpu_manager|topology_manager|memory_manager"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=最佳实践>最佳实践<a href=#最佳实践 class=hash-link aria-label="Direct link to 最佳实践" title="Direct link to 最佳实践">​</a></h2>
<ol>
<li>
<p><strong>AI训练场景推荐配置</strong>：</p>
<ul>
<li><code>topologyManagerPolicy: restricted</code></li>
<li><code>topologyManagerScope: pod</code></li>
<li><code>cpuManagerPolicy: static</code></li>
</ul>
</li>
<li>
<p><strong>资源请求规范</strong>：</p>
<ul>
<li>确保<code>Pod</code>是<code>Guaranteed QoS（requests == limits）</code></li>
<li><code>CPU</code>请求使用整数值以获得独占<code>CPU</code></li>
</ul>
</li>
<li>
<p><strong>多GPU场景</strong>：</p>
<ul>
<li>使用<code>single-numa-node</code>策略确保多<code>GPU</code>在同一<code>NUMA</code>节点</li>
<li>或使用<code>prefer-closest-numa-nodes</code>选项减少跨<code>NUMA</code>延迟</li>
</ul>
</li>
<li>
<p><strong>性能监控</strong>：</p>
<ul>
<li>监控跨<code>NUMA</code>内存访问（通过<code>numastat</code>命令）</li>
<li>监控<code>CPU</code>上下文切换和缓存命中率</li>
</ul>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=参考资料>参考资料<a href=#参考资料 class=hash-link aria-label="Direct link to 参考资料" title="Direct link to 参考资料">​</a></h2>
<ul>
<li><a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/ target=_blank rel="noopener noreferrer">https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/</a></li>
<li><a href=https://kubernetes.io/docs/tasks/administer-cluster/memory-manager/#reserved-memory-flag target=_blank rel="noopener noreferrer">https://kubernetes.io/docs/tasks/administer-cluster/memory-manager/#reserved-memory-flag</a></li>
<li><a href=https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/ target=_blank rel="noopener noreferrer">Kubernetes CPU Management Policies</a></li>
<li><a href=https://kubernetes.io/docs/tasks/administer-cluster/topology-manager/ target=_blank rel="noopener noreferrer">Kubernetes Topology Manager</a></li>
<li><a href=https://kubernetes.io/docs/tasks/administer-cluster/memory-manager/ target=_blank rel="noopener noreferrer">Kubernetes Memory Manager</a></li>
<li><a href=https://github.com/NVIDIA/k8s-device-plugin target=_blank rel="noopener noreferrer">NVIDIA Device Plugin for Kubernetes</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/cloud-native/kubernetes-network-policy><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Kubernetes NetworkPolicy</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/cloud-native/argo-workflow><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Argo Workflow</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#背景与价值 class="table-of-contents__link toc-highlight">背景与价值</a><li><a href=#kubernetes-numa-亲和性关键组件 class="table-of-contents__link toc-highlight">Kubernetes NUMA 亲和性关键组件</a><ul><li><a href=#组件功能概述 class="table-of-contents__link toc-highlight">组件功能概述</a><li><a href=#工作流程 class="table-of-contents__link toc-highlight">工作流程</a></ul><li><a href=#关键组件配置详解 class="table-of-contents__link toc-highlight">关键组件配置详解</a><ul><li><a href=#cpu-manager class="table-of-contents__link toc-highlight">CPU Manager</a><li><a href=#topology-manager class="table-of-contents__link toc-highlight">Topology Manager</a><li><a href=#memory-manager class="table-of-contents__link toc-highlight">Memory Manager</a><li><a href=#device-manager class="table-of-contents__link toc-highlight">Device Manager</a></ul><li><a href=#关键组件配置更新 class="table-of-contents__link toc-highlight">关键组件配置更新</a><li><a href=#测试示例 class="table-of-contents__link toc-highlight">测试示例</a><ul><li><a href=#验证numa亲和性 class="table-of-contents__link toc-highlight">验证NUMA亲和性</a><li><a href=#多gpu-numa亲和性测试 class="table-of-contents__link toc-highlight">多GPU NUMA亲和性测试</a></ul><li><a href=#故障排查 class="table-of-contents__link toc-highlight">故障排查</a><ul><li><a href=#topologyaffinityerror class="table-of-contents__link toc-highlight">TopologyAffinityError</a><li><a href=#切换cpu-manager-policy class="table-of-contents__link toc-highlight">切换CPU Manager Policy</a><li><a href=#查看kubelet日志 class="table-of-contents__link toc-highlight">查看Kubelet日志</a></ul><li><a href=#最佳实践 class="table-of-contents__link toc-highlight">最佳实践</a><li><a href=#参考资料 class="table-of-contents__link toc-highlight">参考资料</a></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>