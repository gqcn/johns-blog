<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/云原生/Kubernetes/Kubelet驱逐Pod详细流程" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Kubelet驱逐Pod详细流程 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/cloud-native/kubernetes-kubelet-pod-eviction-process><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Kubelet驱逐Pod详细流程 | John's Blog"><meta data-rh=true name=description content=深入解析Kubernetes中kubelet的Pod驱逐机制，包括驱逐信号、阈值配置、QoS级别分类、驱逐优先级逻辑等。详细说明requests和limits配置对驱逐顺序的影响，以及内存、磁盘、PID等不同资源压力下的驱逐策略。结合源码分析驱逐流程的具体实现。><meta data-rh=true property=og:description content=深入解析Kubernetes中kubelet的Pod驱逐机制，包括驱逐信号、阈值配置、QoS级别分类、驱逐优先级逻辑等。详细说明requests和limits配置对驱逐顺序的影响，以及内存、磁盘、PID等不同资源压力下的驱逐策略。结合源码分析驱逐流程的具体实现。><meta data-rh=true name=keywords content=Kubelet,Pod驱逐,资源压力,内存压力,磁盘压力,QoS级别,Guaranteed,Burstable,BestEffort,驱逐信号,驱逐阈值,软驱逐,硬驱逐,节点资源管理,容器资源限制,requests,limits,优先级调度,资源回收,垃圾回收><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/cloud-native/kubernetes-kubelet-pod-eviction-process><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/kubernetes-kubelet-pod-eviction-process hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/cloud-native/kubernetes-kubelet-pod-eviction-process hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><link rel=stylesheet href=/assets/css/styles.208c11f9.css><script src=/assets/js/runtime~main.f163cf32.js defer></script><script src=/assets/js/main.b8f83bf3.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/ai>AI技术</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" sidebarid=mainSidebar href=/cloud-native>云原生</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/observability>可观测性</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/cloud-native>云原生</a><button aria-label="Collapse sidebar category '云原生'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/container>Container</a><button aria-label="Expand sidebar category 'Container'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/cloud-native/kubernetes>Kubernetes</a><button aria-label="Collapse sidebar category 'Kubernetes'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-common-commands>Kuberntes 常用命令</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-krew-plugins>Kuberntes krew常用插件</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-kustomize>Kubernetes kustomize</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-informer-client-go>Kubernetes Informer及client-go资料</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-aggregation-apiserver>Kubernetes Aggregation APIServer</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-crd-controller-operator>Kubernetes CRD, Controller, Operator</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-scheduler-framework>Kubernetes Scheduler Framework</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-network-policy>Kubernetes NetworkPolicy</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-common-issues>Kubernetes 常见问题</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-pod-stuck-issues>Pod stuck in ContainerCreating/Terminating</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-device-plugin>Kubernetes Device Plugin</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/cloud-native/kubernetes-kubelet-pod-eviction-process>Kubelet驱逐Pod详细流程</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-generate-bearer-token>Kubernetes生成Bearer Token方式</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/argo-workflow>Argo Workflow</a><button aria-label="Expand sidebar category 'Argo Workflow'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/cloud-native/volcano>Volcano</a><button aria-label="Expand sidebar category 'Volcano'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/helm>Helm常用指令</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/dragonfly>Dragonfly介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernetes-kind>使用Kubernetes Kind搭建本地测试集群</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/cloud-native/kubernettes-kind-mock-ai-test-cluster>使用Kubernetes Kind模拟AI算力测试集群</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native><span itemprop=name>云原生</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/cloud-native/kubernetes><span itemprop=name>Kubernetes</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Kubelet驱逐Pod详细流程</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=1-前言>1. 前言<a href=#1-前言 class=hash-link aria-label="Direct link to 1. 前言" title="Direct link to 1. 前言">​</a></h2>
<p><code>kubelet</code>监控集群节点的内存、磁盘空间和文件系统的<code>inode</code>等资源。 当这些资源中的一个或者多个达到特定的消耗水平，<code>kubelet</code>可以主动驱逐节点上一个或者多个<code>Pod</code>，以回收资源防止节点最终崩溃。</p>
<p><strong>需要注意的是</strong>：由<code>Kubelet</code>发起的驱逐并不会遵循<code>PodDisruptionBudget</code>和<code>terminationGracePeriodSeconds</code>的配置。对<code>K8S</code>来说，保证节点资源充足优先级更高，牺牲小部分<code>Pod</code>来保证剩余的大部分<code>Pod</code>。</p>
<p>另外<code>Kubelet</code>在真正驱逐<code>Pod</code>之前会执行一次垃圾回收，尝试回收节点资源，如果回收后资源充足了，就可以避免驱逐<code>Pod</code>。</p>
<p>在<code>kubelet</code>中实现<code>Pod</code>驱逐逻辑的具体源码位于：<a href=https://github.com/kubernetes/kubernetes/blob/4096c9209cbf20c51d184e83ab6ffa3853bd2ee6/pkg/kubelet/eviction/eviction_manager.go target=_blank rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/blob/4096c9209cbf20c51d184e83ab6ffa3853bd2ee6/pkg/kubelet/eviction/eviction_manager.go</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=2-驱逐信号和阈值什么时候会驱逐-pod>2. 驱逐信号和阈值：什么时候会驱逐 Pod?<a href=#2-驱逐信号和阈值什么时候会驱逐-pod class=hash-link aria-label="Direct link to 2. 驱逐信号和阈值：什么时候会驱逐 Pod?" title="Direct link to 2. 驱逐信号和阈值：什么时候会驱逐 Pod?">​</a></h2>
<p>首先，新的<code>Pod</code>调度不会引发驱逐动作，驱逐动作只会在节点资源紧张时才会发生，例如某些<code>Pod</code>的资源使用率（<code>CPU/Memory/Disk/PID</code>等）飙升（因为<code>Container limits</code>可以超过节点可分配资源总量），或者节点上其他进程引发的节点资源压力。</p>
<p><code>kubelet</code>使用各种参数来做出驱逐决定，具体包含以下<code>3</code>个部分：</p>
<ul>
<li>1）驱逐信号</li>
<li>2）驱逐条件</li>
<li>3）监控间隔</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=21-驱逐信号与节点condition>2.1 驱逐信号与节点condition<a href=#21-驱逐信号与节点condition class=hash-link aria-label="Direct link to 2.1 驱逐信号与节点condition" title="Direct link to 2.1 驱逐信号与节点condition">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=211-驱逐信号>2.1.1 驱逐信号<a href=#211-驱逐信号 class=hash-link aria-label="Direct link to 2.1.1 驱逐信号" title="Direct link to 2.1.1 驱逐信号">​</a></h4>
<p><strong><code>Kubelet</code>使用驱逐信号来代表特定资源在特定时间点的状态</strong>，根据不同资源，<code>Kubelet</code> 中定义了<code>5</code>种驱逐信号。</p>
<blockquote>
<p>驱逐信号这个词感觉有点迷，实际看下来就是检测了这几种资源的余量用于判断是否需要驱逐<code>Pod</code></p>
</blockquote>
<p>在<code>Linux</code>系统中，<code>5</code>种信号分别为：</p>
<table><thead><tr><th>驱逐信号<th>描述<tbody><tr><td><code>memory.available</code><td><code>memory.available := node.status.capacity[memory] - node.stats.memory.workingSet</code><tr><td><code>nodefs.available</code><td><code>nodefs.available := node.stats.fs.available</code><tr><td><code>nodefs.inodesFree</code><td><code>nodefs.inodesFree := node.stats.fs.inodesFree</code><tr><td><code>imagefs.available</code><td><code>imagefs.available := node.stats.runtime.imagefs.available</code><tr><td><code>imagefs.inodesFree</code><td><code>imagefs.inodesFree := node.stats.runtime.imagefs.inodesFree</code><tr><td><code>pid.available</code><td><code>pid.available := node.stats.rlimit.maxpid - node.stats.rlimit.curproc</code></table>
<p>可以看到，主要是对 <code>内存</code>、<code>磁盘</code>、<code>PID</code> 这三种类型资源进行检测。其中磁盘资源又分为两类：</p>
<ol>
<li><code>nodefs</code>：节点的主要文件系统，用于本地磁盘卷、不受内存支持的<code>emptyDir</code>卷、日志存储等。 例如，<code>nodefs</code> 包含 <code>/var/lib/kubelet/</code>。</li>
<li><code>imagefs</code>：可选文件系统，供容器运行时存储容器镜像和容器可写层。</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=212-节点condition与污点>2.1.2 节点condition与污点<a href=#212-节点condition与污点 class=hash-link aria-label="Direct link to 2.1.2 节点condition与污点" title="Direct link to 2.1.2 节点condition与污点">​</a></h4>
<p>除了用驱逐信号来判断是否需要驱逐<code>Pod</code>之外，<code>Kubelet</code> 还会把驱逐信号反应为节点的状态。</p>
<blockquote>
<p>即：更新到<code>node</code>对象的<code>status.condition</code>字段里</p>
</blockquote>
<p>对应关系如下：</p>
<table><thead><tr><th>Node Condition<th>Eviction Signal<th>Description<tbody><tr><td><code>MemoryPressure</code><td><code>memory.available</code><td>节点可用内存余量满足驱逐阈值<tr><td><code>DiskPressure</code><td><code>nodefs.available, nodefs.inodesFree, imagefs.available, or imagefs.inodesFree</code><td>节点主文件系统或者镜像文件系统剩余磁盘空间或者<code>inodes</code>数量满足驱逐阈值<tr><td><code>PIDPressure</code><td><code>pid.available</code><td>节点上可用进程标识符(<code>processes identifiers</code>) 低于驱逐阈值</table>
<p>总的来说就是节点上对应资源不足时<code>kubelet</code>就会被节点打上对应的标记。</p>
<p>同时 <code>control plane(具体为 node controller)</code> 会自动把节点上相关<code>condition</code>转换为<code>taint</code>标记，具体见：<a href=https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/#taint-nodes-by-condition target=_blank rel="noopener noreferrer">#taint-nodes-by-condition</a>，这样可以避免把<code>Pod</code>调度到本来就资源不足的<code>Pod</code>上。</p>
<blockquote>
<p>如果不给资源不足的节点打上标记，可能发生<code>Pod</code>刚调度过去就被驱逐的情况。</p>
</blockquote>
<p><strong>整体运作流程</strong>：</p>
<ul>
<li>1）首先<code>Kubelet</code>检测到节点上剩余磁盘空间不足，更新<code>Node Condition</code>增加 <code>DiskPressure</code> 状态</li>
<li>2）然后<code>node controller</code>自动将<code>Condition</code>转换为<code>污点</code> <code>node.kubernetes.io/disk-pressure</code></li>
<li>3）最后<code>Pod</code>调度的时候，由于没有添加对应的容忍，因此会优先调度到其他节点，或者最终调度失败</li>
</ul>
<p>有时候节点状态处于阈值附近上下波动，导致软驱逐条件也在<code>true</code>和<code>false</code>之间反复切换，为了过滤掉这种误差，<code>kubelet</code> 提供了 <code>eviction-pressure-transition-period</code> 参数来限制，节点状态转换前必须要等待对应的时间，默认为<code>5m</code>。</p>
<blockquote>
<p>一般这种检测状态的为了提升稳定性，都会给一个静默期，比如<code>K8S</code>中的<code>HPA</code>扩缩容也会设置静默期，防止频繁触发扩缩容动作。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=22-驱逐阈值判断条件>2.2 驱逐阈值：判断条件<a href=#22-驱逐阈值判断条件 class=hash-link aria-label="Direct link to 2.2 驱逐阈值：判断条件" title="Direct link to 2.2 驱逐阈值：判断条件">​</a></h3>
<p>拿到资源当前状态之后，就可以根据阈值判断是否需要触发驱逐动作了。</p>
<p><code>Kubelet</code>使用<code>[eviction-signal][operator][quantity]</code>格式定义驱逐条件，其中：</p>
<ul>
<li><code>eviction-signal</code> 是要使用的驱逐信号<!-- -->
<ul>
<li>比如剩余内存 <code>memory.available</code></li>
</ul>
</li>
<li><code>operator</code> 是你想要的关系运算符<!-- -->
<ul>
<li>比如 <code>&lt;</code>（小于）。</li>
</ul>
</li>
<li><code>quantity</code> 是驱逐条件数量，例如 <code>1Gi</code>。<!-- -->
<ul>
<li><code>quantity</code> 的值必须与<code>Kubernetes</code>使用的数量表示相匹配。</li>
<li>你可以使用文字值或百分比（<code>%</code>）。</li>
</ul>
</li>
</ul>
<p>例如，如果一个节点的总内存为<code>10GiB</code>并且你希望在可用内存低于<code>1GiB</code>时触发驱逐， 则可以将驱逐条件定义为 <code>memory.available &lt; 10%</code> 或 <code>memory.available &lt; 1G</code>。</p>
<p>根据紧急程度驱逐条件又分为<strong>软驱逐 <code>eviction-soft</code></strong> 和 <strong>硬驱逐 <code>eviction-hard</code></strong>：</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=221-软驱逐-eviction-soft>2.2.1 软驱逐 eviction-soft<a href=#221-软驱逐-eviction-soft class=hash-link aria-label="Direct link to 2.2.1 软驱逐 eviction-soft" title="Direct link to 2.2.1 软驱逐 eviction-soft">​</a></h4>
<p>一般驱逐条件比较保守，此时还可以等待<code>Pod</code>优雅终止，需要配置以下参数</p>
<ul>
<li><code>eviction-soft</code>：软驱逐条件，例如 <code>memory.available&lt;1.5Gi</code></li>
<li><code>eviction-soft-grace-period</code>：软驱逐宽限期，需要保持驱逐条件这么久之后才开始驱逐<code>Pod</code>（必须指定，否则<code>kubelet</code>启动时会直接报错）</li>
<li><code>eviction-max-pod-grace-period</code>：软驱逐最大<code>Pod</code>宽限期，驱逐<code>Pod</code>的时候给<code>Pod</code>优雅终止的时间</li>
</ul>
<p>在 <a href=https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination target=_blank rel="noopener noreferrer">Pod 生命周期部分</a> 我们可以配置 <code>spec.terminationGracePeriodSeconds</code>来控制<code>Pod</code>优雅终止时间，就像这样：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Pod</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> example</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> my</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">container    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> my</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">image  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>60</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 设置终止期限为 60 秒</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>然后驱逐这里又配置了一个 <code>eviction-max-pod-grace-period</code>,实际驱逐发生时，<strong><code>Kubelet</code>会取二者中的较小值来作为最终优雅终止宽限期</strong>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=222-硬驱逐-eviction-hard>2.2.2 硬驱逐 eviction-hard<a href=#222-硬驱逐-eviction-hard class=hash-link aria-label="Direct link to 2.2.2 硬驱逐 eviction-hard" title="Direct link to 2.2.2 硬驱逐 eviction-hard">​</a></h4>
<p>相比之下则是比较紧急，配置条件都很极限，在往上节点可能会崩溃的那种。</p>
<p>比如 内存小于<code>100Mi</code>这种，因此硬驱逐没有容忍时间，需要配置硬驱逐条件 <code>eviction-hard</code>。</p>
<p>只要满足驱逐条件 <code>kubelet</code> 就会立马将 <code>pod kill</code> 掉，而不是发送 <code>SIGTERM</code> 信号。</p>
<p><code>Kubelet</code>提供了以下的默认硬驱逐条件：</p>
<ul>
<li><code>memory.available &lt; 100Mi</code></li>
<li><code>nodefs.available &lt; 10%</code></li>
<li><code>imagefs.available &lt; 15%</code></li>
<li><code>nodefs.inodesFree &lt; 5%</code></li>
</ul>
<p>例如下面这个配置：</p>
<ul>
<li><code>eviction-soft: memory.available &lt; 1 Gi</code></li>
<li><code>eviction-soft-grace-period: 60s</code></li>
<li><code>eviction-max-pod-grace-period: 30s</code></li>
<li><code>eviction-hard: memory.available &lt; 100 Mi</code></li>
</ul>
<p>当节点可用内存余量低于<code>1Gi</code>连续持续<code>60s</code>之后，<code>kubelet</code>就会开始软驱逐，给被选择的<code>Pod</code>发送<code>SIGTERM</code>，使其优化终止，如果终止时间超过<code>30s</code>则强制<code>kill</code>。</p>
<p>如果节点内存可用余量低于<code>100Mi</code>，则<code>kubelet</code>进入硬驱逐，立马<code>kill</code>掉被选中的<code>Pod</code>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=23-状态检测--驱逐频率>2.3 状态检测 & 驱逐频率<a href=#23-状态检测--驱逐频率 class=hash-link aria-label="Direct link to 2.3 状态检测 & 驱逐频率" title="Direct link to 2.3 状态检测 & 驱逐频率">​</a></h3>
<p><code>Kubelet</code>默认每<code>10s</code>会检测一次节点状态，即驱逐判断条件为<code>10s</code>一次，当然也可以通过<code>housekeeping-interval</code>参数进行配置。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=3-回收节点级资源>3. 回收节点级资源<a href=#3-回收节点级资源 class=hash-link aria-label="Direct link to 3. 回收节点级资源" title="Direct link to 3. 回收节点级资源">​</a></h2>
<p>为了提升稳定性，减少<code>Pod</code>驱逐次数，<code>Kubelet</code>在执行驱逐前会进行一次垃圾回收。如果本地垃圾回收后资源充足了就不再驱逐。</p>
<p>对于磁盘资源可以通过驱逐<code>Pod</code>以外的方式进行回收：</p>
<p>如果节点有一个专用的 <code>imagefs</code>文件系统供容器运行时使用，<code>Kubelet</code>会执行以下操作：</p>
<ul>
<li>如果 <code>nodefs</code>文件系统满足驱逐条件，<code>Kubelet</code>垃圾收集死亡<code>Pod</code>和容器。</li>
<li>如果 <code>imagefs</code>文件系统满足驱逐条件，<code>Kubelet</code>将删除所有未使用的镜像。</li>
</ul>
<p>如果节点只有一个满足驱逐条件的<code>nodefs</code>文件系统，<code>kubelet</code>按以下顺序释放磁盘空间：</p>
<ol>
<li>对死亡的<code>Pod</code>和容器进行垃圾收集</li>
<li>删除未使用的镜像</li>
</ol>
<p>对于CPU、内存资源则是只能驱逐<code>Pod</code>方式进行回收。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=4-驱逐对象哪些-pod-会被驱逐>4. 驱逐对象：哪些 Pod 会被驱逐<a href=#4-驱逐对象哪些-pod-会被驱逐 class=hash-link aria-label="Direct link to 4. 驱逐对象：哪些 Pod 会被驱逐" title="Direct link to 4. 驱逐对象：哪些 Pod 会被驱逐">​</a></h2>
<p>如果进行垃圾回收后，节点资源也满足驱逐条件，那么为了保证当前节点不被压垮，<code>kubelet</code>只能驱逐<code>Pod</code>了。</p>
<p>根据触发驱逐的资源不同，驱逐目标筛选逻辑也有不同。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=41-内存资源导致的驱逐>4.1 内存资源导致的驱逐<a href=#41-内存资源导致的驱逐 class=hash-link aria-label="Direct link to 4.1 内存资源导致的驱逐" title="Direct link to 4.1 内存资源导致的驱逐">​</a></h3>
<p>对于内存资源<code>kubelet</code>使用以下参数来确定<code>Pod</code>驱逐顺序：<a href=https://github.com/kubernetes/kubernetes/blob/4096c9209cbf20c51d184e83ab6ffa3853bd2ee6/pkg/kubelet/eviction/eviction_manager.go#L254 target=_blank rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/blob/4096c9209cbf20c51d184e83ab6ffa3853bd2ee6/pkg/kubelet/eviction/eviction_manager.go#L254</a></p>
<ul>
<li>1）<strong><code>Pod</code></strong> <strong>使用的资源是否超过请求值</strong>：即当前占用资源是否高于<code>yaml</code>中指定的<code>requests</code>值</li>
<li>2）<strong><code>Pod</code></strong> <strong>的优先级</strong>：这里不是<code>QoS</code>优先级，而是 <a href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/pod-priority-preemption/ target=_blank rel="noopener noreferrer">priority-class</a> 这个优先级</li>
<li>3）<strong><code>Pod</code></strong> <strong>使用资源相对于请求资源的百分比</strong>：百分比越高则越容易别驱逐，比如请求<code>100Mi</code>，使用了<code>60Mi</code>则占用了<code>60%</code>，如果没有<code>limits</code>导致<code>Pod</code>使用了<code>200Mi</code>，那就是<code>200%</code></li>
</ul>
<p>因此，虽然没有严格按照<code>QoS</code>来排序，但是整个驱逐顺序和<code>Pod</code>的<code>QoS</code>是有很大关系的：</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=411-qos-级别介绍>4.1.1 QoS 级别介绍<a href=#411-qos-级别介绍 class=hash-link aria-label="Direct link to 4.1.1 QoS 级别介绍" title="Direct link to 4.1.1 QoS 级别介绍">​</a></h4>
<p>在<code>Kubernetes</code>中，<code>Pod</code>根据其资源配置被分为三个<code>QoS</code>（<code>Quality of Service</code>）级别：</p>
<p><strong>1. Guaranteed（保证级别）</strong></p>
<ul>
<li>所有容器都必须设置CPU和内存的<code>requests</code>和<code>limits</code></li>
<li>每个容器的<code>requests</code>必须等于<code>limits</code></li>
<li>这类<code>Pod</code>拥有最高的服务质量保证，在资源紧张时最不容易被驱逐</li>
</ul>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Pod</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> app</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1Gi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"500m"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1Gi"</span><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 必须等于requests</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"500m"</span><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 必须等于requests</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>2. Burstable（突发级别）</strong></p>
<ul>
<li>至少有一个容器设置了CPU或内存的<code>requests</code></li>
<li>不满足<code>Guaranteed</code>级别的条件（即<code>requests</code>不等于<code>limits</code>，或者部分容器未设置<code>limits</code>）</li>
<li>这类<code>Pod</code>可以在资源充足时使用超过<code>requests</code>的资源</li>
</ul>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Pod</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> app</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"512Mi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"250m"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1Gi"</span><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 大于requests，允许突发使用</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1000m"</span><span class="token plain">     </span><span class="token comment" style=color:#8292a2;font-style:italic># 大于requests，允许突发使用</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>3. BestEffort（尽力而为级别）</strong></p>
<ul>
<li>所有容器都没有设置CPU和内存的<code>requests</code>和<code>limits</code></li>
<li>这类<code>Pod</code>在资源紧张时最容易被驱逐</li>
</ul>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Pod</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> app</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 没有设置任何资源限制</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=412-驱逐优先级关系>4.1.2 驱逐优先级关系<a href=#412-驱逐优先级关系 class=hash-link aria-label="Direct link to 4.1.2 驱逐优先级关系" title="Direct link to 4.1.2 驱逐优先级关系">​</a></h4>
<ul>
<li>首先考虑资源使用量超过其请求的<code>QoS</code>级别为<code>BestEffort</code>或<code>Burstable</code>的<code>Pod</code>。 这些<code>Pod</code>会根据它们的优先级以及它们的资源使用级别超过其请求的程度被驱逐。</li>
<li>资源使用量少于请求量的<code>Guaranteed</code>级别的<code>Pod</code>和<code>Burstable Pod</code>根据其优先级被最后驱逐。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=42-inode--pid-导致的驱逐>4.2 inode & pid 导致的驱逐<a href=#42-inode--pid-导致的驱逐 class=hash-link aria-label="Direct link to 4.2 inode & pid 导致的驱逐" title="Direct link to 4.2 inode & pid 导致的驱逐">​</a></h3>
<p>当<code>kubelet</code>因 <strong>inode</strong> 或 <strong>进程标识符(pid)</strong> 不足而驱逐<code>Pod</code>时， 它使用<code>Pod</code>的相对优先级来确定驱逐顺序，因为<code>inode</code>和<code>PID</code>没有对应的请求字段。</p>
<p>相对优先级排序方式如下：</p>
<ol>
<li>节点有 <code>imagefs</code>：</li>
</ol>
<ul>
<li>如果 <code>nodefs</code> 触发驱逐，<code>kubelet</code>会根据 <code>nodefs</code> 使用情况（<code>本地卷 + 所有容器的日志</code>）对<code>Pod</code>进行排序。</li>
<li>如果 <code>imagefs</code> 触发驱逐，<code>kubelet</code>会根据所有容器的可写层使用情况对<code>Pod</code>进行排序。</li>
</ul>
<ol start=2>
<li>节点没有 <code>imagefs</code>：</li>
</ol>
<ul>
<li>如果 <code>nodefs</code> 触发驱逐，<code>kubelet</code>会根据磁盘总用量（<code>本地卷 + 日志和所有容器的可写层</code>）对<code>Pod</code>进行排序。</li>
</ul>
<ol start=3>
<li>即：<code>inode、pid</code>导致的驱逐，<code>Kubelet</code>会优先驱逐磁盘消耗大的<code>Pod</code>，而不是根据<code>Pod QoS</code>来。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=43-小结>4.3 小结<a href=#43-小结 class=hash-link aria-label="Direct link to 4.3 小结" title="Direct link to 4.3 小结">​</a></h3>
<p><code>Kubelet</code>并没有使用<code>QoS</code>来作为驱逐顺序，但是对于<strong>内存资源回收</strong>的场景，驱逐顺序和<code>QoS</code>是相差不大的。不过对于 <strong>磁盘和 PID</strong> 资源的回收则完全不一样的，会优先考虑驱逐磁盘占用多的<code>Pod</code>，即使<code>Pod QoS</code>等级为 <code>Guaranteed</code>。</p>
<blockquote>
<p>毕竟不是所有资源都有<code>requests</code>和<code>limits</code>，只能先驱逐占用量大的。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=44-最少资源回收量>4.4 最少资源回收量<a href=#44-最少资源回收量 class=hash-link aria-label="Direct link to 4.4 最少资源回收量" title="Direct link to 4.4 最少资源回收量">​</a></h3>
<p>为了保证尽量少的<code>Pod</code>，<code>kubelet</code>每次只会驱逐一个<code>Pod</code>，驱逐后就会判断一次资源是否充足。</p>
<p>这样可能导致该节点资源一直处于驱逐阈值，反复达到驱逐条件从而触发多次驱逐，<code>kubelet</code>也提供了参数 <code>--eviction-minimum-reclaim</code> 来指定每次驱逐最低回收资源，达到该值后才停止驱逐。从而减少触发驱逐的次数。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=5-参考资料>5. 参考资料<a href=#5-参考资料 class=hash-link aria-label="Direct link to 5. 参考资料" title="Direct link to 5. ��参考资料">​</a></h2>
<ul>
<li><a href=https://www.lixueduan.com/posts/kubernetes/20-pod-eviction target=_blank rel="noopener noreferrer">https://www.lixueduan.com/posts/kubernetes/20-pod-eviction</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/cloud-native/kubernetes-device-plugin><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Kubernetes Device Plugin</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/cloud-native/kubernetes-generate-bearer-token><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Kubernetes生成Bearer Token方式</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#1-前言 class="table-of-contents__link toc-highlight">1. 前言</a><li><a href=#2-驱逐信号和阈值什么时候会驱逐-pod class="table-of-contents__link toc-highlight">2. 驱逐信号和阈值：什么时候会驱逐 Pod?</a><ul><li><a href=#21-驱逐信号与节点condition class="table-of-contents__link toc-highlight">2.1 驱逐信号与节点condition</a><li><a href=#22-驱逐阈值判断条件 class="table-of-contents__link toc-highlight">2.2 驱逐阈值：判断条件</a><li><a href=#23-状态检测--驱逐频率 class="table-of-contents__link toc-highlight">2.3 状态检测 & 驱逐频率</a></ul><li><a href=#3-回收节点级资源 class="table-of-contents__link toc-highlight">3. 回收节点级资源</a><li><a href=#4-驱逐对象哪些-pod-会被驱逐 class="table-of-contents__link toc-highlight">4. 驱逐对象：哪些 Pod 会被驱逐</a><ul><li><a href=#41-内存资源导致的驱逐 class="table-of-contents__link toc-highlight">4.1 内存资源导致的驱逐</a><li><a href=#42-inode--pid-导致的驱逐 class="table-of-contents__link toc-highlight">4.2 inode & pid 导致的驱逐</a><li><a href=#43-小结 class="table-of-contents__link toc-highlight">4.3 小结</a><li><a href=#44-最少资源回收量 class="table-of-contents__link toc-highlight">4.4 最少资源回收量</a></ul><li><a href=#5-参考资料 class="table-of-contents__link toc-highlight">5. 参考资料</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>