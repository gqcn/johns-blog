<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/数据库与中间件/Etcd/etcd读请求执行流程分析" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>etcd读请求执行流程分析 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/database-and-middleware/etcd-read-request-flow><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="etcd读请求执行流程分析 | John's Blog"><meta data-rh=true name=description content=深入分析etcd读请求的执行流程，包括请求处理、数据读取和响应过程的详细解析><meta data-rh=true property=og:description content=深入分析etcd读请求的执行流程，包括请求处理、数据读取和响应过程的详细解析><meta data-rh=true name=keywords content=etcd,读请求,执行流程,源码分析,性能优化,分布式存储,系统架构><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/database-and-middleware/etcd-read-request-flow><link data-rh=true rel=alternate href=https://johng.cn/database-and-middleware/etcd-read-request-flow hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/database-and-middleware/etcd-read-request-flow hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><script src=https://cdn.wwads.cn/js/makemoney.js async></script><link rel=stylesheet href=/assets/css/styles.208c11f9.css><script src=/assets/js/runtime~main.f9b77b7f.js defer></script><script src=/assets/js/main.5f7373b1.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/ai>AI技术</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/cloud-native>云原生</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/observability>可观测性</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/cloud-native>云原生</a><button aria-label="Expand sidebar category '云原生'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/database-and-middleware>数据库与中间件</a><button aria-label="Collapse sidebar category '数据库与中间件'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/database-and-middleware/mysql>MySQL</a><button aria-label="Expand sidebar category 'MySQL'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/database-and-middleware/redis>Redis</a><button aria-label="Expand sidebar category 'Redis'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/database-and-middleware/etcd>Etcd</a><button aria-label="Collapse sidebar category 'Etcd'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/database-and-middleware/etcd-split-brain-handling>etcd脑裂处理办法</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/database-and-middleware/etcd-read-request-flow>etcd读请求执行流程分析</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/database-and-middleware/distributed-system-raft>分布式系统的Raft算法</a></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/database-and-middleware/database-normalization>数据库三大范式与反三范式</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/database-and-middleware><span itemprop=name>数据库与中间件</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/database-and-middleware/etcd><span itemprop=name>Etcd</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>etcd读请求执行流程分析</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><p>本文主要分析了 etcd 中一个读请求的具体执行流程。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=1-概述>1. 概述<a href=#1-概述 class=hash-link aria-label="Direct link to 1. 概述" title="Direct link to 1. 概述">​</a></h2>
<p>下面是一张 etcd 的简要基础架构图：</p>
<p><img decoding=async loading=lazy src=/assets/images/etcd-simple-arch-1c7142cdcff3edea157a9828f5a5691f.png width=1920 height=1240 class=img_ev3q></p>
<p>按照分层模型，etcd 可分为 Client 层、API 网络层、Raft 算法层、逻辑层和存储层。这些层的功能如下：</p>
<ul>
<li><strong>Client 层</strong>：Client 层包括 client v2 和 v3 两个大版本 API 客户端库，提供了简洁易用的 API，同时支持负载均衡、节点间故障自动转移，可极大降低业务使用 etcd 复杂度，提升开发效率、服务可用性。</li>
<li><strong>API 网络层</strong>：API 网络层主要包括 client 访问 server 和 server 节点之间的通信协议。一方面，client 访问 etcd server 的 API 分为 v2 和 v3 两个大版本。v2 API 使用 HTTP/1.x 协议，v3 API 使用 gRPC 协议。同时 v3 通过 etcd grpc-gateway 组件也支持 HTTP/1.x 协议，便于各种语言的服务调用。另一方面，server 之间通信协议，是指节点间通过 Raft 算法实现数据复制和 Leader 选举等功能时使用的 HTTP 协议。</li>
<li><strong>Raft 算法层</strong>：Raft 算法层实现了 Leader 选举、日志复制、ReadIndex 等核心算法特性，用于保障 etcd 多个节点间的数据一致性、提升服务可用性等，是 etcd 的基石和亮点。</li>
<li><strong>功能逻辑层</strong>：etcd 核心特性实现层，如典型的 KVServer 模块、MVCC 模块、Auth 鉴权模块、Lease 租约模块、Compactor 压缩模块等，其中 MVCC 模块主要由 treeIndex 模块和 boltdb 模块组成。</li>
<li><strong>存储层</strong>：存储层包含预写日志 (WAL) 模块、快照 (Snapshot) 模块、boltdb 模块。其中 WAL 可保障 etcd crash 后数据不丢失，boltdb 则保存了集群元数据和用户写入的数据。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=2-读请求流程>2. 读请求流程<a href=#2-读请求流程 class=hash-link aria-label="Direct link to 2. 读请求流程" title="Direct link to 2. 读请求流程">​</a></h2>
<p>具体流程如下图所示：</p>
<p><img decoding=async loading=lazy src=/assets/images/etcd-read-process-57fc5383fef1e1d86a964807e0d86270.png width=1920 height=1229 class=img_ev3q></p>
<p>以下面的命令进行分析：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># --endpoint=http://127.0.0.1:2379 用于指定后端的 etcd 地址</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">/usr/local/bin </span><span class="token comment" style=color:#8292a2;font-style:italic># etcdctl --endpoint=http://127.0.0.1:2379 put hello world</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">ok</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">/usr/local/bin </span><span class="token comment" style=color:#8292a2;font-style:italic># etcdctl --endpoint=http://127.0.0.1:2379 get hello</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">world</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=21-client>2.1 Client<a href=#21-client class=hash-link aria-label="Direct link to 2.1 Client" title="Direct link to 2.1 Client">​</a></h4>
<p><strong>1）首先，etcdctl 会对命令中的参数进行解析。</strong></p>
<ul>
<li>get" 是请求的方法，它是 KVServer 模块的 API。</li>
<li>"hello" 是我们查询的 key 名。</li>
<li>"endpoints" 是我们后端的 etcd 地址。</li>
</ul>
<blockquote>
<p>通常，生产环境下中需要配置多个 endpoints，这样在 etcd 节点出现故障后，client 就可以自动重连到其它正常的节点，从而保证请求的正常执行。</p>
</blockquote>
<p><strong>2）在解析完请求中的参数后，etcdctl 会创建一个 clientv3 库对象，使用 KVServer 模块的 API 来访问 etcd server。</strong></p>
<p>etcd clientv3 库采用的负载均衡算法为 <strong>Round-robin</strong>。针对每一个请求，Round-robin 算法通过轮询的方式依次从 endpoint 列表中选择一个 endpoint 访问 (长连接)，使 etcd server 负载尽量均衡。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=22-kvserver-与-拦截器>2.2 KVServer 与 拦截器<a href=#22-kvserver-与-拦截器 class=hash-link aria-label="Direct link to 2.2 KVServer 与 拦截器" title="Direct link to 2.2 KVServer 与 拦截器">​</a></h4>
<p>client 发送 Range RPC 请求到了 server 后就进入了 KVServer 模块。</p>
<p>etcd 通过<strong>拦截器</strong>以非侵入式的方式实现了许多特性，例如：丰富的 metrics、日志、请求行为检查、所有请求的执行耗时及错误码、来源 IP 等。</p>
<p>拦截器提供了在执行一个请求前后的 hook 能力，除了 debug 日志、metrics 统计、对 etcd Learner 节点请求接口和参数限制等能力，etcd 还基于它实现了以下特性:</p>
<ul>
<li>1）要求执行一个操作前集群必须有 Leader；</li>
<li>2）请求延时超过指定阈值的，打印包含来源 IP 的慢查询日志 (3.5 版本)。</li>
</ul>
<p>server 收到 client 的 Range RPC 请求后，根据 ServiceName 和 RPC Method 将请求转发到对应的 handler 实现，handler 首先会将上面描述的一系列拦截器串联成一个拦截器再执行（具体实现见<a href=https://github.com/grpc/grpc-go/blob/master/server.go##L1093 target=_blank rel="noopener noreferrer">这里</a>），在拦截器逻辑中，通过调用 KVServer 模块的 Range 接口获取数据。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=23-串行读与线性读>2.3 串行读与线性读<a href=#23-串行读与线性读 class=hash-link aria-label="Direct link to 2.3 串行读与线性读" title="Direct link to 2.3 串行读与线性读">​</a></h4>
<p>etcd 为了保证服务高可用，生产环境一般部署多个节点，多节点之间的数据由于延迟等关系可能会存在不一致的情况。</p>
<blockquote>
<p>所有的写操作，都要经过leader节点，一旦leader被选举成功，就可以对客户端提供服务了。客户端提交每一条命令都会被按顺序记录到leader的日志中，每一条命令都包含term编号和顺序索引，然后向其他节点并行发送AppendEntries RPC用以复制命令(如果命令丢失会不断重发)，当复制成功也就是大多数节点（n/2 + 1）成功复制后，leader就会提交命令，即执行该命令并且将执行结果返回客户端，raft保证已经提交的命令最终也会被其他节点成功执行。</p>
<p>因为日志是顺序记录的，并且有严格的确认机制，所以可以认为写是满足线性一致性的。</p>
<p>由于在Raft算法中，写操作成功仅仅意味着日志达成了一致（已经落盘），而并不能确保当前状态机也已经apply了日志。状态机apply日志的行为在大多数Raft算法的实现中都是异步的，所以此时读取状态机并不能准确反应数据的状态，很可能会读到过期数据。</p>
</blockquote>
<p>当 client 发起一个写请求后具体步骤如下：</p>
<ul>
<li>1）Leader 收到写请求，它会将此请求持久化到 WAL 日志，并广播给各个节点；只有 Leader 节点能处理写请求。</li>
<li>2）若一半以上节点（n/2 + 1）持久化成功，则该请求对应的日志条目被标识为已提交。</li>
<li>3）etcdserver 模块异步从 Raft 模块获取已提交的日志条目，应用到状态机 (boltdb 等)。</li>
</ul>
<p>根据业务场景对数据一致性差异的接受程度，etcd 中有两种读模式。</p>
<ul>
<li>1）<strong>串行 (Serializable) 读</strong>：直接读状态机数据返回、无需通过 Raft 协议与集群进行交互，它具有低延时、高吞吐量的特点，适合对数据一致性要求不高的场景。</li>
<li>2）<strong>线性读</strong>：需要经过 Raft 协议模块，反应的是集群共识，因此在延时和吞吐量上相比串行读略差一点，适用于对数据一致性要求高的场景。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=24-readindex>2.4 ReadIndex<a href=#24-readindex class=hash-link aria-label="Direct link to 2.4 ReadIndex" title="Direct link to 2.4 ReadIndex">​</a></h4>
<p>在 etcd 3.1 时引入了 ReadIndex 机制，保证在串行读的时候，也能读到最新的数据。</p>
<p>具体流程如下：</p>
<ul>
<li>1）当 Follower 节点 收到一个线性读请求时，它首先会从 Leader 获取集群最新的已提交的日志索引 (committed index)。Leader 收到 ReadIndex 请求时，为防止脑裂等异常场景，会向 Follower 节点发送心跳确认，一半以上节点确认 Leader 身份后才能将已提交的索引 (committed index) 返回给请求节点。</li>
<li>2）Follower 节点拿到 read index 后会和状态机的 applied index进行比较，如果 read index 大于 applied index 则会等待，直到状态机已应用索引 (applied index) 大于等于 Leader 的已提交索引时 (committed Index)才会去通知读请求，数据已赶上 Leader，你可以去状态机中访问数据了。</li>
</ul>
<blockquote>
<p>所以根据ReadIndex的特性，如果出现网络分区，少数派所在的部分读写都将会失败。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=25-mvcc>2.5 MVCC<a href=#25-mvcc class=hash-link aria-label="Direct link to 2.5 MVCC" title="Direct link to 2.5 MVCC">​</a></h4>
<p>MVCC 即多版本并发控制 (Multiversion concurrency control) ，<strong>MVCC模块是为了解决 etcd v2 不支持保存 key 的历史版本、不支持多 key 事务等问题而产生的</strong>。</p>
<p>它核心由<strong>内存树形索引模块 treeIndex</strong> 和<strong>嵌入式的</strong> <strong>KV 持久化存储库 boltdb</strong> 组成。</p>
<p>etcd MVCC 具体方案如下：</p>
<p><strong>每次修改操作，生成一个新的版本号 (revision)，以版本号为 key， value 为用户 key-value 等信息组成的结构体存储到 blotdb</strong>。</p>
<p>读取时先从 treeIndex 中获取 key 的版本号，再以版本号作为 boltdb 的 key，从 boltdb 中获取其 value 信息。</p>
<p><strong>treeIndex</strong></p>
<p>treeIndex 模块是基于 Google 开源的内存版 btree 库实现的，treeIndex 模块只会保存用户的 key 和相关版本号信息，用户 key 的 value 数据存储在 boltdb 里面，所以对内存要求相对较低。</p>
<p><strong>buffer</strong></p>
<p>在获取到版本号信息后，就可从 boltdb 模块中获取用户的 key-value 数据了。</p>
<p>etcd 出于数据一致性、性能等考虑，在访问 boltdb 前，首先会从一个内存读事务 buffer 中，二分查找你要访问 key 是否在 buffer 里面，若命中则直接返回。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=26-boltdb>2.6 boltdb<a href=#26-boltdb class=hash-link aria-label="Direct link to 2.6 boltdb" title="Direct link to 2.6 boltdb">​</a></h4>
<p>若 buffer 未命中，此时就真正需要向 boltdb 模块查询数据了。</p>
<blockquote>
<p>boltdb 通过 bucket 隔离集群元数据与用户数据。</p>
</blockquote>
<p>boltdb 使用 B+ tree 来组织用户的 key-value 数据，获取 bucket key 对象后，通过 boltdb 的游标 Cursor 可快速在 B+ tree 找到 key hello 对应的 value 数据，返回给 client。</p>
<p>到这里，一个读请求之路执行完成。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=3-faq>3. FAQ<a href=#3-faq class=hash-link aria-label="Direct link to 3. FAQ" title="Direct link to 3. FAQ">​</a></h2>
<p>Q：<strong>readIndex 需要请求 leader，那为什么不直接让 leader 返回读请求的结果？</strong></p>
<p>A：<strong>主要是性能因素</strong>，如果将所有读请求都转发到 Leader，会导致 Leader 负载升高，内存、cpu、网络带宽资源都很容易耗尽。特别是expensive request场景，会让 Leader 节点性能会急剧下降。read index 机制的引入，使得每个follower节点都可以处理读请求，极大扩展提升了写性能。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=4-小结>4. 小结<a href=#4-小结 class=hash-link aria-label="Direct link to 4. 小结" title="Direct link to 4. 小结">​</a></h2>
<p>一个读请求从 client 通过 Round-robin 负载均衡算法，选择一个 etcd server 节点，发出 gRPC 请求，经过 etcd server 的 KVServer 模块、线性读模块、MVCC 的 treeIndex 和 boltdb 模块紧密协作，完成了一个读请求。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=5-参考资料>5. 参考资料：<a href=#5-参考资料 class=hash-link aria-label="Direct link to 5. 参考资料：" title="Direct link to 5. 参考资料：">​</a></h2>
<ul>
<li><a href=https://ms2008.github.io/2019/12/04/etcd-rumor/ target=_blank rel="noopener noreferrer">https://ms2008.github.io/2019/12/04/etcd-rumor/</a></li>
<li><a href=https://www.cnblogs.com/ricklz/p/15204381.html target=_blank rel="noopener noreferrer">https://www.cnblogs.com/ricklz/p/15204381.html</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/database-and-middleware/etcd-split-brain-handling><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>etcd脑裂处理办法</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/database-and-middleware/distributed-system-raft><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>分布式系统的Raft算法</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#1-概述 class="table-of-contents__link toc-highlight">1. 概述</a><li><a href=#2-读请求流程 class="table-of-contents__link toc-highlight">2. 读请求流程</a><li><a href=#3-faq class="table-of-contents__link toc-highlight">3. FAQ</a><li><a href=#4-小结 class="table-of-contents__link toc-highlight">4. 小结</a><li><a href=#5-参考资料 class="table-of-contents__link toc-highlight">5. 参考资料：</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>