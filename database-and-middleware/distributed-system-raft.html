<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/数据库与中间件/Etcd/分布式系统的Raft算法" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>分布式系统的Raft算法 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/database-and-middleware/distributed-system-raft><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="分布式系统的Raft算法 | John's Blog"><meta data-rh=true name=description content=深入探讨分布式系统中Raft算法的原理、实现机制和应用场景，包括领导者选举、日志复制等核心特性><meta data-rh=true property=og:description content=深入探讨分布式系统中Raft算法的原理、实现机制和应用场景，包括领导者选举、日志复制等核心特性><meta data-rh=true name=keywords content=Raft,分布式系统,一致性算法,共识协议,Leader选举,日志复制,分布式存储><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/database-and-middleware/distributed-system-raft><link data-rh=true rel=alternate href=https://johng.cn/database-and-middleware/distributed-system-raft hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/database-and-middleware/distributed-system-raft hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><script src=https://cdn.wwads.cn/js/makemoney.js async></script><link rel=stylesheet href=/assets/css/styles.208c11f9.css><script src=/assets/js/runtime~main.6723f326.js defer></script><script src=/assets/js/main.d3c7ff30.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/ai>AI技术</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/cloud-native>云原生</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/observability>可观测性</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/cloud-native>云原生</a><button aria-label="Expand sidebar category '云原生'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/database-and-middleware>数据库与中间件</a><button aria-label="Collapse sidebar category '数据库与中间件'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/database-and-middleware/mysql>MySQL</a><button aria-label="Expand sidebar category 'MySQL'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/database-and-middleware/redis>Redis</a><button aria-label="Expand sidebar category 'Redis'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/database-and-middleware/etcd>Etcd</a><button aria-label="Collapse sidebar category 'Etcd'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/database-and-middleware/etcd-split-brain-handling>etcd脑裂处理办法</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/database-and-middleware/etcd-read-request-flow>etcd读请求执行流程分析</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/database-and-middleware/distributed-system-raft>分布式系统的Raft算法</a></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/database-and-middleware/database-normalization>数据库三大范式与反三范式</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/database-and-middleware><span itemprop=name>数据库与中间件</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/database-and-middleware/etcd><span itemprop=name>Etcd</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>分布式系统的Raft算法</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=基本介绍>基本介绍<a href=#基本介绍 class=hash-link aria-label="Direct link to 基本介绍" title="Direct link to 基本介绍">​</a></h2>
<p>过去，Paxos一直是分布式协议的标准，但是Paxos难于理解，更难以实现，Google的分布式锁系统Chubby作为Paxos实现曾经遭遇到很多坑。</p>
<p>来自Stanford的新的分布式协议研究称为Raft，它是一个为真实世界应用建立的协议，主要注重协议的落地性和可理解性。</p>
<p>在了解Raft之前，我们先了解<strong>Consensus一致性共识</strong>这个概念，它是指多个服务器在状态达成一致，但是在一个分布式系统中，因为各种意外可能，有的服务器可能会崩溃或变得不可靠，它就不能和其他服务器达成一致状态。这样就需要一种Consensus协议，一致性协议是为了确保容错性，也就是即使系统中有一两个服务器当机，也不会影响其处理过程。</p>
<p>为了以容错方式达成一致，我们不可能要求所有服务器100%都达成一致状态，只要超过半数的大多数服务器达成一致就可以了，假设有N台服务器，N/2 1 就超过半数，代表大多数了。</p>
<p>Paxos和Raft都是为了实现Consensus一致性这个目标，这个过程如同选举一样，参选者需要说服大多数选民(服务器)投票给他，一旦选定后就跟随其操作。Paxos和Raft的区别在于选举的具体过程不同。</p>
<p>虽然 Raft 的论文比 Paxos 简单版论文还容易读了，但论文依然发散的比较多，相对冗长。读完后掩卷沉思觉得还是整理一下才会更牢靠，变成真正属于自己的。这里我就借助前面黑白棋落子里第一种极简思维来描述和概念验证下 Raft 协议的工作方式。</p>
<p>在一个由 Raft 协议组织的集群中有三类角色：</p>
<ol>
<li>Leader（领袖）</li>
<li>Follower（群众）</li>
<li>Candidate（候选人）</li>
</ol>
<p>就像一个民主社会，领袖由民众投票选出。刚开始没有领袖，所有集群中的参与者都是群众，那么首先开启一轮大选，在大选期间所有群众都能参与竞选，这时所有群众的角色就变成了候选人，民主投票选出领袖后就开始了这届领袖的任期，然后选举结束，所有除领袖的候选人又变回群众角色服从领袖领导。这里提到一个概念「<strong>任期</strong>」，用术语 <strong>Term</strong> 表达。关于 Raft 协议的核心概念和术语就这么多而且和现实民主制度非常匹配，所以很容易理解。三类角色的变迁图如下，结合后面的选举过程来看很容易理解。</p>
<p><img decoding=async loading=lazy src=/assets/images/auto-815275-20160301175331861-266461745-1aea237eb0417f1db215f2aa50498145.png width=1280 height=699 class=img_ev3q></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=leader-选举过程>Leader 选举过程<a href=#leader-选举过程 class=hash-link aria-label="Direct link to Leader 选举过程" title="Direct link to Leader 选举过程">​</a></h2>
<p>在极简的思维下，一个最小的 Raft 民主集群需要三个参与者（如下图：A、B、C），这样才可能投出多数票。初始状态 ABC 都是 Follower，然后发起选举这时有三种可能情形发生。下图中前二种都能选出 Leader，第三种则表明本轮投票无效（Split Votes），每方都投给了自己，结果没有任何一方获得多数票。之后每个参与方随机休息一阵（Election Timeout）重新发起投票直到一方获得多数票。<strong>这里的关键就是随机 timeout，最先从 timeout 中恢复发起投票的一方向还在 timeout 中的另外两方请求投票，这时它们就只能投给对方了，很快达成一致</strong>。</p>
<p><img decoding=async loading=lazy src=/assets/images/auto-815275-20160301175349689-522400583-98ceb5596d3d5bd6e09cde57fb16a146.png width=1280 height=1145 class=img_ev3q></p>
<p>选出 Leader 后，Leader 通过定期向所有 Follower 发送心跳信息维持其统治。若 Follower 一段时间未收到 Leader 的心跳则认为 Leader 可能已经挂了再次发起选主过程。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=leader-节点对一致性的影响>Leader 节点对一致性的影响<a href=#leader-节点对一致性的影响 class=hash-link aria-label="Direct link to Leader 节点对一致性的影响" title="Direct link to Leader 节点对一致性的影响">​</a></h2>
<p>Raft 协议强依赖 Leader 节点的可用性来确保集群数据的一致性。数据的流向只能从 Leader 节点向 Follower 节点转移。**当 Client 向集群 Leader 节点提交数据后，Leader 节点接收到的数据处于未提交状态（Uncommitted），接着 Leader 节点会并发向所有 Follower 节点复制数据并等待接收响应，确保至少集群中超过半数节点已接收到数据后再向 Client 确认数据已接收。**一旦向 Client 发出数据接收 Ack 响应后，表明此时数据状态进入已提交（Committed），Leader 节点再向 Follower 节点发通知告知该数据状态已提交。</p>
<p><img decoding=async loading=lazy src=/assets/images/auto-815275-20160301175358173-526445555-081cd91c5fec267c33ca6f32be281ae9.png width=1070 height=674 class=img_ev3q></p>
<p>在这个过程中，主节点可能在任意阶段挂掉，看下 Raft 协议如何针对不同阶段保障数据一致性的。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=1-数据到达-leader-节点前>1. 数据到达 Leader 节点前<a href=#1-数据到达-leader-节点前 class=hash-link aria-label="Direct link to 1. 数据到达 Leader 节点前" title="Direct link to 1. 数据到达 Leader 节点前">​</a></h4>
<p>这个阶段 Leader 挂掉不影响一致性，不多说。</p>
<p><img decoding=async loading=lazy src=/assets/images/auto-815275-20160301175405705-1452838896-471b731fb36172f8ee4d596a85bf196c.png width=1096 height=620 class=img_ev3q></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=2-数据到达-leader-节点但未复制到-follower-节点>2. 数据到达 Leader 节点，但未复制到 Follower 节点<a href=#2-数据到达-leader-节点但未复制到-follower-节点 class=hash-link aria-label="Direct link to 2. 数据到达 Leader 节点，但未复制到 Follower 节点" title="Direct link to 2. 数据到达 Leader 节点，但未复制到 Follower 节点">​</a></h4>
<p>这个阶段 Leader 挂掉，数据属于未提交状态，Client 不会收到 Ack 会认为超时失败可安全发起重试。Follower 节点上没有该数据，重新选主后 Client 重试重新提交可成功。<strong>原来的 Leader 节点恢复后作为 Follower 加入集群重新从当前任期的新 Leader 处同步数据，强制保持和新的 Leader 数据一致</strong>。</p>
<p><img decoding=async loading=lazy src=/assets/images/auto-815275-20160301175412580-649716029-303c850c9f6332a36bfadd3d6668a415.png width=1024 height=684 class=img_ev3q></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=3-数据到达-leader-节点成功复制到-follower-所有节点但还未向-leader-响应接收>3. 数据到达 Leader 节点，成功复制到 Follower 所有节点，但还未向 Leader 响应接收<a href=#3-数据到达-leader-节点成功复制到-follower-所有节点但��还未向-leader-响应接收 class=hash-link aria-label="Direct link to 3. 数据到达 Leader 节点，成功复制到 Follower 所有节点，但还未向 Leader 响应接收" title="Direct link to 3. 数据到达 Leader 节点，成功复制到 Follower 所有节点，但还未向 Leader 响应接收">​</a></h4>
<p>这个阶段 Leader 挂掉，虽然数据在 Follower 节点处于未提交状态（Uncommitted）但保持一致，重新选出 Leader 后可完成数据提交，此时 Client 由于不知到底提交成功没有，可重试提交。<strong>针对这种情况 Raft 要求 RPC 请求实现幂等性，也就是要实现内部去重机制。</strong></p>
<p><img decoding=async loading=lazy src=/assets/images/auto-815275-20160301175419501-326023047-75936d00ef94a1adda2429648dc53b88.png width=1056 height=598 class=img_ev3q></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=4-数据到达-leader-节点成功复制到-follower-部分节点但还未向-leader-响应接收>4. 数据到达 Leader 节点，成功复制到 Follower 部分节点，但还未向 Leader 响应接收<a href=#4-数据到达-leader-节点成功复制到-follower-部分节点但还未向-leader-响应接收 class=hash-link aria-label="Direct link to 4. 数据到达 Leader 节点，成功复制到 Follower 部分节点，但还未向 Leader 响应接收" title="Direct link to 4. 数据到达 Leader 节点，成功复制到 Follower 部分节点，但还未向 Leader 响应接收">​</a></h4>
<p>这个阶段 Leader 挂掉，数据在 Follower 节点处于未提交状态（Uncommitted）且不一致，<strong>Raft 协议要求投票只能投给拥有最新数据的节点</strong>。所以拥有最新数据的节点会被选为 Leader 再强制同步数据到 Follower，数据不会丢失并最终一致。</p>
<p><img decoding=async loading=lazy src=/assets/images/auto-815275-20160301175427314-1771762822-af9d70c3d6cbc6611e7e5dc583462aff.png width=1102 height=636 class=img_ev3q></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=5-数据到达-leader-节点成功复制到-follower-所有或多数节点数据在-leader-处于已提交状态但在-follower-处于未提交状态>5. 数据到达 Leader 节点，成功复制到 Follower 所有或多数节点，数据在 Leader 处于已提交状态，但在 Follower 处于未提交状态<a href=#5-数据到达-leader-节点成功复制到-follower-所有或多数节点数据在-leader-处于已提交状态但在-follower-处于未提交状态 class=hash-link aria-label="Direct link to 5. 数据到达 Leader 节点，成功复制到 Follower 所有或多数节点，数据在 Leader 处于已提交状态，但在 Follower 处于未提交状态" title="Direct link to 5. 数据到达 Leader 节点，成功复制到 Follower 所有或多数节点，数据在 Leader 处于已提交状态，但在 Follower 处于未提交状态">​</a></h4>
<p>这个阶段 Leader 挂掉，重新选出新 Leader 后的处理流程和阶段 3 一样。</p>
<p><img decoding=async loading=lazy src=/assets/images/auto-815275-20160301175434189-317254838-b545a49cc752d5b75f4c303337aa8a6f.png width=1212 height=608 class=img_ev3q></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=6-数据到达-leader-节点成功复制到-follower-所有或多数节点数据在所有节点都处于已提交状态但还未响应-client>6. 数据到达 Leader 节点，成功复制到 Follower 所有或多数节点，数据在所有节点都处于已提交状态，但还未响应 Client<a href=#6-数据到达-leader-节点成功复制到-follower-所有或多数节点数据在所有节点都处于已提交状态但还未响应-client class=hash-link aria-label="Direct link to 6. 数据到达 Leader 节点，成功复制到 Follower 所有或多数节点，数据在所有节点都处于已提交状态，但还未响应 Client" title="Direct link to 6. 数据到达 Leader 节点，成功复制到 Follower 所有或多数节点，数据在所有节点都处于已提交状态，但还�未响应 Client">​</a></h4>
<p>这个阶段 Leader 挂掉，Cluster 内部数据其实已经是一致的，Client 重复重试基于幂等策略对一致性无影响。</p>
<p><img decoding=async loading=lazy src=/assets/images/auto-815275-20160301175628111-980324469-128eb782eb2463c6717665059468e954.png width=1212 height=614 class=img_ev3q></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=7-网络分区导致的脑裂情况出现双-leader>7. 网络分区导致的脑裂情况，出现双 Leader<a href=#7-网络分区导致的脑裂情况出现双-leader class=hash-link aria-label="Direct link to 7. 网络分区导致的脑裂情况，出现双 Leader" title="Direct link to 7. 网络分区导致的脑裂情况，出现双 Leader">​</a></h4>
<p>网络分区将原先的 Leader 节点和 Follower 节点分隔开，Follower 收不到 Leader 的心跳将发起选举产生新的 Leader。这时就产生了双 Leader，原先的 Leader 独自在一个区，向它提交数据不可能复制到多数节点所以永远提交不成功。向新的 Leader 提交数据可以提交成功，网络恢复后旧的 Leader 发现集群中有更新任期（Term）的新 Leader 则自动降级为 Follower 并从新 Leader 处同步数据达成集群数据一致。</p>
<p><img decoding=async loading=lazy src=/assets/images/auto-815275-20160301175637220-1693295968-bea81bc08b9557fb825c58a5fb348d9b.png width=1280 height=868 class=img_ev3q></p>
<p>综上穷举分析了最小集群（3 节点）面临的所有情况，可以看出 Raft 协议都能很好的应对一致性问题，并且很容易理解。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=总结>总结<a href=#总结 class=hash-link aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h2>
<ul>
<li>目前几乎所有语言都已经有支持Raft算法的库包，具体可参考：<a href=http://raftconsensus.github.io/ target=_blank rel="noopener noreferrer">raftconsensus.github.io</a></li>
<li><a href=http://thesecretlivesofdata.com/raft/ target=_blank rel="noopener noreferrer">英文动画演示Raft</a></li>
<li><a href=http://www.jdon.com/37625 target=_blank rel="noopener noreferrer">CAP定理</a></li>
<li><a href=http://www.jdon.com/artichect/paxos.html target=_blank rel="noopener noreferrer">分布式Paxos算法</a></li>
<li><a href=http://www.jdon.com/artichect/zookeeper.html target=_blank rel="noopener noreferrer">ZooKeeper在服务发现中应用</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/database-and-middleware/etcd-read-request-flow><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>etcd读请求执行流程分析</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/database-and-middleware/database-normalization><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>数据库三大范式与反三范式</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#基本介绍 class="table-of-contents__link toc-highlight">基本介绍</a><li><a href=#leader-选举过程 class="table-of-contents__link toc-highlight">Leader 选举过程</a><li><a href=#leader-节点对一致性的影响 class="table-of-contents__link toc-highlight">Leader 节点对一致性的影响</a><li><a href=#总结 class="table-of-contents__link toc-highlight">总结</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>