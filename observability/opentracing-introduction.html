<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/可观测性/链路跟踪/OpenTracing介绍" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>OpenTracing介绍 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/observability/opentracing-introduction><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="OpenTracing介绍 | John's Blog"><meta data-rh=true name=description content="详细介绍 OpenTracing 分布式链路追踪规范，包括核心概念、数据模型和实践示例，并使用 Jaeger 进行演示"><meta data-rh=true property=og:description content="详细介绍 OpenTracing 分布式链路追踪规范，包括核心概念、数据模型和实践示例，并使用 Jaeger 进行演示"><meta data-rh=true name=keywords content=OpenTracing,链路追踪,Jaeger,Span,分布式追踪,链路监控><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/observability/opentracing-introduction><link data-rh=true rel=alternate href=https://johng.cn/observability/opentracing-introduction hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/observability/opentracing-introduction hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><script src=https://cdn.wwads.cn/js/makemoney.js async></script><link rel=stylesheet href=/assets/css/styles.96de5670.css><script src=/assets/js/runtime~main.8306af45.js defer></script><script src=/assets/js/main.fc8c0be4.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/cloud-native>云原生</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" sidebarid=mainSidebar href=/observability>可观测性</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/cloud-native>云原生</a><button aria-label="Expand sidebar category '云原生'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/observability>可观测性</a><button aria-label="Collapse sidebar category '可观测性'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/observability/tracing>链路跟踪</a><button aria-label="Collapse sidebar category '链路跟踪'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/observability/opentracing-introduction>OpenTracing介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/observability/opentelemetry-introduction>OpenTelemetry介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/observability/opentelemetry-architecture>OpenTelemetry架构</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/observability/monitoring>监控技术</a><button aria-label="Expand sidebar category '监控技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/observability><span itemprop=name>可观测性</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/observability/tracing><span itemprop=name>链路跟踪</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>OpenTracing介绍</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><p>在微服务架构的系统中，请求在各服务之间流转，调用链错综复杂，一旦出现了问题和异常，很难追查定位，这个时候就需要链路追踪来帮忙了。链路追踪系统能追踪并记录请求在系统中的调用顺序，调用时间等一系列关键信息，从而帮助我们定位异常服务和发现性能瓶颈。</p>
<header><h1>Opentracing</h1></header>
<p><img decoding=async loading=lazy src=/assets/images/a78b058374144b879a8ab05b91ea1bcf-52a052677f4ab642cc35218ff84ea964.png width=666 height=465 class=img_ev3q></p>
<p><code>Opentracing</code>是分布式链路追踪的一种规范标准，是<code>CNCF</code>（云原生计算基金会）下的项目之一。和一般的规范标准不同，<code>Opentracing</code>不是传输协议，消息格式层面上的规范标准，而是一种语言层面上的API标准。以<code>Go</code>语言为例，只要某链路追踪系统实现了<code>Opentracing</code>规定的接口（<code>interface</code>），符合<code>Opentracing</code>定义的表现行为，那么就可以说该应用符合<code>Opentracing</code>标准。这意味着开发者只需修改少量的配置代码，就可以在符合<code>Opentracing</code>标准的链路追踪系统之间自由切换：<a href=https://github.com/opentracing/opentracing-go target=_blank rel="noopener noreferrer">https://github.com/opentracing/opentracing-go</a></p>
<p>在使用<code>Opentracing</code>来实现全链路追踪前，有必要先了解一下它所定义的数据模型。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=trace>Trace<a href=#trace class=hash-link aria-label="Direct link to Trace" title="Direct link to Trace">​</a></h2>
<p><code>Trace</code>表示一次完整的追踪链路，<code>trace</code>由一个或多个<code>span</code>组成。下图示例表示了一个由<code>8</code>个<code>span</code>组成的<code>trace</code>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">        [Span A]  ←←←(the root span)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            |</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">     +------+------+</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">     |             |</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"> [Span B]      [Span C] ←←←(Span C is a `ChildOf` Span A)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">     |             |</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"> [Span D]      +---+-------+</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">               |           |</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">           [Span E]    [Span F] >>> [Span G] >>> [Span H]</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                                       ↑</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                                       ↑</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                                       ↑</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                         (Span G `FollowsFrom` Span F)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>时间轴的展现方式会更容易理解：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">––|–––––––|–––––––|–––––––|–––––––|–––––––|–––––––|–––––––|–> time</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"> [Span A···················································]</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">   [Span B··············································]</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      [Span D··········································]</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    [Span C········································]</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">         [Span E·······]        [Span F··] [Span G··] [Span H··]</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>示例来源：<a href=https://github.com/opentracing/specification/blob/master/specification.md#the-opentracing-data-model target=_blank rel="noopener noreferrer">https://github.com/opentracing/specification/blob/master/specification.md#the-opentracing-data-model</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=span>Span<a href=#span class=hash-link aria-label="Direct link to Span" title="Direct link to Span">​</a></h2>
<p><code>Span</code>是一条追踪链路中的基本组成要素，一个<code>span</code>表示一个独立的工作单元，比如可以表示一次函数调用，一次<code>http</code>请求等等。<code>span</code>会记录如下基本要素:</p>
<ul>
<li>服务名称（<code>operation name</code>）</li>
<li>服务的开始时间和结束时间</li>
<li><code>K/V</code>形式的<code>Tags</code></li>
<li><code>K/V</code>形式的<code>Logs</code></li>
<li><code>SpanContext</code></li>
<li><code>References</code>：该<code>span</code>对一个或多个<code>span</code>的引用（通过引用<code>SpanContext</code>）。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=tags>Tags<a href=#tags class=hash-link aria-label="Direct link to Tags" title="Direct link to Tags">​</a></h3>
<p><code>Tags</code>以<code>K/V</code>键值对的形式保存用户自定义标签，主要用于链路追踪结果的查询过滤。例如： <code>http.method="GET",http.status_code=200</code>。其中<code>key</code>值必须为字符串，<code>value</code>必须是字符串，布尔型或者数值型。 <code>span</code>中的<code>tag</code>仅自己可见，不会随着 <code>SpanContext</code>传递给后续<code>span</code>。 例如：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">span</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>SetTag</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"http.method"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token string" style=color:#a6e22e>"GET"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">span</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>SetTag</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"http.status_code"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>200</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=logs>Logs<a href=#logs class=hash-link aria-label="Direct link to Logs" title="Direct link to Logs">​</a></h3>
<p><code>Logs</code>与<code>tags</code>类似，也是<code>K/V</code>键值对形式。与<code>tags</code>不同的是，<code>logs</code>还会记录写入<code>logs</code>的时间，因此<code>logs</code>主要用于记录某些事件发生的时间。<code>logs</code>的<code>key</code>值同样必须为字符串，但对<code>value</code>类型则没有限制。例如：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">span</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>LogFields</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    log</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>String</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"event"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"soft error"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    log</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>String</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"type"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cache timeout"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    log</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"waited.millis"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1500</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>::: info
<code>Opentracing</code>列举了一些惯用的<code>Tags</code>和<code>Logs</code>：<a href=https://github.com/opentracing/specification/blob/master/semantic_conventions.md target=_blank rel="noopener noreferrer">https://github.com/opentracing/specification/blob/master/semantic_conventions.md</a>
:::</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=spancontext>SpanContext<a href=#spancontext class=hash-link aria-label="Direct link to SpanContext" title="Direct link to SpanContext">​</a></h3>
<p><code>SpanContext</code>携带着一些用于**跨服务通信的（跨进程）**数据，主要包含：</p>
<ul>
<li>
<p>足够在系统中标识该<code>span</code>的信息，比如：<code>span_id, trace_id</code>。</p>
</li>
<li>
<p><code>Baggage Items</code>，为整条追踪连保存跨服务（跨进程）的<code>K/V</code>格式的用户自定义数据。<code>Baggage Items</code>与<code>tags</code>类似，也是<code>K/V</code>键值对。与<code>tags</code>不同的是：</p>
</li>
<li>
<ul>
<li>其<code>key</code>跟<code>value</code>都只能是字符串格式</li>
<li><code>Baggage items</code>不仅当前<code>span</code>可见，其会随着<code>SpanContext</code>传递给后续所有的子<code>span</code>。要小心谨慎的使用<code>baggage items</code> - 因为在所有的<code>span</code>中传递这些<code>K,V</code>会带来不小的网络和<code>CPU</code>开销。</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=references>References<a href=#references class=hash-link aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<p><code>Opentracing</code>定义了两种引用关系:<code>ChildOf</code>和<code>FollowFrom</code>。</p>
<ul>
<li><code>ChildOf</code>: 父<code>span</code>的执行依赖子<code>span</code>的执行结果时，此时子<code>span</code>对父<code>span</code>的引用关系是<code>ChildOf</code>。比如对于一次<code>RPC</code>调用，服务端的<code>span</code>（子<code>span</code>）与客户端调用的<code>span</code>（父<code>span</code>）是<code>ChildOf</code>关系。</li>
<li><code>FollowFrom</code>：父<code>span</code>的执不依赖子<code>span</code>执行结果时，此时子<code>span</code>对父<code>span</code>的引用关系是<code>FollowFrom</code>。<code>FollowFrom</code>常用于异步调用的表示，例如消息队列中<code>consumer span</code>与<code>producer span</code>之间的关系。</li>
</ul>
<h1>使用示例</h1>
<p>对<code>Opentracing</code>的概念有初步了解后，下面使用<code>Jaeger</code>来演示如何在程序中使用实现链路追踪。</p>
<p>::: tip
为方便演示，以下示例为进程内部方法的链路跟踪记录，更多详细的示例可参考： <a href=https://github.com/yurishkuro/opentracing-tutorial/tree/master/go target=_blank rel="noopener noreferrer">Opentracing Go Tutorial</a>
:::</p>
<p><img decoding=async loading=lazy src=/assets/images/architecture-v1-c63fdb8eda3363c2d8cdf6b7354bee8e.png width=960 height=540 class=img_ev3q></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=jaeger>Jaeger<a href=#jaeger class=hash-link aria-label="Direct link to Jaeger" title="Direct link to Jaeger">​</a></h2>
<p><a href=https://www.jaegertracing.io/ target=_blank rel="noopener noreferrer">Jaeger</a>\ˈyā-gər\ 是Uber开源的分布式追踪系统，是遵循<code>Opentracing</code>的系统之一，也是<code>CNCF</code>项目。本篇将使用<code>Jaeger</code>来演示如何在系统中引入分布式追踪。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=quick-start>Quick Start<a href=#quick-start class=hash-link aria-label="Direct link to Quick Start" title="Direct link to Quick Start">​</a></h2>
<p><code>Jaeger</code>提供了<code>all-in-one</code>镜像，方便我们快速开始测试：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token function" style=color:#e6db74>docker</span><span class="token plain"> run </span><span class="token parameter variable" style=color:#f8f8f2>-d</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>--name</span><span class="token plain"> jaeger </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>-e</span><span class="token plain"> </span><span class="token assign-left variable" style=color:#f8f8f2>COLLECTOR_ZIPKIN_HTTP_PORT</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>9411</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>-p</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>5775</span><span class="token plain">:5775/udp </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>-p</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>6831</span><span class="token plain">:6831/udp </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>-p</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>6832</span><span class="token plain">:6832/udp </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>-p</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>5778</span><span class="token plain">:5778 </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>-p</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>16686</span><span class="token plain">:16686 </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>-p</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>14268</span><span class="token plain">:14268 </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>-p</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>9411</span><span class="token plain">:9411 </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">jaegertracing/all-in-one:1.14</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>镜像启动后，通过 <a href=http://localhost:16686/ target=_blank rel="noopener noreferrer">http://localhost:16686</a> 可以打开<code>Jaeger UI</code>。</p>
<p>下载客户端<code>library</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">go get github.com/jaegertracing/jaeger-client-go</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>初始化<code>Jaeger tracer</code>:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token string" style=color:#a6e22e>"context"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token string" style=color:#a6e22e>"errors"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token string" style=color:#a6e22e>"fmt"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token string" style=color:#a6e22e>"io"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token string" style=color:#a6e22e>"time"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token string" style=color:#a6e22e>"github.com/opentracing/opentracing-go"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token string" style=color:#a6e22e>"github.com/opentracing/opentracing-go/log"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token string" style=color:#a6e22e>"github.com/uber/jaeger-client-go"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    jaegerCfg </span><span class="token string" style=color:#a6e22e>"github.com/uber/jaeger-client-go/config"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// initJaeger 将jaeger tracer设置为全局tracer</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>initJaeger</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">service </span><span class="token builtin" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> io</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Closer </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    cfg </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> jaegerCfg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Configuration</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// 将采样频率设置为1，每一个span都记录，方便查看测试结果</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        Sampler</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">jaegerCfg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">SamplerConfig</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            Type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">  jaeger</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">SamplerTypeConst</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            Param</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        Reporter</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">jaegerCfg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ReporterConfig</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            LogSpans</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>true</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic>// 将span发往jaeger-collector的服务地址</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            CollectorEndpoint</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"http://localhost:14268/api/traces"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    closer</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> cfg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>InitGlobalTracer</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">service</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> jaegerCfg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Logger</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">jaeger</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">StdLogger</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token function" style=color:#e6db74>panic</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">fmt</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Sprintf</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"ERROR: cannot init Jaeger: %v\n"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> closer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>创建<code>tracer</code>，生成<code>root span</code>：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>main</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    closer </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>initJaeger</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"in-process"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>defer</span><span class="token plain"> closer</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Close</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 获取jaeger tracer</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    tracer </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> opentracing</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>GlobalTracer</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 创建root span</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    span </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> tracer</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>StartSpan</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"in-process-service"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// main执行完结束这个span</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>defer</span><span class="token plain"> span</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Finish</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 将span传递给Foo</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ctx </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> opentracing</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>ContextWithSpan</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Background</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> span</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token function" style=color:#e6db74>Foo</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>上述代码创建了一个<code>root span</code>，并将该<code>span</code>通过<code>context</code>传递给<code>Foo</code>方法，以便在<code>Foo</code>方法中将追踪链继续延续下去：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>Foo</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 开始一个span, 设置span的operation_name为Foo</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    span</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> ctx </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> opentracing</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>StartSpanFromContext</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"Foo"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>defer</span><span class="token plain"> span</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Finish</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 将context传递给Bar</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token function" style=color:#e6db74>Bar</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 模拟执行耗时</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Sleep</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Second</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>Bar</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 开始一个span，设置span的operation_name为Bar</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    span</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> ctx </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> opentracing</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>StartSpanFromContext</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"Bar"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>defer</span><span class="token plain"> span</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Finish</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 模拟执行耗时</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Sleep</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Second</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 假设Bar发生了某些错误</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> errors</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"something wrong"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    span</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>LogFields</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        log</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>String</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"event"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"error"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        log</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>String</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"message"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Error</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    span</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>SetTag</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"error"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>true</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>Foo</code>方法调用了<code>Bar</code>，假设在<code>Bar</code>中发生了一些错误，可以通过<code>span.LogFields</code>和<code>span.SetTag</code>将错误记录在追踪链中。 通过上面的例子可以发现，如果要确保追踪链在程序中不断开，需要将函数的第一个参数设置为<code>context.Context</code>，通过<code>opentracing.ContextWithSpan</code>将保存到<code>context</code>中，通过<code>opentracing.StartSpanFromContext</code>开始一个新的子<code>span</code>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=效果查看>效果查看<a href=#效果查看 class=hash-link aria-label="Direct link to 效果查看" title="Direct link to 效果查看">​</a></h2>
<p>执行完上面的程序后，打开<code>Jaeger UI</code>: <a href=http://localhost:16686/search target=_blank rel="noopener noreferrer">http://localhost:16686/search</a>，可以看到链路追踪的结果：<img decoding=async loading=lazy src=/assets/images/16d37797d34b4a5f-ae9c9e0e900bcf8bef94471d7d75a117.jpg width=1280 height=266 class=img_ev3q></p>
<p><img decoding=async loading=lazy src=/assets/images/16d37797d34b4a5f-ae9c9e0e900bcf8bef94471d7d75a117.jpg width=1280 height=266 class=img_ev3q></p>
<p>点击详情可以查看具体信息：</p>
<p><img decoding=async loading=lazy src=/assets/images/16d3779b990d1859-643dbc6e8413986a725d07ec9d72fd5e.jpg width=1280 height=558 class=img_ev3q></p>
<p> </p>
<p>通过链路追踪系统，我们可以方便的掌握链路中各<code>span</code>的调用顺序，调用关系，执行时间轴，以及记录一些<code>tag</code>和<code>log</code>信息，极大的方便我们定位系统中的异常和发现性能瓶颈。</p>
<h1>其他参考</h1>
<ul>
<li>
<p><a href=https://github.com/yurishkuro/opentracing-tutorial/tree/master/go target=_blank rel="noopener noreferrer">Opentracing Go Tutorial</a></p>
</li>
<li>
<p><a href=https://github.com/opentracing/specification/blob/master/semantic_conventions.md target=_blank rel="noopener noreferrer">Opentracing语义习惯</a></p>
</li>
<li>
<p><a href=https://github.com/opentracing/specification/blob/master/specification.md target=_blank rel="noopener noreferrer">Opentracing规范文档v1.1</a></p>
</li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/observability/tracing><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>链路跟踪</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/observability/opentelemetry-introduction><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>OpenTelemetry介绍</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#trace class="table-of-contents__link toc-highlight">Trace</a><li><a href=#span class="table-of-contents__link toc-highlight">Span</a><ul><li><a href=#tags class="table-of-contents__link toc-highlight">Tags</a><li><a href=#logs class="table-of-contents__link toc-highlight">Logs</a><li><a href=#spancontext class="table-of-contents__link toc-highlight">SpanContext</a></ul><li><a href=#references class="table-of-contents__link toc-highlight">References</a><li><a href=#jaeger class="table-of-contents__link toc-highlight">Jaeger</a><li><a href=#quick-start class="table-of-contents__link toc-highlight">Quick Start</a><li><a href=#效果查看 class="table-of-contents__link toc-highlight">效果查看</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>