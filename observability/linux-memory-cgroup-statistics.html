<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/可观测性/监控技术/Linux中进程内存及cgroup内存统计差异" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Linux中进程内存及cgroup内存统计差异 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/observability/linux-memory-cgroup-statistics><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Linux中进程内存及cgroup内存统计差异 | John's Blog"><meta data-rh=true name=description content="深入分析 Linux 系统中进程内存和 cgroup 内存统计的差异，帮助用户理解容器环境下的内存管理和监控"><meta data-rh=true property=og:description content="深入分析 Linux 系统中进程内存和 cgroup 内存统计的差异，帮助用户理解容器环境下的内存管理和监控"><meta data-rh=true name=keywords content=Linux,Memory,cgroup,内存统计,进程内存,容器内存,系统监控><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/observability/linux-memory-cgroup-statistics><link data-rh=true rel=alternate href=https://johng.cn/observability/linux-memory-cgroup-statistics hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/observability/linux-memory-cgroup-statistics hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><script src=https://cdn.wwads.cn/js/makemoney.js async></script><link rel=stylesheet href=/assets/css/styles.19b7c7dc.css><script src=/assets/js/runtime~main.068dc4dc.js defer></script><script src=/assets/js/main.fb4c190e.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/cloud-native>云原生</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/ai>AI技术</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" sidebarid=mainSidebar href=/observability>可观测性</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/cloud-native>云原生</a><button aria-label="Expand sidebar category '云原生'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/observability>可观测性</a><button aria-label="Collapse sidebar category '可观测性'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/observability/tracing>链路跟踪</a><button aria-label="Expand sidebar category '链路跟踪'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/observability/monitoring>监控技术</a><button aria-label="Collapse sidebar category '监控技术'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/observability/prometheus-exporter-metrics-samples>常用exporter指标samples及指标说明</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/observability/opentelemetry-metrics-introduction>OpenTelemetry Metrics介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/observability/prometheus-rate-irate>promtheus: rate与irate</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/observability/prometheus-alert-rules>prometheus: 常用告警PromeQL</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/observability/linux-memory-cgroup-statistics>Linux中进程内存及cgroup内存统计差异</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/observability/cadvisor-working-set-bytes-oom-killer>Cadvisor working set bytes与linux oom killer</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/observability/kubelet-cadvisor-metrics-missing>从kubelet获取cadvisor指标偶现丢失container*相关指标</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/observability/kubelet-cadvisor-metrics-collection>如何从kubelet拉取cadvisor指标</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/observability/ebpf-learning-guide>eBPF学习</a></ul></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/observability><span itemprop=name>可观测性</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/observability/monitoring><span itemprop=name>监控技术</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Linux中进程内存及cgroup内存统计差异</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=linux内存简介>Linux内存简介<a href=#linux内存简介 class=hash-link aria-label="Direct link to Linux内存简介" title="Direct link to Linux内存简介">​</a></h2>
<p>由于<code>BIOS</code>和<code>Kernel</code>启动过程消耗了部分物理内存，因此<code>MemTotal</code>值（ <code>free</code> 命令获取）小于<code>RAM</code>容量。 <code>Linux</code>内存查询方式：</p>
<ul>
<li><code>free</code> 命令</li>
<li><code>/proc/meminfo</code></li>
</ul>
<p>通过查询到的内存数据可以得到<code>Linux</code>内存计算公式如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>## 总内存 = 已使用内存 + 空闲内存 + 缓存</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">total </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> used + </span><span class="token function" style=color:#e6db74>free</span><span class="token plain"> + buff/cache </span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>其中，已使用内存数据包括<code>Kernel</code>消耗的内存和所有进程消耗的内存。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=进程内存>进程内存<a href=#进程内存 class=hash-link aria-label="Direct link to 进程内存" title="Direct link to 进程内存">​</a></h2>
<p>进程消耗的内存包括：</p>
<ul>
<li>虚拟地址空间映射的物理内存。</li>
<li>读写磁盘生成<code>PageCache</code>消耗的内存。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=虚拟地址映射的物理内存>虚拟地址映射的物理内存<a href=#虚拟地�址映射的物理内存 class=hash-link aria-label="Direct link to 虚拟地址映射的物理内存" title="Direct link to 虚拟地址映射的物理内存">​</a></h4>
<p><img decoding=async loading=lazy src=/assets/images/p619795-69404e15b8193701e36160a86d2d78dd.png width=928 height=705 class=img_ev3q></p>
<ul>
<li><strong>物理内存</strong>：硬件安装的内存（<strong>内存条</strong>）。</li>
<li><strong>虚拟内存</strong>：操作系统为程序运行提供的内存。程序运行空间包括<strong>用户空间（用户态）<strong>和</strong>内核空间（内核态）</strong>。<!-- -->
<ul>
<li>
<p><strong>用户态</strong>：低特权运行程序。数据存储空间包括：</p>
<ul>
<li>栈（<code>Stack</code>）：函数调用的函数栈。</li>
<li><code>MMap(Memory Mapping Segment)</code>：内存映射区。</li>
<li>堆（<code>Heap</code>）：动态分配内存。</li>
<li><code>BBS</code>区：未初始化的静态变量存放区。</li>
<li><code>Data</code>区：已初始化的静态常量存放区。</li>
<li><code>Text</code>区：二进制可执行代码存放区。</li>
</ul>
<p>用户态中运行的程序通过<code>MMap</code>将虚拟地址映射至物理内存中。</p>
</li>
<li>
<p><strong>内核态</strong>：运行的程序需要访问操作系统内核数据。数据存储空间包括：</p>
<ul>
<li>直接映射区：通过简单映射将虚拟地址映射至物理内存中。</li>
<li><code>VMALLOC</code>：内核动态映射空间，用于将连续的虚拟地址映射至不连续的物理内存中。</li>
<li>持久内核映射区：将虚拟地址映射至物理内存的高端内存中。</li>
<li>固定映射区：用于满足特殊映射需求。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>虚拟地址映射的物理内存可以区分为<strong>共享物理内存</strong>和<strong>独占物理内存</strong>。如下图所示，物理内存1和3由进程A独占，物理内存2由进程B独占，物理内存4由进程A和进程B共享。</p>
<p><img decoding=async loading=lazy src=/assets/images/p619791-ad02733770ed0c00a98662bc54f32ef5.png width=1165 height=691 class=img_ev3q></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=pagecache>PageCache<a href=#pagecache class=hash-link aria-label="Direct link to PageCache" title="Direct link to PageCache">​</a></h4>
<p>除了通过<code>MMap</code>文件直接映射外，进程文件还可以通过系统调用<code>Buffered I/O</code>相关的<code>Syscall</code>将数据写入到<code>PageCache</code>，因此，<code>PageCache</code>也会占用一部分内存。</p>
<p><img decoding=async loading=lazy src=/assets/images/p620216-5070eedbff468865b7c23b97f1aa776b.png width=803 height=696 class=img_ev3q></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=进程内存统计指标>进程内存统计指标<a href=#进程内存统计指标 class=hash-link aria-label="Direct link to 进程内存统计指标" title="Direct link to 进程内存统计指标">​</a></h2>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=单进程内存统计指标>单进程内存统计指标<a href=#单进程内存统计指标 class=hash-link aria-label="Direct link to 单进程内存统计指标" title="Direct link to 单进程内存统计指标">​</a></h4>
<p>进程资源有如下类型：</p>
<ul>
<li><code>anno_rss</code>：表示没有映射到文件的内存量，即匿名内存。匿名内存通常是进程通过<code>malloc</code>或类似的方法动态分配的内存。</li>
<li><code>file_rss</code>：表示映射到文件的内存量。如果一个进程打开了一个文件并将其映射到内存，那么这部分内存就会被计入<code>file_rss</code>。</li>
<li><code>shmem_rss</code>：表示共享内存量。如果多个进程共享一部分内存，那么这部分内存就会被计入<code>shmem_rss</code>。</li>
</ul>
<p>::: tip
<code>RSS( resident set size)</code>：驻留集大小。表示进程已装入内存的页面的集合。
:::</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=常用内存查询命令>常用内存查询命令<a href=#常用内存查询命令 class=hash-link aria-label="Direct link to 常用内存查询命令" title="Direct link to 常用内存查询命令">​</a></h4>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=top>top<a href=#top class=hash-link aria-label="Direct link to top" title="Direct link to top">​</a></h6>
<p>::: tip
该命令展示的内存单位默认为<code>KB</code>。
:::</p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-5-6_15-47-44-3c9ff98d71453fab213d95cd82728a15.png width=3784 height=680 class=img_ev3q></p>
<table><thead><tr><th>命令<th>内存<th>说明<th>计算公式<tbody><tr><td><code>top</code><td><code>VIRT(Virtual Set Size)</code><td>虚拟地址空间。<td>无<tr><td><code>RES(Resident Set Size)</code><td><code>RSS</code>映射的物理内存。<td><code>anno_rss + file_rss + shmem_rss</code><td><tr><td><code>SHR(Shared Memory)</code><td>共享内存。<td><code>file_rss + shmem_rss</code><td><tr><td><code>%MEM</code><td>内存使用率。<td><code>RES / MemTotal</code><td></table>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=ps>ps<a href=#ps class=hash-link aria-label="Direct link to ps" title="Direct link to ps">​</a></h6>
<p>::: tip
该命令展示的内存单位默认为<code>KB</code>。
:::</p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-5-6_15-49-57-2f3941ffe85efd46217fef2907e94dcf.png width=3012 height=446 class=img_ev3q></p>
<table><thead><tr><th>命令<th>内存<th>说明<th>计算公式<tbody><tr><td><code>ps</code><td><code>VSZ(Virtual Set Size)</code><td>虚拟地址空间。<td>无<tr><td><code>RSS(Resident Set Size)</code><td><code>RSS</code>映射的物理内存。<td><code>anno_rss + file_rss + shmem_rss</code><td><tr><td><code>%MEM</code><td>内存使用率。<td><code>RSS / MemTotal</code><td></table>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=smem>smem<a href=#smem class=hash-link aria-label="Direct link to smem" title="Direct link to smem">​</a></h6>
<p>::: tip
该命令需要单独安装。
:::</p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-5-6_15-54-38-5ec44ed134f8c652d743ee6fddc3f4e2.png width=2242 height=624 class=img_ev3q></p>
<table><thead><tr><th>命令<th>内存<th>说明<th>计算公式<tbody><tr><td><code>smem</code><td><code>USS(Unique Set Size)</code><td>独占内存。<td><code>anno_rss</code><tr><td><code>PSS(Proportional Set Size)</code><td>按比例分配内存。<td><code>anno_rss + file_rss/m + shmem_rss/n</code><td><tr><td><code>RSS(Resident Set Size)</code><td><code>RSS</code>映射的物理内存。<td><code>anno_rss + file_rss + shmem_rss</code><td></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=内存指标关系>内存指标关系<a href=#内存指标关系 class=hash-link aria-label="Direct link to 内存指标关系" title="Direct link to 内存指标关系">​</a></h4>
<p><img decoding=async loading=lazy src=/assets/images/p623795-5768896fac67bfaaaf309696a0791227.png width=1284 height=780 class=img_ev3q></p>
<p>::: tip
<code>WSS(Memoy Working Set Size)</code>指标：一种更为合理评估进程内存真实使用内存的计算方式。
但是受限于<code>Linux Page Reclaim</code>机制，这个概念目前还只是概念，并没有哪一个工具可以正确统计出<code>WSS</code>，只能是趋近。
:::</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=cgroup内存统计指标><code>cgroup</code>内存统计指标<a href=#cgroup内存统计指标 class=hash-link aria-label="Direct link to cgroup内存统计指标" title="Direct link to cgroup内存统计指标">​</a></h4>
<p><code>cgroup</code>用于对<code>Linux</code>的一组进程资源进行限制、管理和隔离。更多信息，请参见<a href=https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/6/html/resource_management_guide/ch01 target=_blank rel="noopener noreferrer">官方文档</a>。<br>
<code>cgroup</code>按层级管理，每个节点都包含一组文件，用于统计由这个节点包含的<code>cgroup</code>的某些方面的指标。例如，<code>Memory Control Group(memcg)</code>统计内存相关指标。 <br>
<img decoding=async loading=lazy src=/assets/images/p624557-5fc099c2d921ba214af1bf233cd0dc29.png width=837 height=444 class=img_ev3q></p>
<p><code>memory cgroup</code>文件包含以下指标：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">cgroup.event_control       ## 用于eventfd的接口</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">memory.usage_in_bytes      ## 显示当前已用的内存</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">memory.limit_in_bytes      ## 设置/显示当前限制的内存额度</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">memory.failcnt             ## 显示内存使用量达到限制值的次数</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">memory.max_usage_in_bytes  ## 历史内存最大使用量</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">memory.soft_limit_in_bytes ## 设置/显示当前限制的内存软额度</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">memory.stat                ## 显示当前cgroup的内存使用情况</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">memory.use_hierarchy       ## 设置/显示是否将子cgroup的内存使用情况统计到当前cgroup里面</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">memory.force_empty         ## 触发系统立即尽可能的回收当前cgroup中可以回收的内存</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">memory.pressure_level      ## 设置内存压力的通知事件，配合cgroup.event_control一起使用</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">memory.swappiness          ## 设置和显示当前的swappiness</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">memory.move_charge_at_immigrate ## 设置当进程移动到其他cgroup中时，它所占用的内存是否也随着移动过去</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">memory.oom_control         ## 设置/显示oom controls相关的配置</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">memory.numa_stat           ## 显示numa相关的内存</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>其中需要关注以下<code>3</code>个指标：</p>
<ul>
<li>
<p><code>memory.limit_in_bytes</code>：限制当前<code>cgroup</code>可以使用的内存大小。对应<code>k8s</code>、<code>docker</code>下的<code>memory limits</code>值。</p>
</li>
<li>
<p><code>memory.usage_in_bytes</code>：当前<code>cgroup</code>里所有进程实际使用的内存总和，约等于<code>memory.stat</code>文件下的<code>RSS+Cache</code>值。</p>
</li>
<li>
<p><code>memory.stat</code>：当前<code>cgroup</code>的内存统计详情。</p>
<table><thead><tr><th>memory.stat文件字段<th>说明<tbody><tr><td><code>cache</code><td><code>PageCache</code>缓存页大小。<tr><td><code>rss</code><td><code>cgroup</code>中所有进程的<code>anno_rss</code>内存之和。<tr><td><code>mapped_file</code><td><code>cgroup</code>中所有进程的<code>file_rss</code>和<code>shmem_rss</code>内存之和。<tr><td><code>active_anon</code><td>活跃LRU（<code>least-recently-used</code>，最近最少使用）列表中所有<code>Anonymous</code>进程使用内存和<code>Swap</code>缓存，包括 <code>tmpfs</code>（<code>shmem</code>），单位为<code>bytes</code>。<tr><td><code>inactive_anon</code><td>不活跃<code>LRU</code>列表中所有<code>Anonymous</code>进程使用内存和<code>Swap</code>缓存，包括 <code>tmpfs</code>（<code>shmem</code>），单位为<code>bytes</code>。<tr><td><code>active_file</code><td>活跃<code>LRU</code>列表中所有<code>File-backed</code>进程使用内存，以<code>bytes</code>为单位。<tr><td><code>inactive_file</code><td>不活跃<code>LRU</code>列表中所有<code>File-backed</code>进程使用内存，以<code>bytes</code>为单位。<tr><td><code>unevictable</code><td>无法再生的内存，以<code>bytes</code>为单位。</table>
<p>以上指标中如果带有<code>total_</code>前缀则表示当前<code>cgroup</code>及其下所有子孙<code>cgroup</code>对应指标之和。例如 <code>total_rss</code> 指标表示当前<code>cgroup</code>及其下所有子孙<code>cgroup</code>的<code>RSS</code>指标之和。</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=总结>总结<a href=#总结 class=hash-link aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h4>
<p>单进程和进程<code>cgroup</code>指标区别：</p>
<ul>
<li><code>cgroup</code>的<code>RSS</code>指标只包含<code>anno_rss</code>，对应单进程下的<code>USS</code>指标，因此<code>cgroup</code>的<code>mapped_file+RSS</code>则对应单进程下的<code>RSS</code>指标。</li>
<li>单进程中<code>PageCache</code>需单独统计，<code>cgroup</code>中 <code>memcg</code> 文件统计的内存已包含<code>PageCache</code>。</li>
</ul>
<table><thead><tr><th>内存<th>单进程<th>进程<code>cgroup(memcg)</code><tbody><tr><td><code>RSS</code><td><code>anon_rss + file_rss ＋ shmem_rss</code><td><code>anon_rss</code><tr><td><code>mapped_file</code><td>无<td><code>file_rss + shmem_rss</code><tr><td><code>cache</code><td>无<td><code>PageCache</code></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=docker和k8s中的内存统计>Docker和K8s中的内存统计<a href=#docker和k8s中的内存统计 class=hash-link aria-label="Direct link to Docker和K8s中的内存统计" title="Direct link to Docker和K8s中的内存统计">​</a></h2>
<p><code>Docker</code>和<code>K8S</code>中的内存统计即<code>Linux memcg</code>进程统计，但两者内存使用率的定义不同。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=docker-stat命令>docker stat命令<a href=#docker-stat命令 class=hash-link aria-label="Direct link to docker stat命令" title="Direct link to docker stat命令">​</a></h4>
<p>返回示例如下：</p>
<p><img decoding=async loading=lazy src=/assets/images/p624725-ba41c4764c18e8879785226717f9cfa6.png width=750 height=34 class=img_ev3q></p>
<ul>
<li><code>LIMIT</code>对应控制组的<code>memory.limit_in_bytes</code></li>
<li><code>MEM USAGE</code>对应控制组的<code>memory.usage_in_bytes - memory.stat[total_cache]</code></li>
</ul>
<p>::: tip
<code>docker stat</code>命令查询原理，请参见<a href=https://github.com/docker/cli/blob/37f9a88c696ae81be14c1697bd083d6421b4933c/cli/command/container/stats_helpers.go##L233 target=_blank rel="noopener noreferrer">官方文档</a>。
:::</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=kubectl-top-pod命令>kubectl top pod命令<a href=#kubectl-top-pod命令 class=hash-link aria-label="Direct link to kubectl top pod命令" title="Direct link to kubectl top pod命令">​</a></h4>
<p><code>kubectl top</code>命令通过<code>Metric-server</code>和<code>Heapster</code>获取<code>Cadvisor</code>中<code>working_set</code>的值，表示<code>Pod</code>实例使用的内存大小（不包括<code>Pause</code>容器）。<code>Metrics-server</code>中<code>Pod</code>内存获取原理如下，更多信息，请参见<a href=https://github.com/kubernetes-sigs/metrics-server/blob/d4432d67b2fc435b9c71a89c13659882008a4c54/pkg/sources/summary/summary.go##L206 target=_blank rel="noopener noreferrer">官方文档</a>。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>decodeMemory</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">target </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">resource</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Quantity</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> memStats </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">stats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> memStats </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>||</span><span class="token plain"> memStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">WorkingSetBytes </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> fmt</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Errorf</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"missing memory usage metric"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">target </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token function" style=color:#e6db74>uint64Quantity</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">memStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">WorkingSetBytes</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    target</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Format </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> resource</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">BinarySI</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>Cadvisor</code>内存<code>workingset</code>算法如下，更多信息，请参见<a href=https://github.com/google/cadvisor/blob/0ff17b8d0df3712923c46ca484701b876d02dfee/container/libcontainer/handler.go##L706 target=_blank rel="noopener noreferrer">官方文档</a>。 </p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>setMemoryStats</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">cgroups</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Stats</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> ret </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">info</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ContainerStats</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Usage </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Usage</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Usage</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MaxUsage </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Usage</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MaxUsage</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Failcnt </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Usage</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Failcnt</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">UseHierarchy </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Cache </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Stats</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"total_cache"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">RSS </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Stats</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"total_rss"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Swap </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Stats</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"total_swap"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MappedFile </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Stats</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"total_mapped_file"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>else</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Cache </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Stats</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"cache"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">RSS </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Stats</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"rss"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Swap </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Stats</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"swap"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MappedFile </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Stats</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"mapped_file"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> v</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> ok </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Stats</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"pgfault"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> ok </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ContainerData</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Pgfault </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> v</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">HierarchicalData</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Pgfault </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> v</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> v</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> ok </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Stats</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"pgmajfault"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> ok </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ContainerData</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Pgmajfault </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> v</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">HierarchicalData</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Pgmajfault </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> v</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    workingSet </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Usage</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> v</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> ok </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MemoryStats</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Stats</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"total_inactive_file"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> ok </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> workingSet </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain"> v </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            workingSet </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>else</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            workingSet </span><span class="token operator" style=color:#66d9ef>-=</span><span class="token plain"> v</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ret</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Memory</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">WorkingSet </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> workingSet</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>通过以上命令算法可以得出，<code>kubectl top pod</code>命令查询到的<code>Memory Usage = Memory WorkingSet = memory.usage_in_bytes - memory.stat[total_inactive_file]</code>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=总结-1>总结<a href=#总结-1 class=hash-link aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h4>
<table><thead><tr><th>命令<th>生态<th>Memory Usage计算方式<tbody><tr><td><code>docker stat</code><td><code>docker</code><td><code>memory.usage_in_bytes - memory.stat[total_cache]</code><tr><td><code>kubectl top pod</code><td><code>k8s</code><td><code>memory.usage_in_bytes - memory.stat[total_inactive_file]</code></table>
<p>如果使用<code>top/ps</code>命令查询内存，则<code>cgroup</code>下的<code>Memory Usage</code>指标需对<code>top/ps</code>命令查询到的指标进行以下计算：</p>
<table><thead><tr><th>进程组生态<th>计算公式<tbody><tr><td><code>cgroup</code><td><code>rss + cache（active cache + inactive cache）</code><tr><td><code>docker</code><td><code>rss</code><tr><td><code>k8s</code><td><code>rss + active cache</code></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=参考资料>参考资料<a href=#参考资料 class=hash-link aria-label="Direct link to 参考资料" title="Direct link to 参考资料">​</a></h2>
<ul>
<li>
<p><a href=https://www.alibabacloud.com/help/zh/arms/application-monitoring/memory-metrics target=_blank rel="noopener noreferrer">https://www.alibabacloud.com/help/zh/arms/application-monitoring/memory-metrics</a></p>
</li>
<li>
<p><a href="http://hustcat.github.io/memory-usage-in-process-and-cgroup/?spm=a2c6h.12873639.article-detail.8.4db570921VdAkk" target=_blank rel="noopener noreferrer">http://hustcat.github.io/memory-usage-in-process-and-cgroup</a></p>
</li>
<li>
<p><a href=https://www.51cto.com/article/692936.html target=_blank rel="noopener noreferrer">https://www.51cto.com/article/692936.html</a></p>
</li>
<li>
<p><a href=https://itnext.io/from-rss-to-wss-navigating-the-depths-of-kubernetes-memory-metrics-4d7d77d8fdcb target=_blank rel="noopener noreferrer">https://itnext.io/from-rss-to-wss-navigating-the-depths-of-kubernetes-memory-metrics-4d7d77d8fdcb</a></p>
</li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/observability/prometheus-alert-rules><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>prometheus: 常用告警PromeQL</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/observability/cadvisor-working-set-bytes-oom-killer><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Cadvisor working set bytes与linux oom killer</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#linux内存简介 class="table-of-contents__link toc-highlight">Linux内存简介</a><li><a href=#进程内存 class="table-of-contents__link toc-highlight">进程内存</a><li><a href=#进程内存统计指标 class="table-of-contents__link toc-highlight">进程内存统计指标</a><li><a href=#docker和k8s中的内存统计 class="table-of-contents__link toc-highlight">Docker和K8s中的内存统计</a><li><a href=#参考资料 class="table-of-contents__link toc-highlight">参考资料</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>