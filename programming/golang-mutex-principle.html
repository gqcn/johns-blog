<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/开发语言/Golang/Golang Mutex 原理解析" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Golang Mutex 原理解析 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/programming/golang-mutex-principle><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Golang Mutex 原理解析 | John's Blog"><meta data-rh=true name=description content="深入分析 Go 语言 Mutex 互斥锁的实现原理，包括加锁解锁机制、自旋锁、饥饿模式等核心概念"><meta data-rh=true property=og:description content="深入分析 Go 语言 Mutex 互斥锁的实现原理，包括加锁解锁机制、自旋锁、饥饿模式等核心概念"><meta data-rh=true name=keywords content=Mutex,互斥锁,并发控制,自旋锁,饥饿模式,锁机制><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/programming/golang-mutex-principle><link data-rh=true rel=alternate href=https://johng.cn/programming/golang-mutex-principle hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/programming/golang-mutex-principle hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><script src=https://cdn.wwads.cn/js/makemoney.js async></script><link rel=stylesheet href=/assets/css/styles.96de5670.css><script src=/assets/js/runtime~main.4e3fc753.js defer></script><script src=/assets/js/main.1dfd30ac.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/cloud-native>云原生</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/ai>AI技术</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/observability>可观测性</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/programming>开发语言</a><button aria-label="Collapse sidebar category '开发语言'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/programming/golang>Golang</a><button aria-label="Collapse sidebar category 'Golang'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/goroutine-scheduler>Goroutine调度器</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/programming/golang-mutex-principle>Golang Mutex 原理解析</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/golang-knowledge-review>Golang知识点回顾梳理</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/golang-development-tips>Golang开发中的一些技巧</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/goland-json-tag-camelcase>Goland设置json标签自动生成格式为驼峰</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/go-test-disable-cache>go test 禁用缓存</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/golang-regex-rules>Golang正则规则</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/golang-kubernetes-resource-control>Golang程序在Kubernetes下的资源控制</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/golang-sigsegv-error>unexpected fault address 0x0 fatal error: fault signal SIGSEGV: segmentation violation</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/godebug-gc-trace>GODEBUG配置GC跟踪介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/golang-memory-optimization-case>一个Golang程序内存占用问题排查优化（复盘）</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/goland-remote-debug>使用goland remote debug远程调试</a></ul></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/cloud-native>云原生</a><button aria-label="Expand sidebar category '云原生'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/programming><span itemprop=name>开发语言</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/programming/golang><span itemprop=name>Golang</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Golang Mutex 原理解析</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><p>互斥锁是在并发程序中对共享资源进行访问控制的主要手段。对此 Go 语言提供了简单易用的 <code>Mutex</code>。Mutex 和 Goroutine 合作紧密，概念容易混淆，一定注意要区分各自的概念。</p>
<p><code>Mutex</code> 是一个结构体，对外提供 <code>Lock()</code>和<code>Unlock()</code>两个方法，分别用来加锁和解锁。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// A Locker represents an object that can be locked and unlocked.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> Locker </span><span class="token keyword" style=color:#66d9ef>interface</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token function" style=color:#e6db74>Lock</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token function" style=color:#e6db74>Unlock</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> Mutex </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    state </span><span class="token builtin" style=color:#e6db74>int32</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    sema  </span><span class="token builtin" style=color:#e6db74>uint32</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>const</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    mutexLocked </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&lt;&lt;</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>iota</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// mutex is locked</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    mutexWoken</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    mutexStarving</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    mutexWaiterShift </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>iota</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<ul>
<li>Mutex 是一个互斥锁，其零值对应了未上锁的状态，不能被拷贝；</li>
<li>state 代表互斥锁的状态，比如是否被锁定；</li>
<li>sema 表示信号量，协程阻塞会等待该信号量，解锁的协程释放信号量从而唤醒等待信号量的协程。</li>
</ul>
<p>注意到 state 是一个 int32 变量，内部实现时把该变量分成四份，用于记录 Mutex 的状态。</p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-9-2_11-34-27-fad32cde9345787caf189a397f6012ed.png width=1276 height=542 class=img_ev3q></p>
<ul>
<li>Locked: 表示该 Mutex 是否已经被锁定，0表示没有锁定，1表示已经被锁定；</li>
<li>Woken: 表示是否有协程已经被唤醒，0表示没有协程唤醒，1表示已经有协程唤醒，正在加锁过程中；</li>
<li>Starving: 表示该 Mutex 是否处于饥饿状态，0表示没有饥饿，1表示饥饿状态，说明有协程阻塞了超过1ms；</li>
</ul>
<p>上面三个表示了 Mutex 的三个状态：锁定 - 唤醒 - 饥饿。</p>
<p>Waiter 信息虽然也存在 state 中，其实并不代表状态。它表示阻塞等待锁的协程个数，协程解锁时根据此值来判断是否需要释放信号量。</p>
<p>协程之间的抢锁，实际上争抢给<code>Locked</code>赋值的权利，能给 <code>Locked</code> 置为1，就说明抢锁成功。抢不到就阻塞等待 <code>sema</code> 信号量，一旦持有锁的协程解锁，那么等待的协程会依次被唤醒。</p>
<p><code>Woken</code> 和 <code>Starving</code> 主要用于控制协程间的抢锁过程。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=lock>Lock<a href=#lock class=hash-link aria-label="Direct link to Lock" title="Direct link to Lock">​</a></h2>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">m </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Mutex</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>Lock</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// Fast path: grab unlocked mutex.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> atomic</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>CompareAndSwapInt32</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">m</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">state</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> mutexLocked</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> race</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Enabled </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            race</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Acquire</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">unsafe</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Pointer</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">m</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// Slow path (outlined so that the fast path can be inlined)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    m</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>lockSlow</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>若当前锁已经被使用，请求 Lock() 的 goroutine 会阻塞，直到锁可用为止。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=单协程加锁>单协程加锁<a href=#单协程加锁 class=hash-link aria-label="Direct link to 单协程加锁" title="Direct link to 单协程加锁">​</a></h4>
<p>若只有一个协程加锁，无其他协程干扰，在加锁过程中会判断 <code>Locked</code> 标志位是否为 0，若当前为 0 则置为 1，代表加锁成功。这里本质是一个 CAS 操作，依赖了 <code>atomic.CompareAndSwapInt32</code>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=加锁被阻塞>加锁被阻塞<a href=#加锁被阻塞 class=hash-link aria-label="Direct link to 加锁被阻塞" title="Direct link to 加锁被阻塞">​</a></h4>
<p>假设协程B在尝试加锁前，已经有一个协程A获取到了锁，此时的状态为：</p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-9-2_11-34-53-27d1e720a37f5256d5857357370d4c85.png width=1284 height=400 class=img_ev3q></p>
<p>此时协程B尝试加锁，被阻塞，Mutex 的状态为：</p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-9-2_11-35-14-76c04db9b2526a262cadb3860f2ed181.png width=1284 height=400 class=img_ev3q></p>
<p>Waiter 计数器增加了1，协程B将会持续阻塞，直到 <code>Locked</code> 值变成0 后才会被唤醒。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=unlock>Unlock<a href=#unlock class=hash-link aria-label="Direct link to Unlock" title="Direct link to Unlock">​</a></h2>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">m </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Mutex</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>Unlock</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> race</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Enabled </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token boolean" style=color:#ae81ff>_</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> m</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">state</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        race</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Release</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">unsafe</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Pointer</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">m</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// Fast path: drop lock bit.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token builtin" style=color:#e6db74>new</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> atomic</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>AddInt32</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">m</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">state</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>-</span><span class="token plain">mutexLocked</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>new</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// Outlined slow path to allow inlining the fast path.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        m</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>unlockSlow</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token builtin" style=color:#e6db74>new</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>如果 Mutex 没有被加锁，就直接 <code>Unlock</code> ，会抛出一个 runtime error。</p>
<p>从源码注释来看，一个 Mutex 并不会与某个特定的 goroutine 绑定，理论上讲用一个 goroutine 加锁，另一个 goroutine 解锁也是允许的，不过为了代码可维护性，一般还是建议不要这么搞。</p>
<blockquote>
<p>A locked Mutex is not associated with a particular goroutine. It is allowed for one goroutine to lock a Mutex and then arrange for another goroutine to unlock it.</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=无协程阻塞下的解锁>无协程阻塞下的解锁<a href=#无协程阻塞下的解锁 class=hash-link aria-label="Direct link to 无协程阻塞下的解锁" title="Direct link to 无协程阻塞下的解锁">​</a></h4>
<p>假定在解锁时，没有其他协程阻塞等待加锁，那么只需要将 <code>Locked</code> 置为 0 即可，不需要释放信号量。</p>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id=解锁并唤醒协程>解锁并唤醒协程<a href=#解锁并唤醒协程 class=hash-link aria-label="Direct link to 解锁并唤醒协程" title="Direct link to 解锁并唤醒协程">​</a></h6>
<p>假定解锁时有1个或多个协程阻塞，解锁过程分为两个步骤：</p>
<ol>
<li>将<code>Locked</code>位置0；</li>
<li>看到 <code>Waiter</code> > 0，释放一个信号量，唤醒一个阻塞的协程，被唤醒的协程把 <code>Locked</code> 置为1，获取到锁。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=自旋>自旋<a href=#自旋 class=hash-link aria-label="Direct link to 自旋" title="Direct link to 自旋">​</a></h2>
<p>加锁时，如果当前 <code>Locked</code> 位为1，则说明当前该锁由其他协程持有，尝试加锁的协程并不是马上转入阻塞，而是会持续探测 <code>Locked</code> 位是否变为0，这个过程就是「<strong>自旋</strong>」。</p>
<p>自旋的时间很短，如果在自旋过程中发现锁已经被释放，那么协程可以立即获取锁。此时即便有协程被唤醒，也无法获取锁，只能再次阻塞。</p>
<p>自旋的好处是，当加锁失败时不必立即转入阻塞，有一定机会获取到锁，这样可以避免一部分协程的切换。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=什么是自旋>什么是自旋<a href=#什么是自旋 class=hash-link aria-label="Direct link to 什么是自旋" title="Direct link to 什么是自旋">​</a></h4>
<p>自旋对应于 CPU 的 <code>PAUSE</code> 指令，CPU 对该指令什么都不做，相当于空转。对程序而言相当于<code>sleep</code>了很小一段时间，大概 30个时钟周期。连续两次探测<code>Locked</code> 位的间隔就是在执行这些 <code>PAUSE</code> 指令，它不同于<code>sleep</code>，不需要将协程转为睡眠态。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=自旋条件>自旋条件<a href=#自旋条件 class=hash-link aria-label="Direct link to 自旋条件" title="Direct link to 自旋条件">​</a></h4>
<p>加锁时 Golang 的 runtime 会自动判断是否可以自旋，无限制的自旋将给 CPU 带来巨大压力，自旋必须满足以下所有条件：</p>
<ul>
<li>自旋次数要足够少，通常为 4，即自旋最多 4 次；</li>
<li>CPU 核数要大于 1，否则自旋没有意义，因为此时不可能有其他协程释放锁；</li>
<li>协程调度机制中的 P 的数量要大于 1，比如使用 <code>GOMAXPROCS()</code> 将处理器设置为 1 就不能启用自旋；</li>
<li>协程调度机制中的可运行队列必须为空，否则会延迟协程调度。</li>
</ul>
<p>可见自旋的条件是很苛刻的，简单说就是不忙的时候才会启用自旋。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=自旋的优势>自旋的优势<a href=#自旋的优势 class=hash-link aria-label="Direct link to 自旋的优势" title="Direct link to 自旋的优势">​</a></h4>
<p>自旋的优势是更充分地利用 CPU，尽量避免协程切换。因为当前申请加锁的协程拥有 CPU，如果经过短时间的自旋可以获得锁，则当前写成可以继续运行，不必进入阻塞状态。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=自旋的问题>自旋的问题<a href=#自旋的问题 class=hash-link aria-label="Direct link to 自旋的问题" title="Direct link to 自旋的问题">​</a></h4>
<p>如果在自旋过程中获得锁，那么之前被阻塞的协程就无法获得。如果加锁的协程特别多，每次都通过自旋获取锁，则之前被阻塞的协程将很难获取锁，从而进入【<strong>饥饿状态</strong>】。</p>
<p>为此，Golang 1.8 版本后为<code>Mutex</code>增加了<code>Starving</code>模式，在这个状态下不会自旋，一旦有协程释放锁。那么一定会唤醒一个协程并成功加锁。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=mutex-的模式>Mutex 的模式<a href=#mutex-的模式 class=hash-link aria-label="Direct link to Mutex 的模式" title="Direct link to Mutex 的模式">​</a></h2>
<p>每个 Mutex 都有两种模式：<strong>Normal</strong>, <strong>Starving</strong>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=normal-模式>Normal 模式<a href=#normal-模式 class=hash-link aria-label="Direct link to Normal 模式" title="Direct link to Normal 模式">​</a></h4>
<p>默认情况下的模式就是 Normal。 在该模式下，协程如果加锁不成功，不会立即转入阻塞排队（先进先出），而是判断是否满足自旋条件，如果满足则会启动自旋过程，尝试抢锁。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=starving-模式>Starving 模式<a href=#starving-模式 class=hash-link aria-label="Direct link to Starving 模式" title="Direct link to Starving 模式">​</a></h4>
<p>自旋过程中能抢到锁，一定意味着同一时刻有协程释放了锁。我们知道释放锁时，如果发现有阻塞等待的协程，那么还会释放一个信号量来唤醒一个等待协程，被唤醒的协程得到 CPU 后开始运行，此时发现锁已经被抢占了，自己只好再次阻塞，不过阻塞前会判断，自上次阻塞到本次阻塞经过了多长时间，如果超过 1ms，则会将 Mutex 标记为 <code>Starving</code>模式，然后阻塞。</p>
<p>在<code>Starving</code>模式下，不会启动自旋过程，一旦有协程释放了锁，一定会唤醒协程，被唤醒的协程将成功获取锁，同时会把等待计数减 1。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=woken-状态>Woken 状态<a href=#woken-状态 class=hash-link aria-label="Direct link to Woken 状态" title="Direct link to Woken 状态">​</a></h2>
<p>Woken 状态用于加锁和解锁过程中的通信。比如，同一时刻，两个协程一个在加锁，一个在解锁，在加锁的协程可能在自旋过程中，此时把 Woken 标记为 1，用于通知解锁协程不必释放信号量，类似知会一下对方，不用释放了，我马上就拿到锁了。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=参考资料>参考资料<a href=#参考资料 class=hash-link aria-label="Direct link to 参考资料" title="Direct link to 参考资料">​</a></h2>
<ul>
<li>
<p><a href=https://juejin.cn/post/7086756462059323429 target=_blank rel="noopener noreferrer">https://juejin.cn/post/7086756462059323429</a></p>
</li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/programming/goroutine-scheduler><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Goroutine调度器</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/programming/golang-knowledge-review><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Golang知识点回顾梳理</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#lock class="table-of-contents__link toc-highlight">Lock</a><li><a href=#unlock class="table-of-contents__link toc-highlight">Unlock</a><li><a href=#自旋 class="table-of-contents__link toc-highlight">自旋</a><li><a href=#mutex-的模式 class="table-of-contents__link toc-highlight">Mutex 的模式</a><li><a href=#woken-状态 class="table-of-contents__link toc-highlight">Woken 状态</a><li><a href=#参考资料 class="table-of-contents__link toc-highlight">参考资料</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>