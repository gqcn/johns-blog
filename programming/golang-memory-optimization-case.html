<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/开发语言/Golang/一个Golang程序内存占用问题排查优化（复盘）" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>一个Golang程序内存占用问题排查优化（复盘） | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/programming/golang-memory-optimization-case><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="一个Golang程序内存占用问题排查优化（复盘） | John's Blog"><meta data-rh=true name=description content="详细记录一个 Go 语言程序的内存占用问题排查和优化过程，包括使用 PProf 进行分析、问题定位和解决方案"><meta data-rh=true property=og:description content="详细记录一个 Go 语言程序的内存占用问题排查和优化过程，包括使用 PProf 进行分析、问题定位和解决方案"><meta data-rh=true name=keywords content=内存优化,PProf,性能分析,内存泄漏,OOM,性能优化><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/programming/golang-memory-optimization-case><link data-rh=true rel=alternate href=https://johng.cn/programming/golang-memory-optimization-case hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/programming/golang-memory-optimization-case hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><script src=https://cdn.wwads.cn/js/makemoney.js async></script><link rel=stylesheet href=/assets/css/styles.96de5670.css><script src=/assets/js/runtime~main.f5382d00.js defer></script><script src=/assets/js/main.f0adb7a8.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/cloud-native>云原生</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/ai>AI技术</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/observability>可观测性</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/programming>开发语言</a><button aria-label="Collapse sidebar category '开发语言'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/programming/golang>Golang</a><button aria-label="Collapse sidebar category 'Golang'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/goroutine-scheduler>Goroutine调度器</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/golang-mutex-principle>Golang Mutex 原理解析</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/golang-knowledge-review>Golang知识点回顾梳理</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/golang-development-tips>Golang开发中的一些技巧</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/goland-json-tag-camelcase>Goland设置json标签自动生成格式为驼峰</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/go-test-disable-cache>go test 禁用缓存</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/golang-regex-rules>Golang正则规则</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/golang-kubernetes-resource-control>Golang程序在Kubernetes下的资源控制</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/golang-sigsegv-error>unexpected fault address 0x0 fatal error: fault signal SIGSEGV: segmentation violation</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/godebug-gc-trace>GODEBUG配置GC跟踪介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/programming/golang-memory-optimization-case>一个Golang程序内存占用问题排查优化（复盘）</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/programming/goland-remote-debug>使用goland remote debug远程调试</a></ul></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/cloud-native>云原生</a><button aria-label="Expand sidebar category '云原生'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ai>AI技术</a><button aria-label="Expand sidebar category 'AI技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/programming><span itemprop=name>开发语言</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/programming/golang><span itemprop=name>Golang</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>一个Golang程序内存占用问题排查优化（复盘）</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=背景介绍>背景介绍<a href=#背景介绍 class=hash-link aria-label="Direct link to 背景介绍" title="Direct link to 背景介绍">​</a></h2>
<p>笔者编写的一个监控采集上报程序部署遇到了频繁<code>OOM</code>的问题，之前一直在赶业务需求，虽然知道这块存在一些优化空间，记录了需求单跟进但是一直没有时间去完善。终于在交付给客户后由于其他问题的诱发导致了<code>OOM</code>即便增加资源也不可恢复，因此将此问题提高了优先级来处理。</p>
<p>首先介绍下这个监控采集程序，它实现了秒级监控的能力，但基础监控指标复用于其他开源组件或者服务，比如：</p>
<ul>
<li><strong>容器监控数据</strong>来源于<code>kubelet</code>中内置的<code>cadvisor</code>数据，通过<code>https</code>请求<code>kubelet</code>而来。</li>
<li><strong><code>kubelet</code>自身的监控数据</strong>同样来源于<code>kubelet</code>，通过<code>https</code>请求<code>kubelet</code>而来。</li>
<li><strong>集群状态数据</strong>来源于独立部署的开源组件<code>kube-state-metrics</code>而来，通过<code>http</code>请求<code>kube-state-metrics</code>服务地址而来。</li>
</ul>
<p>这<code>3</code>项数据均涉及到<code>HTTP</code>远程访问，并且这些基础指标拿到后根据不同的业务会有独立的<code>plugin</code>接口注册，用于实现各自独立的数据面监控指标。由于涉及到数据面监控指标，因此这些基础监控数据非常重要，容不得丢失。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=排查优化>排查优化<a href=#排查优化 class=hash-link aria-label="Direct link to 排查优化" title="Direct link to 排查优化">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=开启pprof>开启PProf<a href=#开启pprof class=hash-link aria-label="Direct link to 开启PProf" title="Direct link to 开启PProf">​</a></h3>
<p>首先我们的程序需要开启<code>PProf</code>，以便拿到程序的分析指标。具体可以参考：<a href=https://goframe.org/docs/web/senior-pprof target=_blank rel="noopener noreferrer">PProf服务性能分析</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=拿到pprof数据>拿到PProf数据<a href=#拿到pprof数据 class=hash-link aria-label="Direct link to 拿到PProf数据" title="Direct link to 拿到PProf数据">​</a></h3>
<p>具体细节不赘述，具体的命令差不多是这样：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>## 拷贝带有pprof功能的新二进制到指定容器</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl </span><span class="token function" style=color:#e6db74>cp</span><span class="token plain"> /root/khaos-metrics-agent khaos/khaos-guardian-sjsm4:/root/khaos-metrics-agent </span><span class="token parameter variable" style=color:#f8f8f2>-c</span><span class="token plain"> app</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>## 进入指定容器执行bash，便于独立采集pprof数据</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">k </span><span class="token builtin class-name" style=color:#e6db74>exec</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> khaos khaos-guardian-sjsm4 </span><span class="token parameter variable" style=color:#f8f8f2>-c</span><span class="token plain"> app </span><span class="token function" style=color:#e6db74>bash</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-it</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token builtin class-name" style=color:#e6db74>cd</span><span class="token plain"> ~ </span><span class="token operator" style=color:#66d9ef>&&</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>chmod</span><span class="token plain"> +x khaos-metrics-agent</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>## 运行一个独立的khaos-metrics-agent</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>nohup</span><span class="token plain"> ./khaos-metrics-agent </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>--debug</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">false </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>--address</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">:13142 </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>--nodeIP</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>10.186</span><span class="token plain">.19.165 </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>--rootPath</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">/ </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>--agentConfigFilePath</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">/var/run/khaos-guardian/metricsconfig/config.yaml </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>--kubeStateUrl</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">http://127.0.0.1:13043/metrics </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token parameter variable" style=color:#f8f8f2>--enabledPlugins</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">.+ </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>## 采集pprof相关信息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>curl</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>127.0</span><span class="token plain">.0.1:13045/debug/pprof/heap </span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"> pprof.heap</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>curl</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>127.0</span><span class="token plain">.0.1:13045/debug/pprof/goroutine </span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"> pprof.goroutine</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>curl</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>127.0</span><span class="token plain">.0.1:13045/debug/pprof/profile </span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"> pprof.profile</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>## 将pprof信息从容器中拷贝到客户端，便于本地进一步分析</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl </span><span class="token function" style=color:#e6db74>cp</span><span class="token plain"> khaos/khaos-guardian-sjsm4:/root/pprof.heap /root/pprof.heap  </span><span class="token parameter variable" style=color:#f8f8f2>-c</span><span class="token plain"> app</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl </span><span class="token function" style=color:#e6db74>cp</span><span class="token plain"> khaos/khaos-guardian-sjsm4:/root/pprof.goroutine /root/pprof.goroutine  </span><span class="token parameter variable" style=color:#f8f8f2>-c</span><span class="token plain"> app</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl </span><span class="token function" style=color:#e6db74>cp</span><span class="token plain"> khaos/khaos-guardian-sjsm4:/root/pprof.profile /root/pprof.profile  </span><span class="token parameter variable" style=color:#f8f8f2>-c</span><span class="token plain"> app</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=执行pprof分析>执行PProf分析<a href=#执行pprof分析 class=hash-link aria-label="Direct link to 执行PProf分析" title="Direct link to 执行PProf分析">​</a></h3>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=sample1>sample1<a href=#sample1 class=hash-link aria-label="Direct link to sample1" title="Direct link to sample1">​</a></h3>
<p>文件：<a href=/assets/files/pprof-e3f415bb2a0589ee1962112fc49f3a6b.heap target=_blank>pprof.heap</a></p>
<p>由于我们需要排查的是内存占用问题，所以主要是分析<code>pprof.heap</code>这个文件即可，其他两个文件（<code>pprof.profile</code>用以分析<code>cpu</code>耗时、<code>pprof.goroutine</code>用以分析<code>goroutine</code>占用判断有误<code>goroutine</code>阻塞）主要用来辅助排查。通过以下命令使用<code>go tool</code>打开<code>pprof</code>内存分析：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ go tool pprof </span><span class="token parameter variable" style=color:#f8f8f2>-http</span><span class="token plain"> :8080 pprof.heap</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Serving web UI on http://localhost:8080</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-5-11_16-0-58-3d641b3b945d77ba7b1573d2d9a86e1a.png width=3450 height=1416 class=img_ev3q></p>
<p>点开火炬图发现内存占用居然会处在框架的缓存组件方法<code>GetOrSetFuncLock</code>上，说明程序不断地去调用缓存方法来读取和缓存数据，很有可能就是缓存失效了，或者缓存没有起作用，导致频繁地更新缓存。通过查看程序，发现这里的代码写得垃圾得一批，缓存根本没起作用，缓存键名加了一个时间戳是什么鬼？<strong>脑子抽了？😰</strong></p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-5-11_16-19-22-988d6f67d5e4cf05b3ab6c6d7c74b8ff.png width=1986 height=860 class=img_ev3q></p>
<p>为了方便缓存，这里调整一下<code>Gatherer</code>的接口实现，增加<code>Name</code>接口实现，并封装了新的方法来聚合这块缓存逻辑：</p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-5-11_17-15-7-3a26cbf428a0997dd9becdd17edabeac.png width=1932 height=1286 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=sample2>sample2<a href=#sample2 class=hash-link aria-label="Direct link to sample2" title="Direct link to sample2">​</a></h3>
<p>文件：<a href=/assets/files/pprof-e3f415bb2a0589ee1962112fc49f3a6b.heap target=_blank>pprof.heap</a></p>
<p>修复该问题后重新执行<code>pprof</code>分析。这次发现问题出在了<code>io.ReadAll</code>上。由于业务插件在采集业务程序的指标时是通过<code>HTTP GET</code>拉取，里面使用了<code>ReadAll</code>方法来完成读取业务程序的指标数据，并返回给上层转换为<code>Prometheus</code>数据结构，处理后再<code>push</code>给远端存储。</p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-5-11_16-25-42-6db90dc1087c0661f33aef7934507f0a.png width=3454 height=1048 class=img_ev3q></p>
<p>涉及到的代码如下。但是由于业务实例的<strong>指标数据过大（几MB到100+MB不等）</strong>，这里完整读取的话会申请一块新的临时内存，造成过大的内存压力，所以这里的内存问题比较容易凸显。</p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-5-11_16-29-31-75baec27dc10a428e460a9ccfebd0945.png width=2514 height=1412 class=img_ev3q></p>
<p>::: tip
这种问题其实属于常见问题，对于所有的<code>HTTP</code>访问操作都容易出现。大多数<code>HTTP</code>访问的场景下，程序员的思维逻辑都是直接完整读取后再交给上层处理，但是这样会额外占用一块无意义的临时内存。
:::</p>
<p>因此去掉临时内存申请，改为直接<code>res.Body</code>流式读取。同时程序中其他<code>HTTP</code>请求也做类似的改进。</p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-5-11_16-35-7-051f6dac1f1dc67750fb3be08ee7835d.png width=2512 height=1182 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=sample3>sample3<a href=#sample3 class=hash-link aria-label="Direct link to sample3" title="Direct link to sample3">​</a></h3>
<p>文件：<a href=/assets/files/pprof-e3f415bb2a0589ee1962112fc49f3a6b.heap target=_blank>pprof.heap</a></p>
<p>修复后继续<code>pprof</code>分析，发现现在内存占用主要是在执行<code>RemoteWrite</code>远端写入时的第三方包数据结构转换组件调用上。</p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-5-11_16-37-22-e59fc675bf5769a3f19f8a3f520c49ba.png width=3454 height=1042 class=img_ev3q></p>
<p>这个<code>fmtutil</code>包是属于<code>prometheus</code>官方社区的组件包，用于执行指标数据的各种数据结构转换。我们看看这个<code>fmtutil.makeLabels</code>做了什么事情。</p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-5-11_16-40-53-77059e9d2ce4074cfd12d038ca5b1d39.png width=2292 height=992 class=img_ev3q></p>
<p>可以看到内存分配主要是这里的<code>labels</code>数组创建。这里的<code>prompb.Label</code>数据结构很奇怪，它这里使用了<strong>值传参</strong>形式，也就是说，指标标签的键值对都会复制一遍到这个<code>labels</code>中。而我们知道，指标数据容量主要是标签键值对的大小容量占用，那么这里就会不断申请很多内存用于拷贝标签键值对数据。</p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-5-11_16-43-57-140fa0a4da3d0ead4512ee5fb40d5808.png width=2758 height=418 class=img_ev3q></p>
<p>我们这里来梳理一下业务实例的监控指标的数据结构转换流程：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">Metric Text -> dto.MetricFamily -> prompb.WriteRequest</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>其中：</p>
<ul>
<li><code>Metric Text</code>：从业务实例采集到的<code>Prometheus</code>监控数据，文本类型，从<code>Response.Body</code>中流式读取。</li>
<li><code>dto.MetricFamily</code>：从<code>Prometheus</code>监控数据文本转换为的监控数据结构，用于方便采集程序内部处理，如指标过滤、注入等操作。</li>
<li><code>prompb.WriteRequest</code>：当监控数据处理好后，需要通过<code>Prometheus RemoteWrite</code>协议写入到远端存储，需要进行协议转换为该格式。</li>
</ul>
<p>那么既然这里有两次协议转换，为什么<code>Metric Text</code>到<code>dto.MetricFamily</code>没有出现内存占用问题呢？我们来看看它的数据结构：</p>
<p><img decoding=async loading=lazy src=/assets/images/image-2024-5-11_16-45-59-22fd50e11a0eeee6c7b7da10f0de7149.png width=2404 height=446 class=img_ev3q></p>
<p>可以看到，在转换为<code>dto.MetricFamily</code>的时候，内存容量占比较大的部分使用的是指针，其实并没有涉及到额外的内存申请。因此对转换<code>prompb.WriteRequest</code>数据结构的优化可以参考该思路。通过查看<code>Prometheus</code>的源码，发现其实这里不太好改，因为这是个公开的数据结构，并且引用的地方还蛮多，直接修改会有兼容问题。回顾自身的监控采集程序，已经没有更多的优化空间。而针对社区组件的改动，也许未来再详细考虑吧。</p>
<p><img decoding=async loading=lazy src=/assets/images/tapd_69993163_base64_1715248124_728-fc253c9dfee65eede595a247b6dc3b5a.png width=3448 height=1998 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=其他一些点>其他一些点<a href=#其他一些点 class=hash-link aria-label="Direct link to 其他一些点" title="Direct link to 其他一些点">​</a></h3>
<p>除了程序方面的优化，其实在部署上也有一些改进，具体请参考：</p>
<ul>
<li><a href=/programming/golang-kubernetes-resource-control>Golang程序在Kubernetes下的资源控制</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=回顾总结>回顾总结<a href=#回顾总结 class=hash-link aria-label="Direct link to 回顾总结" title="Direct link to 回顾总结">​</a></h2>
<ul>
<li>
<p>开发人员应当对自身产出的物料负责。项目周期通常都非常繁忙（且忙中易出错），不可能单独预留改进优化的时间。在评估每个开发迭代的任务时，应当积极介入工作安排，不要被动接受输入。将遗留的可能风险及时和上级Leader沟通，给Leader更多的输入以便综合权衡评估工作安排来改进。不要等待问题影响业务/客户时再回过头来改进，那样的成本太大了。</p>
</li>
<li>
<p>Golang的工具链很丰富，特别是PProf的存在确实帮助开发人员快速排查、优化程序提供了高效的辅助。</p>
</li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/programming/godebug-gc-trace><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>GODEBUG配置GC跟踪介绍</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/programming/goland-remote-debug><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>使用goland remote debug远程调试</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#背景介绍 class="table-of-contents__link toc-highlight">背景介绍</a><li><a href=#排查优化 class="table-of-contents__link toc-highlight">排查优化</a><ul><li><a href=#开启pprof class="table-of-contents__link toc-highlight">开启PProf</a><li><a href=#拿到pprof数据 class="table-of-contents__link toc-highlight">拿到PProf数据</a><li><a href=#执行pprof分析 class="table-of-contents__link toc-highlight">执行PProf分析</a><li><a href=#sample1 class="table-of-contents__link toc-highlight">sample1</a><li><a href=#sample2 class="table-of-contents__link toc-highlight">sample2</a><li><a href=#sample3 class="table-of-contents__link toc-highlight">sample3</a><li><a href=#其他一些点 class="table-of-contents__link toc-highlight">其他一些点</a></ul><li><a href=#回顾总结 class="table-of-contents__link toc-highlight">回顾总结</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>