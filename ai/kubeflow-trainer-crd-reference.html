<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/AI技术/AI基础架构/HPC/Kubeflow Trainer/Kubeflow Trainer CRD配置格式详解" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Kubeflow Trainer CRD配置格式详解 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/ai/kubeflow-trainer-crd-reference><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=author content="John Guo"><meta data-rh=true property=og:image content=https://johng.cn/img/favicon.png><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Kubeflow Trainer CRD配置格式详解 | John's Blog"><meta data-rh=true name=description content="详细介绍Kubeflow Trainer的三个核心CRD（TrainJob、TrainingRuntime、ClusterTrainingRuntime）的完整配置格式，包括每个配置项的注释说明、复杂配置项的表格解释、特殊标签和注解的使用，以及最佳实践指南"><meta data-rh=true property=og:description content="详细介绍Kubeflow Trainer的三个核心CRD（TrainJob、TrainingRuntime、ClusterTrainingRuntime）的完整配置格式，包括每个配置项的注释说明、复杂配置项的表格解释、特殊标签和注解的使用，以及最佳实践指南"><meta data-rh=true name=keywords content="Kubeflow Trainer,TrainJob,TrainingRuntime,ClusterTrainingRuntime,CRD,Custom Resource Definition,分布式训练,PyTorch,DeepSpeed,MPI,YAML配置,Kubernetes,训练任务,运行时模板,Gang Scheduling,数据集初始化,模型初始化,Pod模板覆盖,弹性训练,HPC"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/ai/kubeflow-trainer-crd-reference><link data-rh=true rel=alternate href=https://johng.cn/ai/kubeflow-trainer-crd-reference hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/ai/kubeflow-trainer-crd-reference hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="John's Blog RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="John's Blog Atom Feed"><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><link rel=stylesheet href=/assets/css/styles.2f56d3c4.css><script src=/assets/js/runtime~main.8de97497.js defer></script><script src=/assets/js/main.d3977856.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/ai>AI技术</a><a class="navbar__item navbar__link" href=/cloud-native>云原生</a><a class="navbar__item navbar__link" href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/programming>开发语言</a><a class="navbar__item navbar__link" href=/architecture>技术架构</a><a class="navbar__item navbar__link" href=/observability>可观测性</a><a class="navbar__item navbar__link" href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" href=/life>生活笔记</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href=/aboutme>关于我</a><a class="navbar__item navbar__link" href=/blog>博客</a><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/ai>AI技术</a><button aria-label="Collapse sidebar category 'AI技术'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/app>AI应用技术</a><button aria-label="Expand sidebar category 'AI应用技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/ai/infra>AI基础架构</a><button aria-label="Collapse sidebar category 'AI基础架构'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/ai/hpc>HPC</a><button aria-label="Collapse sidebar category 'HPC'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/ai/kubeflow-trainer>Kubeflow Trainer</a><button aria-label="Collapse sidebar category 'Kubeflow Trainer'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class=menu__link tabindex=0 href=/ai/kubeflow-trainer-in-hpc>Kubeflow Trainer In HPC</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class=menu__link tabindex=0 href=/ai/kubeflow-trainer-pytorch-parallel-computing>Kubeflow Trainer PyTorch并行计算</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/ai/kubeflow-trainer-crd-reference>Kubeflow Trainer CRD配置格式详解</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class=menu__link tabindex=0 href=/ai/kubeflow-trainer-deploy-usage>Kubeflow Trainer 安装、部署及使用</a></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/hpc-development-training-platform>开发训练平台概述</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/ml-platform-opensource-projects>模型开发训练开源项目对比分析</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/volcano-hpc-ecosystem>云原生HPC生态组件对比分析（基于Volcano）</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/vgpu>vGPU</a><button aria-label="Expand sidebar category 'vGPU'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/rdma>RDMA</a><button aria-label="Expand sidebar category 'RDMA'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/nvidia>NVIDIA</a><button aria-label="Expand sidebar category 'NVIDIA'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/distributed-inference>分布式推理</a><button aria-label="Expand sidebar category '分布式推理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/scheduling>算力资源调度</a><button aria-label="Expand sidebar category '算力资源调度'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/what-is-llmops-mlops>LLMOps介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/common-acceleration-cards>常见智算加速卡汇总</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/common-ai-model-training-inference-framework>常见AI模型训练推理框架对比</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/ai-training-inference-scenarios>AI模型训练推理常见业务场景痛点</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/basic>AI入门知识</a><button aria-label="Expand sidebar category 'AI入门知识'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/cloud-native>云原生</a><button aria-label="Expand sidebar category '云原生'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/life>生活笔记</a><button aria-label="Expand sidebar category '生活笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai><span itemprop=name>AI技术</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai/infra><span itemprop=name>AI基础架构</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai/hpc><span itemprop=name>HPC</span></a><meta itemprop=position content=3><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai/kubeflow-trainer><span itemprop=name>Kubeflow Trainer</span></a><meta itemprop=position content=4><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Kubeflow Trainer CRD配置格式详解</span><meta itemprop=position content=5></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=概述>概述<a href=#概述 class=hash-link aria-label="Direct link to 概述" title="Direct link to 概述">​</a></h2>
<p><code>Kubeflow Trainer</code>提供了三个核心的<code>CRD（Custom Resource Definition）</code>来支持分布式训练任务的定义和执行：</p>
<table><thead><tr><th>CRD名称<th>作用域<th>主要作用<tbody><tr><td><code>TrainJob</code><td>命名空间<td>定义具体的训练任务，包括训练的配置参数、资源需求、数据集和模型初始化等<tr><td><code>TrainingRuntime</code><td>命名空间<td>命名空间级别的训练运行时模板，定义了特定框架（如 <code>PyTorch</code>、<code>DeepSpeed</code>）的执行环境，只能被同一命名空间的<code>TrainJob</code>引用<tr><td><code>ClusterTrainingRuntime</code><td>集群<td>集群级别的训练运行时模板，可以被任何命名空间的 <code>TrainJob</code>引用，适用于跨团队共享的标准运行时配置</table>
<p>本文将详细介绍这三个<code>CRD</code>的完整配置格式，并对每个配置项进行说明。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=trainjob>TrainJob<a href=#trainjob class=hash-link aria-label="Direct link to TrainJob" title="Direct link to TrainJob">​</a></h2>
<p><code>TrainJob</code>是用户创建分布式训练任务的核心<code>CRD</code>，它定义了训练任务的所有配置参数。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=完整模板示例>完整模板示例<a href=#完整模板示例 class=hash-link aria-label="Direct link to 完整模板示例" title="Direct link to 完整模板示例">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> TrainJob</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># TrainJob 的名称，必须符合 RFC 1035 DNS 标签格式（小写字母、数字、连字符，最多63个字符）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">distributed</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">training</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># TrainJob 所在的命名空间</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> kubeflow</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 可选的标签</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> training</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">framework</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 可选的注解</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">description</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"PyTorch distributed training example"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 引用的训练运行时配置（必填）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">runtimeRef</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 运行时的名称（必填，最小长度为1）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">distributed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 运行时的 API 组，默认为 trainer.kubeflow.org</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">apiGroup</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 运行时的类型，可选值：TrainingRuntime 或 ClusterTrainingRuntime</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认为 ClusterTrainingRuntime</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ClusterTrainingRuntime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 初始化器配置，用于数据集和模型的初始化（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">initializer</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 数据集初始化配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">dataset</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 数据集存储的 URI，支持各种存储协议（如 s3://、gs://、pvc:// 等）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">storageUri</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> s3</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">//my</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">bucket/datasets/fashion</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mnist</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 环境变量列表，用于数据集初始化容器</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> AWS_REGION</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> us</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">west</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> DATASET_FORMAT</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># Secret 引用，包含访问数据集的凭证</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># Secret 必须在 TrainJob 所在的命名空间中创建</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">secretRef</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> s3</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">credentials</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 预训练模型初始化配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">model</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 预训练模型存储的 URI</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">storageUri</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> s3</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">//my</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">bucket/models/pretrained</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">resnet</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 环境变量列表，用于模型初始化容器</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> MODEL_FORMAT</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> MODEL_VERSION</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1.0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># Secret 引用，包含访问模型的凭证</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">secretRef</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> s3</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">credentials</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 训练器配置（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">trainer</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 训练容器的镜像</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch/pytorch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">2.7.1</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cuda12.8</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cudnn9</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">runtime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 容器的启动命令</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> python</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> /workspace/train.py</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 容器的参数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">args</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">epochs=10</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">batch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">size=64</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">learning</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">rate=0.001</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 环境变量列表</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NCCL_DEBUG</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> INFO</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> PYTORCH_CUDA_ALLOC_CONF</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> max_split_size_mb</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token number" style=color:#ae81ff>512</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 训练节点数量</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">numNodes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>4</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 每个节点的资源配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">resourcesPerNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"4"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 16Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 32Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 每个节点的进程/worker 数量</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 对于 PyTorch：可以设置为 auto、cpu、gpu 或整数值</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 对于 MPI：只能设置为整数值</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">numProcPerNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> auto</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 应用到衍生 JobSet 和 Jobs 的标签（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 这些标签会与 TrainingRuntime 中的标签合并</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 注意：当存在相同键时，TrainJob 中的标签值会覆盖 TrainingRuntime 中的标签值</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">team</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ml</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">team</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">project</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> image</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">classification</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 应用到衍生 JobSet 和 Jobs 的注解（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 这些注解会与 TrainingRuntime 中的注解合并</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 注意：当存在相同键时，TrainJob 中的注解值会覆盖 TrainingRuntime 中的注解值</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">owner</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> john@example.com</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">cost-center</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1234"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># Pod 模板覆盖配置，用于自定义特定 Job 的 Pod 配置（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">podTemplateOverrides</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 可以配置多个覆盖规则，后面的规则会覆盖前面的字段值</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">targetJobs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 目标 Job 名称列表</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># Pod 元数据覆盖</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">custom-label</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> custom</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">value</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">custom-annotation</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> custom</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">value</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># Pod Spec 覆盖</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 服务账号名称</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">serviceAccountName</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> training</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">sa</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 节点选择器</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">nodeSelector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">node-type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> gpu</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">gpu-type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">a100</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 亲和性配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">affinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">nodeAffinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> gpu</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">type</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> nvidia</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">a100</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> nvidia</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">v100</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">podAntiAffinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">weight</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">podAffinityTerm</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">labelSelector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> app</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> training</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">topologyKey</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> kubernetes.io/hostname</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 容忍度配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">tolerations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia.com/gpu</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Exists</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">effect</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NoSchedule</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> training</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">workload</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Equal</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">effect</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NoSchedule</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 卷配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">volumes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> workspace</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">claimName</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> training</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">workspace</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pvc</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> shared</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">memory</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">emptyDir</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">medium</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Memory</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">sizeLimit</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 8Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 初始化容器覆盖</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">initContainers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> setup</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> SETUP_MODE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> distributed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> workspace</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /workspace</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 容器覆盖</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> CUSTOM_ENV</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> custom</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">value</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> workspace</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /workspace</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> shared</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">memory</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /dev/shm</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 调度门控（用于 Pod 调度就绪性控制）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">schedulingGates</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> custom</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">gate</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 镜像拉取 Secret</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">imagePullSecrets</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> docker</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">registry</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">secret</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 是否暂停运行中的 TrainJob（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认为 false</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">suspend</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>false</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 管理者标识，指示由哪个控制器或实体管理此 TrainJob（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 可选值：</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># - trainer.kubeflow.org/trainjob-controller（默认，由内置控制器管理）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># - kueue.x-k8s.io/multikueue（委托给 Kueue 管理）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 此字段不可变</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">managedBy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org/trainjob</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">controller</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=重要字段说明>重要字段说明<a href=#重要字段说明 class=hash-link aria-label="Direct link to 重要字段说明" title="Direct link to 重要字段说明">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=runtimeref>runtimeRef<a href=#runtimeref class=hash-link aria-label="Direct link to runtimeRef" title="Direct link to runtimeRef">​</a></h4>
<p><code>runtimeRef</code> 是必填字段，用于引用训练运行时配置：</p>
<table><thead><tr><th>字段<th>类型<th>必填<th>默认值<th>说明<tbody><tr><td><code>name</code><td><code>string</code><td>是<td>-<td>运行时名称，最小长度为<code>1</code><tr><td><code>apiGroup</code><td><code>string</code><td>否<td><code>trainer.kubeflow.org</code><td>运行时的<code>API</code>组<tr><td><code>kind</code><td><code>string</code><td>否<td><code>ClusterTrainingRuntime</code><td>运行时类型，可选 <code>TrainingRuntime</code> 或 <code>ClusterTrainingRuntime</code></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=numprocpernode>numProcPerNode<a href=#numprocpernode class=hash-link aria-label="Direct link to numProcPerNode" title="Direct link to numProcPerNode">​</a></h4>
<p>每个节点的进程/<code>worker</code>数量配置：</p>
<table><thead><tr><th>框架<th>支持的值<th>说明<tbody><tr><td><code>PyTorch</code><td><code>auto</code>、<code>cpu</code>、<code>gpu</code>、整数<td><code>auto</code>表示自动检测，<code>cpu</code>/<code>gpu</code>表示使用所有 <code>CPU</code>/<code>GPU</code>，整数表示具体进程数<tr><td><code>MPI</code><td>整数<td>只能设置具体的整数值<tr><td><code>DeepSpeed</code><td>整数<td>只能设置具体的整数值</table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=managedby>managedBy<a href=#managedby class=hash-link aria-label="Direct link to managedBy" title="Direct link to managedBy">​</a></h4>
<p>控制<code>TrainJob</code>的管理者：</p>
<table><thead><tr><th>值<th>说明<tbody><tr><td><code>trainer.kubeflow.org/trainjob-controller</code><td>由内置的 <code>TrainJob</code> 控制器管理（默认）<tr><td><code>kueue.x-k8s.io/multikueue</code><td>委托给 Kueue 进行管理，支持多集群调度</table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=initializer初始化器>initializer（初始化器）<a href=#initializer初始化器 class=hash-link aria-label="Direct link to initializer（初始化器）" title="Direct link to initializer（初始化器）">​</a></h4>
<p>初始化器用于在训练开始前自动完成数据集和预训练模型的准备工作，极大简化了训练任务的配置和管理。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=dataset数据集初始化器>dataset（数据集初始化器）<a href=#dataset数据集初始化器 class=hash-link aria-label="Direct link to dataset（数据集初始化器）" title="Direct link to dataset（数据集初始化器）">​</a></h5>
<p>数据集初始化器的作用：</p>
<ul>
<li><strong>自动下载数据集</strong>：从各种存储源（<code>S3</code>、<code>GCS</code>、<code>Hugging Face</code>、<code>PVC</code> 等）自动下载训练所需的数据集</li>
<li><strong>数据预处理</strong>：可以在初始化阶段对数据进行预处理和格式转换</li>
<li><strong>数据持久化</strong>：将下载的数据集存储到共享卷中，供所有训练节点访问</li>
<li><strong>凭证管理</strong>：通过<code>secretRef</code>安全地管理访问私有数据集所需的凭证</li>
</ul>
<p>配置示例：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">initializer</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">dataset</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 数据集 URI，支持多种协议：</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># - s3://bucket/path（AWS S3）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># - gs://bucket/path（Google Cloud Storage）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># - hf://dataset-name（Hugging Face）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># - pvc://pvc-name/path（Kubernetes PVC）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">storageUri</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> s3</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">//my</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">bucket/datasets/imagenet</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> AWS_REGION</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> us</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">west</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">secretRef</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> s3</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">credentials  </span><span class="token comment" style=color:#8292a2;font-style:italic># 包含 AWS_ACCESS_KEY_ID 和 AWS_SECRET_ACCESS_KEY</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>数据集初始化完成后，数据会被挂载到训练容器的<code>/workspace/dataset</code>路径。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=model模型初始化器>model（模型初始化器）<a href=#model模型初始化器 class=hash-link aria-label="Direct link to model（模型初始化器）" title="Direct link to model（模型初始化器）">​</a></h5>
<p>模型初始化器的作用：</p>
<ul>
<li><strong>自动下载预训练模型</strong>：从模型仓库下载预训练模型权重</li>
<li><strong>模型格式转换</strong>：支持不同框架间的模型格式转换</li>
<li><strong>模型持久化</strong>：将模型文件存储到共享卷中</li>
<li><strong>版本管理</strong>：可以通过环境变量指定具体的模型版本</li>
</ul>
<p>配置示例：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">initializer</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">model</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 预训练模型 URI</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">storageUri</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> hf</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">//meta</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">llama/Llama</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">2</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">7b</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">hf</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> MODEL_VERSION</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1.0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> HUGGING_FACE_TOKEN</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> hf</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">token</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> token</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">secretRef</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> hf</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">credentials</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>模型初始化完成后，模型文件会被挂载到训练容器的<code>/workspace/model</code>路径。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=初始化器的执行流程>初始化器的执行流程<a href=#初始化器的执行流程 class=hash-link aria-label="Direct link to 初始化器的执行流程" title="Direct link to 初始化器的执行流程">​</a></h5>
<ol>
<li><code>dataset-initializer Job</code>首先启动，下载并准备数据集</li>
<li><code>model-initializer Job</code>随后启动，下载并准备预训练模型</li>
<li>两个初始化<code>Job</code>都成功完成后，<code>trainer Job</code>才会启动</li>
<li>训练容器可以直接访问<code>/workspace/dataset</code>和<code>/workspace/model</code>路径下的数据和模型</li>
</ol>
<p>这种机制确保了训练任务启动时所有必需的资源都已就绪，避免了训练过程中的资源加载失败。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=status-conditions>Status Conditions<a href=#status-conditions class=hash-link aria-label="Direct link to Status Conditions" title="Direct link to Status Conditions">​</a></h4>
<table><thead><tr><th>Type<th>Reason<th>说明<tbody><tr><td><code>Suspended</code><td><code>Suspended</code><td><code>TrainJob</code> 被暂停<tr><td><code>Suspended</code><td><code>Resumed</code><td><code>TrainJob</code> 从暂停状态恢复<tr><td><code>Failed</code><td><code>TrainingRuntimeNotSupported</code><td>引用的<code>TrainingRuntime</code>不受支持<tr><td><code>Complete</code><td><code>JobsCompleted</code><td><code>TrainJob</code> 成功完成</table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=trainingruntime>TrainingRuntime<a href=#trainingruntime class=hash-link aria-label="Direct link to TrainingRuntime" title="Direct link to TrainingRuntime">​</a></h2>
<p><code>TrainingRuntime</code>是命名空间级别的训练运行时模板，定义了特定<code>ML</code>框架的执行环境。它只能被同一命名空间中的<code>TrainJob</code>引用。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=完整模板示例-1>完整模板示例<a href=#完整模板示例-1 class=hash-link aria-label="Direct link to 完整模板示例" title="Direct link to 完整模板示例">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> TrainingRuntime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># TrainingRuntime 的名称</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">distributed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># TrainingRuntime 所在的命名空间</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> kubeflow</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 标签，通常标识框架类型</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">trainer.kubeflow.org/framework</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> production</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># ML 策略配置，提供ML特定的参数（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">mlPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 训练节点数量，默认为1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">numNodes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># PyTorch运行时配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">torch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 每个节点的进程数量</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 支持的值：auto（自动检测）、cpu（CPU数量）、gpu（GPU数量）或整数值</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认为 auto</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">numProcPerNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> auto</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># PyTorch 弹性训练策略（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 注意：如果配置了 elasticPolicy，则不能同时设置 mlPolicy.numNodes</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">elasticPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 训练任务可以重启的最大次数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 此值会插入到 torchrun 的 --max-restarts 参数中</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">maxRestarts</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>3</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 可以缩减到的最小节点数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">minNodes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 可以扩展到的最大节点数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">maxNodes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>4</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 用于计算期望节点数的指标</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 将创建 HPA 来执行自动缩放</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">metrics</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Resource</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">resource</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> cpu</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">target</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Utilization</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">averageUtilization</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>80</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># PodGroup 策略配置，用于启用 gang-scheduling（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">podGroupPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 使用 Kubernetes scheduler-plugins 的 coscheduling 插件</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">coscheduling</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># gang-scheduling 的最大调度超时时间（秒）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 如果为 0，则使用默认值</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认为 60 秒</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">scheduleTimeoutSeconds</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>120</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 或者使用 Volcano gang-scheduler</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 注意：coscheduling 和 volcano 只能配置其中一个</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># volcano:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>#   # 网络拓扑配置，与网络拓扑特性和 hyperNode CRD 配合使用</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>#   networkTopology:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>#     # 配置具体的网络拓扑策略</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>#     # 详见 Volcano 文档</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># JobSet 模板配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># JobSet 的元数据</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">runtime</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">version</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v2.7</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">annotations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">description</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> PyTorch distributed training runtime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># JobSet 的规范</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 复制的 Job 列表</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">replicatedJobs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 主要的训练节点 Job</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token comment" style=color:#8292a2;font-style:italic># 该 Job 的副本数量（节点数量）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token comment" style=color:#8292a2;font-style:italic># 注意：实际的副本数会被 mlPolicy.numNodes 或 TrainJob.trainer.numNodes 覆盖</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token comment" style=color:#8292a2;font-style:italic># Job 模板</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token comment" style=color:#8292a2;font-style:italic># 此标签标识这是训练器步骤</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">trainer.kubeflow.org/trainjob-ancestor-step</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token comment" style=color:#8292a2;font-style:italic># Job 完成模式</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token comment" style=color:#8292a2;font-style:italic># Indexed 表示每个 Pod 都有唯一的索引</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">completionMode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Indexed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token comment" style=color:#8292a2;font-style:italic># Job 的 Pod 模板</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token comment" style=color:#8292a2;font-style:italic># 添加 initContainers</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">initContainers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token comment" style=color:#8292a2;font-style:italic># 示例：环境准备</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> setup</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">env</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> busybox</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">latest</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> sh</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">c</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token scalar string" style=color:#a6e22e></span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>                          echo "Setting up environment..."</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>                          mkdir -p /workspace/logs</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>                          echo "Setup complete"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> workspace</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /workspace</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token comment" style=color:#8292a2;font-style:italic># 容器列表</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认镜像，会被 TrainJob.trainer.image 覆盖</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch/pytorch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">2.7.1</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cuda12.8</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cudnn9</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">runtime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认命令，会被 TrainJob.trainer.command 覆盖</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> torchrun</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认参数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">args</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nnodes=$(TRAINER_NNODES)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nproc_per_node=$(TRAINER_NPROC_PER_NODE)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">node_rank=$(JOB_COMPLETION_INDEX)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">rdzv_backend=c10d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">rdzv_endpoint=$(TRAINER_NODE_0_HOSTNAME)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token number" style=color:#ae81ff>29400</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">rdzv_id=$(TRAINER_JOB_ID)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> /workspace/train.py</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token comment" style=color:#8292a2;font-style:italic># 环境变量</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> LOGLEVEL</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> INFO</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NCCL_DEBUG</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> INFO</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token comment" style=color:#8292a2;font-style:italic># 资源配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 8Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"4"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 16Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token comment" style=color:#8292a2;font-style:italic># 卷挂载</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> workspace</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /workspace</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token comment" style=color:#8292a2;font-style:italic># 卷定义</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">volumes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> workspace</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">emptyDir</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token comment" style=color:#8292a2;font-style:italic># 重启策略</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> OnFailure</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 失败策略</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">failurePolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 允许的最大重启次数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">maxRestarts</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>3</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 成功策略</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">successPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 操作符，表示如何判断成功</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># All 表示所有目标 Job 都必须成功</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> All</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 目标 Job 列表</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">targetReplicatedJobs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 网络配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">network</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 是否发布未就绪的地址</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 对于分布式训练，通常设置为 true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">publishNotReadyAddresses</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 是否启用 DNS 主机名</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">enableDNSHostnames</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=重要字段说明-1>重要字段说明<a href=#重要字段说明-1 class=hash-link aria-label="Direct link to 重要字段说明" title="Direct link to 重要字段说明">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=mlpolicy>mlPolicy<a href=#mlpolicy class=hash-link aria-label="Direct link to mlPolicy" title="Direct link to mlPolicy">​</a></h4>
<p><code>ML</code>策略配置的互斥规则：</p>
<table><thead><tr><th>配置<th>互斥规则<th>说明<tbody><tr><td><code>numNodes</code><td>不能与 <code>torch.elasticPolicy</code> 同时使用<td>弹性训练使用 <code>minNodes</code>/<code>maxNodes</code> 代替固定节点数<tr><td><code>torch</code><td>不能与 <code>mpi</code> 同时使用<td>只能配置一种运行时策略<tr><td><code>mpi</code><td>不能与 <code>torch</code> 同时使用<td>只能配置一种运行时策略</table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=pytorch-弹性训练>PyTorch 弹性训练<a href=#pytorch-弹性训练 class=hash-link aria-label="Direct link to PyTorch 弹性训练" title="Direct link to PyTorch 弹性训练">​</a></h4>
<p>启用<code>PyTorch</code>弹性训练时的关键配置：</p>
<table><thead><tr><th>字段<th>说明<tbody><tr><td><code>maxRestarts</code><td>插入到 <code>torchrun</code> 的 <code>--max-restarts</code> 参数和<code>Job</code>的 <code>.spec.failurePolicy.maxRestarts</code><tr><td><code>minNodes</code><td>插入到 <code>torchrun</code> 的 <code>--nnodes</code> 参数的最小值<tr><td><code>maxNodes</code><td>插入到 <code>torchrun</code> 的 <code>--nnodes</code> 参数的最大值<tr><td><code>metrics</code><td>用于创建<code>HPA（Horizontal Pod Autoscaler）</code>进行自动缩放</table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=mpi-实现类型>MPI 实现类型<a href=#mpi-实现类型 class=hash-link aria-label="Direct link to MPI 实现类型" title="Direct link to MPI 实现类型">​</a></h4>
<p>支持的<code>MPI</code>实现：</p>
<table><thead><tr><th>类型<th>说明<tbody><tr><td><code>OpenMPI</code><td><code>Open MPI</code> 实现（默认）<tr><td><code>Intel</code><td><code>Intel MPI</code> 实现<tr><td><code>MPICH</code><td><code>MPICH</code> 实现</table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=特殊标签和注解>特殊标签和注解<a href=#特殊标签和注解 class=hash-link aria-label="Direct link to 特殊标签和注解" title="Direct link to 特殊标签和注解">​</a></h3>
<p><code>Kubeflow Trainer</code>使用一些特殊的标签和注解来控制训练任务的行为和标识资源关系。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=系统预留标签>系统预留标签<a href=#系统预留标签 class=hash-link aria-label="Direct link to 系统预留标签" title="Direct link to 系统预留标签">​</a></h4>
<table><thead><tr><th>标签键<th>可能的值<th>用途<th>应用位置<tbody><tr><td><code>trainer.kubeflow.org/trainjob-ancestor-step</code><td><code>dataset-initializer</code><br><code>model-initializer</code><br><code>trainer</code><td>标识<code>Pod</code>模板在训练流程中的角色，用于关联<code>TrainJob</code>的不同配置项与<code>Runtime</code>中的<code>Job</code>模板<td><code>TrainingRuntime/ClusterTrainingRuntime</code>的<code>replicatedJobs[].template.labels</code><tr><td><code>trainer.kubeflow.org/framework</code><td><code>torch</code><br><code>deepspeed</code><br><code>mpi</code><br><code>mlx</code><br><code>torchtune</code><td>标识 <code>Runtime</code> 支持的训练框架类型<td><code>TrainingRuntime/ClusterTrainingRuntime</code> 的 <code>metadata.labels</code><tr><td><code>trainer.kubeflow.org/support</code><td><code>deprecated</code><td>标识<code>Runtime</code>的支持状态，当值为 <code>deprecated</code> 时会在创建 <code>TrainJob</code>时发出警告<td><code>TrainingRuntime/ClusterTrainingRuntime</code> 的 <code>metadata.labels</code></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=标签使用说明>标签使用说明<a href=#标签使用说明 class=hash-link aria-label="Direct link to 标签使用说明" title="Direct link to 标签使用说明">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=trainerkubefloworgtrainjob-ancestor-step>trainer.kubeflow.org/trainjob-ancestor-step<a href=#trainerkubefloworgtrainjob-ancestor-step class=hash-link aria-label="Direct link to trainer.kubeflow.org/trainjob-ancestor-step" title="Direct link to trainer.kubeflow.org/trainjob-ancestor-step">​</a></h5>
<p>这是最重要的系统标签，用于建立<code>TrainJob</code>配置与<code>Runtime</code>中<code>Job</code>模板之间的映射关系：</p>
<ul>
<li><strong>dataset-initializer</strong>：带有此标签的<code>Job</code>模板会被<code>TrainJob.spec.initializer.dataset</code>配置覆盖</li>
<li><strong>model-initializer</strong>：带有此标签的<code>Job</code>模板会被<code>TrainJob.spec.initializer.model</code>配置覆盖</li>
<li><strong>trainer</strong>：带有此标签的<code>Job</code>模板会被<code>TrainJob.spec.trainer</code>配置覆盖</li>
</ul>
<p><strong>是否必须配置：</strong></p>
<p>该标签在<code>TrainingRuntime/ClusterTrainingRuntime</code>的<code>replicatedJobs</code>中<strong>不是强制要求</strong>的，但通常应该要配置，但具有以下重要作用：</p>
<ol>
<li>
<p><strong>不配置该标签</strong>：</p>
<ul>
<li>该<code>Job</code>模板将不会被<code>TrainJob</code>的任何配置项覆盖</li>
<li>适用于辅助性的<code>Job</code>（如日志收集、监控等），这些<code>Job</code>不需要<code>TrainJob</code>级别的定制</li>
<li><code>Job</code>将完全按照<code>Runtime</code>中定义的配置运行</li>
</ul>
</li>
<li>
<p><strong>配置 <code>trainer</code> 值</strong>：</p>
<ul>
<li><strong>强烈推荐</strong>为主训练节点配置此标签</li>
<li>允许用户通过<code>TrainJob.spec.trainer</code>定制训练镜像、命令、参数、资源等</li>
<li>提供了训练任务级别的灵活性，是<code>Kubeflow Trainer</code>的核心功能之一</li>
<li>不配置此标签意味着放弃了<code>TrainJob</code>级别的训练配置能力</li>
</ul>
</li>
<li>
<p><strong>配置初始化器标签</strong>：</p>
<ul>
<li>如果需要数据集/模型初始化功能，必须为对应的<code>Job</code>配置相应的标签</li>
<li>不配置则无法使用<code>TrainJob.spec.initializer</code>功能</li>
</ul>
</li>
</ol>
<p><strong>最佳实践示例：</strong></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 推荐的配置方式</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">replicatedJobs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 可选：数据集初始化 Job</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> dataset</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">trainer.kubeflow.org/trainjob-ancestor-step</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> dataset</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 可选：模型初始化 Job</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> model</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">trainer.kubeflow.org/trainjob-ancestor-step</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> model</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 强烈推荐：主训练节点必须配置此标签</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">trainer.kubeflow.org/trainjob-ancestor-step</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer  </span><span class="token comment" style=color:#8292a2;font-style:italic># 推荐配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 可选：辅助 Job 可以不配置此标签</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> monitoring</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> monitoring  </span><span class="token comment" style=color:#8292a2;font-style:italic># 不配置 trainjob-ancestor-step</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>示例：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 在 TrainingRuntime 中定义</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">replicatedJobs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> dataset</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token comment" style=color:#8292a2;font-style:italic># 此标签标识这是数据集初始化步骤</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">trainer.kubeflow.org/trainjob-ancestor-step</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> dataset</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token comment" style=color:#8292a2;font-style:italic># 此标签标识这是训练器步骤</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">trainer.kubeflow.org/trainjob-ancestor-step</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=trainerkubefloworgframework>trainer.kubeflow.org/framework<a href=#trainerkubefloworgframework class=hash-link aria-label="Direct link to trainer.kubeflow.org/framework" title="Direct link to trainer.kubeflow.org/framework">​</a></h5>
<p>用于标识<code>Runtime</code>的框架类型，便于用户筛选和管理。</p>
<p><strong>标签作用：</strong></p>
<ol>
<li>
<p><strong>资源分类和管理</strong>：</p>
<ul>
<li>帮助平台管理员对不同框架的<code>Runtime</code>进行分类</li>
<li>便于通过标签选择器查询特定框架的<code>Runtime</code></li>
<li>支持在<code>UI</code>或<code>CLI</code>工具中按框架类型过滤和展示</li>
</ul>
</li>
<li>
<p><strong>用户体验优化</strong>：</p>
<ul>
<li>用户可以通过 <code>kubectl get clustertrainingruntimes -l trainer.kubeflow.org/framework=torch</code> 快速查找<code>PyTorch</code>训练任务模板</li>
<li>在多租户环境中，可以基于框架类型实现<code>RBAC</code>权限控制</li>
<li>便于监控和审计特定框架的使用情况</li>
</ul>
</li>
<li>
<p><strong>文档和自动化</strong>：</p>
<ul>
<li>作为<code>Runtime</code>的元数据，帮助生成文档和使用指南</li>
<li>支持自动化工具根据框架类型进行配置推荐</li>
<li>便于集成到<code>CI/CD</code>流程中进行框架相关的校验</li>
</ul>
</li>
</ol>
<p><strong>是否必须配置：</strong></p>
<p>该标签<strong>不是强制要求</strong>的，但<strong>强烈推荐</strong>配置：</p>
<ul>
<li>✅ <strong>推荐配置</strong>：可以提供更好的用户体验和管理便利性</li>
<li>⚠️ <strong>不配置影响</strong>：<code>Runtime</code>功能完全正常，但会失去上述分类和筛选能力</li>
<li>📝 <strong>命名约定</strong>：建议使用官方支持的框架名称（<code>torch</code>、<code>deepspeed</code>、<code>mpi</code>、<code>mlx</code>、<code>torchtune</code>）</li>
</ul>
<p><strong>支持的框架类型：</strong></p>
<table><thead><tr><th>框架值<th>对应框架<th>说明<tbody><tr><td><code>torch</code><td><code>PyTorch</code><td>标准 <code>PyTorch</code> 分布式训练<tr><td><code>deepspeed</code><td><code>DeepSpeed</code><td><code>Microsoft DeepSpeed</code> 框架<tr><td><code>mpi</code><td><code>MPI</code><td>基于 <code>MPI</code> 的分布式训练<tr><td><code>mlx</code><td><code>MLX</code><td><code>Apple MLX</code> 框架<tr><td><code>torchtune</code><td><code>TorchTune</code><td><code>PyTorch</code> 微调框架</table>
<p><strong>使用示例：</strong></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 示例1：PyTorch Runtime</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ClusterTrainingRuntime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">distributed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">trainer.kubeflow.org/framework</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> torch  </span><span class="token comment" style=color:#8292a2;font-style:italic># 标识为 PyTorch 运行时</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 示例2：DeepSpeed Runtime</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ClusterTrainingRuntime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> deepspeed</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">distributed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">trainer.kubeflow.org/framework</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> deepspeed  </span><span class="token comment" style=color:#8292a2;font-style:italic># 标识为 DeepSpeed 运行时</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 示例3：查询特定框架的 Runtime</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># kubectl get clustertrainingruntimes -l trainer.kubeflow.org/framework=torch</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>最佳实践：</strong></p>
<ol>
<li>为所有生产环境的<code>Runtime</code>配置此标签</li>
<li>保持标签值的一致性，避免使用自定义值</li>
<li>结合其他标签（如版本、环境）实现更细粒度的管理：</li>
</ol>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ClusterTrainingRuntime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">distributed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">trainer.kubeflow.org/framework</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> torch  </span><span class="token comment" style=color:#8292a2;font-style:italic># 标识这是 PyTorch 运行时</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=trainerkubefloworgsupport>trainer.kubeflow.org/support<a href=#trainerkubefloworgsupport class=hash-link aria-label="Direct link to trainer.kubeflow.org/support" title="Direct link to trainer.kubeflow.org/support">​</a></h5>
<p>用于标识<code>Runtime</code>的废弃状态：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ClusterTrainingRuntime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> legacy</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">runtime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">trainer.kubeflow.org/support</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> deprecated  </span><span class="token comment" style=color:#8292a2;font-style:italic># 标识此运行时已废弃</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>当引用带有 <code>deprecated</code> 标签的<code>Runtime</code>时，<code>TrainJob</code>创建时会收到警告，提示用户该<code>Runtime</code>将在未来版本中移除。详见<a href=https://www.kubeflow.org/docs/components/trainer/operator-guides/runtime/#runtime-deprecation-policy target=_blank rel="noopener noreferrer">运行时废弃策略</a>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=用户自定义标签和注解>用户自定义标签和注解<a href=#用户自定义标签和注解 class=hash-link aria-label="Direct link to 用户自定义标签和注解" title="Direct link to 用户自定��义标签和注解">​</a></h4>
<p>除了系统预留标签外，用户可以在以下位置添加自定义标签和注解：</p>
<ol>
<li><strong>TrainJob.metadata.labels/annotations</strong>：应用<code>TrainJob</code>资源本身</li>
<li><strong>TrainJob.spec.labels/annotations</strong>：应用于衍生的<code>JobSet</code>和<code>Jobs</code>，会与<code>Runtime</code>中的标签/注解合并</li>
<li><strong>TrainJob.spec.podTemplateOverrides[].metadata.labels/annotations</strong>：应用于特定<code>Job</code>的<code>Pod</code>模板</li>
</ol>
<p>标签和注解的合并规则：</p>
<ul>
<li><code>TrainJob</code>中定义的标签/注解会与<code>Runtime</code>中的标签/注解合并</li>
<li>当存在相同的键时，<strong><code>TrainJob</code>中的值会覆盖<code>Runtime</code>中的值</strong></li>
<li>这种设计允许用户在不修改<code>Runtime</code>的情况下为特定训练任务自定义标签和注解</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=clustertrainingruntime>ClusterTrainingRuntime<a href=#clustertrainingruntime class=hash-link aria-label="Direct link to ClusterTrainingRuntime" title="Direct link to ClusterTrainingRuntime">​</a></h2>
<p><code>ClusterTrainingRuntime</code>是集群级别的训练运行时模板，可以被任何命名空间中的<code>TrainJob</code>引用。其配置格式与<code>TrainingRuntime</code>完全相同，唯一区别是资源作用域。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=完整模板示例-2>完整模板示例<a href=#完整模板示例-2 class=hash-link aria-label="Direct link to 完整模板示例" title="Direct link to 完整模板示例">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ClusterTrainingRuntime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># ClusterTrainingRuntime 的名称（集群唯一）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">distributed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 标签，标识框架类型</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">trainer.kubeflow.org/framework</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> torch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">version</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v2.7</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># ML 策略配置（与 TrainingRuntime 相同）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">mlPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">numNodes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">torch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">numProcPerNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> auto</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># PodGroup 策略配置（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">podGroupPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># Volcano gang-scheduler 配置示例</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">volcano</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 网络拓扑配置，用于网络感知调度</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">networkTopology</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 网络拓扑键，用于标识网络域</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 例如：topology.kubernetes.io/zone</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">topologyKey</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> topology.kubernetes.io/zone</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 网络策略，定义 Pod 应该如何分布</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 可选值：Best-effort（尽力而为）、Strict（严格模式）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># Best-effort：尽量将 Pod 调度到同一网络域，但不强制</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># Strict：必须将所有 Pod 调度到同一网络域，否则调度失败</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">networkPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Best</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">effort</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># JobSet 模板配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">runtime-type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> cluster</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">wide</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">framework</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 复制的 Job 列表</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">replicatedJobs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token comment" style=color:#8292a2;font-style:italic># 标识这是训练器步骤</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">trainer.kubeflow.org/trainjob-ancestor-step</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token comment" style=color:#8292a2;font-style:italic># Job 的 Pod 模板</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认 PyTorch 镜像</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch/pytorch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">2.7.1</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cuda12.8</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cudnn9</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">runtime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token comment" style=color:#8292a2;font-style:italic># torchrun 命令配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> torchrun</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">args</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nnodes=$(TRAINER_NNODES)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nproc_per_node=$(TRAINER_NPROC_PER_NODE)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">node_rank=$(JOB_COMPLETION_INDEX)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">rdzv_backend=c10d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">rdzv_endpoint=$(TRAINER_NODE_0_HOSTNAME)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token number" style=color:#ae81ff>29400</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">rdzv_id=$(TRAINER_JOB_ID)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token comment" style=color:#8292a2;font-style:italic># 环境变量</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> LOGLEVEL</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> INFO</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> PYTHONUNBUFFERED</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NCCL_DEBUG</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> INFO</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> TORCH_DISTRIBUTED_DEBUG</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> INFO</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token comment" style=color:#8292a2;font-style:italic># 资源请求和限制</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"4"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 16Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 32Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token comment" style=color:#8292a2;font-style:italic># 重启策略</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> OnFailure</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 失败策略</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">failurePolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">maxRestarts</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>3</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 成功策略</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">successPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> All</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">targetReplicatedJobs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 网络配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">network</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">publishNotReadyAddresses</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">enableDNSHostnames</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=集群级数据初始化运行时示例>集群级数据初始化运行时示例<a href=#集群级数据初始化运行时示例 class=hash-link aria-label="Direct link to 集群级数据初始化运行时示例" title="Direct link to 集群级数据初始化运行时示例">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ClusterTrainingRuntime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">distributed</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">with</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">trainer.kubeflow.org/framework</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> torch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">mlPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">numNodes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">torch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">numProcPerNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> auto</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">replicatedJobs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 数据集初始化 Job</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> dataset</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">trainer.kubeflow.org/trainjob-ancestor-step</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> dataset</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> dataset</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token comment" style=color:#8292a2;font-style:italic># 数据集初始化镜像</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ghcr.io/kubeflow/trainer/storage</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token comment" style=color:#8292a2;font-style:italic># 环境变量会被 TrainJob.initializer.dataset.env 合并</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> STORAGE_TYPE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> s3</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token comment" style=color:#8292a2;font-style:italic># 卷挂载</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> dataset</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /mnt/dataset</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token comment" style=color:#8292a2;font-style:italic># 卷定义</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">volumes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> dataset</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">emptyDir</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> OnFailure</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 模型初始化 Job</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> model</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">trainer.kubeflow.org/trainjob-ancestor-step</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> model</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> model</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ghcr.io/kubeflow/trainer/storage</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">initializer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> STORAGE_TYPE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> s3</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pretrained</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">model</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /mnt/model</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">volumes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pretrained</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">model</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">emptyDir</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> OnFailure</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 训练节点 Job</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">trainer.kubeflow.org/trainjob-ancestor-step</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch/pytorch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">2.7.1</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cuda12.8</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cudnn9</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">runtime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> torchrun</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">args</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nnodes=$(TRAINER_NNODES)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nproc_per_node=$(TRAINER_NPROC_PER_NODE)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">node_rank=$(JOB_COMPLETION_INDEX)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">rdzv_backend=c10d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">rdzv_endpoint=$(TRAINER_NODE_0_HOSTNAME)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token number" style=color:#ae81ff>29400</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">rdzv_id=$(TRAINER_JOB_ID)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> /workspace/train.py</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token comment" style=color:#8292a2;font-style:italic># 挂载初始化的数据集和模型</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> dataset</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /mnt/dataset</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pretrained</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">model</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /mnt/model</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">volumes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> dataset</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">emptyDir</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pretrained</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">model</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">emptyDir</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> OnFailure</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 成功策略：只要训练节点成功即可</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">successPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> All</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">targetReplicatedJobs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">network</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">publishNotReadyAddresses</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=trainingruntime-vs-clustertrainingruntime>TrainingRuntime vs ClusterTrainingRuntime<a href=#trainingruntime-vs-clustertrainingruntime class=hash-link aria-label="Direct link to TrainingRuntime vs ClusterTrainingRuntime" title="Direct link to TrainingRuntime vs ClusterTrainingRuntime">​</a></h3>
<p>两种运行时的对比：</p>
<table><thead><tr><th>特性<th>TrainingRuntime<th>ClusterTrainingRuntime<tbody><tr><td>作用域<td>命名空间级别<td>集群级别<tr><td>可见性<td>只能被同一命名空间的<code>TrainJob</code>引用<td>可以被任何命名空间的<code>TrainJob</code>引用<tr><td>使用场景<td>团队或项目特定的运行时配置<td>跨团队共享的标准运行时配置<tr><td>权限要求<td>命名空间级别的权限<td>集群级别的权限<tr><td>配置格式<td>完全相同<td>完全相同</table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=环境变量注入>环境变量注入<a href=#环境变量注入 class=hash-link aria-label="Direct link to 环境变量注入" title="Direct link to 环境变量注入">​</a></h2>
<p><code>Kubeflow Trainer</code>会根据使用的训练框架，为训练容器自动注入相应的环境变量。不同框架使用的环境变量不同。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=pytorch框架环境变量>PyTorch框架环境变量<a href=#pytorch框架环境变量 class=hash-link aria-label="Direct link to PyTorch框架环境变量" title="Direct link to PyTorch框架环境变量">​</a></h3>
<p>使用<code>PyTorch</code>（通过<code>torchrun</code>启动）时，<code>Torch Plugin</code>会自动注入以下环境变量：</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=pet_系列pytorch-elastic-training>PET_*系列（PyTorch Elastic Training）<a href=#pet_系列pytorch-elastic-training class=hash-link aria-label="Direct link to PET_*系列（PyTorch Elastic Training）" title="Direct link to PET_*系列（PyTorch Elastic Training）">​</a></h4>
<p>这些是<code>torchrun</code>使用的标准环境变量，由<code>Kubeflow Trainer</code>自动注入：</p>
<table><thead><tr><th>环境变量<th>说明<th>示例值<th>注入来源<tbody><tr><td><code>PET_NNODES</code><td>训练节点总数<td><code>2</code><td><code>spec.trainer.numNodes</code><tr><td><code>PET_NPROC_PER_NODE</code><td>每节点进程数<td><code>4</code><td><code>spec.mlPolicy.torch.numProcPerNode</code><tr><td><code>PET_NODE_RANK</code><td>当前节点编号<td><code>0-1</code><td><code>JOB_COMPLETION_INDEX</code><tr><td><code>PET_MASTER_ADDR</code><td>主节点地址<td><code>myjob-node-0-0.myjob</code><td><code>{trainjob-name}-node-0-0.{trainjob-name}</code><tr><td><code>PET_MASTER_PORT</code><td>主节点端口<td><code>29400</code><td>固定值</table>
<p><strong>说明</strong>：</p>
<ul>
<li><code>PET</code>代表<code>PyTorch Elastic Training</code>，是<code>torchrun</code>的标准环境变量前缀</li>
<li>这些变量在<code>TrainingRuntime</code>的<code>command</code>中使用，如：<code>torchrun --nproc_per_node=$(PET_NPROC_PER_NODE) ...</code></li>
<li><code>PET_NODE_RANK</code>通过<code>Kubernetes</code>的<code>fieldRef</code>机制自动从<code>JOB_COMPLETION_INDEX</code>获取</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=标准分布式训练环境变量>标准分布式训练环境变量<a href=#标准分布式训练环境变量 class=hash-link aria-label="Direct link to 标准分布式训练环境变量" title="Direct link to 标准分布式训练环境变量">​</a></h4>
<p><code>torchrun</code>会根据<code>PET_*</code>变量，为每个进程设置以下标准环境变量：</p>
<table><thead><tr><th>环境变量<th>说明<th>计算方式<th>示例值<tbody><tr><td><code>WORLD_SIZE</code><td>总进程数<td><code>PET_NNODES × PET_NPROC_PER_NODE</code><td><code>8</code><tr><td><code>RANK</code><td>全局进程编号<td>自动计算<td><code>0-7</code><tr><td><code>LOCAL_RANK</code><td>本地进程编号<td>节点内进程索引<td><code>0-3</code><tr><td><code>MASTER_ADDR</code><td>主节点地址<td>继承<code>PET_MASTER_ADDR</code><td><code>myjob-node-0-0.myjob</code><tr><td><code>MASTER_PORT</code><td>主节点端口<td>继承<code>PET_MASTER_PORT</code><td><code>29400</code></table>
<p><strong>说明</strong>：</p>
<ul>
<li>这些变量由<code>torchrun</code>自动设置，无需在<code>TrainingRuntime</code>中配置</li>
<li>训练代码中可直接使用<code>torch.distributed.get_rank()</code>等<code>API</code>，或通过<code>os.environ</code>访问</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=openmpi框架环境变量>OpenMPI框架环境变量<a href=#openmpi框架环境变量 class=hash-link aria-label="Direct link to OpenMPI框架环境变量" title="Direct link to OpenMPI框架环境变量">​</a></h3>
<p>使用<code>OpenMPI</code>（如<code>DeepSpeed</code>）时，会注入以下环境变量：</p>
<table><thead><tr><th>环境变量<th>说明<th>示例值<tbody><tr><td><code>OMPI_MCA_orte_default_hostfile</code><td>主机列表文件路径<td><code>/etc/mpi/hostfile</code><tr><td><code>OMPI_MCA_plm_rsh_agent</code><td>SSH代理（禁用）<td><code>/usr/bin/false</code><tr><td><code>OMPI_MCA_orte_keep_fqdn_hostnames</code><td>保持完整主机名<td><code>true</code></table>
<p><strong>说明</strong>：</p>
<ul>
<li>这些变量用于配置<code>OpenMPI</code>运行时行为</li>
<li>通常由<code>ClusterTrainingRuntime</code>的容器模板配置</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=通用环境变量>通用环境变量<a href=#通用环境变量 class=hash-link aria-label="Direct link to 通用环境变量" title="Direct link to 通用环境变量">​</a></h3>
<p>所有框架都可以使用以下<code>Kubernetes</code>原生环境变量：</p>
<table><thead><tr><th>环境变量<th>说明<th>示例值<tbody><tr><td><code>JOB_COMPLETION_INDEX</code><td>节点索引（<code>0</code>开始）<td><code>0-1</code></table>
<p><strong>说明</strong>：</p>
<ul>
<li>此变量来自<code>Kubernetes Job</code>的索引机制，表示当前<code>Pod</code>在<code>Job</code>中的序号</li>
<li>可用于获取节点编号或配置节点特定行为</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=使用示例>使用示例<a href=#使用示例 class=hash-link aria-label="Direct link to 使用示例" title="Direct link to 使用示例">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=pytorch训练脚本示例>PyTorch训练脚本示例<a href=#pytorch训练脚本示例 class=hash-link aria-label="Direct link to PyTorch训练脚本示例" title="Direct link to PyTorch训练脚本示例">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> os</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">distributed </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> dist</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 初始化分布式进程组（torchrun会自动设置所需环境变量）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">init_process_group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">backend</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"nccl"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 获取分布式信息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_rank</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">           </span><span class="token comment" style=color:#8292a2;font-style:italic># 等价于 int(os.environ['RANK'])</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">world_size </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_world_size</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 等价于 int(os.environ['WORLD_SIZE'])</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">local_rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">os</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">environ</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>'LOCAL_RANK'</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">node_rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">os</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">environ</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'JOB_COMPLETION_INDEX'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"Node Rank: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">node_rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"Global Rank: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>, World Size: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">world_size</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"Local Rank: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">local_rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=trainingruntime-command配置示例>TrainingRuntime command配置示例<a href=#trainingruntime-command配置示例 class=hash-link aria-label="Direct link to TrainingRuntime command配置示例" title="Direct link to TrainingRuntime command配置示例">​</a></h4>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> torchrun</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nproc_per_node=$(PET_NPROC_PER_NODE) </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nnodes=$(PET_NNODES)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">node_rank=$(PET_NODE_RANK)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">master_addr=$(PET_MASTER_ADDR)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">master_port=$(PET_MASTER_PORT)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> /workspace/train.py</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=最佳实践>最佳实践<a href=#最佳实践 class=hash-link aria-label="Direct link to 最佳实践" title="Direct link to 最佳实践">​</a></h2>
<ol>
<li>
<p><strong>资源配置</strong></p>
<ul>
<li>为训练任务设置合理的资源请求（<code>requests</code>）和限制（<code>limits</code>）</li>
<li><code>GPU</code>资源通常设置相同的<code>requests</code>和<code>limits</code></li>
<li>为需要大量内存的操作（如数据加载）预留足够的内存</li>
</ul>
</li>
<li>
<p><strong>存储配置</strong></p>
<ul>
<li>使用<code>PVC</code>或对象存储（<code>S3</code>、<code>GCS</code>）来持久化数据集和模型</li>
<li>对于需要高<code>I/O</code>性能的场景，考虑使用<code>hostPath</code>或<code>local volume</code></li>
<li>使用<code>emptyDir</code>（<code>medium: Memory</code>）作为共享内存，避免<code>/dev/shm</code>不足</li>
</ul>
</li>
<li>
<p><strong>网络配置</strong></p>
<ul>
<li>启用<code>publishNotReadyAddresses: true</code>确保分布式训练的网络连通性</li>
<li>对于大规模分布式训练，考虑使用高速网络（如<code>InfiniBand</code>）</li>
<li>配置适当的网络插件和<code>CNI</code></li>
</ul>
</li>
<li>
<p><strong>调度策略</strong></p>
<ul>
<li>使用<code>gang-scheduling</code>（<code>coscheduling</code>或<code>Volcano</code>）确保所有训练节点同时启动</li>
<li>使用节点亲和性和反亲和性控制<code>Pod</code>分布</li>
<li>对于<code>GPU</code>训练，使用节点选择器确保<code>Pod</code>调度到<code>GPU</code>节点</li>
</ul>
</li>
<li>
<p><strong>容错配置</strong></p>
<ul>
<li>设置合理的<code>maxRestarts</code>值，避免无限重试</li>
<li>使用<code>checkpoint</code>机制定期保存训练状态</li>
<li>配置健康检查（<code>readinessProbe</code>、<code>livenessProbe</code>）</li>
</ul>
</li>
<li>
<p><strong>运行时选择</strong></p>
<ul>
<li>使用<code>ClusterTrainingRuntime</code>定义组织级别的标准运行时</li>
<li>使用<code>TrainingRuntime</code>为特定团队或项目定制运行时</li>
<li>保持运行时配置的版本化管理</li>
</ul>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=参考资料>参考资料<a href=#参考资料 class=hash-link aria-label="Direct link to 参考资料" title="Direct link to 参考资料">​</a></h2>
<ul>
<li><a href=https://www.kubeflow.org/docs/components/trainer/ target=_blank rel="noopener noreferrer">Kubeflow Trainer 官方文档</a></li>
<li><a href=https://github.com/kubeflow/trainer target=_blank rel="noopener noreferrer">Kubeflow Trainer GitHub 仓库</a></li>
<li><a href=https://pytorch.org/tutorials/intermediate/ddp_tutorial.html target=_blank rel="noopener noreferrer">PyTorch Distributed 文档</a></li>
<li><a href=https://volcano.sh/zh/docs/network_topology_aware_scheduling/ target=_blank rel="noopener noreferrer">Volcano 网络拓扑调度</a></li>
<li><a href=https://github.com/kubernetes-sigs/jobset target=_blank rel="noopener noreferrer">Kubernetes JobSet</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/ai/kubeflow-trainer-pytorch-parallel-computing><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Kubeflow Trainer PyTorch并行计算</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/ai/kubeflow-trainer-deploy-usage><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Kubeflow Trainer 安装、部署及使用</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#概述 class="table-of-contents__link toc-highlight">概述</a><li><a href=#trainjob class="table-of-contents__link toc-highlight">TrainJob</a><ul><li><a href=#完整模板示例 class="table-of-contents__link toc-highlight">完整模板示例</a><li><a href=#重要字段说明 class="table-of-contents__link toc-highlight">重要字段说明</a></ul><li><a href=#trainingruntime class="table-of-contents__link toc-highlight">TrainingRuntime</a><ul><li><a href=#完整模板示例-1 class="table-of-contents__link toc-highlight">完整模板示例</a><li><a href=#重要字段说明-1 class="table-of-contents__link toc-highlight">重要字段说明</a><li><a href=#特殊标签和注解 class="table-of-contents__link toc-highlight">特殊标签和注解</a></ul><li><a href=#clustertrainingruntime class="table-of-contents__link toc-highlight">ClusterTrainingRuntime</a><ul><li><a href=#完整模板示例-2 class="table-of-contents__link toc-highlight">完整模板示例</a><li><a href=#集群级数据初始化运行时示例 class="table-of-contents__link toc-highlight">集群级数据初始化运行时示例</a><li><a href=#trainingruntime-vs-clustertrainingruntime class="table-of-contents__link toc-highlight">TrainingRuntime vs ClusterTrainingRuntime</a></ul><li><a href=#环境变量注入 class="table-of-contents__link toc-highlight">环境变量注入</a><ul><li><a href=#pytorch框架环境变量 class="table-of-contents__link toc-highlight">PyTorch框架环境变量</a><li><a href=#openmpi框架环境变量 class="table-of-contents__link toc-highlight">OpenMPI框架环境变量</a><li><a href=#通用环境变量 class="table-of-contents__link toc-highlight">通用环境变量</a><li><a href=#使用示例 class="table-of-contents__link toc-highlight">使用示例</a></ul><li><a href=#最佳实践 class="table-of-contents__link toc-highlight">最佳实践</a><li><a href=#参考资料 class="table-of-contents__link toc-highlight">参考资料</a></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>