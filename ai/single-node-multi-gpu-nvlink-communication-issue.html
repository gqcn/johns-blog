<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/AI技术/分布式推理/单机多卡部署，GPU之间无法使用NVLINK通信问题排查" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>单机多卡部署，GPU之间无法使用NVLINK通信问题排查 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/ai/single-node-multi-gpu-nvlink-communication-issue><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="单机多卡部署，GPU之间无法使用NVLINK通信问题排查 | John's Blog"><meta data-rh=true name=description content=详细分析和解决单机多卡部署中GPU之间无法使用NVLINK通信的问题。以PD分离技术为例，深入探讨GPU资源隔离机制、容器特权模式配置、GPU拓扑结构发现等关键技术，提供可供参考的解决方案。><meta data-rh=true property=og:description content=详细分析和解决单机多卡部署中GPU之间无法使用NVLINK通信的问题。以PD分离技术为例，深入探讨GPU资源隔离机制、容器特权模式配置、GPU拓扑结构发现等关键技术，提供可供参考的解决方案。><meta data-rh=true name=keywords content="单机多卡,NVLINK通信,Pod GPU通信,分布式推理,PD分离,Prefill Decode,GPU拓扑结构,NCCL NVLINK,容器GPU隔离,privileged容器,NVIDIA_VISIBLE_DEVICES,CUDA_VISIBLE_DEVICES,GPU device plugin,Kubernetes GPU调度,UCX性能测试,GPU通信优化,高性能计算,AI推理加速"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/ai/single-node-multi-gpu-nvlink-communication-issue><link data-rh=true rel=alternate href=https://johng.cn/ai/single-node-multi-gpu-nvlink-communication-issue hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/ai/single-node-multi-gpu-nvlink-communication-issue hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><script src=https://cdn.wwads.cn/js/makemoney.js async></script><link rel=stylesheet href=/assets/css/styles.208c11f9.css><script src=/assets/js/runtime~main.6f6069b1.js defer></script><script src=/assets/js/main.5dc6b32d.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" sidebarid=mainSidebar href=/ai>AI技术</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/cloud-native>云原生</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/observability>可观测性</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/ai>AI技术</a><button aria-label="Collapse sidebar category 'AI技术'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/nvidia>NVIDIA</a><button aria-label="Expand sidebar category 'NVIDIA'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/ai/distributed-inference>分布式推理</a><button aria-label="Collapse sidebar category '分布式推理'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/pd-separation>PD(Prefill&Decode)分离</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/nvidia-dynamo>NVIDIA Dynamo: 分布式AI推理的高效引擎</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/ai/single-node-multi-gpu-nvlink-communication-issue>单机多卡部署，GPU之间无法使用NVLINK通信问题排查</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/scheduling>算力资源调度</a><button aria-label="Expand sidebar category '算力资源调度'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ai/nfd-gfd>NFD&GFD</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ai/common-acceleration-cards>常见智算加速卡汇总</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ai/rdma>RDMA技术架构深度解析</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ai/general-ai-model-and-reasoning-ai-model-difference>通用大模型和推理大模型区别</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ai/common-ai-model-training-inference-framework>常见AI模型训练推理框架对比</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ai/ai-training-inference-scenarios>AI模型训练推理常见业务场景痛点</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/cloud-native>云原生</a><button aria-label="Expand sidebar category '云原生'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai><span itemprop=name>AI技术</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai/distributed-inference><span itemprop=name>分布式推理</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>单机多卡部署，GPU之间无法使用NVLINK通信问题排查</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><p>本章节使用<code>PD</code>分离作为示例，排查和演示单机多卡部署，<code>Pod</code>的<code>GPU</code>之间无法使用<code>NVLINK</code>通信的问题。</p>
<blockquote>
<p><code>PD</code>分离的部署架构正常应当是多机多卡部署，本文主要是基于测试目的，使用了单机多卡部署。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=1-问题介绍>1. 问题介绍<a href=#1-问题介绍 class=hash-link aria-label="Direct link to 1. 问题介绍" title="Direct link to 1. 问题介绍">​</a></h2>
<p><code>PD（Prefill & Decode）</code>分离技术中，如果<code>Prefill</code>和<code>Decode</code>部署到同节点下，<code>Prefill</code>和<code>Decode</code>两个<code>Pod</code>无法使用<code>NVLINK</code>通信，导致<code>Prefill</code>和<code>Decode</code>之间的通信性能较差。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=2-问题复现>2. 问题复现<a href=#2-问题复现 class=hash-link aria-label="Direct link to 2. 问题复现" title="Direct link to 2. 问题复现">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=21-复现环境>2.1 复现环境<a href=#21-复现环境 class=hash-link aria-label="Direct link to 2.1 复现环境" title="Direct link to 2.1 复现环境">​</a></h3>
<p>节点系统版本：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ cat /etc/issue</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Ubuntu 22.04.5 LTS </span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>节点内核版本：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ uname -a</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Linux ai-app-8-1-msxf 5.15.0-1078-nvidia #79-Ubuntu SMP Fri Apr 25 14:51:39 UTC 2025 x86_64 x86_64 x86_64 GNU/Linux</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>节点<code>GPU卡</code>列表：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ nvidia-smi topo -m</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        GPU0    GPU1    GPU2    GPU3    GPU4    GPU5    GPU6    GPU7    NIC0    NIC1    NIC2    NIC3    NIC4    CPU Affinity    NUMA Affinity   GPU NUMA ID</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU0     X      NV18    NV18    NV18    NV18    NV18    NV18    NV18    PIX     NODE    SYS     SYS     NODE    0-47,96-143     0               N/A</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU1    NV18     X      NV18    NV18    NV18    NV18    NV18    NV18    NODE    NODE    SYS     SYS     NODE    0-47,96-143     0               N/A</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU2    NV18    NV18     X      NV18    NV18    NV18    NV18    NV18    NODE    PIX     SYS     SYS     NODE    0-47,96-143     0               N/A</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU3    NV18    NV18    NV18     X      NV18    NV18    NV18    NV18    NODE    NODE    SYS     SYS     NODE    0-47,96-143     0               N/A</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU4    NV18    NV18    NV18    NV18     X      NV18    NV18    NV18    SYS     SYS     PIX     NODE    SYS     48-95,144-191   1               N/A</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU5    NV18    NV18    NV18    NV18    NV18     X      NV18    NV18    SYS     SYS     NODE    NODE    SYS     48-95,144-191   1               N/A</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU6    NV18    NV18    NV18    NV18    NV18    NV18     X      NV18    SYS     SYS     NODE    PIX     SYS     48-95,144-191   1               N/A</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU7    NV18    NV18    NV18    NV18    NV18    NV18    NV18     X      SYS     SYS     NODE    NODE    SYS     48-95,144-191   1               N/A</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">NIC0    PIX     NODE    NODE    NODE    SYS     SYS     SYS     SYS      X      NODE    SYS     SYS     NODE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">NIC1    NODE    NODE    PIX     NODE    SYS     SYS     SYS     SYS     NODE     X      SYS     SYS     NODE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">NIC2    SYS     SYS     SYS     SYS     PIX     NODE    NODE    NODE    SYS     SYS      X      NODE    SYS</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">NIC3    SYS     SYS     SYS     SYS     NODE    NODE    PIX     NODE    SYS     SYS     NODE     X      SYS</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">NIC4    NODE    NODE    NODE    NODE    SYS     SYS     SYS     SYS     NODE    NODE    SYS     SYS      X</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Legend:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  X    = Self</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  SYS  = Connection traversing PCIe as well as the SMP interconnect between NUMA nodes (e.g., QPI/UPI)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  NODE = Connection traversing PCIe as well as the interconnect between PCIe Host Bridges within a NUMA node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  PHB  = Connection traversing PCIe as well as a PCIe Host Bridge (typically the CPU)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  PXB  = Connection traversing multiple PCIe bridges (without traversing the PCIe Host Bridge)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  PIX  = Connection traversing at most a single PCIe bridge</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  NV#  = Connection traversing a bonded set of # NVLinks</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">NIC Legend:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  NIC0: ibp14s0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  NIC1: ibp71s0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  NIC2: ibp134s0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  NIC3: ibp195s0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  NIC4: rocep32s0f0</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=22-部署内容>2.2 部署内容<a href=#22-部署内容 class=hash-link aria-label="Direct link to 2.2 部署内容" title="Direct link to 2.2 部署内容">​</a></h3>
<p>以下部署内容示例仅供参考，内容无法独立部署。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=221-prefill>2.2.1 prefill<a href=#221-prefill class=hash-link aria-label="Direct link to 2.2.1 prefill" title="Direct link to 2.2.1 prefill">​</a></h4>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> apps/v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Deployment</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> qwen25</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">72b</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">int4</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">dhzn</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">prefill</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> qwen25</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">72b</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">int4</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">dhzn</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">prefill</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> qwen25</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">72b</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">int4</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">dhzn</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">prefill</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">creationTimestamp</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token null important">null</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> qwen25</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">72b</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">int4</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">dhzn</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">prefill</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">affinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">nodeAffinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia.com/gpu.product</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"NVIDIA-H20"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> bash</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">c</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> sleep 30 </span><span class="token important">&&</span><span class="token plain"> python3 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">m sglang.launch_server  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">host 0.0.0.0 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">port 30000  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">path</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          /models/model </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">served</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">name qwen   </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">disaggregation</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mode prefill  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">disaggregation</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">transfer</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">backend</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          nixl </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">enable</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nccl</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nvls</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mem</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">fraction</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">static 0.9 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">enable</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">p2p</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">check </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">tp</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">size 2 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pp</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">size 1 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">enable</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">metrics</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">page</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">size 64  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">enable</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">metrics </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">collect</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">tokens</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">histogram</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_TLS</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> cuda_ipc</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain">cuda_copy</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain">rc</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain">tcp</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_MEMTYPE_CACHE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"n"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_RNDV_SCHEME</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> get_zcopy</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_PROTO_INFO</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"y"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_LOG_LEVEL</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> debug</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> SGL_LOGURU_PATH</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /home/finance/Logs/prefill.log</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> aiharbor.msxf.local/test/sglang</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">0.4.8.post1</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cu128</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> IfNotPresent</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">sglang</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">prefill</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"24"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 150Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"24"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 150Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">securityContext</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">capabilities</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">add</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> IPC_LOCK</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=222-decoder>2.2.2 decoder<a href=#222-decoder class=hash-link aria-label="Direct link to 2.2.2 decoder" title="Direct link to 2.2.2 decoder">​</a></h4>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> apps/v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Deployment</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> qwen25</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">72b</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">int4</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">dhzn</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">decoder</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> qwen25</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">72b</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">int4</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">dhzn</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">decoder</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> qwen25</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">72b</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">int4</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">dhzn</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">decoder</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> qwen25</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">72b</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">int4</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">dhzn</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">decoder</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">affinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">nodeAffinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia.com/gpu.product</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"NVIDIA-H20"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> bash</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">c</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> sleep 30 </span><span class="token important">&&</span><span class="token plain">  python3 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">m sglang.launch_server </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">host 0.0.0.0 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">port 30000   </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">path</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          /models/model  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">served</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">name qwen  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">disaggregation</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mode decode  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">disaggregation</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">transfer</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">backend</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          nixl   </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">enable</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nccl</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nvls </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mem</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">fraction</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">static 0.85 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">enable</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">p2p</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">check</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">tp</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">size 2 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pp</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">size 1 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">enable</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">metrics </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">page</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">size 64  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">enable</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">metrics</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">collect</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">tokens</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">histogram</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_TLS</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> cuda_ipc</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain">cuda_copy</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain">rc</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain">tcp</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_MEMTYPE_CACHE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"n"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_RNDV_SCHEME</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> get_zcopy</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_PROTO_INFO</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"y"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_LOG_LEVEL</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> debug</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> SGL_LOGURU_PATH</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /home/finance/Logs/decoder.log</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> aiharbor.msxf.local/test/sglang</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">0.4.8.post1</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cu128</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> IfNotPresent</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">sglang</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">decoder</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"24"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 192Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"24"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 192Gi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">securityContext</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">capabilities</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">add</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> IPC_LOCK</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">hostIPC</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">securityContext</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=23-测试过程>2.3 测试过程<a href=#23-测试过程 class=hash-link aria-label="Direct link to 2.3 测试过程" title="Direct link to 2.3 测试过程">​</a></h3>
<p>执行后，查看<code>Pod</code>列表：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ k get pod </span><span class="token parameter variable" style=color:#f8f8f2>-owide</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">NAME                                               READY   STATUS    RESTARTS   AGE   IP               NODE                                  NOMINATED NODE   READINESS GATES</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">qwen25-72b-int4-dhzn-pd-decoder-6f44bd8869-lhjv9   </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running   </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">          20m   </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.52.252    ai-app-8-1-msxf                       </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain">           </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">qwen25-72b-int4-dhzn-pd-prefill-88f47f885-d2c9h    </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running   </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">          24m   </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.52.247    ai-app-8-1-msxf                       </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain">           </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>测试操作：</p>
<ol>
<li>
<p>在<code>qwen25-72b-int4-dhzn-pd-decoder-6f44bd8869-lhjv</code>容器中执行：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token assign-left variable" style=color:#f8f8f2>CUDA_VISIBLE_DEVICES</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> </span><span class="token assign-left variable" style=color:#f8f8f2>UCX_TLS</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">cuda_ipc,cuda_copy,rc,tcp ucx_perftest </span><span class="token parameter variable" style=color:#f8f8f2>-t</span><span class="token plain"> tag_bw </span><span class="token parameter variable" style=color:#f8f8f2>-m</span><span class="token plain"> cuda </span><span class="token parameter variable" style=color:#f8f8f2>-s</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>10000000</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>10</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-p</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>9999</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-c</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
<li>
<p>在<code>qwen25-72b-int4-dhzn-pd-prefill-88f47f885-d2c9h</code>容器中执行：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token assign-left variable" style=color:#f8f8f2>CUDA_VISIBLE_DEVICES</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token assign-left variable" style=color:#f8f8f2>UCX_TLS</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">cuda_ipc,cuda_copy,rc,tcp ucx_perftest </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.52.252 </span><span class="token parameter variable" style=color:#f8f8f2>-t</span><span class="token plain"> tag_bw </span><span class="token parameter variable" style=color:#f8f8f2>-m</span><span class="token plain"> cuda </span><span class="token parameter variable" style=color:#f8f8f2>-s</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100000000</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>10</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-p</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>9999</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-c</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> Final</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>其中<code>10.188.52.252</code>的<code>IP</code>是<code>decoder</code>的<code>Pod IP</code>。
最终输出结果如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ </span><span class="token assign-left variable" style=color:#f8f8f2>CUDA_VISIBLE_DEVICES</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token assign-left variable" style=color:#f8f8f2>UCX_TLS</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">cuda_ipc,cuda_copy,rc,tcp ucx_perftest </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.52.252 </span><span class="token parameter variable" style=color:#f8f8f2>-t</span><span class="token plain"> tag_bw </span><span class="token parameter variable" style=color:#f8f8f2>-m</span><span class="token plain"> cuda </span><span class="token parameter variable" style=color:#f8f8f2>-s</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100000000</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>10</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-p</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>9999</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-c</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-i</span><span class="token plain"> final</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Final:                    </span><span class="token number" style=color:#ae81ff>10</span><span class="token plain">      </span><span class="token number" style=color:#ae81ff>7.122</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>261054.587</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>261054.587</span><span class="token plain">      </span><span class="token number" style=color:#ae81ff>365.32</span><span class="token plain">     </span><span class="token number" style=color:#ae81ff>365.32</span><span class="token plain">           </span><span class="token number" style=color:#ae81ff>4</span><span class="token plain">           </span><span class="token number" style=color:#ae81ff>4</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>可以看待两个<code>Pod</code>之间的网速只有<code>365MB/S</code>，根本没有用上<code>NVLINK</code>，如果用上的话至少是上百<code>GB/S</code>的速率。</p>
</li>
<li>
<p>分别查看两个<code>Pod</code>中容器挂载的<code>GPU</code>卡信息，发现分配了不同的<code>GPU</code>卡：</p>
<p><code>prefill</code>容器：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ nvidia-smi </span><span class="token parameter variable" style=color:#f8f8f2>-L</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">: NVIDIA H20 </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">UUID: GPU-b0c5b618-67d0-f464-9905-e1fd41226305</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">: NVIDIA H20 </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">UUID: GPU-4695a002-ab2d-092d-6db9-44e9ae3cb5a6</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>decoder</code>容器：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ nvidia-smi </span><span class="token parameter variable" style=color:#f8f8f2>-L</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">: NVIDIA H20 </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">UUID: GPU-4650fca3-dbba-f168-d6bd-338a4ba8f044</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">: NVIDIA H20 </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">UUID: GPU-9648f14e-6ab2-46f0-221f-777f7652630b</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=3-排查过程>3. 排查过程<a href=#3-排查过程 class=hash-link aria-label="Direct link to 3. 排查过程" title="Direct link to 3. 排查过程">​</a></h2>
<p>篇幅太长，已省略。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=4-解决方案>4. 解决方案<a href=#4-解决方案 class=hash-link aria-label="Direct link to 4. 解决方案" title="Direct link to 4. 解决方案">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=41-问题原因>4.1 问题原因<a href=#41-问题原因 class=hash-link aria-label="Direct link to 4.1 问题原因" title="Direct link to 4.1 问题原因">​</a></h3>
<ul>
<li><code>GPU</code>卡资源的分配是由底层<code>GPU</code>的<code>device plugin</code>来实现的，而GPU资源分配是按照容器维度做了资源隔离。</li>
<li>每个容器中只能看到自身分配到的<code>GPU</code>卡（并且索引号都是从<code>0</code>开始），无法看到其他<code>GPU</code>卡，造成不同的容器之间无法发现完整<code>GPU</code>拓扑结构，从而引发<code>NCCL</code>的<code>NVLINK</code>失效。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=42-关键技术>4.2 关键技术<a href=#42-关键技术 class=hash-link aria-label="Direct link to 4.2 关键技术" title="Direct link to 4.2 关键技术">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=421-关键配置>4.2.1 关键配置<a href=#421-关键配置 class=hash-link aria-label="Direct link to 4.2.1 关键配置" title="Direct link to 4.2.1 关键配置">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=4211-privileged>4.2.1.1 privileged<a href=#4211-privileged class=hash-link aria-label="Direct link to 4.2.1.1 privileged" title="Direct link to 4.2.1.1 privileged">​</a></h4>
<p><strong>配置类型：</strong> 容器配置</p>
<p><strong>配置说明：</strong> 通过该配置项标识该容器是特权容器，特权容器能够访问宿主机上所有的硬件资源，包括所有的<code>GPU卡</code>。</p>
<p>使用示例：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">securityContext</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">privileged</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=4212-nvidia_visible_devices>4.2.1.2 NVIDIA_VISIBLE_DEVICES<a href=#4212-nvidia_visible_devices class=hash-link aria-label="Direct link to 4.2.1.2 NVIDIA_VISIBLE_DEVICES" title="Direct link to 4.2.1.2 NVIDIA_VISIBLE_DEVICES">​</a></h4>
<p><strong>配置类型：</strong> 容器运行时控制面环境变量</p>
<p><strong>配置说明：</strong></p>
<p>容器申请资源时使用的是<code>nvidia.com/gpu: "2"</code>这样的<code>resources.requests</code>和<code>limits</code>，但在底层进行<code>GPU</code>资源分配的时候，<code>GPU DevicePlugin</code>先查找空闲的<code>GPU</code>卡，再通过给业务容器注入<code>NVIDIA_VISIBLE_DEVICES</code>环境来实现的<code>GPU</code>卡分配，表示该容器只能使用该环境变量指定的这几张卡。</p>
<p>注意<code>device plugin</code>注入的该变量的值存储的是<code>GPU</code>卡的<code>UUID</code>。</p>
<p>具体可以参考官方资料：<a href=https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/docker-specialized.html target=_blank rel="noopener noreferrer">https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/docker-specialized.html</a></p>
<p>使用示例：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token builtin class-name" style=color:#e6db74>export</span><span class="token plain"> </span><span class="token assign-left variable" style=color:#f8f8f2>NVIDIA_VISIBLE_DEVICES</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"GPU-f055d080-1808-96f1-1c87-70fad19d9040,GPU-4650fca3-dbba-f168-d6bd-338a4ba8f044"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=4213-cuda_visible_devices>4.2.1.3 CUDA_VISIBLE_DEVICES<a href=#4213-cuda_visible_devices class=hash-link aria-label="Direct link to 4.2.1.3 CUDA_VISIBLE_DEVICES" title="Direct link to 4.2.1.3 CUDA_VISIBLE_DEVICES">​</a></h4>
<p><strong>配置类型：</strong> 容器运行时控制面环境变量</p>
<p><strong>配置说明：</strong></p>
<p>表示使用CUDA的应用程序能够使用的卡索引号列表，<code>CUDA</code>应用程序会根据该环境变量去访问<code>/dev/nvidia*</code>设备。</p>
<p>默认情况下，业务容器不会被<code>device plugin</code>注入该环境变量，<code>CUDA</code>应用程序会自动从容器中挂载的索引<code>0</code>号的<code>GPU</code>卡开始使用。</p>
<p>具体可以参考官方资料：<a href=https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#env-vars target=_blank rel="noopener noreferrer">https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#env-vars</a></p>
<p>使用示例：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token builtin class-name" style=color:#e6db74>export</span><span class="token plain"> </span><span class="token assign-left variable" style=color:#f8f8f2>CUDA_VISIBLE_DEVICES</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"1,2,3,4"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=422-技术原理>4.2.2 技术原理<a href=#422-技术原理 class=hash-link aria-label="Direct link to 4.2.2 技术原理" title="Direct link to 4.2.2 技术原理">​</a></h4>
<ol>
<li>通过配置<code>privileged</code>开启容器的特权模式，这样业务容器能够访问所有的硬件资源，包括完整的<code>GPU</code>卡列表，这样每个容器能够看到完整的<code>GPU</code>拓扑结构，以便能确认是否能够和目标进行<code>NVLINK</code>通信。</li>
<li>业务容器仍然使用<code>nvidia.com/gpu: "2"</code>这样的资源申请方式来申请<code>GPU</code>卡，让<code>device plugin</code>自动分配可用的<code>GPU</code>卡给业务容器，并自动注入<code>NVIDIA_VISIBLE_DEVICES</code>环境变量到业务容器中。</li>
<li>由于特权容器能够看到宿主机所有的<code>GPU</code>卡，默认情况下，业务容器的<code>CUDA</code>应用程序会自动从容器中挂载的索引<code>0</code>号的<code>GPU</code>卡开始使用。当存在多个特权容器时，都访问索引<code>0</code>号的<code>GPU</code>卡就会出现资源冲突。为了解决这个问题，我们需要让业务容器感知到自身被<code>device plugin</code>分配的<code>GPU</code>卡是哪些，通过<code>CUDA_VISIBLE_DEVICES</code>环境变量设置<code>CUDA</code>应用程序允许使用的正确的<code>GPU</code>卡索引号。</li>
<li>其中<code>NVIDIA_VISIBLE_DEVICES</code>是<code>device plugin</code>自动分配的<code>GPU</code>卡UUID，我们需要将这些<code>UUID</code>转换为宿主机上对应卡的索引号，并将该索引号注入到<code>CUDA_VISIBLE_DEVICES</code>环境变量即可。</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=423-部署示例>4.2.3 部署示例<a href=#423-部署示例 class=hash-link aria-label="Direct link to 4.2.3 部署示例" title="Direct link to 4.2.3 部署示例">​</a></h4>
<p>实现原理：</p>
<ul>
<li>通过给容器<code>privileged</code>权限，挂载所有的<code>GPU</code>设备，提供拓扑信息。</li>
<li>此时<code>CUDA</code>会看到节点上的所有<code>GPU</code>，需要指定其使用<code>device-plugin</code>分配的<code>GPU</code>。</li>
<li><code>device-plugin</code>在分配<code>GPU</code>资源时会为容器注入环境变量<code>NVIDIA_VISIBLE_DEVICES</code>，为指定的<code>GPU</code>设备<code>UUID</code>，如：<code>NVIDIA_VISIBLE_DEVICES=GPU-f055d080-1808-96f1-1c87-70fad19d9040,GPU-4650fca3-dbba-f168-d6bd-338a4ba8f044</code>。</li>
<li>将<code>NVIDIA_VISIBLE_DEVICES</code>转换为<code>GPU</code>的序号设置为<code>CUDA_VISIBLE_DEVICES</code>。但由于转换逻辑有点复杂，这里调整为了从本地进程文件中去读取对应的<code>GPU</code>索引列表。命令如下：<!-- -->
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token assign-left variable" style=color:#f8f8f2>CUDA_VISIBLE_DEVICES</span><span class="token operator" style=color:#66d9ef>=</span><span class="token variable" style=color:#f8f8f2>$(</span><span class="token variable function" style=color:#e6db74>find</span><span class="token variable" style=color:#f8f8f2> /proc/driver/nvidia/gpus/ </span><span class="token variable parameter variable" style=color:#f8f8f2>-mindepth</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable number" style=color:#ae81ff>1</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable parameter variable" style=color:#f8f8f2>-maxdepth</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable number" style=color:#ae81ff>1</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable parameter variable" style=color:#f8f8f2>-type</span><span class="token variable" style=color:#f8f8f2> d </span><span class="token variable operator" style=color:#66d9ef>|</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable function" style=color:#e6db74>sort</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable operator" style=color:#66d9ef>|</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable function" style=color:#e6db74>awk</span><span class="token variable" style=color:#f8f8f2> -F</span><span class="token variable string" style=color:#a6e22e>'/'</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable string" style=color:#a6e22e>'{print $6}'</span><span class="token variable operator" style=color:#66d9ef>|</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable keyword" style=color:#66d9ef>while</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable builtin class-name" style=color:#e6db74>read</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable parameter variable" style=color:#f8f8f2>-r</span><span class="token variable" style=color:#f8f8f2> gpu_dir</span><span class="token variable punctuation" style=color:#f8f8f2>;</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable keyword" style=color:#66d9ef>do</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable assign-left variable" style=color:#f8f8f2>index</span><span class="token variable operator" style=color:#66d9ef>=</span><span class="token variable punctuation" style=color:#f8f8f2>$(</span><span class="token variable" style=color:#f8f8f2>grep </span><span class="token variable string" style=color:#a6e22e>"Device Minor"</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable string" style=color:#a6e22e>"/proc/driver/nvidia/gpus/</span><span class="token variable string variable" style=color:#f8f8f2>$gpu_dir</span><span class="token variable string" style=color:#a6e22e>/information"</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable operator file-descriptor important" style=color:#66d9ef>2</span><span class="token variable operator" style=color:#66d9ef>></span><span class="token variable" style=color:#f8f8f2>/dev/null </span><span class="token variable operator" style=color:#66d9ef>|</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable function" style=color:#e6db74>awk</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable string" style=color:#a6e22e>'{print $3}'</span><span class="token variable punctuation" style=color:#f8f8f2>)</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable punctuation" style=color:#f8f8f2>;</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable builtin class-name" style=color:#e6db74>echo</span><span class="token variable" style=color:#f8f8f2> $index</span><span class="token variable punctuation" style=color:#f8f8f2>;</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable keyword" style=color:#66d9ef>done</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable operator" style=color:#66d9ef>|</span><span class="token variable" style=color:#f8f8f2> </span><span class="token variable function" style=color:#e6db74>paste</span><span class="token variable" style=color:#f8f8f2> -sd, </span><span class="token variable" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
</ul>
<p>部署示例如下，仅供参考：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> apps/v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Deployment</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">sglang</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">prefill</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">sglang</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">prefill</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">sglang</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">prefill</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">sglang</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">prefill</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">tolerations</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">effect</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NoSchedule</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> special.accelerate</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Exists</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">effect</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NoSchedule</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> special.accelerate.usage</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> inference</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"nvidia.com/gpu.product"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"Equal"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"NVIDIA-H200"</span><span class="token plain">         </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pd</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">sglang</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">prefill</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> harborai.msxf.lo/online/sglang</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">0.4.10.post2</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cu128</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> IfNotPresent</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">securityContext</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">privileged</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">capabilities</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">add</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> IPC_LOCK</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> bash</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">c</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> sleep 30 </span><span class="token important">&&</span><span class="token plain"> CUDA_VISIBLE_DEVICES=$(find /proc/driver/nvidia/gpus/ </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mindepth 1 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">maxdepth 1 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">type d </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token plain"> sort </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token plain"> awk </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">F'/' '</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain">print $6</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain">'</span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token plain"> while read </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">r gpu_dir; do index=$(grep "Device Minor" "/proc/driver/nvidia/gpus/$gpu_dir/information" 2</span><span class="token punctuation" style=color:#f8f8f2>></span><span class="token plain">/dev/null </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token plain"> awk '</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain">print $3</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain">') ; echo $index; done </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token plain"> paste </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">sd</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> ) python3 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">m sglang.launch_server  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">host 0.0.0.0 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">port 30000  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">path /models/model </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">served</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">name qwen25</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">72b</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">int4</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">dhzn</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pd   </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">disaggregation</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mode prefill  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">disaggregation</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">transfer</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">backend nixl </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">enable</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">torch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">compile </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">torch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">compile</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">max</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">bs 32 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">enable</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nccl</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nvls </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mem</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">fraction</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">static 0.9 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">enable</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">p2p</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">check </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">tp</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">size 2 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pp</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">size 1 </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">enable</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">metrics </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">page</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">size 64  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">enable</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">metrics </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">collect</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">tokens</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">histogram</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"24"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"150Gi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"24"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"150Gi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_TLS</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cuda_ipc,cuda_copy,tcp"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_MEMTYPE_CACHE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'n'</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_RNDV_SCHEME</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"get_zcopy"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_PROTO_INFO</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'y'</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> UCX_LOG_LEVEL</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'debug'</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> SGL_LOGURU_PATH  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'/home/finance/Logs/prefill.log'</span><span class="token plain">              </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">affinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">nodeAffinity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">values</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'NVIDIA-H200'</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token key atrule">key</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia.com/gpu</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token key atrule">operator</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> In</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=5-参考资料>5. 参考资料<a href=#5-参考资料 class=hash-link aria-label="Direct link to 5. 参考资料" title="Direct link to 5. 参考资料">​</a></h2>
<ul>
<li><a href=https://github.com/NVIDIA/k8s-device-plugin/issues/347 target=_blank rel="noopener noreferrer">https://github.com/NVIDIA/k8s-device-plugin/issues/347</a></li>
<li><a href=https://github.com/NVIDIA/nvidia-docker/issues/1255 target=_blank rel="noopener noreferrer">https://github.com/NVIDIA/nvidia-docker/issues/1255</a></li>
<li><a href=https://github.com/NVIDIA/nccl/issues/324 target=_blank rel="noopener noreferrer">https://github.com/NVIDIA/nccl/issues/324</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/ai/nvidia-dynamo><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>NVIDIA Dynamo: 分布式AI推理的高效引擎</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/ai/scheduling><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>算力资源调度</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#1-问题介绍 class="table-of-contents__link toc-highlight">1. 问题介绍</a><li><a href=#2-问题复现 class="table-of-contents__link toc-highlight">2. 问题复现</a><ul><li><a href=#21-复现环境 class="table-of-contents__link toc-highlight">2.1 复现环境</a><li><a href=#22-部署内容 class="table-of-contents__link toc-highlight">2.2 部署内容</a><li><a href=#23-测试过程 class="table-of-contents__link toc-highlight">2.3 测试过程</a></ul><li><a href=#3-排查过程 class="table-of-contents__link toc-highlight">3. 排查过程</a><li><a href=#4-解决方案 class="table-of-contents__link toc-highlight">4. 解决方案</a><ul><li><a href=#41-问题原因 class="table-of-contents__link toc-highlight">4.1 问题原因</a><li><a href=#42-关键技术 class="table-of-contents__link toc-highlight">4.2 关键技术</a></ul><li><a href=#5-参考资料 class="table-of-contents__link toc-highlight">5. 参考资料</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>