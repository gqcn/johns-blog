<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/AI技术/训练微调/开发训练框架/Pytorch/Volcano Job PyTorch Plugin调研测试" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Volcano Job PyTorch Plugin调研测试 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/ai/volcano-pytorch-plugin><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=author content="John Guo"><meta data-rh=true property=og:image content=https://johng.cn/img/favicon.png><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Volcano Job PyTorch Plugin调研测试 | John's Blog"><meta data-rh=true name=description content="深入介绍Volcano Job PyTorch Plugin的核心功能和使用方法。Volcano是面向高性能计算场景的Kubernetes批量调度系统，其PyTorch Plugin专为简化PyTorch分布式训练任务而设计。本文详细讲解PyTorch Plugin的工作原理，包括自动配置分布式训练环境变量、端口管理和服务发现等核心机制。介绍如何在Kubernetes集群中安装和配置Volcano系统，包括使用Helm或YAML文件部署Volcano组件。提供完整的PyTorch分布式训练任务示例，展示如何使用Volcano Job定义Master-Worker架构的训练任务，帮助读者快速掌握在Kubernetes上运行大规模PyTorch训练作业的最佳实践。"><meta data-rh=true property=og:description content="深入介绍Volcano Job PyTorch Plugin的核心功能和使用方法。Volcano是面向高性能计算场景的Kubernetes批量调度系统，其PyTorch Plugin专为简化PyTorch分布式训练任务而设计。本文详细讲解PyTorch Plugin的工作原理，包括自动配置分布式训练环境变量、端口管理和服务发现等核心机制。介绍如何在Kubernetes集群中安装和配置Volcano系统，包括使用Helm或YAML文件部署Volcano组件。提供完整的PyTorch分布式训练任务示例，展示如何使用Volcano Job定义Master-Worker架构的训练任务，帮助读者快速掌握在Kubernetes上运行大规模PyTorch训练作业的最佳实践。"><meta data-rh=true name=keywords content=Volcano,PyTorch,分布式训练,Kubernetes,批量调度,深度学习,GPU调度,容器编排,训练框架,云原生AI,机器学习,模型训练,并行训练,任务调度,作业管理,环境变量配置,Master-Worker架构,分布式计算><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/ai/volcano-pytorch-plugin><link data-rh=true rel=alternate href=https://johng.cn/ai/volcano-pytorch-plugin hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/ai/volcano-pytorch-plugin hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="John's Blog RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="John's Blog Atom Feed"><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><link rel=stylesheet href=/assets/css/styles.2ece4f8a.css><script src=/assets/js/runtime~main.68e3f0e6.js defer></script><script src=/assets/js/main.d69f8fc0.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/ai>AI技术</a><a class="navbar__item navbar__link" href=/cloud-native>云原生</a><a class="navbar__item navbar__link" href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/programming>开发语言</a><a class="navbar__item navbar__link" href=/architecture>技术架构</a><a class="navbar__item navbar__link" href=/observability>可观测性</a><a class="navbar__item navbar__link" href=/life>生活笔记</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href=/aboutme>关于我</a><a class="navbar__item navbar__link" href=/blog>博客</a><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/ai>AI技术</a><button aria-label="Collapse sidebar category 'AI技术'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false tabindex=0 href=/ai/agents-deep-dive-from-llm-to-autonomous-agents>智能体</a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false tabindex=0 href=/ai/copilot-skills-guide>应用开发</a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false tabindex=0 href=/ai/online-offline-batch-inference>推理服务</a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role=button aria-expanded=true tabindex=0 href=/ai/hpc-development-training-platform>训练微调</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false tabindex=0 href=/ai/hpc-development-training-platform>开发训练平台</a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role=button aria-expanded=true tabindex=0 href=/ai/pytorch-intro>开发训练框架</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role=button aria-expanded=true tabindex=0 href=/ai/pytorch-intro>Pytorch</a></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class=menu__link tabindex=0 href=/ai/pytorch-intro>PyTorch框架介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/ai/volcano-pytorch-plugin>Volcano Job PyTorch Plugin调研测试</a></ul></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false tabindex=0 href=/ai/kubeflow-trainer-in-hpc>Kubeflow Trainer</a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false tabindex=0 href=/ai/ray-distributed-computing>Ray分布式计算引擎</a></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/machine-learning-fundamentals>AI模型与机器学习</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/training>AI模型训练技术详解</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/fine-tuning>AI模型微调技术详解</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/training-parallel-strategies>AI模型训练并行策略介绍</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/model-development>模型开发</a><button aria-label="Expand sidebar category '模型开发'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false tabindex=0 href=/ai/rdma-brief>基础架构</a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false tabindex=0 href=/ai/basic-terminology>入门知识</a></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/cloud-native>云原生</a><button aria-label="Expand sidebar category '云原生'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/life>生活笔记</a><button aria-label="Expand sidebar category '生活笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai><span itemprop=name>AI技术</span></a><meta itemprop=position content=1><li class=breadcrumbs__item><span class=breadcrumbs__link>训练微调</span><meta itemprop=position content=2><li class=breadcrumbs__item><span class=breadcrumbs__link>开发训练框架</span><meta itemprop=position content=3><li class=breadcrumbs__item><span class=breadcrumbs__link>Pytorch</span><meta itemprop=position content=4><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Volcano Job PyTorch Plugin调研测试</span><meta itemprop=position content=5></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 12 16"><path fill-rule=evenodd d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"/></svg></span>注意</div><div class=admonitionContent_BuS1><p>目前<code>Volcano</code>最新版本<code>1.13.0</code>的<code>PyTorch Job Plugin</code>经调研发现存在严重<code>BUG</code>，需要等修复之后再进一步完善文档。</div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=volcano-pytorch-plugin是什么>Volcano PyTorch Plugin是什么<a href=#volcano-pytorch-plugin是什么 class=hash-link aria-label="Direct link to Volcano PyTorch Plugin是什么" title="Direct link to Volcano PyTorch Plugin是什么">​</a></h2>
<p><code>Volcano PyTorch Plugin</code>是<code>Volcano</code>批量调度系统中的一个插件，专门用于简化在<code>Kubernetes</code>集群上运行<code>PyTorch</code>分布式训练任务的配置和管理。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=volcano简介>Volcano简介<a href=#volcano简介 class=hash-link aria-label="Direct link to Volcano简介" title="Direct link to Volcano简介">​</a></h3>
<p><code>Volcano</code>是一个基于<code>Kubernetes</code>构建的批量调度系统，专为高性能计算场景（如<code>AI</code>训练、大数据分析、科学计算等）设计。它与<code>Spark</code>、<code>TensorFlow</code>、<code>PyTorch</code>、<code>Ray</code>、<code>MPI</code>等多种计算框架深度集成，提供了强大的批量任务调度能力。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=pytorch-plugin定位>PyTorch Plugin定位<a href=#pytorch-plugin定位 class=hash-link aria-label="Direct link to PyTorch Plugin定位" title="Direct link to PyTorch Plugin定位">​</a></h3>
<p><code>PyTorch Plugin</code>是<code>Volcano</code>针对<code>PyTorch</code>分布式训练场景提供的插件，它能够：</p>
<ul>
<li><strong>自动配置分布式训练环境变量</strong>：自动注入<code>MASTER_ADDR</code>、<code>MASTER_PORT</code>、<code>WORLD_SIZE</code>、<code>RANK</code>等<code>PyTorch</code>分布式训练必需的环境变量</li>
<li><strong>简化任务定义</strong>：用户无需手动配置复杂的网络和环境设置，只需定义基本的任务结构</li>
<li><strong>确保任务正常运行</strong>：自动处理端口开放、服务发现等底层细节</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=通俗理解>通俗理解<a href=#通俗理解 class=hash-link aria-label="Direct link to 通俗理解" title="Direct link to 通俗理解">​</a></h3>
<p>如果把<code>PyTorch</code>分布式训练比作一个交响乐团演出：</p>
<ul>
<li><strong>训练任务</strong>就像整场音乐会（需要多个乐手协同完成）</li>
<li><strong>Master节点</strong>就像指挥家（协调整个训练过程）</li>
<li><strong>Worker节点</strong>就像乐手（执行具体的训练计算）</li>
<li><strong>Volcano PyTorch Plugin</strong>就像音乐会的舞台监督（自动安排座位、配置设备、建立通信渠道），让乐手们只需专注演奏，无需关心座位编号、通信方式等细节</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=pytorch-plugin解决什么问题>PyTorch Plugin解决什么问题<a href=#pytorch-plugin解决什么问题 class=hash-link aria-label="Direct link to PyTorch Plugin解决什么问题" title="Direct link to PyTorch Plugin解决什么问题">​</a></h2>
<p>在<code>Kubernetes</code>上运行<code>PyTorch</code>分布式训练任务时，开发者通常面临以下挑战，<code>PyTorch Plugin</code>针对性地解决了这些问题。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=主要解决的问题>主要解决的问题<a href=#主要解决的问题 class=hash-link aria-label="Direct link to 主要解决的问题" title="Direct link to 主要解决的问题">​</a></h3>
<table><thead><tr><th>问题领域<th>传统困境<th>PyTorch Plugin的解决方案<th>价值<tbody><tr><td><strong>环境变量配置</strong><td>需要手动为每个<code>Pod</code>配置<code>MASTER_ADDR</code>、<code>RANK</code>等变量<td>自动注入所有必需的环境变量<td>减少配置错误，降低<code>80%</code>配置工作量<tr><td><strong>端口管理</strong><td>需要手动配置容器端口和服务端口<td>自动开放<code>PyTorch</code>通信端口<td>避免端口冲突和配置遗漏<tr><td><strong>服务发现</strong><td>需要手动配置<code>Master</code>节点地址<td>自动生成<code>Master</code>节点的完整域名<td>简化网络配置，提升可靠性<tr><td><strong>任务编排</strong><td><code>YAML</code>文件复杂，易出错<td>统一的任务定义格式<td>提升开发效率，降低维护成本<tr><td><strong>扩展性</strong><td>修改节点数量需要大量配置变更<td>自动计算<code>WORLD_SIZE</code>和分配<code>RANK</code><td>轻松实现任务扩缩容</table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=plugin工作原理>Plugin工作原理<a href=#plugin工作原理 class=hash-link aria-label="Direct link to Plugin工作原理" title="Direct link to Plugin工作原理">​</a></h3>
<p><code>PyTorch Plugin</code>在<code>Pod</code>创建时自动执行以下操作：</p>
<ol>
<li>创建<code>Volcano Job</code></li>
<li><code>PyTorch Plugin</code>启动</li>
<li>识别<code>Master</code>和<code>Worker</code>任务</li>
<li>生成<code>Master</code>地址</li>
<li>计算<code>WORLD_SIZE</code></li>
<li>分配<code>RANK</code>给每个<code>Pod</code></li>
<li>开放通信端口</li>
<li>注入环境变量</li>
<li><code>Pod</code>启动训练</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=核心功能详解>核心功能详解<a href=#核心功能详解 class=hash-link aria-label="Direct link to 核心功能详解" title="Direct link to 核心功能详解">​</a></h4>
<p><strong>1. 自动注入环境变量</strong></p>
<p><code>PyTorch</code>分布式训练依赖以下关键环境变量：</p>
<table><thead><tr><th>环境变量<th>含义<th>Plugin处理方式<tbody><tr><td><code>MASTER_ADDR</code><td><code>Master</code>节点的网络地址<td>自动生成为<code>{hostname}.{subdomain}</code>格式<tr><td><code>MASTER_PORT</code><td><code>Master</code>节点的通信端口<td>默认<code>23456</code>，可配置<tr><td><code>WORLD_SIZE</code><td>总的进程数（所有节点）<td>自动计算<code>Master + Worker</code>的副本数<tr><td><code>RANK</code><td>当前进程的全局排名<td><code>Master</code>为<code>0</code>，<code>Worker</code>依次递增</table>
<p><strong>2. 自动开放端口</strong></p>
<p><code>Plugin</code>会为所有容器自动添加端口配置：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">ports</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorchjob</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">port</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">containerPort</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>23456</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认端口，可配置</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>3. 强制启用服务插件</strong></p>
<p><code>Plugin</code>会自动启用<code>svc</code>插件，为每个任务创建<code>Headless Service</code>，实现<code>Pod</code>之间的稳定网络通信。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=如何安装和配置>如何安装和配置<a href=#如何安装和配置 class=hash-link aria-label="Direct link to 如何安装和配置" title="Direct link to 如何安装和配置">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=前置条件>前置条件<a href=#前置条件 class=hash-link aria-label="Direct link to 前置条件" title="Direct link to 前置条件">​</a></h3>
<ul>
<li><code>Kubernetes</code>集群（版本<code>1.19+</code>）</li>
<li><code>kubectl</code>命令行工具</li>
<li>集群管理员权限（用于安装<code>CRD</code>和控制器）</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=安装volcano>安装Volcano<a href=#安装volcano class=hash-link aria-label="Direct link to 安装Volcano" title="Direct link to 安装Volcano">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 添加Volcano Helm仓库</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">helm repo </span><span class="token function" style=color:#e6db74>add</span><span class="token plain"> volcano-sh https://volcano-sh.github.io/helm-charts</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">helm repo update</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 安装Volcano（版本可自行指定）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">helm </span><span class="token function" style=color:#e6db74>install</span><span class="token plain"> volcano volcano-sh/volcano </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> volcano-system </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  --create-namespace </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token parameter variable" style=color:#f8f8f2>--version</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1.13</span><span class="token plain">.0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 等待Volcano组件就绪，预计需要几分钟时间</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 验证安装</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl get pods </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> volcano-system</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>预期输出示例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">NAME                                   READY   STATUS    RESTARTS      AGE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">volcano-admission-b84bbd89-dgv2p       1/1     Running   0             10s</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">volcano-controllers-7b97b6455c-rghzf   1/1     Running   0             10s</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">volcano-scheduler-65d4d4645b-p9llx     1/1     Running   0             10s</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=配置参数说明>配置参数说明<a href=#配置参数说明 class=hash-link aria-label="Direct link to 配置参数说明" title="Direct link to 配置参数说明">​</a></h3>
<p><code>PyTorch Plugin</code>支持以下配置参数：</p>
<table><thead><tr><th>参数名<th>类型<th>默认值<th>必填<th>说明<th>示例<tbody><tr><td><code>--master</code><td><code>string</code><td><code>master</code><td>否<td><code>Master</code>任务的名称<td><code>--master=master</code><tr><td><code>--worker</code><td><code>string</code><td><code>worker</code><td>否<td><code>Worker</code>任务的名称<td><code>--worker=worker</code><tr><td><code>--port</code><td><code>int</code><td><code>23456</code><td>否<td>通信端口号<td><code>--port=23456</code></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=pytorch分布式训练示例>PyTorch分布式训练示例<a href=#pytorch分布式训练示例 class=hash-link aria-label="Direct link to PyTorch分布式训练示例" title="Direct link to PyTorch分布式训练示例">​</a></h2>
<blockquote>
<p>以下示例中使用的镜像为<code>pytorch/pytorch:2.7.1-cuda12.8-cudnn9-runtime</code>，可根据需要替换为其他版本。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=脚本示例>脚本示例<a href=#脚本示例 class=hash-link aria-label="Direct link to 脚本示例" title="Direct link to 脚本示例">​</a></h3>
<p>我们使用一个简单的<code>PyTorch</code>分布式训练脚本来演示。该脚本实现了一个简单的线性回归模型训练：</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockTitle_Ktv7>pytorch-demo.py</div><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> os</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">nn </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> nn</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">optim </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> optim</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">distributed </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> dist</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>from</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">utils</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">data </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> Dataset</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> DataLoader</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>from</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">utils</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">data</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">distributed </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> DistributedSampler</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ====================== 1. 定义简单的数据集和模型 ======================</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>class</span><span class="token plain"> </span><span class="token class-name" style=color:#e6db74>SimpleDataset</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">Dataset</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token triple-quoted-string string" style=color:#a6e22e>"""简单的数据集：输入是随机数，标签是输入的2倍（简单回归任务）"""</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>def</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>__init__</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">self</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> size</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>100</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">data </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">randn</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">size</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 输入：(size, 1)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">labels </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">data </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>+</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0.1</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">randn_like</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 标签：2x + 噪声</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>def</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>__len__</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">self</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>len</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>def</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>__getitem__</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">self</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> idx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">data</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token plain">idx</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">labels</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token plain">idx</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>class</span><span class="token plain"> </span><span class="token class-name" style=color:#e6db74>SimpleModel</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">nn</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Module</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token triple-quoted-string string" style=color:#a6e22e>"""简单的线性模型：y = wx + b"""</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>def</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>__init__</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">self</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token builtin" style=color:#e6db74>super</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">SimpleModel</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> self</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">__init__</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">linear </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> nn</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Linear</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>def</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>forward</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">self</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> x</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">linear</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">x</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ====================== 2. 初始化分布式进程组 ======================</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>def</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>init_distributed</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token triple-quoted-string string" style=color:#a6e22e>"""</span><br></span><span class=token-line style=color:#f8f8f2><span class="token triple-quoted-string string" style=color:#a6e22e>    初始化分布式环境（CPU + gloo后端）</span><br></span><span class=token-line style=color:#f8f8f2><span class="token triple-quoted-string string" style=color:#a6e22e>    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token triple-quoted-string string" style=color:#a6e22e>    Volcano PyTorch Plugin 会自动设置以下环境变量：</span><br></span><span class=token-line style=color:#f8f8f2><span class="token triple-quoted-string string" style=color:#a6e22e>    - RANK: 全局进程排名</span><br></span><span class=token-line style=color:#f8f8f2><span class="token triple-quoted-string string" style=color:#a6e22e>    - WORLD_SIZE: 总进程数</span><br></span><span class=token-line style=color:#f8f8f2><span class="token triple-quoted-string string" style=color:#a6e22e>    - MASTER_ADDR: 主节点地址</span><br></span><span class=token-line style=color:#f8f8f2><span class="token triple-quoted-string string" style=color:#a6e22e>    - MASTER_PORT: 主节点端口</span><br></span><span class=token-line style=color:#f8f8f2><span class="token triple-quoted-string string" style=color:#a6e22e>    """</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 从环境变量中获取分布式训练参数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">os</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">environ</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"RANK"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    world_size </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">os</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">environ</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"WORLD_SIZE"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"[初始化] RANK=</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>, WORLD_SIZE=</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">world_size</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"[初始化] MASTER_ADDR=</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">os</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>.</span><span class="token string-interpolation interpolation">environ</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>.</span><span class="token string-interpolation interpolation">get</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation interpolation string" style=color:#a6e22e>'MASTER_ADDR'</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>,</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation string" style=color:#a6e22e>'N/A'</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>)</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"[初始化] MASTER_PORT=</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">os</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>.</span><span class="token string-interpolation interpolation">environ</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>.</span><span class="token string-interpolation interpolation">get</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation interpolation string" style=color:#a6e22e>'MASTER_PORT'</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>,</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation string" style=color:#a6e22e>'N/A'</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>)</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 初始化分布式进程组</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 使用 gloo 后端（CPU训练），自动从环境变量读取配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">init_process_group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">backend</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"gloo"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"[初始化完成] 成功初始化分布式进程组"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> rank</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> world_size</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ====================== 3. 核心训练函数 ======================</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>def</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>train</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"="</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>60</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"开始 PyTorch 分布式训练（Volcano 版本）"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"="</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>60</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 初始化分布式环境</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    rank</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> world_size </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> init_distributed</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 设置当前进程的设备（CPU）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    device </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"cpu"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 1. 构建数据集和分布式采样器（核心：将数据分发给不同进程）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dataset </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> SimpleDataset</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">size</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>100</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># DistributedSampler：保证不同进程读取不同的数据分片</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    sampler </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> DistributedSampler</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">dataset</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> num_replicas</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">world_size</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> rank</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">rank</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dataloader </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> DataLoader</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        dataset</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        batch_size</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>10</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        sampler</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">sampler</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 必须用分布式采样器，替代shuffle</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        num_workers</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 简化demo，关闭多线程</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 2. 构建模型并包装为分布式数据并行（DDP）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    model </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> SimpleModel</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># DDP：自动处理参数同步、梯度聚合</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    model </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> nn</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">parallel</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">DistributedDataParallel</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> device_ids</span><span class="token operator" style=color:#66d9ef>=</span><span class="token boolean" style=color:#ae81ff>None</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># CPU训练，device_ids设为None</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 3. 定义损失函数和优化器</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    criterion </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> nn</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MSELoss</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    optimizer </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> optim</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">SGD</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">parameters</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> lr</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>0.01</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 4. 训练循环</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    epochs </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>5</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"\n[Rank </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>] 开始训练，共 </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">epochs</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e> 个 epoch"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"-"</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>60</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> epoch </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">epochs</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 每个epoch开始前，更新采样器的epoch（保证分布式数据打乱的一致性）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        sampler</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">set_epoch</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">epoch</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">train</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        total_loss </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0.0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> batch_idx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">data</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> labels</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>enumerate</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">dataloader</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic># 将数据移动到设备</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            data</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> labels </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> data</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">to</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> labels</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">to</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic># 前向传播</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            outputs </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            loss </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> criterion</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">outputs</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> labels</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic># 反向传播和优化</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            optimizer</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">zero_grad</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            loss</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">backward</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            optimizer</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">step</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            total_loss </span><span class="token operator" style=color:#66d9ef>+=</span><span class="token plain"> loss</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">item</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 只在主进程（rank=0）打印训练信息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> rank </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            avg_loss </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> total_loss </span><span class="token operator" style=color:#66d9ef>/</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>len</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">dataloader</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"Epoch [</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">epoch</span><span class="token string-interpolation interpolation operator" style=color:#66d9ef>+</span><span class="token string-interpolation interpolation number" style=color:#ae81ff>1</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>/</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">epochs</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>], Average Loss: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">avg_loss</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>:</span><span class="token string-interpolation interpolation format-spec">.4f</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"-"</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>60</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"[Rank </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>] 训练完成！"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 在主进程打印最终的模型参数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> rank </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"\n"</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>+</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"="</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>60</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"最终模型参数:"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> name</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> param </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">named_parameters</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"  </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">name</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">param</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>.</span><span class="token string-interpolation interpolation">data</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"="</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>60</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 清理分布式进程组</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">destroy_process_group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"[Rank </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>] 进程组已销毁"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> __name__ </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"__main__"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    train</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>代码关键点：</p>
<ol>
<li><strong>分布式初始化</strong>：使用<code>dist.init_process_group(backend="gloo")</code>初始化分布式环境，<code>CPU</code>训练使用<code>gloo</code>后端</li>
<li><strong>数据并行</strong>：使用<code>DistributedSampler</code>确保不同进程读取不同的数据分片</li>
<li><strong>模型并行</strong>：使用<code>DistributedDataParallel</code>包装模型，自动处理梯度聚合</li>
<li><strong>环境变量</strong>：<code>Volcano PyTorch Plugin</code>会自动设置所有必要的环境变量（<code>RANK</code>、<code>WORLD_SIZE</code>、<code>MASTER_ADDR</code>等）</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=部署步骤>部署步骤<a href=#部署步骤 class=hash-link aria-label="Direct link to 部署步骤" title="Direct link to 部署步骤">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=步骤一创建-configmap>步骤一：创建 ConfigMap<a href=#步骤一创建-configmap class=hash-link aria-label="Direct link to 步骤一：创建 ConfigMap" title="Direct link to 步骤一：创建 ConfigMap">​</a></h4>
<p>本示例使用<code>ConfigMap</code>方式管理训练代码，适合快速开发和测试场景，将训练脚本存储在<code>ConfigMap</code>中，然后挂载到训练<code>Pod</code>中。</p>
<p><strong>优点：</strong></p>
<ul>
<li>✅ 快速迭代：修改脚本只需更新<code>ConfigMap</code></li>
<li>✅ 无需构建镜像：避免镜像构建和推送的开销</li>
<li>✅ 适合调试：快速验证训练逻辑</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ 文件大小限制：<code>ConfigMap</code>最大<code>1MB</code></li>
<li>❌ 不适合生产：缺少版本控制和回滚能力</li>
</ul>
<p>将训练脚本保存为<code>pytorch-demo.py</code>文件，然后创建<code>ConfigMap</code>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl create configmap pytorch-demo-script --from-file</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">pytorch-demo.py</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>验证<code>ConfigMap</code>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl get configmap pytorch-demo-script</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl describe configmap pytorch-demo-script</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=步骤二创建-volcano-job>步骤二：创建 Volcano Job<a href=#步骤二创建-volcano-job class=hash-link aria-label="Direct link to 步骤二：创建 Volcano Job" title="Direct link to 步骤二：创建 Volcano Job">​</a></h4>
<p>创建<code>pytorch-job-with-configmap.yaml</code>：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockTitle_Ktv7>pytorch-job-with-configmap.yaml</div><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> batch.volcano.sh/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Job</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">job</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">with</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">configmap</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 最小可用副本数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">minAvailable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>3</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 使用Volcano调度器</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">schedulerName</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> volcano</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 配置插件</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">plugins</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 启用PyTorch Plugin</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">pytorch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"--master=master"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"--worker=worker"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"--port=23456"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 指定队列</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">queue</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> default</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 定义任务</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">tasks</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># Master任务定义</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> master</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">policies</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 当Master任务完成时，整个Job标记为完成</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">event</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> TaskCompleted</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">action</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> CompleteJob</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> master</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch/pytorch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">2.7.1</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cuda12.8</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cudnn9</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">runtime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> IfNotPresent</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> python</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> /workspace/pytorch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">demo.py</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> PYTHONUNBUFFERED</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> training</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">script</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /workspace</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2Gi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2Gi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">volumes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> training</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">script</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">configMap</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">demo</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">script</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> OnFailure</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># Worker任务定义</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> worker</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> worker</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch/pytorch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">2.7.1</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cuda12.8</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cudnn9</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">runtime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> IfNotPresent</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> python</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> /workspace/pytorch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">demo.py</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> PYTHONUNBUFFERED</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> training</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">script</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /workspace</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2Gi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2Gi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">volumes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> training</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">script</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">configMap</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">demo</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">script</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> OnFailure</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=步骤三提交训练任务>步骤三：提交训练任务<a href=#步骤三提交训练任务 class=hash-link aria-label="Direct link to 步骤三：提交训练任务" title="Direct link to 步骤三：提交训练任务">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 应用Job定义</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl apply </span><span class="token parameter variable" style=color:#f8f8f2>-f</span><span class="token plain"> pytorch-job-with-configmap.yaml</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 查看Job状态</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl get vcjob pytorch-job-with-configmap</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 查看Pod状态</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl get pods </span><span class="token parameter variable" style=color:#f8f8f2>-l</span><span class="token plain"> volcano.sh/job-name</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">pytorch-job-with-configmap</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>期望输出：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">NAME                                   READY   STATUS    RESTARTS   AGE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">pytorch-job-with-configmap-master-0    1/1     Running   0          30s</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">pytorch-job-with-configmap-worker-0    1/1     Running   0          30s</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">pytorch-job-with-configmap-worker-1    1/1     Running   0          30s</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=步骤四查看训练日志>步骤四：查看训练日志<a href=#步骤四查看训练日志 class=hash-link aria-label="Direct link to 步骤四：查看训练日志" title="Direct link to 步骤四：查看训练日志">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 查看Master节点日志</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl logs pytorch-job-with-configmap-master-0 </span><span class="token parameter variable" style=color:#f8f8f2>-f</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 查看Worker节点日志</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl logs pytorch-job-with-configmap-worker-0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl logs pytorch-job-with-configmap-worker-1</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>预期输出：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">============================================================</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">开始 PyTorch 分布式训练（Volcano 版本）</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">============================================================</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">[初始化] RANK=0, WORLD_SIZE=3</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">[初始化] MASTER_ADDR=master-0.pytorch-job-with-configmap</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">[初始化] MASTER_PORT=23456</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">[初始化完成] 成功初始化分布式进程组</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">[Rank 0] 开始训练，共 5 个 epoch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">------------------------------------------------------------</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Epoch [1/5], Average Loss: 0.0234</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Epoch [2/5], Average Loss: 0.0189</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Epoch [3/5], Average Loss: 0.0156</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Epoch [4/5], Average Loss: 0.0128</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Epoch [5/5], Average Loss: 0.0103</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">------------------------------------------------------------</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">[Rank 0] 训练完成！</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 12 16"><path fill-rule=evenodd d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"/></svg></span>分布式训练验证</div><div class=admonitionContent_BuS1><ul>
<li>查看<code>WORLD_SIZE</code>确认总进程数：<code>1个Master + 2个Worker = 3进程</code></li>
<li>查看<code>RANK</code>确认进程编号：<code>0（Master）, 1（Worker-0）, 2（Worker-1）</code></li>
<li>查看<code>MASTER_ADDR</code>确认主节点地址自动生成</li>
</ul></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=步骤五清理资源>步骤五：清理资源<a href=#步骤五清理资源 class=hash-link aria-label="Direct link to 步骤五：清理资源" title="Direct link to 步骤五：清理资源">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 删除Job（会自动清理所有相关Pod和Service）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl delete </span><span class="token parameter variable" style=color:#f8f8f2>-f</span><span class="token plain"> pytorch-job-with-configmap.yaml</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 删除ConfigMap</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl delete configmap pytorch-demo-script</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/ai/pytorch-intro><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>PyTorch框架介绍</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/ai/kubeflow-trainer-in-hpc><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Kubeflow Trainer In HPC</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#volcano-pytorch-plugin是什么 class="table-of-contents__link toc-highlight">Volcano PyTorch Plugin是什么</a><ul><li><a href=#volcano简介 class="table-of-contents__link toc-highlight">Volcano简介</a><li><a href=#pytorch-plugin定位 class="table-of-contents__link toc-highlight">PyTorch Plugin定位</a><li><a href=#通俗理解 class="table-of-contents__link toc-highlight">通俗理解</a></ul><li><a href=#pytorch-plugin解决什么问题 class="table-of-contents__link toc-highlight">PyTorch Plugin解决什么问题</a><ul><li><a href=#主要解决的问题 class="table-of-contents__link toc-highlight">主要解决的问题</a><li><a href=#plugin工作原理 class="table-of-contents__link toc-highlight">Plugin工作原理</a></ul><li><a href=#如何安装和配置 class="table-of-contents__link toc-highlight">如何安装和配置</a><ul><li><a href=#前置条件 class="table-of-contents__link toc-highlight">前置条件</a><li><a href=#安装volcano class="table-of-contents__link toc-highlight">安装Volcano</a><li><a href=#配置参数说明 class="table-of-contents__link toc-highlight">配置参数说明</a></ul><li><a href=#pytorch分布式训练示例 class="table-of-contents__link toc-highlight">PyTorch分布式训练示例</a><ul><li><a href=#脚本示例 class="table-of-contents__link toc-highlight">脚本示例</a><li><a href=#部署步骤 class="table-of-contents__link toc-highlight">部署步骤</a></ul></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2026 johng.cn</div></div></div></footer></div>