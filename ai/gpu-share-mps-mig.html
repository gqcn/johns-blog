<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/AI技术/NVIDIA/GPU Share MPS&MIG具体操作步骤" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>GPU Share MPS&MIG具体操作与注意事项 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/ai/gpu-share-mps-mig><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="GPU Share MPS&MIG具体操作与注意事项 | John's Blog"><meta data-rh=true name=description content="详细介绍NVIDIA GPU共享技术MPS和MIG的原理、优缺点、适用场景以及在Kubernetes环境中的具体配置和操作步骤，帮助用户实现GPU资源的高效利用"><meta data-rh=true property=og:description content="详细介绍NVIDIA GPU共享技术MPS和MIG的原理、优缺点、适用场景以及在Kubernetes环境中的具体配置和操作步骤，帮助用户实现GPU资源的高效利用"><meta data-rh=true name=keywords content="GPU共享,MPS,MIG,NVIDIA,GPU虚拟化,Kubernetes,GPU Operator,资源隔离,多租户,高性能计算"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/ai/gpu-share-mps-mig><link data-rh=true rel=alternate href=https://johng.cn/ai/gpu-share-mps-mig hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/ai/gpu-share-mps-mig hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><script src=https://cdn.wwads.cn/js/makemoney.js async></script><link rel=stylesheet href=/assets/css/styles.208c11f9.css><script src=/assets/js/runtime~main.2980ef1a.js defer></script><script src=/assets/js/main.01697419.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" sidebarid=mainSidebar href=/ai>AI技术</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/cloud-native>云原生</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/notes>日常笔记</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/programming>开发语言</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/architecture>技术架构</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/observability>可观测性</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" href=/aboutme>关于我</a></div><div class="navbar__items navbar__items--right"><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/ai>AI技术</a><button aria-label="Collapse sidebar category 'AI技术'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/ai/nvidia>NVIDIA</a><button aria-label="Collapse sidebar category 'NVIDIA'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/gpu-operator>GPU Operator</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/gpu-dcgm-exporter>GPU DCGM-Exporter监控方案</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/ai/gpu-share-mps-mig>GPU Share MPS&MIG具体操作与注意事项</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/gpu-mig-docker-specify-subcard>GPU MIG拆卡后使用docker指定子卡执行</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/gpu-mig-pod-pending-terminating-troubleshooting>GPU MIG拆卡后Pod偶发Pending/Terminating状态阻塞问题排查</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/gpu-environment-setup-guide>GPU环境搭建指南：在裸机、Docker、K8S环境中使用GPU</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/distributed-inference>分布式推理</a><button aria-label="Expand sidebar category '分布式推理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/scheduling>算力资源调度</a><button aria-label="Expand sidebar category '算力资源调度'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ai/nfd-gfd>NFD&GFD</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ai/common-acceleration-cards>常见智算加速卡汇总</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ai/rdma>RDMA技术架构深度解析</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ai/general-ai-model-and-reasoning-ai-model-difference>通用大模型和推理大模型区别</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ai/common-ai-model-training-inference-framework>常见AI模型训练推理框架对比</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ai/ai-training-inference-scenarios>AI模型训练推理常见业务场景痛点</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/cloud-native>云原生</a><button aria-label="Expand sidebar category '云原生'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai><span itemprop=name>AI技术</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai/nvidia><span itemprop=name>NVIDIA</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>GPU Share MPS&MIG具体操作与注意事项</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=1-基本介绍>1. 基本介绍<a href=#1-基本介绍 class=hash-link aria-label="Direct link to 1. 基本介绍" title="Direct link to 1. 基本介绍">​</a></h2>
<p><strong>MPS</strong>：<code>MPS</code>是<code>NVIDIA</code>官方的<code>CUDA</code>应用编程接口，是<code>CUDA</code>应用程序编程接口的一种可替代、二进制兼容的实现方式，以利用<code>NVIDIA GPU</code>的<code>Hyper-Q</code>功能，允许<code>CUDA</code>内核在同一个<code>GPU</code>上并发处理：<a href=https://docs.nvidia.com/deploy/mps/index.html target=_blank rel="noopener noreferrer">https://docs.nvidia.com/deploy/mps/index.html</a></p>
<p><strong>MIG</strong>：<code>Multi-Instance GPU (MIG)</code> 是<code>NVIDIA</code>针对<code>Ampere</code>架构之后和的系列卡推出的<code>GPU</code>虚拟化技术，它实现了物理卡的拆分，可以将一张<code>GPU</code>，按照特定规格拆分成多个子实例：<a href=https://docs.nvidia.com/datacenter/tesla/mig-user-guide/index.html target=_blank rel="noopener noreferrer">https://docs.nvidia.com/datacenter/tesla/mig-user-guide/index.html</a></p>
<p><code>MPS</code>与<code>MIG</code>技术对比：</p>
<table><thead><tr><th>特性<th>MPS (Multi-Process Service)<th>MIG (Multi-Instance GPU)<tbody><tr><td>隔离级别<td>软件级隔离<td>硬件级隔离<tr><td>资源分配<td>动态分配，共享计算单元<td>静态分配，独立计算单元<tr><td>故障传播<td>存在故障传播风险<td>完全隔离，无故障传播<tr><td>灵活性<td>高，可动态调整资源分配<td>低，需要预先定义分区方案<tr><td>部署复杂度<td>较低，软件配置即可<td>较高，需要完全驱逐业务后操作<tr><td>支持的<code>GPU</code><td>计算能力 <code>>= 3.5</code>的<code>GPU</code><td>仅<code>Ampere</code>架构及之后的特定<code>GPU</code><tr><td>适用场景<td>多副本推理服务、小模型训练<td>多租户环境、需要强隔离的业务</table>
<p><img decoding=async loading=lazy alt="alt text" src=/assets/images/image-617e925e4bb9a7ef8866203d124605b7.png width=1968 height=954 class=img_ev3q></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=2-mps拆卡方案>2. MPS拆卡方案<a href=#2-mps拆卡方案 class=hash-link aria-label="Direct link to 2. MPS拆卡方案" title="Direct link to 2. MPS拆卡方案">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=21-依赖与限制>2.1 依赖与限制<a href=#21-依赖与限制 class=hash-link aria-label="Direct link to 2.1 依赖与限制" title="Direct link to 2.1 依赖与限制">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=211-环境依赖>2.1.1 环境依赖<a href=#211-环境依赖 class=hash-link aria-label="Direct link to 2.1.1 环境依赖" title="Direct link to 2.1.1 环境依赖">​</a></h4>
<ul>
<li>资源限制</li>
<li>仅支持<code>Linux</code>系统</li>
<li>不管进程的GPU资源独占设置。MPS控制守护进程会对来自不同用户的请求进行排队访问的</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=212-部署依赖>2.1.2 部署依赖<a href=#212-部署依赖 class=hash-link aria-label="Direct link to 2.1.2 部署依赖" title="Direct link to 2.1.2 部署依赖">​</a></h4>
<ul>
<li>需要依赖<code>GPU Operator</code>组件。</li>
<li><code>Kubernetes</code>版本要求 <code>1.22-1.29</code>（<code>GPU Operator</code>）要求。</li>
<li>需要完全解除<code>GPU</code>占用，需要驱逐所有的<code>GPU</code>使用<code>POD</code>（建议驱逐节点上所有的<code>POD</code>）。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=22-优缺点分析>2.2 优缺点分析<a href=#22-优缺点分析 class=hash-link aria-label="Direct link to 2.2 优缺点分析" title="Direct link to 2.2 优缺点分析">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=优势>优势<a href=#优势 class=hash-link aria-label="Direct link to 优势" title="Direct link to 优势">​</a></h4>
<ol>
<li>由于它在单卡上跑多服务，能有效提高单卡的<code>GPU</code>利用率和吞吐量。</li>
<li>拆分相对轻量，只是纯软件层的配置即可。</li>
<li>相对于直接单卡跑多服务，在开启<code>MPS</code>的卡上基于<code>container</code>跑多服务，能进行算力和显存限制，多服务间<code>QoS</code>得到保障，同时避免了单卡多服务的<code>GPU</code>上下文切换的开销</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=劣势>劣势<a href=#劣势 class=hash-link aria-label="Direct link to 劣势" title="Direct link to 劣势">​</a></h4>
<ol>
<li>因为多个进程共享<code>Cuda Context</code>,故存在故障传播问题，当其中一个连接客户端出现错误时，会传播到其他<code>Context</code>。</li>
<li>在某些特定情况下，多个<code>MPS</code>客户端进程可能会互相影响，官方建议一般应用于单个应用的主进程和他的协作进程。</li>
<li><code>MPS</code>的多个客户端进程都具有完全隔离的<code>GPU</code>地址空间，是从主进程的同一个<code>GPU</code>虚拟地址空间分区分配的，如果进程越界访问内存，可能不会触发访问错误，而是访问到了别的进程的内存空间。</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=适用场景>适用场景<a href=#适用场景 class=hash-link aria-label="Direct link to 适用场景" title="Direct link to 适用场景">​</a></h4>
<p>考虑到故障传播的问题，通常用它来部署多副本的推理服务、小模型。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=23-如何识别gpu卡是否支持mps>2.3 如何识别GPU卡是否支持MPS<a href=#23-如何识别gpu卡是否支持mps class=hash-link aria-label="Direct link to 2.3 如何识别GPU卡是否支持MPS" title="Direct link to 2.3 如何识别GPU卡是否支持MPS">​</a></h3>
<p><code>MPS</code>要求 <code>nvidia.com/gpu.compute.major</code> 计算能力版本 <code>>= 3.5</code> (查询地址 <a href=https://developer.nvidia.com/cuda-gpus target=_blank rel="noopener noreferrer">https://developer.nvidia.com/cuda-gpus</a> ）几乎主流卡都支持。具体查看节点标签内容：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">ada</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token number" style=color:#ae81ff>4090</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu-driver-upgrade-state</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pod</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">restart</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">required</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.compute.major</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8"</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic># 计算能力主版本</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.compute.minor</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"9"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.count</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.family</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ampere</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.machine</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> R8428</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">G13</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"24564"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.present</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.product</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">GeForce</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">RTX</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token number" style=color:#ae81ff>4090</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.sharing-strategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mps</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig.capable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"false"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig.config</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> all</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">disabled</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mps.capable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=24-特性的启用流程>2.4 特性的启用流程<a href=#24-特性的启用流程 class=hash-link aria-label="Direct link to 2.4 特性的启用流程" title="Direct link to 2.4 特性的启用流程">​</a></h3>
<p>安装完成<code>GPU Operator</code>后，默认情况下所有节点的<code>MPS</code>特性是关闭的，可以看到带有<code>GPU</code>卡机器的标签值为<code>nvidia.com/mps.capable=false</code>。<code>MPS</code>特性需要通过配置文件为当前节点启用<code>MPS</code>策略后才能开启。以下是具体操作步骤：</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=241-确认gpu卡的机器节点标签>2.4.1 确认GPU卡的机器节点标签<a href=#241-确认gpu卡的机器节点标签 class=hash-link aria-label="Direct link to 2.4.1 确认GPU卡的机器节点标签" title="Direct link to 2.4.1 确认GPU卡的机器节点标签">​</a></h4>
<p>默认情况下<code>MPS</code>特性是关闭的。</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.count</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.family</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ampere</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.machine</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> R8428</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">G13</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"24564"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.present</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.product</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">GeForce</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">RTX</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token number" style=color:#ae81ff>4090</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.sharing-strategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mps</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig.capable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"false"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig.config</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> all</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">disabled</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mps.capable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"false"</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic># MPS特性未开启</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=242-确定mps使用的配置项名称>2.4.2 确定MPS使用的配置项名称<a href=#242-确定mps使用的配置项名称 class=hash-link aria-label="Direct link to 2.4.2 确定MPS使用的配置项�名称" title="Direct link to 2.4.2 确定MPS使用的配置项名称">​</a></h4>
<p>通过节点标签中的<code>nvidia.com/device-plugin.config: default</code>可以得知具体的配置项名称为<code>default</code>。</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/device-plugin.config</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> default </span><span class="token comment" style=color:#8292a2;font-style:italic># device plugin配置项名称</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gfd.timestamp</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1748575819"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">ada</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token number" style=color:#ae81ff>4090</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.compute.major</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.compute.minor</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"9"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.count</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>DevicePlugin</code>的具体配置默认是通过<code>device-plugin-config</code>来管理的：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ kubectl get cm </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> gpu-operator</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">NAME                                                  DATA   AGE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">custom-mig-parted-config                              </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">      346d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">default-gpu-clients                                   </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">      347d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">default-mig-parted-config                             </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">      347d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">device-plugin-config                                  </span><span class="token number" style=color:#ae81ff>52</span><span class="token plain">     346d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">gpu-clients                                           </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">      259d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kube-root-ca.crt                                      </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">      347d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-container-toolkit-entrypoint                   </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">      347d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-dcgm-exporter                                  </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">      247d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-device-plugin-entrypoint                       </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">      347d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-mig-manager-entrypoint                         </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">      347d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-master-conf             </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">      347d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-topology-updater-conf   </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">      347d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-worker-conf             </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">      347d</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>该<code>ConfigMap</code>是在<code>nvidia-device-plugin-daemonset</code>中作为配置文件挂载进去的：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ kubectl get pod </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> gpu-operator</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">NAME                                                    READY   STATUS      RESTARTS       AGE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">gpu-feature-discovery-jztwz                             </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">/2     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              22h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">gpu-operator-699bc5544b-885lt                           </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>15</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">59d ago</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">   129d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">node-agent-96wx8                                        </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              23h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-container-toolkit-daemonset-d7j66                </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              23h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-cuda-validator-zhp78                             </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">/1     Completed   </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              23h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-dcgm-exporter-bgpbh                              </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              23h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-device-plugin-daemonset-rcgf9                    </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">/2     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              23h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-device-plugin-mps-control-daemon-mzbh9           </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">/2     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              5h23m</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-operator-validator-c5m8f                         </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              23h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-gc-85f45bc45-gxwj6        </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              78d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-master-7dc854f47f-67cwd   </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              78d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-worker-2tkjp              </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>23</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">59d ago</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">   77d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-worker-k4pz5              </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>23</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">59d ago</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">   77d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-worker-kzkvq              </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              23h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-worker-qjprr              </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>23</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">59d ago</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">   77d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-worker-xn6sl              </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>25</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">59d ago</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">   77d</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>describe</code>一下这个<code>nvidia-device-plugin-daemonset-rcgf9</code>可以看到具体的配置卷挂载声明：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl get pod </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> gpu-operator nvidia-device-plugin-daemonset-rcgf9 </span><span class="token parameter variable" style=color:#f8f8f2>-oyaml</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">volumes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">configMap</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">defaultMode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>448</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">plugin</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">entrypoint</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">plugin</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">entrypoint</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">hostPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">path</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /var/lib/kubelet/device</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">plugins</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> device</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">plugin</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">hostPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">path</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /run/nvidia</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Directory</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> run</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nvidia</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">hostPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">path</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> host</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">root</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">hostPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">path</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /var/run/cdi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> DirectoryOrCreate</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> cdi</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">root</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">hostPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">path</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /run/nvidia/mps</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> DirectoryOrCreate</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mps</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">root</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">hostPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">path</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /run/nvidia/mps/shm</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mps</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">shm</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">configMap</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">defaultMode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>420</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> device</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">plugin</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">config </span><span class="token comment" style=color:#8292a2;font-style:italic># 挂载的ConfigMap名称</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> device</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">plugin</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">config</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=243-添加mps拆卡配置项>2.4.3 添加MPS拆卡配置项<a href=#243-添加mps拆卡配置项 class=hash-link aria-label="Direct link to 2.4.3 添加MPS拆卡配置项" title="Direct link to 2.4.3 添加MPS拆卡配置项">​</a></h4>
<p>查看<code>device-plugin-config</code>的配置内容：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl get cm </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> gpu-operator device-plugin-config </span><span class="token parameter variable" style=color:#f8f8f2>-oyaml</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>可以看到节点标签<code>nvidia.com/device-plugin.config: default</code>中关联的<code>default</code>配置项是没有开启<code>MPS</code>特性的：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">data</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认配置项</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">default</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">version</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">flags</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">migStrategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> none</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">mig-mixed</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">version</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">flags</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">migStrategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mixed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">mig-single</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">version</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">flags</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">migStrategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> single</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>我们增加一项配置项<code>test-sharing</code>，该配置项用于特定的拆卡策略：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">data</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认配置项</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">default</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">version</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">flags</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">migStrategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> none</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">mig-mixed</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">version</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">flags</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">migStrategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mixed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">mig-single</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">version</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">flags</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">migStrategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> single</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 新增配置项用于测试MPS</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">test-sharing</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">version</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">sharing</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">mps</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">renameByDefault</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia.com/gpu</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>3</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">devices</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"0"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"3"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>随后修改<code>GPU</code>卡的机器标签，将该配置项名称修改到<code>nvidia.com/device-plugin.config</code>中，修改后为<code>nvidia.com/device-plugin.config:test-sharing</code>:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/device-plugin.config</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> test</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">sharing </span><span class="token comment" style=color:#8292a2;font-style:italic># 修改该配置项名称</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gfd.timestamp</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1748575819"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvidia</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">ada</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token number" style=color:#ae81ff>4090</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.compute.major</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.compute.minor</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"9"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.count</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>保存后，不一会儿你再查询节点信息时，会发现节点上<code>nvidia.com/mps.capable</code>标签的值从<code>false</code>自动变为了<code>true</code>：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.count</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.family</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ampere</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.machine</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> R8428</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">G13</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"24564"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.present</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.product</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">GeForce</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">RTX</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token number" style=color:#ae81ff>4090</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.sharing-strategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mps</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig.capable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"false"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig.config</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> all</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">disabled</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mps.capable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic># 该节点标签被自动更新为true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>同时会看到在<code>gpu-operator</code>命名空间下自动增加了一个<code>MPS</code>的控制器<code>nvidia-device-plugin-mps-control-daemon-mzbh9</code>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ kubectl get pod </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> gpu-operator</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">NAME                                                    READY   STATUS      RESTARTS       AGE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">gpu-feature-discovery-jztwz                             </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">/2     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              22h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">gpu-operator-699bc5544b-885lt                           </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>15</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">59d ago</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">   129d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">node-agent-96wx8                                        </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              23h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-container-toolkit-daemonset-d7j66                </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              23h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-cuda-validator-zhp78                             </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">/1     Completed   </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              23h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-dcgm-exporter-bgpbh                              </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              23h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-device-plugin-daemonset-rcgf9                    </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">/2     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              23h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-device-plugin-mps-control-daemon-mzbh9           </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">/2     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              5h23m</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-operator-validator-c5m8f                         </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              23h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-gc-85f45bc45-gxwj6        </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              78d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-master-7dc854f47f-67cwd   </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              78d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-worker-2tkjp              </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>23</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">59d ago</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">   77d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-worker-k4pz5              </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>23</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">59d ago</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">   77d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-worker-kzkvq              </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              23h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-worker-qjprr              </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>23</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">59d ago</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">   77d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">stable-node-feature-discovery-worker-xn6sl              </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>25</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">59d ago</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">   77d</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=25-如何对节点gpu进行mps拆卡>2.5 如何对节点GPU进行MPS拆卡<a href=#25-如何对节点gpu进行mps拆卡 class=hash-link aria-label="Direct link to 2.5 如何对节点GPU进行MPS拆卡" title="Direct link to 2.5 如何对节点GPU进行MPS拆卡">​</a></h4>
<p>拆卡的原理实际上就是修改<code>device-plugin-config</code>配置文件，通过手动或者程序自动增加/修改对应的配置项，随后修改对应机器节点的<code>nvidia.com/device-plugin.config</code>标签值即可。
拆卡完成后，在节点上会增加<code>nvidia.com/gpu.share</code>的资源类型，随后训练推理任务在申请资源时可申请该类型的资源。</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">Capacity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">                    </span><span class="token number" style=color:#ae81ff>128</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">ephemeral-storage</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">      575546624Ki</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">hugepages-1Gi</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">          </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">hugepages-2Mi</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">          </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">                 263234272Ki</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">         </span><span class="token number" style=color:#ae81ff>7</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">nvidia.com/gpu.shared</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">  </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic># 新增资源类型</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">pods</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">                   </span><span class="token number" style=color:#ae81ff>110</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">rdma/hca_ib_dev</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">        </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">Allocatable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">                    127600m</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">ephemeral-storage</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">      575546624Ki</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">hugepages-1Gi</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">          </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">hugepages-2Mi</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">          </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">                 </span><span class="token number" style=color:#ae81ff>255550011601</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">         </span><span class="token number" style=color:#ae81ff>7</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">nvidia.com/gpu.shared</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">  </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic># 新增资源类型</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">pods</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">                   </span><span class="token number" style=color:#ae81ff>110</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">rdma/hca_ib_dev</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">        </span><span class="token number" style=color:#ae81ff>0</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=3-mig拆卡方案>3. MIG拆卡方案<a href=#3-mig拆卡方案 class=hash-link aria-label="Direct link to 3. MIG拆卡方案" title="Direct link to 3. MIG拆卡方案">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=31-依赖与限制>3.1 依赖与限制<a href=#31-依赖与限制 class=hash-link aria-label="Direct link to 3.1 依赖与限制" title="Direct link to 3.1 依赖与限制">​</a></h3>
<ul>
<li>需要依赖<code>GPU Operator</code>组件。</li>
<li><code>Kubernetes</code>版本要求 <code>1.22-1.29</code>（<code>GPU Operator</code>）要求。</li>
<li>需要完全解除<code>GPU</code>占用，需要驱逐所有的<code>GPU</code>使用<code>POD</code>（建议驱逐节点上所有的<code>POD</code>）。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=32-优缺点分析>3.2 优缺点分析<a href=#32-优缺点分析 class=hash-link aria-label="Direct link to 3.2 优缺点分析" title="Direct link to 3.2 优缺点分析">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=优势-1>优势<a href=#优势-1 class=hash-link aria-label="Direct link to 优势" title="Direct link to 优势">​</a></h4>
<ol>
<li>每个实例都有自己的内存和计算单元，资源隔离性好，不会存在故障传播的问题。</li>
<li>多租户场景下，其隔离性强，更适合业务。</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=劣势-1>劣势<a href=#劣势-1 class=hash-link aria-label="Direct link to 劣势" title="Direct link to 劣势">​</a></h4>
<ol>
<li>灵活性相对差，每种卡只支持特定规格的切分策略。</li>
<li>切分动作较“重”，切分需要完全驱逐业务，解除内核占用后才可以操作。</li>
<li>对卡有要求，只支持<code>Ampere</code>架构和它之后推出的卡型号（特定卡，不是所有<code>Ampere</code>都支持）</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=注意>注意<a href=#注意 class=hash-link aria-label="Direct link to 注意" title="Direct link to 注意">​</a></h4>
<ol>
<li><code>Ampere</code>机构下，如果开启了<code>MIG</code>，机器重启后<code>MIG</code>的设置也会存在</li>
<li><code>H100</code>系列 需要<code>cuda > 12/R525</code></li>
<li><code>A100</code> <code>A30</code>系列需要<code>cuda > 11/R450</code></li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=适用场景-1>适用场景<a href=#适用场景-1 class=hash-link aria-label="Direct link to 适用场景" title="Direct link to 适用场景">​</a></h4>
<p><code>QoS</code>要求高，隔离性强的业务。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=33-如何识别gpu卡是否支持mig>3.3 如何识别GPU卡是否支持MIG<a href=#33-如何识别gpu卡是否支持mig class=hash-link aria-label="Direct link to 3.3 如何识别GPU卡是否支持MIG" title="Direct link to 3.3 如何识别GPU卡是否支持MIG">​</a></h3>
<p>可以参考<code>GPU Operator</code>的源码：<a href=https://github.com/NVIDIA/gpu-operator/blob/main/assets/state-mig-manager/0400_configmap.yaml target=_blank rel="noopener noreferrer">https://github.com/NVIDIA/gpu-operator/blob/main/assets/state-mig-manager/0400_configmap.yaml</a></p>
<p><img decoding=async loading=lazy alt="alt text" src=/assets/images/image-1-c6f542d6a3d58c6f1e92abe57889a480.png width=1280 height=755 class=img_ev3q></p>
<p>里面有大概型号名称的注释以及十六进制型号编码，但是需要和<code>nvidia.com/gpu.product</code>配置对应的话，名称会存在一定差异不太好做自动化识别。前期可以做配置文件，将企业用到的卡型号配置进去进行识别；后续可以通过脚本识别底层<code>GPU</code>卡十六进制编号，并自动打标到节点上。
使用<code>nvidia-smi</code>工具识别<code>GPU</code>设备十六进制型号的命令：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-smi </span><span class="token parameter variable" style=color:#f8f8f2>-q</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-x</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'&lt;pci_device_id>'</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>sed</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'s/.*&lt;pci_device_id>\(.*\)&lt;\/pci_device_id>.*/\1/'</span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>uniq</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=34-特性的启用流程>3.4 特性的启用流程<a href=#34-特性的启用流程 class=hash-link aria-label="Direct link to 3.4 特性的启用流程" title="Direct link to 3.4 特性的启用流程">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=341-确认gpu卡的机器节点标签>3.4.1 确认GPU卡的机器节点标签<a href=#341-确认gpu卡的机器节点标签 class=hash-link aria-label="Direct link to 3.4.1 确认GPU卡的机器节点标签" title="Direct link to 3.4.1 确认GPU卡的机器节点标签">​</a></h4>
<p>查看节点标签，可以看到<code>nvidia.com/mig.capable: "false"</code>表示没有启用<code>MIG</code>特性：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.family</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> hopper</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.machine</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> OpenStack</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">Nova</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"97871"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.present</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.product</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">H20</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/gpu.sharing-strategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> none</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig.capable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"false"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig.config</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> all</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">disabled</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 省略...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=342-确定mig使用的配置项名称>3.4.2 确定MIG使用的配置项名称<a href=#342-确定mig使用的配置项名称 class=hash-link aria-label="Direct link to 3.4.2 确定MIG使用的配置项名称" title="Direct link to 3.4.2 确定MIG使用的配置项名称">​</a></h4>
<p>查询<code>clusterpolicy</code>，并查看其中对于<code>mig</code>配置项的名称</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl get clusterpolicy </span><span class="token parameter variable" style=color:#f8f8f2>-oyaml</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>在输出的<code>yaml</code>中的以下配置展示了<code>MIG</code>主要的配置内容，其中<code>default-mig-parted-config</code>即是<code>MIG</code>特性对应的<code>ConfigMap</code>名称：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 省略 ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">mig</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">strategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> single </span><span class="token comment" style=color:#8292a2;font-style:italic># single 全部卡一样，mixed 可以拆不同的卡</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">migManager</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">config</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">default</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> all</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">disabled </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认策略</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> default</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mig</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">parted</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">config </span><span class="token comment" style=color:#8292a2;font-style:italic># 自定义的profile配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">enabled</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> WITH_REBOOT </span><span class="token comment" style=color:#8292a2;font-style:italic># 配置后是否重启</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"false"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">gpuClientsConfig</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> k8s</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mig</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">manager</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> IfNotPresent</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">repository</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> nvcr.io/nvidia/cloud</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">native</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">version</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v0.12.1</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">ubuntu20.04</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 省略 ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=343-修改mig全局配置文件>3.4.3 修改MIG全局配置文件<a href=#343-修改mig全局配置文件 class=hash-link aria-label="Direct link to 3.4.3 修改MIG全局配置文件" title="Direct link to 3.4.3 修改MIG全局配置文件">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=3431-device-plugin-config>3.4.3.1 device-plugin-config<a href=#3431-device-plugin-config class=hash-link aria-label="Direct link to 3.4.3.1 device-plugin-config" title="Direct link to 3.4.3.1 device-plugin-config">​</a></h5>
<p>执行以下命令查看<code>device plugin</code>的配置内容中是否存在<code>mig-mixed</code>的配置项，如果没有则添加该配置：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl get cm </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> gpu-operator device-plugin-config </span><span class="token parameter variable" style=color:#f8f8f2>-oyaml</span><span class="token plain"> </span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>mig-mixed</code>的配置项内容如下：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 省略 ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">mig-mixed</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">version</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">flags</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">migStrategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mixed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 省略 ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=3432-clusterpolicy>3.4.3.2 clusterpolicy<a href=#3432-clusterpolicy class=hash-link aria-label="Direct link to 3.4.3.2 clusterpolicy" title="Direct link to 3.4.3.2 clusterpolicy">​</a></h5>
<p>修改<code>clusterpolicy</code>中的相关配置内容如下：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 省略 ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">mig</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">strategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mixed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">migManager</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">config</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">default</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> all</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">disabled</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> custom</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mig</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">parted</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">config</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">enabled</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> WITH_REBOOT</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"false"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">gpuClientsConfig</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> k8s</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mig</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">manager</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> IfNotPresent</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">repository</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> harbor.hl.zkj.local/pa/mirror</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">stuff/nvidia/cloud</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">native</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">version</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v0.7.0</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">ubuntu20.04</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 省略 ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>clusterpolicy</code>中的<code>default-mig-parted-config</code>是对应的<code>ConfigMap</code>名称，我这里修改为了自定义的名称<code>custom-mig-parted-config</code>。</p>
<p>与<code>MPS</code>特性类似，<code>MIG</code>特性只有增加拆卡配置并且为特定<code>GPU</code>卡节点标签添加对应配置项名称关联后才会真实启用。我们继续看看如何配置<code>MIG</code>拆卡内容。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=35-如何对节点gpu进行mig拆卡>3.5 如何对节点GPU进行MIG拆卡<a href=#35-如何对节点gpu进行mig拆卡 class=hash-link aria-label="Direct link to 3.5 如何对节点GPU进行MIG拆卡" title="Direct link to 3.5 如何对节点GPU进行MIG拆卡">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=351-查看现有mig配置内容>3.5.1 查看现有MIG配置内容<a href=#351-查看现有mig配置内容 class=hash-link aria-label="Direct link to 3.5.1 查看现有MIG配置内容" title="Direct link to 3.5.1 查看现有MIG配置内容">​</a></h4>
<p>查看<code>custom-mig-parted-config</code>配置项内容：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl get cm </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> gpu-operator custom-mig-parted-config </span><span class="token parameter variable" style=color:#f8f8f2>-oyaml</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>输出内容如下：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ConfigMap</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">creationTimestamp</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2024-12-05T06:16:49Z"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> custom</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mig</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">parted</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">config</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> gpu</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">operator</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">resourceVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"15465565"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">uid</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> b9d510b5</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">98b2</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">4a6a</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">8f9a</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">f045485e96ff</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">data</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">config.yaml</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>|</span><span class="token scalar string" style=color:#a6e22e></span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>    version: v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>    mig-configs:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>        all-1g.5gb:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>            - devices: all</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>              mig-enabled: true</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>              mig-devices:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>                1g.5gb: 7</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>        all-1g.5gb.me:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>            - devices: all</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>              mig-enabled: true</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>              mig-devices:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>                1g.5gb+me: 1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>        all-1g.6gb:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>            - devices: all</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>              mig-enabled: true</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>              mig-devices:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>                1g.6gb: 4</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>        all-1g.6gb.me:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>            - devices: all</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>              mig-enabled: true</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>              mig-devices:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token scalar string" style=color:#a6e22e>                1g.6gb+me: 1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 省略 ... 还有很多</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>其实这个配置文件是默认的<code>MIG</code>拆卡配置，可以参考<code>GPU Operator</code>的源码：<a href=https://github.com/NVIDIA/gpu-operator/blob/main/assets/state-mig-manager/0400_configmap.yaml target=_blank rel="noopener noreferrer">https://github.com/NVIDIA/gpu-operator/blob/main/assets/state-mig-manager/0400_configmap.yaml</a></p>
<p>拆卡设备名称规则：
<img decoding=async loading=lazy alt="alt text" src=/assets/images/image-2-79a5ae4d49f5bee3ec5a7c8be8a7af7a.png width=828 height=216 class=img_ev3q></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=352-增加自定义mig拆卡内容>3.5.2 增加自定义MIG拆卡内容<a href=#352-增加自定义mig拆卡内容 class=hash-link aria-label="Direct link to 3.5.2 增加自定义MIG拆卡内容" title="Direct link to 3.5.2 增加自定义MIG拆卡内容">​</a></h4>
<p>我们在<code>custom-mig-parted-config</code>这个<code>ConfigMap</code>内容的最末尾增加一个自定义的<code>MIG</code>拆卡配置，该配置的变更可以手动但通常是由程序自动更新完成：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 省略 ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">zkj-pa-uat-gpu-004</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">devices</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token number" style=color:#ae81ff>3</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">mig-enabled</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">mig-devices</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">1g.12gb</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">1g.24gb</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">3g.48gb</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 省略 ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这个节点上本来有<code>8</code>张<code>NVIDIA-H20</code>的<code>GPU</code>卡，这个配置项表示将其中索引为<code>3</code>的<code>GPU</code>卡拆为<code>4</code>张虚拟卡：<code>2</code>张<code>1g.12gb</code>、<code>1</code>张<code>1g.24gb</code>、<code>1</code>张<code>3g.48gb</code>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=353-为节点增加拆卡配置项关联>3.5.3 为节点增加拆卡配置项关联<a href=#353-为节点增加拆卡配置项关联 class=hash-link aria-label="Direct link to 3.5.3 为节点增加拆卡配置项关联" title="Direct link to 3.5.3 为节点增加拆卡配置项关联">​</a></h4>
<p>与<code>MIG</code>特性相关的机器节点标签如下：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">nvidia.com/device-plugin.config</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> default</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig.config</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> all</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">disabled</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>修改为以下内容：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">nvidia.com/device-plugin.config</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mig</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mixed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig.config</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> zkj</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pa</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">uat</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">gpu</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token number" style=color:#ae81ff>004</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>保存退出后不久，节点的标签会被<code>MIG</code>控制器更新为如下内容：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">nvidia.com/mig-1g.12gb.count</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.12gb.engines.copy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.12gb.engines.decoder</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.12gb.engines.encoder</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"0"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.12gb.engines.jpeg</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.12gb.engines.ofa</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"0"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.12gb.memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"12032"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.12gb.multiprocessors</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.12gb.product</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">H20</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">MIG</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">1g.12gb</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.12gb.replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.12gb.sharing-strategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> none</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.12gb.slices.ci</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.12gb.slices.gi</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.24gb.count</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.24gb.engines.copy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.24gb.engines.decoder</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.24gb.engines.encoder</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"0"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.24gb.engines.jpeg</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.24gb.engines.ofa</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"0"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.24gb.memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"24192"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.24gb.multiprocessors</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"8"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.24gb.product</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">H20</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">MIG</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">1g.24gb</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.24gb.replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.24gb.sharing-strategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> none</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.24gb.slices.ci</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.24gb.slices.gi</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-3g.48gb.count</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-3g.48gb.engines.copy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"3"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-3g.48gb.engines.decoder</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"3"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-3g.48gb.engines.encoder</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"0"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-3g.48gb.engines.jpeg</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"3"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-3g.48gb.engines.ofa</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"0"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-3g.48gb.memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"48512"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-3g.48gb.multiprocessors</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"32"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-3g.48gb.product</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">H20</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">MIG</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">3g.48gb</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-3g.48gb.replicas</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-3g.48gb.sharing-strategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> none</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-3g.48gb.slices.ci</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"3"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-3g.48gb.slices.gi</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"3"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig.capable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"true"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig.config</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> zkj</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">pa</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">uat</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">gpu</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token number" style=color:#ae81ff>004</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig.config.state</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> success</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig.strategy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mixed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mps.capable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"false"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>可以看到<code>MIG</code>特性在该机器节点上被成功启用，拆卡的配置信息也被自动更新到了节点标签上。
同时该节点上的资源类型也新增了如下几个：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">allocatable</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"128"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">ephemeral-storage</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"96626364666"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">hugepages-1Gi</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"0"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">hugepages-2Mi</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"0"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 1056189400Ki</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"7"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">nvidia.com/mig-1g.12gb</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">nvidia.com/mig-1g.24gb</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">nvidia.com/mig-3g.48gb</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">pods</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"110"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">capacity</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"128"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">ephemeral-storage</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 104846316Ki</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">hugepages-1Gi</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"0"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">hugepages-2Mi</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"0"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> 1056291800Ki</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"7"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">nvidia.com/mig-1g.12gb</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">nvidia.com/mig-1g.24gb</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">nvidia.com/mig-3g.48gb</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">pods</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"110"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>其中这几项便是新增的资源类型，创建训练推理任务时便可以按照这些资源类型申请使用拆卡资源：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">nvidia.com/mig-1g.12gb</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-1g.24gb</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">nvidia.com/mig-3g.48gb</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"1"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=4-注意事项>4. 注意事项<a href=#4-注意事项 class=hash-link aria-label="Direct link to 4. 注意事项" title="Direct link to 4. 注意事项">​</a></h2>
<ol>
<li>
<p>在<code>MPS</code>拆卡中，<code>failRequestsGreaterThanOne</code>参数配置默认为<code>true</code>(无法配置)，因此在使用<code>nvidia.com/gpu.shared</code>资源时，如果申请的资源数量大于<code>1</code>，则会导致请求失败，具体请参考<code>GitHub</code>首页介绍：<a href=https://github.com/NVIDIA/k8s-device-plugin target=_blank rel="noopener noreferrer">https://github.com/NVIDIA/k8s-device-plugin</a></p>
</li>
<li>
<p><code>MIG</code>拆卡会引发<code>GPU Pod</code>的重启，甚至<code>Node</code>的重启，具体请参考官方文档：<a href=https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/gpu-operator-mig.html target=_blank rel="noopener noreferrer">https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/gpu-operator-mig.html</a></p>
<blockquote>
<p>MIG Manager is designed as a controller within Kubernetes. It watches for changes to the nvidia.com/mig.config label on the node and then applies the user-requested MIG configuration When the label changes, MIG Manager first stops all GPU pods, including device plugin, GPU feature discovery, and DCGM exporter. MIG Manager then stops all host GPU clients listed in the clients.yaml config map if drivers are preinstalled. Finally, it applies the MIG reconfiguration and restarts the GPU pods and possibly, host GPU clients. The MIG reconfiguration can also involve rebooting a node if a reboot is required to enable MIG mode.</p>
<p>The default MIG profiles are specified in the default-mig-parted-config config map. You can specify one of these profiles to apply to the mig.config label to trigger a reconfiguration of the MIG geometry.</p>
<p>MIG Manager uses the mig-parted tool to apply the configuration changes to the GPU, including enabling MIG mode, with a node reboot as required by some scenarios.</p>
</blockquote>
<p><img decoding=async loading=lazy alt="alt text" src=/assets/images/image-888ec8bbd4a1675927337b51904f70d1.png width=1328 height=1720 class=img_ev3q></p>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=5-总结>5. 总结<a href=#5-总结 class=hash-link aria-label="Direct link to 5. 总结" title="Direct link to 5. 总结">​</a></h2>
<p><code>NVIDIA</code>的<code>MPS</code>和<code>MIG</code>技术为解决<code>GPU</code>资源利用率低下和多租户隔离的问题提供了有效的解决方案。<code>MPS</code>采用软件级隔离，支持动态资源分配，适合多副本推理服务和轻量级训练场景；而<code>MIG</code>提供硬件级隔离，确保完全的性能隔离和故障隔离，更适合多租户环境和需要强隔离的业务场景。选择哪种技术应基于业务需求、硬件条件、运维复杂度和应用场景等因素综合考量。在实际部署中，应注重资源监控、自动化配置和安全防护，以确保系统的稳定性和性能。通过合理应用这些<code>GPU</code>共享技术，企业可以显著提高<code>GPU</code>资源利用率，降低<code>AI</code>应用部署成本，同时满足不同业务场景的需求。</div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/ai/gpu-dcgm-exporter><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>GPU DCGM-Exporter监控方案</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/ai/gpu-mig-docker-specify-subcard><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>GPU MIG拆卡后使用docker指定子卡执行</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#1-基本介绍 class="table-of-contents__link toc-highlight">1. 基本介绍</a><li><a href=#2-mps拆卡方案 class="table-of-contents__link toc-highlight">2. MPS拆卡方案</a><ul><li><a href=#21-依赖与限制 class="table-of-contents__link toc-highlight">2.1 依赖与限制</a><li><a href=#22-优缺点分析 class="table-of-contents__link toc-highlight">2.2 优缺点分析</a><li><a href=#23-如何识别gpu卡是否支持mps class="table-of-contents__link toc-highlight">2.3 如何识别GPU卡是否支持MPS</a><li><a href=#24-特性的启用流程 class="table-of-contents__link toc-highlight">2.4 特性的启用流程</a></ul><li><a href=#3-mig拆卡方案 class="table-of-contents__link toc-highlight">3. MIG拆卡方案</a><ul><li><a href=#31-依赖与限制 class="table-of-contents__link toc-highlight">3.1 依赖与限制</a><li><a href=#32-优缺点分析 class="table-of-contents__link toc-highlight">3.2 优缺点分析</a><li><a href=#33-如何识别gpu卡是否支持mig class="table-of-contents__link toc-highlight">3.3 如何识别GPU卡是否支持MIG</a><li><a href=#34-特性的启用流程 class="table-of-contents__link toc-highlight">3.4 特性的启用流程</a><li><a href=#35-如何对节点gpu进行mig拆卡 class="table-of-contents__link toc-highlight">3.5 如何对节点GPU进行MIG拆卡</a></ul><li><a href=#4-注意事项 class="table-of-contents__link toc-highlight">4. 注意事项</a><li><a href=#5-总结 class="table-of-contents__link toc-highlight">5. 总结</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>