<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/AI技术/训练微调/Kubeflow Trainer/Kubeflow Trainer PyTorch并行计算" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Kubeflow Trainer PyTorch并行计算 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/ai/kubeflow-trainer-pytorch-parallel-computing><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=author content="John Guo"><meta data-rh=true property=og:image content=https://johng.cn/img/favicon.png><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Kubeflow Trainer PyTorch并行计算 | John's Blog"><meta data-rh=true name=description content="深入介绍Kubeflow Trainer如何支持PyTorch框架实现HPC并行计算能力，包括HPC并行计算基础特性、PyTorch分布式训练原理、Kubeflow Trainer的CRD设计与组件架构、torchrun自动配置机制，以及算法工程师如何在代码中使用并行计算能力"><meta data-rh=true property=og:description content="深入介绍Kubeflow Trainer如何支持PyTorch框架实现HPC并行计算能力，包括HPC并行计算基础特性、PyTorch分布式训练原理、Kubeflow Trainer的CRD设计与组件架构、torchrun自动配置机制，以及算法工程师如何在代码中使用并行计算能力"><meta data-rh=true name=keywords content="Kubeflow Trainer,PyTorch,并行计算,分布式训练,DDP,FSDP,torchrun,HPC,数据并行,模型并行,NCCL,Gloo,torch.distributed,DistributedDataParallel,FullyShardedDataParallel,GPU训练,多机多卡,TrainJob,TrainingRuntime,Kubernetes,分布式环境变量,WORLD_SIZE,RANK,LOCAL_RANK"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/ai/kubeflow-trainer-pytorch-parallel-computing><link data-rh=true rel=alternate href=https://johng.cn/ai/kubeflow-trainer-pytorch-parallel-computing hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/ai/kubeflow-trainer-pytorch-parallel-computing hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="John's Blog RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="John's Blog Atom Feed"><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><link rel=stylesheet href=/assets/css/styles.2f56d3c4.css><script src=/assets/js/runtime~main.a1f3aeb7.js defer></script><script src=/assets/js/main.1f139af7.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/ai>AI技术</a><a class="navbar__item navbar__link" href=/cloud-native>云原生</a><a class="navbar__item navbar__link" href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/programming>开发语言</a><a class="navbar__item navbar__link" href=/architecture>技术架构</a><a class="navbar__item navbar__link" href=/observability>可观测性</a><a class="navbar__item navbar__link" href=/life>生活笔记</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href=/aboutme>关于我</a><a class="navbar__item navbar__link" href=/blog>博客</a><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/ai>AI技术</a><button aria-label="Collapse sidebar category 'AI技术'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/agents>智能体</a><button aria-label="Expand sidebar category '智能体'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/app>应用开发</a><button aria-label="Expand sidebar category '应用开发'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/inference>推理服务</a><button aria-label="Expand sidebar category '推理服务'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/ai/training>训练微调</a><button aria-label="Collapse sidebar category '训练微调'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/training-platform>开发训练平台</a><button aria-label="Expand sidebar category '开发训练平台'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/ai/kubeflow-trainer>Kubeflow Trainer</a><button aria-label="Collapse sidebar category 'Kubeflow Trainer'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/kubeflow-trainer-in-hpc>Kubeflow Trainer In HPC</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/ai/kubeflow-trainer-pytorch-parallel-computing>Kubeflow Trainer PyTorch并行计算</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/kubeflow-trainer-crd-reference>Kubeflow Trainer CRD配置格式详解</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/kubeflow-trainer-environment-variables>Kubeflow Trainer 环境变量自动注入</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/kubeflow-trainer-deploy-usage>Kubeflow Trainer 安装、部署及使用</a></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/training-parallel-strategies>AI训练并行策略详解</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/infra>基础架构</a><button aria-label="Expand sidebar category '基础架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/basic>入门知识</a><button aria-label="Expand sidebar category '入门知识'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/cloud-native>云原生</a><button aria-label="Expand sidebar category '云原生'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/life>生活笔记</a><button aria-label="Expand sidebar category '生活笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai><span itemprop=name>AI技术</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai/training><span itemprop=name>训练微调</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai/kubeflow-trainer><span itemprop=name>Kubeflow Trainer</span></a><meta itemprop=position content=3><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Kubeflow Trainer PyTorch并行计算</span><meta itemprop=position content=4></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=hpc并行计算基础特性>HPC并行计算基础特性<a href=#hpc并行计算基础特性 class=hash-link aria-label="Direct link to HPC并行计算基础特性" title="Direct link to HPC并行计算基础特性">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=什么是hpc并行计算>什么是HPC并行计算<a href=#什么是hpc并行计算 class=hash-link aria-label="Direct link to 什么是HPC并行计算" title="Direct link to 什么是HPC并行计算">​</a></h3>
<p><code>HPC</code>（<code>High Performance Computing</code>，高性能计算）是指利用多个计算资源（如<code>CPU</code>、<code>GPU</code>）协同工作，以解决复杂计算问题的技术。在<code>AI</code>模型训练场景中，<code>HPC</code>并行计算是实现大规模模型训练的核心技术基础。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=并行计算的核心特性>并行计算的核心特性<a href=#并行计算的核心特性 class=hash-link aria-label="Direct link to 并行计算的核心特性" title="Direct link to 并行计算的核心特性">​</a></h3>
<table><thead><tr><th>特性<th>描述<th>在AI训练中的应用<tbody><tr><td><strong>任务分解</strong><td>将大任务拆分为多个可并行执行的子任务<td>将训练数据分片到多个<code>GPU</code><tr><td><strong>并行执行</strong><td>多个计算单元同时处理不同子任务<td>多<code>GPU</code>同时计算梯度<tr><td><strong>通信同步</strong><td>计算单元间交换数据和同步状态<td>梯度聚合、参数同步<tr><td><strong>结果合并</strong><td>将各计算单元的结果汇总<td>模型参数更新</table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=ai训练中的并行策略>AI训练中的并行策略<a href=#ai训练中的并行策略 class=hash-link aria-label="Direct link to AI训练中的并行策略" title="Direct link to AI训练中的并行策略">​</a></h3>
<p>在<code>AI</code>大模型训练中，单个<code>GPU</code>的计算能力和显存往往无法满足需求，需要使用多个<code>GPU</code>协同工作。主要的并行策略包括：</p>
<table><thead><tr><th>并行策略<th>英文名称<th>核心原理<tbody><tr><td><strong>数据并行</strong><td><code>Data Parallelism (DP)</code><td>每个<code>GPU</code>持有完整模型，处理不同的数据分片，通过梯度同步保持模型一致<tr><td><strong>模型并行</strong><td><code>Model Parallelism (MP)</code><td>将模型的不同层分配到不同<code>GPU</code>，突破单卡显存限制<tr><td><strong>流水线并行</strong><td><code>Pipeline Parallelism (PP)</code><td>模型并行的优化版，通过微批次流水线提高<code>GPU</code>利用率<tr><td><strong>张量并行</strong><td><code>Tensor Parallelism (TP)</code><td>将单个网络层的计算拆分到多个<code>GPU</code>并行执行</table>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"/></svg></span>详细说明</div><div class=admonitionContent_BuS1><p>关于各种并行策略的详细原理、术语解释、适用场景和实现方式，请参考：<a href=/ai/training-parallel-strategies>AI训练并行策略详解</a></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=分布式通信后端>分布式通信后端<a href=#分布式通信后端 class=hash-link aria-label="Direct link to 分布式通信后端" title="Direct link to 分布式通信后端">​</a></h3>
<table><thead><tr><th>后端<th>适用场景<th>支持操作<th>性能特点<tbody><tr><td><strong>NCCL</strong><td><code>GPU</code>集群<td>全部集合通信<td>最优<code>GPU</code>通信性能<tr><td><strong>Gloo</strong><td><code>CPU</code>/<code>GPU</code><td>全部集合通信<td>跨平台兼容<tr><td><strong>MPI</strong><td><code>HPC</code>集群<td>点对点+集合通信<td>传统<code>HPC</code>标准</table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=pytorch分布式训练原理>PyTorch分布式训练原理<a href=#pytorch分布式训练原理 class=hash-link aria-label="Direct link to PyTorch分布式训练原理" title="Direct link to PyTorch分布式训练原理">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=torchdistributed核心概念>torch.distributed核心概念<a href=#torchdistributed核心概念 class=hash-link aria-label="Direct link to torch.distributed核心概念" title="Direct link to torch.distributed核心概念">​</a></h3>
<p><code>PyTorch</code>通过<code>torch.distributed</code>包提供分布式训练能力，核心概念包括：</p>
<table><thead><tr><th>概念<th>说明<th>示例<tbody><tr><td><strong>World Size</strong><td>参与训练的总进程数<td><code>4节点×8GPU = 32</code><tr><td><strong>Rank</strong><td>当前进程的全局唯一标识<td><code>0, 1, 2, ..., 31</code><tr><td><strong>Local Rank</strong><td>当前进程在本节点的标识<td><code>0, 1, ..., 7</code><tr><td><strong>Process Group</strong><td>进程组，用于集合通信<td>默认组包含所有进程<tr><td><strong>Backend</strong><td>通信后端<td><code>nccl, gloo, mpi</code><tr><td><strong>AllReduce</strong><td>集合通信算子：对所有进程的张量做规约（<code>sum/avg</code>）并广播回所有进程<td></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=分布式数据并行ddp>分布式数据并行（DDP）<a href=#分布式数据并行ddp class=hash-link aria-label="Direct link to 分布式数据并行（DDP）" title="Direct link to 分布式数据并行（DDP）">​</a></h3>
<p><code>DistributedDataParallel</code>（<code>DDP</code>）是<code>PyTorch</code>推荐的数据并行方案：</p>
<!-- -->
<p><strong>DDP训练流程说明</strong>：</p>
<ol>
<li><strong>前向传播阶段</strong>：各<code>GPU</code>独立执行，互不通信。每个进程用自己的数据分片（如<code>data_0</code>、<code>data_1</code>等）通过模型得到输出。</li>
<li><strong>反向传播阶段</strong>：在计算梯度时，<code>DDP</code>会自动将梯度按<code>bucket</code>分组进行<code>AllReduce</code>同步，确保所有进程得到相同的梯度。这个过程与梯度计算重叠执行，减少等待时间。</li>
<li><strong>参数更新阶段</strong>：因为所有进程的梯度已同步，各进程独立执行<code>optimizer.step()</code>后，模型参数仍保持一致。</li>
</ol>
<p><strong>DDP核心优势</strong>：</p>
<ul>
<li>梯度同步与反向传播重叠，减少通信开销</li>
<li>每个进程独立运行，无<code>GIL</code>限制</li>
<li>支持多机多卡扩展</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=全分片数据并行fsdp>全分片数据并行（FSDP）<a href=#全分片数据并行fsdp class=hash-link aria-label="Direct link to 全分片数据并行（FSDP）" title="Direct link to 全分片数据并行（FSDP）">​</a></h3>
<p><code>FullyShardedDataParallel</code>（<code>FSDP</code>）是<code>PyTorch</code>针对大模型的优化方案：</p>
<table><thead><tr><th>特性<th>DDP<th>FSDP<tbody><tr><td>模型存储<td>每个<code>GPU</code>存储完整模型<td>模型参数分片存储<tr><td>显存占用<td>高（<code>N</code>份完整模型）<td>低（<code>1/N</code>模型参数）<tr><td>通信模式<td><code>AllReduce</code>梯度<td><code>AllGather</code>参数 + <code>ReduceScatter</code>梯度<tr><td>适用场景<td>中小模型<td>大模型（<code>>10B</code>参数）</table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=torchrun启动器>torchrun启动器<a href=#torchrun启动器 class=hash-link aria-label="Direct link to torchrun启动器" title="Direct link to torchrun启动器">​</a></h3>
<p><code>torchrun</code>是<code>PyTorch</code>官方推荐的分布式训练启动工具，它会自动设置以下环境变量：</p>
<table><thead><tr><th>环境变量<th>说明<th>来源<tbody><tr><td><code>WORLD_SIZE</code><td>总进程数<td><code>--nnodes × --nproc-per-node</code><tr><td><code>RANK</code><td>全局进程编号<td>自动计算<tr><td><code>LOCAL_RANK</code><td>本地进程编号<td>自动计算<tr><td><code>MASTER_ADDR</code><td>主节点地址<td><code>--master-addr</code><tr><td><code>MASTER_PORT</code><td>主节点端口<td><code>--master-port</code></table>
<p><strong>torchrun命令示例</strong>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 单机4卡</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">torchrun --nproc-per-node</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>4</span><span class="token plain"> train.py</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 多机多卡（4节点，每节点8卡）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">torchrun </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token parameter variable" style=color:#f8f8f2>--nnodes</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>4</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    --nproc-per-node</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>8</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    --node-rank</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    --master-addr</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>192.168</span><span class="token plain">.1.1 </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    --master-port</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>29500</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    train.py</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=kubeflow-trainer-pytorch并行计算支持>Kubeflow Trainer PyTorch并行计算支持<a href=#kubeflow-trainer-pytorch并行计算支持 class=hash-link aria-label="Direct link to Kubeflow Trainer PyTorch并行计算支持" title="Direct link to Kubeflow Trainer PyTorch并行计算支持">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=整体架构>整体架构<a href=#整体架构 class=hash-link aria-label="Direct link to 整体架构" title="Direct link to 整体架构">​</a></h3>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=核心crd设计>核心CRD设计<a href=#核心crd设计 class=hash-link aria-label="Direct link to 核心CRD设计" title="Direct link to 核心CRD设计">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=trainjob>TrainJob<a href=#trainjob class=hash-link aria-label="Direct link to TrainJob" title="Direct link to TrainJob">​</a></h4>
<p><code>TrainJob</code>是面向数据科学家的简化<code>API</code>，用于提交训练任务：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> TrainJob</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">ddp</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">training</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ml</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">team</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 引用预定义的训练运行时</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">runtimeRef</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">apiGroup</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ClusterTrainingRuntime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">distributed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 训练器配置（可覆盖Runtime默认值）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">trainer</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> my</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">registry/pytorch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">training</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">v1.0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> torchrun</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> train.py</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">args</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">epochs=100</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">batch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">size=64</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">numNodes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>4</span><span class="token plain">                    </span><span class="token comment" style=color:#8292a2;font-style:italic># 训练节点数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">numProcPerNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>8</span><span class="token plain">              </span><span class="token comment" style=color:#8292a2;font-style:italic># 每节点进程数（通常等于GPU数）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">resourcesPerNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>8</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"64Gi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"16"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NCCL_DEBUG</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"INFO"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=clustertrainingruntime>ClusterTrainingRuntime<a href=#clustertrainingruntime class=hash-link aria-label="Direct link to ClusterTrainingRuntime" title="Direct link to ClusterTrainingRuntime">​</a></h4>
<p><code>ClusterTrainingRuntime</code>是平台工程师预定义的训练任务模板：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ClusterTrainingRuntime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">distributed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">trainer.kubeflow.org/framework</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> torch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># ML策略配置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">mlPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">numNodes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">                    </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认节点数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">torch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">numProcPerNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> auto         </span><span class="token comment" style=color:#8292a2;font-style:italic># auto/cpu/gpu/具体数值</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># 弹性训练配置（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic># elasticPolicy:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic>#   minNodes: 2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic>#   maxNodes: 8</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic>#   maxRestarts: 3</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># Gang调度策略（可选）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">podGroupPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">volcano</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain">                    </span><span class="token comment" style=color:#8292a2;font-style:italic># 使用Volcano调度器</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># JobSet模板</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">replicatedJobs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">trainer.kubeflow.org/trainjob-ancestor-step</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch/pytorch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">2.7.1</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cuda12.8</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cudnn9</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">runtime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">ports</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">containerPort</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>29500</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 分布式通信端口</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=torch-plugin实现原理>Torch Plugin实现原理<a href=#torch-plugin实现原理 class=hash-link aria-label="Direct link to Torch Plugin实现原理" title="Direct link to Torch Plugin实现原理">​</a></h3>
<p><code>Kubeflow Trainer</code>通过<code>Torch Plugin</code>实现对<code>PyTorch</code>分布式训练的支持。该插件的核心功能是自动注入分布式环境变量。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=环境变量注�入>环境变量注入<a href=#环境变量注入 class=hash-link aria-label="Direct link to 环境变量注入" title="Direct link to 环境变量注入">​</a></h4>
<p><code>Torch Plugin</code>会自动为每个训练<code>Pod</code>注入以下环境变量：</p>
<table><thead><tr><th>环境变量<th>说明<th>计算方式<tbody><tr><td><code>PET_NNODES</code><td>训练节点总数<td><code>spec.trainer.numNodes</code><tr><td><code>PET_NPROC_PER_NODE</code><td>每节点进程数<td><code>spec.mlPolicy.torch.numProcPerNode</code><tr><td><code>PET_NODE_RANK</code><td>当前节点编号<td>从<code>Job Completion Index</code>获取<tr><td><code>PET_MASTER_ADDR</code><td>主节点地址<td><code>{trainjob-name}-node-0-0.{trainjob-name}</code><tr><td><code>PET_MASTER_PORT</code><td>主节点端口<td>默认<code>29500</code></table>
<p><strong>注意</strong>：这些环境变量使用<code>PET_</code>前缀（<code>PyTorch Elastic Training</code>），是<code>Kubeflow Trainer</code>特有的命名规范，避免与用户自定义变量冲突。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=numprocpernode计算逻辑>numProcPerNode计算逻辑<a href=#numprocpernode计算逻辑 class=hash-link aria-label="Direct link to numProcPerNode计算逻辑" title="Direct link to numProcPerNode计算逻辑">​</a></h4>
<p><code>numProcPerNode</code>支持多种配置方式：</p>
<table><thead><tr><th>配置值<th>行为<tbody><tr><td><code>auto</code><td>如果配置了<code>GPU</code>资源，使用<code>GPU</code>数量；否则使用<code>CPU</code>数量<tr><td><code>cpu</code><td>使用<code>CPU</code>核心数<tr><td><code>gpu</code><td>使用<code>GPU</code>数量<tr><td>整数值<td>使用指定的数值</table>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// 源码逻辑简化</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> numProcPerNode </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"auto"</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> gpuCount </span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        numProcPerNode </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> gpuCount</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>else</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        numProcPerNode </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> cpuCount</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=执行流程详解>执行流程详解<a href=#执行流程详解 class=hash-link aria-label="Direct link to 执行流程详解" title="Direct link to 执行流程详解">​</a></h3>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=headless-service与节点发现>Headless Service与节点发现<a href=#headless-service与节点发现 class=hash-link aria-label="Direct link to Headless Service与节点发现" title="Direct link to Headless Service与节点发现">​</a></h3>
<p><code>Kubeflow Trainer</code>会自动创建<code>Headless Service</code>用于节点间通信：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> Service</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">ddp</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">training  </span><span class="token comment" style=color:#8292a2;font-style:italic># 与TrainJob同名</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">clusterIP</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> None             </span><span class="token comment" style=color:#8292a2;font-style:italic># Headless Service</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">trainer.kubeflow.org/trainjob-name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">ddp</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">training</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>29500</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">targetPort</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>29500</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><strong>节点DNS解析</strong>：</p>
<ul>
<li>主节点：<code>pytorch-ddp-training-node-0-0.pytorch-ddp-training</code></li>
<li>工作节点1：<code>pytorch-ddp-training-node-0-1.pytorch-ddp-training</code></li>
<li>工作节点2：<code>pytorch-ddp-training-node-0-2.pytorch-ddp-training</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=算法工程师使用指南>算法工程师使用指南<a href=#算法工程师使用指南 class=hash-link aria-label="Direct link to 算法工程师使用指南" title="Direct link to 算法工程师使用指南">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=是否需要感知底层架构>是否需要感知底层架构？<a href=#是否需要感知底层架构 class=hash-link aria-label="Direct link to 是否需要感知底层架构？" title="Direct link to 是否需要感知底层架构？">​</a></h3>
<p><strong>简短回答</strong>：<strong>不需要</strong>。<code>Kubeflow Trainer</code>的设计目标之一就是对算法工程师屏蔽<code>Kubernetes</code>和分布式训练的复杂性。</p>
<table><thead><tr><th>关注点<th>算法工程师需要关心<th>Kubeflow Trainer自动处理<tbody><tr><td>分布式环境初始化<td>❌<td>✅ 自动注入环境变量<tr><td>节点发现与通信<td>❌<td>✅ 自动创建<code>Headless Service</code><tr><td><code>torchrun</code>参数配置<td>❌<td>✅ 自动计算<code>nnodes</code>、<code>nproc</code>等<tr><td><code>GPU</code>资源分配<td>❌<td>✅ 通过<code>Runtime</code>配置<tr><td><code>Pod</code>调度与编排<td>❌<td>✅ 通过<code>JobSet</code>管理<tr><td>训练代码编写<td>✅<td>-<tr><td>模型架构设计<td>✅<td>-<tr><td>超参数调优<td>✅<td>-</table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=训练代码编写规范>训练代码编写规范<a href=#训练代码编写规范 class=hash-link aria-label="Direct link to 训练代码编写规范" title="Direct link to 训练代码编写规范">​</a></h3>
<p>算法工程师只需按照标准的<code>PyTorch</code>分布式训练方式编写代码：</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>def</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>train</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> os</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">distributed </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> dist</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>from</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">nn</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">parallel </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> DistributedDataParallel </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> DDP</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>from</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">utils</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">data </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> DataLoader</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> DistributedSampler</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># [1] 初始化分布式环境</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># Kubeflow Trainer已自动设置所有必要的环境变量</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    device </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cuda"</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">cuda</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">is_available</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>else</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cpu"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    backend </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"nccl"</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> device </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cuda"</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>else</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"gloo"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">init_process_group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">backend</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">backend</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># [2] 获取分布式信息（可选，用于日志或调试）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    world_size </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_world_size</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_rank</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    local_rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">os</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">environ</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"LOCAL_RANK"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"Initialized: World Size=</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">world_size</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>, Rank=</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>, Local Rank=</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">local_rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># [3] 设置当前进程使用的GPU</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> device </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cuda"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">cuda</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">set_device</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">local_rank</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        device </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"cuda:</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">local_rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># [4] 创建模型并包装为DDP</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    model </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> MyModel</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">to</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    model </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> DDP</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> device_ids</span><span class="token operator" style=color:#66d9ef>=</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token plain">local_rank</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> device</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token builtin" style=color:#e6db74>type</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cuda"</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>else</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>None</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># [5] 创建数据加载器（使用DistributedSampler）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dataset </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> MyDataset</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    sampler </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> DistributedSampler</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">dataset</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> num_replicas</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">world_size</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> rank</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">rank</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dataloader </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> DataLoader</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">dataset</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> batch_size</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> sampler</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">sampler</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># [6] 训练循环</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    optimizer </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">optim</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Adam</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">parameters</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> lr</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>0.001</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> epoch </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>100</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        sampler</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">set_epoch</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">epoch</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 重要：确保每个epoch数据打乱方式不同</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> batch </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> dataloader</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            inputs</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> labels </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> batch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            inputs</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> labels </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> inputs</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">to</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> labels</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">to</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            optimizer</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">zero_grad</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            outputs </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">inputs</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            loss </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> criterion</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">outputs</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> labels</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            loss</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">backward</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            optimizer</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">step</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 只在主节点保存模型</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> rank </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">save</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">module</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">state_dict</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string-interpolation string" style=color:#a6e22e>f"model_epoch_</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">epoch</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>.pt"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># [7] 清理</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">destroy_process_group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> __name__ </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"__main__"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    train</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=使用kubeflow-python-sdk提交任务>使用Kubeflow Python SDK提交任务<a href=#使用kubeflow-python-sdk提交任务 class=hash-link aria-label="Direct link to 使用Kubeflow Python SDK提交任务" title="Direct link to 使用Kubeflow Python SDK提交任务">​</a></h3>
<p>算法工程师可以使用<code>Kubeflow Python SDK</code>直接从<code>Python</code>代码提交训练任务：</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>from</span><span class="token plain"> kubeflow</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">trainer </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> TrainerClient</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> CustomTrainer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 定义训练函数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>def</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>train_pytorch</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">distributed </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> dist</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>from</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">nn</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">parallel </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> DistributedDataParallel </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> DDP</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 初始化分布式环境（Kubeflow Trainer自动配置）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    device</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> backend </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"cuda"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"nccl"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">cuda</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">is_available</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>else</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"cpu"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"gloo"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">init_process_group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">backend</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">backend</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    local_rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">os</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">environ</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"LOCAL_RANK"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 创建模型</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    model </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">nn</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Linear</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>10</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>10</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">to</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    model </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> DDP</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 训练逻辑...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"Training on rank </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">dist</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>.</span><span class="token string-interpolation interpolation">get_rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>)</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>/</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">dist</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>.</span><span class="token string-interpolation interpolation">get_world_size</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>)</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">destroy_process_group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 创建训练任务</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">client </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> TrainerClient</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">job_id </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> client</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">train</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    trainer</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">CustomTrainer</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        func</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">train_pytorch</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        num_nodes</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>4</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain">                    </span><span class="token comment" style=color:#8292a2;font-style:italic># 4个训练节点</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        resources_per_node</span><span class="token operator" style=color:#66d9ef>=</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token string" style=color:#a6e22e>"cpu"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>8</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token string" style=color:#a6e22e>"memory"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"32Gi"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token string" style=color:#a6e22e>"gpu"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain">                   </span><span class="token comment" style=color:#8292a2;font-style:italic># 每节点2个GPU</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        packages_to_install</span><span class="token operator" style=color:#66d9ef>=</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"transformers>=4.53.0"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 额外依赖</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 等待任务完成</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">client</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">wait_for_job_status</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">job_id</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 查看日志</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> log </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> client</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_job_logs</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">job_id</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> follow</span><span class="token operator" style=color:#66d9ef>=</span><span class="token boolean" style=color:#ae81ff>True</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">log</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=关键注意事项>关键注意事项<a href=#关键注意事项 class=hash-link aria-label="Direct link to 关键注意事项" title="Direct link to 关键注意事项">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=数据加载>数据加载<a href=#数据加载 class=hash-link aria-label="Direct link to 数据加载" title="Direct link to 数据加载">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># ✅ 正确：使用DistributedSampler</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">sampler </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> DistributedSampler</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">dataset</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">dataloader </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> DataLoader</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">dataset</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> sampler</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">sampler</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ❌ 错误：不使用Sampler会导致所有节点处理相同数据</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">dataloader </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> DataLoader</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">dataset</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> shuffle</span><span class="token operator" style=color:#66d9ef>=</span><span class="token boolean" style=color:#ae81ff>True</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=模型保存>模型保存<a href=#模型保存 class=hash-link aria-label="Direct link to 模型保存" title="Direct link to 模型保存">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># ✅ 正确：只在主节点保存</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_rank</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">save</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">module</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">state_dict</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"model.pt"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># ❌ 错误：所有节点都保存会造成冲突</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">save</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">state_dict</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"model.pt"</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=日志输出>日志输出<a href=#日志输出 class=hash-link aria-label="Direct link to 日志输出" title="Direct link to 日志输出">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># ✅ 推荐：只在主节点输出详细日志</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_rank</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"Epoch </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">epoch</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>, Loss: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">loss</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>.</span><span class="token string-interpolation interpolation">item</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>)</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 或使用条件日志</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>def</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>log</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">msg</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_rank</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">msg</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=随机种子>随机种子<a href=#随机种子 class=hash-link aria-label="Direct link to 随机种子" title="Direct link to 随机种子">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># ✅ 正确：设置确定性种子，但每个节点使用不同的数据增强</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">manual_seed</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>42</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>+</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_rank</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=fsdp使用示例>FSDP使用示例<a href=#fsdp使用示例 class=hash-link aria-label="Direct link to FSDP使用示例" title="Direct link to FSDP使用示例">​</a></h3>
<p>对于大模型训练，可以使用<code>FSDP</code>：</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>from</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">distributed</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">fsdp </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> FullyShardedDataParallel </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> FSDP</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>from</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">distributed</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">fsdp</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">wrap </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> transformer_auto_wrap_policy</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>def</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>train_large_model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">distributed </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> dist</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>from</span><span class="token plain"> transformers </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> AutoModelForCausalLM</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">init_process_group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">backend</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"nccl"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    local_rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">os</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">environ</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"LOCAL_RANK"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">cuda</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">set_device</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">local_rank</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 加载大模型</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    model </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> AutoModelForCausalLM</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"meta-llama/Llama-2-7b"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 使用FSDP包装</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    model </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> FSDP</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        model</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        auto_wrap_policy</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">transformer_auto_wrap_policy</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        device_id</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">local_rank</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 训练逻辑...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">destroy_process_group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=完整示例>完整示例<a href=#完整示例 class=hash-link aria-label="Direct link to 完整示例" title="Direct link to 完整示例">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=trainingruntime配置>TrainingRuntime配置<a href=#trainingruntime配置 class=hash-link aria-label="Direct link to TrainingRuntime配置" title="Direct link to TrainingRuntime配置">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ClusterTrainingRuntime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">ddp</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">gpu</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">mlPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">numNodes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">torch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">numProcPerNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> auto</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">podGroupPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">volcano</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">replicatedJobs</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">labels</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">trainer.kubeflow.org/trainjob-ancestor-step</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">              </span><span class="token key atrule">template</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">schedulerName</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> volcano</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                  </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> node</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch/pytorch</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">2.7.1</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cuda12.8</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">cudnn9</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">runtime</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token key atrule">limits</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>4</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">memory</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"64Gi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">cpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"16"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                      </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                        </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NCCL_DEBUG</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                          </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"INFO"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=trainjob提交>TrainJob提交<a href=#trainjob提交 class=hash-link aria-label="Direct link to TrainJob提交" title="Direct link to TrainJob提交">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> trainer.kubeflow.org/v1alpha1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> TrainJob</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mnist</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">ddp</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">training</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> ml</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">team</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">runtimeRef</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> pytorch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">ddp</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">gpu</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">trainer</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> my</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">registry/mnist</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">training</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">v1.0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> torchrun</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> train.py</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">args</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">epochs=50</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">batch</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">size=128</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">numNodes</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>4</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">resourcesPerNode</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">requests</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>8</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=训练脚本>训练脚本<a href=#训练脚本 class=hash-link aria-label="Direct link to 训练脚本" title="Direct link to 训练脚本">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>#!/usr/bin/env python3</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token triple-quoted-string string" style=color:#a6e22e>"""</span><br></span><span class=token-line style=color:#f8f8f2><span class="token triple-quoted-string string" style=color:#a6e22e>MNIST分布式训练示例</span><br></span><span class=token-line style=color:#f8f8f2><span class="token triple-quoted-string string" style=color:#a6e22e>此脚本可直接在Kubeflow Trainer中运行，无需修改</span><br></span><span class=token-line style=color:#f8f8f2><span class="token triple-quoted-string string" style=color:#a6e22e>"""</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> os</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> argparse</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">nn </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> nn</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">nn</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">functional </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> F</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">distributed </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> dist</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>from</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">nn</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">parallel </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> DistributedDataParallel </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> DDP</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>from</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">utils</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">data </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> DataLoader</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>from</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">utils</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">data</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">distributed </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> DistributedSampler</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>from</span><span class="token plain"> torchvision </span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> datasets</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> transforms</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>class</span><span class="token plain"> </span><span class="token class-name" style=color:#e6db74>MNISTNet</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">nn</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Module</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>def</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>__init__</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">self</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token builtin" style=color:#e6db74>super</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">__init__</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">conv1 </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> nn</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Conv2d</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>32</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>3</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">conv2 </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> nn</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Conv2d</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>32</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>3</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">fc1 </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> nn</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Linear</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>9216</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>128</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">fc2 </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> nn</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Linear</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>128</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>10</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>def</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>forward</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">self</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> x</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        x </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> F</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">relu</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">conv1</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">x</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        x </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> F</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">relu</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">conv2</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">x</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        x </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> F</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">max_pool2d</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">x</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        x </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">flatten</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">x</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        x </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> F</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">relu</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">fc1</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">x</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        x </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> self</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">fc2</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">x</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> F</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">log_softmax</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">x</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> dim</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>def</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>train</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">args</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 初始化分布式环境</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    device </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cuda"</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">cuda</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">is_available</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>else</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cpu"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    backend </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"nccl"</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> device </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cuda"</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>else</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"gloo"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">init_process_group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">backend</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">backend</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_rank</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    world_size </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_world_size</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    local_rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">os</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">environ</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"LOCAL_RANK"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> device </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cuda"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">cuda</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">set_device</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">local_rank</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        device </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"cuda:</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">local_rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> rank </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"Starting distributed training with </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">world_size</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e> processes"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 准备数据</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    transform </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> transforms</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Compose</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        transforms</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ToTensor</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        transforms</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Normalize</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>0.1307</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>0.3081</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 只在rank 0下载数据</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> rank </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        datasets</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MNIST</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'./data'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> train</span><span class="token operator" style=color:#66d9ef>=</span><span class="token boolean" style=color:#ae81ff>True</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> download</span><span class="token operator" style=color:#66d9ef>=</span><span class="token boolean" style=color:#ae81ff>True</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">barrier</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dataset </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> datasets</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">MNIST</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'./data'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> train</span><span class="token operator" style=color:#66d9ef>=</span><span class="token boolean" style=color:#ae81ff>True</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> transform</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">transform</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    sampler </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> DistributedSampler</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">dataset</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> num_replicas</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">world_size</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> rank</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">rank</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dataloader </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> DataLoader</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">dataset</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> batch_size</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">args</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">batch_size</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> sampler</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">sampler</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 创建模型</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    model </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> MNISTNet</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">to</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    model </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> DDP</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> device_ids</span><span class="token operator" style=color:#66d9ef>=</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token plain">local_rank</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> device</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token builtin" style=color:#e6db74>type</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"cuda"</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>else</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>None</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    optimizer </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">optim</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Adam</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">parameters</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> lr</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>0.001</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 训练循环</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> epoch </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>range</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">args</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">epochs</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        sampler</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">set_epoch</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">epoch</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">train</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> batch_idx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">data</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> target</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>enumerate</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">dataloader</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            data</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> target </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> data</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">to</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> target</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">to</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            optimizer</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">zero_grad</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            output </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            loss </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> F</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">nll_loss</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">output</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> target</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            loss</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">backward</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            optimizer</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">step</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> batch_idx </span><span class="token operator" style=color:#66d9ef>%</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>and</span><span class="token plain"> rank </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"Epoch </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">epoch</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e> [</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">batch_idx </span><span class="token string-interpolation interpolation operator" style=color:#66d9ef>*</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation builtin" style=color:#e6db74>len</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation interpolation">data</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>)</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>/</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation builtin" style=color:#e6db74>len</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation interpolation">dataset</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>)</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>] Loss: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">loss</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>.</span><span class="token string-interpolation interpolation">item</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>)</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>:</span><span class="token string-interpolation interpolation format-spec">.6f</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic># 保存检查点</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> rank </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">save</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token string" style=color:#a6e22e>'epoch'</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> epoch</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token string" style=color:#a6e22e>'model_state_dict'</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">module</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">state_dict</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token string" style=color:#a6e22e>'optimizer_state_dict'</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> optimizer</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">state_dict</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string-interpolation string" style=color:#a6e22e>f'checkpoint_epoch_</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">epoch</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>.pt'</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> rank </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"Training completed!"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">destroy_process_group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> __name__ </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"__main__"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    parser </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> argparse</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ArgumentParser</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    parser</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">add_argument</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"--epochs"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>type</span><span class="token operator" style=color:#66d9ef>=</span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> default</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>10</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    parser</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">add_argument</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"--batch-size"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>type</span><span class="token operator" style=color:#66d9ef>=</span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> default</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>64</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    args </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> parser</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">parse_args</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    train</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">args</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=参考资料>参考资料<a href=#参考资料 class=hash-link aria-label="Direct link to 参考资料" title="Direct link to 参考资料">​</a></h2>
<ul>
<li><a href=https://www.kubeflow.org/docs/components/trainer/ target=_blank rel="noopener noreferrer">Kubeflow Trainer官方文档</a></li>
<li><a href=https://pytorch.org/tutorials/beginner/dist_overview.html target=_blank rel="noopener noreferrer">PyTorch Distributed Overview</a></li>
<li><a href=https://pytorch.org/tutorials/intermediate/ddp_tutorial.html target=_blank rel="noopener noreferrer">PyTorch DDP Tutorial</a></li>
<li><a href=https://pytorch.org/tutorials/intermediate/FSDP_tutorial.html target=_blank rel="noopener noreferrer">PyTorch FSDP Tutorial</a></li>
<li><a href=https://pytorch.org/docs/stable/elastic/run.html target=_blank rel="noopener noreferrer">torchrun Documentation</a></li>
<li><a href=https://github.com/kubeflow/trainer target=_blank rel="noopener noreferrer">Kubeflow Trainer GitHub</a></li>
<li><a href=https://pytorch.org/blog/pytorch-on-kubernetes-kubeflow-trainer-joins-the-pytorch-ecosystem/ target=_blank rel="noopener noreferrer">PyTorch on Kubernetes Blog</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/ai/kubeflow-trainer-in-hpc><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Kubeflow Trainer In HPC</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/ai/kubeflow-trainer-crd-reference><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Kubeflow Trainer CRD配置格式详解</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#hpc并行计算基础特性 class="table-of-contents__link toc-highlight">HPC并行计算基础特性</a><ul><li><a href=#什么是hpc并行计算 class="table-of-contents__link toc-highlight">什么是HPC并行计算</a><li><a href=#并行计算的核心特性 class="table-of-contents__link toc-highlight">并行计算的核心特性</a><li><a href=#ai训练中的并行策略 class="table-of-contents__link toc-highlight">AI训练中的并行策略</a><li><a href=#分布式通信后端 class="table-of-contents__link toc-highlight">分布式通信后端</a></ul><li><a href=#pytorch分布式训练原理 class="table-of-contents__link toc-highlight">PyTorch分布式训练原理</a><ul><li><a href=#torchdistributed核心概念 class="table-of-contents__link toc-highlight">torch.distributed核心概念</a><li><a href=#分布式数据并行ddp class="table-of-contents__link toc-highlight">分布式数据并行（DDP）</a><li><a href=#全分片数据并行fsdp class="table-of-contents__link toc-highlight">全分片数据并行（FSDP）</a><li><a href=#torchrun启动器 class="table-of-contents__link toc-highlight">torchrun启动器</a></ul><li><a href=#kubeflow-trainer-pytorch并行计算支持 class="table-of-contents__link toc-highlight">Kubeflow Trainer PyTorch并行计算支持</a><ul><li><a href=#整体架构 class="table-of-contents__link toc-highlight">整体架构</a><li><a href=#核心crd设计 class="table-of-contents__link toc-highlight">核心CRD设计</a><li><a href=#torch-plugin实现原理 class="table-of-contents__link toc-highlight">Torch Plugin实现原理</a><li><a href=#执行流程详解 class="table-of-contents__link toc-highlight">执行流程详解</a><li><a href=#headless-service与节点发现 class="table-of-contents__link toc-highlight">Headless Service与节点发现</a></ul><li><a href=#算法工程师使用指南 class="table-of-contents__link toc-highlight">算法工程师使用指南</a><ul><li><a href=#是否需要感知底层架构 class="table-of-contents__link toc-highlight">是否需要感知底层架构？</a><li><a href=#训练代码编写规范 class="table-of-contents__link toc-highlight">训练代码编写规范</a><li><a href=#使用kubeflow-python-sdk提交任务 class="table-of-contents__link toc-highlight">使用Kubeflow Python SDK提交任务</a><li><a href=#关键注意事项 class="table-of-contents__link toc-highlight">关键注意事项</a><li><a href=#fsdp使用示例 class="table-of-contents__link toc-highlight">FSDP使用示例</a></ul><li><a href=#完整示例 class="table-of-contents__link toc-highlight">完整示例</a><ul><li><a href=#trainingruntime配置 class="table-of-contents__link toc-highlight">TrainingRuntime配置</a><li><a href=#trainjob提交 class="table-of-contents__link toc-highlight">TrainJob提交</a><li><a href=#训练脚本 class="table-of-contents__link toc-highlight">训练脚本</a></ul><li><a href=#参考资料 class="table-of-contents__link toc-highlight">参考资料</a></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2026 johng.cn</div></div></div></footer></div>