<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/AI技术/训练微调/Kubeflow Trainer/Kubeflow Trainer 环境变量自动注入" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Kubeflow Trainer 环境变量自动注入 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/ai/kubeflow-trainer-environment-variables><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=author content="John Guo"><meta data-rh=true property=og:image content=https://johng.cn/img/favicon.png><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Kubeflow Trainer 环境变量自动注入 | John's Blog"><meta data-rh=true name=description content="详细介绍Kubeflow Trainer在不同训练框架（PyTorch、DeepSpeed、MLX、TorchTune、MPI）下自动注入的环境变量，包括PET系列环境变量、标准分布式训练环境变量、MPI环境变量等，以及各框架的使用示例和最佳实践"><meta data-rh=true property=og:description content="详细介绍Kubeflow Trainer在不同训练框架（PyTorch、DeepSpeed、MLX、TorchTune、MPI）下自动注入的环境变量，包括PET系列环境变量、标准分布式训练环境变量、MPI环境变量等，以及各框架的使用示例和最佳实践"><meta data-rh=true name=keywords content="Kubeflow Trainer,环境变量,Environment Variables,PyTorch,DeepSpeed,MLX,TorchTune,MPI,分布式训练,PET环境变量,torchrun,OpenMPI,WORLD_SIZE,RANK,LOCAL_RANK,MASTER_ADDR,MASTER_PORT,分布式通信,训练框架"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/ai/kubeflow-trainer-environment-variables><link data-rh=true rel=alternate href=https://johng.cn/ai/kubeflow-trainer-environment-variables hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/ai/kubeflow-trainer-environment-variables hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="John's Blog RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="John's Blog Atom Feed"><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><link rel=stylesheet href=/assets/css/styles.2f56d3c4.css><script src=/assets/js/runtime~main.c4456a16.js defer></script><script src=/assets/js/main.df2d7182.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/ai>AI技术</a><a class="navbar__item navbar__link" href=/cloud-native>云原生</a><a class="navbar__item navbar__link" href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/programming>开发语言</a><a class="navbar__item navbar__link" href=/architecture>技术架构</a><a class="navbar__item navbar__link" href=/observability>可观测性</a><a class="navbar__item navbar__link" href=/life>生活笔记</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href=/aboutme>关于我</a><a class="navbar__item navbar__link" href=/blog>博客</a><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/ai>AI技术</a><button aria-label="Collapse sidebar category 'AI技术'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/agents>智能体</a><button aria-label="Expand sidebar category '智能体'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/app>应用开发</a><button aria-label="Expand sidebar category '应用开发'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/inference>推理服务</a><button aria-label="Expand sidebar category '推理服务'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/ai/training>训练微调</a><button aria-label="Collapse sidebar category '训练微调'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/training-platform>开发训练平台</a><button aria-label="Expand sidebar category '开发训练平台'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/notebook>Notebook</a><button aria-label="Expand sidebar category 'Notebook'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/ai/kubeflow-trainer>Kubeflow Trainer</a><button aria-label="Collapse sidebar category 'Kubeflow Trainer'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/kubeflow-trainer-in-hpc>Kubeflow Trainer In HPC</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/kubeflow-trainer-pytorch-parallel-computing>Kubeflow Trainer PyTorch并行计算</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/kubeflow-trainer-crd-reference>Kubeflow Trainer CRD配置格式详解</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/ai/kubeflow-trainer-environment-variables>Kubeflow Trainer 环境变量自动注入</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/kubeflow-trainer-deploy-usage>Kubeflow Trainer 安装、部署及使用</a></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/training-parallel-strategies>AI训练并行策略详解</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/infra>基础架构</a><button aria-label="Expand sidebar category '基础架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/basic>入门知识</a><button aria-label="Expand sidebar category '入门知识'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/cloud-native>云原生</a><button aria-label="Expand sidebar category '云原生'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/life>生活笔记</a><button aria-label="Expand sidebar category '生活笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai><span itemprop=name>AI技术</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai/training><span itemprop=name>训练微调</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai/kubeflow-trainer><span itemprop=name>Kubeflow Trainer</span></a><meta itemprop=position content=3><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Kubeflow Trainer 环境变量自动注入</span><meta itemprop=position content=4></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><p><code>Kubeflow Trainer</code>会根据使用的训练框架，为训练容器自动注入相应的环境变量。不同框架使用的环境变量不同，本文详细介绍各个框架的环境变量配置和使用方法。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=环境变量注入流程>环境变量注入流程<a href=#环境变量注入流程 class=hash-link aria-label="Direct link to 环境变量注入流程" title="Direct link to 环境变量注入流程">​</a></h2>
<p><code>Kubeflow Trainer</code>的环境变量注入流程如下：</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=pytorch框架环境变量>PyTorch框架环境变量<a href=#pytorch框架环境变量 class=hash-link aria-label="Direct link to PyTorch框架环境变量" title="Direct link to PyTorch框架环境变量">​</a></h2>
<p><code>PyTorch</code>是<code>Meta</code>（<code>Facebook</code>）开源的深度学习框架，提供灵活的动态计算图和丰富的分布式训练能力。<code>Kubeflow Trainer</code>使用<code>PyTorch</code>的<code>torchrun</code>工具启动分布式训练，支持数据并行（<code>DDP</code>）、全分片数据并行（<code>FSDP</code>）等多种并行策略。</p>
<p>使用<code>PyTorch</code>（通过<code>torchrun</code>启动）时，<code>Torch Plugin</code>会自动注入以下环境变量：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=pet_系列环境变量>PET_*系列环境变量<a href=#pet_系列环境变量 class=hash-link aria-label="Direct link to PET_*系列环境变量" title="Direct link to PET_*系列环境变量">​</a></h3>
<p>这些是<code>Kubeflow Trainer</code>为<code>PyTorch</code>分布式训练定义的环境变量，在<code>TrainingRuntime</code>的<code>command</code>和<code>args</code>中使用：</p>
<table><thead><tr><th>环境变量<th>说明<th>示例值<th>注入来源<tbody><tr><td><code>PET_NNODES</code><td>训练节点总数<td><code>2</code><td><code>spec.trainer.numNodes</code><tr><td><code>PET_NPROC_PER_NODE</code><td>每节点进程数<td><code>4</code><td><code>spec.mlPolicy.torch.numProcPerNode</code><tr><td><code>PET_NODE_RANK</code><td>当前节点编号<td><code>0-1</code><td><code>JOB_COMPLETION_INDEX</code><tr><td><code>PET_MASTER_ADDR</code><td>主节点地址<td><code>myjob-node-0-0.myjob</code><td><code>{trainjob-name}-node-0-0.{trainjob-name}</code><tr><td><code>PET_MASTER_PORT</code><td>主节点端口<td><code>29400</code><td>固定值</table>
<p><strong>说明</strong>：</p>
<ul>
<li><code>PET</code>代表<code>PyTorch Elastic Training</code>，是<code>Kubeflow Trainer</code>为<code>PyTorch</code>分布式训练定义的环境变量前缀</li>
<li>这些变量在<code>TrainingRuntime</code>的<code>command</code>中使用，如：<code>torchrun --nproc_per_node=$(PET_NPROC_PER_NODE) ...</code></li>
<li><code>PET_NODE_RANK</code>通过<code>Kubernetes</code>的<code>fieldRef</code>机制自动从<code>JOB_COMPLETION_INDEX</code>获取</li>
<li>这些环境变量由<code>Kubeflow Trainer</code>的<code>Torch Plugin</code>自动注入到容器环境中</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=标准分布式训练环境变量>标准分布式训练环境变量<a href=#标准分布式训练环境变量 class=hash-link aria-label="Direct link to 标准分布式训练环境变量" title="Direct link to 标准分布式训练环境变量">​</a></h3>
<p><code>torchrun</code>会根据<code>PET_*</code>变量，为每个进程设置以下标准环境变量（具体请参考<a href=https://docs.pytorch.org/docs/stable/distributed.html#environment-variable-initialization target=_blank rel="noopener noreferrer">PyTorch官方文档</a>）：</p>
<table><thead><tr><th>环境变量<th>说明<th>计算方式<th>示例值<tbody><tr><td><code>WORLD_SIZE</code><td>总进程数<td><code>PET_NNODES × PET_NPROC_PER_NODE</code><td><code>8</code><tr><td><code>RANK</code><td>全局进程编号<td>自动计算<td><code>0-7</code><tr><td><code>LOCAL_RANK</code><td>本地进程编号<td>节点内进程索引<td><code>0-3</code><tr><td><code>MASTER_ADDR</code><td>主节点地址<td>继承<code>PET_MASTER_ADDR</code><td><code>myjob-node-0-0.myjob</code><tr><td><code>MASTER_PORT</code><td>主节点端口<td>继承<code>PET_MASTER_PORT</code><td><code>29400</code></table>
<p><strong>说明</strong>：</p>
<ul>
<li>这些变量由<code>torchrun</code>自动设置，无需在<code>TrainingRuntime</code>中配置</li>
<li>训练代码中可直接使用<code>torch.distributed.get_rank()</code>等<code>API</code>，或通过<code>os.environ</code>访问</li>
<li>这些是<code>PyTorch</code>分布式训练的标准环境变量，所有使用<code>torchrun</code>的训练框架都会设置</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=pytorch训练脚本示例>PyTorch训练脚本示例<a href=#pytorch训练脚本示例 class=hash-link aria-label="Direct link to PyTorch训练脚本示例" title="Direct link to PyTorch训练脚本示例">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> os</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">distributed </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> dist</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 初始化分布式进程组（torchrun会自动设置所需环境变量）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">init_process_group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">backend</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"nccl"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 获取分布式信息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_rank</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">           </span><span class="token comment" style=color:#8292a2;font-style:italic># 等价于 int(os.environ['RANK'])</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">world_size </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_world_size</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic># 等价于 int(os.environ['WORLD_SIZE'])</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">local_rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">os</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">environ</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>'LOCAL_RANK'</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">node_rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">os</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">environ</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'JOB_COMPLETION_INDEX'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"Node Rank: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">node_rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"Global Rank: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>, World Size: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">world_size</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"Local Rank: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">local_rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 设置当前进程使用的GPU</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">cuda</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">set_device</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">local_rank</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=runtime-command配置示例>Runtime Command配置示例<a href=#runtime-command配置示例 class=hash-link aria-label="Direct link to Runtime Command配置示例" title="Direct link to Runtime Command配置示例">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> torchrun</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">args</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nproc_per_node=$(PET_NPROC_PER_NODE) </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">nnodes=$(PET_NNODES)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">node_rank=$(PET_NODE_RANK)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">master_addr=$(PET_MASTER_ADDR)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">master_port=$(PET_MASTER_PORT)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">rdzv_backend=c10d</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">rdzv_endpoint=$(PET_MASTER_ADDR)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">$(PET_MASTER_PORT)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> /workspace/train.py</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=deepspeed框架环境变量>DeepSpeed框架环境变量<a href=#deepspeed框架环境变量 class=hash-link aria-label="Direct link to DeepSpeed框架环境变量" title="Direct link to DeepSpeed框架环境变量">​</a></h2>
<p><code>DeepSpeed</code>是<code>Microsoft</code>开发的深度学习优化库，专注于大规模模型训练，提供了<code>ZeRO</code>优化器（零冗余优化器）、混合精度训练、梯度累积等功能。<code>DeepSpeed</code>可以显著降低显存占用，支持训练超大规模模型（如千亿参数的<code>LLM</code>）。在<code>Kubeflow Trainer</code>中，<code>DeepSpeed</code>通过<code>MPI</code>运行时使用<code>mpirun</code>启动。
<code>DeepSpeed</code>使用<code>MPI</code>运行时通过<code>mpirun</code>启动，会自动注入<code>MPI</code>相关环境变量，同时<code>DeepSpeed</code>会设置自己的分布式环境变量。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=mpi环境变量openmpi实现>MPI环境变量（OpenMPI实现）<a href=#mpi环境变量openmpi实现 class=hash-link aria-label="Direct link to MPI环境变量（OpenMPI实现）" title="Direct link to MPI环境变量（OpenMPI实现）">​</a></h3>
<table><thead><tr><th>环境变量<th>说明<th>示例值<tbody><tr><td><code>OMPI_MCA_orte_default_hostfile</code><td>主机列表文件路径<td><code>/etc/mpi/hostfile</code><tr><td><code>OMPI_MCA_plm_rsh_args</code><td><code>SSH</code>远程启动参数<td><code>-o ConnectionAttempts=10</code><tr><td><code>OMPI_MCA_orte_keep_fqdn_hostnames</code><td>保持完整主机名<td><code>true</code><tr><td><code>OMPI_MCA_orte_set_default_slots</code><td>默认<code>slot</code>数量<td><code>4</code></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=deepspeed分布式环境变量>DeepSpeed分布式环境变量<a href=#deepspeed分布式环境变量 class=hash-link aria-label="Direct link to DeepSpeed分布式环境变量" title="Direct link to DeepSpeed分布式环境变量">​</a></h3>
<p><code>DeepSpeed</code>通过调用<code>deepspeed.init_distributed()</code>初始化分布式环境后，可使用以下变量（由<code>PyTorch</code>底层设置）：</p>
<table><thead><tr><th>环境变量<th>说明<th>获取方式<th>示例值<tbody><tr><td><code>WORLD_SIZE</code><td>总进程数<td><code>dist.get_world_size()</code><td><code>8</code><tr><td><code>RANK</code><td>全局进程编号<td><code>dist.get_rank()</code><td><code>0-7</code><tr><td><code>LOCAL_RANK</code><td>本地进程编号<td><code>os.environ['LOCAL_RANK']</code><td><code>0-3</code></table>
<p><strong>说明</strong>：</p>
<ul>
<li><code>DeepSpeed</code>使用<code>MPI</code>运行时，<code>Kubeflow Trainer</code>会自动创建<code>OpenMPI hostfile</code></li>
<li><code>Kubeflow Trainer</code>会自动启动<code>OpenSSH</code>服务器用于节点间通信</li>
<li>训练代码中使用<code>deepspeed.init_distributed()</code>初始化后，可以访问上述分布式环境变量</li>
<li>具体可参考<a href=https://www.deepspeed.ai/getting-started/#mpi-and-azureml-compatibility target=_blank rel="noopener noreferrer">DeepSpeed官方文档</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=deepspeed训练脚本示例>DeepSpeed训练脚本示例<a href=#deepspeed训练脚本示例 class=hash-link aria-label="Direct link to DeepSpeed训练脚本示例" title="Direct link to DeepSpeed训练脚本示例">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> os</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> torch</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">distributed </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> dist</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> deepspeed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 初始化DeepSpeed分布式环境</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">deepspeed</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">init_distributed</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">dist_backend</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"nccl"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 获取分布式信息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">world_size </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_world_size</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">get_rank</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">local_rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">os</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">environ</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>'LOCAL_RANK'</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"DeepSpeed Distributed Environment"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"WORLD_SIZE: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">world_size</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"RANK: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"LOCAL_RANK: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">local_rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 在rank 0节点上下载数据集</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> rank </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"Downloading dataset on master node..."</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 下载数据集的代码</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 在local_rank 0节点上进行本地操作</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> local_rank </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"Performing local operations on this node..."</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 本地操作的代码</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=runtime-command配置示例-1>Runtime Command配置示例<a href=#runtime-command配置示例-1 class=hash-link aria-label="Direct link to Runtime Command配置示例" title="Direct link to Runtime Command配置示例">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># Launcher容器使用mpirun启动</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> mpirun</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">args</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">hostfile</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> /etc/mpi/hostfile</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">allow</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">run</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">as</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">root</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">tag</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">output</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mca</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> btl_tcp_if_include</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> eth0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> deepspeed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> /workspace/train.py</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">deepspeed_config=/workspace/ds_config.json</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=mlx框架环境变量>MLX框架环境变量<a href=#mlx框架环境变量 class=hash-link aria-label="Direct link to MLX框架环境变量" title="Direct link to MLX框架环境变量">​</a></h2>
<p><code>MLX</code>是<code>Apple</code>专为<code>Apple Silicon</code>（<code>M</code>系列芯片）优化的机器学习框架，设计类似<code>NumPy</code>，但充分利用了<code>Apple</code>统一内存架构和<code>GPU</code>加速能力。<code>MLX</code>特别适合在<code>Mac</code>设备上进行模型训练和推理，支持分布式训练。在<code>Kubeflow Trainer</code>中，<code>MLX</code>通过<code>MPI</code>运行时实现多节点分布式训练。</p>
<p><code>MLX</code>框架使用<code>MPI</code>运行时进行分布式训练，会注入<code>MPI</code>相关环境变量。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=mpi环境变量openmpi实现-1>MPI环境变量（OpenMPI实现）<a href=#mpi环境变量openmpi实现-1 class=hash-link aria-label="Direct link to MPI环境变量（OpenMPI实现）" title="Direct link to MPI环境变量（OpenMPI实现）">​</a></h3>
<table><thead><tr><th>环境变量<th>说明<th>示例值<tbody><tr><td><code>OMPI_MCA_orte_default_hostfile</code><td>主机列表文件路径<td><code>/etc/mpi/hostfile</code><tr><td><code>OMPI_MCA_plm_rsh_args</code><td><code>SSH</code>远程启动参数<td><code>-o ConnectionAttempts=10</code><tr><td><code>OMPI_MCA_orte_keep_fqdn_hostnames</code><td>保持完整主机名<td><code>true</code><tr><td><code>OMPI_MCA_orte_set_default_slots</code><td>默认<code>slot</code>数量<td><code>4</code></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=mlx分布式环境变量>MLX分布式环境变量<a href=#mlx分布式环境变量 class=hash-link aria-label="Direct link to MLX分布式环境变量" title="Direct link to MLX分布式环境变�量">​</a></h3>
<p><code>MLX</code>分布式训练使用<code>MPI</code>通信，可通过以下方式获取分布式信息：</p>
<table><thead><tr><th>获取方式<th>说明<th>示例<tbody><tr><td><code>mx.distributed.init()</code><td>初始化分布式环境<td><code>mx.distributed.init()</code><tr><td><code>mx.distributed.world_size()</code><td>获取总进程数<td><code>world_size = mx.distributed.world_size()</code><tr><td><code>mx.distributed.rank()</code><td>获取当前进程编号<td><code>rank = mx.distributed.rank()</code></table>
<p><strong>说明</strong>：</p>
<ul>
<li><code>MLX</code>专为<code>Apple Silicon</code>优化，支持<code>GPU</code>加速</li>
<li>使用<code>MPI</code>运行时时，<code>Kubeflow Trainer</code>自动配置<code>MPI</code>环境</li>
<li>训练代码需要显式调用<code>mx.distributed.init()</code>初始化分布式环境</li>
<li>具体可参考<a href=https://ml-explore.github.io/mlx/build/html/usage/distributed.html target=_blank rel="noopener noreferrer">MLX官方文档</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=mlx训练脚本示例>MLX训练脚本示例<a href=#mlx训练脚本示例 class=hash-link aria-label="Direct link to MLX训练脚本示例" title="Direct link to MLX训练脚本示例">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> mlx</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">core </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> mx</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> mlx</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">nn </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> nn</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>import</span><span class="token plain"> mlx</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">distributed </span><span class="token keyword" style=color:#66d9ef>as</span><span class="token plain"> dist</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 初始化MLX分布式环境</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">init</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 获取分布式信息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">world_size </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">world_size</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">rank </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> dist</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">rank</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"MLX Distributed Environment"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"World Size: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">world_size</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string-interpolation string" style=color:#a6e22e>f"Rank: </span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>{</span><span class="token string-interpolation interpolation">rank</span><span class="token string-interpolation interpolation punctuation" style=color:#f8f8f2>}</span><span class="token string-interpolation string" style=color:#a6e22e>"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 在rank 0节点上进行全局操作</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> rank </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>print</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"Performing global operations on master node..."</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic># 全局操作的代码</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=runtime-command配置示例-2>Runtime Command配置示例<a href=#runtime-command配置示例-2 class=hash-link aria-label="Direct link to Runtime Command配置示例" title="Direct link to Runtime Command配置示例">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># Launcher容器使用mpirun启动</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> mpirun</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token key atrule">args</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">hostfile</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> /etc/mpi/hostfile</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">allow</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">run</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">as</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">root</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">mca</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> btl_tcp_if_include</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> eth0</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> python</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> /workspace/train.py</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=torchtune框架环境变量>TorchTune框架环境变量<a href=#torchtune框架环境变量 class=hash-link aria-label="Direct link to TorchTune框架环境变量" title="Direct link to TorchTune框架环境变量">​</a></h2>
<p><code>TorchTune</code>是<code>PyTorch</code>官方提供的<code>LLM</code>（大语言模型）微调库，专门用于微调预训练的大模型（如<code>Llama</code>、<code>Mistral</code>等）。<code>TorchTune</code>提供了开箱即用的微调配方（<code>recipes</code>）、内存优化技术（如<code>LoRA</code>、<code>QLoRA</code>）和分布式训练支持。在<code>Kubeflow Trainer</code>中，<code>TorchTune</code>使用<code>torchrun</code>启动，但采用命令行参数而非环境变量来配置分布式参数。</p>
<p><code>TorchTune</code>是<code>PyTorch</code>官方的<code>LLM</code>微调框架，使用<code>torchrun</code>启动，但环境变量注入方式与标准<code>PyTorch</code>略有不同。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=torchtune特殊处理>TorchTune特殊处理<a href=#torchtune特殊处理 class=hash-link aria-label="Direct link to TorchTune特殊处理" title="Direct link to TorchTune特殊处理">​</a></h3>
<p><code>TorchTune</code>使用命令行参数而非环境变量来配置分布式训练，<code>Kubeflow Trainer</code>会自动将分布式参数注入到<code>command</code>和<code>args</code>中：</p>
<table><thead><tr><th>命令行参数<th>说明<th>注入来源<th>示例值<tbody><tr><td><code>--nnodes</code><td>训练节点总数<td><code>spec.trainer.numNodes</code><td><code>--nnodes=2</code><tr><td><code>--nproc_per_node</code><td>每节点进程数<td><code>spec.mlPolicy.torch.numProcPerNode</code><td><code>--nproc_per_node=auto</code><tr><td><code>--node_rank</code><td>当前节点编号<td><code>JOB_COMPLETION_INDEX</code><td><code>--node_rank=0</code><tr><td><code>--rdzv_endpoint</code><td>主节点端点<td>自动生成<td><code>--rdzv_endpoint=myjob-node-0-0.myjob:29400</code></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=标准分布式训练环境变量-1>标准分布式训练环境变量<a href=#标准分布式训练环境变量-1 class=hash-link aria-label="Direct link to 标准分布式训练环境变量" title="Direct link to 标准分布式训练环境变量">​</a></h3>
<p><code>torchrun</code>启动后，<code>TorchTune</code>训练脚本同样可以访问以下环境变量：</p>
<table><thead><tr><th>环境变量<th>说明<th>示例值<tbody><tr><td><code>WORLD_SIZE</code><td>总进程数<td><code>8</code><tr><td><code>RANK</code><td>全局进程编号<td><code>0-7</code><tr><td><code>LOCAL_RANK</code><td>本地进程编号<td><code>0-3</code><tr><td><code>MASTER_ADDR</code><td>主节点地址<td><code>myjob-node-0-0.myjob</code><tr><td><code>MASTER_PORT</code><td>主节点端口<td><code>29400</code></table>
<p><strong>说明</strong>：</p>
<ul>
<li><code>TorchTune</code>与标准<code>PyTorch</code>共享相同的<code>ML Policy</code>配置</li>
<li><code>Kubeflow Trainer</code>会自动检测<code>TorchTune</code>训练任务（通过<code>command</code>判断）</li>
<li>对于<code>TorchTune</code>，分布式参数通过命令行参数注入，而非<code>PET_*</code>环境变量</li>
<li>训练代码可以使用标准的<code>torch.distributed</code> API获取分布式信息</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=mpi框架环境变量>MPI框架环境变量<a href=#mpi框架环境变量 class=hash-link aria-label="Direct link to MPI框架环境变量" title="Direct link to MPI框架环境变量">​</a></h2>
<p><code>MPI</code>（<code>Message Passing Interface</code>）是高性能计算（<code>HPC</code>）领域的标准通信协议，广泛用于并行计算和分布式训练。<code>MPI</code>提供了进程间通信的底层接口，支持点对点通信、集合通信等操作。<code>Kubeflow Trainer</code>支持<code>OpenMPI</code>、<code>Intel MPI</code>和<code>MPICH</code>三种实现，自动处理节点间的<code>SSH</code>通信和<code>hostfile</code>配置。</p>
<p><code>MPI</code>（<code>Message Passing Interface</code>）框架支持多种实现，<code>Kubeflow Trainer</code>目前支持<code>OpenMPI</code>、<code>Intel MPI</code>和<code>MPICH</code>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=openmpi环境变量>OpenMPI环境变量<a href=#openmpi环境变量 class=hash-link aria-label="Direct link to OpenMPI环境变量" title="Direct link to OpenMPI环境变量">​</a></h3>
<table><thead><tr><th>环境变量<th>说明<th>示例值<tbody><tr><td><code>OMPI_MCA_orte_default_hostfile</code><td>主机列表文件路径<td><code>/etc/mpi/hostfile</code><tr><td><code>OMPI_MCA_plm_rsh_args</code><td><code>SSH</code>远程启动参数<td><code>-o ConnectionAttempts=10</code><tr><td><code>OMPI_MCA_orte_keep_fqdn_hostnames</code><td>保持完整主机名<td><code>true</code><tr><td><code>OMPI_MCA_orte_set_default_slots</code><td>默认<code>slot</code>数量<td><code>4</code></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=mpi通用配置>MPI通用配置<a href=#mpi通用配置 class=hash-link aria-label="Direct link to MPI通用配置" title="Direct link to MPI通用配置">​</a></h3>
<p><code>Kubeflow Trainer</code>会自动生成<code>MPI hostfile</code>，内容格式如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">trainjob-node-0-0.trainjob slots=4</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">trainjob-node-0-1.trainjob slots=4</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>其中<code>slots</code>数量等于<code>spec.mlPolicy.mpi.numProcPerNode</code>的值。</p>
<p><strong>说明</strong>：</p>
<ul>
<li><code>Kubeflow Trainer</code>自动生成<code>SSH</code>密钥用于节点间安全通信</li>
<li><code>hostfile</code>自动创建并挂载到<code>/etc/mpi/hostfile</code>路径</li>
<li><code>numProcPerNode</code>对应<code>MPI hostfile</code>中的<code>slots</code>数量</li>
<li>支持三种<code>MPI</code>实现：<code>OpenMPI</code>（默认）、<code>Intel MPI</code>、<code>MPICH</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=通用环境变量>通用环境变量<a href=#通用环境变量 class=hash-link aria-label="Direct link to 通用环境变量" title="Direct link to 通用环境变量">​</a></h2>
<p>所有框架都可以使用以下<code>Kubernetes</code>原生环境变量：</p>
<table><thead><tr><th>环境变量<th>说明<th>示例值<tbody><tr><td><code>JOB_COMPLETION_INDEX</code><td>节点索引（<code>0</code>开始）<td><code>0-1</code></table>
<p><strong>说明</strong>：</p>
<ul>
<li>此变量来自<code>Kubernetes Job</code>的索引机制，表示当前<code>Pod</code>在<code>Job</code>中的序号</li>
<li>可用于获取节点编号或配置节点特定行为</li>
<li>通常用于确定当前节点的角色（如主节点、工作节点）</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=参考资料>参考资料<a href=#参考资料 class=hash-link aria-label="Direct link to 参考资料" title="Direct link to 参考资料">​</a></h2>
<ul>
<li><a href=https://docs.pytorch.org/docs/stable/distributed.html#environment-variable-initialization target=_blank rel="noopener noreferrer">PyTorch Distributed 环境变量文档</a></li>
<li><a href=https://www.deepspeed.ai/getting-started/#mpi-and-azureml-compatibility target=_blank rel="noopener noreferrer">DeepSpeed MPI启动文档</a></li>
<li><a href=https://ml-explore.github.io/mlx/build/html/usage/distributed.html target=_blank rel="noopener noreferrer">MLX 分布式训练文档</a></li>
<li><a href=https://github.com/kubeflow/trainer target=_blank rel="noopener noreferrer">Kubeflow Trainer GitHub 仓库</a></li>
<li><a href=https://www.open-mpi.org/doc/v4.1/ target=_blank rel="noopener noreferrer">OpenMPI 环境变量文档</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/ai/kubeflow-trainer-crd-reference><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Kubeflow Trainer CRD配置格式详解</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/ai/kubeflow-trainer-deploy-usage><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Kubeflow Trainer 安装、部署及使用</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#环境变量注入流程 class="table-of-contents__link toc-highlight">环境变量注入流程</a><li><a href=#pytorch框架环境变量 class="table-of-contents__link toc-highlight">PyTorch框架环境变量</a><ul><li><a href=#pet_系列环境变量 class="table-of-contents__link toc-highlight">PET_*系列环境变量</a><li><a href=#标准分布式训练环境变量 class="table-of-contents__link toc-highlight">标准分布式训练环境变量</a><li><a href=#pytorch训练脚本示例 class="table-of-contents__link toc-highlight">PyTorch训练脚本示例</a><li><a href=#runtime-command配置示例 class="table-of-contents__link toc-highlight">Runtime Command配置示例</a></ul><li><a href=#deepspeed框架环境变量 class="table-of-contents__link toc-highlight">DeepSpeed框架环境变量</a><ul><li><a href=#mpi环境变量openmpi实现 class="table-of-contents__link toc-highlight">MPI环境变量（OpenMPI实现）</a><li><a href=#deepspeed分布式环境变量 class="table-of-contents__link toc-highlight">DeepSpeed分布式环境变量</a><li><a href=#deepspeed训练脚本示例 class="table-of-contents__link toc-highlight">DeepSpeed训练脚本示例</a><li><a href=#runtime-command配置示例-1 class="table-of-contents__link toc-highlight">Runtime Command配置示例</a></ul><li><a href=#mlx框架环境变量 class="table-of-contents__link toc-highlight">MLX框架环境变量</a><ul><li><a href=#mpi环境变量openmpi实现-1 class="table-of-contents__link toc-highlight">MPI环境变量（OpenMPI实现）</a><li><a href=#mlx分布式环境变量 class="table-of-contents__link toc-highlight">MLX分布式环境变量</a><li><a href=#mlx训练脚本示例 class="table-of-contents__link toc-highlight">MLX训练脚本示例</a><li><a href=#runtime-command配置示例-2 class="table-of-contents__link toc-highlight">Runtime Command配置示例</a></ul><li><a href=#torchtune框架环境变量 class="table-of-contents__link toc-highlight">TorchTune框架环境变量</a><ul><li><a href=#torchtune特殊处理 class="table-of-contents__link toc-highlight">TorchTune特殊处理</a><li><a href=#标准分布式训练环境变量-1 class="table-of-contents__link toc-highlight">标准分布式训练环境变量</a></ul><li><a href=#mpi框架环境变量 class="table-of-contents__link toc-highlight">MPI框架环境变量</a><ul><li><a href=#openmpi环境变量 class="table-of-contents__link toc-highlight">OpenMPI环境变量</a><li><a href=#mpi通用配置 class="table-of-contents__link toc-highlight">MPI通用配置</a></ul><li><a href=#通用环境变量 class="table-of-contents__link toc-highlight">通用环境变量</a><li><a href=#参考资料 class="table-of-contents__link toc-highlight">参考资料</a></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2026 johng.cn</div></div></div></footer></div>