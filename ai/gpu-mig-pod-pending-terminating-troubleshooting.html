<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docs/AI技术/AI基础架构/NVIDIA/GPU MIG拆卡后，调度到该节点的Pod偶发Pending、Terminating状态阻塞问题排查" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>GPU MIG拆卡后Pod偶发Pending/Terminating状态阻塞问题排查 | John's Blog</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://johng.cn/ai/gpu-mig-pod-pending-terminating-troubleshooting><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=author content="John Guo"><meta data-rh=true property=og:image content=https://johng.cn/img/favicon.png><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="GPU MIG拆卡后Pod偶发Pending/Terminating状态阻塞问题排查 | John's Blog"><meta data-rh=true name=description content="深入分析GPU MIG拆卡后Pod一直处于Pending或Terminating状态的根因，通过kubelet源码分析发现GetPreferredAllocation接口阻塞问题，最终定位到NVIDIA驱动570.158.01版本的nvml初始化BUG，提供完整的故障排查思路和解决方案"><meta data-rh=true property=og:description content="深入分析GPU MIG拆卡后Pod一直处于Pending或Terminating状态的根因，通过kubelet源码分析发现GetPreferredAllocation接口阻塞问题，最终定位到NVIDIA驱动570.158.01版本的nvml初始化BUG，提供完整的故障排查思路和解决方案"><meta data-rh=true name=keywords content="GPU MIG,Pod Pending,Pod Terminating,kubelet阻塞,DevicePlugin,GetPreferredAllocation,NVIDIA H20,nvidia-driver,nvml init,Kubernetes故障排查,GPU Operator,device plugin阻塞"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://johng.cn/ai/gpu-mig-pod-pending-terminating-troubleshooting><link data-rh=true rel=alternate href=https://johng.cn/ai/gpu-mig-pod-pending-terminating-troubleshooting hreflang=en><link data-rh=true rel=alternate href=https://johng.cn/ai/gpu-mig-pod-pending-terminating-troubleshooting hreflang=x-default><link data-rh=true rel=preconnect href=https://XGS1CPQERK-dsn.algolia.net crossorigin><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="John's Blog RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="John's Blog Atom Feed"><link rel=search type=application/opensearchdescription+xml title="John's Blog" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?6b4ae23dc83ee5efe875b7172af6c7c1 async></script><link rel=stylesheet href=/assets/css/styles.2f56d3c4.css><script src=/assets/js/runtime~main.2f1d518f.js defer></script><script src=/assets/js/main.135d121c.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><b class="navbar__title text--truncate">John's Blog</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/ai>AI技术</a><a class="navbar__item navbar__link" href=/cloud-native>云原生</a><a class="navbar__item navbar__link" href=/notes>日常笔记</a><a class="navbar__item navbar__link" href=/programming>开发语言</a><a class="navbar__item navbar__link" href=/architecture>技术架构</a><a class="navbar__item navbar__link" href=/observability>可观测性</a><a class="navbar__item navbar__link" href=/database-and-middleware>数据库与中间件</a><a class="navbar__item navbar__link" href=/life>生活笔记</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href=/aboutme>关于我</a><a class="navbar__item navbar__link" href=/blog>博客</a><a href=https://goframe.org/ target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-goframe-link"></a><a href=https://github.com/gqcn target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/ai>AI技术</a><button aria-label="Collapse sidebar category 'AI技术'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/app>AI应用技术</a><button aria-label="Expand sidebar category 'AI应用技术'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/ai/infra>AI基础架构</a><button aria-label="Collapse sidebar category 'AI基础架构'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/hpc>HPC</a><button aria-label="Expand sidebar category 'HPC'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/vgpu>vGPU</a><button aria-label="Expand sidebar category 'vGPU'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/rdma>RDMA</a><button aria-label="Expand sidebar category 'RDMA'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/ai/nvidia>NVIDIA</a><button aria-label="Collapse sidebar category 'NVIDIA'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/nfd-gfd>NFD&GFD</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/gpu-operator>GPU Operator</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/gpu-dcgm-exporter>GPU DCGM-Exporter监控方案</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/gpu-pcie-vs-sxm>GPU PCIe版和SXM版的区别</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/gpu-share-solutions>GPU Share 常见技术方案</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/gpu-share-mps-mig>GPU Share MPS&MIG具体操作与注意事项</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/gpu-mig-docker-specify-subcard>GPU MIG拆卡后使用docker指定子卡执行</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/ai/gpu-mig-pod-pending-terminating-troubleshooting>GPU MIG拆卡后Pod偶发Pending/Terminating状态阻塞问题排查</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class=menu__link tabindex=0 href=/ai/gpu-environment-setup-guide>GPU环境搭建指南：在裸机、Docker、K8S环境中使用GPU</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/distributed-inference>分布式推理</a><button aria-label="Expand sidebar category '分布式推理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/scheduling>算力资源调度</a><button aria-label="Expand sidebar category '算力资源调度'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/what-is-llmops-mlops>LLMOps介绍</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/common-acceleration-cards>常见智算加速卡汇总</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/common-ai-model-training-inference-framework>常见AI模型训练推理框架对比</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/ai/ai-training-inference-scenarios>AI模型训练推理常见业务场景痛点</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ai/basic>AI入门知识</a><button aria-label="Expand sidebar category 'AI入门知识'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/cloud-native>云原生</a><button aria-label="Expand sidebar category '云原生'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/notes>日常笔记</a><button aria-label="Expand sidebar category '日常笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/programming>开发语言</a><button aria-label="Expand sidebar category '开发语言'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/architecture>技术架构</a><button aria-label="Expand sidebar category '技术架构'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/management>技术管理</a><button aria-label="Expand sidebar category '技术管理'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/observability>可观测性</a><button aria-label="Expand sidebar category '可观测性'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/database-and-middleware>数据库与中间件</a><button aria-label="Expand sidebar category '数据库与中间件'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/operating-systems-and-networks>操作系统和网络</a><button aria-label="Expand sidebar category '操作系统和网络'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/life>生活笔记</a><button aria-label="Expand sidebar category '生活笔记'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai><span itemprop=name>AI技术</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai/infra><span itemprop=name>AI基础架构</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ai/nvidia><span itemprop=name>NVIDIA</span></a><meta itemprop=position content=3><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>GPU MIG拆卡后Pod偶发Pending/Terminating状态阻塞问题排查</span><meta itemprop=position content=4></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id=背景描述>背景描述<a href=#背景描述 class=hash-link aria-label="Direct link to 背景描述" title="Direct link to 背景描述">​</a></h2>
<p>在对<code>GPU H20</code>加速卡进行<code>MIG</code>拆卡后，模型推理任务调度到该卡的节点上偶尔会阻塞在<code>Pending</code>的状态，无法正常启动。查看<code>Pod</code>的状态时，<code>Event</code>信息如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">Events:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  Type    Reason     Age   From               Message</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  ----    ------     ----  ----               -------</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  Normal  Scheduled  11m   default-scheduler  Successfully assigned mck-test/neal-0729-6-68b4895fb7-6868w to ai-app-8-1-msxf</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>如果对<code>Pod</code>进行删除，或者对<code>Pod</code>关联的<code>Deployment</code>进行删除后，<code>Pod</code>将会一直阻塞在<code>Terminating</code>状态，查看<code>Pod</code>状态时发现<code>Event</code>信息也一直没有变更。</p>
<p>尝试过重启<code>kubelet</code>和<code>nvidia device plugin</code>，随后当前<code>Pending/Terminating</code>的<code>Pod</code>会恢复，但后续的<code>Pod</code>仍将出现同样的问题。</p>
<p>并且该问题是偶现的，但问题出现后，所有调度到该节点的<code>Pod</code>都会出现该问题，无论该<code>Pod</code>是否会请求<code>GPU</code>卡或者<code>MIG</code>子卡，均无法自动恢复，必须要手动取消对该节点上的<code>GPU MIG</code>拆卡策略后才能恢复。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=环境信息>环境信息<a href=#环境信息 class=hash-link aria-label="Direct link to 环境信息" title="Direct link to 环境信息">​</a></h2>
<p>系统内核信息：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ uname -a</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Linux ai-app-8-1-msxf 5.15.0-1078-nvidia #79-Ubuntu SMP Fri Apr 25 14:51:39 UTC 2025 x86_64 x86_64 x86_64 GNU/Linux</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>系统版本信息：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ cat /etc/issue</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Ubuntu 22.04.5 LTS </span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>节点<code>GPU</code>卡信息，其中<code>GPU 0~2</code>卡进行了<code>MIG</code>拆卡，每张卡拆分为了<code>4</code>张子卡：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ nvidia-smi -L</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU 0: NVIDIA H20 (UUID: GPU-2f815c32-768d-d782-1073-db01d7b90215)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  MIG 3g.48gb     Device  0: (UUID: MIG-e76cc178-e1f3-5596-a9e1-84fa6bffa030)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  MIG 1g.24gb     Device  1: (UUID: MIG-160ae368-7334-5d1e-91ad-d6eb55ec6f67)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  MIG 1g.12gb     Device  2: (UUID: MIG-ac6829e7-b466-50e4-917c-b77aee4c5016)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  MIG 1g.12gb     Device  3: (UUID: MIG-4e18003f-f745-5d17-b03f-203b7cbb671b)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU 1: NVIDIA H20 (UUID: GPU-bafcf1f7-1006-01e5-85e2-684fee364617)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  MIG 3g.48gb     Device  0: (UUID: MIG-f28b28ea-2a63-569d-8e74-0068dd6efb1c)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  MIG 1g.24gb     Device  1: (UUID: MIG-9244fc71-c9b9-5a4c-8588-8b991d1df2a1)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  MIG 1g.12gb     Device  2: (UUID: MIG-70b0f862-2a3b-5056-89f6-4e1bc03f0913)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  MIG 1g.12gb     Device  3: (UUID: MIG-a93cbeea-c3ce-5933-9512-35fde18fe2fd)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU 2: NVIDIA H20 (UUID: GPU-b0c5b618-67d0-f464-9905-e1fd41226305)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  MIG 3g.48gb     Device  0: (UUID: MIG-de57fa99-1a2b-5462-9a2e-71d72261a6c2)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  MIG 1g.24gb     Device  1: (UUID: MIG-e25ff671-e5b4-55ca-ae65-7d82bdc026f7)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  MIG 1g.12gb     Device  2: (UUID: MIG-9429d092-1945-524b-8a22-474247772105)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  MIG 1g.12gb     Device  3: (UUID: MIG-e99237a2-b951-5f96-af7b-d0c5ecedb6f4)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU 3: NVIDIA H20 (UUID: GPU-4695a002-ab2d-092d-6db9-44e9ae3cb5a6)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU 4: NVIDIA H20 (UUID: GPU-39862681-62c1-28f7-0244-5563c070a260)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU 5: NVIDIA H20 (UUID: GPU-f055d080-1808-96f1-1c87-70fad19d9040)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU 6: NVIDIA H20 (UUID: GPU-4650fca3-dbba-f168-d6bd-338a4ba8f044)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">GPU 7: NVIDIA H20 (UUID: GPU-9648f14e-6ab2-46f0-221f-777f7652630b)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>Kubernetes</code>版本信息：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ kubectl version</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Client Version: v1.28.2</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Kustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Server Version: v1.27.5</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=排查过程>排查过程<a href=#排查过程 class=hash-link aria-label="Direct link to 排查过程" title="Direct link to 排查过程">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=关键日志排查>关键日志排查<a href=#关键日志排查 class=hash-link aria-label="Direct link to 关键日志排查" title="Direct link to 关键日志排查">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=kubelet日志初查>kubelet日志初查<a href=#kubelet日志初查 class=hash-link aria-label="Direct link to kubelet日志初查" title="Direct link to kubelet日志初查">​</a></h4>
<p>从<code>Pod</code>（<code>neal-0729-6-68b4895fb7-6868w</code>）的状态信息来看：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">Events:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  Type    Reason     Age   From               Message</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  ----    ------     ----  ----               -------</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  Normal  Scheduled  11m   default-scheduler  Successfully assigned mck-test/neal-0729-6-68b4895fb7-6868w to ai-app-8-1-msxf</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>Kubernetes</code>调度器是没有问题的，因为调度器已经将<code>Pod</code>分配到了合适的节点（<code>ai-app-8-1-msxf</code>）上了，后续便是该节点上的<code>kubelet</code>的工作了。但实际上<code>Pod</code>上并没有展示任何的<code>kubelet</code>操作事件，说明该节点上的<code>kubelet</code>没有正常工作。</p>
<p>因此我们优先去排查<code>kubelet</code>的日志，大致通过以下命令来排查：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">journalctl </span><span class="token parameter variable" style=color:#f8f8f2>-u</span><span class="token plain"> kubelet </span><span class="token parameter variable" style=color:#f8f8f2>-f</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">journalctl </span><span class="token parameter variable" style=color:#f8f8f2>-u</span><span class="token plain"> kubelet </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> neal-0729-6-68b4895fb7-6868w</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">journalctl </span><span class="token parameter variable" style=color:#f8f8f2>-u</span><span class="token plain"> kubelet </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> neal-0729-6-68b4895fb7</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>通过查询日志，观察产生的日志，实际上没有看到太有用的日志信息。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=device-plugin日志>device plugin日志<a href=#device-plugin日志 class=hash-link aria-label="Direct link to device plugin日志" title="Direct link to device plugin日志">​</a></h4>
<p>由于该问题现象与<code>GPU MIG</code>有关，因此我们很有必要去看看<code>nvidia device plugin</code>的日志。我们是使用<code>GPU Operator</code>来安装的<code>GPU</code>的相关组件，<code>nvidia device plugin</code>被安装到了<code>gpu-operator</code>的命名空间下。查看状态如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ kubectl get pod </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> gpu-operator </span><span class="token parameter variable" style=color:#f8f8f2>-owide</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">NAME                                                     READY   STATUS      RESTARTS       AGE     IP               NODE                                    NOMINATED NODE   READINESS GATES</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">gpu-feature-discovery-7mp2l                              </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">/2     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              39m     </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.52.241    ai-app-8-1-msxf                         </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain">           </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">gpu-operator-69568cb5fc-dvwsn                            </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              2d6h    </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.31.231    cluster-sak7pztche3smzr3a9-master0003   </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain">           </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">gpushare-node-feature-discovery-worker-swwc8             </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              7d5h    </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.145.3     cluster-sak7pztche3smzr3a9-node0023     </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain">           </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">gpushare-node-feature-discovery-worker-t87lm             </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>4</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">39m ago</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">    8d      </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.52.238    ai-app-8-1-msxf                         </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain">           </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">gpushare-node-feature-discovery-worker-znpzv             </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              7d5h    </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.236.161   cluster-sak7pztche3smzr3a9-node0030     </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain">           </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-container-toolkit-daemonset-q8zbd                 </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>3</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">39m ago</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">    2d6h    </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.52.251    ai-app-8-1-msxf                         </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain">           </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-cuda-validator-9584l                              </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">/1     Completed   </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              38m     </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.52.249    ai-app-8-1-msxf                         </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain">           </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-dcgm-exporter-6nxpm                               </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              39m     </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.52.248    ai-app-8-1-msxf                         </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain">           </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-device-plugin-daemonset-bbp4x                     </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">/2     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              39m     </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.52.245    ai-app-8-1-msxf                         </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain">           </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-mig-manager-n6wnt                                 </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>4</span><span class="token plain">              18h     </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.52.247    ai-app-8-1-msxf                         </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain">           </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-operator-validator-hlsjf                          </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running     </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">              39m     </span><span class="token number" style=color:#ae81ff>10.188</span><span class="token plain">.52.225    ai-app-8-1-msxf                         </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain">           </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token plain">.</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>查看<code>nvidia-device-plugin-daemonset-bbp4x</code>的日志：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">kubectl logs </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> gpu-operator nvidia-device-plugin-daemonset-bbp4x </span><span class="token parameter variable" style=color:#f8f8f2>-c</span><span class="token plain"> nvidia-device-plugin</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>实际上，<code>nvidia-device-plugin</code>的日志输出的相当少，根本没有任何有用的信息。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=containerd日志>containerd日志<a href=#containerd日志 class=hash-link aria-label="Direct link to containerd日志" title="Direct link to containerd日志">​</a></h4>
<p>在节点上看看该<code>Pod</code>对应的容器有没有成功启动，通过以下命令：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">crictl </span><span class="token function" style=color:#e6db74>ps</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">crictl </span><span class="token function" style=color:#e6db74>ps</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-a</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">crictl </span><span class="token function" style=color:#e6db74>ps</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-a</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> neal-0729-6-68b4895fb7-6868w</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">crictl </span><span class="token function" style=color:#e6db74>ps</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-a</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> neal-0729-6-68b4895fb7</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>看起来，连容器都还没启动起来。来都来了，还是简单看一下<code>containerd</code>的日志吧，说不定走狗屎运能看到什么利于问题排查的关键信息呢：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">journalctl </span><span class="token parameter variable" style=color:#f8f8f2>-u</span><span class="token plain"> containerd </span><span class="token parameter variable" style=color:#f8f8f2>-f</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>果然，之前通过查看<code>Pod</code>信息，里面连<code>容器ID</code>都没有，看<code>containerd</code>日志也没什么用。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=查看系统内核日志>查看系统内核日志<a href=#查看系统内核日志 class=hash-link aria-label="Direct link to 查看系统内核日志" title="Direct link to 查看系统内核日志">​</a></h4>
<p>查看系统内核日志，通过以下命令：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token function" style=color:#e6db74>dmesg</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-T</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>内核中有一些可疑的信息，不过是和磁盘相关的，初步感觉和当前排查的问题关联性不是很大，但还是先记录一下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">...</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">67035 Jul 30 19:46:12 ai-app-8-1-msxf kernel: [434189.944726] XFS (dm-3): Invalid superblock magic number</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">67036 Jul 30 19:46:35 ai-app-8-1-msxf kernel: [434213.828068] XFS (dm-3): Mounting V5 Filesystem</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">67037 Jul 30 19:46:35 ai-app-8-1-msxf kernel: [434213.837526] XFS (dm-3): Ending clean mount</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">67038 Jul 30 19:46:35 ai-app-8-1-msxf kernel: [434213.842750] xfs filesystem being mounted at /pdata supports timestamps until 2038-01-19 (0x7fffffff)</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">...</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">66636 Jul 29 17:54:57 ai-app-8-1-msxf kernel: [341115.681608] INFO: task containerd-shim:7663 blocked for more than 5 seconds.</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">66637 Jul 29 17:54:57 ai-app-8-1-msxf kernel: [341115.681664]       Tainted: P           OE     5.15.0-1078-nvidia #79-Ubuntu</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">66638 Jul 29 17:54:57 ai-app-8-1-msxf kernel: [341115.681692] "echo 0 > /proc/sys/kernel/hung_task_timeout_secs" disables this message.</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">66639 Jul 29 17:54:57 ai-app-8-1-msxf kernel: [341115.681718] task:containerd-shim state:D stack:    0 pid: 7663 ppid:     1 flags:0x00004000</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">66640 Jul 29 17:54:57 ai-app-8-1-msxf kernel: [341115.681729] Call Trace:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=网络社区资料检索>网络社区资料检索<a href=#网络社区资料检索 class=hash-link aria-label="Direct link to 网络社区资料检索" title="Direct link to 网络社区资料检索">​</a></h4>
<p>通常工作中我们遇到的大部分问题，我们都不会是第一个遇到的，网络上特别是开源社区中通常也会有类似问题的反馈。关键在于你能否找到这些信息，看看大家是怎么处理的，官方是如何回复的。</p>
<p>通过以下关键字在<code>Google</code>和<code>Github Issue</code>中检索相关资料：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">gpu mig pod pending terminating</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">gpu mig pod pending</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">gpu mig pod stuck</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">gpu mig pod block</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">mig pod block</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">gpu pod pending terminating</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>等等各种组合检索了资料，但是并未找到任何相关联和有用的信息。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=kubelet日志深挖>kubelet日志深挖<a href=#kubelet日志深挖 class=hash-link aria-label="Direct link to kubelet日志深挖" title="Direct link to kubelet日志深挖">​</a></h4>
<p>既然都已经排查了一圈，没有发现有用的信息，由于从<code>Pod</code>现象来看和<code>kubelet</code>关联性更大一些，因此继续排查<code>kubelet</code>的日志。</p>
<p>由于<code>kubelet</code>默认的日志等级比较低，只会打印<code>INFO</code>以下的日志，因此调整一下<code>kubelet</code>的日志等级，让它输出更详细的日志信息。
查看<code>kubelet</code>进程，通过其启动参数判断对应的配置文件路径：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ </span><span class="token function" style=color:#e6db74>ps</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-ef</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>grep</span><span class="token plain"> kubelet</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">root     </span><span class="token number" style=color:#ae81ff>25493</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>21.1</span><span class="token plain">  </span><span class="token number" style=color:#ae81ff>0.0</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>9022112</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>126716</span><span class="token plain"> ?      Ssl  </span><span class="token number" style=color:#ae81ff>19</span><span class="token plain">:45   </span><span class="token number" style=color:#ae81ff>5</span><span class="token plain">:44 /usr/local/bin/kubelet </span><span class="token parameter variable" style=color:#f8f8f2>--v</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>10</span><span class="token plain"> --node-ip</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>10.112</span><span class="token plain">.8.1 --hostname-override</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">ai-app-8-1-msxf --bootstrap-kubeconfig</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">/etc/kubernetes/bootstrap-kubelet.conf </span><span class="token parameter variable" style=color:#f8f8f2>--config</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">/etc/kubernetes/kubelet-config.yaml </span><span class="token parameter variable" style=color:#f8f8f2>--kubeconfig</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">/etc/kubernetes/kubelet.conf --container-runtime-endpoint</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">unix:///var/run/containerd/containerd.sock --runtime-cgroups</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">/system.slice/containerd.service --root-dir</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">/var/lib/kubelet</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>查看并更新<code>kubelet</code>配置：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ </span><span class="token function" style=color:#e6db74>cat</span><span class="token plain"> /etc/kubernetes/kubelet-config.yaml</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">apiVersion: kubelet.config.k8s.io/v1beta1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kind: KubeletConfiguration</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nodeStatusUpdateFrequency: </span><span class="token string" style=color:#a6e22e>"10s"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">verbosity: </span><span class="token number" style=color:#ae81ff>10</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic># 默认没有该配置项，设置为10后，日志等级会提升到V=10</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">failSwapOn: True</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">authentication:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  anonymous:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    enabled: </span><span class="token boolean" style=color:#ae81ff>false</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  webhook:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    enabled: True</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  x509:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    clientCAFile: /etc/kubernetes/ssl/ca.crt</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">authorization:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  mode: Webhook</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">staticPodPath: /etc/kubernetes/manifests</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">cgroupDriver: systemd</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">containerLogMaxFiles: </span><span class="token number" style=color:#ae81ff>5</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">containerLogMaxSize: 10Mi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">maxPods: </span><span class="token number" style=color:#ae81ff>110</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">podPidsLimit: </span><span class="token parameter variable" style=color:#f8f8f2>-1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">address: </span><span class="token number" style=color:#ae81ff>10.112</span><span class="token plain">.8.1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">readOnlyPort: </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">healthzPort: </span><span class="token number" style=color:#ae81ff>10248</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">healthzBindAddress: </span><span class="token number" style=color:#ae81ff>127.0</span><span class="token plain">.0.1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">kubeletCgroups: /system.slice/kubelet.service</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">clusterDomain: cluster.local</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">protectKernelDefaults: </span><span class="token boolean" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">rotateCertificates: </span><span class="token boolean" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">clusterDNS:</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">- </span><span class="token number" style=color:#ae81ff>10.199</span><span class="token plain">.0.3</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">resolvConf: </span><span class="token string" style=color:#a6e22e>"/run/systemd/resolve/resolv.conf"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">eventRecordQPS: </span><span class="token number" style=color:#ae81ff>50</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">shutdownGracePeriod: 60s</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">shutdownGracePeriodCriticalPods: 20s</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>重启<code>kubelet</code>服务：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">systemctl restart kubelet</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>随后继续观察日志，寻找关键信息以及日志规律。看到一些可疑的信息，记录一下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">...</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:01:46 ai-app-8-1-msxf kubelet[45878]: I0730 21:01:46.109395   45878 fs.go:419] unable to determine file system type, partition mountpoint does not exist: /run/containerd/io></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:01:46 ai-app-8-1-msxf kubelet[45878]: I0730 21:01:46.110307   45878 fs.go:419] unable to determine file system type, partition mountpoint does not exist: /home/kubelet/pods></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:01:46 ai-app-8-1-msxf kubelet[45878]: I0730 21:01:46.110316   45878 fs.go:419] unable to determine file system type, partition mountpoint does not exist: /run/containerd/io></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:01:46 ai-app-8-1-msxf kubelet[45878]: I0730 21:01:46.110440   45878 fs.go:419] unable to determine file system type, partition mountpoint does not exist: /home/kubelet/pods></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:01:46 ai-app-8-1-msxf kubelet[45878]: I0730 21:01:46.110529   45878 fs.go:419] unable to determine file system type, partition mountpoint does not exist: /run/containerd/io></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">...</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:01:46 ai-app-8-1-msxf kubelet[45878]: I0730 21:01:46.149822   45878 cri_stats_provider.go:499] "Unable to find network stats for sandbox" sandboxID="4349bc2464369f69eba8add></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:01:46 ai-app-8-1-msxf kubelet[45878]: I0730 21:01:46.149948   45878 cri_stats_provider.go:499] "Unable to find network stats for sandbox" sandboxID="07dea91cfecc5008f2d99b6></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:01:46 ai-app-8-1-msxf kubelet[45878]: I0730 21:01:46.150046   45878 cri_stats_provider.go:499] "Unable to find network stats for sandbox" sandboxID="766ed5f4f36f5de9bf0dc80></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:01:46 ai-app-8-1-msxf kubelet[45878]: I0730 21:01:46.150181   45878 cri_stats_provider.go:499] "Unable to find network stats for sandbox" sandboxID="df5fd0dc977bb03adf9fc54></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:01:46 ai-app-8-1-msxf kubelet[45878]: I0730 21:01:46.150273   45878 cri_stats_provider.go:499] "Unable to find network stats for sandbox" sandboxID="023989878ee015cc9a97e9d></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:01:46 ai-app-8-1-msxf kubelet[45878]: I0730 21:01:46.150401   45878 cri_stats_provider.go:499] "Unable to find network stats for sandbox" sandboxID="df5fd0dc977bb03adf9fc54></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>另外，以下信息看起来和<code>cadvisor</code>有一定关联，不知道是否和当前排查问题有关，也先记录一下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">...</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:02:03 ai-app-8-1-msxf kubelet[45878]: I0730 21:02:03.804312   45878 factory.go:260] Factory "containerd" was unable to handle container "/user.slice/user-40492906.slice/ses></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:02:03 ai-app-8-1-msxf kubelet[45878]: I0730 21:02:03.804315   45878 factory.go:260] Factory "systemd" was unable to handle container "/user.slice/user-40492906.slice/sessio></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:02:03 ai-app-8-1-msxf kubelet[45878]: I0730 21:02:03.804319   45878 factory.go:253] Factory "raw" can handle container "/user.slice/user-40492906.slice/session-8458.scope",></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:02:03 ai-app-8-1-msxf kubelet[45878]: I0730 21:02:03.804324   45878 manager.go:919] ignoring container "/user.slice/user-40492906.slice/session-8458.scope"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:02:03 ai-app-8-1-msxf kubelet[45878]: I0730 21:02:03.804328   45878 factory.go:260] Factory "containerd" was unable to handle container "/user.slice/user-40489916.slice/ses></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:02:03 ai-app-8-1-msxf kubelet[45878]: I0730 21:02:03.804332   45878 factory.go:260] Factory "systemd" was unable to handle container "/user.slice/user-40489916.slice/sessio></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:02:03 ai-app-8-1-msxf kubelet[45878]: I0730 21:02:03.804336   45878 factory.go:253] Factory "raw" can handle container "/user.slice/user-40489916.slice/session-8529.scope",></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:02:03 ai-app-8-1-msxf kubelet[45878]: I0730 21:02:03.804340   45878 manager.go:919] ignoring container "/user.slice/user-40489916.slice/session-8529.scope"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 21:02:03 ai-app-8-1-msxf kubelet[45878]: I0730 21:02:03.804343   45878 factory.go:260] Factory "containerd" was unable to handle container </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>似乎看起来没有直接与当前问题明显关联的日志。</p>
<p>随后，以使用<code>GPU</code>卡的<code>Pod</code>为例，通过对比正常的<code>Pod</code>启动日志和异常启动（阻塞在<code>Pending</code>状态）的<code>Pod</code>日志。</p>
<p>正常启动的<code>Pod</code>日志大概是这样的：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">...</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.951650   26361 manager.go:773] "Looking for needed resources" needed=1 resourceName="nvidia.com/mig-3g.48gb"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.951690   26361 manager.go:523] "Pods to be removed" podUIDs=[bc17fe76-a3c2-4ed6-b203-816dc0c24188]</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.951716   26361 manager.go:548] "Need devices to allocate for pod" deviceNumber=1 resourceName="nvidia.com/mig-3g.48gb" podUID="cf97dd7e-bc61-44c1-8241-b47204a2e9b1" containerName="neal-0729-1"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.951749   26361 manager.go:956] "Issuing a GetPreferredAllocation call for container" containerName="neal-0729-1" podUID="cf97dd7e-bc61-44c1-8241-b47204a2e9b1"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.952761   26361 manager.go:819] "Making allocation request for device plugin" devices=[MIG-5e2f454b-6cf3-51c3-a060-0a34ba38dfe4] resourceName="nvidia.com/mig-3g.48gb"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.953459   26361 manager.go:773] "Looking for needed resources" needed=12 resourceName="cpu"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.953490   26361 manager.go:773] "Looking for needed resources" needed=50331648000 resourceName="memory"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.954888   26361 pod_workers.go:770] "Pod is being synced for the first time" pod="mck-test/neal-0729-1-6f67d4dd6f-bw8pz" podUID=cf97dd7e-bc61-44c1-8241-b47204a2e9b1 updateType="create"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.954940   26361 pod_workers.go:965] "Notifying pod of pending update" pod="mck-test/neal-0729-1-6f67d4dd6f-bw8pz" podUID=cf97dd7e-bc61-44c1-8241-b47204a2e9b1 workType="sync"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.954987   26361 pod_workers.go:1226] "Processing pod event" pod="mck-test/neal-0729-1-6f67d4dd6f-bw8pz" podUID=cf97dd7e-bc61-44c1-8241-b47204a2e9b1 updateType="sync"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.955043   26361 kubelet.go:1666] "SyncPod enter" pod="mck-test/neal-0729-1-6f67d4dd6f-bw8pz" podUID=cf97dd7e-bc61-44c1-8241-b47204a2e9b1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.955087   26361 kubelet_pods.go:1578] "Generating pod status" podIsTerminal=false pod="mck-test/neal-0729-1-6f67d4dd6f-bw8pz"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.955140   26361 kubelet_pods.go:1591] "Got phase for pod" pod="mck-test/neal-0729-1-6f67d4dd6f-bw8pz" oldPhase=Pending phase=Pending</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.955346   26361 reflector.go:287] Starting reflector *v1.ConfigMap (0s) from object-"mck-test"/"kube-root-ca.crt"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.955363   26361 reflector.go:323] Listing and watching *v1.ConfigMap from object-"mck-test"/"kube-root-ca.crt"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.955346   26361 status_manager.go:217] "Syncing updated statuses"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>异常启动（阻塞在<code>Pending</code>状态）的<code>Pod</code>日志大概是这样的：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">...</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.752764   45878 kubelet.go:2343] "SyncLoop ADD" source="api" pods=[mck-test/neal-0729-6-8686d45f8c-rgsr9]</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.752799   45878 topology_manager.go:212] "Topology Admit Handler"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.752952   45878 manager.go:773] "Looking for needed resources" needed=1 resourceName="nvidia.com/gpu"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.752987   45878 manager.go:548] "Need devices to allocate for pod" deviceNumber=1 resourceName="nvidia.com/gpu" podUID="69e0758e-d625-4013-9258-df8b7ddf04e2" containerName="neal-0729-6"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.753013   45878 manager.go:956] "Issuing a GetPreferredAllocation call for container" containerName="neal-0729-6" podUID="69e0758e-d625-4013-9258-df8b7ddf04e2"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.804100   45878 factory.go:260] Factory "containerd" was unable to handle container "/system.slice/sssd-ssh.socket"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.804115   45878 factory.go:260] Factory "systemd" was unable to handle container "/system.slice/sssd-ssh.socket"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.804121   45878 factory.go:253] Factory "raw" can handle container "/system.slice/sssd-ssh.socket", but ignoring.</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.804129   45878 manager.go:919] ignoring container "/system.slice/sssd-ssh.socket"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.804134   45878 factory.go:260] Factory "containerd" was unable to handle container "/system.slice/nvidia-fabricmanager.service"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.804138   45878 factory.go:260] Factory "systemd" was unable to handle container "/system.slice/nvidia-fabricmanager.service"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.804142   45878 factory.go:253] Factory "raw" can handle container "/system.slice/nvidia-fabricmanager.service", but ignoring.</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.804148   45878 manager.go:919] ignoring container "/system.slice/nvidia-fabricmanager.service"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.804152   45878 factory.go:260] Factory "containerd" was unable to handle container "/user.slice/user-40489916.slice/session-8529.scope"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.804155   45878 factory.go:260] Factory "systemd" was unable to handle container "/user.slice/user-40489916.slice/session-8529.scope"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.804159   45878 factory.go:253] Factory "raw" can handle container "/user.slice/user-40489916.slice/session-8529.scope", but ignoring.</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.804164   45878 manager.go:919] ignoring container "/user.slice/user-40489916.slice/session-8529.scope"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>我们可以发现，正常启动的<code>Pod</code>，会有以下与<code>GPU</code>资源分配的日志顺序输出：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.951749   26361 manager.go:956] "Issuing a GetPreferredAllocation call for container" containerName="neal-0729-1" podUID="cf97dd7e-bc61-44c1-8241-b47204a2e9b1"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.952761   26361 manager.go:819] "Making allocation request for device plugin" devices=[MIG-5e2f454b-6cf3-51c3-a060-0a34ba38dfe4] resourceName="nvidia.com/mig-3g.48gb"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.953459   26361 manager.go:773] "Looking for needed resources" needed=12 resourceName="cpu"</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 19:37:03 ai-app-8-1-msxf kubelet[26361]: I0730 19:37:03.953490   26361 manager.go:773] "Looking for needed resources" needed=50331648000 resourceName="memory"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>异常启动（阻塞在<code>Pending</code>状态）的<code>Pod</code>，只输出以下日志后就没有其他类似的日志输出了：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">Jul 30 20:39:03 ai-app-8-1-msxf kubelet[45878]: I0730 20:39:03.753013   45878 manager.go:956] "Issuing a GetPreferredAllocation call for container" containerName="neal-0729-6" podUID="69e0758e-d625-4013-9258-df8b7ddf04e2"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>看样子是这个操作<code>Issuing a GetPreferredAllocation call for container</code>之后，要么请求断掉了、要么<code>kubelet</code>执行流程被阻塞了。如果是<code>kubelet</code>执行流程被阻塞的话，那么便能够解释异常<code>Pod</code>的现象。因为后续所有<code>Pod</code>的创建/销毁都被阻塞了，事件和状态未更新，这种情况只有在<code>kubelet</code>假死才可能出现。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=日志结果分析>日志结果分析<a href=#日志结果分析 class=hash-link aria-label="Direct link to 日志结果分析" title="Direct link to 日志结果分析">​</a></h3>
<p>从前面的日志排查来看，关键突破口在<code>Issuing a GetPreferredAllocation call for container</code>这个日志这个地方。该日志是由<code>kubelet</code>的<code>DeviceManager</code>打印的，该<code>DeviceManager</code>负责与注册的<code>DevicePlugin</code>交互。</p>
<p><code>DevicePlugin</code>是<code>kubenetes</code>的插件机制，负责与<code>kubelet</code>进行交互，管理扩展设备，比如<code>GPU</code>、<code>NPU</code>、<code>PPU</code>等<code>AI</code>模型训练中常用的加速卡设备。关于<code>Kubernetes DevicePlugin</code>机制的详细介绍，请参考我另一篇文章：<a href=/cloud-native/kubernetes-device-plugin>Kubernetes DevicePlugin</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=kubelet与deviceplugin交互流程>kubelet与DevicePlugin交互流程<a href=#kubelet与deviceplugin交互流程 class=hash-link aria-label="Direct link to kubelet与DevicePlugin交互流程" title="Direct link to kubelet与DevicePlugin交互流程">​</a></h4>
<p><code>kubelet</code>与<code>DevicePlugin</code>的交互涉及的接口请参考<code>kubeket</code>中的源码定义：<a href=https://github.com/kubernetes/kubernetes/blob/b57c7e2fe4bb466ff1614aa9df7cc164e90b24b6/staging/src/k8s.io/kubelet/pkg/apis/deviceplugin/v1beta1/api.proto target=_blank rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/blob/b57c7e2fe4bb466ff1614aa9df7cc164e90b24b6/staging/src/k8s.io/kubelet/pkg/apis/deviceplugin/v1beta1/api.proto</a></p>
<p><code>DevicePlugin</code>接口简要介绍如下：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">service Registration </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// DevicePlugin将自身注册到kubelet</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    rpc </span><span class="token function" style=color:#e6db74>Register</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">RegisterRequest</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> returns </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">Empty</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">service DevicePlugin </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 获取设备插件的配置选项，用于与kubelet的DeviceManager通信</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    rpc </span><span class="token function" style=color:#e6db74>GetDevicePluginOptions</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">Empty</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> returns </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">DevicePluginOptions</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 持续监听设备状态变化，返回设备列表的数据流</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 当设备状态发生变化或设备消失时，会推送最新的设备列表</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    rpc </span><span class="token function" style=color:#e6db74>ListAndWatch</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">Empty</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> returns </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">stream ListAndWatchResponse</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// （可选）从可用设备列表中返回推荐的设备分配方案</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 注意：返回的推荐分配方案不保证是最终的分配结果</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 这个接口主要是帮助DeviceManager做出更明智的分配决策</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    rpc </span><span class="token function" style=color:#e6db74>GetPreferredAllocation</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">PreferredAllocationRequest</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> returns </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">PreferredAllocationResponse</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 在容器创建时调用，让设备插件执行设备特定的操作</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 并指导kubelet如何让设备在容器中可用（如环境变量、挂载点等）</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    rpc </span><span class="token function" style=color:#e6db74>Allocate</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">AllocateRequest</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> returns </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">AllocateResponse</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// （可选）如果设备插件在注册时指定需要，则在每个容器启动前调用</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 设备插件可以执行设备特定的操作，如重置设备状态等</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    rpc </span><span class="token function" style=color:#e6db74>PreStartContainer</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">PreStartContainerRequest</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> returns </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">PreStartContainerResponse</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>kubelet</code>与<code>DevicePlugin</code>的交互流程是基于<code>gRPC</code>的，以<code>nvidia device plugin</code>为例，交互流程如下：</p>
<ol>
<li><code>nvidia device plugin</code>启动后立即调用<code>kubelet</code>的<code>Registration.Register</code>接口，向<code>kubelet</code>注册自己。</li>
<li><code>kubelet</code>调用<code>nvidia device plugin</code>的<code>DevicePlugin.ListAndWatch</code>接口，获取设备列表，随后保持长连接数据流(<code>stream</code>)。设备状态变化时，<code>nvidia device plugin</code>主动推送更新给<code>kubelet</code>。</li>
<li><code>kubelet</code>调用<code>nvidia device plugin</code>的<code>DevicePlugin.Allocate</code>接口，分配设备资源，例如咱们这里的<code>GPU</code>设备资源。</li>
<li>如果<code>nvidia device plugin</code>支持优选分配策略（注册时通过参数配置），那么<code>kubelet</code>会先调用<code>DevicePlugin.GetPreferredAllocation</code>接口，获取优选分配策略，再调用<code>DevicePlugin.Allocate</code>接口，分配设备资源。</li>
<li>如果<code>nvidia device plugin</code>支持容器启动前处理（注册时通过参数配置），那么<code>kubelet</code>会调用<code>DevicePlugin.PreStartContainer</code>接口，预启动容器。该接口主要用于设备重置、初始化等特定操作。</li>
</ol>
<p>相关关键源码实现位置：</p>
<ol>
<li><a href=https://github.com/kubernetes/kubernetes/blob/c635a7e7d8362ac7c706680e77f7680895b1d517/pkg/kubelet/cm/devicemanager/manager.go#L801 target=_blank rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/blob/c635a7e7d8362ac7c706680e77f7680895b1d517/pkg/kubelet/cm/devicemanager/manager.go#L801</a></li>
<li><a href=https://github.com/NVIDIA/k8s-device-plugin/blob/d9f202f2710d6ff866761aa4d20dc2354ce39b8f/internal/plugin/server.go#L301 target=_blank rel="noopener noreferrer">https://github.com/NVIDIA/k8s-device-plugin/blob/d9f202f2710d6ff866761aa4d20dc2354ce39b8f/internal/plugin/server.go#L301</a></li>
</ol>
<p>根据日志分析，<code>Issuing a GetPreferredAllocation call for container</code>日志表示<code>kubelet</code>正在调用<code>nvidia device plugin</code>的<code>DevicePlugin.GetPreferredAllocation</code>接口，获取优选分配策略，随后没有其他<code>nvidia device plugin</code>交互流程相关的日志输出，说明<code>kubelet</code>在调用<code>DevicePlugin.GetPreferredAllocation</code>接口后，<code>kubelet</code>执行流程被阻塞了。所以问题可能出现这里的接口交互逻辑中。</p>
<p>由于在<code>nvidia device plugin</code>组件中没有查到有用的日志，因此我们优先去排查下<code>kubelet</code>的主流程是否会因为<code>DevicePlugin.GetPreferredAllocation</code>接口的调用而被阻塞。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=kubelet主流程分析>kubelet主流程分析<a href=#kubelet主流程分析 class=hash-link aria-label="Direct link to kubelet主流程分析" title="Direct link to kubelet主流程分析">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=完整调用链路>完整调用链路<a href=#完整调用链路 class=hash-link aria-label="Direct link to 完整调用链路" title="Direct link to 完整调用链路">​</a></h5>
<p><code>kubelet</code>调用<code>DevicePlugin.GetPreferredAllocation</code>接口的完整调用链路如下：</p>
<ol>
<li>
<p><a href=https://github.com/kubernetes/kubernetes/blob/f1e7386fbc4008e8079ff0d3eb142c935ec3ba57/pkg/kubelet/kubelet.go#L1541 target=_blank rel="noopener noreferrer">kubelet.go:1541</a> <code>Run</code>：执行<code>kubelet</code>的主进程处理逻辑。</p>
</li>
<li>
<p><a href=https://github.com/kubernetes/kubernetes/blob/f1e7386fbc4008e8079ff0d3eb142c935ec3ba57/pkg/kubelet/kubelet.go#L1635 target=_blank rel="noopener noreferrer">kubelet.go:1635</a> <code>syncLoop</code>：执行<code>Pod</code>处理，例如针对调度到该节点上<code>Pod</code>的创建、更新和删除等操作。需要注意，这个操作是一个同步处理逻辑，并不是在<code>goroutine</code>中处理的。</p>
</li>
<li>
<p><a href=https://github.com/kubernetes/kubernetes/blob/f1e7386fbc4008e8079ff0d3eb142c935ec3ba57/pkg/kubelet/kubelet.go#L2376 target=_blank rel="noopener noreferrer">kubelet.go:2376</a> <code>syncLoopIteration</code>：逐个遍历处理<code>Pod</code>更新数据（添加、更新、同步、删除等操作）。</p>
</li>
<li>
<p><a href=https://github.com/kubernetes/kubernetes/blob/f1e7386fbc4008e8079ff0d3eb142c935ec3ba57/pkg/kubelet/kubelet.go#L2499 target=_blank rel="noopener noreferrer">kubelet.go:2499</a> <code>HandlePodAdditions</code>：处理<code>Pod</code>的创建，比如当调度器已经将<code>Pod</code>指派给当前节点运行后，就需要该方法来执行真正的<code>Pod</code>相关容器创建。如果<code>Pod</code>阻塞在<code>Pending</code>状态，那么就需要查看该方法的实现逻辑。</p>
</li>
<li>
<p><a href=https://github.com/kubernetes/kubernetes/blob/f1e7386fbc4008e8079ff0d3eb142c935ec3ba57/pkg/kubelet/kubelet.go#L2552 target=_blank rel="noopener noreferrer">kubelet.go:2552</a> <code>canAdmitPod</code>：<code>Pod</code>准入检查，验证<code>Pod</code>是否可以在节点上运行</p>
</li>
<li>
<p><a href=https://github.com/kubernetes/kubernetes/blob/f1e7386fbc4008e8079ff0d3eb142c935ec3ba57/pkg/kubelet/cm/topology_manager.go#L219 target=_blank rel="noopener noreferrer">topology_manager.go:219</a> <code>topologyManager.Admit</code>：拓扑管理器准入检查，确保资源分配符合<code>NUMA</code>拓扑要求</p>
</li>
<li>
<p><a href=https://github.com/kubernetes/kubernetes/blob/f1e7386fbc4008e8079ff0d3eb142c935ec3ba57/pkg/kubelet/cm/scope.go#L152 target=_blank rel="noopener noreferrer">scope.go:152</a> <code>scope.allocateAlignedResources</code>：为<code>Pod</code>分配对齐的资源（CPU、内存、设备等）</p>
</li>
<li>
<p><a href=https://github.com/kubernetes/kubernetes/blob/f1e7386fbc4008e8079ff0d3eb142c935ec3ba57/pkg/kubelet/cm/manager.go#L320 target=_blank rel="noopener noreferrer">manager.go:320</a> <code>deviceManager.Allocate</code>：设备管理器分配设备资源给<code>Pod</code></p>
</li>
<li>
<p><a href=https://github.com/kubernetes/kubernetes/blob/f1e7386fbc4008e8079ff0d3eb142c935ec3ba57/pkg/kubelet/cm/manager.go#L801 target=_blank rel="noopener noreferrer">manager.go:801</a> <code>allocateContainerResources</code>：为容器分配具体的设备资源</p>
</li>
<li>
<p><a href=https://github.com/kubernetes/kubernetes/blob/f1e7386fbc4008e8079ff0d3eb142c935ec3ba57/pkg/kubelet/cm/manager.go#L623 target=_blank rel="noopener noreferrer">manager.go:623</a> <code>devicesToAllocate</code>：确定需要分配给容器的具体设备列表</p>
</li>
<li>
<p><a href=https://github.com/kubernetes/kubernetes/blob/f1e7386fbc4008e8079ff0d3eb142c935ec3ba57/pkg/kubelet/cm/manager.go#L984 target=_blank rel="noopener noreferrer">manager.go:984</a> <code>callGetPreferredAllocationIfAvailable</code>：调用设备插件获取优选分配方案</p>
</li>
<li>
<p><a href=https://github.com/kubernetes/kubernetes/blob/f1e7386fbc4008e8079ff0d3eb142c935ec3ba57/pkg/kubelet/cm/endpoint.go#L126 target=_blank rel="noopener noreferrer">endpoint.go:126</a> <code>endpoint.getPreferredAllocation</code>：通过<code>gRPC</code>调用设备插件的<code>GetPreferredAllocation</code>接口</p>
</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=关键阻塞点>关键阻塞点<a href=#关键阻塞点 class=hash-link aria-label="Direct link to 关键阻塞点" title="Direct link to 关键阻塞点">​</a></h5>
<p>源码位置：<a href=https://github.com/kubernetes/kubernetes/blob/c635a7e7d8362ac7c706680e77f7680895b1d517/pkg/kubelet/cm/devicemanager/manager.go#L995 target=_blank rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/blob/c635a7e7d8362ac7c706680e77f7680895b1d517/pkg/kubelet/cm/devicemanager/manager.go#L995</a></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">m </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">ManagerImpl</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>callGetPreferredAllocationIfAvailable</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token operator" style=color:#66d9ef>...</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 释放mutex锁</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    m</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">mutex</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Unlock</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    klog</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>V</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>4</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>InfoS</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"Issuing a GetPreferredAllocation call for container"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>...</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 发起同步gRPC调用，这里会阻塞等待device plugin响应</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    resp</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> eI</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">e</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>getPreferredAllocation</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">available</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>UnsortedList</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> mustInclude</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>UnsortedList</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> size</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 重新获取mutex锁</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    m</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">mutex</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Lock</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=阻塞问题分析>阻塞问题分析<a href=#阻塞问题分析 class=hash-link aria-label="Direct link to 阻塞问题分析" title="Direct link to 阻塞问题分析">​</a></h5>
<ol>
<li><strong>同步阻塞调用</strong>：<code>getPreferredAllocation</code>是同步<code>gRPC</code>调用，会一直阻塞直到<code>nvidia device plugin</code>返回响应。</li>
<li><strong>无超时机制</strong>：代码中没有设置<code>gRPC</code>调用超时，如果<code>nvidia device plugin</code>响应慢或卡死，<code>kubelet</code>会无限等待。</li>
<li><strong>串行处理</strong>：虽然调用时释放了<code>mutex</code>锁，但整个<code>Pod admission</code>流程仍然是串行的。</li>
<li><strong>影响范围广</strong>：阻塞会影响所有新<code>Pod</code>的创建和现有<code>Pod</code>的删除。</li>
</ol>
<p>通过深入分析<code>kubelet</code>源码，发现<code>DevicePlugin.GetPreferredAllocation</code>接口调用确实存在阻塞<code>kubelet</code>主流程的风险。因此，这里的<code>kubelet</code>在涉及到<code>DevicePlugin</code>交互时，存在很严重的假死风险。</p>
<p>那么，为什么<code>nvidia device plugin</code>的<code>GetPreferredAllocation</code>接口调用会卡死呢？</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=deviceplugin分析>DevicePlugin分析<a href=#deviceplugin分析 class=hash-link aria-label="Direct link to DevicePlugin分析" title="Direct link to DevicePlugin分析">​</a></h3>
<p>由于<code>nvidia device plugin</code>组件中没发现有用的日志（其实压根就没打关键日志），为了排查<code>GetPreferredAllocation</code>接口的阻塞原因，我这里手动修改了<code>nvidia device plugin</code>组件的源码，给<code>GetPreferredAllocation</code>接口的调用链路的关键方法添加了关键日志。并编译重新部署到集群中，经过一定时间的调试，发现最终问题阻塞在了<code>nvml</code>的初始化方法上。</p>
<p>源码位置：<a href=https://github.com/NVIDIA/k8s-device-plugin/blob/345c3ea8e38da5661ee2e31d13aaeae45467a958/vendor/github.com/NVIDIA/go-nvml/pkg/nvml/init.go#L24 target=_blank rel="noopener noreferrer">https://github.com/NVIDIA/k8s-device-plugin/blob/345c3ea8e38da5661ee2e31d13aaeae45467a958/vendor/github.com/NVIDIA/go-nvml/pkg/nvml/init.go#L24</a></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// nvml.Init()</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">l </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">library</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>Init</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> Return </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> l</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>load</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> ERROR_LIBRARY_NOT_FOUND</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>nvmlInit</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// 该方法执行阻塞了</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<blockquote>
<p><code>nvml</code>是 <code>NVIDIA Management Library</code> 的缩写，是一套用于管理和监控<code>NVIDIA GPU</code>设备的编程接口（<code>API</code>）。它提供了一系列函数，允许开发者或系统工具与<code>NVIDIA GPU</code>进行交互，获取硬件状态信息并执行基本的管理操作。</p>
</blockquote>
<p>该方法的内部实现是一堆<code>CGO</code>源代码，其实现原理是会去调用底层<code>GPU</code>驱动的接口，来实现初始化操作。所以这个问题可能比预料得更复杂，因为看起来这个问题出现在更底层。但也有可能是我们使用的方式不太正确，比如配置文件之类的没有使用对。</p>
<p>优先去查看了<code>nvidia device plugin</code>组件的配置介绍，在<code>README.md</code>中，经过和本地配置文件对比，并没有什么配置使用上的不对。估计问题还是出在底层。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=问题出现在更底层>问题出现在更底层<a href=#问题出现在更底层 class=hash-link aria-label="Direct link to 问题出现在更底层" title="Direct link to 问题出现在更底层">​</a></h3>
<p>既然如此，那么尝试升级了<code>nvidia device plugin</code>组件的版本，从当前的<code>0.16.2</code>升级到最新的<code>0.17.3</code>，结果问题依旧存在。因为问题出在<code>nvml</code>初始化，并不是<code>device plugin</code>的实现问题，那么是否是底层硬件驱动有问题？</p>
<p>由于升级驱动是一个重操作，对现有已运行的任务影响较大，在执行这个操作之前，根据已有排查结果，进一步去搜索社区的反馈，看看有没有线索。</p>
<p>根据以下关键字检索<code>Google</code>和<code>Github Issue</code>：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia device plugin nvml init block</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia driver nvml init block</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia nvml init block</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia device plugin nvml stuck</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia driver nvml stuck</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia container nvml stuck</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">container nvml stuck</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>经过一些尝试，最终在<code>GPU Operator</code>项目的<code>issue</code>中找到了类似的问题。搜索条件：<a href="https://github.com/search?q=nvidia+container+nvml+stuck+owner%3Anvidia&type=issues" target=_blank rel="noopener noreferrer">https://github.com/search?q=nvidia+container+nvml+stuck+owner%3Anvidia&type=issues</a></p>
<p><img decoding=async loading=lazy alt="GitHub中NVIDIA nvml stuck问题搜索结果" src=/assets/images/image-2-4e2222106e297298af9f5b9bc7e69211.png width=2684 height=1720 class=img_ev3q></p>
<p><code>issue</code>链接：<a href=https://github.com/NVIDIA/gpu-operator/issues/1361 target=_blank rel="noopener noreferrer">https://github.com/NVIDIA/gpu-operator/issues/1361</a> 并且该用户反馈的问题现象和我们遇到的非常类似，估计是一个问题。官方的开发者也回复了该问题，以下是具体引发<code>nvml</code>阻塞的原因，并且给出了<code>workaround</code>方案：</p>
<p><img decoding=async loading=lazy alt="GPU Operator开发者关于MIG nvml阻塞问题的回复说明" src=/assets/images/image-3f6625efd63d05a9bae1a4b624e62b2b.png width=2330 height=850 class=img_ev3q></p>
<p>我们看看<code>GPU</code>节点上的驱动版本，发现驱动版本是<code>570.158.01</code>，正好是踩上了这个驱动的<code>BUG</code>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ nvidia-smi</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">+-----------------------------------------------------------------------------------------+</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> NVIDIA-SMI </span><span class="token number" style=color:#ae81ff>570.158</span><span class="token plain">.01             Driver Version: </span><span class="token number" style=color:#ae81ff>570.158</span><span class="token plain">.01     CUDA Version: </span><span class="token number" style=color:#ae81ff>12.8</span><span class="token plain">     </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">-----------------------------------------+------------------------+----------------------+</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> GPU  Name                 Persistence-M </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> Bus-Id          Disp.A </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> Volatile Uncorr. ECC </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> Fan  Temp   Perf          Pwr:Usage/Cap </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">           Memory-Usage </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> GPU-Util  Compute M. </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                                         </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                        </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">               MIG M. </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>=</span><span class="token operator" style=color:#66d9ef>+=</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>=</span><span class="token operator" style=color:#66d9ef>+=</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>==</span><span class="token operator" style=color:#66d9ef>=</span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">  NVIDIA H20                     Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   00000000:0F:00.0 Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                   On </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> N/A   30C    P0             74W /  500W </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">      87MiB /  97871MiB </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">     N/A      Default </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                                         </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                        </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">              Enabled </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">+-----------------------------------------+------------------------+----------------------+</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">  NVIDIA H20                     Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   00000000:34:00.0 Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                   On </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> N/A   29C    P0             73W /  500W </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">      87MiB /  97871MiB </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">     N/A      Default </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                                         </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                        </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">              Enabled </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">+-----------------------------------------+------------------------+----------------------+</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">  NVIDIA H20                     Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   00000000:48:00.0 Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                   On </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> N/A   30C    P0             76W /  500W </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">      87MiB /  97871MiB </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">     N/A      Default </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                                         </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                        </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">              Enabled </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">+-----------------------------------------+------------------------+----------------------+</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   </span><span class="token number" style=color:#ae81ff>3</span><span class="token plain">  NVIDIA H20                     Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   00000000:5A:00.0 Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                    </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> N/A   28C    P0             74W /  500W </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">       0MiB /  97871MiB </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">      </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">%      Default </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                                         </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                        </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">             Disabled </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">+-----------------------------------------+------------------------+----------------------+</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   </span><span class="token number" style=color:#ae81ff>4</span><span class="token plain">  NVIDIA H20                     Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   00000000:87:00.0 Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                    </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> N/A   30C    P0             73W /  500W </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">       0MiB /  97871MiB </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">      </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">%      Default </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                                         </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                        </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">             Disabled </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">+-----------------------------------------+------------------------+----------------------+</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   </span><span class="token number" style=color:#ae81ff>5</span><span class="token plain">  NVIDIA H20                     Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   00000000:AE:00.0 Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                    </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> N/A   28C    P0             73W /  500W </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">       0MiB /  97871MiB </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">      </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">%      Default </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                                         </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                        </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">             Disabled </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">+-----------------------------------------+------------------------+----------------------+</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   </span><span class="token number" style=color:#ae81ff>6</span><span class="token plain">  NVIDIA H20                     Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   00000000:C2:00.0 Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                    </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> N/A   30C    P0             73W /  500W </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">       0MiB /  97871MiB </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">      </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">%      Default </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                                         </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                        </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">             Disabled </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">+-----------------------------------------+------------------------+----------------------+</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   </span><span class="token number" style=color:#ae81ff>7</span><span class="token plain">  NVIDIA H20                     Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">   00000000:D7:00.0 Off </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                    </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"> N/A   29C    P0             76W /  500W </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">       0MiB /  97871MiB </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">      </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">%      Default </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                                         </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">                        </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain">             Disabled </span><span class="token operator" style=color:#66d9ef>|</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">+-----------------------------------------+------------------------+----------------------+</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token plain">.</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=解决方案>解决方案<a href=#解决方案 class=hash-link aria-label="Direct link to 解决方案" title="Direct link to 解决方案">​</a></h2>
<p>根据官方人员的建议，升级到最新<code>570.172.08</code>驱动，并且该驱动是<code>8</code>小时前才发布的。估计这个问题后续还会有很多人踩上去。</p>
<p><img decoding=async loading=lazy alt="NVIDIA 570.172.08驱动版本发布时间信息" src=/assets/images/image-1-e019840cd6ee2a3e20042116b30aafa7.png width=2292 height=506 class=img_ev3q></p>
<p>驱动升级方式（以<code>Ubuntu 22.04</code>系统为例）：</p>
<p>查看驱动列表：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token function" style=color:#e6db74>sudo</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>apt-cache</span><span class="token plain"> search nvidia-driver</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>执行驱动升级：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token function" style=color:#e6db74>sudo</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>apt-get</span><span class="token plain"> upgrade nvidia-driver-570</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>执行驱动升级后，需要重启节点。随后该问题暂时未复现。</p>
<hr>
<p>PS：至于<code>kubelet</code>假死的风险，目前<code>kubernetes</code>的最新版本也存在这个问题，<code>kubernetes</code>社区也有<code>issue</code>和<code>PR</code>在跟进：<a href=https://github.com/kubernetes/kubernetes/issues/130855 target=_blank rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/issues/130855</a> 、 <a href=https://github.com/kubernetes/kubernetes/pull/131383 target=_blank rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/pull/131383</a> 大家注意存在这个问题即可。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=常见问题>常见问题<a href=#常见问题 class=hash-link aria-label="Direct link to 常见问题" title="Direct link to 常见问题">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=为何在575或580系列驱动该问题任然存在>为何在575或580系列驱动该问题任然存在<a href=#为何在575或580系列驱动该问题任然存在 class=hash-link aria-label="Direct link to 为何在575或580系列驱动该问题任然存在" title="Direct link to 为何在575或580系列驱动该问题任然存在">​</a></h3>
<p>截止目前（<code>2025.08.12</code>），<code>570.172.08</code>版本是唯一一个修复该问题的驱动。大版本号（<code>575</code>或<code>580</code>）高于<code>570</code>并不意味着其子版本号或者修复版本号是晚于<code>570.172.08</code>版本的。</p>
<p><code>570</code>、<code>575</code>、<code>580</code>都是长期维护的驱动版本，出现重大问题的时候会同时合并到这几个大版本号的驱动中，但目前该修复还未合并到<code>580</code>系列驱动中。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=升级驱动后mps拆卡失败>升级驱动后MPS拆卡失败<a href=#升级驱动后mps拆卡失败 class=hash-link aria-label="Direct link to 升级驱动后MPS拆卡失败" title="Direct link to 升级驱动后MPS拆卡失败">​</a></h3>
<p>如果升级驱动后出现<code>MPS</code>拆卡失败，具体现象为<code>MPS</code>的<code>nvidia-device-plugin-mps-control-daemon</code>组件处于<code>CrashLoopBackOff</code>状态：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">$ kubectl get pod </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> gpu-operator</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token plain">.</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-device-plugin-daemonset-85lzp                     </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">/2     Running            </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">               25h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-device-plugin-daemonset-gsp8d                     </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">/2     Running            </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">               26h</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-device-plugin-daemonset-rghb5                     </span><span class="token number" style=color:#ae81ff>2</span><span class="token plain">/2     Running            </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">46m ago</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">     66m</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-device-plugin-mps-control-daemon-rpm7r            </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/2     CrashLoopBackOff   </span><span class="token number" style=color:#ae81ff>12</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">2m5s ago</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">   46m</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-mig-manager-275td                                 </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running            </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">               82m</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">nvidia-mig-manager-bmt75                                 </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">/1     Running            </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain">               82m</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token plain">.</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>查看<code>nvidia-device-plugin-mps-control-daemon</code>组件中的<code>mps-control-daemon-ctr</code>容器的日志，报错信息如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">I0805 08:40:16.021509     </span><span class="token number" style=color:#ae81ff>303</span><span class="token plain"> main.go:197</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"> Retrieving MPS daemons.</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">I0805 08:40:16.157726     </span><span class="token number" style=color:#ae81ff>303</span><span class="token plain"> manager.go:88</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"Resource is not shared"</span><span class="token plain"> </span><span class="token assign-left variable" style=color:#f8f8f2>resource</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"resource"</span><span class="token plain"> nvidia.com/gpu</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"(MISSING)"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">I0805 08:40:16.431605     </span><span class="token number" style=color:#ae81ff>303</span><span class="token plain"> daemon.go:100</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"Staring MPS daemon"</span><span class="token plain"> </span><span class="token assign-left variable" style=color:#f8f8f2>resource</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"nvidia.com/gpu.shared"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">I0805 08:40:16.431671     </span><span class="token number" style=color:#ae81ff>303</span><span class="token plain"> daemon.go:153</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"SELinux disabled, not updating context"</span><span class="token plain"> </span><span class="token assign-left variable" style=color:#f8f8f2>path</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>"/mps/nvidia.com/gpu.shared/pipe"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">E0805 08:40:16.431856     </span><span class="token number" style=color:#ae81ff>303</span><span class="token plain"> main.go:213</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"> Failed to start MPS daemon: exec: </span><span class="token string" style=color:#a6e22e>"nvidia-cuda-mps-control"</span><span class="token builtin class-name" style=color:#e6db74>:</span><span class="token plain"> executable </span><span class="token function" style=color:#e6db74>file</span><span class="token plain"> not found </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> </span><span class="token environment constant" style=color:#e6db74>$PATH</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">I0805 08:40:16.431895     </span><span class="token number" style=color:#ae81ff>303</span><span class="token plain"> main.go:132</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"> Failed to start one or </span><span class="token function" style=color:#e6db74>more</span><span class="token plain"> MPS deamons. Retrying </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> 30s</span><span class="token punctuation" style=color:#f8f8f2>..</span><span class="token plain">.</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">W0805 08:40:46.441659     </span><span class="token number" style=color:#ae81ff>303</span><span class="token plain"> main.go:228</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"> Failed to remove .ready file: remove /mps/.ready: no such </span><span class="token function" style=color:#e6db74>file</span><span class="token plain"> or directory</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">I0805 08:40:46.441705     </span><span class="token number" style=color:#ae81ff>303</span><span class="token plain"> main.go:230</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"> Stopping MPS daemons.</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">E0805 08:40:46.441879     </span><span class="token number" style=color:#ae81ff>303</span><span class="token plain"> main.go:84</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"> error stopping plugins from previous run: error sending quit message: failed to start NVIDIA MPS command: exec: </span><span class="token string" style=color:#a6e22e>"nvidia-cuda-mps-control"</span><span class="token builtin class-name" style=color:#e6db74>:</span><span class="token plain"> executable </span><span class="token function" style=color:#e6db74>file</span><span class="token plain"> not found </span><span class="token keyword" style=color:#66d9ef>in</span><span class="token plain"> </span><span class="token environment constant" style=color:#e6db74>$PATH</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>说明容器找不到<code>nvidia-cuda-mps-control</code>二进制文件。</p>
<p>经过排查发现<code>nvidia-device-plugin-mps-control-daemon</code>组件中的<code>mps-control-daemon-ctr</code>容器使用了特权模式，能够使用宿主机上的二进制文件：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">command</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> mps</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">control</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">daemon</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NODE_NAME</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token key atrule">fieldRef</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">apiVersion</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> v1</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">          </span><span class="token key atrule">fieldPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> spec.nodeName</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA_VISIBLE_DEVICES</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> all</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA_DRIVER_CAPABILITIES</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> compute</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain">utility</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> CONFIG_FILE</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /config/config.yaml</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> MIG_STRATEGY</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mixed</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> NVIDIA_MIG_MONITOR_DEVICES</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> all</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> aiharbor.msxf.local/mirror</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">stuff/nvidia/k8s</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">device</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">plugin</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">v0.16.2</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">msxf.27</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> IfNotPresent</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mps</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">control</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">daemon</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">ctr</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">securityContext</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">privileged</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">terminationMessagePath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /dev/termination</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">log</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> File</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token key atrule">volumeMounts</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /dev/shm</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mps</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">shm</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /mps</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> mps</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">root</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /config</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> config</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /available</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">configs</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> device</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">plugin</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">config</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain"> </span><span class="token key atrule">mountPath</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> /var/run/secrets/kubernetes.io/serviceaccount</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> kube</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">api</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">access</span><span class="token punctuation" style=color:#f8f8f2>-</span><span class="token plain">skcwm</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">      </span><span class="token key atrule">readOnly</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>因此去宿主机上查看，发现确实不存在<code>nvidia-cuda-mps-control</code>二进制文件。估计是升级驱动的时候自动把相关旧版本的工具删掉了？正常安装完成驱动后，也应该安装相应的工具，这里重新安装对应驱动版本工具即可：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token function" style=color:#e6db74>sudo</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>apt-get</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>install</span><span class="token plain"> nvidia-compute-utils-570</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=参考链接>参考链接<a href=#参考链接 class=hash-link aria-label="Direct link to 参考链接" title="Direct link to 参考链接">​</a></h2>
<ul>
<li><a href=https://github.com/NVIDIA/gpu-operator/issues/1361 target=_blank rel="noopener noreferrer">https://github.com/NVIDIA/gpu-operator/issues/1361</a></li>
<li><a href=https://github.com/kubernetes/kubernetes/issues/130855 target=_blank rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/issues/130855</a></li>
<li><a href=https://github.com/kubernetes/kubernetes/issues/117435 target=_blank rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/issues/117435</a></li>
<li><a href=https://github.com/NVIDIA/gpu-operator/issues/1356 target=_blank rel="noopener noreferrer">https://github.com/NVIDIA/gpu-operator/issues/1356</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/ai/gpu-mig-docker-specify-subcard><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>GPU MIG拆卡后使用docker指定子卡执行</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/ai/gpu-environment-setup-guide><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>GPU环境搭建指南：在裸机、Docker、K8S环境中使用GPU</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#背景描述 class="table-of-contents__link toc-highlight">背景描述</a><li><a href=#环境信息 class="table-of-contents__link toc-highlight">环境信息</a><li><a href=#排查过程 class="table-of-contents__link toc-highlight">排查过程</a><ul><li><a href=#关键日志排查 class="table-of-contents__link toc-highlight">关键日志排查</a><li><a href=#日志结果分析 class="table-of-contents__link toc-highlight">日志结果分析</a><li><a href=#deviceplugin分析 class="table-of-contents__link toc-highlight">DevicePlugin分析</a><li><a href=#问题出现在更底层 class="table-of-contents__link toc-highlight">问题出现在更底层</a></ul><li><a href=#解决方案 class="table-of-contents__link toc-highlight">解决方案</a><li><a href=#常见问题 class="table-of-contents__link toc-highlight">常见问题</a><ul><li><a href=#为何在575或580系列驱动该问题任然存在 class="table-of-contents__link toc-highlight">为何在575或580系列驱动该问题任然存在</a><li><a href=#升级驱动后mps拆卡失败 class="table-of-contents__link toc-highlight">升级驱动后MPS拆卡失败</a></ul><li><a href=#参考链接 class="table-of-contents__link toc-highlight">参考链接</a></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 johng.cn</div></div></div></footer></div>